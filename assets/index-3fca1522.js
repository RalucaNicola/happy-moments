(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();const JRe="modulepreload",KRe=function(t,e){return new URL(t,e).href},ZK={},ie=function(e,r,i){if(!r||r.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(r.map(n=>{if(n=KRe(n,i),n in ZK)return;ZK[n]=!0;const o=n.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!i)for(let h=s.length-1;h>=0;h--){const p=s[h];if(p.href===n&&(!o||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${a}`))return;const c=document.createElement("link");if(c.rel=o?"stylesheet":JRe,o||(c.as="script",c.crossOrigin=""),c.href=n,document.head.appendChild(c),o)return new Promise((h,p)=>{c.addEventListener("load",h),c.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>e())},RT={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let OT,mhe,k4,ghe=!1,xN=!1,Wq=!1,mu=!1,JK=null,xk=!1;const yhe=t=>{const e=new URL(t,Ta.$resourcesUrl$);return e.origin!==mM.location.origin?e.href:e.pathname},_he=t=>Ta.$resourcesUrl$=t,gw=(t,e="")=>()=>{},KK="http://www.w3.org/1999/xlink",QK={},QRe="http://www.w3.org/2000/svg",eOe="http://www.w3.org/1999/xhtml",tOe=t=>t!=null,Xq=t=>(t=typeof t,t==="object"||t==="function"),gc=(t,e,...r)=>{let i=null,s=null,n=null,o=!1,a=!1;const l=[],c=p=>{for(let f=0;f<p.length;f++)i=p[f],Array.isArray(i)?c(i):i!=null&&typeof i!="boolean"&&((o=typeof t!="function"&&!Xq(i))&&(i=String(i)),o&&a?l[l.length-1].$text$+=i:l.push(o?TN(null,i):i),a=o)};if(c(r),e){e.key&&(s=e.key),e.name&&(n=e.name);{const p=e.className||e.class;p&&(e.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}}if(typeof t=="function")return t(e===null?{}:e,l,iOe);const h=TN(t,null);return h.$attrs$=e,l.length>0&&(h.$children$=l),h.$key$=s,h.$name$=n,h},TN=(t,e)=>{const r={$flags$:0,$tag$:t,$text$:e,$elm$:null,$children$:null};return r.$attrs$=null,r.$key$=null,r.$name$=null,r},vhe={},rOe=t=>t&&t.$tag$===vhe,iOe={forEach:(t,e)=>t.map(eQ).forEach(e),map:(t,e)=>t.map(eQ).map(e).map(sOe)},eQ=t=>({vattrs:t.$attrs$,vchildren:t.$children$,vkey:t.$key$,vname:t.$name$,vtag:t.$tag$,vtext:t.$text$}),sOe=t=>{if(typeof t.vtag=="function"){const r=Object.assign({},t.vattrs);return t.vkey&&(r.key=t.vkey),t.vname&&(r.name=t.vname),gc(t.vtag,r,...t.vchildren||[])}const e=TN(t.vtag,t.vtext);return e.$attrs$=t.vattrs,e.$children$=t.vchildren,e.$key$=t.vkey,e.$name$=t.vname,e},nOe=t=>LOe.map(e=>e(t)).find(e=>!!e),oOe=(t,e)=>t!=null&&!Xq(t)?e&4?t==="false"?!1:t===""||!!t:e&2?parseFloat(t):e&1?String(t):t:t,aOe=t=>t,lOe=(t,e,r)=>{const i=aOe(t);return{emit:s=>cOe(i,e,{bubbles:!!(r&4),composed:!!(r&2),cancelable:!!(r&1),detail:s})}},cOe=(t,e,r)=>{const i=Ta.ce(e,r);return t.dispatchEvent(i),i},tQ=new WeakMap,uOe=(t,e,r)=>{let i=EN.get(t);FOe&&r?(i=i||new CSSStyleSheet,typeof i=="string"?i=e:i.replaceSync(e)):i=e,EN.set(t,i)},hOe=(t,e,r,i)=>{let s=bhe(e,r);const n=EN.get(s);if(t=t.nodeType===11?t:Zf,n)if(typeof n=="string"){t=t.head||t;let o=tQ.get(t),a;o||tQ.set(t,o=new Set),o.has(s)||(a=Zf.createElement("style"),a.innerHTML=n,t.insertBefore(a,t.querySelector("link")),o&&o.add(s))}else t.adoptedStyleSheets.includes(n)||(t.adoptedStyleSheets=[...t.adoptedStyleSheets,n]);return s},dOe=t=>{const e=t.$cmpMeta$,r=t.$hostElement$,i=e.$flags$,s=gw("attachStyles",e.$tagName$),n=hOe(r.shadowRoot?r.shadowRoot:r.getRootNode(),e,t.$modeName$);i&10&&(r["s-sc"]=n,r.classList.add(n+"-h"),i&2&&r.classList.add(n+"-s")),s()},bhe=(t,e)=>"sc-"+(e&&t.$flags$&32?t.$tagName$+"-"+e:t.$tagName$),rQ=(t,e,r,i,s,n)=>{if(r!==i){let o=oQ(t,e),a=e.toLowerCase();if(e==="class"){const l=t.classList,c=iQ(r),h=iQ(i);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(e==="style"){for(const l in r)(!i||i[l]==null)&&(l.includes("-")?t.style.removeProperty(l):t.style[l]="");for(const l in i)(!r||i[l]!==r[l])&&(l.includes("-")?t.style.setProperty(l,i[l]):t.style[l]=i[l])}else if(e!=="key")if(e==="ref")i&&i(t);else if(!t.__lookupSetter__(e)&&e[0]==="o"&&e[1]==="n")e[2]==="-"?e=e.slice(3):oQ(mM,a)?e=a.slice(2):e=a[2]+e.slice(3),r&&Ta.rel(t,e,r,!1),i&&Ta.ael(t,e,i,!1);else{const l=Xq(i);if((o||l&&i!==null)&&!s)try{if(t.tagName.includes("-"))t[e]=i;else{const h=i??"";e==="list"?o=!1:(r==null||t[e]!=h)&&(t[e]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(e=a,c=!0),i==null||i===!1?(i!==!1||t.getAttribute(e)==="")&&(c?t.removeAttributeNS(KK,e):t.removeAttribute(e)):(!o||n&4||s)&&!l&&(i=i===!0?"":i,c?t.setAttributeNS(KK,e,i):t.setAttribute(e,i))}}},pOe=/\s/,iQ=t=>t?t.split(pOe):[],whe=(t,e,r,i)=>{const s=e.$elm$.nodeType===11&&e.$elm$.host?e.$elm$.host:e.$elm$,n=t&&t.$attrs$||QK,o=e.$attrs$||QK;for(i in n)i in o||rQ(s,i,n[i],void 0,r,e.$flags$);for(i in o)rQ(s,i,n[i],o[i],r,e.$flags$)},SN=(t,e,r,i)=>{const s=e.$children$[r];let n=0,o,a,l;if(ghe||(Wq=!0,s.$tag$==="slot"&&(OT&&i.classList.add(OT+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=Zf.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=Zf.createTextNode("");else{if(mu||(mu=s.$tag$==="svg"),o=s.$elm$=Zf.createElementNS(mu?QRe:eOe,s.$flags$&2?"slot-fb":s.$tag$),mu&&s.$tag$==="foreignObject"&&(mu=!1),whe(null,s,mu),tOe(OT)&&o["s-si"]!==OT&&o.classList.add(o["s-si"]=OT),s.$children$)for(n=0;n<s.$children$.length;++n)a=SN(t,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?mu=!1:o.tagName==="foreignObject"&&(mu=!0)}return o["s-hn"]=k4,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=mhe,o["s-sn"]=s.$name$||"",l=t&&t.$children$&&t.$children$[r],l&&l.$tag$===s.$tag$&&t.$elm$&&t3(t.$elm$,!1)),o},t3=(t,e)=>{Ta.$flags$|=1;const r=t.childNodes;for(let i=r.length-1;i>=0;i--){const s=r[i];s["s-hn"]!==k4&&s["s-ol"]&&(She(s).insertBefore(s,Yq(s)),s["s-ol"].remove(),s["s-ol"]=void 0,Wq=!0),e&&t3(s,e)}Ta.$flags$&=-2},xhe=(t,e,r,i,s,n)=>{let o=t["s-cr"]&&t["s-cr"].parentNode||t,a;for(o.shadowRoot&&o.tagName===k4&&(o=o.shadowRoot);s<=n;++s)i[s]&&(a=SN(null,r,s,t),a&&(i[s].$elm$=a,o.insertBefore(a,Yq(e))))},The=(t,e,r,i,s)=>{for(;e<=r;++e)(i=t[e])&&(s=i.$elm$,Ahe(i),xN=!0,s["s-ol"]?s["s-ol"].remove():t3(s,!0),s.remove())},fOe=(t,e,r,i)=>{let s=0,n=0,o=0,a=0,l=e.length-1,c=e[0],h=e[l],p=i.length-1,f=i[0],m=i[p],y,_;for(;s<=l&&n<=p;)if(c==null)c=e[++s];else if(h==null)h=e[--l];else if(f==null)f=i[++n];else if(m==null)m=i[--p];else if(vP(c,f))MT(c,f),c=e[++s],f=i[++n];else if(vP(h,m))MT(h,m),h=e[--l],m=i[--p];else if(vP(c,m))(c.$tag$==="slot"||m.$tag$==="slot")&&t3(c.$elm$.parentNode,!1),MT(c,m),t.insertBefore(c.$elm$,h.$elm$.nextSibling),c=e[++s],m=i[--p];else if(vP(h,f))(c.$tag$==="slot"||m.$tag$==="slot")&&t3(h.$elm$.parentNode,!1),MT(h,f),t.insertBefore(h.$elm$,c.$elm$),h=e[--l],f=i[++n];else{for(o=-1,a=s;a<=l;++a)if(e[a]&&e[a].$key$!==null&&e[a].$key$===f.$key$){o=a;break}o>=0?(_=e[o],_.$tag$!==f.$tag$?y=SN(e&&e[n],r,o,t):(MT(_,f),e[o]=void 0,y=_.$elm$),f=i[++n]):(y=SN(e&&e[n],r,n,t),f=i[++n]),y&&She(c.$elm$).insertBefore(y,Yq(c.$elm$))}s>l?xhe(t,i[p+1]==null?null:i[p+1].$elm$,r,i,n,p):n>p&&The(e,s,l)},vP=(t,e)=>t.$tag$===e.$tag$?t.$tag$==="slot"?t.$name$===e.$name$:t.$key$===e.$key$:!1,Yq=t=>t&&t["s-ol"]||t,She=t=>(t["s-ol"]?t["s-ol"]:t).parentNode,MT=(t,e)=>{const r=e.$elm$=t.$elm$,i=t.$children$,s=e.$children$,n=e.$tag$,o=e.$text$;let a;o===null?(mu=n==="svg"?!0:n==="foreignObject"?!1:mu,n==="slot"||whe(t,e,mu),i!==null&&s!==null?fOe(r,i,e,s):s!==null?(t.$text$!==null&&(r.textContent=""),xhe(r,null,e,s,0,s.length-1)):i!==null&&The(i,0,i.length-1),mu&&n==="svg"&&(mu=!1)):(a=r["s-cr"])?a.parentNode.textContent=o:t.$text$!==o&&(r.data=o)},Ehe=t=>{const e=t.childNodes;let r,i,s,n,o,a;for(i=0,s=e.length;i<s;i++)if(r=e[i],r.nodeType===1){if(r["s-sr"]){for(o=r["s-sn"],r.hidden=!1,n=0;n<s;n++)if(a=e[n].nodeType,e[n]["s-hn"]!==r["s-hn"]||o!==""){if(a===1&&o===e[n].getAttribute("slot")){r.hidden=!0;break}}else if(a===1||a===3&&e[n].textContent.trim()!==""){r.hidden=!0;break}}Ehe(r)}},Zd=[],Che=t=>{let e,r,i,s,n,o,a=0;const l=t.childNodes,c=l.length;for(;a<c;a++){if(e=l[a],e["s-sr"]&&(r=e["s-cr"])&&r.parentNode)for(i=r.parentNode.childNodes,s=e["s-sn"],o=i.length-1;o>=0;o--)r=i[o],!r["s-cn"]&&!r["s-nr"]&&r["s-hn"]!==e["s-hn"]&&(sQ(r,s)?(n=Zd.find(h=>h.$nodeToRelocate$===r),xN=!0,r["s-sn"]=r["s-sn"]||s,n?n.$slotRefNode$=e:Zd.push({$slotRefNode$:e,$nodeToRelocate$:r}),r["s-sr"]&&Zd.map(h=>{sQ(h.$nodeToRelocate$,r["s-sn"])&&(n=Zd.find(p=>p.$nodeToRelocate$===r),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):Zd.some(h=>h.$nodeToRelocate$===r)||Zd.push({$nodeToRelocate$:r}));e.nodeType===1&&Che(e)}},sQ=(t,e)=>t.nodeType===1?t.getAttribute("slot")===null&&e===""||t.getAttribute("slot")===e:t["s-sn"]===e?!0:e==="",Ahe=t=>{t.$attrs$&&t.$attrs$.ref&&t.$attrs$.ref(null),t.$children$&&t.$children$.map(Ahe)},mOe=(t,e)=>{const r=t.$hostElement$,i=t.$cmpMeta$,s=t.$vnode$||TN(null,null),n=rOe(e)?e:gc(null,null,e);k4=r.tagName,i.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},i.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=r[o])),n.$tag$=null,n.$flags$|=4,t.$vnode$=n,n.$elm$=s.$elm$=r.shadowRoot||r,OT=r["s-sc"],mhe=r["s-cr"],ghe=(i.$flags$&1)!==0,xN=!1,MT(s,n);{if(Ta.$flags$|=1,Wq){Che(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<Zd.length;f++)o=Zd[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=Zf.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<Zd.length;f++)if(o=Zd[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}xN&&Ehe(n.$elm$),Ta.$flags$&=-2,Zd.length=0}},gOe=(t,e)=>{},Zq=(t,e)=>(t.$flags$|=16,gOe(t,t.$ancestorComponent$),kOe(()=>yOe(t,e))),yOe=(t,e)=>{const r=t.$hostElement$,i=gw("scheduleUpdate",t.$cmpMeta$.$tagName$),s=r;let n;return e?n=sS(s,"componentWillLoad"):n=sS(s,"componentWillUpdate"),n=nQ(n,()=>sS(s,"componentWillRender")),i(),nQ(n,()=>_Oe(t,s,e))},_Oe=async(t,e,r)=>{const i=t.$hostElement$,s=gw("update",t.$cmpMeta$.$tagName$);i["s-rc"],r&&dOe(t);const n=gw("render",t.$cmpMeta$.$tagName$);vOe(t,e,i),n(),s(),bOe(t)},vOe=(t,e,r)=>{try{JK=e,e=e.render&&e.render(),t.$flags$&=-17,t.$flags$|=2,(RT.hasRenderFn||RT.reflect)&&(RT.vdomRender||RT.reflect)&&(RT.hydrateServerSide||mOe(t,e))}catch(a){fM(a,t.$hostElement$)}return JK=null,null},bOe=t=>{const e=t.$cmpMeta$.$tagName$,r=t.$hostElement$,i=gw("postUpdate",e),s=r;t.$ancestorComponent$,sS(s,"componentDidRender"),t.$flags$&64?(sS(s,"componentDidUpdate"),i()):(t.$flags$|=64,sS(s,"componentDidLoad"),i())},STt=t=>{{const e=pM(t),r=e.$hostElement$.isConnected;return r&&(e.$flags$&18)===2&&Zq(e,!1),r}},sS=(t,e,r)=>{if(t&&t[e])try{return t[e](r)}catch(i){fM(i)}},nQ=(t,e)=>t&&t.then?t.then(e):e(),wOe=(t,e)=>pM(t).$instanceValues$.get(e),xOe=(t,e,r,i)=>{const s=pM(t),n=t,o=s.$instanceValues$.get(e),a=s.$flags$,l=n;r=oOe(r,i.$members$[e][0]);const c=Number.isNaN(o)&&Number.isNaN(r);if(r!==o&&!c){s.$instanceValues$.set(e,r);{if(i.$watchers$&&a&128){const p=i.$watchers$[e];p&&p.map(f=>{try{l[f](r,o,e)}catch(m){fM(m,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(r,o,e)===!1)return;Zq(s,!1)}}}},TOe=(t,e,r)=>{if(e.$members$){t.watchers&&(e.$watchers$=t.watchers);const i=Object.entries(e.$members$),s=t.prototype;i.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return wOe(this,n)},set(a){xOe(this,n,a,e)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){Ta.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},t.observedAttributes=i.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&e.$attrsToReflect$.push([o,l]),l})}}return t},SOe=async(t,e,r,i,s)=>{if(!(e.$flags$&32)&&(s=t.constructor,e.$flags$|=32,customElements.whenDefined(r.$tagName$).then(()=>e.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[e.$modeName$=nOe(t)]);const a=bhe(r,e.$modeName$);if(!EN.has(a)){const l=gw("registerStyles",r.$tagName$);uOe(a,o,!!(r.$flags$&1)),l()}}e.$ancestorComponent$,(()=>Zq(e,!0))()},EOe=t=>{},COe=t=>{if(!(Ta.$flags$&1)){const e=pM(t),r=e.$cmpMeta$,i=gw("connectedCallback",r.$tagName$);e.$flags$&1?(Ohe(t,e,r.$listeners$),EOe(e.$lazyInstance$)):(e.$flags$|=1,r.$flags$&12&&AOe(t),r.$members$&&Object.entries(r.$members$).map(([s,[n]])=>{if(n&31&&t.hasOwnProperty(s)){const o=t[s];delete t[s],t[s]=o}}),SOe(t,e,r)),i()}},AOe=t=>{const e=t["s-cr"]=Zf.createComment("");e["s-cn"]=!0,t.insertBefore(e,t.firstChild)},ROe=t=>{if(!(Ta.$flags$&1)){const e=pM(t);e.$rmListeners$&&(e.$rmListeners$.map(r=>r()),e.$rmListeners$=void 0)}},Rhe=(t,e)=>{const r={$flags$:e[0],$tagName$:e[1]};r.$members$=e[2],r.$listeners$=e[3],r.$watchers$=t.$watchers$,r.$attrsToReflect$=[];const i=t.prototype.connectedCallback,s=t.prototype.disconnectedCallback;return Object.assign(t.prototype,{__registerHost(){$Oe(this,r)},connectedCallback(){COe(this),i&&i.call(this)},disconnectedCallback(){ROe(this),s&&s.call(this)},__attachShadow(){this.attachShadow({mode:"open",delegatesFocus:!!(r.$flags$&16)})}}),t.is=r.$tagName$,TOe(t,r)},OOe=(t,e)=>e,Ohe=(t,e,r,i)=>{r&&r.map(([s,n,o])=>{const a=POe(t,s),l=MOe(e,o),c=IOe(s);Ta.ael(a,n,l,c),(e.$rmListeners$=e.$rmListeners$||[]).push(()=>Ta.rel(a,n,l,c))})},MOe=(t,e)=>r=>{try{RT.lazyLoad||t.$hostElement$[e](r)}catch(i){fM(i)}},POe=(t,e)=>e&4?Zf:e&8?mM:e&16?Zf.body:t,IOe=t=>DOe?{passive:(t&1)!==0,capture:(t&2)!==0}:(t&2)!==0,Mhe=new WeakMap,pM=t=>Mhe.get(t),$Oe=(t,e)=>{const r={$flags$:0,$hostElement$:t,$cmpMeta$:e,$instanceValues$:new Map};return Ohe(t,r,e.$listeners$),Mhe.set(t,r)},oQ=(t,e)=>e in t,fM=(t,e)=>(0,console.error)(t,e),EN=new Map,LOe=[],mM=typeof window<"u"?window:{},Zf=mM.document||{head:{}},Phe=mM.HTMLElement||class{},Ta={$flags$:0,$resourcesUrl$:"",jmp:t=>t(),raf:t=>requestAnimationFrame(t),ael:(t,e,r,i)=>t.addEventListener(e,r,i),rel:(t,e,r,i)=>t.removeEventListener(e,r,i),ce:(t,e)=>new CustomEvent(t,e)},DOe=(()=>{let t=!1;try{Zf.addEventListener("e",null,Object.defineProperty({},"passive",{get(){t=!0}}))}catch{}return t})(),NOe=t=>Promise.resolve(t),FOe=(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replaceSync=="function"}catch{}return!1})(),aQ=[],Ihe=[],UOe=(t,e)=>r=>{t.push(r),xk||(xk=!0,e&&Ta.$flags$&4?VOe(Tk):Ta.raf(Tk))},lQ=t=>{for(let e=0;e<t.length;e++)try{t[e](performance.now())}catch(r){fM(r)}t.length=0},Tk=()=>{lQ(aQ),lQ(Ihe),(xk=aQ.length>0)&&Ta.raf(Tk)},VOe=t=>NOe().then(t),kOe=UOe(Ihe,!0);/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */const zOe="calcite-mode-auto",BOe="calcite-mode-dark";function GOe(t){const e="dir",r=`[${e}]`,i=Jq(t,r);return i?i.getAttribute(e):"ltr"}function jOe(t){return t.getRootNode()}function HOe(t){return t.host||null}function Jq(t,e){function r(i){return i?i.closest(e)||r(HOe(jOe(i))):null}return r(t)}function qOe(t,e){return $he(t,e)}function $he(t,e){if(!t)return;const r=e(t);if(r!==void 0)return r;const{parentNode:i}=t;return $he(i instanceof ShadowRoot?i.host:i,e)}function WOe(t,e){return!!qOe(e,r=>r===t?!0:void 0)}function XOe(t){return(!!t).toString()}/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */function cQ(){const{classList:t}=document.body,e=window.matchMedia("(prefers-color-scheme: dark)").matches,r=()=>t.contains(BOe)||t.contains(zOe)&&e?"dark":"light",i=o=>document.body.dispatchEvent(new CustomEvent("calciteModeChange",{bubbles:!0,detail:{mode:o}})),s=o=>{n!==o&&i(o),n=o};let n=r();i(n),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>s(o.matches?"dark":"light")),new MutationObserver(()=>s(r())).observe(document.body,{attributes:!0,attributeFilter:["class"]})}function YOe(){typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document&&(document.readyState==="interactive"?cQ():document.addEventListener("DOMContentLoaded",()=>cQ(),{once:!0}))}const ZOe=YOe;ZOe();let w_;function de(t){return typeof w_[t]=="function"?w_[t]=w_[t](globalThis):w_[t]}var ahe,lhe,che,uhe;w_=(ahe=globalThis.dojoConfig)!=null&&ahe.has||(lhe=globalThis.esriConfig)!=null&&lhe.has?{...(che=globalThis.dojoConfig)==null?void 0:che.has,...(uhe=globalThis.esriConfig)==null?void 0:uhe.has}:{},de.add=(t,e,r,i)=>((i||w_[t]===void 0)&&(w_[t]=e),r&&de(t)),de.cache=w_,de.add("esri-deprecation-warnings",!0),(()=>{var e;de.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const t=typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document;if(de.add("host-browser",t),de.add("host-node",typeof globalThis.process=="object"&&((e=globalThis.process.versions)==null?void 0:e.node)&&globalThis.process.versions.v8),de.add("dom",t),de("host-browser")){const r=navigator,i=r.userAgent,s=r.appVersion,n=parseFloat(s);if(de.add("wp",parseFloat(i.split("Windows Phone")[1])||void 0),de.add("msapp",parseFloat(i.split("MSAppHost/")[1])||void 0),de.add("khtml",s.includes("Konqueror")?n:void 0),de.add("edge",parseFloat(i.split("Edge/")[1])||void 0),de.add("opr",parseFloat(i.split("OPR/")[1])||void 0),de.add("webkit",!de("wp")&&!de("edge")&&parseFloat(i.split("WebKit/")[1])||void 0),de.add("chrome",!de("edge")&&!de("opr")&&parseFloat(i.split("Chrome/")[1])||void 0),de.add("android",!de("wp")&&parseFloat(i.split("Android ")[1])||void 0),de.add("safari",!s.includes("Safari")||de("wp")||de("chrome")||de("android")||de("edge")||de("opr")?void 0:parseFloat(s.split("Version/")[1])),de.add("mac",s.includes("Macintosh")),!de("wp")&&i.match(/(iPhone|iPod|iPad)/)){const o=RegExp.$1.replace(/P/,"p"),a=i.match(/OS ([\d_]+)/)?RegExp.$1:"1",l=parseFloat(a.replace(/_/,".").replace(/_/g,""));de.add(o,l),de.add("ios",l)}de("webkit")||(!i.includes("Gecko")||de("wp")||de("khtml")||de("edge")||de.add("mozilla",n),de("mozilla")&&de.add("ff",parseFloat(i.split("Firefox/")[1]||i.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const t=navigator.userAgent,e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(t),r=/iPhone/i.test(t);e&&de.add("esri-mobile",e),r&&de.add("esri-iPhone",r),de.add("esri-geolocation",!!navigator.geolocation)}de.add("esri-wasm","WebAssembly"in globalThis),de.add("esri-shared-array-buffer",()=>{const t="SharedArrayBuffer"in globalThis,e=globalThis.crossOriginIsolated===!1;return t&&!e}),de.add("wasm-simd",()=>{const t=[0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11];return WebAssembly.validate(new Uint8Array(t))}),de.add("esri-atomics","Atomics"in globalThis),de.add("esri-workers","Worker"in globalThis),de.add("web-feat:cache","caches"in globalThis),de.add("esri-workers-arraybuffer-transfer",!de("safari")||Number(de("safari"))>=12),de.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),de.add("featurelayer-simplify-payload-size-factors",[1,1,4]),de.add("featurelayer-snapshot-enabled",!0),de.add("featurelayer-snapshot-point-min-threshold",8e4),de.add("featurelayer-snapshot-point-max-threshold",4e5),de.add("featurelayer-snapshot-point-coverage",.1),de.add("featurelayer-advanced-symbols",!1),de.add("featurelayer-pbf",!0),de.add("featurelayer-pbf-statistics",!1),de.add("feature-layers-workers",!0),de.add("feature-polyline-generalization-factor",1),de.add("mapview-transitions-duration",200),de.add("mapview-srswitch-adjust-rotation-scale-threshold",24e6),de.add("mapserver-pbf-version-support",10.81),de.add("mapservice-popup-identify-max-tolerance",20),de.add("heatmap-allow-raster-fallback",!0),de.add("heatmap-force-raster",!1),de("host-webworker")||de("host-browser")&&(de.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),de.add("esri-image-decode",()=>{if("decode"in new Image){const t=new Image;return t.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void t.decode().then(()=>{de.add("esri-image-decode",!0,!0,!0)}).catch(()=>{de.add("esri-image-decode",!1,!0,!0)})}return!1}),de.add("esri-url-encodes-apostrophe",()=>{const t=window.document.createElement("a");return t.href="?'",t.href.includes("?%27")}))})();const b1=null;function v(t){return t!=null}function C(t){return t==null}function ao(t,e){return v(t)?e(t):b1}function ETt(t){return t}function CTt(t){return t}function Fl(t,e){return z4(t,e),t}function z4(t,e){if(C(t))throw new Error(e??"value is None")}function It(t,e){return v(t)?t:typeof e=="function"?e():e}function uQ(t,e){return v(t)?t:e}function Ve(t){return v(t)&&t.destroy(),null}function et(t){return v(t)&&t.dispose(),null}function Vi(t){return v(t)&&t.remove(),null}function jh(t){return v(t)&&t.abort(),null}function ji(t){return v(t)&&t.release(),null}function JOe(t,e,r){return v(t)&&v(e)?v(r)?r(t,e):t.equals(e):t===e}function yw(t){return null}function ATt(t,e){const r=new Array;return t.forEach(i=>{const s=e(i);v(s)&&r.push(s)}),r}function RTt(t,e){const r=new Array;for(const i of t)r.push(xu(i,null,e));return r}function OTt(t,e){for(const r of t)ao(r,e)}function xu(t,e,r){return v(t)?r(t):e}function MTt(t){return t.filter(e=>v(e))}function Js(t,...e){let r=t;for(let i=0;i<e.length&&r;++i)r=r[e[i]];return r}function PTt(t){return t}let iO=class w1{constructor(e=1){this._seed=e}set seed(e){this._seed=e??Math.random()*w1._m}getInt(){return this._seed=(w1._a*this._seed+w1._c)%w1._m,this._seed}getFloat(){return this.getInt()/(w1._m-1)}getIntRange(e,r){return Math.round(this.getFloatRange(e,r))}getFloatRange(e,r){const i=r-e;return e+this.getInt()/w1._m*i}};iO._m=2147483647,iO._a=48271,iO._c=0;function gM(t,e){return e?t.filter((r,i,s)=>s.findIndex(e.bind(null,r))===i):t.filter((r,i,s)=>s.indexOf(r)===i)}function ry(t,e,r){if(C(t)&&C(e))return!0;if(C(t)||C(e)||t.length!==e.length)return!1;if(r){for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1}else for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function Kq(t,e){let r=t.length!==e.length;r&&(t.length=e.length);for(let i=0;i<e.length;++i)t[i]!==e[i]&&(t[i]=e[i],r=!0);return r}function KOe(t,e,r){let i,s;return r?(i=e.filter(n=>!t.some(o=>r(o,n))),s=t.filter(n=>!e.some(o=>r(o,n)))):(i=e.filter(n=>!t.includes(n)),s=t.filter(n=>!e.includes(n))),{added:i,removed:s}}function QOe(t){return t&&typeof t.length=="number"}function ITt(t,e){const r=t.length;if(r===0)return[];const i=[];for(let s=0;s<r;s+=e)i.push(t.slice(s,s+e));return i}const e3e=!!Array.prototype.fill;function $Tt(t,e){if(e3e)return new Array(t).fill(e);const r=new Array(t);for(let i=0;i<t;i++)r[i]=e;return r}function t3e(t,e){e===void 0&&(e=t,t=0);const r=new Array(e-t);for(let i=t;i<e;i++)r[i-t]=i;return r}function r3e(t,e,r){const i=t.length;let s=0,n=i-1;for(;s<n;){const a=s+Math.floor((n-s)/2);e>t[a]?s=a+1:n=a}const o=t[s];return r?e>=t[i-1]?-1:o===e?s:s-1:o===e?s:-1}let Lhe=class{constructor(){this.last=0}};const Dhe=new Lhe;function Sk(t,e,r,i){i=i||Dhe;const s=Math.max(0,i.last-10);for(let o=s;o<r;++o)if(t[o]===e)return i.last=o,o;const n=Math.min(s,r);for(let o=0;o<n;++o)if(t[o]===e)return i.last=o,o;return-1}function r3(t,e,r,i){const s=r??t.length,n=Sk(t,e,s,i);if(n!==-1)return t[n]=t[s-1],r==null&&t.pop(),e}const ld=new Set;function i3e(t,e,r=t.length,i=e.length,s,n){if(i===0||r===0)return r;ld.clear();for(let a=0;a<i;++a)ld.add(e[a]);s=s||Dhe;const o=Math.max(0,s.last-10);for(let a=o;a<r;++a)if(ld.has(t[a])&&(n&&n.push(t[a]),ld.delete(t[a]),t[a]=t[r-1],--r,--a,ld.size===0||r===0))return ld.clear(),r;for(let a=0;a<o;++a)if(ld.has(t[a])&&(n&&n.push(t[a]),ld.delete(t[a]),t[a]=t[r-1],--r,--a,ld.size===0||r===0))return ld.clear(),r;return ld.clear(),r}function s3e(t,e){let r=0;for(let i=0;i<t.length;++i){const s=t[i];e(s,i)&&(t[r]=s,r++)}t.length=r}function n3e(t){return t?(hQ.seed=t,()=>hQ.getFloat()):Math.random}function DTt(t,e){const r=n3e(e);for(let i=t.length-1;i>0;i--){const s=Math.floor(r()*(i+1)),n=t[i];t[i]=t[s],t[s]=n}return t}const hQ=new iO;function Qq(t,e){const r=t.indexOf(e);return r!==-1?(t.splice(r,1),e):null}function NTt(t,e){const r=new Map,i=t.length;for(let s=0;s<i;s++){const n=t[s],o=e(n,s,t),a=r.get(o);a?a.push(n):r.set(o,[n])}return r}function _C(t){return t instanceof ArrayBuffer}function o3e(t){return t&&t.constructor&&t.constructor.name==="Int8Array"}function Tb(t){return t&&t.constructor&&t.constructor.name==="Uint8Array"}function a3e(t){return t&&t.constructor&&t.constructor.name==="Uint8ClampedArray"}function l3e(t){return t&&t.constructor&&t.constructor.name==="Int16Array"}function eW(t){return t&&t.constructor&&t.constructor.name==="Uint16Array"}function c3e(t){return t&&t.constructor&&t.constructor.name==="Int32Array"}function tW(t){return t&&t.constructor&&t.constructor.name==="Uint32Array"}function rW(t){return t&&t.constructor&&t.constructor.name==="Float32Array"}function iW(t){return t&&t.constructor&&t.constructor.name==="Float64Array"}function bP(t){return v(t)?128+t.buffer.byteLength+64:0}const nm=1024;function Nhe(t,e){let r;if(e)for(r in t)t.hasOwnProperty(r)&&(t[r]===void 0?delete t[r]:t[r]instanceof Object&&Nhe(t[r],!0));else for(r in t)t.hasOwnProperty(r)&&t[r]===void 0&&delete t[r];return t}function te(t){if(!t||typeof t!="object"||typeof t=="function")return t;const e=khe(t);if(v(e))return e;if(Fhe(t))return t.clone();if(Uhe(t))return t.map(te);if(Vhe(t))return t.clone();const r={};for(const i of Object.getOwnPropertyNames(t))r[i]=te(t[i]);return r}function Ek(t){if(!t||typeof t!="object"||typeof t=="function"||"HTMLElement"in globalThis&&t instanceof HTMLElement)return t;const e=khe(t);if(v(e))return e;if(Uhe(t)){let r=!0;const i=t.map(s=>{const n=Ek(s);return s!=null&&n==null&&(r=!1),n});return r?i:null}if(Fhe(t))return t.clone();if(!Vhe(t)){const r=new(Object.getPrototypeOf(t)).constructor;for(const i of Object.getOwnPropertyNames(t)){const s=t[i],n=Ek(s);if(s!=null&&n==null)return null;r[i]=n}return r}return null}function Fhe(t){return typeof t.clone=="function"}function Uhe(t){return typeof t.map=="function"&&typeof t.forEach=="function"}function Vhe(t){return typeof t.notifyChange=="function"&&typeof t.watch=="function"}function dQ(t){if(Object.prototype.toString.call(t)!=="[object Object]")return!1;const e=Object.getPrototypeOf(t);return e===null||e===Object.prototype}function khe(t){if(o3e(t)||Tb(t)||a3e(t)||l3e(t)||eW(t)||c3e(t)||tW(t)||rW(t)||iW(t))return t.slice();if(t instanceof Date)return new Date(t.getTime());if(t instanceof ArrayBuffer)return t.slice(0,t.byteLength);if(t instanceof Map){const e=new Map;for(const[r,i]of t)e.set(r,te(i));return e}if(t instanceof Set){const e=new Set;for(const r of t)e.add(te(r));return e}return null}function sW(t,e){return t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e)||typeof(t||{}).getTime=="function"&&typeof(e||{}).getTime=="function"&&t.getTime()===e.getTime()||!1}function u3e(t,e){return t===e||(t==null||typeof t=="string"?t===e:typeof t=="number"?t===e||typeof e=="number"&&isNaN(t)&&isNaN(e):t instanceof Date?e instanceof Date&&t.getTime()===e.getTime():Array.isArray(t)?Array.isArray(e)&&ry(t,e):t instanceof Set?e instanceof Set&&d3e(t,e):t instanceof Map?e instanceof Map&&p3e(t,e):!!dQ(t)&&dQ(e)&&h3e(t,e))}function h3e(t,e){if(t===null||e===null)return!1;const r=Object.keys(t);if(e===null||Object.keys(e).length!==r.length)return!1;for(const i of r)if(t[i]!==e[i]||!Object.prototype.hasOwnProperty.call(e,i))return!1;return!0}function d3e(t,e){if(t.size!==e.size)return!1;for(const r of t)if(!e.has(r))return!1;return!0}function p3e(t,e){if(t.size!==e.size)return!1;for(const[r,i]of t){const s=e.get(r);if(s!==i||s===void 0&&!e.has(r))return!1}return!0}function zhe(t,e,r=!1){return Ghe(t,e,r)}function yM(t,e){if(e!=null)return e[t]||Bhe(t.split("."),!1,e)}function sl(t,e,r){const i=t.split("."),s=i.pop(),n=Bhe(i,!0,r);n&&s&&(n[s]=e)}function Bhe(t,e,r){let i=r;for(const s of t){if(i==null)return;if(!(s in i)){if(!e)return;i[s]={}}i=i[s]}return i}function Ghe(t,e,r){return e?Object.keys(e).reduce((i,s)=>{let n=i[s],o=e[s];return n===o?i:n===void 0?(i[s]=te(o),i):(Array.isArray(o)||Array.isArray(i)?(n=n?Array.isArray(n)?i[s]=n.concat():i[s]=[n]:i[s]=[],o&&(Array.isArray(o)||(o=[o]),r?o.forEach(a=>{n.includes(a)||n.push(a)}):i[s]=o.concat())):o&&typeof o=="object"?i[s]=Ghe(n,o,r):i.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(i[s]=o),i)},t||{}):t}var hhe;const Qr={analysisTheme:{accentColor:[255,128,0],textColor:"white"},apiKey:void 0,applicationUrl:(hhe=globalThis.location)==null?void 0:hhe.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",userPrivilegesApplied:!1,portalUrl:"https://www.arcgis.com",routeServiceUrl:"https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{crossOriginNoCorsDomains:null,httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,priority:"high",proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(zhe(Qr,globalThis.esriConfig,!0),delete Qr.has),!Qr.assetsPath){{const t="4.26.5";Qr.assetsPath=`https://js.arcgis.com/${t.slice(0,-2)}/@arcgis/core/assets`}Qr.defaultAssetsPath=Qr.assetsPath}function u(t,e,r,i){var s,n=arguments.length,o=n<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,r):i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o}const f3e=/\{([^\}]+)\}/g;function pQ(t){return t??""}function om(t,e){return t.replace(f3e,typeof e=="object"?(r,i)=>pQ(yM(i,e)):(r,i)=>pQ(e(i)))}function FTt(t,e){return t.replace(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,r=>e&&e.includes(r)?r:`\\${r}`)}function nW(t){let e=0;for(let r=0;r<t.length;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e}function UTt(t){return new DOMParser().parseFromString(t||"","text/html").body.innerText||""}const fQ={info:0,warn:1,error:2,none:3};let se=class Va{constructor(e){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},e.level!=null&&(this.level=e.level),e.writer!=null&&(this.writer=e.writer),this._module=e.module,Va._loggers[this.module]=this;const r=this.module.lastIndexOf(".");r!==-1&&(this._parent=Va.getLogger(this.module.slice(0,r)))}get module(){return this._module}get parent(){return this._parent}error(...e){this._log("error","always",...e)}warn(...e){this._log("warn","always",...e)}info(...e){this._log("info","always",...e)}errorOnce(...e){this._log("error","once",...e)}warnOnce(...e){this._log("warn","once",...e)}infoOnce(...e){this._log("info","once",...e)}errorOncePerTick(...e){this._log("error","oncePerTick",...e)}warnOncePerTick(...e){this._log("warn","oncePerTick",...e)}infoOncePerTick(...e){this._log("info","oncePerTick",...e)}get test(){const e=this;return{loggedMessages:e._loggedMessages,clearLoggedWarnings:()=>e._loggedMessages.warn.clear()}}static get testSingleton(){return{resetLoggers(e={}){const r=Va._loggers;return Va._loggers=e,r},set throttlingDisabled(e){Va._throttlingDisabled=e}}}static getLogger(e){let r=Va._loggers[e];return r||(r=new Va({module:e})),r}_log(e,r,...i){if(this._matchLevel(e)){if(r!=="always"&&!Va._throttlingDisabled){const s=this._argsToKey(i),n=this._loggedMessages[e].get(s);if(r==="once"&&n!=null||r==="oncePerTick"&&n&&n>=Va._tickCounter)return;this._loggedMessages[e].set(s,Va._tickCounter),Va._scheduleTickCounterIncrement()}for(const s of Qr.log.interceptors)if(s(e,this.module,...i))return;this._inheritedWriter()(e,this.module,...i)}}_parentWithMember(e,r){let i=this;for(;v(i);){const s=i[e];if(v(s))return s;i=i.parent}return r}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(e,r,...i){console[e](`[${r}]`,...i)}_matchLevel(e){const r=Qr.log.level?Qr.log.level:"warn";return fQ[this._parentWithMember("level",r)]<=fQ[e]}_argsToKey(...e){return nW(JSON.stringify(e,(i,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]"))}static _scheduleTickCounterIncrement(){Va._tickCounterScheduled||(Va._tickCounterScheduled=!0,Promise.resolve().then(()=>{Va._tickCounter++,Va._tickCounterScheduled=!1}))}};se._loggers={},se._tickCounter=0,se._tickCounterScheduled=!1,se._throttlingDisabled=!1;function m3e(t,e){return t.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,(r,i)=>{if(i==="")return"$";const s=yM(i,e),n=s??"";if(n===void 0)throw new Error(`could not find key "${i}" in template`);return n.toString()})}let jhe=class Hhe{constructor(e,r,i){this.name=e,this.details=i,this instanceof Hhe&&(this.message=(r&&m3e(r,i))??"")}toString(){return"["+this.name+"]: "+this.message}},j=class yL extends jhe{constructor(e,r,i){if(super(e,r,i),!(this instanceof yL))return new yL(e,r,i)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(e,r)=>{if(r&&typeof r=="object"&&typeof r.toJSON=="function")return r;try{return te(r)}catch{return"[object]"}}))}}catch(e){throw se.getLogger("esri.core.Error").error(e),e}return{name:this.name,message:this.message,details:this.details}}static fromJSON(e){return new yL(e.name,e.message,e.details)}};j.prototype.type="error";const g3e=/^https:\/\/([a-z\d-]+)(\.maps([^.]*))?\.arcgis\.com/i,y3e={devext:{customBaseUrl:"mapsdevext.arcgis.com",portalHostname:"devext.arcgis.com"},qaext:{customBaseUrl:"mapsqa.arcgis.com",portalHostname:"qaext.arcgis.com"},www:{customBaseUrl:"maps.arcgis.com",portalHostname:"www.arcgis.com"}};function mQ(t){const e=t==null?void 0:t.match(g3e);if(!e)return null;const[,r,i,s]=e;if(!r)return null;let n=null,o=null,a=null;const{devext:l,qaext:c,www:h}=y3e;if(i)if(n=r,s)switch(s.toLowerCase()){case"devext":({customBaseUrl:o,portalHostname:a}=l);break;case"qa":({customBaseUrl:o,portalHostname:a}=c);break;default:return null}else({customBaseUrl:o,portalHostname:a}=h);else switch(r.toLowerCase()){case"devext":({customBaseUrl:o,portalHostname:a}=l);break;case"qaext":({customBaseUrl:o,portalHostname:a}=c);break;case"www":({customBaseUrl:o,portalHostname:a}=h);break;default:return null}return{customBaseUrl:o,isPortal:!1,portalHostname:a,urlKey:n}}function _3e(t){return/\/(sharing|usrsvcs)\/(appservices|servers)\//i.test(t)}const v3e=se.getLogger("esri.core.urlUtils"),UE=Qr.request,gQ="esri/config: esriConfig.request.proxyUrl is not set.",qhe=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,Whe=/^\s*http:/i,b3e=/^\s*https:/i,w3e=/^\s*file:/i,x3e=/:\d+$/,T3e=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,S3e=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),E3e=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");let nS=class{constructor(e=""){this.uri=e,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let r=this.uri.match(S3e);this.scheme=r[2]||(r[1]?"":null),this.authority=r[4]||(r[3]?"":null),this.path=r[5],this.query=r[7]||(r[6]?"":null),this.fragment=r[9]||(r[8]?"":null),this.authority!=null&&(r=this.authority.match(E3e),this.user=r[3]||null,this.password=r[4]||null,this.host=r[6]||r[7],this.port=r[9]||null)}toString(){return this.uri}};const wP={},C3e=new nS(Qr.applicationUrl);let Za=C3e;const A3e=R3e();let oW=A3e;const aW=()=>Za,kTt=()=>oW;function R3e(){const t=Za.path,e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${Za.scheme}://${Za.host}${Za.port!=null?`:${Za.port}`:""}`}${e}`}function lo(t){if(!t)return null;const e={path:null,query:null},r=new nS(t),i=t.indexOf("?");return r.query===null?e.path=t:(e.path=t.substring(0,i),e.query=Xhe(r.query)),r.fragment&&(e.hash=r.fragment,r.query===null&&(e.path=e.path.substring(0,e.path.length-(r.fragment.length+1)))),e}function Xhe(t){const e=t.split("&"),r={};for(const i of e){if(!i)continue;const s=i.indexOf("=");let n,o;s<0?(n=decodeURIComponent(i),o=""):(n=decodeURIComponent(i.slice(0,s)),o=decodeURIComponent(i.slice(s+1)));let a=r[n];typeof a=="string"&&(a=r[n]=[a]),Array.isArray(a)?a.push(o):r[n]=o}return r}function yQ(t){return t&&typeof t=="object"&&"toJSON"in t&&typeof t.toJSON=="function"}function i3(t,e){return t?e&&typeof e=="function"?Object.keys(t).map(r=>encodeURIComponent(r)+"="+encodeURIComponent(e(r,t[r]))).join("&"):Object.keys(t).map(r=>{const i=t[r];if(i==null)return"";const s=encodeURIComponent(r)+"=",n=e&&e[r];return n?s+encodeURIComponent(n(i)):Array.isArray(i)?i.map(o=>yQ(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):yQ(i)?s+encodeURIComponent(JSON.stringify(i)):s+encodeURIComponent(i)}).filter(r=>r).join("&"):""}function O3e(t=!1){let e,r=UE.proxyUrl;if(typeof t=="string"){e=N3e(t);const i=B4(t);i&&(r=i.proxyUrl)}else e=!!t;if(!r)throw v3e.warn(gQ),new j("urlutils:proxy-not-set",gQ);return e&&Ck()&&(r=pW(r)),lo(r)}function zTt(t){const e=B4(t);let r,i;if(e){const s=lW(e.proxyUrl);r=s.path,i=s.query?Xhe(s.query):null}if(r){const s=lo(t);t=r+"?"+s.path;const n=i3({...i,...s.query});n&&(t=`${t}?${n}`)}return t}const vC={path:"",query:""};function lW(t){const e=t.indexOf("?");return e!==-1?(vC.path=t.slice(0,e),vC.query=t.slice(e+1)):(vC.path=t,vC.query=null),vC}function Yhe(t){return t=(t=AN(t=B3e(t=lW(t).path),!0)).toLowerCase()}function M3e(t){const e={proxyUrl:t.proxyUrl,urlPrefix:Yhe(t.urlPrefix)},r=UE.proxyRules,i=e.urlPrefix;let s=r.length;for(let n=0;n<r.length;n++){const o=r[n].urlPrefix;if(i.indexOf(o)===0){if(i.length===o.length)return-1;s=n;break}o.indexOf(i)===0&&(s=n+1)}return r.splice(s,0,e),s}function B4(t){const e=UE.proxyRules,r=Yhe(t);for(let i=0;i<e.length;i++)if(r.indexOf(e[i].urlPrefix)===0)return e[i]}function P3e(t,e){if(!t||!e)return!1;t=CN(t),e=CN(e);const r=mQ(t),i=mQ(e);return v(r)&&v(i)?r.portalHostname===i.portalHostname:!v(r)&&!v(i)&&NS(t,e,!0)}function Zhe(t,e){return t=CN(t),e=CN(e),AN(t)===AN(e)}function CN(t){const e=(t=Uh(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function Jhe(t){const e=i=>i==null||i instanceof RegExp&&i.test(t)||typeof i=="string"&&t.startsWith(i),r=UE.interceptors;if(r){for(const i of r)if(Array.isArray(i.urls)){if(i.urls.some(e))return i}else if(e(i.urls))return i}return null}function NS(t,e,r=!1){if(!t||!e)return!1;const i=Rk(t),s=Rk(e);return!(!r&&i.scheme!==s.scheme)&&i.host!=null&&s.host!=null&&i.host.toLowerCase()===s.host.toLowerCase()&&i.port===s.port}function cW(t){if(typeof t=="string"){if(!Mu(t))return!0;t=Rk(t)}if(NS(t,Za))return!0;const e=UE.trustedServers||[];for(let r=0;r<e.length;r++){const i=I3e(e[r]);for(let s=0;s<i.length;s++)if(NS(t,i[s]))return!0}return!1}function I3e(t){return wP[t]||(dW(t)||am(t)?wP[t]=[new nS(Eu(t))]:wP[t]=[new nS(`http://${t}`),new nS(`https://${t}`)]),wP[t]}function Eu(t,e=oW,r){return am(t)?r&&r.preserveProtocolRelative?t:Za.scheme==="http"&&Za.authority===dp(t).slice(2)?`http:${t}`:`https:${t}`:dW(t)?t:Nu(t[0]==="/"?k3e(e):e,t)}function uW(t,e=oW,r){if(t==null||!Mu(t))return t;const i=Uh(t),s=i.toLowerCase(),n=Uh(e).toLowerCase().replace(/\/+$/,""),o=r?Uh(r).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return t;const a=(p,f,m)=>(m=p.indexOf(f,m))===-1?p.length:m;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return t;t=i.slice(c);const h=n.slice(c-1).replace(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)t=`../${t}`;else t=`./${t}`;return t}function Uh(t){return t=H3e(t=j3e(t=G3e(t=Eu(t=t.trim()))))}function Nu(...t){const e=t.filter(v);if(!e||!e.length)return;const r=[];if(Mu(e[0])){const s=e[0],n=s.indexOf("//");n!==-1&&(r.push(s.slice(0,n+1)),U3e(e[0])&&(r[0]+="/"),e[0]=s.slice(n+2))}else e[0][0]==="/"&&r.push("");const i=e.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<i.length;s++){const n=i[s];n===".."&&r.length>0&&r[r.length-1]!==".."?r.pop():(!n&&s===i.length-1||n&&(n!=="."||r.length===0))&&r.push(n)}return r.join("/")}function dp(t,e=!1){if(t==null||FS(t)||bm(t))return null;let r=t.indexOf("://");if(r===-1&&am(t))r=2;else{if(r===-1)return null;r+=3}const i=t.indexOf("/",r);return i!==-1&&(t=t.slice(0,i)),e&&(t=AN(t,!0)),t}function Mu(t){return am(t)||dW(t)}function FS(t){return t!=null&&t.slice(0,5)==="blob:"}function bm(t){return t!=null&&t.slice(0,5)==="data:"}function hW(t){const e=_M(t);if(!e||!e.isBase64)return null;const r=atob(e.data),i=new Uint8Array(r.length);for(let s=0;s<r.length;s++)i[s]=r.charCodeAt(s);return i.buffer}function BTt(t){return btoa(String.fromCharCode.apply(null,t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const $3e=/^data:(.*?)(;base64)?,(.*)$/;function _M(t){const e=t.match($3e);if(!e)return null;const[,r,i,s]=e;return{mediaType:r,isBase64:!!i,data:s}}function Khe(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function GTt(t){const e=hW(t);if(!e)return null;const r=_M(t);return new Blob([e],{type:r.mediaType})}function jTt(t,e){L3e(t,e)||D3e(t,e)}function L3e(t,e){if(!t)return!1;const r=document.createElement("a");if(!("download"in r))return!1;const i=URL.createObjectURL(t);return r.download=e,r.href=i,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),!0}function D3e(t,e){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(t,e)}function am(t){return t!=null&&t[0]==="/"&&t[1]==="/"}function dW(t){return t!=null&&qhe.test(t)}function N3e(t){return t!=null&&b3e.test(t)||Za.scheme==="https"&&am(t)}function F3e(t){return t!=null&&Whe.test(t)||Za.scheme==="http"&&am(t)}function U3e(t){return t!=null&&w3e.test(t)}function pW(t){return am(t)?`https:${t}`:t.replace(Whe,"https:")}function V3e(){return Za.scheme==="http"}function Ck(){return Za.scheme==="https"}function AN(t,e=!1){return am(t)?t.slice(2):(t=t.replace(qhe,""),e&&t.length>1&&t[0]==="/"&&t[1]==="/"&&(t=t.slice(2)),t)}function k3e(t){const e=t.indexOf("//"),r=t.indexOf("/",e+2);return r===-1?t:t.slice(0,r)}function z3e(t){let e=0;if(Mu(t)){const i=t.indexOf("//");i!==-1&&(e=i+2)}const r=t.lastIndexOf("/");return r<e?t:t.slice(0,r+1)}function HTt(t,e){if(!t)return"";const r=lo(t).path.replace(/\/+$/,""),i=r.substring(r.lastIndexOf("/")+1);if(!(e!=null&&e.length))return i;const s=new RegExp(`.(${e.join("|")})$`,"ig");return i.replace(s,"")}function B3e(t){return t&&t[t.length-1]==="/"?t:`${t}/`}function Qhe(t){return t.replace(/\/+$/,"")}function G3e(t){if(/^https?:\/\//i.test(t)){const e=lW(t);t=(t=e.path.replace(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}function j3e(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function H3e(t){const e=UE.httpsDomains;if(!F3e(t))return t;const r=t.indexOf("/",7);let i;if(i=r===-1?t:t.slice(0,r),i=i.toLowerCase().slice(7),x3e.test(i)){if(!i.endsWith(":80"))return t;i=i.slice(0,-3),t=t.replace(":80","")}return V3e()&&i===Za.authority&&!T3e.test(t)||(Ck()&&i===Za.authority||e&&e.some(s=>i===s||i.endsWith(`.${s}`))||Ck()&&!B4(t))&&(t=pW(t)),t}function Ak(t,e,r){if(!(e&&r&&t&&Mu(t)))return t;const i=t.indexOf("//"),s=t.indexOf("/",i+2),n=t.indexOf(":",i+2),o=Math.min(s<0?t.length:s,n<0?t.length:n);return t.slice(i+2,o).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,i+2)}${r}${t.slice(o)}`}function Rk(t){return typeof t=="string"?new nS(Eu(t)):(t.scheme||(t.scheme=Za.scheme),t)}function ede(t){return W3e.test(t)}function tde(t,e){const r=lo(t),i=Object.keys(r.query||{});return i.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${i.join(", ")}.`),r.path}function fW(t,e,r){const i=lo(t),s=i.query||{};return s[e]=String(r),`${i.path}?${i3(s)}`}function oU(t,e){const r=lo(t),i=r.query||{};for(const n in e)i[n]=e[n];const s=i3(i);return s?`${r.path}?${s}`:r.path}function q3e(t){if(C(t))return null;const e=t.match(rde);return e?e[2]:null}function _Q(t){if(C(t))return null;const e=t.match(rde);return e?{path:e[1],extension:e[2]}:{path:t,extension:null}}const rde=/([^.]*)\.([^\/]*)$/,W3e=/(^data:image\/svg|\.svg$)/i,ide="20230301",sde="2657e728c1857e6d94c324181c0788310bb0958a",mW="4.26",X3e={async request(t,e){var a,l;const{default:r}=await ie(()=>Promise.resolve().then(()=>AIe),void 0,import.meta.url),i=t.options,s=i.responseType;i.signal=e==null?void 0:e.signal,i.responseType=s==="native"||s==="native-request-init"?"native-request-init":s&&["blob","json","text"].includes(s)&&((a=Jhe(t.url))!=null&&a.after)?s:"array-buffer";const n=await r(t.url,i),o={data:n.data,httpStatus:n.httpStatus,ssl:n.ssl};switch((l=n.requestOptions)==null?void 0:l.responseType){case"native-request-init":return delete o.data.signal,o;case"blob":o.data=await o.data.arrayBuffer();break;case"json":o.data=new TextEncoder().encode(JSON.stringify(o.data)).buffer;break;case"text":o.data=new TextEncoder().encode(o.data).buffer}return{result:o,transferList:[o.data]}}};let xi;function qTt(t){xi=t}function WTt(t){const e=xi&&xi.findCredential(t);return e&&e.token?fW(t,"token",e.token):t}de("host-webworker");function Y3e(t){return t&&t.release&&typeof t.release=="function"}function Z3e(t){return t&&t.acquire&&typeof t.acquire=="function"}let Po=class Ok{constructor(e,r,i,s=1,n=0){if(this._ctor=e,this._acquireFunction=r,this._releaseFunction=i,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this._ctor)for(let o=0;o<n;o++)this._pool[o]=new this._ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...e){let r;if(Ok.test.disabled)r=new this._ctor;else{if(this._pool.length===0){const i=this.allocationSize;for(let s=0;s<i;s++)this._pool[s]=new this._ctor}r=this._pool.pop()}return this._acquireFunction?this._acquireFunction(r,...e):Z3e(r)&&r.acquire(...e),r}release(e){e&&!Ok.test.disabled&&(this._releaseFunction?this._releaseFunction(e):Y3e(e)&&e.release(),this._pool.push(e))}prune(e=this._initialSize){if(!(e>=this._pool.length)){for(let r=e;r<this._pool.length;++r){const i=this._pool[r];this._dispose(i)}this._pool.length=e}}_dispose(e){e.dispose&&typeof e.dispose=="function"&&e.dispose()}};Po.test={disabled:!1};function J3e(t){t.length=0}let Tc=class{constructor(e=50,r=50){this._pool=new Po(Array,void 0,J3e,r,e)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return aU.acquire()}static release(e){return aU.release(e)}static prune(){aU.prune()}};const aU=new Tc(100);function YTt(t){const e=[];return function*(){yield*e;for(const r of t)e.push(r),yield r}}function K3e(t,e){for(const r of t)if(r!=null&&e(r))return r}function Mk(t){return t!=null&&typeof t[Symbol.iterator]=="function"}let Zr=class{constructor(){this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach(r=>{e+=r.length}),e}add(e,r){if(Mk(e)){const i=this._getOrCreateGroup(r);for(const s of e)this._isHandle(s)&&i.push(s)}else this._isHandle(e)&&this._getOrCreateGroup(r).push(e);return this}forEach(e,r){if(typeof e=="function")this._groups.forEach(i=>i.forEach(e));else{const i=this._getGroup(e);i&&r&&i.forEach(r)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(typeof e!="string"&&Mk(e)){for(const r of e)this.remove(r);return this}return this.has(e)?(this._removeAllFromGroup(this._getGroup(e)),this._groups.delete(this._ensureGroupKey(e)),this):this}removeAll(){return this._groups.forEach(e=>this._removeAllFromGroup(e)),this._groups.clear(),this}_isHandle(e){return e&&!!e.remove}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const r=[];return this._groups.set(this._ensureGroupKey(e),r),r}_getGroup(e){return this._groups.get(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}_removeAllFromGroup(e){e.forEach(r=>r.remove())}};const nde=Symbol("Accessor-beforeDestroy");function US(t){return yp(()=>t.forEach(e=>v(e)&&e.remove()))}function yp(t){return{remove:()=>{t&&(t(),t=void 0)}}}function JTt(t){return yp(v(t)?()=>t.destroy():void 0)}function nl(t){return t?t.__accessor__?t.__accessor__:t.propertyInvalidated?t:null:null}function Q3e(t,e){return t!=null&&t.metadatas&&t.metadatas[e]!=null}function _L(t,e,r){return r?RN(t,e,{policy:r,path:""}):RN(t,e,null)}function RN(t,e,r){return e?Object.keys(e).reduce((i,s)=>{let n=null,o="merge";if(r&&(n=r.path?`${r.path}.${s}`:s,o=r.policy(n)),o==="replace"||o==="replace-arrays"&&Array.isArray(i[s]))return i[s]=e[s],i;if(i[s]===void 0)return i[s]=te(e[s]),i;let a=i[s],l=e[s];if(a===l)return i;if(Array.isArray(l)||Array.isArray(i))a=a?Array.isArray(a)?i[s]=a.concat():i[s]=[a]:i[s]=[],l&&(Array.isArray(l)||(l=[l]),l.forEach(c=>{a.includes(c)||a.push(c)}));else if(l&&typeof l=="object")if(r){const c=r.path;r.path=n,i[s]=RN(a,l,r),r.path=c}else i[s]=RN(a,l,null);else i.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(i[s]=l);return i},t||{}):t}function ode(t){return Array.isArray(t)?t:t.split(".")}function vQ(t){return t.includes(",")?t.split(",").map(e=>e.trim()):[t.trim()]}function eMe(t){if(Array.isArray(t)){const e=[];for(const r of t)e.push(...vQ(r));return e}return vQ(t)}function ade(t,e,r,i){const s=eMe(e);if(s.length!==1){const n=s.map(o=>i(t,o,r));return US(n)}return i(t,s[0],r)}function gW(t){let e=!1;return()=>{e||(e=!0,t())}}function lde(t,e){const r=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const s=parseInt(r,10);if(!isNaN(s))return Array.isArray(e)?e[s]:e.getItemAt(s)}const i=nl(e);return Q3e(i,r)?i.get(r):e[r]}function cde(t,e,r){if(t==null)return t;const i=lde(e[r],t);return!i&&r<e.length-1?void 0:r===e.length-1?i:cde(i,e,r+1)}function vM(t,e,r=0){return typeof e!="string"||e.includes(".")?cde(t,ode(e),r):lde(e,t)}function ON(t,e){return vM(t,e)}function bQ(t,e){return vM(e,t)!==void 0}function bM(t){let e=t.constructor.__accessorMetadata__;const r=Object.prototype.hasOwnProperty.call(t.constructor,"__accessorMetadata__");if(e){if(!r){e=Object.create(e);for(const i in e)e[i]=te(e[i]);Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0})}}else e={},Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0});return t.constructor.__accessorMetadata__}function G4(t,e){const r=bM(t);let i=r[e];return i||(i=r[e]={}),i}function tMe(t,e){return _L(t,e,iMe)}const rMe=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function iMe(t){return rMe.test(t)?"replace":"merge"}var $g;(function(t){t[t.INITIALIZING=0]="INITIALIZING",t[t.CONSTRUCTING=1]="CONSTRUCTING",t[t.CONSTRUCTED=2]="CONSTRUCTED"})($g||($g={}));let sMe=class{constructor(e,r){this._observers=e,this._observer=r}remove(){Qq(this._observers,this._observer)}},ude=class{constructor(){this._observers=null,this.destroyed=!1}observe(e){if(this.destroyed||e.destroyed)return nMe;this._observers==null&&(this._observers=[]);const r=this._observers;let i=!1,s=!1;const n=r.length;for(let o=0;o<n;++o){const a=r[o];if(a.destroyed)s=!0;else if(a===e){i=!0;break}}return i||(r.push(e),s&&this._removeDestroyedObservers()),new sMe(r,e)}_removeDestroyedObservers(){const e=this._observers;if(!e||e.length===0)return;const r=e.length;let i=0;for(let s=0;s<r;++s){for(;s+i<r&&e[s+i].destroyed;)++i;if(i>0){if(!(s+i<r))break;e[s]=e[s+i]}}e.length=r-i}destroy(){if(this.destroyed)return;this.destroyed=!0;const e=this._observers;if(e!=null){for(const r of e)r.onCommitted();this._observers=null}}};const nMe={remove:()=>{}};var Gr;(function(t){t[t.DEFAULTS=0]="DEFAULTS",t[t.COMPUTED=1]="COMPUTED",t[t.SERVICE=2]="SERVICE",t[t.PORTAL_ITEM=3]="PORTAL_ITEM",t[t.WEB_SCENE=4]="WEB_SCENE",t[t.WEB_MAP=5]="WEB_MAP",t[t.USER=6]="USER"})(Gr||(Gr={}));const Pk=Gr.USER+1;function x_(t){switch(t){case"defaults":return Gr.DEFAULTS;case"service":return Gr.SERVICE;case"portal-item":return Gr.PORTAL_ITEM;case"web-scene":return Gr.WEB_SCENE;case"web-map":return Gr.WEB_MAP;case"user":return Gr.USER;default:return null}}function MN(t){switch(t){case Gr.DEFAULTS:return"defaults";case Gr.SERVICE:return"service";case Gr.PORTAL_ITEM:return"portal-item";case Gr.WEB_SCENE:return"web-scene";case Gr.WEB_MAP:return"web-map";case Gr.USER:return"user"}return void 0}function oMe(t){return MN(t)}var Ni;(function(t){t[t.Dirty=1]="Dirty",t[t.Overriden=2]="Overriden",t[t.Computing=4]="Computing",t[t.NonNullable=8]="NonNullable",t[t.HasDefaultValue=16]="HasDefaultValue",t[t.DepTrackingInitialized=32]="DepTrackingInitialized",t[t.AutoTracked=64]="AutoTracked",t[t.ExplicitlyTracking=128]="ExplicitlyTracking"})(Ni||(Ni={}));const PN={onObservableAccessed:()=>{},onTrackingEnd:()=>{}},MA=[];let sO=PN;function vr(t){sO.onObservableAccessed(t)}let vL=!1,bL=!1;function iy(t,e,r){if(vL)return yW(t,e,r);hde(t);const i=e.call(r);return dde(),i}function aMe(t,e){return iy(PN,t,e)}function yW(t,e,r){const i=vL;vL=!0,hde(t);let s=null;try{s=e.call(r)}catch(n){bL&&se.getLogger("esri.core.accessorSupport.tracking").error(n)}return dde(),vL=i,s}function hde(t){sO=t,MA.push(t)}function dde(){const t=MA.length;if(t>1){const e=MA.pop();sO=MA[t-2],e.onTrackingEnd()}else if(t===1){const e=MA.pop();sO=PN,e.onTrackingEnd()}else sO=PN}function pde(t,e){const r=e.observerObject;if(r.flags&Ni.DepTrackingInitialized)return;const i=bL;bL=!1,r.flags&Ni.AutoTracked?yW(e,e.metadata.get,t):fde(t,e),bL=i}const lMe=[];function fde(t,e){const r=e.observerObject;r.flags&Ni.ExplicitlyTracking||(r.flags|=Ni.ExplicitlyTracking,yW(e,()=>{const i=e.metadata.dependsOn||lMe;for(const s of i)if(typeof s!="string"||s.includes(".")){const n=ode(s);for(let o=0,a=t;o<n.length&&a!=null&&typeof a=="object";++o)a=wQ(a,n[o],o!==n.length-1)}else wQ(t,s,!1)}),r.flags&=~Ni.ExplicitlyTracking)}function wQ(t,e,r){var n;const i=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const o=parseInt(i,10);if(!isNaN(o))return Array.isArray(t)?t[o]:t.getItemAt(o)}const s=(n=nl(t))==null?void 0:n.properties.get(i);return s&&(vr(s.observerObject),pde(t,s)),r?t[i]:void 0}let xQ=class{constructor(e,r,i){this.properties=e,this.propertyName=r,this.metadata=i,this.observerObject=new cMe,this._accessed=null,this._handles=null,this.observerObject.flags=Ni.Dirty|(i.nonNullable?Ni.NonNullable:0)|(i.hasOwnProperty("value")?Ni.HasDefaultValue:0)|(i.get===void 0?Ni.DepTrackingInitialized:0)|(i.dependsOn===void 0?Ni.AutoTracked:0),TQ.register(this,this.observerObject)}destroy(){this.observerObject.destroy(),this._accessed=null,this._clearObservationHandles(),TQ.unregister(this)}getComputed(){const e=this.observerObject;vr(e);const r=this.properties.store,i=this.propertyName,s=e.flags,n=r.get(i);if(s&Ni.Computing||~s&Ni.Dirty&&r.has(i))return n;e.flags|=Ni.Computing;const o=this.properties.host;let a;s&Ni.AutoTracked?a=iy(this,this.metadata.get,o):(fde(o,this),a=this.metadata.get.call(o)),r.set(i,a,Gr.COMPUTED);const l=r.get(i);return l===n?e.flags&=~Ni.Dirty:aMe(this.commit,this),e.flags&=~Ni.Computing,l}onObservableAccessed(e){e!==this.observerObject&&(this._accessed===null&&(this._accessed=[]),this._accessed.includes(e)||this._accessed.push(e))}onTrackingEnd(){this._clearObservationHandles();const e=this.observerObject;e.flags|=Ni.DepTrackingInitialized;const r=this._accessed;if(r===null)return;let i=this._handles;i===null&&(i=this._handles=[]);for(let s=0;s<r.length;++s)i.push(r[s].observe(e));r.length=0}notifyChange(){const e=this.observerObject;e.onInvalidated(),e.onCommitted()}invalidate(){this.observerObject.onInvalidated()}commit(){const e=this.observerObject;e.flags&=~Ni.Dirty,e.onCommitted()}_clearObservationHandles(){const e=this._handles;if(e!==null){for(let r=0;r<e.length;++r)e[r].remove();e.length=0}}},cMe=class extends ude{constructor(){super(...arguments),this.flags=0}onInvalidated(){~this.flags&Ni.Overriden&&(this.flags|=Ni.Dirty);const e=this._observers;if(e&&e.length>0)for(const r of e)r.onInvalidated()}onCommitted(){const e=this._observers;if(e&&e.length>0){const r=e.slice();for(const i of r)i.onCommitted()}}destroy(){this.flags&Ni.Dirty&&this.onCommitted(),super.destroy()}};const TQ=new FinalizationRegistry(t=>{t.destroy()});let uMe=class mde{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new mde;return this._values.forEach((i,s)=>{e&&e.has(s)||r.set(s,te(i))}),r}get(e){return this._values.get(e)}originOf(){return Gr.USER}keys(){return[...this._values.keys()]}set(e,r){this._values.set(e,r)}delete(e){this._values.delete(e)}has(e){return this._values.has(e)}forEach(e){this._values.forEach(e)}};function xP(t,e,r){return t!==void 0}function SQ(t,e,r,i){return t!==void 0&&(!(r==null&&t.observerObject.flags&Ni.NonNullable)||(i.lifecycle,$g.INITIALIZING,!1))}function hMe(t){return t&&typeof t.destroy=="function"}se.getLogger("esri.core.accessorSupport.Properties");let dMe=class{constructor(e){this.host=e,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=$g.INITIALIZING,this.store=new uMe,this._origin=Gr.USER;const r=this.host.constructor.__accessorMetadata__;for(const i in r){const s=new xQ(this,i,r[i]);this.properties.set(i,s)}this.metadatas=r}initialize(){this.lifecycle=$g.CONSTRUCTING}constructed(){this.lifecycle=$g.CONSTRUCTED}destroy(){this.destroyed=!0;for(const[e,r]of this.properties){if(r.metadata.autoDestroy){const i=this.internalGet(e);i&&hMe(i)&&(i.destroy(),~r.observerObject.flags&Ni.NonNullable&&this._internalSet(r,null))}r.destroy()}}get initialized(){return this.lifecycle!==$g.INITIALIZING}get(e){const r=this.properties.get(e);if(r.metadata.get)return r.getComputed();vr(r.observerObject);const i=this.store;return i.has(e)?i.get(e):r.metadata.value}originOf(e){const r=this.store.originOf(e);if(r===void 0){const i=this.properties.get(e);if(i!==void 0&&i.observerObject.flags&Ni.HasDefaultValue)return"defaults"}return MN(r)}has(e){return!!this.properties.has(e)&&this.store.has(e)}keys(){return[...this.properties.keys()]}internalGet(e){const r=this.properties.get(e);if(xP(r))return this.store.has(e)?this.store.get(e):r.metadata.value}internalSet(e,r){const i=this.properties.get(e);xP(i)&&this._internalSet(i,r)}getDependsInfo(e,r,i){const s=this.properties.get(r);if(!xP(s))return"";const n=new Set,o=iy({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>{var l;return(l=s.metadata.get)==null?void 0:l.call(e)});let a=`${i}${e.declaredClass.split(".").pop()}.${r}: ${o}
`;if(n.size===0)return a;i+="  ";for(const l of n){if(!(l instanceof xQ))continue;const c=l.properties.host,h=l.propertyName,p=nl(c);a+=p?p.getDependsInfo(c,h,i):`${i}${h}: undefined
`}return a}setAtOrigin(e,r,i){const s=this.properties.get(e);if(xP(s))return this._setAtOrigin(s,r,i)}isOverridden(e){const r=this.properties.get(e);return r!==void 0&&!!(r.observerObject.flags&Ni.Overriden)}clearOverride(e){const r=this.properties.get(e),i=r==null?void 0:r.observerObject;i&&i.flags&Ni.Overriden&&(i.flags&=~Ni.Overriden,r.notifyChange())}override(e,r){const i=this.properties.get(e);if(!SQ(i,e,r,this))return;const s=i.metadata.cast;if(s){const n=this._cast(s,r),{valid:o,value:a}=n;if(lU.release(n),!o)return;r=a}i.observerObject.flags|=Ni.Overriden,this._internalSet(i,r)}set(e,r){const i=this.properties.get(e);if(!SQ(i,e,r,this))return;const s=i.metadata.cast;if(s){const o=this._cast(s,r),{valid:a,value:l}=o;if(lU.release(o),!a)return;r=l}const n=i.metadata.set;n?n.call(this.host,r):this._internalSet(i,r)}setDefaultOrigin(e){this._origin=x_(e)}getDefaultOrigin(){return MN(this._origin)}notifyChange(e){const r=this.properties.get(e);r!==void 0&&r.notifyChange()}invalidate(e){const r=this.properties.get(e);r!==void 0&&r.invalidate()}commit(e){const r=this.properties.get(e);r!==void 0&&r.commit()}_internalSet(e,r){const i=this.lifecycle!==$g.INITIALIZING?this._origin:Gr.DEFAULTS;this._setAtOrigin(e,r,i)}_setAtOrigin(e,r,i){const s=this.store,n=e.propertyName;s.has(n,i)&&sW(r,s.get(n))&&~e.observerObject.flags&Ni.Overriden&&i===s.originOf(n)||(e.invalidate(),s.set(n,r,i),e.commit(),pde(this.host,e))}_cast(e,r){const i=lU.acquire();return i.valid=!0,i.value=r,e&&(i.value=e.call(this.host,r,i)),i}},pMe=class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}};const lU=new Po(pMe);function IN(t,e,r){if(t&&e)if(typeof e=="object")for(const i of Object.getOwnPropertyNames(e))IN(t,i,e[i]);else{if(e.includes(".")){const s=e.split("."),n=s.splice(s.length-1,1)[0];return void IN(ON(t,s),n,r)}const i=t.__accessor__;i!=null&&fMe(e,i),t[e]=r}}function fMe(t,e){if(de("esri-unknown-property-errors")&&!mMe(t,e))throw new j("set:unknown-property",gMe(t,e))}function mMe(t,e){return e.metadatas[t]!=null}function gMe(t,e){return"setting unknown property '"+t+"' on instance of "+e.host.declaredClass}let gde=class extends Po{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=yw(this._set)}acquire(...e){const r=super.acquire(...e);return this._set.delete(r),r}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}};const TP=[];function VS(t){TP.push(t),TP.length===1&&queueMicrotask(()=>{const e=TP.slice();TP.length=0;for(const r of e)r()})}let Ug=class{constructor(e,r=30){this.name=e,this._counter=0,this._samples=new Array(r)}record(e){v(e)&&(this._samples[++this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort((e,r)=>e-r)[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce((e,r)=>e+r,0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}};var Ik;(function(t){const e=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const m=n[h-1];if(l(m,f)<=0)break;n[c-1]=m,c=h}n[c-1]=f},r=(n,o)=>n<o?-1:n>o?1:0;function i(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=r);for(let h=a>>>1;h>o;h--)e(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=r);for(let h=a>>>1;h>o;h--)e(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l),yield}}t.sort=i,t.iterableSort=s})(Ik||(Ik={}));const EQ=Ik,yMe=1.5,_Me=1.1;let Kt=class{constructor(e){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new Lhe,e&&(e.initialSize&&(this.data=new Array(e.initialSize)),e.allocator&&(this._allocator=e.allocator),e.deallocator!==void 0&&(this._deallocator=e.deallocator),e.shrink&&(this._shrink=()=>CQ(this)))}toArray(){return this.data.slice(0,this.length)}filter(e){const r=new Array;for(let i=0;i<this._length;i++){const s=this.data[i];e(s)&&r.push(s)}return r}getItemAt(e){if(!(e<0||e>=this._length))return this.data[e]}includes(e,r){const i=this.data.indexOf(e,r);return i!==-1&&i<this.length}get length(){return this._length}set length(e){if(e>this._length){if(this._allocator){for(;this._length<e;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=e}else{if(this._deallocator)for(let r=e;r<this._length;++r)this.data[r]=this._deallocator(this.data[r]);this._length=e,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(e){this.data[this._length++]=e}pushArray(e,r=e.length){for(let i=0;i<r;i++)this.data[this._length++]=e[i]}fill(e,r){for(let i=0;i<r;i++)this.data[this._length++]=e}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const e=this.data[this._length];return++this._length,e}unshift(e){this.data.unshift(e),this._length++,CQ(this)}pop(){if(this.length===0)return;const e=this.data[this.length-1];return this.length=this.length-1,this._shrink(),e}remove(e){const r=Sk(this.data,e,this.length,this._hint);if(r!==-1)return this.data.splice(r,1),this.length=this.length-1,e}removeUnordered(e){return this.removeUnorderedIndex(Sk(this.data,e,this.length,this._hint))}removeUnorderedIndex(e){if(!(e>=this.length||e<0))return this.swapElements(e,this.length-1),this.pop()}removeUnorderedMany(e,r=e.length,i){this.length=i3e(this.data,e,this.length,r,this._hint,i),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(e,r){if(e>=this.length||r>=this.length||e===r)return;const i=this.data[e];this.data[e]=this.data[r],this.data[r]=i}sort(e){EQ.sort(this.data,0,this.length,e)}iterableSort(e){return EQ.iterableSort(this.data,0,this.length,e)}some(e,r){for(let i=0;i<this.length;++i)if(e.call(r,this.data[i],i,this.data))return!0;return!1}find(e,r){for(let i=0;i<this.length;++i){const s=this.data[i];if(e.call(r,s,i))return s}}filterInPlace(e,r){let i=0;for(let s=0;s<this._length;++s){const n=this.data[s];e.call(r,n,s,this.data)&&(this.data[s]=this.data[i],this.data[i]=n,i++)}if(this._deallocator)for(let s=i;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=i,this._shrink(),this}forAll(e,r){const i=this.length,s=this.data;for(let n=0;n<i;++n)e.call(r,s[n],n,s)}forEach(e,r){for(let i=0;i<this.length;++i)e.call(r,this.data[i],i,this.data)}map(e,r){const i=new Array(this.length);for(let s=0;s<this.length;++s)i[s]=e.call(r,this.data[s],s,this.data);return i}reduce(e,r){let i=r;for(let s=0;s<this.length;++s)i=e(i,this.data[s],s,this.data);return i}has(e){const r=this.length,i=this.data;for(let s=0;s<r;++s)if(i[s]===e)return!0;return!1}};function CQ(t){t.data.length>yMe*t.length&&(t.data.length=Math.floor(t.length*_Me))}function vMe(t){return{setTimeout:(e,r)=>{const i=t.setTimeout(e,r);return{remove:()=>t.clearTimeout(i)}}}}const j4=vMe(globalThis),AQ=new Set;function bMe(t,e,r=!1){r&&AQ.has(e)||(r&&AQ.add(e),t.warn(` DEPRECATED - ${e}`))}function $k(t,e,r={}){if(de("esri-deprecation-warnings")){const{moduleName:i}=r;yde(t,`Property: ${(i?i+"::":"")+e}`,r)}}function yde(t,e,r={}){if(de("esri-deprecation-warnings")){const{replacement:i,version:s,see:n,warnOnce:o}=r;let a=e;i&&(a+=`
	 Replacement: ${i}`),s&&(a+=`
	 Version: ${s}`),n&&(a+=`
	 See ${n} for more details.`),bMe(t,a,o)}}function H4(t){return t&&(typeof t.on=="function"||typeof t.addEventListener=="function")}function wM(t,e,r){if(!H4(t))throw new TypeError("target is not a Evented or EventTarget object");if("on"in t)return t.on(e,r);if(Array.isArray(e)){const i=e.slice();for(const s of i)t.addEventListener(s,r);return{remove(){for(const s of i)t.removeEventListener(s,r)}}}return t.addEventListener(e,r),{remove(){t.removeEventListener(e,r)}}}function _de(t,e,r){if(!H4(t))throw new TypeError("target is not a Evented or EventTarget object");if("once"in t)return t.once(e,r);const i=wM(t,e,s=>{i.remove(),r.call(t,s)});return{remove(){i.remove()}}}const wMe={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function Sb({key:t}){return wMe[t]||t}function qr(t="Aborted"){return new j("AbortError",t)}function ur(t,e="Aborted"){if(Fn(t))throw qr(e)}function q4(t){return v(t)?"aborted"in t?t:t.signal:t}function Fn(t){const e=q4(t);return v(e)&&e.aborted}function Sc(t){if(Ks(t))throw t}function Lk(t){if(!Ks(t))throw t}function ba(t,e){const r=q4(t);if(!C(r)){if(!r.aborted)return _de(r,"abort",()=>e());e()}}function W4(t,e){const r=q4(t);if(!C(r))return ur(r),_de(r,"abort",()=>e(qr()))}function _W(t,e){const r=q4(e);return C(r)?t:new Promise((i,s)=>{let n=ba(e,()=>s(qr()));const o=()=>n=Vi(n);t.then(o,o),t.then(i,s)})}function Ks(t){return(t==null?void 0:t.name)==="AbortError"}async function oS(t){try{return await t}catch(e){if(!Ks(e))throw e;return}}async function a2t(t,e=se.getLogger("esri")){try{return await t}catch(r){Ks(r)||e.error(r)}}function J_(){let t=null;const e=new Promise((r,i)=>{t={promise:void 0,resolve:r,reject:i}});return t.promise=e,t}async function co(t){if(!t)return;if(typeof t.forEach!="function"){const r=Object.keys(t),i=r.map(o=>t[o]),s=await co(i),n={};return r.map((o,a)=>n[o]=s[a]),n}const e=t;return new Promise(r=>{const i=[];let s=e.length;s===0&&r(i),e.forEach(n=>{const o={promise:n||Promise.resolve(n)};i.push(o),o.promise.then(a=>{o.value=a}).catch(a=>{o.error=a}).then(()=>{--s,s===0&&r(i)})})})}async function Dk(t){return(await co(t)).filter(e=>!!e.value).map(e=>e.value)}function _w(t,e,r){const i=new AbortController;return ba(r,()=>i.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(e)},t);ba(i,()=>{o&&(clearTimeout(o),n(qr()))})})}function Gu(t){return t&&typeof t.then=="function"}function Nk(t){return Gu(t)?t:Promise.resolve(t)}function vW(t,e=-1){let r,i,s,n,o=null;const a=(...l)=>{if(r){i=l,n&&n.reject(qr()),n=J_();const f=n.promise;if(o){const m=o;o=null,m.abort()}return f}if(s=n||J_(),n=null,e>0){const f=new AbortController;r=Nk(t(...l,f.signal));const m=r;_w(e).then(()=>{r===m&&(n?f.abort():o=f)})}else r=1,r=Nk(t(...l));const c=()=>{const f=i;i=s=r=o=null,f!=null&&a(...f)},h=r,p=s;return h.then(c,c),h.then(p.resolve,p.reject),p.promise};return a}function K_(){let t,e;const r=new Promise((s,n)=>{t=s,e=n}),i=s=>{t(s)};return i.resolve=s=>t(s),i.reject=s=>e(s),i.timeout=(s,n)=>j4.setTimeout(()=>i.reject(n),s),i.promise=r,i}function l2t(t,e){return t.then(e,e)}async function RQ(t){await Promise.resolve(),ur(t)}function c2t(t){return t}function vde(t){return 1e3*t}function bW(t){return .001*t}let xMe=class{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}},TMe=class{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}},Fk=0,Uk=0;const bC={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},Vk=["prepare","preRender","render","postRender","update","finish"],kk=[],vw=new Kt;let SMe=class{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}};const $N={frameTasks:vw,willDispatch:!1,clearFrameTasks:EMe,dispatch:xde,executeFrameTasks:AMe};function VE(t){const e=new TMe(t);return kk.push(e),$N.willDispatch||($N.willDispatch=!0,VS(xde)),e}function kS(t){const e=new xMe(t);return vw.push(e),LN==null&&(Fk=performance.now(),LN=requestAnimationFrame(bde)),new SMe(e)}let LN=null;function EMe(t=!1){vw.forAll(e=>{e.removed=!0}),t&&wde()}function CMe(t){Uk=Math.max(0,t)}function bde(){const t=performance.now();LN=null,LN=vw.length>0?requestAnimationFrame(bde):null,$N.executeFrameTasks(t)}function AMe(t){const e=t-Fk;Fk=t;const r=Uk>0?Uk:1e3/60,i=Math.max(0,e-r);bC.time=t,bC.frameDuration=r-i;for(let s=0;s<Vk.length;s++){const n=performance.now(),o=Vk[s];vw.forAll(a=>{var l;a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(bC.elapsedFrameTime=performance.now()-t,bC.deltaTime=a.ticks===0?0:e,(l=a.phases[o])==null||l.call(a,bC)))}),RMe[s].record(performance.now()-n)}wde(),OMe.record(performance.now()-t)}const SP=new Kt;function wde(){vw.forAll(t=>{t.removed&&SP.push(t)}),vw.removeUnorderedMany(SP.data,SP.length),SP.clear()}function xde(){for(;kk.length;){const t=kk.shift();t.isActive&&t.callback()}$N.willDispatch=!1}function p2t(t=1,e){const r=K_(),i=()=>{Fn(e)?r.reject(qr()):t===0?r():(--t,VS(()=>i()))};return i(),r.promise}const RMe=Vk.map(t=>new Ug(t)),OMe=new Ug("total");function wL(t,e){for(const r of t.entries())if(e(r[0]))return!0;return!1}let MMe=0;const PMe=0;function $c(){return++MMe}let X4=class{constructor(e){this._notify=e,this._accessed=[],this._handles=[],this._observerObject=new IMe(this._notify),OQ.register(this,this._observerObject)}destroy(){var e;this._accessed.length=0,(e=this._observerObject)==null||e.destroy(),this.clear(),OQ.unregister(this)}onObservableAccessed(e){const r=this._accessed;r.includes(e)||r.push(e)}onTrackingEnd(){const e=this._handles,r=this._accessed,i=this._observerObject;for(let s=0;s<r.length;++s)e.push(r[s].observe(i));r.length=0}clear(){const e=this._handles;for(let r=0;r<e.length;++r)e[r].remove();e.length=0}},IMe=class{constructor(e){this._notify=e,this._invalidCount=0,this.destroyed=!1}onInvalidated(){this._invalidCount++}onCommitted(){if(this.destroyed)return;const e=this._invalidCount;if(e===1)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}destroy(){this.destroyed=!0,this._notify=$Me}};const OQ=new FinalizationRegistry(t=>{t.destroy()});function $Me(){}let aS=!1;const DN=[];function Tde(t,e){let r=new X4(n),i=null,s=!1;function n(){if(!r||s)return;if(aS)return void Cde(n);const a=i;r.clear(),aS=!0,s=!0,i=iy(r,t),s=!1,aS=!1,e(i,a),Ade()}function o(){r&&(r.destroy(),r=null,i=null)}return s=!0,i=iy(r,t),s=!1,{remove:o}}function Sde(t,e){let r=new X4(s),i=null;function s(){e(i,o)}function n(){r&&(r.destroy(),r=null),i=null}function o(){return r?(r.clear(),i=iy(r,t),i):null}return o(),{remove:n}}function Ede(t){let e=new X4(i),r=!1;function i(){e&&!r&&(aS?Cde(i):(e.clear(),aS=!0,r=!0,iy(e,t),r=!1,aS=!1,Ade()))}function s(){e&&(e.destroy(),e=null)}return r=!0,iy(e,t),r=!1,{remove:s}}function Cde(t){DN.includes(t)||DN.unshift(t)}function Ade(){for(;DN.length;)DN.pop()()}var nO;(function(t){t[t.Untracked=0]="Untracked",t[t.Tracked=1]="Tracked"})(nO||(nO={}));let s3=class{constructor(){this.uid=$c(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,r,i,s,n){return this.pool.acquire(nO.Untracked,e,r,i,s,n,sW)}static acquireTracked(e,r,i,s){return this.pool.acquire(nO.Tracked,e,r,i,null,null,s)}notify(e,r){this.type===nO.Untracked?this.callback.call(this.target,e,r,this.path,this.target):this.callback.call(null,e,r)}acquire(e,r,i,s,n,o,a){this.uid=$c(),this.removed=!1,this.type=e,this.oldValue=r,this.callback=i,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=$c(),this.removed=!0}};s3.pool=new gde(s3);const xL=new Tc,Gg=new Set;let NN;function FN(t){Gg.delete(t),Gg.add(t),NN||(NN=VE(NMe))}function LMe(t){if(t.removed)return;const e=t.oldValue,r=t.getValue();t.equals(e,r)||(t.oldValue=r,t.notify(r,e))}function DMe(t){for(const e of Gg.values())e.target===t&&(e.removed=!0)}function NMe(){let t=10;for(;NN&&t--;){NN=null;const e=FMe(),r=xL.acquire();for(const i of e){const s=i.uid;LMe(i),s===i.uid&&i.removed&&r.push(i)}for(const i of Gg)i.removed&&(r.push(i),Gg.delete(i));for(const i of r)s3.pool.release(i);xL.release(r),xL.release(e),zk.forEach(i=>i())}}function FMe(){const t=xL.acquire();t.length=Gg.size;let e=0;for(const r of Gg)t[e]=r,++e;return Gg.clear(),t}const zk=new Set;function Rde(t){return zk.add(t),{remove(){zk.delete(t)}}}function UMe(t,e,r){let i=ade(t,e,r,(s,n,o)=>{let a,l,c=Sde(()=>vM(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?i.remove():(a||(a=s3.acquireUntracked(h,o,p,s,n),l=a.uid),FN(a))});return{remove:gW(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,FN(a)),a=null),i=c=null})}});return i}function VMe(t,e,r){const i=ade(t,e,r,(s,n,o)=>{let a=!1;return Tde(()=>vM(s,n),(l,c)=>{s.__accessor__.destroyed?i.remove():a||(a=!0,sW(c,l)||o.call(s,l,c,n,s),a=!1)})});return i}function kMe(t,e,r,i=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:i?VMe(t,e,r):UMe(t,e,r)}function zMe(t,e,r){let i,s,n=Sde(t,(o,a)=>{i&&i.uid!==s?n.remove():(i||(i=s3.acquireTracked(o,e,a,r),s=i.uid),FN(i))});return{remove:gW(()=>{n.remove(),i&&(i.uid!==s||i.removed||(i.removed=!0,FN(i)),i=null),n=null})}}function BMe(t,e,r){let i=!1;return Tde(t,(s,n)=>{i||(i=!0,r(n,s)||e(s,n),i=!1)})}function GMe(t,e,r=!1,i=u3e){return r?BMe(t,e,i):zMe(t,e,i)}function MQ(t){return wL(Gg,e=>e.oldValue===t)}function Yo(t,e){for(const[r,i]of t)if(e(i,r))return!0;return!1}function y2t(t,e){for(const[r,i]of t)if(e(i,r))return i;return null}function wW(t,e,r){const i=t.get(e);if(i!==void 0)return i;const s=r();return t.set(e,s),s}const lS=se.getLogger("esri.core.accessorSupport.ensureTypes");function jMe(t){return t==null?t:new Date(t)}function HMe(t){return t==null?t:!!t}function xM(t){return t==null?t:t.toString()}function Ch(t){return t==null?t:(t=parseFloat(t),isNaN(t)?0:t)}function xW(t){return t==null?t:Math.round(parseFloat(t))}function Ode(t){return t&&t.constructor&&t.constructor.__accessorMetadata__!==void 0}function UN(t,e){return e!=null&&t&&!(e instanceof t)}function Mde(t){return t&&"isCollection"in t}function PQ(t){return t&&t.Type?typeof t.Type=="function"?t.Type:t.Type.base:null}function qMe(t,e){if(!e||!e.constructor||!Mde(e.constructor))return Bk(t,e)?e:new t(e);const r=PQ(t.prototype.itemType),i=PQ(e.constructor.prototype.itemType);return r?i?r===i?e:r.prototype.isPrototypeOf(i.prototype)?new t(e):(Bk(t,e),e):new t(e):e}function Bk(t,e){return!!Ode(e)&&(lS.error("Accessor#set","Assigning an instance of '"+(e.declaredClass||"unknown")+"' which is not a subclass of '"+Y4(t)+"'"),!0)}function zS(t,e){return e==null?e:Mde(t)?qMe(t,e):UN(t,e)?Bk(t,e)?e:new t(e):e}function Y4(t){return t&&t.prototype&&t.prototype.declaredClass||"unknown"}const WMe=new WeakMap;function XMe(t){switch(t){case Number:return Ch;case Ti:return xW;case Boolean:return HMe;case String:return xM;case Date:return jMe;default:return wW(WMe,t,()=>zS.bind(null,t))}}function Ls(t,e){const r=XMe(t);return arguments.length===1?r:r(e)}function n3(t,e,r){return arguments.length===1?n3.bind(null,t):e&&(Array.isArray(e)?e.map(i=>t(i,r)):[t(e,r)])}function YMe(t,e){return arguments.length===1?n3(Ls.bind(null,t)):n3(Ls.bind(null,t),e)}function Pde(t,e,r){return e!==0&&Array.isArray(r)?r.map(i=>Pde(t,e-1,i)):t(r)}function VN(t,e,r){if(arguments.length===2)return VN.bind(null,t,e);if(!r)return r;let i=e,s=r=Pde(t,e,r);for(;i>0&&Array.isArray(s);)i--,s=s[0];if(s!==void 0)for(let n=0;n<i;n++)r=[r];return r}function ZMe(t,e,r){return arguments.length===2?VN(Ls.bind(null,t),e):VN(Ls.bind(null,t),e,r)}function Ide(t){return!!Array.isArray(t)&&!t.some(e=>{const r=typeof e;return!(r==="string"||r==="number"||r==="function"&&t.length>1)})}function Gk(t,e){if(arguments.length===2)return Gk(t).call(null,e);const r=new Set,i=t.filter(a=>typeof a!="function"),s=t.filter(a=>typeof a=="function");for(const a of t)typeof a!="string"&&typeof a!="number"||r.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(r.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!UN(a,p))?a:(h&&i.length?(n||(n=i.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),lS.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>Y4(p)).join(", ")),lS.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):lS.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function _p(t,e){if(arguments.length===2)return _p(t).call(null,e);const r={},i=[],s=[];for(const l in t.typeMap){const c=t.typeMap[l];r[l]=Ls(c),i.push(Y4(c)),s.push(l)}const n=()=>`'${i.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof t.key=="string"?l=>l[t.key]:t.key;return l=>{if(t.base&&!UN(t.base,l)||l==null)return l;const c=a(l)||t.defaultKeyValue,h=r[c];if(!h)return lS.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!UN(t.typeMap[c],l))return l;if(typeof t.key=="string"&&!Ode(l)){const p={};for(const f in l)f!==t.key&&(p[f]=l[f]);return h(p)}return h(l)}}let Ti=class{};const v2t={native:t=>({type:"native",value:t}),array:t=>({type:"array",value:t}),oneOf:t=>({type:"one-of",values:t})};function JMe(t){if(!t||!("type"in t))return!1;switch(t.type){case"native":case"array":case"one-of":return!0}return!1}function $de(t){switch(t.type){case"native":return Ls(t.value);case"array":return n3($de(t.value));case"one-of":return KMe(t);default:return null}}function KMe(t){let e=null;return(r,i)=>Hk(r,t)?r:(e==null&&(e=jk(t)),lS.error("Accessor#set",`Invalid property value, value needs to be of type ${e}`),i&&(i.valid=!1),null)}function jk(t){switch(t.type){case"native":switch(t.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case Ti:return"integer";case Date:return"date";default:return Y4(t.value)}case"array":return`array of ${jk(t.value)}`;case"one-of":{const e=t.values.map(r=>jk(r));return`one of ${e.slice(0,e.length-1)} or ${e[e.length-1]}`}}return"unknown"}function Hk(t,e){if(t==null)return!0;switch(e.type){case"native":switch(e.value){case Number:case Ti:return typeof t=="number";case Boolean:return typeof t=="boolean";case String:return typeof t=="string"}return t instanceof e.value;case"array":return!!Array.isArray(t)&&!t.some(r=>!Hk(r,e.value));case"one-of":return e.values.some(r=>Hk(t,r))}}function d(t={}){return(e,r)=>{if(e===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${e.name}.${r}. Accessor does not support static properties.`);const i=Object.getOwnPropertyDescriptor(e,r),s=G4(e,r);i&&(i.get||i.set?(s.get=i.get||s.get,s.set=i.set||s.set):"value"in i&&("value"in t&&se.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${r}" on "${e.constructor.name}" already defined in the metadata`,t),s.value=t.value=i.value)),t.readOnly!=null&&(s.readOnly=t.readOnly);const n=t.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=ON(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=ON(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){this._override(r,p)}:function(p){IN(this,l,p)})}const o=t.type,a=t.types;s.cast||(o?s.cast=QMe(o):a&&(Array.isArray(a)?s.cast=n3(_p(a[0])):s.cast=_p(a))),tMe(s,t),t.range&&(s.cast=ePe(s.cast,t.range))}}function Lde(t,e,r){const i=G4(t,r);i.json||(i.json={});let s=i.json;return e!==void 0&&(s.origins||(s.origins={}),s.origins[e]||(s.origins[e]={}),s=s.origins[e]),s}function QMe(t){let e=0,r=t;if(JMe(t))return $de(t);for(;Array.isArray(r)&&r.length===1&&typeof r[0]!="string"&&typeof r[0]!="number";)r=r[0],e++;const i=r;if(Ide(i))return e===0?Gk(i):VN(Gk(i),e);if(e===1)return YMe(i);if(e>1)return ZMe(i,e);const s=t;return s.from?s.from:Ls(s)}function ePe(t,e){return r=>{let i=+t(r);return e.step!=null&&(i=Math.round(i/e.step)*e.step),e.min!=null&&(i=Math.max(e.min,i)),e.max!=null&&(i=Math.min(e.max,i)),i}}function tPe(t){if(t.json&&t.json.origins){const e=t.json.origins,r={"web-document":["web-scene","web-map"]};for(const i in r)if(e[i]){const s=e[i];r[i].forEach(n=>{e[n]=s}),delete e[i]}}}let lm=class qk extends jhe{constructor(e,r,i){if(super(e,r,i),!(this instanceof qk))return new qk(e,r,i)}};lm.prototype.type="warning";function Dde(t){return!!t&&t.prototype&&t.prototype.declaredClass&&t.prototype.declaredClass.indexOf("esri.core.Collection")===0}const Wk=se.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function IQ(t,e,r){var i,s;t&&(!r&&!e.read||(i=e.read)!=null&&i.reader||((s=e.read)==null?void 0:s.enabled)===!1||sPe(t)&&sl("read.reader",wv(t),e))}function wv(t){var r,i;const e=t.ndimArray??0;if(e>1)return iPe(t);if(e===1)return $Q(t);if("type"in t&&Fde(t.type)){const s=(i=(r=t.type.prototype)==null?void 0:r.itemType)==null?void 0:i.Type,n=$Q(typeof s=="function"?{type:s}:{types:s});return(o,a,l)=>{const c=n(o,a,l);return c&&new t.type(c)}}return TW(t)}function TW(t){return"type"in t?rPe(t.type):nPe(t.types)}function rPe(t){return t.prototype.read?(e,r,i)=>{if(e==null)return e;const s=typeof e;if(s!=="object")return void Wk.error(`Expected JSON value of type 'object' to deserialize type '${t.prototype.declaredClass}', but got '${s}'`);const n=new t;return n.read(e,i),n}:t.fromJSON}function Nde(t,e,r,i){return i!==0&&Array.isArray(e)?e.map(s=>Nde(t,s,r,i-1)):t(e,void 0,r)}function iPe(t){const e=TW(t),r=Nde.bind(null,e),i=t.ndimArray??0;return(s,n,o)=>{if(s==null)return s;s=r(s,o,i);let a=i,l=s;for(;a>0&&Array.isArray(l);)a--,l=l[0];if(l!==void 0)for(let c=0;c<a;c++)s=[s];return s}}function $Q(t){const e=TW(t);return(r,i,s)=>{if(r==null)return r;if(Array.isArray(r)){const o=[];for(const a of r){const l=e(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=e(r,void 0,s);return n!==void 0?[n]:void 0}}function Fde(t){if(!Dde(t))return!1;const e=t.prototype.itemType;return!(!e||!e.Type)&&(typeof e.Type=="function"?SW(e.Type):Ude(e.Type))}function sPe(t){return"types"in t?Ude(t.types):SW(t.type)}function SW(t){return!Array.isArray(t)&&!!t&&t.prototype&&("read"in t.prototype||"fromJSON"in t||Fde(t))}function Ude(t){for(const e in t.typeMap)if(!SW(t.typeMap[e]))return!1;return!0}function nPe(t){let e=null;const r=t.errorContext??"type";return(i,s,n)=>{if(i==null)return i;const o=typeof i;if(o!=="object")return void Wk.error(`Expected JSON value of type 'object' to deserialize, but got '${o}'`);e||(e=oPe(t));const a=t.key;if(typeof a!="string")return;const l=i[a],c=l?e[l]:t.defaultKeyValue?t.typeMap[t.defaultKeyValue]:void 0;if(!c){const p=`Type '${l||"unknown"}' is not supported`;return n&&n.messages&&i&&n.messages.push(new lm(`${r}:unsupported`,p,{definition:i,context:n})),void Wk.error(p)}const h=new c;return h.read(i,n),h}}function oPe(t){var r,i;const e={};for(const s in t.typeMap){const n=t.typeMap[s],o=bM(n.prototype);if(typeof t.key=="function")continue;const a=o[t.key];if(!a)continue;(r=a.json)!=null&&r.type&&Array.isArray(a.json.type)&&a.json.type.length===1&&typeof a.json.type[0]=="string"&&(e[a.json.type[0]]=n);const l=(i=a.json)==null?void 0:i.write;if(!l||!l.writer){e[s]=n;continue}const c=l.target,h=typeof c=="string"?c:t.key,p={};l.writer(s,p,h),p[h]&&(e[p[h]]=n)}return e}function aPe(t){if(t.json||(t.json={}),DQ(t.json),NQ(t.json),LQ(t.json),t.json.origins)for(const e in t.json.origins)DQ(t.json.origins[e]),NQ(t.json.origins[e]),LQ(t.json.origins[e]);return!0}function LQ(t){t.name&&(t.read&&typeof t.read=="object"?t.read.source===void 0&&(t.read.source=t.name):t.read={source:t.name},t.write&&typeof t.write=="object"?t.write.target===void 0&&(t.write.target=t.name):t.write={target:t.name})}function DQ(t){typeof t.read=="boolean"?t.read={enabled:t.read}:typeof t.read=="function"?t.read={enabled:!0,reader:t.read}:t.read&&typeof t.read=="object"&&t.read.enabled===void 0&&(t.read.enabled=!0)}function NQ(t){typeof t.write=="boolean"?t.write={enabled:t.write}:typeof t.write=="function"?t.write={enabled:!0,writer:t.write}:t.write&&typeof t.write=="object"&&t.write.enabled===void 0&&(t.write.enabled=!0)}function FQ(t,e){if(!e.write||e.write.writer||e.write.enabled===!1&&!e.write.overridePolicy)return;const r=(t==null?void 0:t.ndimArray)??0;t&&(r===1||"type"in t&&Dde(t.type))?e.write.writer=uPe:r>1?e.write.writer=hPe(r):e.types?Array.isArray(e.types)?e.write.writer=cPe(e.types[0]):e.write.writer=lPe(e.types):e.write.writer=o3}function lPe(t){return(e,r,i,s)=>e?Vde(e,t,s)?o3(e,r,i,s):void 0:o3(e,r,i,s)}function Vde(t,e,r){for(const i in e.typeMap)if(t instanceof e.typeMap[i])return!0;if(r!=null&&r.messages){const i=e.errorContext??"type",s=`Values of type '${(typeof e.key!="function"?t[e.key]:t.declaredClass)??"Unknown"}' cannot be written`;r&&r.messages&&t&&r.messages.push(new j(`${i}:unsupported`,s,{definition:t,context:r})),se.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer").error(s)}return!1}function cPe(t){return(e,r,i,s)=>!e||!Array.isArray(e)?o3(e,r,i,s):o3(e.filter(n=>Vde(n,t,s)),r,i,s)}function o3(t,e,r,i){sl(r,kN(t,i),e)}function kN(t,e){return t&&typeof t.write=="function"?t.write({},e):t&&typeof t.toJSON=="function"?t.toJSON():typeof t=="number"?zN(t):t}function zN(t){return t===-1/0?-Number.MAX_VALUE:t===1/0?Number.MAX_VALUE:isNaN(t)?null:t}function uPe(t,e,r,i){let s;t===null?s=null:t&&typeof t.map=="function"?(s=t.map(n=>kN(n,i)),typeof s.toArray=="function"&&(s=s.toArray())):s=[kN(t,i)],sl(r,s,e)}function kde(t,e,r){return r!==0&&Array.isArray(t)?t.map(i=>kde(i,e,r-1)):kN(t,e)}function hPe(t){return(e,r,i,s)=>{let n;if(e===null)n=null;else{n=kde(e,s,t);let o=t,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}sl(i,n,r)}}function Xk(t,e){return EW(t,"read",e)}function zde(t,e){return EW(t,"write",e)}function EW(t,e,r){let i=t&&t.json;if(t&&t.json&&t.json.origins&&r){const s=r.origin&&t.json.origins[r.origin];s&&(e==="any"||e in s)&&(i=s)}return i}function dPe(t){const e=pPe(t);if(t.json.origins)for(const r in t.json.origins){const i=t.json.origins[r],s=i.types?fPe(i):e;IQ(s,i,!1),i.types&&!i.write&&t.json.write&&t.json.write.enabled&&(i.write={...t.json.write}),FQ(s,i)}IQ(e,t.json,!0),FQ(e,t.json)}function pPe(t){return t.json.types?Yk(t.json):t.type?Bde(t):Yk(t)}function fPe(t){return t.type?Bde(t):Yk(t)}function Bde(t){if(!t.type)return;let e=0,r=t.type;for(;Array.isArray(r)&&!Ide(r);)r=r[0],e++;return{type:r,ndimArray:e}}function Yk(t){if(!t.types)return;let e=0,r=t.types;for(;Array.isArray(r);)r=r[0],e++;return{types:r,ndimArray:e}}function mPe(t){aPe(t)&&(tPe(t),dPe(t))}const cU=new Set,uU=new Set;function P(t){return e=>{e.prototype.declaredClass=t,yPe(e);const r=[],i=[];let s=e.prototype;for(;s;)s.hasOwnProperty("initialize")&&!cU.has(s.initialize)&&(cU.add(s.initialize),r.push(s.initialize)),s.hasOwnProperty("destroy")&&!uU.has(s.destroy)&&(uU.add(s.destroy),i.push(s.destroy)),s=Object.getPrototypeOf(s);cU.clear(),uU.clear();class n extends e{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(r.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=r.length-1;l>=0;l--)r[l].call(this)}}),i.length){let l=!1;const c=this[nde];Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0,c.call(this);for(let h=0;h<i.length;h++)i[h].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=bM(e.prototype),n.prototype.declaredClass=t,n}}function gPe(t,e){return e.get==null?function(){const r=this.__accessor__.properties.get(t);if(r===void 0)return;vr(r.observerObject);const i=this.__accessor__.store;return i.has(t)?i.get(t):r.metadata.value}:function(){const r=this.__accessor__.properties.get(t);if(r!==void 0)return r.getComputed()}}function yPe(t){const e=t.prototype,r=bM(e),i={};for(const s of Object.getOwnPropertyNames(r)){const n=r[s];mPe(n),i[s]={enumerable:!0,configurable:!0,get:gPe(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===$g.CONSTRUCTED&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(t.prototype,i)}var Gde,jde;function _Pe(t){var e;if(t==null)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return(e=t.constructor)!=null&&e.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}const x1=Symbol("Accessor-Handles"),Zk=Symbol("Accessor-Initialized");let Te=class Hde{static createSubclass(e={}){if(Array.isArray(e))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:r,declaredClass:i,constructor:s}=e;delete e.declaredClass,delete e.properties,delete e.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}bM(o.prototype);for(const a in e){const l=e[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:e[a]}for(const a in r){const l=_Pe(r[a]);d(l)(o.prototype,a)}return P(i)(o)}constructor(...e){if(this[Gde]=null,this[jde]=!1,this.constructor===Hde)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new dMe(this)}),e.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,e))}postscript(e){const r=this.__accessor__,i=r.ctorArgs||e;r.initialize(),i&&(this.set(i),r.ctorArgs=null),r.constructed(),this.initialize(),this[Zk]=!0}initialize(){}[nde](){this[x1]=Ve(this[x1])}destroy(){this.destroyed||(DMe(this),this.__accessor__.destroy())}get constructed(){return this.__accessor__&&this.__accessor__.initialized||!1}get initialized(){return this[Zk]}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(e){this.get(e)}get(e){return ON(this,e)}hasOwnProperty(e){return this.__accessor__?this.__accessor__.has(e):Object.prototype.hasOwnProperty.call(this,e)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(e,r){return IN(this,e,r),this}watch(e,r,i){return kMe(this,e,r,i)}own(e){this.addHandles(e)}addHandles(e,r){let i=this[x1];C(i)&&(i=this[x1]=new Zr),i.add(e,r)}removeHandles(e){const r=this[x1];C(r)||r.remove(e)}hasHandles(e){const r=this[x1];return!!v(r)&&r.has(e)}_override(e,r){r===void 0?this.__accessor__.clearOverride(e):this.__accessor__.override(e,r)}_clearOverride(e){return this.__accessor__.clearOverride(e)}_overrideIfSome(e,r){r==null?this.__accessor__.clearOverride(e):this.__accessor__.override(e,r)}_isOverridden(e){return this.__accessor__.isOverridden(e)}notifyChange(e){this.__accessor__.notifyChange(e)}_get(e){return this.__accessor__.internalGet(e)}_set(e,r){return this.__accessor__.internalSet(e,r),this}};Gde=x1,jde=Zk;let TL=class qde{constructor(){this._emitter=new qde.EventEmitter(this)}emit(e,r){return this._emitter.emit(e,r)}on(e,r){return this._emitter.on(e,r)}once(e,r){return this._emitter.once(e,r)}hasEventListener(e){return this._emitter.hasEventListener(e)}};(function(t){class e{constructor(s=null){this._target=s,this._listenersMap=null}clear(){this._listenersMap&&this._listenersMap.clear(),this._listenersMap=null}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this._target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return US(a)}if(s.includes(","))throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}t.EventEmitter=e,t.EventedMixin=i=>{let s=class extends i{constructor(){super(...arguments),this._emitter=new e}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([P("esri.core.Evented")],s),s};let r=class extends Te{constructor(){super(...arguments),this._emitter=new TL.EventEmitter(this)}destroy(){this._emitter.clear()}emit(i,s){return this._emitter.emit(i,s)}on(i,s){return this._emitter.on(i,s)}once(i,s){return this._emitter.once(i,s)}hasEventListener(i){return this._emitter.hasEventListener(i)}};r=u([P("esri.core.Evented")],r),t.EventedAccessor=r})(TL||(TL={}));const Fs=TL;var mi;(function(t){t[t.ADD=1]="ADD",t[t.REMOVE=2]="REMOVE",t[t.MOVE=4]="MOVE"})(mi||(mi={}));function CW(t){return(e,r)=>{e[r]=t}}let AW=class extends ude{notify(){const e=this._observers;if(e&&e.length>0){const r=e.slice();for(const i of r)i.onInvalidated(),i.onCommitted()}}};var Mg;let vPe=class{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(e){this.defaultPrevented=!1,this.item=e}};const qu=new Po(vPe,void 0,t=>{t.item=null,t.target=null,t.defaultPrevented=!1,t.cancellable=!1}),bPe=()=>{};function hU(t){return t?t instanceof Eb?t.toArray():t.length?Array.prototype.slice.apply(t):[]:[]}function dU(t){if(t&&t.length)return t[0]}function wPe(t,e,r,i){const s=Math.min(t.length-r,e.length-i);let n=0;for(;n<s&&t[r+n]===e[i+n];)n++;return n}function Wde(t,e,r,i){e&&e.forEach((s,n,o)=>{t.push(s),Wde(t,r.call(i,s,n,o),r,i)})}const Fy=new Set,Uy=new Set,Vy=new Set,pU=new Map;let xPe=0,Eb=Mg=class extends Fs.EventedAccessor{static isCollection(t){return t!=null&&t instanceof Mg}constructor(t){super(t),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new AW,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:xPe++})}normalizeCtorArgs(t){return t?Array.isArray(t)||t instanceof Mg?{items:t}:t:{}}destroy(){this.removeAll()}*[Symbol.iterator](){yield*this.items}get items(){return vr(this._observable),this._items}set items(t){this._emitBeforeChanges(mi.ADD)||(this._splice(0,this.length,hU(t)),this._emitAfterChanges(mi.ADD))}hasEventListener(t){return t==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(t)}on(t,e){if(t==="change"){const r=this._chgListeners,i={removed:!1,callback:e};return r.push(i),this._notifications&&this._notifications.push({listeners:r.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=bPe,i.removed=!0,r.splice(r.indexOf(i),1)}}}return this._emitter.on(t,e)}once(t,e){const r=this.on(t,e);return{remove(){r.remove()}}}add(t,e){if(vr(this._observable),this._emitBeforeChanges(mi.ADD))return this;const r=this.getNextIndex(e??null);return this._splice(r,0,[t]),this._emitAfterChanges(mi.ADD),this}addMany(t,e=this._items.length){if(vr(this._observable),!t||!t.length)return this;if(this._emitBeforeChanges(mi.ADD))return this;const r=this.getNextIndex(e);return this._splice(r,0,hU(t)),this._emitAfterChanges(mi.ADD),this}at(t){if(vr(this._observable),(t=Math.trunc(t)||0)<0&&(t+=this.length),!(t<0||t>=this.length))return this._items[t]}removeAll(){if(vr(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return[];const t=this._splice(0,this.length)||[];return this._emitAfterChanges(mi.REMOVE),t}clone(){return vr(this._observable),this._createNewInstance({items:this._items.map(te)})}concat(...t){vr(this._observable);const e=t.map(hU);return this._createNewInstance({items:this._items.concat(...e)})}drain(t,e){if(vr(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return;const r=this._splice(0,this.length),i=r.length;for(let s=0;s<i;s++)t.call(e,r[s],s,r);this._emitAfterChanges(mi.REMOVE)}every(t,e){return vr(this._observable),this._items.every(t,e)}filter(t,e){let r;return vr(this._observable),r=arguments.length===2?this._items.filter(t,e):this._items.filter(t),this._createNewInstance({items:r})}find(t,e){return vr(this._observable),this._items.find(t,e)}findIndex(t,e){return vr(this._observable),this._items.findIndex(t,e)}flatten(t,e){vr(this._observable);const r=[];return Wde(r,this,t,e),new Mg(r)}forEach(t,e){return vr(this._observable),this._items.forEach(t,e)}getItemAt(t){return vr(this._observable),this._items[t]}getNextIndex(t){vr(this._observable);const e=this.length;return(t=t??e)<0?t=0:t>e&&(t=e),t}includes(t,e=0){return vr(this._observable),this._items.includes(t,e)}indexOf(t,e=0){return vr(this._observable),this._items.indexOf(t,e)}join(t=","){return vr(this._observable),this._items.join(t)}lastIndexOf(t,e=this.length-1){return vr(this._observable),this._items.lastIndexOf(t,e)}map(t,e){vr(this._observable);const r=this._items.map(t,e);return new Mg({items:r})}reorder(t,e=this.length-1){vr(this._observable);const r=this.indexOf(t);if(r!==-1){if(e<0?e=0:e>=this.length&&(e=this.length-1),r!==e){if(this._emitBeforeChanges(mi.MOVE))return t;this._splice(r,1),this._splice(e,0,[t]),this._emitAfterChanges(mi.MOVE)}return t}}pop(){if(vr(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return;const t=dU(this._splice(this.length-1,1));return this._emitAfterChanges(mi.REMOVE),t}push(...t){return vr(this._observable),this._emitBeforeChanges(mi.ADD)||(this._splice(this.length,0,t),this._emitAfterChanges(mi.ADD)),this.length}reduce(t,e){vr(this._observable);const r=this._items;return arguments.length===2?r.reduce(t,e):r.reduce(t)}reduceRight(t,e){vr(this._observable);const r=this._items;return arguments.length===2?r.reduceRight(t,e):r.reduceRight(t)}remove(t){return vr(this._observable),this.removeAt(this.indexOf(t))}removeAt(t){if(vr(this._observable),t<0||t>=this.length||this._emitBeforeChanges(mi.REMOVE))return;const e=dU(this._splice(t,1));return this._emitAfterChanges(mi.REMOVE),e}removeMany(t){if(vr(this._observable),!t||!t.length||this._emitBeforeChanges(mi.REMOVE))return[];const e=t instanceof Mg?t.toArray():t,r=this._items,i=[],s=e.length;for(let n=0;n<s;n++){const o=e[n],a=r.indexOf(o);if(a>-1){const l=1+wPe(e,r,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&i.push.apply(i,c),n+=l-1}}return this._emitAfterChanges(mi.REMOVE),i}reverse(){if(vr(this._observable),this._emitBeforeChanges(mi.MOVE))return this;const t=this._splice(0,this.length);return t&&(t.reverse(),this._splice(0,0,t)),this._emitAfterChanges(mi.MOVE),this}shift(){if(vr(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return;const t=dU(this._splice(0,1));return this._emitAfterChanges(mi.REMOVE),t}slice(t=0,e=this.length){return vr(this._observable),this._createNewInstance({items:this._items.slice(t,e)})}some(t,e){return vr(this._observable),this._items.some(t,e)}sort(t){if(vr(this._observable),!this.length||this._emitBeforeChanges(mi.MOVE))return this;const e=this._splice(0,this.length);return arguments.length?e.sort(t):e.sort(),this._splice(0,0,e),this._emitAfterChanges(mi.MOVE),this}splice(t,e,...r){vr(this._observable);const i=(e?mi.REMOVE:0)|(r.length?mi.ADD:0);if(this._emitBeforeChanges(i))return[];const s=this._splice(t,e,r)||[];return this._emitAfterChanges(i),s}toArray(){return vr(this._observable),this._items.slice()}toJSON(){return vr(this._observable),this.toArray()}toLocaleString(){return vr(this._observable),this._items.toLocaleString()}toString(){return vr(this._observable),this._items.toString()}unshift(...t){return vr(this._observable),!t.length||this._emitBeforeChanges(mi.ADD)||(this._splice(0,0,t),this._emitAfterChanges(mi.ADD)),this.length}_createNewInstance(t){return new this.constructor(t)}_splice(t,e,r){const i=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=VE(()=>this._dispatchChange())),e){if(o=i.splice(t,e),this.hasEventListener("before-remove")){const a=qu.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),i.splice(t,0,n),t+=1,l-=1,c-=1);qu.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=qu.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);qu.release(a)}}if(r&&r.length){if(s){const h=[];for(const p of r){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}r=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=t===this.length;if(a||l){const h=qu.acquire();h.target=this,h.cancellable=!0;const p=qu.acquire();p.target=this,p.cancellable=!1;for(const f of r)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?i.push(f):i.splice(t++,0,f),this._set("length",i.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?i.push(f):i.splice(t++,0,f),this._set("length",i.length),p.reset(f),this.emit("after-add",p));qu.release(p),qu.release(h)}else{if(c)for(const h of r)i.push(h);else i.splice(t,0,...r);this._set("length",i.length)}}return(r&&r.length||o&&o.length)&&this._notifyChangeEvent(r,o),o}_emitBeforeChanges(t){let e=!1;if(this.hasEventListener("before-changes")){const r=qu.acquire();r.target=this,r.cancellable=!0,r.type=t,this.emit("before-changes",r),e=r.defaultPrevented,qu.release(r)}return e}_emitAfterChanges(t){if(this.hasEventListener("after-changes")){const e=qu.acquire();e.target=this,e.cancellable=!1,e.type=t,this.emit("after-changes",e),qu.release(e)}this._observable.notify()}_notifyChangeEvent(t,e){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:t,removed:e})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const t=this._notifications;this._notifications=null;for(const e of t){const r=e.changes;Fy.clear(),Uy.clear(),Vy.clear();for(const{added:l,removed:c}of r){if(l)if(Vy.size===0&&Uy.size===0)for(const h of l)Fy.add(h);else for(const h of l)Uy.has(h)?(Vy.add(h),Uy.delete(h)):Vy.has(h)||Fy.add(h);if(c)if(Vy.size===0&&Fy.size===0)for(const h of c)Uy.add(h);else for(const h of c)Fy.has(h)?Fy.delete(h):(Vy.delete(h),Uy.add(h))}const i=Tc.acquire();Fy.forEach(l=>{i.push(l)});const s=Tc.acquire();Uy.forEach(l=>{s.push(l)});const n=this._items,o=e.items,a=Tc.acquire();if(Vy.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),e.listeners&&(i.length||s.length||a.length)){const l={target:this,added:i,removed:s,moved:a},c=e.listeners.length;for(let h=0;h<c;h++){const p=e.listeners[h];p.removed||p.callback.call(this,l)}}Tc.release(i),Tc.release(s),Tc.release(a)}Fy.clear(),Uy.clear(),Vy.clear()}};Eb.ofType=t=>{if(!t)return Mg;if(pU.has(t))return pU.get(t);let e=null;if(typeof t=="function")e=t.prototype.declaredClass;else if(t.base)e=t.base.prototype.declaredClass;else for(const i in t.typeMap){const s=t.typeMap[i].prototype.declaredClass;e?e+=` | ${s}`:e=s}let r=class extends Mg{};return u([CW({Type:t,ensureType:typeof t=="function"?Ls(t):_p(t)})],r.prototype,"itemType",void 0),r=u([P(`esri.core.Collection<${e}>`)],r),pU.set(t,r),r},u([d()],Eb.prototype,"length",void 0),u([d()],Eb.prototype,"items",null),Eb=Mg=u([P("esri.core.Collection")],Eb);const ft=Eb;function sy(t,e,r=ft){return e||(e=new r),e===t||(e.removeAll(),TPe(t)?e.addMany(t):t&&e.add(t)),e}function RW(t){return t}function TPe(t){return t&&(Array.isArray(t)||"items"in t&&Array.isArray(t.items))}let SPe=class Xde{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new Xde;return this._values.forEach((i,s)=>{e&&e.has(s)||r.set(s,te(i.value),i.origin)}),r}get(e,r){r=this._normalizeOrigin(r);const i=this._values.get(e);return r==null||(i==null?void 0:i.origin)===r?i==null?void 0:i.value:void 0}originOf(e){var r;return((r=this._values.get(e))==null?void 0:r.origin)??Gr.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return e==null?r:r.filter(i=>{var s;return((s=this._values.get(i))==null?void 0:s.origin)===e})}set(e,r,i){if((i=this._normalizeOrigin(i))===Gr.DEFAULTS){const s=this._values.get(e);if(s&&s.origin!=null&&s.origin>i)return}this._values.set(e,new EPe(r,i))}delete(e,r){var i;(r=this._normalizeOrigin(r))!=null&&((i=this._values.get(e))==null?void 0:i.origin)!==r||this._values.delete(e)}has(e,r){var i;return(r=this._normalizeOrigin(r))!=null?((i=this._values.get(e))==null?void 0:i.origin)===r:this._values.has(e)}forEach(e){this._values.forEach(({value:r},i)=>e(r,i))}_normalizeOrigin(e){if(e!=null)return e===Gr.DEFAULTS?e:Gr.USER}},EPe=class{constructor(e,r){this.value=e,this.origin=r}};function Yde(t,e,r){e.keys().forEach(s=>{r.set(s,e.get(s),Gr.DEFAULTS)});const i=t.metadatas;Object.keys(i).forEach(s=>{t.internalGet(s)&&r.set(s,t.internalGet(s),Gr.DEFAULTS)})}function CPe(t,e,r){if(!t||!t.read||t.read.enabled===!1||!t.read.source)return!1;const i=t.read.source;if(typeof i=="string"){if(i===e||i.includes(".")&&i.indexOf(e)===0&&bQ(i,r))return!0}else for(const s of i)if(s===e||s.includes(".")&&s.indexOf(e)===0&&bQ(s,r))return!0;return!1}function APe(t){return t&&(!t.read||t.read.enabled!==!1&&!t.read.source)}function RPe(t,e,r,i,s){let n=Xk(e[r],s);APe(n)&&(t[r]=!0);for(const o of Object.getOwnPropertyNames(e))n=Xk(e[o],s),CPe(n,r,i)&&(t[o]=!0)}function OPe(t,e,r,i){const s=r.metadatas,n=EW(s[e],"any",i),o=n&&n.default;if(o===void 0)return;const a=typeof o=="function"?o.call(t,e,i):o;a!==void 0&&r.set(e,a)}const Zde={origin:"service"};function Jde(t,e,r=Zde){if(!e||typeof e!="object")return;const i=nl(t),s=i.metadatas,n={};for(const o of Object.getOwnPropertyNames(e))RPe(n,s,o,e,r);i.setDefaultOrigin(r.origin);for(const o of Object.getOwnPropertyNames(n)){const a=Xk(s[o],r).read,l=a&&a.source;let c;c=l&&typeof l=="string"?vM(e,l):e[o],a&&a.reader&&(c=a.reader.call(t,c,e,r)),c!==void 0&&i.set(o,c)}if(!r||!r.ignoreDefaults){i.setDefaultOrigin("defaults");for(const o of Object.getOwnPropertyNames(s))n[o]||OPe(t,o,i,r)}i.setDefaultOrigin("user")}function Kde(t,e,r,i=Zde){var n;const s={...i,messages:[]};r(s),(n=s.messages)==null||n.forEach(o=>{o.type!=="warning"||t.loaded?i&&i.messages&&i.messages.push(o):t.loadWarnings.push(o)})}function MPe(t,e,r,i,s){var o,a;const n={};return(a=(o=e.write)==null?void 0:o.writer)==null||a.call(t,i,n,r,s),n}function Qde(t,e,r,i,s,n){if(!i||!i.write)return!1;const o=t.get(r);if(!s&&i.write.overridePolicy){const a=i.write.overridePolicy.call(t,o,r,n);a!==void 0&&(s=a)}if(s||(s=i.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new j("web-document-write:property-required",`Missing value for required property '${r}' on '${t.declaredClass}'`,{propertyName:r,target:t});return a&&n&&n.messages?n.messages.push(a):a&&!n&&se.getLogger("esri.core.accessorSupport.write").error(a.name,a.message),!1}return!(o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||(!e.store.multipleOriginsSupported||e.store.originOf(r)===Gr.DEFAULTS)&&PPe(t,r,n,i,o)||!s.ignoreOrigin&&n&&n.origin&&e.store.multipleOriginsSupported&&e.store.originOf(r)<x_(n.origin))}function PPe(t,e,r,i,s){const n=i.default;if(n===void 0)return!1;if(i.defaultEquals!=null)return i.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(t,e,r);return ry(o,s)}return!1}return n===s}function IPe(t,e,r,i){const s=nl(t),n=s.metadatas,o=zde(n[e],i);return!!o&&Qde(t,s,e,o,r,i)}function epe(t,e,r){var n,o;if(t&&typeof t.toJSON=="function"&&(!t.toJSON.isDefaultToJSON||!t.write))return _L(e,t.toJSON(r));const i=nl(t),s=i.metadatas;for(const a in s){const l=zde(s[a],r);if(!Qde(t,i,a,l,void 0,r))continue;const c=t.get(a),h=MPe(t,l,l.write&&typeof l.write.target=="string"?l.write.target:a,c,r);Object.keys(h).length>0&&(e=_L(e,h),(o=(n=r==null?void 0:r.resources)==null?void 0:n.pendingOperations)!=null&&o.length&&r.resources.pendingOperations.push(Promise.all(r.resources.pendingOperations).then(()=>_L(e,h,()=>"replace-arrays"))),r&&r.writtenProperties&&r.writtenProperties.push({target:t,propName:a,oldOrigin:oMe(i.store.originOf(a)),newOrigin:r.origin}))}return e}const TM=t=>{let e=class extends t{constructor(...r){super(...r);const i=nl(this),s=i.store,n=new SPe;i.store=n,Yde(i,s,n)}read(r,i){Jde(this,r,i)}write(r={},i){return epe(this,r,i)}toJSON(r){return this.write({},r)}static fromJSON(r,i){return $Pe.call(this,r,i)}};return e=u([P("esri.core.JSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function $Pe(t,e){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const r=new this;return r.read(t,e),r}let fe=class extends TM(Te){};fe=u([P("esri.core.JSONSupport")],fe);var r_;(function(t){t[t.PENDING=0]="PENDING",t[t.RESOLVED=1]="RESOLVED",t[t.REJECTED=2]="REJECTED"})(r_||(r_={}));let LPe=class{constructor(e){this.instance=e,this._resolver=J_(),this._status=r_.PENDING,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=r_.RESOLVED,this._cleanUp()},()=>{this._status=r_.REJECTED,this._cleanUp()})}addResolvingPromise(e){this._resolvingPromises.push(e),this._tryResolve()}isResolved(){return this._status===r_.RESOLVED}isRejected(){return this._status===r_.REJECTED}isFulfilled(){return this._status!==r_.PENDING}abort(){this._resolver.reject(qr())}when(e,r){return this._resolver.promise.then(e,r)}_cleanUp(){this._allPromise=this._resolvingPromises=this._allPromise=null}_tryResolve(){if(this.isFulfilled())return;const e=J_(),r=[...this._resolvingPromises,e.promise],i=this._allPromise=Promise.all(r);i.then(()=>{this.isFulfilled()||this._allPromise!==i||this._resolver.resolve(this.instance)},s=>{this.isFulfilled()||this._allPromise!==i||Ks(s)||this._resolver.reject(s)}),e.resolve()}};const SM=t=>{let e=class extends t{constructor(...r){super(...r),this._promiseProps=new LPe(this),this.addResolvingPromise(Promise.resolve())}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(r,i){return new Promise((s,n)=>{this._promiseProps.when(s,n)}).then(r,i)}catch(r){return this.when(null,r)}addResolvingPromise(r){r&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in r?r.when():r)}};return e=u([P("esri.core.Promise")],e),e};let BN=class extends SM(Te){};BN=u([P("esri.core.Promise")],BN);const DPe="not-loaded",NPe="loading",FPe="failed",UQ="loaded",tpe=t=>{let e=class extends t{constructor(...r){super(...r),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(i=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=W4(n,l);this.destroyed&&l(new j("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this._promiseProps.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===DPe){this._set("loadStatus",NPe);const a=this._loadController=new AbortController;s({signal:a.signal}),ba(a.signal,()=>{this._promiseProps.abort()})}return i(),o}})),this.when(()=>{this._set("loadStatus",UQ),this._loadController=null},i=>{this._set("loadStatus",FPe),this._set("loadError",i),this._loadController=null})}get loaded(){return this.loadStatus===UQ}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){var r;return this.isFulfilled()||(this._set("loadError",new j("load:cancelled","Cancelled")),(r=this._loadController)==null||r.abort()),this}};return u([d({readOnly:!0})],e.prototype,"loaded",null),u([d({readOnly:!0})],e.prototype,"loadError",void 0),u([d({clonable:!1})],e.prototype,"loadStatus",void 0),u([d({type:[lm],readOnly:!0})],e.prototype,"loadWarnings",null),e=u([P("esri.core.Loadable")],e),e};let PA=class extends tpe(BN){};PA=u([P("esri.core.Loadable")],PA),function(t){function e(r){return!(!r||!r.load)}t.LoadableMixin=tpe,t.isLoadable=e}(PA||(PA={}));const cm=PA;function Z4(t,e,r){return co(t.map((i,s)=>e.apply(r,[i,s])))}async function UPe(t,e,r){return(await co(t.map((i,s)=>e.apply(r,[i,s])))).map(i=>i.value)}function OW(t){return{ok:!0,value:t}}function MW(t){return{ok:!1,error:t}}function VPe(t){return v(t)&&t.ok===!0?t.value:null}function kPe(t){return v(t)&&t.ok===!1?t.error:null}async function Uc(t){if(C(t))return{ok:!1,error:new Error("no promise provided")};try{return OW(await t)}catch(e){return MW(e)}}async function A2t(t){try{return OW(await t)}catch(e){return Sc(e),MW(e)}}function R2t(t){if(t.ok===!0)return t.value;throw t.error}function EM(t,e){return new T0(t,e)}let T0=class extends Te{get value(){return VPe(this._result)}get error(){return kPe(this._result)}get finished(){return v(this._result)}constructor(e,r){super({}),this._result=null,this._abortHandle=null,this.abort=()=>{this._abortController=jh(this._abortController)},this.remove=this.abort,this._abortController=new AbortController;const{signal:i}=this._abortController;this.promise=e(i),this.promise.then(s=>{this._result=OW(s),this._cleanup()},s=>{this._result=MW(s),this._cleanup()}),this._abortHandle=ba(r,this.abort)}normalizeCtorArgs(){return{}}destroy(){this.abort()}_cleanup(){this._abortHandle=Vi(this._abortHandle),this._abortController=null}};u([d()],T0.prototype,"value",null),u([d()],T0.prototype,"error",null),u([d()],T0.prototype,"finished",null),u([d()],T0.prototype,"promise",void 0),u([d()],T0.prototype,"_result",void 0),T0=u([P("esri.core.asyncUtils.ReactiveTask")],T0);async function PW(t,e){return await t.load(),zPe(t,e)}async function zPe(t,e){const r=[],i=(...n)=>{for(const o of n)C(o)||(Array.isArray(o)?i(...o):ft.isCollection(o)?o.forEach(a=>i(a)):cm.isLoadable(o)&&r.push(o))};e(i);let s=null;if(await UPe(r,async n=>{const o=await Uc(BPe(n)?n.loadAll():n.load());o.ok!==!1||s||(s=o)}),s)throw s.error;return t}function BPe(t){return"loadAll"in t&&typeof t.loadAll=="function"}function ke(t,e,r){let i,s;return e===void 0?(s=t,i=[void 0]):typeof e!="string"?(s=t,i=[void 0],r=e):(s=e,i=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;for(const l of i){const c=Lde(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),r&&(c.write.target=r),c.write.writer=a[o]}}}let Vr=class{constructor(e,r={ignoreUnknown:!1,useNumericKeys:!1}){this._jsonToAPI=e,this._options=r,this.apiValues=[],this.jsonValues=[],this._apiToJSON=this._invertMap(e),this.apiValues=this._getKeysSorted(this._apiToJSON),this.jsonValues=this._getKeysSorted(this._jsonToAPI),this.read=i=>this.fromJSON(i),this.write=(i,s,n)=>{const o=this.toJSON(i);o!==void 0&&sl(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(e){if(e==null)return null;if(this._apiToJSON.hasOwnProperty(e)){const r=this._apiToJSON[e];return this._options.useNumericKeys?+r:r}return this._options.ignoreUnknown?void 0:e}fromJSON(e){return e!=null&&this._jsonToAPI.hasOwnProperty(e)?this._jsonToAPI[e]:this._options.ignoreUnknown?void 0:e}_invertMap(e){const r={};for(const i in e)r[e[i]]=i;return r}_getKeysSorted(e){const r=[];for(const i in e)r.push(i);return r.sort(),r}};function Ra(){return function(t,e){return new Vr(t,{ignoreUnknown:!0,...e})}}let IW=class{constructor(e,r,i,s){this.semiMajorAxis=e,this.flattening=r,this.outerAtmosphereRimWidth=i;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}};const br=new IW(6378137,1/298.257223563,3e5,.006694379990137799),Jf=new IW(3396190,1/169.8944472236118,23e4),ny=new IW(1737400,0,0);var $h;(function(t){t[t.CGCS2000=4490]="CGCS2000",t[t.GCSMARS2000=104971]="GCSMARS2000",t[t.GCSMARS2000_SPHERE=104905]="GCSMARS2000_SPHERE",t[t.GCSMOON2000=104903]="GCSMOON2000"})($h||($h={}));let g;const D={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5041:0,5042:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,9793:0,9794:0,9869:0,9874:0,9875:0,9880:0,9943:0,9945:0,9947:0,9967:0,9972:0,9977:0,20042:0,20050:1,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22239:0,22240:0,22332:0,22337:0,22338:0,22391:0,22392:0,22639:0,22700:0,22739:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102731:0,102732:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(g=2e3;g<=2045;g++)D[g]=0;for(g=2056;g<=2065;g++)D[g]=0;for(g=2067;g<=2135;g++)D[g]=0;for(g=2137;g<=2154;g++)D[g]=0;for(g=2161;g<=2170;g++)D[g]=0;for(g=2172;g<=2193;g++)D[g]=0;for(g=2195;g<=2198;g++)D[g]=0;for(g=2200;g<=2203;g++)D[g]=0;for(g=2205;g<=2217;g++)D[g]=0;for(g=2222;g<=2224;g++)D[g]=1;for(g=2225;g<=2250;g++)D[g]=2;for(g=2251;g<=2253;g++)D[g]=1;for(g=2257;g<=2264;g++)D[g]=2;for(g=2274;g<=2279;g++)D[g]=2;for(g=2280;g<=2282;g++)D[g]=1;for(g=2283;g<=2289;g++)D[g]=2;for(g=2290;g<=2292;g++)D[g]=0;for(g=2308;g<=2313;g++)D[g]=0;for(g=2315;g<=2491;g++)D[g]=0;for(g=2494;g<=2866;g++)D[g]=0;for(g=2867;g<=2869;g++)D[g]=1;for(g=2870;g<=2888;g++)D[g]=2;for(g=2891;g<=2895;g++)D[g]=2;for(g=2896;g<=2898;g++)D[g]=1;for(g=2902;g<=2908;g++)D[g]=2;for(g=2915;g<=2920;g++)D[g]=2;for(g=2921;g<=2923;g++)D[g]=1;for(g=2924;g<=2930;g++)D[g]=2;for(g=2931;g<=2962;g++)D[g]=0;for(g=2964;g<=2968;g++)D[g]=2;for(g=2969;g<=2973;g++)D[g]=0;for(g=2975;g<=2991;g++)D[g]=0;for(g=2995;g<=3051;g++)D[g]=0;for(g=3054;g<=3079;g++)D[g]=0;for(g=3081;g<=3088;g++)D[g]=0;for(g=3092;g<=3101;g++)D[g]=0;for(g=3106;g<=3138;g++)D[g]=0;for(g=3146;g<=3151;g++)D[g]=0;for(g=3153;g<=3166;g++)D[g]=0;for(g=3168;g<=3172;g++)D[g]=0;for(g=3174;g<=3203;g++)D[g]=0;for(g=3294;g<=3358;g++)D[g]=0;for(g=3367;g<=3403;g++)D[g]=0;for(g=3408;g<=3416;g++)D[g]=0;for(g=3417;g<=3438;g++)D[g]=2;for(g=3441;g<=3446;g++)D[g]=2;for(g=3447;g<=3450;g++)D[g]=0;for(g=3451;g<=3459;g++)D[g]=2;for(g=3460;g<=3478;g++)D[g]=0;for(g=3554;g<=3559;g++)D[g]=0;for(g=3560;g<=3570;g++)D[g]=2;for(g=3571;g<=3581;g++)D[g]=0;for(g=3594;g<=3597;g++)D[g]=0;for(g=3601;g<=3604;g++)D[g]=0;for(g=3637;g<=3639;g++)D[g]=0;for(g=3665;g<=3667;g++)D[g]=0;for(g=3693;g<=3695;g++)D[g]=0;for(g=3701;g<=3727;g++)D[g]=0;for(g=3728;g<=3739;g++)D[g]=2;for(g=3740;g<=3751;g++)D[g]=0;for(g=3753;g<=3760;g++)D[g]=2;for(g=3761;g<=3773;g++)D[g]=0;for(g=3775;g<=3777;g++)D[g]=0;for(g=3779;g<=3781;g++)D[g]=0;for(g=3783;g<=3785;g++)D[g]=0;for(g=3788;g<=3791;g++)D[g]=0;for(g=3797;g<=3802;g++)D[g]=0;for(g=3814;g<=3816;g++)D[g]=0;for(g=3825;g<=3829;g++)D[g]=0;for(g=3832;g<=3841;g++)D[g]=0;for(g=3844;g<=3852;g++)D[g]=0;for(g=3873;g<=3885;g++)D[g]=0;for(g=3890;g<=3893;g++)D[g]=0;for(g=3907;g<=3912;g++)D[g]=0;for(g=3942;g<=3950;g++)D[g]=0;for(g=3968;g<=3970;g++)D[g]=0;for(g=3973;g<=3976;g++)D[g]=0;for(g=3986;g<=3989;g++)D[g]=0;for(g=3994;g<=3997;g++)D[g]=0;for(g=4048;g<=4051;g++)D[g]=0;for(g=4056;g<=4063;g++)D[g]=0;for(g=4093;g<=4096;g++)D[g]=0;for(g=4390;g<=4398;g++)D[g]=0;for(g=4399;g<=4413;g++)D[g]=2;for(g=4418;g<=4433;g++)D[g]=2;for(g=4455;g<=4457;g++)D[g]=2;for(g=4484;g<=4489;g++)D[g]=0;for(g=4491;g<=4554;g++)D[g]=0;for(g=4568;g<=4589;g++)D[g]=0;for(g=4652;g<=4656;g++)D[g]=0;for(g=4766;g<=4800;g++)D[g]=0;for(g=5014;g<=5016;g++)D[g]=0;for(g=5069;g<=5072;g++)D[g]=0;for(g=5105;g<=5130;g++)D[g]=0;for(g=5173;g<=5188;g++)D[g]=0;for(g=5253;g<=5259;g++)D[g]=0;for(g=5269;g<=5275;g++)D[g]=0;for(g=5292;g<=5311;g++)D[g]=0;for(g=5329;g<=5331;g++)D[g]=0;for(g=5343;g<=5349;g++)D[g]=0;for(g=5355;g<=5357;g++)D[g]=0;for(g=5387;g<=5389;g++)D[g]=0;for(g=5459;g<=5463;g++)D[g]=0;for(g=5479;g<=5482;g++)D[g]=0;for(g=5518;g<=5520;g++)D[g]=0;for(g=5530;g<=5539;g++)D[g]=0;for(g=5550;g<=5552;g++)D[g]=0;for(g=5562;g<=5583;g++)D[g]=0;for(g=5623;g<=5625;g++)D[g]=2;for(g=5631;g<=5639;g++)D[g]=0;for(g=5649;g<=5653;g++)D[g]=0;for(g=5663;g<=5680;g++)D[g]=0;for(g=5682;g<=5685;g++)D[g]=0;for(g=5875;g<=5877;g++)D[g]=0;for(g=5896;g<=5899;g++)D[g]=0;for(g=5921;g<=5940;g++)D[g]=0;for(g=6050;g<=6125;g++)D[g]=0;for(g=6244;g<=6275;g++)D[g]=0;for(g=6328;g<=6348;g++)D[g]=0;for(g=6350;g<=6356;g++)D[g]=0;for(g=6366;g<=6372;g++)D[g]=0;for(g=6381;g<=6387;g++)D[g]=0;for(g=6393;g<=6404;g++)D[g]=0;for(g=6480;g<=6483;g++)D[g]=0;for(g=6511;g<=6514;g++)D[g]=0;for(g=6579;g<=6581;g++)D[g]=0;for(g=6619;g<=6624;g++)D[g]=0;for(g=6625;g<=6627;g++)D[g]=2;for(g=6628;g<=6632;g++)D[g]=0;for(g=6634;g<=6637;g++)D[g]=0;for(g=6669;g<=6692;g++)D[g]=0;for(g=6707;g<=6709;g++)D[g]=0;for(g=6720;g<=6723;g++)D[g]=0;for(g=6732;g<=6738;g++)D[g]=0;for(g=6931;g<=6933;g++)D[g]=0;for(g=6956;g<=6959;g++)D[g]=0;for(g=7005;g<=7007;g++)D[g]=0;for(g=7057;g<=7070;g++)D[g]=2;for(g=7074;g<=7082;g++)D[g]=0;for(g=7109;g<=7118;g++)D[g]=0;for(g=7119;g<=7127;g++)D[g]=1;for(g=7374;g<=7376;g++)D[g]=0;for(g=7528;g<=7586;g++)D[g]=0;for(g=7587;g<=7645;g++)D[g]=2;for(g=7692;g<=7696;g++)D[g]=0;for(g=7755;g<=7787;g++)D[g]=0;for(g=7791;g<=7795;g++)D[g]=0;for(g=7799;g<=7801;g++)D[g]=0;for(g=7803;g<=7805;g++)D[g]=0;for(g=7825;g<=7831;g++)D[g]=0;for(g=7845;g<=7859;g++)D[g]=0;for(g=8013;g<=8032;g++)D[g]=0;for(g=8065;g<=8068;g++)D[g]=1;for(g=8518;g<=8529;g++)D[g]=2;for(g=8533;g<=8536;g++)D[g]=2;for(g=8538;g<=8540;g++)D[g]=2;for(g=8677;g<=8679;g++)D[g]=0;for(g=8836;g<=8840;g++)D[g]=0;for(g=8857;g<=8859;g++)D[g]=0;for(g=8908;g<=8910;g++)D[g]=0;for(g=9154;g<=9159;g++)D[g]=0;for(g=9205;g<=9218;g++)D[g]=0;for(g=9271;g<=9273;g++)D[g]=0;for(g=9295;g<=9297;g++)D[g]=0;for(g=9356;g<=9360;g++)D[g]=0;for(g=9404;g<=9407;g++)D[g]=0;for(g=9476;g<=9482;g++)D[g]=0;for(g=9487;g<=9494;g++)D[g]=0;for(g=9697;g<=9699;g++)D[g]=0;for(g=9821;g<=9865;g++)D[g]=0;for(g=20002;g<=20032;g++)D[g]=0;for(g=20047;g<=20049;g++)D[g]=0;for(g=20062;g<=20092;g++)D[g]=0;for(g=20135;g<=20138;g++)D[g]=0;for(g=20248;g<=20258;g++)D[g]=0;for(g=20348;g<=20358;g++)D[g]=0;for(g=20436;g<=20440;g++)D[g]=0;for(g=20822;g<=20824;g++)D[g]=0;for(g=20904;g<=20932;g++)D[g]=0;for(g=20934;g<=20936;g++)D[g]=0;for(g=21004;g<=21032;g++)D[g]=0;for(g=21035;g<=21037;g++)D[g]=0;for(g=21095;g<=21097;g++)D[g]=0;for(g=21148;g<=21150;g++)D[g]=0;for(g=21207;g<=21264;g++)D[g]=0;for(g=21307;g<=21364;g++)D[g]=0;for(g=21413;g<=21423;g++)D[g]=0;for(g=21453;g<=21463;g++)D[g]=0;for(g=21473;g<=21483;g++)D[g]=0;for(g=21780;g<=21782;g++)D[g]=0;for(g=21891;g<=21894;g++)D[g]=0;for(g=21896;g<=21899;g++)D[g]=0;for(g=22171;g<=22177;g++)D[g]=0;for(g=22181;g<=22187;g++)D[g]=0;for(g=22191;g<=22197;g++)D[g]=0;for(g=22207;g<=22222;g++)D[g]=0;for(g=22234;g<=22236;g++)D[g]=0;for(g=22243;g<=22250;g++)D[g]=0;for(g=22262;g<=22265;g++)D[g]=0;for(g=22307;g<=22322;g++)D[g]=0;for(g=22348;g<=22357;g++)D[g]=0;for(g=22407;g<=22422;g++)D[g]=0;for(g=22462;g<=22465;g++)D[g]=0;for(g=22521;g<=22525;g++)D[g]=0;for(g=22607;g<=22622;g++)D[g]=0;for(g=22641;g<=22646;g++)D[g]=0;for(g=22648;g<=22657;g++)D[g]=0;for(g=22707;g<=22722;g++)D[g]=0;for(g=22762;g<=22765;g++)D[g]=0;for(g=22991;g<=22994;g++)D[g]=0;for(g=23028;g<=23038;g++)D[g]=0;for(g=23830;g<=23853;g++)D[g]=0;for(g=23866;g<=23872;g++)D[g]=0;for(g=23877;g<=23884;g++)D[g]=0;for(g=23886;g<=23894;g++)D[g]=0;for(g=23946;g<=23948;g++)D[g]=0;for(g=24311;g<=24313;g++)D[g]=0;for(g=24342;g<=24347;g++)D[g]=0;for(g=24370;g<=24374;g++)D[g]=10;for(g=24375;g<=24381;g++)D[g]=0;for(g=24718;g<=24721;g++)D[g]=0;for(g=24817;g<=24821;g++)D[g]=0;for(g=24877;g<=24882;g++)D[g]=0;for(g=24891;g<=24893;g++)D[g]=0;for(g=25391;g<=25395;g++)D[g]=0;for(g=25828;g<=25838;g++)D[g]=0;for(g=26191;g<=26195;g++)D[g]=0;for(g=26391;g<=26393;g++)D[g]=0;for(g=26701;g<=26722;g++)D[g]=0;for(g=26729;g<=26799;g++)D[g]=2;for(g=26801;g<=26803;g++)D[g]=2;for(g=26811;g<=26813;g++)D[g]=2;for(g=26847;g<=26870;g++)D[g]=2;for(g=26891;g<=26899;g++)D[g]=0;for(g=26901;g<=26923;g++)D[g]=0;for(g=26929;g<=26946;g++)D[g]=0;for(g=26948;g<=26998;g++)D[g]=0;for(g=27037;g<=27040;g++)D[g]=0;for(g=27205;g<=27232;g++)D[g]=0;for(g=27258;g<=27260;g++)D[g]=0;for(g=27391;g<=27398;g++)D[g]=0;for(g=27561;g<=27564;g++)D[g]=0;for(g=27571;g<=27574;g++)D[g]=0;for(g=27581;g<=27584;g++)D[g]=0;for(g=27591;g<=27594;g++)D[g]=0;for(g=28191;g<=28193;g++)D[g]=0;for(g=28348;g<=28358;g++)D[g]=0;for(g=28402;g<=28432;g++)D[g]=0;for(g=28462;g<=28492;g++)D[g]=0;for(g=29118;g<=29122;g++)D[g]=0;for(g=29168;g<=29172;g++)D[g]=0;for(g=29177;g<=29185;g++)D[g]=0;for(g=29187;g<=29195;g++)D[g]=0;for(g=29900;g<=29903;g++)D[g]=0;for(g=30161;g<=30179;g++)D[g]=0;for(g=30491;g<=30494;g++)D[g]=0;for(g=30729;g<=30732;g++)D[g]=0;for(g=31251;g<=31259;g++)D[g]=0;for(g=31265;g<=31268;g++)D[g]=0;for(g=31275;g<=31279;g++)D[g]=0;for(g=31281;g<=31297;g++)D[g]=0;for(g=31461;g<=31469;g++)D[g]=0;for(g=31491;g<=31495;g++)D[g]=0;for(g=31917;g<=31922;g++)D[g]=0;for(g=31965;g<=32e3;g++)D[g]=0;for(g=32001;g<=32003;g++)D[g]=2;for(g=32005;g<=32031;g++)D[g]=2;for(g=32033;g<=32060;g++)D[g]=2;for(g=32064;g<=32067;g++)D[g]=2;for(g=32074;g<=32077;g++)D[g]=2;for(g=32081;g<=32086;g++)D[g]=0;for(g=32107;g<=32130;g++)D[g]=0;for(g=32133;g<=32159;g++)D[g]=0;for(g=32164;g<=32167;g++)D[g]=2;for(g=32180;g<=32199;g++)D[g]=0;for(g=32201;g<=32260;g++)D[g]=0;for(g=32301;g<=32360;g++)D[g]=0;for(g=32601;g<=32662;g++)D[g]=0;for(g=32664;g<=32667;g++)D[g]=2;for(g=32701;g<=32761;g++)D[g]=0;for(g=53001;g<=53004;g++)D[g]=0;for(g=53008;g<=53019;g++)D[g]=0;for(g=53021;g<=53032;g++)D[g]=0;for(g=53034;g<=53037;g++)D[g]=0;for(g=53042;g<=53046;g++)D[g]=0;for(g=53074;g<=53080;g++)D[g]=0;for(g=54001;g<=54004;g++)D[g]=0;for(g=54008;g<=54019;g++)D[g]=0;for(g=54021;g<=54032;g++)D[g]=0;for(g=54034;g<=54037;g++)D[g]=0;for(g=54042;g<=54046;g++)D[g]=0;for(g=54048;g<=54053;g++)D[g]=0;for(g=54074;g<=54080;g++)D[g]=0;for(g=54098;g<=54101;g++)D[g]=0;for(g=102001;g<=102040;g++)D[g]=0;for(g=102042;g<=102063;g++)D[g]=0;for(g=102065;g<=102067;g++)D[g]=0;for(g=102070;g<=102117;g++)D[g]=0;for(g=102122;g<=102216;g++)D[g]=0;for(g=102221;g<=102377;g++)D[g]=0;for(g=102382;g<=102388;g++)D[g]=0;for(g=102389;g<=102398;g++)D[g]=2;for(g=102399;g<=102444;g++)D[g]=0;for(g=102445;g<=102447;g++)D[g]=2;for(g=102448;g<=102458;g++)D[g]=0;for(g=102459;g<=102468;g++)D[g]=2;for(g=102469;g<=102499;g++)D[g]=0;for(g=102500;g<=102519;g++)D[g]=1;for(g=102520;g<=102524;g++)D[g]=0;for(g=102525;g<=102529;g++)D[g]=2;for(g=102530;g<=102588;g++)D[g]=0;for(g=102590;g<=102598;g++)D[g]=0;for(g=102601;g<=102603;g++)D[g]=0;for(g=102605;g<=102628;g++)D[g]=0;for(g=102629;g<=102646;g++)D[g]=2;for(g=102648;g<=102700;g++)D[g]=2;for(g=102701;g<=102703;g++)D[g]=0;for(g=102707;g<=102730;g++)D[g]=2;for(g=102733;g<=102758;g++)D[g]=2;for(g=102767;g<=102900;g++)D[g]=0;for(g=102901;g<=102933;g++)D[g]=2;for(g=102934;g<=102950;g++)D[g]=13;for(g=102951;g<=102955;g++)D[g]=0;for(g=102961;g<=102963;g++)D[g]=0;for(g=102965;g<=102969;g++)D[g]=0;for(g=102971;g<=102973;g++)D[g]=0;for(g=102975;g<=102989;g++)D[g]=0;for(g=102990;g<=102992;g++)D[g]=1;for(g=102997;g<=103002;g++)D[g]=0;for(g=103003;g<=103008;g++)D[g]=2;for(g=103009;g<=103011;g++)D[g]=0;for(g=103012;g<=103014;g++)D[g]=2;for(g=103019;g<=103021;g++)D[g]=0;for(g=103022;g<=103024;g++)D[g]=2;for(g=103029;g<=103031;g++)D[g]=0;for(g=103032;g<=103034;g++)D[g]=2;for(g=103065;g<=103068;g++)D[g]=0;for(g=103074;g<=103076;g++)D[g]=0;for(g=103077;g<=103079;g++)D[g]=1;for(g=103080;g<=103082;g++)D[g]=0;for(g=103083;g<=103085;g++)D[g]=2;for(g=103090;g<=103093;g++)D[g]=0;for(g=103097;g<=103099;g++)D[g]=0;for(g=103100;g<=103102;g++)D[g]=2;for(g=103107;g<=103109;g++)D[g]=0;for(g=103110;g<=103112;g++)D[g]=2;for(g=103113;g<=103116;g++)D[g]=0;for(g=103117;g<=103120;g++)D[g]=2;for(g=103153;g<=103157;g++)D[g]=0;for(g=103158;g<=103162;g++)D[g]=2;for(g=103163;g<=103165;g++)D[g]=0;for(g=103166;g<=103168;g++)D[g]=1;for(g=103169;g<=103171;g++)D[g]=2;for(g=103186;g<=103188;g++)D[g]=0;for(g=103189;g<=103191;g++)D[g]=2;for(g=103192;g<=103195;g++)D[g]=0;for(g=103196;g<=103199;g++)D[g]=2;for(g=103200;g<=103224;g++)D[g]=0;for(g=103225;g<=103227;g++)D[g]=1;for(g=103232;g<=103237;g++)D[g]=0;for(g=103238;g<=103243;g++)D[g]=2;for(g=103244;g<=103246;g++)D[g]=0;for(g=103247;g<=103249;g++)D[g]=2;for(g=103254;g<=103256;g++)D[g]=0;for(g=103257;g<=103259;g++)D[g]=2;for(g=103264;g<=103266;g++)D[g]=0;for(g=103267;g<=103269;g++)D[g]=2;for(g=103300;g<=103375;g++)D[g]=0;for(g=103381;g<=103383;g++)D[g]=0;for(g=103384;g<=103386;g++)D[g]=1;for(g=103387;g<=103389;g++)D[g]=0;for(g=103390;g<=103392;g++)D[g]=2;for(g=103397;g<=103399;g++)D[g]=0;for(g=103400;g<=103471;g++)D[g]=2;for(g=103476;g<=103478;g++)D[g]=0;for(g=103479;g<=103481;g++)D[g]=2;for(g=103486;g<=103488;g++)D[g]=0;for(g=103489;g<=103491;g++)D[g]=2;for(g=103492;g<=103495;g++)D[g]=0;for(g=103496;g<=103499;g++)D[g]=2;for(g=103528;g<=103543;g++)D[g]=0;for(g=103544;g<=103548;g++)D[g]=2;for(g=103549;g<=103551;g++)D[g]=0;for(g=103552;g<=103554;g++)D[g]=1;for(g=103555;g<=103557;g++)D[g]=2;for(g=103558;g<=103560;g++)D[g]=0;for(g=103571;g<=103573;g++)D[g]=0;for(g=103574;g<=103576;g++)D[g]=2;for(g=103577;g<=103580;g++)D[g]=0;for(g=103581;g<=103583;g++)D[g]=2;for(g=103595;g<=103694;g++)D[g]=0;for(g=103696;g<=103699;g++)D[g]=0;for(g=103700;g<=103793;g++)D[g]=2;for(g=103794;g<=103890;g++)D[g]=0;for(g=103891;g<=103896;g++)D[g]=2;for(g=103900;g<=103971;g++)D[g]=2;for(g=103972;g<=103977;g++)D[g]=0;for(g=112e3;g<=112101;g++)D[g]=0;const GPe={102113:!0,102100:!0,3857:!0,3785:!0},jPe={4326:!0,3785:!0,3857:!0,102113:!0,102100:!0,104905:!0,104971:!0},VQ='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',EP=[-20037508342788905e-9,20037508342788905e-9],CP=[-20037508342787e-6,20037508342787e-6],rpe={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:EP,origin:CP,dx:1e-5},102100:{wkTemplate:VQ,valid:EP,origin:CP,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:EP,origin:CP,dx:1e-5},3857:{wkTemplate:VQ,valid:EP,origin:CP,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function Cn(t,e){return t===e||!C(t)&&!C(e)&&(t.wkid!=null||e.wkid!=null?t.wkid===e.wkid||bw(t)&&bw(e)||e.latestWkid!=null&&t.wkid===e.latestWkid||t.latestWkid!=null&&e.wkid===t.latestWkid:!(!t.wkt||!e.wkt)&&t.wkt.toUpperCase()===e.wkt.toUpperCase())}function V_(t){return va(t)&&t.wkid&&rpe[t.wkid]||null}function ipe(t){return!!va(t)&&(t.wkid?D[t.wkid]==null:!!t.wkt&&!!/^\s*GEOGCS/i.test(t.wkt))}function BS(t){return!(wm(t)||xm(t))}function a3(t){return va(t)&&t.wkid===4326}function spe(t){return va(t)&&t.wkid===$h.CGCS2000}function bw(t){return va(t)&&t.wkid!=null&&GPe[t.wkid]===!0}function $W(t){return va(t)&&t.wkid===32662}function LW(t){return t===$h.GCSMARS2000||t===$h.GCSMARS2000_SPHERE}function wm(t){return va(t)&&t.wkid!=null&&LW(t.wkid)}function DW(t){return t===$h.GCSMOON2000}function xm(t){return va(t)&&t.wkid!=null&&DW(t.wkid)}function HPe(t){return va(t)&&t.wkid!=null&&jPe[t.wkid]===!0}function va(t){return v(t)&&(t.wkid!=null&&t.wkid>=2e3||t.wkt!=null)}const qPe={wkid:4326,wkt:om(rpe[4326].wkTemplate,{Central_Meridian:"0.0"})},WPe={wkid:102100,latestWkid:3857},XPe={wkid:32662};function NW(t){return{wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${t.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`}}const npe=NW(br),FW=NW(Jf),UW=NW(ny),ope={wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${br.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`};function Yr(t){return v(t)&&(wm(t)||Cn(t,FW))?Jf:v(t)&&(xm(t)||Cn(t,UW))?ny:br}function I2t(t){return LW(t)?Jf:DW(t)?ny:br}const VW=39.37,YPe=br.radius*Math.PI/200,ape=/UNIT\[([^\]]+)\]\]$/i,ew=D,lpe=/UNIT\[([^\]]+)\]/i,ZPe=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),JPe=Ra()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),Dp=t=>t*t,ky=t=>t*t*t,l3={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:Dp(.001)},"square-centimeters":{inBaseUnits:Dp(.01)},"square-decimeters":{inBaseUnits:Dp(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:Dp(1e3)},"square-inches":{inBaseUnits:Dp(.0254)},"square-feet":{inBaseUnits:Dp(.3048)},"square-yards":{inBaseUnits:Dp(.9144)},"square-miles":{inBaseUnits:Dp(1609.344)},"square-us-feet":{inBaseUnits:Dp(1200/3937)},acres:{inBaseUnits:.0015625*Dp(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*ky(.001)},"cubic-centimeters":{inBaseUnits:1e3*ky(.01)},"cubic-decimeters":{inBaseUnits:1e3*ky(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*ky(1e3)},"cubic-inches":{inBaseUnits:1e3*ky(.0254)},"cubic-feet":{inBaseUnits:1e3*ky(.3048)},"cubic-yards":{inBaseUnits:1e3*ky(.9144)},"cubic-miles":{inBaseUnits:1e3*ky(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},KPe=(()=>{const t={};for(const e in l3)for(const r in l3[e].units)t[r]=e;return t})();function QPe(t,e,r){return t*l3[r].units[e].inBaseUnits}function eIe(t,e,r){return t/l3[r].units[e].inBaseUnits}const tIe=["metric","imperial","inches","feet","yards","miles","nautical-miles","us-feet","meters","kilometers"];function Jk(t){const e=KPe[t];if(!e)throw new Error("unknown type");return e}function kQ(t,e=null){return e=e||Jk(t),l3[e].baseUnit===t}function vn(t,e,r){if(e===r)return t;const i=Jk(e);if(i!==Jk(r))throw new Error("incompatible units");const s=kQ(e,i)?t:QPe(t,e,i);return kQ(r,i)?s:eIe(s,r,i)}function $2t(t,e,r){switch(r){case"metric":return cpe(t,e);case"imperial":return hpe(t,e);default:return r}}function L2t(t,e,r){switch(r){case"metric":return upe(t,e);case"imperial":return dpe(t,e);default:return r}}function cpe(t,e){const r=vn(t,e,"meters");return Math.abs(r)<3e3?"meters":"kilometers"}function upe(t,e){const r=vn(t,e,"meters");return Math.abs(r)<1e5?"meters":"kilometers"}function hpe(t,e){const r=vn(t,e,"feet");return Math.abs(r)<1e3?"feet":"miles"}function dpe(t,e){const r=vn(t,e,"feet");return Math.abs(r)<1e5?"feet":"miles"}function D2t(t,e){const r=vn(t,e,"square-meters");return Math.abs(r)<3e6?"square-meters":"square-kilometers"}function N2t(t,e){const r=vn(t,e,"square-feet");return Math.abs(r)<1e6?"square-feet":"square-miles"}function rIe(t,e,r){return vn(t,e,"meters")/(r*Math.PI/180)}function ppe(t){return JPe.fromJSON(t.toLowerCase())||null}function ww(t){if(v(t)&&!BS(t))return 1;const e=al(t);return e>1e5?1:e}function iIe(t){return al(t)>=Yr(t).metersPerDegree?"meters":J4(t)}function al(t,e=br.metersPerDegree){return It(sIe(t,!0),e)}function sIe(t,e=!1){const r=v(t)?t.wkid:null,i=v(t)?t.wkt:null;let s=null;if(r){if(LW(r))return Jf.metersPerDegree;if(DW(r))return ny.metersPerDegree;s=ew.values[ew[r]],!s&&e&&ZPe.has(r)&&(s=YPe)}else i&&(gpe(i)?s=zQ(ape.exec(i),s):mpe(i)&&(s=zQ(lpe.exec(i),s)));return s}function zQ(t,e){return t&&t[1]?fpe(t[1]):e}function fpe(t){return parseFloat(t.split(",")[1])}function J4(t){const e=v(t)?t.wkid:null,r=v(t)?t.wkt:null;let i=null;if(e)i=ew.units[ew[e]];else if(r){const s=gpe(r)?ape:mpe(r)?lpe:null;if(s){const n=s.exec(r);n&&n[1]&&(i=oIe(n[1]))}}return v(i)?ppe(i):null}function F2t(t){const e=J4(t);return C(e)||!tIe.includes(e)?null:e}function mpe(t){return/^GEOCCS/i.test(t)}function gpe(t){return/^PROJCS/i.test(t)}const nIe=1e-7;function oIe(t){const e=/[\\"\\']{1}([^\\"\\']+)/.exec(t);let r=e&&e[1];if(!r||!ew.units.includes(r)){const i=fpe(t);r=null;const s=ew.values;for(let n=0;n<s.length;++n)if(Math.abs(i-s[n])<nIe){r=ew.units[n];break}}return r}function U2t(t){const e=J4(t);if(C(e))return null;switch(e){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric"}return null}const aIe={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},lIe={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},cIe={esriDUDecimalDegrees:"degrees",esriDURadians:"radians"},uIe=Ra()(aIe),hIe=Ra()(lIe),V2t=Ra()(cIe);var tf;let Ri=tf=class extends fe{static fromJSON(t){if(!t)return null;if(t.wkid){if(t.wkid===102100)return tf.WebMercator;if(t.wkid===4326)return tf.WGS84}const e=new tf;return e.read(t),e}constructor(t){super(t),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}normalizeCtorArgs(t){return t&&typeof t=="object"?t:{[typeof t=="string"?"wkt":"wkid"]:t}}get isWGS84(){return a3(this)}get isWebMercator(){return bw(this)}get isGeographic(){return ipe(this)}get isWrappable(){return HPe(this)}get metersPerUnit(){return al(this)}get unit(){return J4(this)||(this.isGeographic?"degrees":null)}writeWkt(t,e){this.wkid||(e.wkt=t)}clone(){if(this===tf.WGS84)return tf.WGS84;if(this===tf.WebMercator)return tf.WebMercator;const t=new tf;return this.wkid!=null?(t.wkid=this.wkid,this.latestWkid!=null&&(t.latestWkid=this.latestWkid),this.vcsWkid!=null&&(t.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(t.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(t.wkt=this.wkt),this.imageCoordinateSystem&&(t.imageCoordinateSystem=te(this.imageCoordinateSystem)),t}equals(t){if(t==null)return!1;if(this.imageCoordinateSystem||t.imageCoordinateSystem){if(this.imageCoordinateSystem==null||t.imageCoordinateSystem==null)return!1;const{id:e,referenceServiceName:r}=t.imageCoordinateSystem,{geodataXform:i}=t.imageCoordinateSystem,s=this.imageCoordinateSystem;return e==null||i?JSON.stringify(s)===JSON.stringify(t.imageCoordinateSystem):r?s.id===e&&s.referenceServiceName===r:s.id===e}return Cn(this,t)}toJSON(t){return this.write(void 0,t)}};Ri.GCS_NAD_1927=null,Ri.WGS84=null,Ri.WebMercator=null,Ri.PlateCarree=null,u([d({readOnly:!0})],Ri.prototype,"isWGS84",null),u([d({readOnly:!0})],Ri.prototype,"isWebMercator",null),u([d({readOnly:!0})],Ri.prototype,"isGeographic",null),u([d({readOnly:!0})],Ri.prototype,"isWrappable",null),u([d({type:Ti,json:{write:!0}})],Ri.prototype,"latestWkid",void 0),u([d({readOnly:!0})],Ri.prototype,"metersPerUnit",null),u([d({readOnly:!0})],Ri.prototype,"unit",null),u([d({type:Ti,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt===null}}}}}}})],Ri.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid===null}}}}}}})],Ri.prototype,"wkt",void 0),u([ke("wkt"),ke("web-scene","wkt")],Ri.prototype,"writeWkt",null),u([d({type:Ti,json:{write:!0}})],Ri.prototype,"vcsWkid",void 0),u([d({type:Ti,json:{write:!0}})],Ri.prototype,"latestVcsWkid",void 0),u([d()],Ri.prototype,"imageCoordinateSystem",void 0),Ri=tf=u([P("esri.geometry.SpatialReference")],Ri),Ri.prototype.toJSON.isDefaultToJSON=!0,Ri.GCS_NAD_1927=new Ri({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),Ri.WGS84=new Ri(qPe),Ri.WebMercator=new Ri(WPe),Ri.PlateCarree=new Ri(XPe),Object.freeze&&(Object.freeze(Ri.GCS_NAD_1927),Object.freeze(Ri.WGS84),Object.freeze(Ri.WebMercator));const We=Ri,dIe=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function ype(t){const e=dp(t,!0);return!!e&&e.endsWith(".arcgis.com")&&!dIe.includes(e)&&!t.endsWith("/sharing/rest/generateToken")}function _pe(t,e,r=!1,i){return new Promise((s,n)=>{if(Fn(i))return void n(BQ());let o=()=>{c(),n(new Error(`Unable to load ${e}`))},a=()=>{const h=t;c(),s(h)},l=()=>{if(!t)return;const h=t;c(),h.src="",n(BQ())};const c=()=>{de("esri-image-decode")||(t.removeEventListener("error",o),t.removeEventListener("load",a)),o=null,a=null,t=null,v(i)&&i.removeEventListener("abort",l),l=null,r&&URL.revokeObjectURL(e)};v(i)&&i.addEventListener("abort",l),de("esri-image-decode")?t.decode().then(a,o):(t.addEventListener("error",o),t.addEventListener("load",a))})}function BQ(){try{return new DOMException("Aborted","AbortError")}catch{const t=new Error;return t.name="AbortError",t}}function pIe(t){Qr.request.crossOriginNoCorsDomains||(Qr.request.crossOriginNoCorsDomains={});const e=Qr.request.crossOriginNoCorsDomains;for(let r of t)r=r.toLowerCase(),/^https?:\/\//.test(r)?e[dp(r)??""]=0:(e[dp("http://"+r)??""]=0,e[dp("https://"+r)??""]=0)}function fIe(t){const e=Qr.request.crossOriginNoCorsDomains;if(e){let r=dp(t);if(r)return r=r.toLowerCase(),!NS(r,aW())&&e[r]<Date.now()-36e5}return!1}async function mIe(t){var s;const e=Qr.request.crossOriginNoCorsDomains,r=dp(t);e&&r&&(e[r.toLowerCase()]=Date.now());const i=lo(t);t=i.path,((s=i.query)==null?void 0:s.f)==="json"&&(t+="?f=json");try{await fetch(t,{mode:"no-cors",credentials:"include"})}catch{}}async function Pi(t,e){var c;const r=bm(t),i=FS(t);i||r||(t=Uh(t));const s={url:t,requestOptions:{...e}};let n=Jhe(t);if(n){const h=await TIe(n,s);if(h!=null)return{data:h,getHeader:kW,httpStatus:200,requestOptions:s.requestOptions,url:s.url};n.after||n.error||(n=null)}if(t=s.url,(e=s.requestOptions).responseType==="image"){if(de("host-webworker")||de("host-node"))throw tp("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),s)}else if(r)throw tp("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+e.responseType),s);if(e.method==="head"){if(e.body)throw tp("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),s);if(r||i)throw tp("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),s)}if(await bIe(),GN)return GN.execute(t,e);const o=new AbortController;ba(e,()=>o.abort());const a={controller:o,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:n,params:s,redoRequest:!1,useIdentity:Hd.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},l=await EIe(a);return(c=n==null?void 0:n.after)==null||c.call(n,l),l}let GN;const Hd=Qr.request,vpe="FormData"in globalThis,gIe=[499,498,403,401],yIe=["COM_0056","COM_0057","SB_0008"],_Ie=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],kW=()=>null,jN=Symbol();function vIe(t){const e=dp(t);e&&!Pi._corsServers.includes(e)&&Pi._corsServers.push(e)}function GQ(t){const e=dp(t);return!e||e.endsWith(".arcgis.com")||Pi._corsServers.includes(e)||cW(e)}function tp(t,e,r,i){let s="Error";const n={url:r.url,requestOptions:r.requestOptions,getHeader:kW,ssl:!1};if(e instanceof j)return e.details?(e.details=te(e.details),e.details.url=r.url,e.details.requestOptions=r.requestOptions):e.details=n,e;if(e){const o=i&&(c=>i.headers.get(c)),a=i&&i.status,l=e.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(e.httpCode!=null?e.httpCode:e.code)||a||0,n.subCode=e.subcode,n.messageCode=e.messageCode,typeof e.details=="string"?n.messages=[e.details]:n.messages=e.details,n.raw=jN in e?e[jN]:e}return Ks(e)?qr():new j(t,s,n)}async function bIe(){de("host-webworker")?GN||(GN=await ie(()=>import("./request-b4ccdbcf.js"),[],import.meta.url)):Pi._abortableFetch||(Pi._abortableFetch=globalThis.fetch.bind(globalThis))}async function Kk(){xi||await ie(()=>import("./IdentityManager-99d06c95.js"),[],import.meta.url)}async function wIe(t){var a;const e=t.params.url,r=t.params.requestOptions,i=t.controller.signal,s=r.body;let n=null,o=null;if(vpe&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(n=new FormData(s))),typeof s=="string"&&(o=s),t.fetchOptions={cache:r.cacheBust&&!Pi._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:r.headers||{},method:r.method==="head"?"HEAD":"GET",mode:"cors",priority:Hd.priority,redirect:"follow",signal:i},(n||o)&&(t.fetchOptions.body=n||o),r.authMode==="anonymous"&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(e)||(a=r.query)!=null&&a.token||n!=null&&n.get("token")),!t.hasToken&&Qr.apiKey&&ype(e)&&(r.query||(r.query={}),r.query.token=Qr.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!bpe(e)&&!Fn(i)){let l;r.authMode==="immediate"?(await Kk(),l=await xi.getCredential(e,{signal:i}),t.credential=l):r.authMode==="no-prompt"?(await Kk(),l=await xi.getCredential(e,{prompt:!1,signal:i}).catch(()=>{}),t.credential=l):xi&&(l=xi.findCredential(e)),l&&(t.credentialToken=l.token,t.useSSL=!!l.ssl)}}function bpe(t){return _Ie.some(e=>e.test(t))}async function xIe(t){let e=t.params.url;const r=t.params.requestOptions,i=t.fetchOptions??{},s=FS(e)||bm(e),n=r.responseType||"json",o=s?0:r.timeout!=null?r.timeout:Hd.timeout;let a=!1;if(!s){t.useSSL&&(e=pW(e)),r.cacheBust&&i.cache==="default"&&(e=fW(e,"request.preventCache",Date.now()));let f={...r.query};t.credentialToken&&(f.token=t.credentialToken);let m=i3(f);de("esri-url-encodes-apostrophe")&&(m=m.replace(/'/g,"%27"));const y=e.length+1+m.length;let _;a=r.method==="delete"||r.method==="post"||r.method==="put"||!!r.body||y>Hd.maxUrlLength;const b=r.useProxy||!!B4(e);if(b){const x=O3e(e);_=x.path,!a&&_.length+1+y>Hd.maxUrlLength&&(a=!0),x.query&&(f={...x.query,...f})}if(i.method==="HEAD"&&(a||b)){if(a)throw y>Hd.maxUrlLength?tp("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params):tp("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params);if(b)throw tp("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}if(a?(i.method=r.method==="delete"?"DELETE":r.method==="put"?"PUT":"POST",r.body?e=oU(e,f):(i.body=i3(f),i.headers||(i.headers={}),i.headers["Content-Type"]="application/x-www-form-urlencoded")):e=oU(e,f),b&&(t.useProxy=!0,e=`${_}?${e}`),f.token&&vpe&&i.body instanceof FormData&&!_3e(e)&&i.body.set("token",f.token),r.hasOwnProperty("withCredentials"))t.withCredentials=r.withCredentials;else if(!NS(e,aW())){if(cW(e))t.withCredentials=!0;else if(xi){const x=xi.findServerInfo(e);x&&x.webTierAuth&&(t.withCredentials=!0)}}t.withCredentials&&(i.credentials="include",fIe(e)&&await mIe(a?oU(e,f):e))}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,t.controller.abort()},o));try{if(r.responseType==="native-request-init")c=i,c.url=e;else if(r.responseType!=="image"||i.cache!=="default"||i.method!=="GET"||a||SIe(r.headers)||!s&&!t.useProxy&&Hd.proxyUrl&&!GQ(e)){if(l=await Pi._abortableFetch(e,i),t.useProxy||vIe(e),r.responseType==="native")c=l;else if(i.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=jQ(c,"application/xml");break;case"document":c=jQ(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(f&&/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const m=await new Response(c).json();m.error&&(c=m)}catch{}}n==="image"&&c instanceof Blob&&(c=await HQ(URL.createObjectURL(c),t,!0))}}else c=await l.text()}else c=await HQ(e,t)}catch(f){if(f.name==="AbortError")throw p?new Error("Timeout exceeded"):qr("Request canceled");if(!(!l&&f instanceof TypeError&&Hd.proxyUrl)||r.body||r.method==="delete"||r.method==="head"||r.method==="post"||r.method==="put"||t.useProxy||GQ(e))throw f;t.redoRequest=!0,M3e({proxyUrl:Hd.proxyUrl,urlPrefix:dp(e)??""})}finally{h&&clearTimeout(h)}return[l,c]}async function TIe(t,e){if(t.responseData!=null)return t.responseData;if(t.headers&&(e.requestOptions.headers={...e.requestOptions.headers,...t.headers}),t.query&&(e.requestOptions.query={...e.requestOptions.query,...t.query}),t.before){let r,i;try{i=await t.before(e)}catch(s){r=tp("request:interceptor",s,e)}if((i instanceof Error||i instanceof j)&&(r=tp("request:interceptor",i,e)),r)throw t.error&&t.error(r),r;return i}}function SIe(t){if(t){for(const e of Object.getOwnPropertyNames(t))if(t[e])return!0}return!1}function jQ(t,e){let r;try{r=new DOMParser().parseFromString(t,e)}catch{}if(!r||r.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return r}async function EIe(t){var n;let e,r;await wIe(t);try{do[e,r]=await xIe(t);while(!await CIe(t,e,r))}catch(o){const a=tp("request:server",o,t.params,e);throw a.details.ssl=t.useSSL,t.interceptor&&t.interceptor.error&&t.interceptor.error(a),a}const i=t.params.url;if(r&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(i)){if(!t.hasToken&&!t.credentialToken&&((n=r.user)!=null&&n.username)&&!cW(i)){const o=dp(i,!0);o&&Hd.trustedServers.push(o)}Array.isArray(r.authorizedCrossOriginNoCorsDomains)&&pIe(r.authorizedCrossOriginNoCorsDomains)}const s=t.credential;if(s&&xi){const o=xi.findServerInfo(s.server);let a=o&&o.owningSystemUrl;if(a){a=a.replace(/\/?$/,"/sharing");const l=xi.findCredential(a,s.userId);l&&xi._getIdenticalSvcIdx(a,l)===-1&&l.resources.unshift(a)}}return{data:r,getHeader:e?o=>e==null?void 0:e.headers.get(o):kW,httpStatus:(e==null?void 0:e.status)??200,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}async function CIe(t,e,r){if(t.redoRequest)return t.redoRequest=!1,!1;const i=t.params.requestOptions;if(!e||i.responseType==="native"||i.responseType==="native-request-init")return!0;let s,n;if(!e.ok)throw s=new Error(`Unable to load ${e.url} status: ${e.status}`),s[jN]=r,s;r&&(r.error?s=r.error:r.status==="error"&&Array.isArray(r.messages)&&(s={...r},s[jN]=r,s.details=r.messages));let o,a=null;s&&(n=Number(s.code),a=s.hasOwnProperty("subcode")?Number(s.subcode):null,o=s.messageCode,o=o&&o.toUpperCase());const l=i.authMode;if(n===403&&(a===4||s.message&&s.message.toLowerCase().includes("ssl")&&!s.message.toLowerCase().includes("permission"))){if(!t.useSSL)return t.useSSL=!0,!1}else if(!t.hasToken&&t.useIdentity&&(l!=="no-prompt"||n===498)&&n!==void 0&&gIe.includes(n)&&!bpe(t.params.url)&&(n!==403||o&&!yIe.includes(o)&&(a==null||a===2&&t.credentialToken))){await Kk();try{const c=await xi.getCredential(t.params.url,{error:tp("request:server",s,t.params),prompt:l!=="no-prompt",signal:t.controller.signal,token:t.credentialToken});return t.credential=c,t.credentialToken=c.token,t.useSSL=t.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return t.credential=void 0,t.credentialToken=void 0,!1;s=c}}if(s)throw s;return!0}function HQ(t,e,r=!1){const i=e.controller.signal,s=new Image;return e.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.fetchPriority=Hd.priority,s.src=t,_pe(s,t,r,i)}Pi._abortableFetch=null,Pi._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];const AIe=Object.freeze(Object.defineProperty({__proto__:null,default:Pi},Symbol.toStringTag,{value:"Module"}));function Le(t,e,r){let i,s;return e===void 0||Array.isArray(e)?(s=t,r=e,i=[void 0]):(s=e,i=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;i.forEach(l=>{const c=Lde(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],r&&(c.read.source=(c.read.source||[]).concat(r))})}}let rf=class extends fe{constructor(...e){super(...e),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=We.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(e,r){if(e instanceof We)return e;if(e!=null){const i=new We;return i.read(e,r),i}return e}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(e){return this.cache[e]}setCacheValue(e,r){this.cache[e]=r}};u([d()],rf.prototype,"type",void 0),u([d({readOnly:!0})],rf.prototype,"cache",null),u([d({readOnly:!0})],rf.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],rf.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],rf.prototype,"hasZ",void 0),u([d({type:We,json:{write:!0},value:We.WGS84})],rf.prototype,"spatialReference",void 0),u([Le("spatialReference")],rf.prototype,"readSpatialReference",null),rf=u([P("esri.geometry.Geometry")],rf);const xv=rf,RIe=Object.prototype.toString;function OIe(t){const e="__accessorMetadata__"in t?Ls(t):t;return function(...r){if(r.push(e),typeof r[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return MIe.apply(this,r)}}function MIe(t,e,r,i){G4(t,e).cast=i}function PIe(t){return(e,r)=>{G4(e,t).cast=e[r]}}function Gt(...t){if(t.length!==3||typeof t[1]!="string")return t.length===1&&RIe.call(t[0])==="[object Function]"?OIe(t[0]):t.length===1&&typeof t[0]=="string"?PIe(t[0]):void 0}function IIe(t,e){const r=t.x-e.x,i=t.y-e.y,s=t.hasZ&&e.hasZ?t.z-e.z:0;return Math.sqrt(r*r+i*i+s*s)}const $Ie=57.29577951308232,LIe=.017453292519943;function qQ(t){return t*$Ie}function WQ(t){return t*LIe}function XQ(t){return t/br.radius}function HN(t){return Math.PI/2-2*Math.atan(Math.exp(-t/br.radius))}function Qk(t){return t.wkid!=null||t.wkt!=null}const fU=[0,0];function qN(t,e,r,i,s){const n=t,o=s;if(o.spatialReference=r,"x"in n&&"x"in o)[o.x,o.y]=e(n.x,n.y,fU,i);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=e(n.xmin,n.ymin,fU,i),[o.xmax,o.ymax]=e(n.xmax,n.ymax,fU,i);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(e(p[f][0],p[f][1],[0,0],i)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=e(a[c][0],a[c][1],[0,0],i),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function k_(t,e){const r=t&&(Qk(t)?t:t.spatialReference),i=e&&(Qk(e)?e:e.spatialReference);return!(t&&"type"in t&&t.type==="mesh"||e&&"type"in e&&e.type==="mesh"||!r||!i)&&(!!Cn(i,r)||bw(i)&&a3(r)||bw(r)&&a3(i))}function ex(t,e){if(C(t))return null;const r=t.spatialReference,i=e&&(Qk(e)?e:e.spatialReference);return k_(r,i)?Cn(r,i)?te(t):bw(i)?qN(t,$2,We.WebMercator,!1,te(t)):a3(i)?qN(t,oO,We.WGS84,!1,te(t)):null:null}function $2(t,e,r=[0,0]){e>89.99999?e=89.99999:e<-89.99999&&(e=-89.99999);const i=WQ(e);return r[0]=WQ(t)*br.radius,r[1]=br.halfSemiMajorAxis*Math.log((1+Math.sin(i))/(1-Math.sin(i))),r}function oO(t,e,r=[0,0],i=!1){const s=qQ(t/br.radius);return r[0]=i?s:s-360*Math.floor((s+180)/360),r[1]=qQ(Math.PI/2-2*Math.atan(Math.exp(-e/br.radius))),r}function jg(t,e=!1,r=te(t)){return qN(t,$2,We.WebMercator,e,r)}function L2(t,e=!1,r=te(t)){return qN(t,oO,We.WGS84,e,r)}var SL;const wC=[0,0];function YQ(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let xl=SL=class extends xv{static copy(t,e){e._set("x",t._get("x")),e._set("y",t._get("y")),e._set("z",t._get("z")),e._set("m",t._get("m"));const r=t._get("spatialReference");e._set("spatialReference",Object.isFrozen(r)?r:r.clone())}constructor(...t){super(...t),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}normalizeCtorArgs(t,e,r,i,s){let n;if(Array.isArray(t))n=t,s=e,t=n[0],e=n[1],r=n[2],i=n[3];else if(t&&typeof t=="object"){if(n=t,t=n.x!=null?n.x:n.longitude,e=n.y!=null?n.y:n.latitude,r=n.z,i=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new We(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)se.getLogger(this.declaredClass).warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)se.getLogger(this.declaredClass).warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=$2(n.longitude,n.latitude,wC);t=a[0],e=a[1]}}}else YQ(r)?(s=r,r=null):YQ(i)&&(s=i,i=null);const o={x:t,y:e};return o.x==null&&o.y!=null?se.getLogger(this.declaredClass).warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&se.getLogger(this.declaredClass).warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),r!=null&&(o.z=r),i!=null&&(o.m=i),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(t){t!==(this._get("m")!==void 0)&&(this._set("m",t?0:void 0),this._set("hasM",t))}get hasZ(){return this.z!==void 0}set hasZ(t){t!==(this._get("z")!==void 0)&&(this._set("z",t?0:void 0),this._set("hasZ",t))}get latitude(){const{spatialReference:t,x:e,y:r}=this;if(t){if(t.isWebMercator)return oO(e,r,wC)[1];if(t.isGeographic)return r}return null}set latitude(t){const{spatialReference:e,x:r}=this;t!=null&&e&&(e.isWebMercator?this._set("y",$2(r,t,wC)[1]):e.isGeographic&&this._set("y",t),this._set("latitude",t))}get longitude(){const{x:t,y:e,spatialReference:r}=this;if(r){if(r.isWebMercator)return oO(t,e,wC)[0];if(r.isGeographic)return t}return null}set longitude(t){const{y:e,spatialReference:r}=this;t!=null&&r&&(r.isWebMercator?this._set("x",$2(t,e,wC)[0]):r.isGeographic&&this._set("x",t),this._set("longitude",t))}writeX(t,e,r){e[r]=isNaN(t)?"NaN":t}readX(t){return typeof t=="string"?NaN:t}clone(){const t=new SL;return t.x=this.x,t.y=this.y,t.z=this.z,t.m=this.m,t.spatialReference=this.spatialReference,t}copy(t){return SL.copy(t,this),this}equals(t){if(C(t))return!1;const{x:e,y:r,z:i,m:s,spatialReference:n}=this,{z:o,m:a}=t;let{x:l,y:c,spatialReference:h}=t;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=$2(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=oO(l,c),h=n}return e===l&&r===c&&i===o&&s===a&&n.wkid===h.wkid}offset(t,e,r){return this.x+=t,this.y+=e,r!=null&&(this.z=(this.z??0)+r),this}normalize(){if(!this.spatialReference)return this;const t=V_(this.spatialReference);if(!t)return this;let e=this.x;const[r,i]=t.valid,s=2*i;let n;return e>i?(n=Math.ceil(Math.abs(e-i)/s),e-=n*s):e<r&&(n=Math.ceil(Math.abs(e-r)/s),e+=n*s),this._set("x",e),this}distance(t){return IIe(this,t)}toArray(){const t=this.hasZ,e=this.hasM;return t&&e?[this.x,this.y,this.z,this.m]:t?[this.x,this.y,this.z]:e?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],xl.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],xl.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],xl.prototype,"hasZ",null),u([d({type:Number})],xl.prototype,"latitude",null),u([d({type:Number})],xl.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),Gt(t=>isNaN(t)?t:Ch(t))],xl.prototype,"x",void 0),u([ke("x")],xl.prototype,"writeX",null),u([Le("x")],xl.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],xl.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],xl.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],xl.prototype,"m",void 0),xl=SL=u([P("esri.geometry.Point")],xl),xl.prototype.toJSON.isDefaultToJSON=!0;const _t=xl,mU=[0,0];function zW(t,e){return!!v(e)&&Xa(t,e.x,e.y,e.z)}function z2t(t,e){if(!e.points||e.points.length)return!1;for(const r of e.points)if(!GS(t,r))return!1;return!0}function DIe(t,e){const{xmin:r,ymin:i,zmin:s,xmax:n,ymax:o,zmax:a}=e;return t.hasZ&&e.hasZ?Xa(t,r,i,s)&&Xa(t,r,o,s)&&Xa(t,n,o,s)&&Xa(t,n,i,s)&&Xa(t,r,i,a)&&Xa(t,r,o,a)&&Xa(t,n,o,a)&&Xa(t,n,i,a):Xa(t,r,i)&&Xa(t,r,o)&&Xa(t,n,o)&&Xa(t,n,i)}function GS(t,e){return Xa(t,e[0],e[1])}function NIe(t,e){return Xa(t,e[0],e[1],e[2])}function Xa(t,e,r,i){return e>=t.xmin&&e<=t.xmax&&r>=t.ymin&&r<=t.ymax&&(i==null||!t.hasZ||i>=t.zmin&&i<=t.zmax)}function FIe(t,e){return mU[1]=e.y,mU[0]=e.x,UIe(t,mU)}function UIe(t,e){return wpe(t.rings,e)}function wpe(t,e){if(!t)return!1;if(VIe(t))return ZQ(!1,t,e);let r=!1;for(let i=0,s=t.length;i<s;i++)r=ZQ(r,t[i],e);return r}function VIe(t){return!Array.isArray(t[0][0])}function ZQ(t,e,r){const[i,s]=r;let n=t,o=0;for(let a=0,l=e.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=e[a],[p,f]=e[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<i&&(n=!n)}return n}function kIe(t,e){return zW(t,e)}function zIe(t,e){const r=t.hasZ&&e.hasZ;let i,s,n;if(t.xmin<=e.xmin){if(i=e.xmin,t.xmax<i)return!1}else if(i=t.xmin,e.xmax<i)return!1;if(t.ymin<=e.ymin){if(s=e.ymin,t.ymax<s)return!1}else if(s=t.ymin,e.ymax<s)return!1;if(r&&e.hasZ){if(t.zmin<=e.zmin){if(n=e.zmin,t.zmax<n)return!1}else if(n=t.zmin,e.zmax<n)return!1}return!0}function BIe(t,e){const{points:r,hasZ:i}=e,s=i?NIe:GS;for(const n of r)if(s(t,n))return!0;return!1}const xw=[0,0],Tw=[0,0],Sw=[0,0],Ew=[0,0],GIe=[xw,Tw,Sw,Ew],xpe=[[Sw,xw],[xw,Tw],[Tw,Ew],[Ew,Sw]];function jIe(t,e){return HIe(t,e.rings)}function HIe(t,e){xw[0]=t.xmin,xw[1]=t.ymax,Tw[0]=t.xmax,Tw[1]=t.ymax,Sw[0]=t.xmin,Sw[1]=t.ymin,Ew[0]=t.xmax,Ew[1]=t.ymin;for(const r of GIe)if(wpe(e,r))return!0;for(const r of e){if(!r.length)continue;let i=r[0];if(GS(t,i))return!0;for(let s=1;s<r.length;s++){const n=r[s];if(GS(t,n)||Tpe(i,n,xpe))return!0;i=n}}return!1}function qIe(t,e){xw[0]=t.xmin,xw[1]=t.ymax,Tw[0]=t.xmax,Tw[1]=t.ymax,Sw[0]=t.xmin,Sw[1]=t.ymin,Ew[0]=t.xmax,Ew[1]=t.ymin;const r=e.paths;for(const i of r){if(!r.length)continue;let s=i[0];if(GS(t,s))return!0;for(let n=1;n<i.length;n++){const o=i[n];if(GS(t,o)||Tpe(s,o,xpe))return!0;s=o}}return!1}const ko=[0,0];function WIe(t){for(let e=0;e<t.length;e++){const r=t[e];for(let s=0;s<r.length-1;s++){const n=r[s],o=r[s+1];for(let a=e+1;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){const c=t[a][l],h=t[a][l+1];if(ez(n,o,c,h,ko)&&!(ko[0]===n[0]&&ko[1]===n[1]||ko[0]===c[0]&&ko[1]===c[1]||ko[0]===o[0]&&ko[1]===o[1]||ko[0]===h[0]&&ko[1]===h[1]))return!0}}const i=r.length;if(!(i<=4))for(let s=0;s<i-3;s++){let n=i-1;s===0&&(n=i-2);const o=r[s],a=r[s+1];for(let l=s+2;l<n;l++){const c=r[l],h=r[l+1];if(ez(o,a,c,h,ko)&&!(ko[0]===o[0]&&ko[1]===o[1]||ko[0]===c[0]&&ko[1]===c[1]||ko[0]===a[0]&&ko[1]===a[1]||ko[0]===h[0]&&ko[1]===h[1]))return!0}}}return!1}function Tpe(t,e,r){for(let i=0;i<r.length;i++)if(ez(t,e,r[i][0],r[i][1]))return!0;return!1}function ez(t,e,r,i,s){const[n,o]=t,[a,l]=e,[c,h]=r,[p,f]=i,m=p-c,y=n-c,_=a-n,b=f-h,x=o-h,T=l-o,S=b*_-m*T;if(S===0)return!1;const E=(m*x-b*y)/S,O=(_*x-T*y)/S;return E>=0&&E<=1&&O>=0&&O<=1&&(s&&(s[0]=n+E*(a-n),s[1]=o+E*(l-o)),!0)}function XIe(t){switch(t){case"esriGeometryEnvelope":case"extent":return zIe;case"esriGeometryMultipoint":case"multipoint":return BIe;case"esriGeometryPoint":case"point":return kIe;case"esriGeometryPolygon":case"polygon":return jIe;case"esriGeometryPolyline":case"polyline":return qIe}}var nh;function YIe(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}function zy(t,e,r){return e==null?r:r==null?e:t(e,r)}let go=nh=class extends xv{constructor(...t){super(...t),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(t,e,r,i,s){return YIe(t)?{spatialReference:t,xmin:0,ymin:0,xmax:0,ymax:0}:typeof t=="object"?(t.spatialReference=t.spatialReference==null?We.WGS84:t.spatialReference,t):{xmin:t,ymin:e,xmax:r,ymax:i,spatialReference:s??We.WGS84}}static fromBounds(t,e){return new nh({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}static fromPoint(t){return new nh({xmin:t.x,ymin:t.y,zmin:t.z,xmax:t.x,ymax:t.y,zmax:t.z,spatialReference:t.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const t=new _t({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(t.z=.5*(this.zmin+this.zmax)),this.hasM&&(t.m=.5*(this.mmin+this.mmax)),t}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(t){const e=this.center;return t.z!=null&&this.hasZ?this.offset(t.x-e.x,t.y-e.y,t.z-e.z):this.offset(t.x-e.x,t.y-e.y)}clone(){const t=new nh;return t.xmin=this.xmin,t.ymin=this.ymin,t.xmax=this.xmax,t.ymax=this.ymax,t.spatialReference=this.spatialReference,this.zmin!=null&&(t.zmin=this.zmin,t.zmax=this.zmax),this.mmin!=null&&(t.mmin=this.mmin,t.mmax=this.mmax),t}contains(t){if(!t)return!1;const e=this.spatialReference,r=t.spatialReference;return e&&r&&!e.equals(r)&&k_(e,r)&&(t=e.isWebMercator?jg(t):L2(t,!0)),t.type==="point"?zW(this,t):t.type==="extent"&&DIe(this,t)}equals(t){if(this===t)return!0;if(C(t))return!1;const e=this.spatialReference,r=t.spatialReference;return e&&r&&!e.equals(r)&&k_(e,r)&&(t=e.isWebMercator?jg(t):L2(t,!0)),this.xmin===t.xmin&&this.ymin===t.ymin&&this.zmin===t.zmin&&this.mmin===t.mmin&&this.xmax===t.xmax&&this.ymax===t.ymax&&this.zmax===t.zmax&&this.mmax===t.mmax}expand(t){const e=.5*(1-t),r=this.width*e,i=this.height*e;if(this.xmin+=r,this.ymin+=i,this.xmax-=r,this.ymax-=i,this.hasZ){const s=(this.zmax-this.zmin)*e;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*e;this.mmin+=s,this.mmax-=s}return this}intersects(t){if(C(t))return!1;t.type==="mesh"&&(t=t.extent);const e=this.spatialReference,r=t.spatialReference;return e&&r&&!Cn(e,r)&&k_(e,r)&&(t=e.isWebMercator?jg(t):L2(t,!0)),XIe(t.type)(this,t)}normalize(){const t=this._normalize(!1,!0);return Array.isArray(t)?t:[t]}offset(t,e,r){return this.xmin+=t,this.ymin+=e,this.xmax+=t,this.ymax+=e,r!=null&&(this.zmin+=r,this.zmax+=r),this}shiftCentralMeridian(){return this._normalize(!0)}union(t){return this===t||(this.xmin=Math.min(this.xmin,t.xmin),this.ymin=Math.min(this.ymin,t.ymin),this.xmax=Math.max(this.xmax,t.xmax),this.ymax=Math.max(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=zy(Math.min,this.zmin,t.zmin),this.zmax=zy(Math.max,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=zy(Math.min,this.mmin,t.mmin),this.mmax=zy(Math.max,this.mmax,t.mmax))),this}intersection(t){return this===t?this:C(t)||!this.intersects(t)?null:(this.xmin=Math.max(this.xmin,t.xmin),this.ymin=Math.max(this.ymin,t.ymin),this.xmax=Math.min(this.xmax,t.xmax),this.ymax=Math.min(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=zy(Math.max,this.zmin,t.zmin),this.zmax=zy(Math.min,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=zy(Math.max,this.mmin,t.mmin),this.mmax=zy(Math.min,this.mmax,t.mmax)),this)}toJSON(t){return this.write({},t)}_shiftCM(t=V_(this.spatialReference)){if(!t||!this.spatialReference)return this;const e=this.spatialReference,r=this._getCM(t);if(r){const i=e.isWebMercator?L2(r):r;this.xmin-=r.x,this.xmax-=r.x,e.isWebMercator||(i.x=this._normalizeX(i.x,t).x),this.spatialReference=new We(om((e.isWGS84?t.altTemplate:null)??t.wkTemplate,{Central_Meridian:i.x}))}return this}_getCM(t){let e=null;const[r,i]=t.valid,s=this.xmin,n=this.xmax;return s>=r&&s<=i&&n>=r&&n<=i||(e=this.center),e}_normalize(t,e,r){const i=this.spatialReference;if(!i)return this;const s=r??V_(i);if(s==null)return this;const n=this._getParts(s).map(l=>l.extent);if(n.length<2)return n[0]||this;if(n.length>2)return t?this._shiftCM(s):this.set({xmin:s.valid[0],xmax:s.valid[1]});if(t)return this._shiftCM(s);if(e)return n;let o=!0,a=!0;return n.forEach(l=>{l.hasZ||(o=!1),l.hasM||(a=!1)}),{rings:n.map(l=>{const c=[[l.xmin,l.ymin],[l.xmin,l.ymax],[l.xmax,l.ymax],[l.xmax,l.ymin],[l.xmin,l.ymin]];if(o){const h=(l.zmax-l.zmin)/2;for(let p=0;p<c.length;p++)c[p].push(h)}if(a){const h=(l.mmax-l.mmin)/2;for(let p=0;p<c.length;p++)c[p].push(h)}return c}),hasZ:o,hasM:a,spatialReference:i}}_getParts(t){let e=this.cache._parts;if(!e){e=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;t=t||V_(o);const[p,f]=t.valid;h=this._normalizeX(this.xmin,t);const m=h.x,y=h.frameId;h=this._normalizeX(this.xmax,t);const _=h.x,b=h.frameId,x=m===_&&a>0;if(a>2*f){const T=new nh(l<c?m:_,s,f,n,o),S=new nh(p,s,l<c?_:m,n,o),E=new nh(0,s,f,n,o),O=new nh(p,s,0,n,o),R=[],L=[];T.contains(E)&&R.push(y),T.contains(O)&&L.push(y),S.contains(E)&&R.push(b),S.contains(O)&&L.push(b);for(let I=y+1;I<b;I++)R.push(I),L.push(I);e.push({extent:T,frameIds:[y]},{extent:S,frameIds:[b]},{extent:E,frameIds:R},{extent:O,frameIds:L})}else m>_||x?e.push({extent:new nh(m,s,f,n,o),frameIds:[y]},{extent:new nh(p,s,_,n,o),frameIds:[b]}):e.push({extent:new nh(m,s,_,n,o),frameIds:[y]});this.cache._parts=e}const r=this.hasZ,i=this.hasM;if(r||i){const s={};r&&(s.zmin=this.zmin,s.zmax=this.zmax),i&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<e.length;n++)e[n].extent.set(s)}return e}_normalizeX(t,e){const[r,i]=e.valid,s=2*i;let n,o=0;return t>i?(n=Math.ceil(Math.abs(t-i)/s),t-=n*s,o=n):t<r&&(n=Math.ceil(Math.abs(t-r)/s),t+=n*s,o=-n),{x:t,frameId:o}}};u([d({readOnly:!0})],go.prototype,"cache",null),u([d({readOnly:!0})],go.prototype,"center",null),u([d({readOnly:!0})],go.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],go.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],go.prototype,"hasZ",null),u([d({readOnly:!0})],go.prototype,"height",null),u([d({readOnly:!0})],go.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],go.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],go.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],go.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],go.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],go.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],go.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],go.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],go.prototype,"zmax",void 0),go=nh=u([P("esri.geometry.Extent")],go),go.prototype.toJSON.isDefaultToJSON=!0;const Hr=go;let aO;var dhe,phe;const ZIe=((dhe=globalThis.esriConfig)==null?void 0:dhe.locale)??((phe=globalThis.dojoConfig)==null?void 0:phe.locale);function Spe(){var t;return ZIe??((t=globalThis.navigator)==null?void 0:t.language)??"en"}function Vh(){return aO===void 0&&(aO=Spe()),aO}const lO=[];function Epe(t){return lO.push(t),{remove(){lO.splice(lO.indexOf(t),1)}}}const tz=[];function BW(t){return tz.push(t),{remove(){lO.splice(tz.indexOf(t),1)}}}function JIe(){const t=Spe();aO!==t&&(aO=t,[...tz].forEach(e=>{e.call(null,t)}),[...lO].forEach(e=>{e.call(null,t)}))}var fhe;(fhe=globalThis.addEventListener)==null||fhe.call(globalThis,"languagechange",JIe);var rz;const KIe=new Vr({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let oh=rz=class extends Te{constructor(t){super(t),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(t){t!=="asc"&&t!=="desc"||this._set("sortOrder",t)}clone(){return new rz({categories:this.categories?te(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(t,e){let r=[];this.categories&&(r=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o));let i="";if(this.extent){const o=ex(this.extent,We.WGS84);v(o)&&(i=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&t.extraQuery&&(s="("+s+")"+t.extraQuery);const n={categories:r,bbox:i,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>KIe.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:{...e,...n}}}};u([d()],oh.prototype,"categories",void 0),u([d()],oh.prototype,"disableExtraQuery",void 0),u([d({type:Hr})],oh.prototype,"extent",void 0),u([d()],oh.prototype,"filter",void 0),u([d()],oh.prototype,"num",void 0),u([d()],oh.prototype,"query",void 0),u([d()],oh.prototype,"sortField",void 0),u([d()],oh.prototype,"sortOrder",null),u([d()],oh.prototype,"start",void 0),oh=rz=u([P("esri.portal.PortalQueryParams")],oh);const Lg=oh;let T1=class extends Te{constructor(e){super(e),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],T1.prototype,"nextQueryParams",void 0),u([d()],T1.prototype,"queryParams",void 0),u([d()],T1.prototype,"results",void 0),u([d()],T1.prototype,"total",void 0),T1=u([P("esri.portal.PortalQueryResult")],T1);const QIe=T1;let rg=class extends fe{constructor(e){super(e),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new j("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],rg.prototype,"created",void 0),u([d()],rg.prototype,"id",void 0),u([d()],rg.prototype,"portal",void 0),u([d()],rg.prototype,"title",void 0),u([d({readOnly:!0})],rg.prototype,"url",null),u([d()],rg.prototype,"username",void 0),rg=u([P("esri.portal.PortalFolder")],rg);const e$e=rg;let yo=class extends fe{constructor(e){super(e),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){var i;const e=this.url,r=this.thumbnail;return e&&r&&this.portal?(i=this.portal)==null?void 0:i.normalizeUrl(`${e}/info/${r}?f=json`):null}get url(){const e=this.get("portal.restUrl");return e?e+"/community/groups/"+this.id:null}fetchCategorySchema(e){return Fl(this.portal).request(this.url+"/categorySchema",e).then(r=>{const i=r.categorySchema||[];return i.some(s=>s.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",e):i})}fetchMembers(e){return Fl(this.portal).request(this.url+"/users",e)}getThumbnailUrl(e){let r=this.thumbnailUrl;return r&&e&&(r+=`&w=${e}`),r}toJSON(){throw new j("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(e,r){let i=Ls(Lg,e);const s=Fl(this.portal);return parseFloat(s.currentVersion)>5?(i=i||new Lg,s.queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",r)):(i=i?i.clone():new Lg,i.query="group:"+this.id+(i.query?" "+i.query:""),s.queryItems(i,r))}_fetchCategorySchemaSet(e,r){const i=Fl(this.portal);return i.fetchSelf(i.authMode,!0,r).then(s=>{const n=s.contentCategorySetsGroupQuery;if(n){const o=new Lg;return o.disableExtraQuery=!0,o.num=1,o.query=n,i.queryGroups(o,r)}throw new j("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(s=>{if(s.total){const n=s.results[0],o=new Lg;return o.num=1,o.query=`typekeywords:"${e}"`,n.queryItems(o,r)}throw new j("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(s=>s.total?s.results[0].fetchData("json",r).then(n=>{const o=n&&n.categorySchema;return o&&o.length?o:[]}):[])}};u([d()],yo.prototype,"access",void 0),u([d({type:Date})],yo.prototype,"created",void 0),u([d()],yo.prototype,"description",void 0),u([d()],yo.prototype,"id",void 0),u([d()],yo.prototype,"isInvitationOnly",void 0),u([d({type:Date})],yo.prototype,"modified",void 0),u([d()],yo.prototype,"owner",void 0),u([d()],yo.prototype,"portal",void 0),u([d()],yo.prototype,"snippet",void 0),u([d()],yo.prototype,"sortField",void 0),u([d()],yo.prototype,"sortOrder",void 0),u([d()],yo.prototype,"tags",void 0),u([d()],yo.prototype,"thumbnail",void 0),u([d({readOnly:!0})],yo.prototype,"thumbnailUrl",null),u([d()],yo.prototype,"title",void 0),u([d({readOnly:!0})],yo.prototype,"url",null),yo=u([P("esri.portal.PortalGroup")],yo);const iz=yo,t$e=Object.freeze(Object.defineProperty({__proto__:null,default:iz},Symbol.toStringTag,{value:"Module"}));var sz;let Cs=sz=class extends fe{constructor(...t){super(...t),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const t=this.url,e=this.thumbnail;return t&&e?this.portal.normalizeUrl(`${t}/info/${e}?f=json`):null}get userContentUrl(){const t=this.get("portal.restUrl");return t?`${t}/content/users/${this.username}`:null}get url(){const t=this.get("portal.restUrl");return t?`${t}/community/users/${this.username}`:null}addItem(t){const e=t&&t.item,r=t&&t.data,i=t&&t.folder,s={method:"post"};e&&(s.query=e.createPostQuery(),r!=null&&(typeof r=="string"?s.query.text=r:typeof r=="object"&&(s.query.text=JSON.stringify(r))));let n=this.userContentUrl;return i&&(n+="/"+(typeof i=="string"?i:i.id)),this.portal.request(n+"/addItem",s).then(o=>(e.id=o.id,e.portal=this.portal,e.loaded?e.reload():e.load()))}deleteItem(t){let e=this.userContentUrl;return t.ownerFolder&&(e+="/"+t.ownerFolder),this.portal.request(e+`/items/${t.id}/delete`,{method:"post"}).then(()=>{t.id=null,t.portal=null})}deleteItems(t){const e=this.userContentUrl+"/deleteItems",r=t.map(i=>i.id);if(r.length){const i={method:"post",query:{items:r.join(",")}};return this.portal.request(e,i).then(()=>{t.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const t={query:{num:1}};return this.portal.request(this.userContentUrl??"",t).then(e=>{let r;return r=e&&e.folders?e.folders.map(i=>{const s=e$e.fromJSON(i);return s.portal=this.portal,s}):[],r})}fetchGroups(){return this.portal.request(this.url??"").then(t=>{let e;return e=t&&t.groups?t.groups.map(r=>{const i=iz.fromJSON(r);return i.portal=this.portal,i}):[],e})}fetchItems(t){const e=t??{};let r,i=this.userContentUrl??"";return e.folder&&(i+="/"+e.folder.id),ie(()=>Promise.resolve().then(()=>Cpe),void 0,import.meta.url).then(({default:s})=>{r=s;const n={folders:!1,num:e.num||10,start:e.start||1,sortField:e.sortField||"created",sortOrder:e.sortOrder||"asc"};return this.portal.request(i,{query:n})}).then(s=>{let n;return s&&s.items?(n=s.items.map(o=>{const a=r.fromJSON(o);return a.portal=this.portal,a}),Promise.all(n.map(o=>o.load())).catch(o=>o).then(()=>({items:n,nextStart:s.nextStart,total:s.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal.request(this.url+"/tags").then(t=>t.tags)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}queryFavorites(t){return this.favGroupId?(this._favGroup||(this._favGroup=new iz({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(t)):Promise.reject(new j("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new j("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const e=new sz;return e.sourceJSON=t,e.read(t),e}};u([d()],Cs.prototype,"access",void 0),u([d({type:Date})],Cs.prototype,"created",void 0),u([d()],Cs.prototype,"culture",void 0),u([d()],Cs.prototype,"description",void 0),u([d()],Cs.prototype,"email",void 0),u([d()],Cs.prototype,"favGroupId",void 0),u([d()],Cs.prototype,"fullName",void 0),u([d({type:Date})],Cs.prototype,"modified",void 0),u([d()],Cs.prototype,"orgId",void 0),u([d()],Cs.prototype,"portal",void 0),u([d()],Cs.prototype,"preferredView",void 0),u([d()],Cs.prototype,"privileges",void 0),u([d()],Cs.prototype,"region",void 0),u([d()],Cs.prototype,"role",void 0),u([d()],Cs.prototype,"roleId",void 0),u([d()],Cs.prototype,"sourceJSON",void 0),u([d()],Cs.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Cs.prototype,"thumbnailUrl",null),u([d()],Cs.prototype,"units",void 0),u([d({readOnly:!0})],Cs.prototype,"userContentUrl",null),u([d({readOnly:!0})],Cs.prototype,"url",null),u([d()],Cs.prototype,"username",void 0),u([d()],Cs.prototype,"userType",void 0),Cs=sz=u([P("esri.portal.PortalUser")],Cs);const GW=Cs,r$e=Object.freeze(Object.defineProperty({__proto__:null,default:GW},Symbol.toStringTag,{value:"Module"}));var ru;let gU;const JQ={PortalGroup:()=>ie(()=>Promise.resolve().then(()=>t$e),void 0,import.meta.url),PortalItem:()=>ie(()=>Promise.resolve().then(()=>Cpe),void 0,import.meta.url),PortalUser:()=>ie(()=>Promise.resolve().then(()=>r$e),void 0,import.meta.url)};let Ge=ru=class extends TM(cm){constructor(t){super(t),this._esriIdCredentialCreateHandle=null,this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=Qr.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(t){return typeof t=="string"?{url:t}:t}destroy(){this._esriIdCredentialCreateHandle=Vi(this._esriIdCredentialCreateHandle)}readAuthorizedCrossOriginDomains(t){if(t)for(const e of t)Qr.request.trustedServers.includes(e)||Qr.request.trustedServers.push(e);return t}readDefaultBasemap(t){return this._readBasemap(t)}readDefaultDevBasemap(t){return this._readBasemap(t)}readDefaultVectorBasemap(t){return this._readBasemap(t)}get extraQuery(){const t=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!t?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get itemPageUrl(){return this.url?`${this.url}/home/item.html`:null}get restUrl(){let t=this.url;if(t){const e=t.indexOf("/sharing");t=e>0?t.substring(0,e):this.url.replace(/\/+$/,""),t+="/sharing/rest"}return t}get thumbnailUrl(){const t=this.restUrl,e=this.thumbnail;return t&&e?this._normalizeSSL(t+"/portals/self/resources/"+e):null}readUrlKey(t){return t&&t.toLowerCase()}readUser(t){let e=null;return t&&(e=GW.fromJSON(t),e.portal=this),e}load(t){const e=ie(()=>Promise.resolve().then(()=>E$e),void 0,import.meta.url).then(({default:r})=>{ur(t),gU=r}).then(()=>this.sourceJSON?this.sourceJSON:this.fetchSelf(this.authMode,!1,t)).then(r=>{if(xi){const i=xi;this.credential=i.findCredential(this.restUrl),this.credential||this.authMode!==ru.AUTH_MODE_AUTO||(this._esriIdCredentialCreateHandle=i.on("credential-create",()=>{i.findCredential(this.restUrl)&&this.signIn().catch(()=>{})}))}this.sourceJSON=r,this.read(r)});return this.addResolvingPromise(e),Promise.resolve(this)}async createElevationLayers(){await this.load();const t=this._getHelperService("defaultElevationLayers"),e=(await ie(()=>import("./ElevationLayer-f600c98c.js"),["./ElevationLayer-f600c98c.js","./ArcGISCachedService-219a1636.js","./TilemapCache-30000c82.js"],import.meta.url)).default;return t?t.map(r=>new e({id:r.id,url:r.url})):[]}fetchBasemaps(t,e){const r=new Lg;return r.query=t||(Qr.apiKey&&ype(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),r.disableExtraQuery=!0,this.queryGroups(r,e).then(i=>{if(r.num=100,r.query='type:"Web Map" -type:"Web Application"',i.total){const s=i.results[0];return r.sortField=s.sortField||"name",r.sortOrder=s.sortOrder||"desc",s.queryItems(r,e)}return null}).then(i=>{let s;return s=i&&i.total?i.results.filter(n=>n.type==="Web Map").map(n=>new gU({portalItem:n})):[],s})}fetchCategorySchema(t){return this.hasCategorySchema?this.request(this.restUrl+"/portals/self/categorySchema",t).then(e=>e.categorySchema):Fn(t)?Promise.reject(qr()):Promise.resolve([])}fetchFeaturedGroups(t){const e=this.featuredGroups,r=new Lg;if(r.num=100,r.sortField="title",e&&e.length){const i=[];for(const s of e)i.push(`(title:"${s.title}" AND owner:${s.owner})`);return r.query=i.join(" OR "),this.queryGroups(r,t).then(s=>s.results)}return Fn(t)?Promise.reject(qr()):Promise.resolve([])}fetchRegions(t){var r;const e=((r=this.user)==null?void 0:r.culture)||this.culture||Vh();return this.request(this.restUrl+"/portals/regions",{...t,query:{culture:e}})}fetchSettings(t){var r;const e=((r=this.user)==null?void 0:r.culture)||this.culture||Vh();return this.request(this.restUrl+"/portals/self/settings",{...t,query:{culture:e}})}static getDefault(){return ru._default&&!ru._default.destroyed||(ru._default=new ru),ru._default}queryGroups(t,e){return this.queryPortal("/community/groups",t,"PortalGroup",e)}queryItems(t,e){return this.queryPortal("/search",t,"PortalItem",e)}queryUsers(t,e){return t.sortField||(t.sortField="username"),this.queryPortal("/community/users",t,"PortalUser",e)}fetchSelf(t=this.authMode,e=!1,r){const i=this.restUrl+"/portals/self",s={authMode:t,query:{culture:Vh().toLowerCase()},...r};return s.authMode==="auto"&&(s.authMode="no-prompt"),e&&(s.query.default=!0),this.request(i,s)}queryPortal(t,e,r,i){const s=Ls(Lg,e),n=o=>this.request(this.restUrl+t,{...s.toRequestOptions(this),...i}).then(a=>{const l=s.clone();return l.start=a.nextStart,new QIe({nextQueryParams:l,queryParams:s,total:a.total,results:ru._resultsToTypedArray(o,{portal:this},a,i)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(Sc(l),a)));return r&&JQ[r]?JQ[r]().then(({default:o})=>(ur(i),n(o))):n()}signIn(){if(this.authMode===ru.AUTH_MODE_ANONYMOUS)return Promise.reject(new j("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const t=e=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(e||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=e,this.fetchSelf("immediate"))):this.user&&this.credential===e?null:(this.credential=e,this.fetchSelf("immediate"))).then(r=>{r&&(this.sourceJSON=r,this.read(r))});return xi?xi.getCredential(this.restUrl).then(e=>t(e)):t(this.credential)}normalizeUrl(t){const e=this.credential&&this.credential.token;return this._normalizeSSL(e?t+(t.includes("?")?"&":"?")+"token="+e:t)}requestToTypedArray(t,e,r){return this.request(t,e).then(i=>{const s=ru._resultsToTypedArray(r,{portal:this},i);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():i)).then(()=>s,()=>s)})}request(t,e={}){const r={f:"json",...e.query},{authMode:i=this.authMode===ru.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=e,c={authMode:i,body:s,cacheBust:n,method:o,query:r,responseType:a,timeout:0,signal:l};return Pi(this._normalizeSSL(t),c).then(h=>h.data)}toJSON(){throw new j("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new ru({sourceJSON:t})}_getHelperService(t){const e=this.helperServices&&this.helperServices[t];if(!e)throw new j("portal:service-not-found",`The \`helperServices\` do not include an entry named "${t}"`);return e}_normalizeSSL(t){return t.replace(/^http:/i,"https:").replace(":7080",":7443")}_readBasemap(t){if(t){const e=gU.fromJSON(t);return e.portalItem={portal:this},e}return null}static _resultsToTypedArray(t,e,r,i){let s=[];if(r){const n=v(i)?i.signal:null;s=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(t||e)&&(s=s.map(o=>{const a=Object.assign(t?t.fromJSON(o):o,e);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};Ge.AUTH_MODE_ANONYMOUS="anonymous",Ge.AUTH_MODE_AUTO="auto",Ge.AUTH_MODE_IMMEDIATE="immediate",u([d()],Ge.prototype,"access",void 0),u([d()],Ge.prototype,"allSSL",void 0),u([d()],Ge.prototype,"authMode",void 0),u([d()],Ge.prototype,"authorizedCrossOriginDomains",void 0),u([Le("authorizedCrossOriginDomains")],Ge.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],Ge.prototype,"basemapGalleryGroupQuery",void 0),u([d()],Ge.prototype,"bingKey",void 0),u([d()],Ge.prototype,"canListApps",void 0),u([d()],Ge.prototype,"canListData",void 0),u([d()],Ge.prototype,"canListPreProvisionedItems",void 0),u([d()],Ge.prototype,"canProvisionDirectPurchase",void 0),u([d()],Ge.prototype,"canSearchPublic",void 0),u([d()],Ge.prototype,"canShareBingPublic",void 0),u([d()],Ge.prototype,"canSharePublic",void 0),u([d()],Ge.prototype,"canSignInArcGIS",void 0),u([d()],Ge.prototype,"canSignInIDP",void 0),u([d()],Ge.prototype,"colorSetsGroupQuery",void 0),u([d()],Ge.prototype,"commentsEnabled",void 0),u([d({type:Date})],Ge.prototype,"created",void 0),u([d()],Ge.prototype,"credential",void 0),u([d()],Ge.prototype,"culture",void 0),u([d()],Ge.prototype,"currentVersion",void 0),u([d()],Ge.prototype,"customBaseUrl",void 0),u([d()],Ge.prototype,"defaultBasemap",void 0),u([Le("defaultBasemap")],Ge.prototype,"readDefaultBasemap",null),u([d()],Ge.prototype,"defaultDevBasemap",void 0),u([Le("defaultDevBasemap")],Ge.prototype,"readDefaultDevBasemap",null),u([d({type:Hr})],Ge.prototype,"defaultExtent",void 0),u([d()],Ge.prototype,"defaultVectorBasemap",void 0),u([Le("defaultVectorBasemap")],Ge.prototype,"readDefaultVectorBasemap",null),u([d()],Ge.prototype,"description",void 0),u([d()],Ge.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],Ge.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],Ge.prototype,"extraQuery",null),u([d()],Ge.prototype,"featuredGroups",void 0),u([d()],Ge.prototype,"featuredItemsGroupQuery",void 0),u([d()],Ge.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],Ge.prototype,"livingAtlasGroupQuery",void 0),u([d()],Ge.prototype,"hasCategorySchema",void 0),u([d()],Ge.prototype,"helpBase",void 0),u([d()],Ge.prototype,"helperServices",void 0),u([d()],Ge.prototype,"helpMap",void 0),u([d()],Ge.prototype,"homePageFeaturedContent",void 0),u([d()],Ge.prototype,"homePageFeaturedContentCount",void 0),u([d()],Ge.prototype,"httpPort",void 0),u([d()],Ge.prototype,"httpsPort",void 0),u([d()],Ge.prototype,"id",void 0),u([d()],Ge.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],Ge.prototype,"isOrganization",null),u([d()],Ge.prototype,"isPortal",void 0),u([d()],Ge.prototype,"isReadOnly",void 0),u([d({readOnly:!0})],Ge.prototype,"itemPageUrl",null),u([d()],Ge.prototype,"layerTemplatesGroupQuery",void 0),u([d()],Ge.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],Ge.prototype,"modified",void 0),u([d()],Ge.prototype,"name",void 0),u([d()],Ge.prototype,"portalHostname",void 0),u([d()],Ge.prototype,"portalMode",void 0),u([d()],Ge.prototype,"portalProperties",void 0),u([d()],Ge.prototype,"region",void 0),u([d({readOnly:!0})],Ge.prototype,"restUrl",null),u([d()],Ge.prototype,"rotatorPanels",void 0),u([d()],Ge.prototype,"showHomePageDescription",void 0),u([d()],Ge.prototype,"sourceJSON",void 0),u([d()],Ge.prototype,"staticImagesUrl",void 0),u([d({json:{name:"2DStylesGroupQuery"}})],Ge.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],Ge.prototype,"stylesGroupQuery3d",void 0),u([d()],Ge.prototype,"supportsHostedServices",void 0),u([d()],Ge.prototype,"symbolSetsGroupQuery",void 0),u([d()],Ge.prototype,"templatesGroupQuery",void 0),u([d()],Ge.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Ge.prototype,"thumbnailUrl",null),u([d()],Ge.prototype,"units",void 0),u([d()],Ge.prototype,"url",void 0),u([d()],Ge.prototype,"urlKey",void 0),u([Le("urlKey")],Ge.prototype,"readUrlKey",null),u([d()],Ge.prototype,"user",void 0),u([Le("user")],Ge.prototype,"readUser",null),u([d()],Ge.prototype,"useStandardizedQuery",void 0),u([d()],Ge.prototype,"useVectorBasemaps",void 0),u([d()],Ge.prototype,"vectorBasemapGalleryGroupQuery",void 0),Ge=ru=u([P("esri.portal.Portal")],Ge);const Io=Ge,i$e=se.getLogger("esri.assets");function s$e(t,e){return Pi(Kr(t),e)}function Kr(t){if(!Qr.assetsPath)throw i$e.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new j("assets:path-not-set","config.assetsPath is not set");return Nu(Qr.assetsPath,t)}let S0=class extends Te{constructor(e){super(e),this.portalItem=null}normalizeCtorArgs(e){return e&&e.portalItem&&e.path?{...e,path:this._normalizePath(e.path,e.portalItem)}:e}set path(e){v(e)&&Mu(e)?se.getLogger(this.declaredClass).error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}_castPath(e){return this._normalizePath(e,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(e="json",r){const i=this.url;if(C(i))throw new j("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal.request(i,{responseType:e,query:{token:this.portalItem.apiKey},signal:Js(r,"signal")})}async update(e,r){return(await ie(()=>Promise.resolve().then(()=>NA),void 0,import.meta.url)).addOrUpdateResource(this,"update",e,r)}hasPath(){return v(this.path)}_normalizePath(e,r){return C(e)?e:(e=e.replace(/^\/+/,""),v(r)&&Mu(e)&&(e=uW(e,r.itemUrl)),e==null?void 0:e.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],S0.prototype,"portalItem",void 0),u([d({type:String,value:null})],S0.prototype,"path",null),u([Gt("path")],S0.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],S0.prototype,"url",null),u([d({type:String,readOnly:!0})],S0.prototype,"itemRelativeUrl",null),S0=u([P("esri.portal.PortalItemResource")],S0);const n$e=S0;let IA=class extends Te{constructor(e){super(e),this.created=null,this.rating=null}};u([d()],IA.prototype,"created",void 0),u([d()],IA.prototype,"rating",void 0),IA=u([P("esri.portal.PortalRating")],IA);const yU=IA;var S1;const o$e=new Set(["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","GeoJson","CSV","KML","WFS","WMTS","WMS","Feed"]),a$e=new Set(["KML","GeoJson","CSV"]);let yr=S1=class extends TM(cm){static from(t){return zS(S1,t)}constructor(t){super(t),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.isOrgItem=!1,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.sourceUrl=null,this.spatialReference=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}destroy(){this.portal=null}get displayName(){const t=this.type,e=this.typeKeywords||[];let r=t;return t==="Feature Service"||t==="Feature Collection"?r=e.includes("Table")?"Table":e.includes("Route Layer")?"Route Layer":e.includes("Markup")?"Markup":"Feature Layer":t==="Image Service"?r=e.includes("Elevation 3D Layer")?"Elevation Layer":e.includes("Tiled Imagery")?"Tiled Imagery Layer":"Imagery Layer":t==="Scene Service"?r="Scene Layer":t==="Video Service"?r="Video Layer":t==="Scene Package"?r="Scene Layer Package":t==="Stream Service"?r="Feature Layer":t==="Geoprocessing Service"&&this.portal&&this.portal.isPortal?r=e.includes("Web Tool")?"Tool":"Geoprocessing Service":t==="Geocoding Service"?r="Locator":t==="Geoenrichment Service"?r="GeoEnrichment Service":t==="Microsoft Powerpoint"?r="Microsoft PowerPoint":t==="GeoJson"?r="GeoJSON":t==="Globe Service"?r="Globe Layer":t==="Vector Tile Service"?r="Tile Layer":t==="netCDF"?r="NetCDF":t==="Map Service"?r=e.includes("Spatiotemporal")||!e.includes("Hosted Service")&&!e.includes("Tiled")||e.includes("Relational")?"Map Image Layer":"Tile Layer":t&&t.toLowerCase().includes("add in")?r=t.replace(/(add in)/gi,"Add-In"):t==="datastore catalog service"?r="Big Data File Share":t==="Compact Tile Package"?r="Tile Package (tpkx)":t==="OGCFeatureServer"?r="OGC Feature Layer":t==="web mapping application"&&e.includes("configurableApp")?r="Instant App":t==="Insights Page"&&(r="Insights Report"),r}readExtent(t){return t&&t.length?new Hr(t[0][0],t[0][1],t[1][0],t[1][1]):null}get iconUrl(){const t=this.type&&this.type.toLowerCase()||"",e=this.typeKeywords||[],r="esri/images/portal/",i="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return t.indexOf("service")>0||t==="feature collection"||t==="kml"||t==="wms"||t==="wmts"||t==="wfs"?(n=e.includes("Hosted Service"),t==="feature service"||t==="feature collection"||t==="kml"||t==="wfs"?(o=e.includes("Table"),a=e.includes("Route Layer"),l=e.includes("Markup"),c=e.includes("Spatiotemporal"),h=e.includes("UtilityNetwork"),s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=t==="map service"||t==="wms"||t==="wmts"?n||e.includes("Tiled")||t==="wmts"?"maptiles":"mapimages":t==="scene service"?e.includes("Line")?"sceneweblayerline":e.includes("3DObject")?"sceneweblayermultipatch":e.includes("Point")?"sceneweblayerpoint":e.includes("IntegratedMesh")?"sceneweblayermesh":e.includes("PointCloud")?"sceneweblayerpointcloud":e.includes("Polygon")?"sceneweblayerpolygon":e.includes("Building")?"sceneweblayerbuilding":e.includes("Voxel")?"sceneweblayervoxel":"sceneweblayer":t==="image service"?e.includes("Elevation 3D Layer")?"elevationlayer":e.includes("Tiled Imagery")?"tiledimagerylayer":"imagery":t==="stream service"?"streamlayer":t==="video service"?"mediaservice":t==="vector tile service"?"vectortile":t==="datastore catalog service"?"datastorecollection":t==="geocoding service"?"geocodeservice":t==="geoprocessing service"?e.includes("Web Tool")&&this.portal&&this.portal.isPortal?"tool":"layers":t==="geodata service"?"geodataservice":"layers"):s=t==="web map"||t==="cityengine web scene"?"maps":t==="web scene"?e.includes("ViewingMode-Local")?"webscenelocal":"websceneglobal":t==="web mapping application"&&e.includes("configurableApp")?"instantapps":t==="web mapping application"||t==="mobile application"||t==="application"||t==="operation view"||t==="desktop application"?"apps":t==="map document"||t==="map package"||t==="published map"||t==="scene document"||t==="globe document"||t==="basemap package"||t==="mobile basemap package"||t==="mobile map package"||t==="project package"||t==="project template"||t==="pro map"||t==="layout"||t==="layer"&&e.includes("ArcGIS Pro")||t==="explorer map"&&e.indexOf("Explorer Document")?"mapsgray":t==="service definition"||t==="csv"||t==="shapefile"||t==="cad drawing"||t==="geojson"||t==="360 vr experience"||t==="netcdf"||t==="administrative report"?"datafiles":t==="explorer add in"||t==="desktop add in"||t==="windows viewer add in"||t==="windows viewer configuration"?"appsgray":t==="arcgis pro add in"||t==="arcgis pro configuration"?"addindesktop":t==="rule package"||t==="file geodatabase"||t==="sqlite geodatabase"||t==="csv collection"||t==="kml collection"||t==="windows mobile package"||t==="map template"||t==="desktop application template"||t==="gml"||t==="arcpad package"||t==="code sample"||t==="form"||t==="document link"||t==="earth configuration"||t==="operations dashboard add in"||t==="rules package"||t==="image"||t==="workflow manager package"||t==="explorer map"&&e.includes("Explorer Mapping Application")||e.includes("Document")?"datafilesgray":t==="network analysis service"||t==="geoprocessing service"||t==="geodata service"||t==="geometry service"||t==="geoprocessing package"||t==="locator package"||t==="geoprocessing sample"||t==="workflow manager service"?"toolsgray":t==="layer"||t==="layer package"||t==="explorer layer"?"layersgray":t==="scene package"?"scenepackage":t==="mobile scene package"?"mobilescenepackage":t==="tile package"||t==="compact tile package"?"tilepackage":t==="task file"?"taskfile":t==="report template"?"report-template":t==="statistical data collection"?"statisticaldatacollection":t==="insights workbook"?"workbook":t==="insights model"?"insightsmodel":t==="insights page"?"insightspage":t==="insights theme"?"insightstheme":t==="hub initiative"?"hubinitiative":t==="hubpage"?"hubpage":t==="hub event"?"hubevent":t==="hub site application"?"hubsite":t==="hub project"?"hubproject":t==="relational database connection"?"relationaldatabaseconnection":t==="big data file share"?"datastorecollection":t==="image collection"?"imagecollection":t==="style"?"style":t==="desktop style"?"desktopstyle":t==="dashboard"?"dashboard":t==="raster function template"?"rasterprocessingtemplate":t==="vector tile package"?"vectortilepackage":t==="ortho mapping project"?"orthomappingproject":t==="ortho mapping template"?"orthomappingtemplate":t==="solution"?"solutions":t==="geopackage"?"geopackage":t==="deep learning package"?"deeplearningpackage":t==="real time analytic"?"realtimeanalytics":t==="big data analytic"?"bigdataanalytics":t==="feed"?"feed":t==="excalibur imagery project"?"excaliburimageryproject":t==="notebook"?"notebook":t==="storymap"?"storymap":t==="survey123 add in"?"survey123addin":t==="mission"?"mission":t==="mission report"?"missionreport":t==="quickcapture project"?"quickcaptureproject":t==="pro report"?"proreport":t==="pro report template"?"proreporttemplate":t==="urban model"?"urbanmodel":t==="web experience"?"experiencebuilder":t==="web experience template"?"webexperiencetemplate":t==="experience builder widget"?"experiencebuilderwidget":t==="experience builder widget package"?"experiencebuilderwidgetpackage":t==="workflow"?"workflow":t==="insights script"?"insightsscript":t==="kernel gateway connection"?"kernelgatewayconnection":t==="hub initiative template"?"hubinitiativetemplate":t==="storymap theme"?"storymaptheme":t==="knowledge graph"?"knowledgegraph":t==="native application"?"nativeapp":t==="native application installer"?"nativeappinstaller":t==="link chart"?"linkchart":t==="investigation"?"investigation":t==="ogcfeatureserver"?"features":t==="pro project"?"proproject":t==="insights workbook package"?"insightsworkbookpackage":t==="apache parquet"?"apacheparquet":t==="notebook code snippets"||t==="notebook code snippet library"?"notebookcodesnippets":t==="suitability model"?"suitabilitymodel":t==="esri classifier definition"?"classifierdefinition":t==="esri classification schema"?"classificationschema":t==="insights data engineering workbook"?"dataengineeringworkbook":t==="insights data engineering model"?"dataengineeringmodel":t==="deep learning studio project"?"deeplearningproject":t==="discussion"?"discussion":t==="allsource project"?"allsourceproject":t==="api key"?"apikey":"maps",s?Kr(r+s+i+".png"):null}get isLayer(){return this.type!=null&&o$e.has(this.type)}get itemPageUrl(){var e;const t=(e=this.portal)==null?void 0:e.itemPageUrl;return t&&this.id?`${t}?id=${this.id}`:null}get itemUrl(){var e;const t=(e=this.portal)==null?void 0:e.restUrl;return t&&this.id?`${t}/content/items/${this.id}`:null}get thumbnailUrl(){var r;const t=this.itemUrl,e=this.thumbnail;return t&&e?((r=this.portal)==null?void 0:r.normalizeUrl(`${t}/info/${e}?f=json`))??null:null}get userItemUrl(){const t=this.get("portal.restUrl");if(!t)return null;const e=this.owner||this.get("portal.user.username");return e?`${t}/content/users/${this.ownerFolder?`${e}/${this.ownerFolder}`:e}/items/${this.id}`:null}load(t){const e=this.portal??(this.portal=Io.getDefault()),r=e.load(t).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?e.request(this.itemUrl,{signal:v(t)?t.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(r),Promise.resolve(this)}async addRating(t){const e={method:"post",query:{}};return t instanceof yU&&(t=t.rating),t==null||isNaN(t)||typeof t!="number"||(e.query.rating=t),this.portal?(await this.portal.request(this.itemUrl+"/addRating",e),new yU({rating:t,created:new Date})):null}clone(){const t={access:this.access,accessInformation:this.accessInformation,applicationProxies:te(this.applicationProxies),avgRating:this.avgRating,categories:te(this.categories),created:te(this.created),culture:this.culture,description:this.description,extent:te(this.extent),groupCategories:te(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:te(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:te(this.screenshots),size:this.size,snippet:this.snippet,sourceUrl:this.sourceUrl,spatialReference:this.spatialReference,tags:te(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:te(this.typeKeywords),url:this.url};this.loaded&&(t.loadStatus="loaded");const e=new S1({sourceJSON:this.sourceJSON}).set(t);return e._set("isOrgItem",this.isOrgItem),e}createPostQuery(){const t=this.toJSON();for(const r of["tags","typeKeywords","categories"])t[r]&&(t[r]=t[r].join(", "));const{extent:e}=t;return e&&(t.extent=JSON.stringify(e)),t}async deleteRating(){await Fl(this.portal).request(this.itemUrl+"/deleteRating",{method:"post"})}fetchData(t="json",e){return Fl(this.portal).request(this.itemUrl+"/data",{responseType:t,...e,query:{token:this.apiKey}})}async fetchRating(t){const e=await Fl(this.portal).request(this.itemUrl+"/rating",{query:{token:this.apiKey},...t});return e.rating!=null?(e.created=new Date(e.created),new yU(e)):null}fetchRelatedItems(t,e){return Fl(this.portal).requestToTypedArray(this.itemUrl+"/relatedItems",{query:{...t,token:this.apiKey},...e},S1)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}reload(){return Fl(this.portal).request(this.itemUrl??"",{cacheBust:!0,query:{token:this.apiKey}}).then(t=>(this.sourceJSON=t,this.read(t),this))}update(t){return this.id?this.load().then(()=>Fl(this.portal).signIn()).then(()=>{const e=t&&t.data,r={method:"post"};r.query=this.createPostQuery();for(const i in r.query)r.query[i]===null&&(r.query[i]="");return r.query.clearEmptyFields=!0,e!=null&&(typeof e=="string"?r.query.text=e:typeof e=="object"&&(r.query.text=JSON.stringify(e))),this.portal.request(`${this.userItemUrl}/update`,r).then(()=>this.reload())}):Promise.reject(new j("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async copy(t){if(!this.id)throw new j("portal:item-does-not-exist","The item does not exist yet");await this.load();const{portal:e,itemUrl:r}=this;await Fl(e).signIn();const{copyResources:i,folder:s,tags:n,title:o}=t||{},a={method:"post",query:{copyPrivateResources:i==="all",folder:typeof s=="string"?s:s==null?void 0:s.id,includeResources:!!i,tags:n==null?void 0:n.join(","),title:o}},{itemId:l}=await e.request(`${r}/copy`,a);return new S1({id:l,portal:e})}updateThumbnail(t){return this.id?this.load().then(()=>this.portal.signIn()).then(()=>{const e=t.thumbnail,r=t.filename,i={method:"post"};if(typeof e=="string")bm(e)?i.query={data:e}:i.query={url:Eu(e)},v(r)&&(i.query.filename=r);else{const s=new FormData;v(r)?s.append("file",e,r):s.append("file",e),i.body=s}return this.portal.request(`${this.userItemUrl}/updateThumbnail`,i).then(()=>this.reload())}):Promise.reject(new j("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(t={},e){return(await ie(()=>Promise.resolve().then(()=>NA),void 0,import.meta.url)).fetchResources(this,t,e)}async addResource(t,e,r){const i=await ie(()=>Promise.resolve().then(()=>NA),void 0,import.meta.url);return t.portalItem=this,i.addOrUpdateResource(t,"add",e,r)}async removeResource(t,e){const r=await ie(()=>Promise.resolve().then(()=>NA),void 0,import.meta.url);if(t.portalItem&&t.portalItem.itemUrl!==this.itemUrl)throw new j("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return r.removeResource(this,t,e)}async removeAllResources(t){return(await ie(()=>Promise.resolve().then(()=>NA),void 0,import.meta.url)).removeAllResources(this,t)}resourceFromPath(t){return new n$e({portalItem:this,path:t})}toJSON(){const t=this.extent,e={accessInformation:this.accessInformation,categories:te(this.categories),created:this.created&&this.created.getTime(),description:this.description,extent:t&&[[t.xmin,t.ymin],[t.xmax,t.ymax]],id:this.id,isOrgItem:this.isOrgItem,licenseInfo:this.licenseInfo,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,sourceUrl:this.sourceUrl,spatialReference:this.spatialReference,tags:te(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:te(this.typeKeywords),url:this.url};return Nhe(e)}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new S1({sourceJSON:t})}_getPostQuery(){const t=this.toJSON();for(const e in t)e==="tags"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="typeKeywords"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="extent"&&t[e]&&(t[e]=JSON.stringify(t[e]));return t}};u([d({type:["private","shared","org","public"]})],yr.prototype,"access",void 0),u([d()],yr.prototype,"accessInformation",void 0),u([d({type:String})],yr.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],yr.prototype,"applicationProxies",void 0),u([d()],yr.prototype,"avgRating",void 0),u([d()],yr.prototype,"categories",void 0),u([d({type:Date})],yr.prototype,"created",void 0),u([d()],yr.prototype,"culture",void 0),u([d()],yr.prototype,"description",void 0),u([d({readOnly:!0})],yr.prototype,"displayName",null),u([d({type:Hr})],yr.prototype,"extent",void 0),u([Le("extent")],yr.prototype,"readExtent",null),u([d()],yr.prototype,"groupCategories",void 0),u([d({readOnly:!0})],yr.prototype,"iconUrl",null),u([d()],yr.prototype,"id",void 0),u([d({readOnly:!0})],yr.prototype,"isLayer",null),u([d({type:Boolean,readOnly:!0})],yr.prototype,"isOrgItem",void 0),u([d()],yr.prototype,"itemControl",void 0),u([d({readOnly:!0})],yr.prototype,"itemPageUrl",null),u([d({readOnly:!0})],yr.prototype,"itemUrl",null),u([d()],yr.prototype,"licenseInfo",void 0),u([d({type:Date})],yr.prototype,"modified",void 0),u([d()],yr.prototype,"name",void 0),u([d()],yr.prototype,"numComments",void 0),u([d()],yr.prototype,"numRatings",void 0),u([d()],yr.prototype,"numViews",void 0),u([d()],yr.prototype,"owner",void 0),u([d()],yr.prototype,"ownerFolder",void 0),u([d({type:Io})],yr.prototype,"portal",void 0),u([d()],yr.prototype,"screenshots",void 0),u([d()],yr.prototype,"size",void 0),u([d()],yr.prototype,"snippet",void 0),u([d()],yr.prototype,"sourceJSON",void 0),u([d({type:String})],yr.prototype,"sourceUrl",void 0),u([d({type:String})],yr.prototype,"spatialReference",void 0),u([d()],yr.prototype,"tags",void 0),u([d()],yr.prototype,"thumbnail",void 0),u([d({readOnly:!0})],yr.prototype,"thumbnailUrl",null),u([d()],yr.prototype,"title",void 0),u([d()],yr.prototype,"type",void 0),u([d()],yr.prototype,"typeKeywords",void 0),u([d({type:String,json:{read(t,e){var r;if(a$e.has(e.type)){const i=(r=this.portal)==null?void 0:r.restUrl;t||(t=i&&this.id?`${i}/content/items/${this.id}/data`:null)}return t}}})],yr.prototype,"url",void 0),u([d({readOnly:!0})],yr.prototype,"userItemUrl",null),yr=S1=u([P("esri.portal.PortalItem")],yr);const tw=yr,Cpe=Object.freeze(Object.defineProperty({__proto__:null,default:tw},Symbol.toStringTag,{value:"Module"})),KQ=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,l$e={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function QQ(t){return l$e[t]??!1}const $A=[],cS=new Map;function eee(t){for(const e of cS.keys())Rpe(t.pattern,e)&&cS.delete(e)}function c$e(t){return $A.includes(t)||(eee(t),$A.unshift(t)),{remove(){const e=$A.indexOf(t);e>-1&&($A.splice(e,1),eee(t))}}}async function Ape(t){const e=Vh();cS.has(t)||cS.set(t,h$e(t,e));const r=cS.get(t);return r&&await d$e.add(r),r}function u$e(t){if(!KQ.test(t))return null;const e=KQ.exec(t);if(e===null)return null;const[,r,i]=e,s=r+(i?"-"+i.toUpperCase():"");return QQ(s)?s:QQ(r)?r:null}async function h$e(t,e){const r=[];for(const i of $A)if(Rpe(i.pattern,t))try{return await i.fetchMessageBundle(t,e)}catch(s){r.push(s)}throw r.length?new j("intl:message-bundle-error",`Errors occurred while loading "${t}"`,{errors:r}):new j("intl:no-message-bundle-loader",`No loader found for message bundle "${t}"`)}function Rpe(t,e){return typeof t=="string"?e.startsWith(t):t.test(e)}BW(()=>{cS.clear()});const d$e=new class{constructor(){this._numLoading=0,this._dfd=null}async waitForAll(){this._dfd&&await this._dfd.promise}add(t){return this._increase(),t.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=J_())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}};async function p$e(t){if(!t)return;const e=t.includes("-vector")?t.slice(0,t.indexOf("-vector")):t,r=await Ape("esri/t9n/basemaps");return r[t]||r[e]}const nz={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return Kr("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/30d6b8271e1849cd9c3042060001f425/resources/styles/root.json",layerType:"VectorTileLayer",title:"Hybrid Reference Layer",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return Kr("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Kr("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Kr("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return Kr("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return Kr("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return Kr("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return Kr("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return Kr("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return Kr("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return Kr("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return Kr("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return Kr("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return Kr("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return Kr("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return Kr("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]},"arcgis-human-geography":{title:"Human Geography",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Base",title:"Human Geography Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Detail",title:"Human Geography Detail",isReference:!0},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Label",title:"Human Geography Label",isReference:!0}]},"arcgis-human-geography-dark":{title:"Human Geography (Dark)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Base",title:"Human Geography Dark Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Detail",title:"Human Geography Dark Detail",isReference:!0},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Label",title:"Human Geography Dark Label",isReference:!0}]}};function cO(t){const e=t==null?void 0:t.type;return e==="base-tile"||e==="tile"||e==="elevation"||e==="imagery-tile"||e==="base-elevation"||e==="open-street-map"||e==="wcs"||e==="web-tile"||e==="wmts"||e==="vector-tile"}function jS(t){return t!=null&&"type"in t&&t.type==="group"}const W2t={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};function Ope(t){const e=t==null?void 0:t.type;return e==="building-scene"||e==="integrated-mesh"||e==="point-cloud"||e==="scene"}function tee(t){return(t==null?void 0:t.type)==="voxel"}function ree(t){return(t==null?void 0:t.type)==="imagery-tile"}function Mpe(t){return t!=null&&t.parent!=null&&"declaredClass"in t.parent&&t.parent.declaredClass==="esri.Basemap"&&t.parent.baseLayers.includes(t)}function jW(t){var e;return(t==null?void 0:t.type)==="feature"&&!t.url&&((e=t.source)==null?void 0:e.type)==="memory"}function X2t(t){var e;return(t==null?void 0:t.type)==="feature"&&((e=t.source)==null?void 0:e.type)==="feature-layer"}function f$e(t){if(t.activeLayer){const e=t.activeLayer.tileMatrixSet;if(e)return e;const r=t.activeLayer.tileMatrixSets;if(r)return r}return null}async function Ppe(t,e){const r=xi==null?void 0:xi.findServerInfo(t);if((r==null?void 0:r.currentVersion)!=null)return r.owningSystemUrl||null;const i=t.toLowerCase().indexOf("/rest/services");if(i===-1)return null;const s=`${t.substring(0,i)}/rest/info`,n=v(e)?e.signal:null,{data:o}=await Pi(s,{query:{f:"json"},responseType:"json",signal:n});return(o==null?void 0:o.owningSystemUrl)||null}function m$e(t){if(!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"imagery":case"knowledge-graph-sublayer":case"ogc-feature":case"oriented-imagery":case"scene":case"subtype-group":case"subtype-sublayer":case"wfs":return!0;default:return!1}}function Ipe(t){return m$e(t)?"effectiveCapabilities"in t?t.effectiveCapabilities:t.capabilities:null}function g$e(t){if(!("editingEnabled"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"oriented-imagery":case"scene":case"subtype-group":case"subtype-sublayer":return!0;default:return!1}}function y$e(t){return!!g$e(t)&&("effectiveEditingEnabled"in t?t.effectiveEditingEnabled:t.editingEnabled)}const _$e=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),v$e=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","media","ogc-feature","route","subtype-group","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function b$e(t){return t.layerContainerType==="basemap"?_$e:t.layerContainerType==="operational-layers"?v$e:null}function w$e(t,e){if(e.restrictedWebMapWriting){const r=b$e(e);return!v(r)||r.has(t.type)&&!jW(t)}return!0}function x$e(t,e){if(e)if(jW(t)){const r=yM("featureCollection.layers",e),i=r&&r[0]&&r[0].layerDefinition;i&&_U(t,i)}else t.type==="stream"?_U(t,e.layerDefinition=e.layerDefinition||{}):t.type!=="group"&&_U(t,e)}function _U(t,e){"maxScale"in t&&(e.maxScale=zN(t.maxScale)??void 0),"minScale"in t&&(e.minScale=zN(t.minScale)??void 0)}function T$e(t,e){if(x$e(t,e),e&&("blendMode"in t&&(e.blendMode=t.blendMode,e.blendMode==="normal"&&delete e.blendMode),e.opacity=zN(t.opacity)??void 0,e.title=t.title||"Layer",e.visibility=t.visible,"legendEnabled"in t&&t.type!=="wmts"))if(jW(t)){const r=e.featureCollection;r&&(r.showLegend=t.legendEnabled)}else e.showLegend=t.legendEnabled}function iee(t,e,r){if(!("write"in t)||!t.write)return r&&r.messages&&r.messages.push(new j("layer:unsupported",`Layers (${t.title}, ${t.id}) of type '${t.declaredClass}' cannot be persisted`,{layer:t})),null;if(w$e(t,r)){const i={};return t.write(i,r)?i:null}return v(e)&&T$e(t,e=te(e)),e}var EL;let S$e=0;const $pe="esri.Basemap";let ah=EL=class extends TM(cm){constructor(t){super(t),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+S$e++,this.baseLayers=new ft,this.referenceLayers=new ft;const e=i=>{i.parent&&i.parent!==this&&"remove"in i.parent&&i.parent.remove(i),i.parent=this,i.type==="elevation"&&se.getLogger(this.declaredClass).error(`Layer '${i.title}, id:${i.id}' of type '${i.type}' is not supported as a basemap layer and will therefore be ignored.`)},r=i=>{i.parent=null};this.baseLayers.on("after-add",i=>e(i.item)),this.referenceLayers.on("after-add",i=>e(i.item)),this.baseLayers.on("after-remove",i=>r(i.item)),this.referenceLayers.on("after-remove",i=>r(i.item))}initialize(){this.when().catch(t=>{se.getLogger(this.declaredClass).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var r;const t=this.baseLayers.removeAll();for(const i of t)i.destroy();const e=this.referenceLayers.removeAll();for(const i of e)i.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),(r=this.portalItem)==null||r.destroy(),this.portalItem=null}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t={...t}).resourceInfo),t}set baseLayers(t){this._set("baseLayers",sy(t,this._get("baseLayers")))}_writeBaseLayers(t,e,r){const i=[];t&&(r={...r,layerContainerType:"basemap"},this.baseLayers.forEach(s=>{const n=iee(s,r.webmap?r.webmap.getLayerJSONFromResourceInfo(s):null,r);v(n)&&i.push(n)}),this.referenceLayers.forEach(s=>{const n=iee(s,r.webmap?r.webmap.getLayerJSONFromResourceInfo(s):null,r);v(n)&&(s.type!=="scene"&&(n.isReference=!0),i.push(n))})),e.baseMapLayers=i}set referenceLayers(t){this._set("referenceLayers",sy(t,this._get("referenceLayers")))}writeTitle(t,e){e.title=t||"Basemap"}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return PW(this,t=>{t(this.baseLayers,this.referenceLayers)})}clone(){const t={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(t.loadStatus="loaded"),new EL({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}write(t,e){return t=t||{},e&&e.origin||(e={origin:"web-map",...e}),super.write(t,e),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(t.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(r=>{const i=te(r);return i.url&&am(i.url)&&(i.url=`https:${i.url}`),i.templateUrl&&am(i.templateUrl)&&(i.templateUrl=`https:${i.templateUrl}`),i})),t}async _loadFromSource(t){const{resourceInfo:e,portalItem:r}=this;ur(t);const i=[];if(e){const s=e.context?e.context.url:null;if(i.push(this._loadLayersFromJSON(e.data,s,t)),e.data.id&&!e.data.title){const n=e.data.id;i.push(p$e(n).then(o=>{o&&this.read({title:o},e.context)}))}}else r&&i.push(this._loadFromItem(r,t));await Promise.all(i)}async _loadLayersFromJSON(t,e,r){const i=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||i&&i.portal||null,n=i&&i.origin==="web-scene"?"web-scene":"web-map",{populateOperationalLayers:o}=await ie(()=>import("./layersCreator-0c0184a0.js"),["./layersCreator-0c0184a0.js","./lazyLayerLoader-de1ad940.js","./portalLayers-adce7908.js","./layersLoader-9600ea66.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url),a=[];if(ur(r),t.baseMapLayers&&Array.isArray(t.baseMapLayers)){const l={context:{origin:n,url:e,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=f=>n==="web-scene"&&f.layerType==="ArcGISSceneServiceLayer"||f.isReference,h=o(this.baseLayers,t.baseMapLayers.filter(f=>!c(f)),l);a.push(h);const p=o(this.referenceLayers,t.baseMapLayers.filter(c),l);a.push(p)}await co(a)}async _loadFromItem(t,e){const r=await t.load(e),i=await r.fetchData("json",e),s=lo(t.itemUrl??"");return this._set("resourceInfo",{data:i.baseMap??{},context:{origin:t.type==="Web Scene"?"web-scene":"web-map",portal:t.portal||Io.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:i.spatialReference},this.resourceInfo.context),this.read({title:t.title,thumbnailUrl:t.thumbnailUrl},{origin:"portal-item",portal:t.portal||Io.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,e)}static fromId(t){const e=nz[t];if(e){if(e.deprecated){let r=null;t==="dark-gray"?r="dark-gray-vector":t==="gray"?r="gray-vector":t==="streets"?r="streets-vector":t==="topo"&&(r="topo-vector"),yde(se.getLogger($pe),`The ${t} basemap has entered mature support and is no longer being updated.`,{replacement:r,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return EL.fromJSON(e)}return null}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(t,e,r,i){this._writeBaseLayers(t,e,i)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:ft}},writer(t,e,r,i){this._writeBaseLayers(t,e,i)}}}}}})],ah.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],ah.prototype,"id",void 0),u([d({type:tw})],ah.prototype,"portalItem",void 0),u([d()],ah.prototype,"referenceLayers",null),u([d({readOnly:!0})],ah.prototype,"resourceInfo",void 0),u([d({type:We})],ah.prototype,"spatialReference",void 0),u([d()],ah.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],ah.prototype,"title",void 0),u([ke("title")],ah.prototype,"writeTitle",null),ah=EL=u([P($pe)],ah);const HS=ah,E$e=Object.freeze(Object.defineProperty({__proto__:null,default:HS},Symbol.toStringTag,{value:"Module"})),WN={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function Lpe(t){return WN[t]||WN[t.toLowerCase()]}function HW(t){return WN[t]??WN[t.toLowerCase()]}function C$e(t){return[...HW(t)]}function vU(t,e,r){r<0&&++r,r>1&&--r;const i=6*r;return i<1?t+(e-t)*i:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function Dpe(t,e,r,i=1){const s=(t%360+360)%360/360,n=r<=.5?r*(e+1):r+e-r*e,o=2*r-n;return[Math.round(255*vU(o,n,s+1/3)),Math.round(255*vU(o,n,s)),Math.round(255*vU(o,n,s-1/3)),i]}function A$e(t){const e=t.length>5,r=e?8:4,i=(1<<r)-1,s=e?1:17,n=e?t.length===9:t.length===5;let o=+("0x"+t.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&i,o>>=r,a[3]=s*l/255),l=o&i,o>>=r,a[2]=s*l,l=o&i,o>>=r,a[1]=s*l,l=o&i,o>>=r,a[0]=s*l,a}function M(){return[0,0,0]}function gs(t){return[t[0],t[1],t[2]]}function $e(t,e,r){return[t,e,r]}function Ul(t){const e=M(),r=Math.min(3,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function qW(t,e){return new Float64Array(t,e,3)}function Npe(){return M()}function Fpe(){return $e(1,1,1)}function Upe(){return $e(1,0,0)}function Vpe(){return $e(0,1,0)}function WW(){return $e(0,0,1)}const wa=Npe(),Gf=Fpe(),R$e=Upe(),O$e=Vpe(),kpe=WW();Object.freeze(Object.defineProperty({__proto__:null,ONES:Gf,UNIT_X:R$e,UNIT_Y:O$e,UNIT_Z:kpe,ZEROS:wa,clone:gs,create:M,createView:qW,fromArray:Ul,fromValues:$e,ones:Fpe,unitX:Upe,unitY:Vpe,unitZ:WW,zeros:Npe},Symbol.toStringTag,{value:"Module"}));let XW=1e-6;function Oa(){return XW}function M$e(t){XW=t}const CM=Math.random,P$e=Math.PI/180,I$e=180/Math.PI;function K4(t){return t*P$e}function $$e(t){return t*I$e}function L$e(t,e){return Math.abs(t-e)<=XW*Math.max(1,Math.abs(t),Math.abs(e))}Object.freeze(Object.defineProperty({__proto__:null,RANDOM:CM,equals:L$e,getEpsilon:Oa,setEpsilon:M$e,toDegree:$$e,toRadian:K4},Symbol.toStringTag,{value:"Module"}));function Me(t){const e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function le(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ce(t,e,r,i){return t[0]=e,t[1]=r,t[2]=i,t}function me(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function ge(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function Q4(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function XN(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function D$e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function zpe(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function oz(t,e){return t[0]=Math.abs(e[0]),t[1]=Math.abs(e[1]),t[2]=Math.abs(e[2]),t}function Bpe(t,e){return t[0]=Math.sign(e[0]),t[1]=Math.sign(e[1]),t[2]=Math.sign(e[2]),t}function Gpe(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t}function N$e(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t}function F$e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function ae(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function zb(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t}function Si(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(r*r+i*i+s*s)}function Vn(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}function ga(t){const e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}function xa(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function U$e(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function ve(t,e){const r=e[0],i=e[1],s=e[2];let n=r*r+i*i+s*s;return n>0&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n),t}function _e(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function pt(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2];return t[0]=s*l-n*a,t[1]=n*o-i*l,t[2]=i*a-s*o,t}function Qs(t,e,r,i){const s=e[0],n=e[1],o=e[2];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t[2]=o+i*(r[2]-o),t}function V$e(t,e,r,i,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return t[0]=e[0]*a+r[0]*l+i[0]*c+s[0]*h,t[1]=e[1]*a+r[1]*l+i[1]*c+s[1]*h,t[2]=e[2]*a+r[2]*l+i[2]*c+s[2]*h,t}function k$e(t,e,r,i,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return t[0]=e[0]*c+r[0]*h+i[0]*p+s[0]*f,t[1]=e[1]*c+r[1]*h+i[1]*p+s[1]*f,t[2]=e[2]*c+r[2]*h+i[2]*p+s[2]*f,t}function z$e(t,e){e=e||1;const r=CM,i=2*r()*Math.PI,s=2*r()-1,n=Math.sqrt(1-s*s)*e;return t[0]=Math.cos(i)*n,t[1]=Math.sin(i)*n,t[2]=s*e,t}function Xe(t,e,r){const i=e[0],s=e[1],n=e[2];return t[0]=r[0]*i+r[4]*s+r[8]*n+r[12],t[1]=r[1]*i+r[5]*s+r[9]*n+r[13],t[2]=r[2]*i+r[6]*s+r[10]*n+r[14],t}function Oc(t,e,r){const i=e[0],s=e[1],n=e[2];return t[0]=i*r[0]+s*r[3]+n*r[6],t[1]=i*r[1]+s*r[4]+n*r[7],t[2]=i*r[2]+s*r[5]+n*r[8],t}function pp(t,e,r){const i=r[0],s=r[1],n=r[2],o=r[3],a=e[0],l=e[1],c=e[2];let h=s*c-n*l,p=n*a-i*c,f=i*l-s*a,m=s*f-n*p,y=n*h-i*f,_=i*p-s*h;const b=2*o;return h*=b,p*=b,f*=b,m*=2,y*=2,_*=2,t[0]=a+h+m,t[1]=l+p+y,t[2]=c+f+_,t}function B$e(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[0],n[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),n[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function G$e(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),n[1]=s[1],n[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function j$e(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),n[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),n[2]=s[2],t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function jpe(t,e){le(AP,t),le(RP,e),ve(AP,AP),ve(RP,RP);const r=_e(AP,RP);return r>1?0:r<-1?Math.PI:Math.acos(r)}const AP=M(),RP=M();function H$e(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Qa(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Q_(t,e){if(t===e)return!0;const r=t[0],i=t[1],s=t[2],n=e[0],o=e[1],a=e[2],l=Oa();return Math.abs(r-n)<=l*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-o)<=l*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-a)<=l*Math.max(1,Math.abs(s),Math.abs(a))}function my(t,e,r){const i=r[0]-e[0],s=r[1]-e[1],n=r[2]-e[2];let o=i*i+s*s+n*n;return o>0?(o=1/Math.sqrt(o),t[0]=i*o,t[1]=s*o,t[2]=n*o,t):(t[0]=0,t[1]=0,t[2]=0,t)}const so=ge,q$e=Q4,W$e=XN,AM=Si,YW=Vn,yc=Me,az=ga,see=Object.freeze(Object.defineProperty({__proto__:null,abs:oz,add:me,angle:jpe,bezier:k$e,ceil:D$e,copy:le,cross:pt,direction:my,dist:AM,distance:Si,div:W$e,divide:XN,dot:_e,equals:Q_,exactEquals:Qa,floor:zpe,hermite:V$e,inverse:U$e,len:yc,length:Me,lerp:Qs,max:N$e,min:Gpe,mul:q$e,multiply:Q4,negate:xa,normalize:ve,random:z$e,rotateX:B$e,rotateY:G$e,rotateZ:j$e,round:F$e,scale:ae,scaleAndAdd:zb,set:ce,sign:Bpe,sqrDist:YW,sqrLen:az,squaredDistance:Vn,squaredLength:ga,str:H$e,sub:so,subtract:ge,transformMat3:Oc,transformMat4:Xe,transformQuat:pp},Symbol.toStringTag,{value:"Module"}));function rp(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function ti(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t}function ZW(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function Hpe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function qpe(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function Wpe(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function X$e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function Y$e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function Z$e(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t}function J$e(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t}function K$e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function kE(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function Q$e(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t}function Xpe(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(r*r+i*i+s*s+n*n)}function YN(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return r*r+i*i+s*s+n*n}function JW(t){const e=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(e*e+r*r+i*i+s*s)}function KW(t){const e=t[0],r=t[1],i=t[2],s=t[3];return e*e+r*r+i*i+s*s}function eLe(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function tLe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function Ype(t,e){const r=e[0],i=e[1],s=e[2],n=e[3];let o=r*r+i*i+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),t[0]=r*o,t[1]=i*o,t[2]=s*o,t[3]=n*o),t}function Zpe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function e5(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t[2]=o+i*(r[2]-o),t[3]=a+i*(r[3]-a),t}function rLe(t,e){const r=CM;let i,s,n,o,a,l;e=e||1;do i=2*r()-1,s=2*r()-1,a=i*i+s*s;while(a>=1);do n=2*r()-1,o=2*r()-1,l=n*n+o*o;while(l>=1);const c=Math.sqrt((1-a)/l);return t[0]=e*i,t[1]=e*s,t[2]=e*n*c,t[3]=e*o*c,t}function Ru(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3];return t[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*o,t[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*o,t[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*o,t[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*o,t}function iLe(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2],c=r[3],h=c*i+a*n-l*s,p=c*s+l*i-o*n,f=c*n+o*s-a*i,m=-o*i-a*s-l*n;return t[0]=h*c+m*-o+p*-l-f*-a,t[1]=p*c+m*-a+f*-o-h*-l,t[2]=f*c+m*-l+h*-a-p*-o,t[3]=e[3],t}function sLe(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function uS(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function QW(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3],h=Oa();return Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))}const nLe=Hpe,oLe=qpe,aLe=Wpe,lLe=Xpe,cLe=YN,uLe=JW,hLe=KW,Jpe=Object.freeze(Object.defineProperty({__proto__:null,add:ZW,ceil:X$e,copy:rp,dist:lLe,distance:Xpe,div:aLe,divide:Wpe,dot:Zpe,equals:QW,exactEquals:uS,floor:Y$e,inverse:tLe,len:uLe,length:JW,lerp:e5,max:J$e,min:Z$e,mul:oLe,multiply:qpe,negate:eLe,normalize:Ype,random:rLe,round:K$e,scale:kE,scaleAndAdd:Q$e,set:ti,sqrDist:cLe,sqrLen:hLe,squaredDistance:YN,squaredLength:KW,str:sLe,sub:nLe,subtract:Hpe,transformMat4:Ru,transformQuat:iLe},Symbol.toStringTag,{value:"Module"})),nee=new Float32Array(1);function qS(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}function ye(t,e,r){return Math.min(Math.max(t,e),r)}function vp(t){return(t&t-1)==0}function Y2t(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Z2t(t){return 10**Math.ceil(Math.LOG10E*Math.log(t))}function Ft(t,e,r){return t+(e-t)*r}function jt(t){return t*Math.PI/180}function ol(t){return 180*t/Math.PI}function bU(t,e=1e-6){return(t<0?-1:1)/Math.max(Math.abs(t),e)}function An(t){return Math.acos(ye(t,-1,1))}function Hh(t){return Math.asin(ye(t,-1,1))}function hS(t,e,r=1e-6){return t===e?!0:!Number.isFinite(t)||!Number.isFinite(e)?!1:(t>e?t-e:e-t)<=r}const ZN=new DataView(new ArrayBuffer(Float64Array.BYTES_PER_ELEMENT));function dLe(t){return ZN.setFloat64(0,t),ZN.getBigInt64(0)}function pLe(t){return ZN.setBigInt64(0,t),ZN.getFloat64(0)}const wU=BigInt("1000000");fLe(1);function fLe(t){const e=dLe(t=Math.abs(t)),r=pLe(e<=wU?wU:e-wU);return Math.abs(t-r)}function mLe(t,e,r=1e-6){if(t===e)return!0;if(!Number.isFinite(t)||!Number.isFinite(e))return!1;const i=Math.abs(t-e),s=Math.abs(t),n=Math.abs(e);if(t===0||e===0||s<1e-12&&n<1e-12){if(i>.01*r)return!1}else if(i/(s+n)>r)return!1;return!0}function gLe(t){return Kpe(Math.max(-lz,Math.min(t,lz)))}function Kpe(t){return nee[0]=t,nee[0]}function WS(t,e,r){const i=ye((r-t)/(e-t),0,1);return i*i*(3-2*i)}function oee(t,e){const r=Me(t),i=Hh(t[2]/r),s=Math.atan2(t[1]/r,t[0]/r);return ce(e,r,i,s),e}function J2t(t,e,r){return ti(t,e[0],e[1],e[2],e[3]*r)}function K2t(t){const e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[3]*t[3]+t[4]*t[4]+t[5]*t[5],i=t[6]*t[6]+t[7]*t[7]+t[8]*t[8];return!(hS(e,1)&&hS(r,1)&&hS(i,1))}const lz=Kpe(34028234663852886e22);function OP(t){return ye(xW(t),0,255)}function MP(t,e,r){return t=Number(t),isNaN(t)?r:t<e?e:t>r?r:t}let CL=class ca{static blendColors(e,r,i,s=new ca){return s.r=Math.round(e.r+(r.r-e.r)*i),s.g=Math.round(e.g+(r.g-e.g)*i),s.b=Math.round(e.b+(r.b-e.b)*i),s.a=e.a+(r.a-e.a)*i,s._sanitize()}static fromRgb(e,r){const i=e.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(i){const s=i[2].split(/\s*,\s*/),n=i[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),ca.fromArray(a,r)}return ca.fromArray(s.map(a=>parseFloat(a)),r)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return ca.fromArray(Dpe(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),r)}return null}static fromHex(e,r=new ca){if(e.length!==4&&e.length!==7||e[0]!=="#")return null;const i=e.length===4?4:8,s=(1<<i)-1;let n=+("0x"+e.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=i,r[o]=i===4?17*a:a}),r.a=1,r)}static fromArray(e,r=new ca){return r._set(Number(e[0]),Number(e[1]),Number(e[2]),Number(e[3])),isNaN(r.a)&&(r.a=1),r._sanitize()}static fromString(e,r){const i=Lpe(e)?HW(e):null;return i&&ca.fromArray(i,r)||ca.fromRgb(e,r)||ca.fromHex(e,r)}static fromJSON(e){return e&&new ca([e[0],e[1],e[2],e[3]/255])}static toUnitRGB(e){return v(e)?[e.r/255,e.g/255,e.b/255]:null}static toUnitRGBA(e){return v(e)?[e.r/255,e.g/255,e.b/255,e.a!=null?e.a:1]:null}constructor(e){this.r=255,this.g=255,this.b=255,this.a=1,e&&this.setColor(e)}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(e){return typeof e=="string"?ca.fromString(e,this):Array.isArray(e)?ca.fromArray(e,this):(this._set(e.r??0,e.g??0,e.b??0,e.a??1),e instanceof ca||this._sanitize()),this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const e=this.r.toString(16),r=this.g.toString(16),i=this.b.toString(16);return`#${e.length<2?"0"+e:e}${r.length<2?"0"+r:r}${i.length<2?"0"+i:i}`}toCss(e=!1){const r=this.r+", "+this.g+", "+this.b;return e?`rgba(${r}, ${this.a})`:`rgb(${r})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(e=ca.AlphaMode.ALWAYS){const r=OP(this.r),i=OP(this.g),s=OP(this.b);return e===ca.AlphaMode.ALWAYS||this.a!==1?[r,i,s,OP(255*this.a)]:[r,i,s]}clone(){return new ca(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}equals(e){return v(e)&&e.r===this.r&&e.g===this.g&&e.b===this.b&&e.a===this.a}_sanitize(){return this.r=Math.round(MP(this.r,0,255)),this.g=Math.round(MP(this.g,0,255)),this.b=Math.round(MP(this.b,0,255)),this.a=MP(this.a,0,1),this}_set(e,r,i,s){this.r=e,this.g=r,this.b=i,this.a=s}};CL.prototype.declaredClass="esri.Color",function(t){var e;(e=t.AlphaMode||(t.AlphaMode={}))[e.ALWAYS=0]="ALWAYS",e[e.UNLESS_OPAQUE=1]="UNLESS_OPAQUE"}(CL||(CL={}));const Ze=CL;function Q2t(t){}function yLe(t){return()=>t}function mt(t,e={}){const r=t instanceof Vr?t:new Vr(t,e),i={type:(e==null?void 0:e.ignoreUnknown)??1?r.apiValues:String,json:{type:r.jsonValues,read:!(e!=null&&e.readOnly)&&{reader:r.read},write:{writer:r.write}}};return(e==null?void 0:e.readOnly)!==void 0&&(i.readOnly=!!e.readOnly),(e==null?void 0:e.default)!==void 0&&(i.json.default=e.default),(e==null?void 0:e.name)!==void 0&&(i.json.name=e.name),(e==null?void 0:e.nonNullable)!==void 0&&(i.nonNullable=e.nonNullable),d(i)}var cz;let AL=cz=class extends fe{constructor(t){super(t),this.type="none"}clone(){return new cz({type:this.type})}};u([mt({none:"none",stayAbove:"stay-above"})],AL.prototype,"type",void 0),AL=cz=u([P("esri.ground.NavigationConstraint")],AL);let As=class extends Te{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1,this.TERRAIN_USE_LEGACY_SHADING=!1}};u([d()],As.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],As.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],As.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],As.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],As.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],As.prototype,"TEXT_SHOW_BASELINE",void 0),u([d()],As.prototype,"TEXT_SHOW_BORDER",void 0),u([d()],As.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],As.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],As.prototype,"SHOW_POI",void 0),u([d()],As.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],As.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],As.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],As.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],As.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],As.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],As.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],As.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],As.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],As.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],As.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),u([d()],As.prototype,"LINE_WIREFRAMES",void 0),u([d()],As.prototype,"TERRAIN_USE_LEGACY_SHADING",void 0),As=u([P("esri.views.3d.support.DebugFlags")],As);const Wr=new As;function RM(t){const e=xW(100*(1-t));return Math.max(0,Math.min(e,100))}function XS(t){const e=1-t/100;return Math.max(0,Math.min(e,1))}var uz;let sf=uz=class extends TM(cm){constructor(t){super(t),this.opacity=1,this.shading=!Wr.TERRAIN_USE_LEGACY_SHADING,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new ft;const e=i=>{i.parent&&i.parent!==this&&"remove"in i.parent&&i.parent.remove(i),i.parent=this,i.type!=="elevation"&&i.type!=="base-elevation"&&se.getLogger(this.declaredClass).error(`Layer '${i.title}, id:${i.id}' of type '${i.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},r=i=>{i.parent=null};this.layers.on("after-add",i=>e(i.item)),this.layers.on("after-remove",i=>r(i.item))}initialize(){this.when().catch(t=>{se.getLogger(this.declaredClass).error("#load()","Failed to load ground",t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const t=this.layers.removeAll();for(const e of t)e.destroy();this.layers.destroy()}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t={...t}).resourceInfo),t}set layers(t){this._set("layers",sy(t,this._get("layers")))}writeLayers(t,e,r,i){const s=[];t&&(i={...i,layerContainerType:"ground"},t.forEach(n=>{if("write"in n){const o={};yLe(n)().write(o,i)&&s.push(o)}else i&&i.messages&&i.messages.push(new j("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),e.layers=s}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return PW(this,t=>{t(this.layers)})}async queryElevation(t,e){await this.load({signal:e==null?void 0:e.signal});const{ElevationQuery:r}=await ie(()=>import("./ElevationQuery-832185a4.js"),[],import.meta.url);ur(e);const i=new r,s=this.layers.filter(aee).toArray();return i.queryAll(s,t,e)}async createElevationSampler(t,e){await this.load({signal:e==null?void 0:e.signal});const{ElevationQuery:r}=await ie(()=>import("./ElevationQuery-832185a4.js"),[],import.meta.url);ur(e);const i=new r,s=this.layers.filter(aee).toArray();return i.createSamplerAll(s,t,e)}clone(){const t={opacity:this.opacity,surfaceColor:te(this.surfaceColor),navigationConstraint:te(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(t.loadStatus="loaded"),new uz({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}_loadFromSource(t){const e=this.resourceInfo;return e?this._loadLayersFromJSON(e.data,e.context,t):Promise.resolve()}_loadLayersFromJSON(t,e,r){const i=e&&e.origin||"web-scene",s=e&&e.portal||null,n=e&&e.url||null;return ie(()=>import("./layersCreator-0c0184a0.js"),["./layersCreator-0c0184a0.js","./lazyLayerLoader-de1ad940.js","./portalLayers-adce7908.js","./layersLoader-9600ea66.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url).then(({populateOperationalLayers:o})=>{ur(r);const a=[];if(t.layers&&Array.isArray(t.layers)){const l={context:{origin:i,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,t.layers,l))}return co(a)}).then(()=>{})}};function _Le(t){return t&&"createElevationSampler"in t}function aee(t){return t.type==="elevation"||_Le(t)}u([d({json:{read:!1}})],sf.prototype,"layers",null),u([ke("layers")],sf.prototype,"writeLayers",null),u([d({readOnly:!0})],sf.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:Ti,read:{reader:XS,source:"transparency"},write:{writer:(t,e)=>{e.transparency=RM(t)},target:"transparency"}}})],sf.prototype,"opacity",void 0),u([d({type:Boolean,nonNullable:!0,json:{read:!1}})],sf.prototype,"shading",void 0),u([d({type:Ze,json:{type:[Ti],write:(t,e)=>{e.surfaceColor=t.toJSON().slice(0,3)}}})],sf.prototype,"surfaceColor",void 0),u([d({type:AL,json:{write:!0}})],sf.prototype,"navigationConstraint",void 0),sf=uz=u([P("esri.Ground")],sf);const c3=sf;let PT=class extends ft{constructor(e){super(e),this.getCollections=null}initialize(){this.own(Ede(()=>this._refresh()))}destroy(){this.getCollections=null}_refresh(){const e=v(this.getCollections)?this.getCollections():null;if(C(e))return void this.removeAll();let r=0;for(const i of e)v(i)&&(r=this._processCollection(r,i));this.splice(r,this.length)}_createNewInstance(e){return new ft(e)}_processCollection(e,r){if(!r)return e;const i=this.itemFilterFunction?this.itemFilterFunction:s=>!!s;for(const s of r)if(s){if(i(s)){const n=this.indexOf(s,e);n>=0?n!==e&&this.reorder(s,e):this.add(s,e),++e}if(this.getChildrenFunction){const n=this.getChildrenFunction(s);if(Array.isArray(n))for(const o of n)e=this._processCollection(e,o);else e=this._processCollection(e,n)}}return e}};u([d()],PT.prototype,"getCollections",void 0),u([d()],PT.prototype,"getChildrenFunction",void 0),u([d()],PT.prototype,"itemFilterFunction",void 0),PT=u([P("esri.core.CollectionFlattener")],PT);const u3=PT;function vLe(t){var e,r;return!(!(t!=null&&t.loaded)||!((r=(e=Ipe(t))==null?void 0:e.operations)!=null&&r.supportsEditing)||"editingEnabled"in t&&!y$e(t))}const lee=se.getLogger("esri.support.basemapUtils");function bLe(){return{}}function wLe(t){for(const e in t){const r=t[e];(r==null?void 0:r.destroyed)===!1&&r.destroy(),delete t[e]}}function eX(t,e){let r;if(typeof t=="string"){if(!(t in nz)){const i=Object.entries(nz).filter(([s,n])=>Qr.apiKey&&!n.classic||!Qr.apiKey&&n.classic&&!n.deprecated).map(([s])=>`"${s}"`).join(", ");return lee.warn(`Unable to find basemap definition for: ${t}. Try one of these: ${i}`),null}e&&(r=e[t]),r||(r=HS.fromId(t),e&&(e[t]=r))}else r=Ls(HS,t);return r!=null&&r.destroyed&&(lee.warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}function xLe(t,e=null){const r=eX(t);if(!r)return null;const i=new HS({id:r.id,title:r.title,baseLayers:r.baseLayers.slice(),referenceLayers:r.referenceLayers.slice()});return e&&(i.baseLayers=cee(i.baseLayers,e.baseLayers),i.referenceLayers=cee(i.referenceLayers,e.referenceLayers)),i.load().catch(()=>{}),i.portalItem=r.portalItem,i}function cee(t,e){const r=new ft;return t.forEach(i=>{const s=e.find(n=>TLe(uee(i),uee(n)))||i;r.includes(s)?r.push(i):r.push(s)}),r}function uee(t){var e,r;return{type:t.type,url:SLe("urlTemplate"in t&&t.urlTemplate||t.url||"styleUrl"in t&&t.styleUrl||""),minScale:"minScale"in t&&t.minScale!=null?t.minScale:0,maxScale:"maxScale"in t&&t.maxScale!=null?t.maxScale:0,opacity:t.opacity!=null?t.opacity:1,visible:t.visible==null||!!t.visible,sublayers:t.type!=="map-image"&&t.type!=="wms"||!v(t.sublayers)||(e=t.sublayers)==null?void 0:e.map(i=>({id:i.id,visible:i.visible})),activeLayerId:t.type==="wmts"?(r=t.activeLayer)==null?void 0:r.id:void 0}}function TLe(t,e){if(t.type!==e.type||t.type==="scene"||t.url!==e.url||t.minScale!==e.minScale||t.maxScale!==e.maxScale||t.visible!==e.visible||t.opacity!==e.opacity)return!1;if(v(t.activeLayerId)||v(e.activeLayerId))return t.activeLayerId===e.activeLayerId;if(v(t.sublayers)||v(e.sublayers)){if(C(t.sublayers)||C(e.sublayers)||t.sublayers.length!==e.sublayers.length)return!1;for(let r=0;r<t.sublayers.length;r++){const i=t.sublayers.at(r),s=e.sublayers.at(r);if((i==null?void 0:i.id)!==(s==null?void 0:s.id)||(i==null?void 0:i.visible)!==(s==null?void 0:s.visible))return!1}}return!0}function SLe(t){return t?Uh(t).replace(/^\s*https?:/i,"").toLowerCase():""}function ELe(t){return new u3({getCollections:()=>[t.tables,t.layers],getChildrenFunction:e=>{const r=[];return"tables"in e&&r.push(e.tables),"layers"in e&&r.push(e.layers),r},itemFilterFunction:e=>{const r=e.parent;return!!r&&"tables"in r&&r.tables.includes(e)}})}const hee={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function CLe(t){let e=null;if(typeof t=="string")if(t in hee){const r=hee[t];e=new c3({resourceInfo:{data:{layers:[r]}}})}else se.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${t}. Try "world-elevation"`);else e=Ls(c3,t);return e}function YS(t,e,r=!1){let{hasM:i,hasZ:s}=t;Array.isArray(e)?e.length!==4||i||s?e.length===3&&r&&!i?(s=!0,i=!1):e.length===3&&i&&s&&(i=!1,s=!1):(i=!0,s=!0):(s=!s&&e.hasZ&&(!i||e.hasM),i=!i&&e.hasM&&(!s||e.hasZ)),t.hasZ=s,t.hasM=i}var hz;function dee(t){return(e,r)=>e==null?r:r==null?e:t(e,r)}function ALe(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let E0=hz=class extends xv{constructor(...t){super(...t),this.points=[],this.type="multipoint"}normalizeCtorArgs(t,e){if(!t&&!e)return{};const r={};Array.isArray(t)?(r.points=t,r.spatialReference=e):ALe(t)?r.spatialReference=t:(t.points&&(r.points=t.points),t.spatialReference&&(r.spatialReference=t.spatialReference),t.hasZ&&(r.hasZ=t.hasZ),t.hasM&&(r.hasM=t.hasM));const i=r.points&&r.points[0];return i&&(r.hasZ===void 0&&r.hasM===void 0?(r.hasZ=i.length>2,r.hasM=!1):r.hasZ===void 0?r.hasZ=i.length>3:r.hasM===void 0&&(r.hasM=i.length>3)),r}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const t=this.points;if(!t.length)return null;const e=new Hr,r=this.hasZ,i=this.hasM,s=r?3:2,n=t[0],o=dee(Math.min),a=dee(Math.max);let l,c,h,p,[f,m]=n,[y,_]=n;for(let b=0,x=t.length;b<x;b++){const T=t[b],[S,E]=T;if(f=o(f,S),m=o(m,E),y=a(y,S),_=a(_,E),r&&T.length>2){const O=T[2];l=o(l,O),h=a(h,O)}if(i&&T.length>s){const O=T[s];c=o(c,O),p=a(p,O)}}return e.xmin=f,e.ymin=m,e.xmax=y,e.ymax=_,e.spatialReference=this.spatialReference,r?(e.zmin=l,e.zmax=h):(e.zmin=void 0,e.zmax=void 0),i?(e.mmin=c,e.mmax=p):(e.mmin=void 0,e.mmax=void 0),e}writePoints(t,e){e.points=te(this.points)}addPoint(t){return YS(this,t),Array.isArray(t)?this.points.push(t):this.points.push(t.toArray()),this.notifyChange("points"),this}clone(){const t={points:te(this.points),spatialReference:this.spatialReference};return this.hasZ&&(t.hasZ=!0),this.hasM&&(t.hasM=!0),new hz(t)}getPoint(t){if(!this._validateInputs(t))return null;const e=this.points[t],r={x:e[0],y:e[1],spatialReference:this.spatialReference};let i=2;return this.hasZ&&(r.z=e[2],i=3),this.hasM&&(r.m=e[i]),new _t(r)}removePoint(t){if(!this._validateInputs(t))return null;const e=new _t(this.points.splice(t,1)[0],this.spatialReference);return this.notifyChange("points"),e}setPoint(t,e){return this._validateInputs(t)?(YS(this,e),Array.isArray(e)||(e=e.toArray()),this.points[t]=e,this.notifyChange("points"),this):this}toJSON(t){return this.write({},t)}_validateInputs(t){return t!=null&&t>=0&&t<this.points.length}};u([d({readOnly:!0})],E0.prototype,"cache",null),u([d()],E0.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],E0.prototype,"points",void 0),u([ke("points")],E0.prototype,"writePoints",null),E0=hz=u([P("esri.geometry.Multipoint")],E0),E0.prototype.toJSON.isDefaultToJSON=!0;const OM=E0;function tX(t,e){const r=e[0]-t[0],i=e[1]-t[1];if(t.length>2&&e.length>2){const s=t[2]-e[2];return Math.sqrt(r*r+i*i+s*s)}return Math.sqrt(r*r+i*i)}function Qpe(t,e,r){const i=t[0]+r*(e[0]-t[0]),s=t[1]+r*(e[1]-t[1]);return t.length>2&&e.length>2?[i,s,t[2]+r*(e[2]-t[2])]:[i,s]}function rSt(t,e,r,i){const[s,n]=e,[o,a]=r[i],[l,c]=r[i+1],h=l-o,p=c-a,f=h*h+p*p,m=(s-o)*h+(n-a)*p,y=Math.min(1,Math.max(0,m/f));return t[0]=o+h*y,t[1]=a+p*y,t}function iSt(t,e,r){const i=r.rings;let s,n,o=!1,a=1/0;for(let l=0;l<i.length;l++){const c=i[l];for(let h=0,p=c.length-1;h<c.length;p=h++)s=c[h],n=c[p],s[1]>e!=n[1]>e&&t<(n[0]-s[0])*(e-s[1])/(n[1]-s[1])+s[0]&&(o=!o),a=Math.min(a,RLe(t,e,s,n))}return a===0?0:(o?1:-1)*Math.sqrt(a)}function RLe(t,e,r,i){let s=r[0],n=r[1],o=i[0]-s,a=i[1]-n;if(o!==0||a!==0){const l=((t-s)*o+(e-n)*a)/(o*o+a*a);l>1?(s=i[0],n=i[1]):l>0&&(s+=o*l,n+=a*l)}return o=t-s,a=e-n,o*o+a*a}function OLe(t,e){return Qpe(t,e,.5)}function efe(t){const e=t.length;let r=0;for(let i=0;i<e-1;++i)r+=tX(t[i],t[i+1]);return r}function tfe(t,e){if(e<=0)return t[0];const r=t.length;let i=0;for(let s=0;s<r-1;++s){const n=tX(t[s],t[s+1]);if(e-i<n){const o=(e-i)/n;return Qpe(t[s],t[s+1],o)}i+=n}return t[r-1]}function rfe(t,e,r){const i=t.length;let s=0,n=0,o=0;for(let a=0;a<i;a++){const l=t[a],c=t[(a+1)%i];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&r&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&e&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function MLe(t){const e=t.length;return e>2&&ry(t[0],t[e-1])}function sSt(t){if("rings"in t)for(const e of t.rings)MLe(e)||e.push(e[0].slice())}function ife(t){if(!t||t.length<3)return 0;let e=0;const r=t.length-1;for(let i=0;i<r;i++)e+=(t[i][0]-t[i+1][0])*(t[i][1]+t[i+1][1]);return e+=(t[r][0]-t[0][0])*(t[r][1]+t[0][1]),-.5*e}function nSt(t){return t?t.hasZ?[t.xmax-t.xmin/2,t.ymax-t.ymin/2,t.zmax-t.zmin/2]:[t.xmax-t.xmin/2,t.ymax-t.ymin/2]:null}function PLe(t){return t?rX(t.rings,t.hasZ??!1):null}function rX(t,e){if(!t||!t.length)return null;const r=[],i=[],s=e?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=t.length;n<o;n++){const a=ILe(t[n],e,s);a&&i.push(a)}if(i.sort((n,o)=>{let a=n[2]-o[2];return a===0&&e&&(a=n[4]-o[4]),a}),i.length&&(r[0]=i[0][0],r[1]=i[0][1],e&&(r[2]=i[0][3]),(r[0]<s[0]||r[0]>s[1]||r[1]<s[2]||r[1]>s[3]||e&&(r[2]<s[4]||r[2]>s[5]))&&(r.length=0)),!r.length){const n=t[0]&&t[0].length?$Le(t[0],e):null;if(!n)return null;r[0]=n[0],r[1]=n[1],e&&n.length>2&&(r[2]=n[2])}return r}function ILe(t,e,r){let i=0,s=0,n=0,o=0,a=0;const l=t.length?t[0][0]:0,c=t.length?t[0][1]:0,h=t.length&&e?t[0][2]:0;for(let f=0;f<t.length;f++){const m=t[f],y=t[(f+1)%t.length],[_,b,x]=m,T=_-l,S=b-c,[E,O,R]=y,L=E-l,I=O-c,U=T*I-L*S;if(o+=U,i+=(T+L)*U,s+=(S+I)*U,e&&m.length>2&&y.length>2){const z=x-h,B=R-h,G=T*B-L*z;n+=(z+B)*G,a+=G}_<r[0]&&(r[0]=_),_>r[1]&&(r[1]=_),b<r[2]&&(r[2]=b),b>r[3]&&(r[3]=b),e&&(x<r[4]&&(r[4]=x),x>r[5]&&(r[5]=x))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[i/(6*o)+l,s/(6*o)+c,o];return e&&(r[4]===r[5]||a===0?(p[3]=(r[4]+r[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function $Le(t,e){const r=e?[0,0,0]:[0,0],i=e?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=t.length;l<c-1;l++){const h=t[l],p=t[l+1];if(h&&p){r[0]=h[0],r[1]=h[1],i[0]=p[0],i[1]=p[1],e&&h.length>2&&p.length>2&&(r[2]=h[2],i[2]=p[2]);const f=tX(r,i);if(f){s+=f;const m=OLe(h,p);n+=f*m[0],o+=f*m[1],e&&m.length>2&&(a+=f*m[2])}}}return s>0?e?[n/s,o/s,a/s]:[n/s,o/s]:t.length?t[0]:null}const LLe=1e-6;function oSt(t){if(!t||!t.rings)return null;const{rings:e}=t;let r=0;for(let n=0;n<e.length;n++)r+=ife(e[n]);if(r<LLe)return rX(e,!1);const i=[0,0],s=e[0][0];for(let n=0;n<e.length;n++)NLe(i,s,e[n]);return i[0]*=1/r,i[1]*=1/r,i[0]+=s[0],i[1]+=s[1],i}const DLe=1/3;function NLe(t,e,r){if(!t||!r||r.length<3)return null;const i=r[0],s=[0,0],n=[r[1][0]-i[0],r[1][1]-i[1]];let o;for(let c=2;c<r.length;c++)s[0]=r[c][0]-i[0],s[1]=r[c][1]-i[1],o=.5*DLe*(s[0]*n[1]-s[1]*n[0]),t[0]+=o*(n[0]+s[0]),t[1]+=o*(n[1]+s[1]),n[0]=s[0],n[1]=s[1];const a=ife(r),l=[i[0],i[1]];return l[0]-=e[0],l[1]-=e[1],l[0]*=a,l[1]*=a,t[0]+=l[0],t[1]+=l[1],t}function sfe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function nfe(t){return t.points!==void 0}function ofe(t){return t.x!==void 0&&t.y!==void 0}function afe(t){return t.paths!==void 0}function lfe(t){return t.rings!==void 0}function cfe(t){function e(r,i){return r==null?i:i==null?r:t(r,i)}return e}const T_=cfe(Math.min),S_=cfe(Math.max);function aSt(t,e){return afe(e)?ZS(t,e.paths,!1,!1):lfe(e)?ZS(t,e.rings,!1,!1):nfe(e)?iX(t,e.points,!1,!1,!1,!1):sfe(e)?ufe(t,e):(ofe(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.x,t[3]=e.y),t)}function lSt(t,e){return afe(e)?ZS(t,e.paths,!0,!1):lfe(e)?ZS(t,e.rings,!0,!1):nfe(e)?iX(t,e.points,!0,!1,!0,!1):sfe(e)?ufe(t,e,!0,!1,!0,!1):(ofe(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.x,t[4]=e.y,t[5]=e.z),t)}function ZS(t,e,r,i){const s=r?3:2;if(!e.length||!e[0].length)return null;let n,o,a,l,[c,h]=e[0][0],[p,f]=e[0][0];for(let m=0;m<e.length;m++){const y=e[m];for(let _=0;_<y.length;_++){const b=y[_],[x,T]=b;if(c=T_(c,x),h=T_(h,T),p=S_(p,x),f=S_(f,T),r&&b.length>2){const S=b[2];n=T_(n,S),o=S_(o,S)}if(i&&b.length>s){const S=b[s];a=T_(n,S),l=S_(o,S)}}}return r?i?(t[0]=c,t[1]=h,t[2]=n,t[3]=a,t[4]=p,t[5]=f,t[6]=o,t[7]=l,t.length=8,t):(t[0]=c,t[1]=h,t[2]=n,t[3]=p,t[4]=f,t[5]=o,t.length=6,t):i?(t[0]=c,t[1]=h,t[2]=a,t[3]=p,t[4]=f,t[5]=l,t.length=6,t):(t[0]=c,t[1]=h,t[2]=p,t[3]=f,t.length=4,t)}function ufe(t,e,r,i,s,n){const o=e.xmin,a=e.xmax,l=e.ymin,c=e.ymax;let h=e.zmin,p=e.zmax,f=e.mmin,m=e.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,m=m||0,t[0]=o,t[1]=l,t[2]=h,t[3]=f,t[4]=a,t[5]=c,t[6]=p,t[7]=m,t):(t[0]=o,t[1]=l,t[2]=h,t[3]=a,t[4]=c,t[5]=p,t)):n?(f=f||0,m=m||0,t[0]=o,t[1]=l,t[2]=f,t[3]=a,t[4]=c,t[5]=m,t):(t[0]=o,t[1]=l,t[2]=a,t[3]=c,t)}function iX(t,e,r,i,s,n){const o=r?3:2,a=i&&n,l=r&&s;if(!e.length||!e[0].length)return null;let c,h,p,f,[m,y]=e[0],[_,b]=e[0];for(let x=0;x<e.length;x++){const T=e[x],[S,E]=T;if(m=T_(m,S),y=T_(y,E),_=S_(_,S),b=S_(b,E),l&&T.length>2){const O=T[2];c=T_(c,O),h=S_(h,O)}if(a&&T.length>o){const O=T[o];p=T_(c,O),f=S_(h,O)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,t[0]=m,t[1]=y,t[2]=c,t[3]=p,t[4]=_,t[5]=b,t[6]=h,t[7]=f,t):(t[0]=m,t[1]=y,t[2]=c,t[3]=_,t[4]=b,t[5]=h,t)):n?(p=p||0,f=f||0,t[0]=m,t[1]=y,t[2]=p,t[3]=_,t[4]=b,t[5]=f,t):(t[0]=m,t[1]=y,t[2]=_,t[3]=b,t)}function FLe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function ULe(t){return t.points!==void 0}function VLe(t){return t.x!==void 0&&t.y!==void 0}function kLe(t){return t.paths!==void 0}function zLe(t){return t.rings!==void 0}const sX=[];function hfe(t,e,r,i){return{xmin:t,ymin:e,xmax:r,ymax:i}}function dfe(t,e,r,i,s,n){return{xmin:t,ymin:e,zmin:r,xmax:i,ymax:s,zmax:n}}function pfe(t,e,r,i,s,n){return{xmin:t,ymin:e,mmin:r,xmax:i,ymax:s,mmax:n}}function ffe(t,e,r,i,s,n,o,a){return{xmin:t,ymin:e,zmin:r,mmin:i,xmax:s,ymax:n,zmax:o,mmax:a}}function nX(t,e=!1,r=!1){return e?r?ffe(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]):dfe(t[0],t[1],t[2],t[3],t[4],t[5]):r?pfe(t[0],t[1],t[2],t[3],t[4],t[5]):hfe(t[0],t[1],t[2],t[3])}function cSt(t){return t?FLe(t)?t:VLe(t)?GLe(t):zLe(t)?mfe(t):kLe(t)?gfe(t):ULe(t)?BLe(t):null:null}function BLe(t){const{hasZ:e,hasM:r,points:i}=t;return nX(iX(sX,i,e??!1,r??!1),e,r)}function GLe(t){const{x:e,y:r,z:i,m:s}=t,n=s!=null;return i!=null?n?ffe(e,r,i,s,e,r,i,s):dfe(e,r,i,e,r,i):n?pfe(e,r,s,e,r,s):hfe(e,r,e,r)}function mfe(t){const{hasZ:e,hasM:r,rings:i}=t,s=ZS(sX,i,e??!1,r??!1);return s?nX(s,e,r):null}function gfe(t){const{hasZ:e,hasM:r,paths:i}=t,s=ZS(sX,i,e??!1,r??!1);return s?nX(s,e,r):null}var RL;function pee(t){return!Array.isArray(t[0])}let nf=RL=class extends xv{static fromExtent(t){const e=t.clone().normalize(),r=t.spatialReference;let i=!1,s=!1;for(const o of e)o.hasZ&&(i=!0),o.hasM&&(s=!0);const n={rings:e.map(o=>{const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(i&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:r};return i&&(n.hasZ=!0),s&&(n.hasM=!0),new RL(n)}constructor(...t){super(...t),this.rings=[],this.type="polygon"}normalizeCtorArgs(t,e){let r,i,s=null,n=null;return t&&!Array.isArray(t)?(s=t.rings?t.rings:null,e||(t.spatialReference?e=t.spatialReference:t.rings||(e=t)),r=t.hasZ,i=t.hasM):s=t,s=s||[],e=e||We.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(r===void 0&&i===void 0?(r=n.length>2,i=n.length>3):r===void 0?r=i?n.length>3:n.length>2:i===void 0&&(i=r?n.length>3:n.length>2)),{rings:s,spatialReference:e,hasZ:r,hasM:i}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const t=PLe(this);if(!t||isNaN(t[0])||isNaN(t[1])||this.hasZ&&isNaN(t[2]))return null;const e=new _t;return e.x=t[0],e.y=t[1],e.spatialReference=this.spatialReference,this.hasZ&&(e.z=t[2]),e}get extent(){const{spatialReference:t}=this,e=mfe(this);if(!e)return null;const r=new Hr(e);return r.spatialReference=t,r}get isSelfIntersecting(){return WIe(this.rings)}writeRings(t,e){e.rings=te(this.rings)}addRing(t){if(!t)return;const e=this.rings,r=e.length;if(pee(t)){const i=[];for(let s=0,n=t.length;s<n;s++)i[s]=t[s].toArray();e[r]=i}else e[r]=t.concat();return this.notifyChange("rings"),this}clone(){const t=new RL;return t.spatialReference=this.spatialReference,t.rings=te(this.rings),t.hasZ=this.hasZ,t.hasM=this.hasM,t}equals(t){if(this===t)return!0;if(C(t))return!1;const e=this.spatialReference,r=t.spatialReference;if(v(e)!==v(r)||v(e)&&v(r)&&!e.equals(r)||this.rings.length!==t.rings.length)return!1;const i=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=t.rings[s];if(!ry(n,o,i))return!1}return!0}contains(t){if(!t)return!1;const e=ex(t,this.spatialReference);return FIe(this,v(e)?e:t)}isClockwise(t){let e;return e=pee(t)?t.map(r=>this.hasZ?this.hasM?[r.x,r.y,r.z,r.m]:[r.x,r.y,r.z]:[r.x,r.y]):t,rfe(e,this.hasM,this.hasZ)}getPoint(t,e){if(!this._validateInputs(t,e))return null;const r=this.rings[t][e],i=this.hasZ,s=this.hasM;return i&&!s?new _t(r[0],r[1],r[2],void 0,this.spatialReference):s&&!i?new _t(r[0],r[1],void 0,r[2],this.spatialReference):i&&s?new _t(r[0],r[1],r[2],r[3],this.spatialReference):new _t(r[0],r[1],this.spatialReference)}insertPoint(t,e,r){return this._validateInputs(t,e,!0)?(YS(this,r),Array.isArray(r)||(r=r.toArray()),this.rings[t].splice(e,0,r),this.notifyChange("rings"),this):this}removePoint(t,e){if(!this._validateInputs(t,e))return null;const r=new _t(this.rings[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("rings"),r}removeRing(t){if(!this._validateInputs(t,null))return null;const e=this.rings.splice(t,1)[0],r=this.spatialReference,i=e.map(s=>new _t(s,r));return this.notifyChange("rings"),i}setPoint(t,e,r){return this._validateInputs(t,e)?(YS(this,r),Array.isArray(r)||(r=r.toArray()),this.rings[t][e]=r,this.notifyChange("rings"),this):this}_validateInputs(t,e,r=!1){if(t==null||t<0||t>=this.rings.length)return!1;if(e!=null){const i=this.rings[t];if(r&&(e<0||e>i.length)||!r&&(e<0||e>=i.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],nf.prototype,"cache",null),u([d({readOnly:!0})],nf.prototype,"centroid",null),u([d({readOnly:!0})],nf.prototype,"extent",null),u([d({readOnly:!0})],nf.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],nf.prototype,"rings",void 0),u([ke("rings")],nf.prototype,"writeRings",null),nf=RL=u([P("esri.geometry.Polygon")],nf),nf.prototype.toJSON.isDefaultToJSON=!0;const bp=nf;var dz;function jLe(t){return!Array.isArray(t[0])}let C0=dz=class extends xv{constructor(...t){super(...t),this.paths=[],this.type="polyline"}normalizeCtorArgs(t,e){let r,i,s=null,n=null;return t&&!Array.isArray(t)?(s=t.paths?t.paths:null,e||(t.spatialReference?e=t.spatialReference:t.paths||(e=t)),r=t.hasZ,i=t.hasM):s=t,s=s||[],e=e||We.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(r===void 0&&i===void 0?(r=n.length>2,i=!1):r===void 0?r=!i&&n.length>3:i===void 0&&(i=!r&&n.length>3)),{paths:s,spatialReference:e,hasZ:r,hasM:i}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:t}=this,e=gfe(this);if(!e)return null;const r=new Hr(e);return r.spatialReference=t,r}writePaths(t,e){e.paths=te(this.paths)}addPath(t){if(!t)return;const e=this.paths,r=e.length;if(jLe(t)){const i=[];for(let s=0,n=t.length;s<n;s++)i[s]=t[s].toArray();e[r]=i}else e[r]=t.concat();return this.notifyChange("paths"),this}clone(){const t=new dz;return t.spatialReference=this.spatialReference,t.paths=te(this.paths),t.hasZ=this.hasZ,t.hasM=this.hasM,t}getPoint(t,e){if(!this._validateInputs(t,e))return null;const r=this.paths[t][e],i=this.hasZ,s=this.hasM;return i&&!s?new _t(r[0],r[1],r[2],void 0,this.spatialReference):s&&!i?new _t(r[0],r[1],void 0,r[2],this.spatialReference):i&&s?new _t(r[0],r[1],r[2],r[3],this.spatialReference):new _t(r[0],r[1],this.spatialReference)}insertPoint(t,e,r){return this._validateInputs(t,e,!0)?(YS(this,r),Array.isArray(r)||(r=r.toArray()),this.paths[t].splice(e,0,r),this.notifyChange("paths"),this):this}removePath(t){if(!this._validateInputs(t,null))return null;const e=this.paths.splice(t,1)[0],r=this.spatialReference,i=e.map(s=>new _t(s,r));return this.notifyChange("paths"),i}removePoint(t,e){if(!this._validateInputs(t,e))return null;const r=new _t(this.paths[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("paths"),r}setPoint(t,e,r){return this._validateInputs(t,e)?(YS(this,r),Array.isArray(r)||(r=r.toArray()),this.paths[t][e]=r,this.notifyChange("paths"),this):this}_validateInputs(t,e,r=!1){if(t==null||t<0||t>=this.paths.length)return!1;if(e!=null){const i=this.paths[t];if(r&&(e<0||e>i.length)||!r&&(e<0||e>=i.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],C0.prototype,"cache",null),u([d({readOnly:!0})],C0.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],C0.prototype,"paths",void 0),u([ke("paths")],C0.prototype,"writePaths",null),C0=dz=u([P("esri.geometry.Polyline")],C0),C0.prototype.toJSON.isDefaultToJSON=!0;const ip=C0,yfe=Ra()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),fee=Ra()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function _fe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function oX(t){return t.points!==void 0}function aX(t){return t.x!==void 0&&t.y!==void 0}function lX(t){return t.paths!==void 0}function rw(t){return t.rings!==void 0}function um(t){return C(t)?null:t instanceof xv?t:aX(t)?_t.fromJSON(t):lX(t)?ip.fromJSON(t):rw(t)?bp.fromJSON(t):oX(t)?OM.fromJSON(t):_fe(t)?Hr.fromJSON(t):null}function zE(t){return t?aX(t)?"esriGeometryPoint":lX(t)?"esriGeometryPolyline":rw(t)?"esriGeometryPolygon":_fe(t)?"esriGeometryEnvelope":oX(t)?"esriGeometryMultipoint":null:null}const HLe={esriGeometryPoint:_t,esriGeometryPolyline:ip,esriGeometryPolygon:bp,esriGeometryEnvelope:Hr,esriGeometryMultipoint:OM};function qLe(t){return t&&HLe[t]||null}const tx={base:xv,key:"type",typeMap:{extent:Hr,multipoint:OM,point:_t,polyline:ip,polygon:bp}};_p(tx);let vfe=0;const MM=t=>{let e=class extends t{constructor(...r){super(...r),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+vfe++})}};return e=u([P("esri.core.Identifiable")],e),e},uSt=t=>{let e=class extends t{constructor(...r){super(...r),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:vfe++})}};return e=u([P("esri.core.NumericIdentifiable")],e),e};let mee=class extends MM(class{}){};mee=u([P("esri.core.Identifiable")],mee);async function WLe(t){const e="portalItem"in t?t:{portalItem:t},r=await ie(()=>import("./portalLayers-adce7908.js"),["./portalLayers-adce7908.js","./lazyLayerLoader-de1ad940.js","./layersLoader-9600ea66.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url);try{return await r.fromItem(e)}catch(i){const s=e&&e.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||Qr.portalUrl;throw se.getLogger("esri.layers.support.fromPortalItem").error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",i),i}}let XLe=0,_o=class extends Fs.EventedMixin(MM(cm)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new Hr(-180,-90,180,90,We.WGS84),this.id=Date.now().toString(16)+"-layer-"+XLe++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=We.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(e){const r=typeof e=="string"?{url:e}:e;return(await ie(()=>import("./arcgisLayers-5c4b4fb0.js"),["./arcgisLayers-5c4b4fb0.js","./fetchService-00d56f7a.js","./lazyLayerLoader-de1ad940.js"],import.meta.url)).fromUrl(r)}static fromPortalItem(e){return WLe(e)}initialize(){this.when().catch(e=>{Ks(e)||se.getLogger(this.declaredClass).error("#load()",`Failed to load layer (title: '${this.title??"no title"}', id: '${this.id??"no id"}')`,{error:e})})}destroy(){if(this.parent){const e=this,r=this.parent;"layers"in r&&r.layers.includes(e)?r.layers.remove(e):"tables"in r&&r.tables.includes(e)?r.tables.remove(e):"baseLayers"in r&&r.baseLayers.includes(e)?r.baseLayers.remove(e):"baseLayers"in r&&r.referenceLayers.includes(e)&&r.referenceLayers.remove(e)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){return lo(this.url)}async fetchAttributionData(){const e=this.attributionDataUrl;if(this.hasAttributionData&&e)return(await Pi(e,{query:{f:"json"},responseType:"json"})).data;throw new j("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],_o.prototype,"attributionDataUrl",void 0),u([d({type:Hr})],_o.prototype,"fullExtent",void 0),u([d({readOnly:!0})],_o.prototype,"hasAttributionData",null),u([d({type:String,clonable:!1})],_o.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],_o.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],_o.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],_o.prototype,"opacity",void 0),u([d({clonable:!1})],_o.prototype,"parent",void 0),u([d({readOnly:!0})],_o.prototype,"parsedUrl",null),u([d({type:Boolean})],_o.prototype,"popupEnabled",void 0),u([d({type:Boolean})],_o.prototype,"attributionVisible",void 0),u([d({type:We})],_o.prototype,"spatialReference",void 0),u([d({type:String})],_o.prototype,"title",void 0),u([d({readOnly:!0,json:{read:!1}})],_o.prototype,"type",void 0),u([d()],_o.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],_o.prototype,"visible",void 0),_o=u([P("esri.layers.Layer")],_o);const h3=_o;function pz(t,e,r){let i,s;if(t)for(let n=0,o=t.length;n<o;n++){if(i=t.getItemAt(n),i[e]===r)return i;if((i==null?void 0:i.type)==="group"&&(s=pz(i.layers,e,r),s))return s}}const YLe=t=>{let e=class extends t{constructor(...r){super(...r),this.layers=new ft;const i=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||se.getLogger(this.declaredClass).error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.layers.on("before-add",o=>i(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))}destroy(){const r=this.layers.removeAll();for(const i of r)this.layerRemoved(i),i.destroy();this.layers.destroy()}set layers(r){this._set("layers",sy(r,this._get("layers")))}add(r,i){const s=this.layers;if(i=s.getNextIndex(i),r instanceof h3){const n=r;n.parent===this?this.reorder(n,i):s.add(n,i)}else Gu(r)?r.then(n=>{this.destroyed||this.add(n,i)}):se.getLogger(this.declaredClass).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(r,i){const s=this.layers;let n=s.getNextIndex(i);r.slice().forEach(o=>{o.parent!==this?(s.add(o,n),n+=1):this.reorder(o,n)})}findLayerById(r){return pz(this.layers,"id",r)}findLayerByUid(r){return pz(this.layers,"uid",r)}remove(r){return this.layers.remove(r)}removeMany(r){return this.layers.removeMany(r)}removeAll(){return this.layers.removeAll()}reorder(r,i){return this.layers.reorder(r,i)}layerAdded(r){}layerRemoved(r){}};return u([d()],e.prototype,"layers",null),e=u([P("esri.support.LayersMixin")],e),e};function fz(t,e,r){if(t)for(let i=0,s=t.length;i<s;i++){const n=t.getItemAt(i);if(n[e]===r)return n;if((n==null?void 0:n.type)==="group"){const o=fz(n.tables,e,r);if(o)return o}}}const ZLe=t=>{let e=class extends t{constructor(...r){super(...r),this.tables=new ft,this.tables.on("after-add",i=>{const s=i.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&se.getLogger(this.declaredClass).error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",i=>{i.item.parent=null})}destroy(){const r=this.tables.removeAll();for(const i of r)i.destroy();this.tables.destroy()}set tables(r){this._set("tables",sy(r,this._get("tables")))}findTableById(r){return fz(this.tables,"id",r)}findTableByUid(r){return fz(this.tables,"uid",r)}};return u([d()],e.prototype,"tables",null),e=u([P("esri.support.TablesMixin")],e),e};let of=class extends ZLe(YLe(Fs.EventedMixin(Te))){constructor(e){super(e),this.allLayers=new u3({getCollections:()=>{var r,i,s;return[(r=this.basemap)==null?void 0:r.baseLayers,(i=this.ground)==null?void 0:i.layers,this.layers,(s=this.basemap)==null?void 0:s.referenceLayers]},getChildrenFunction:r=>"layers"in r?r.layers:null}),this.allTables=ELe(this),this.basemap=null,this.editableLayers=new u3({getCollections:()=>[this.allLayers],itemFilterFunction:vLe}),this.ground=new c3,this._basemapCache=bLe()}destroy(){var e,r;this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),(e=this.ground)==null||e.destroy(),(r=this.basemap)==null||r.destroy(),wLe(this._basemapCache),this._basemapCache=null}castBasemap(e){return eX(e,this._basemapCache)}castGround(e){const r=CLe(e);return C(r)?this._get("ground"):r}findLayerById(e){return this.allLayers.find(r=>r.id===e)}findTableById(e){return this.allTables.find(r=>r.id===e)}};u([d({readOnly:!0,dependsOn:[]})],of.prototype,"allLayers",void 0),u([d({readOnly:!0})],of.prototype,"allTables",void 0),u([d({type:HS})],of.prototype,"basemap",void 0),u([Gt("basemap")],of.prototype,"castBasemap",null),u([d({readOnly:!0})],of.prototype,"editableLayers",void 0),u([d({type:c3,nonNullable:!0})],of.prototype,"ground",void 0),u([Gt("ground")],of.prototype,"castGround",null),of=u([P("esri.Map")],of);const bfe=of,bs=t=>{let e=class extends t{clone(){var l;const r=Fl(nl(this),"unable to clone instance of non-accessor class"),i=r.metadatas,s=r.store,n={},o=new Map;for(const c in i){const h=i[c],p=s==null?void 0:s.originOf(c),f=h.clonable;if(h.readOnly||f===!1||p!==Gr.USER&&p!==Gr.DEFAULTS&&p!==Gr.WEB_MAP&&p!==Gr.WEB_SCENE)continue;const m=this[c];let y=null;y=typeof f=="function"?f(m):f==="reference"?m:Ek(m),m!=null&&y==null||(p===Gr.DEFAULTS?o.set(c,y):n[c]=y)}const a=new(Object.getPrototypeOf(this)).constructor(n);if(o.size){const c=(l=nl(a))==null?void 0:l.store;if(c)for(const[h,p]of o)c.set(h,p,Gr.DEFAULTS)}return a}};return e=u([P("esri.core.Clonable")],e),e};let gee=class extends bs(Te){};gee=u([P("esri.core.Clonable")],gee);let ev=class{constructor(e,r){this.min=e,this.max=r,this.range=r-e}ndiff(e,r=0){return Math.ceil((e-r)/this.range)*this.range+r}_normalize(e,r,i,s=0,n=!1){return(i-=s)<e?i+=this.ndiff(e-i):i>r&&(i-=this.ndiff(i-r)),n&&i===r&&(i=e),i+s}normalize(e,r=0,i=!1){return this._normalize(this.min,this.max,e,r,i)}clamp(e,r=0){return ye(e-r,this.min,this.max)+r}monotonic(e,r,i){return e<r?r:r+this.ndiff(e-r,i)}minimalMonotonic(e,r,i){return this._normalize(e,e+this.range,r,i)}center(e,r,i){return r=this.monotonic(e,r,i),this.normalize((e+r)/2,i)}diff(e,r,i){return this.monotonic(e,r,i)-e}shortestSignedDiff(e,r){e=this.normalize(e);const i=(r=this.normalize(r))-e,s=r<e?this.minimalMonotonic(e,r)-e:r-this.minimalMonotonic(r,e);return Math.abs(i)<Math.abs(s)?i:s}contains(e,r,i){return r=this.minimalMonotonic(e,r),(i=this.minimalMonotonic(e,i))>e&&i<r}};function cX(t){for(const e in t){const r=t[e];r instanceof Function&&(t[e]=r.bind(t))}return t}const JLe=cX(new ev(0,2*Math.PI)),tv=cX(new ev(-Math.PI,Math.PI)),uX=cX(new ev(0,360));let ig=class extends bs(fe){constructor(...e){super(...e),this.position=new _t([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(e,r,i,s){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const n={position:e};return r!=null&&(n.heading=r),i!=null&&(n.tilt=i),s!=null&&(n.fov=s),n}return e}writePosition(e,r,i,s){const n=e.clone();n.x=Ch(e.x||0),n.y=Ch(e.y||0),n.z=e.hasZ?Ch(e.z||0):e.z,r[i]=n.write({},s)}readPosition(e,r){const i=new _t;return i.read(e,r),i.x=Ch(i.x||0),i.y=Ch(i.y||0),i.z=i.hasZ?Ch(i.z||0):i.z,i}equals(e){return!C(e)&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}};u([d({type:_t,json:{write:{isRequired:!0}}})],ig.prototype,"position",void 0),u([ke("position")],ig.prototype,"writePosition",null),u([Le("position")],ig.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Gt(t=>uX.normalize(Ch(t)))],ig.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Gt(t=>ye(Ch(t),-180,180))],ig.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],ig.prototype,"fov",void 0),ig=u([P("esri.Camera")],ig);const qh=ig;var mz;let A0=mz=class extends fe{constructor(t){super(t),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(t){return(t%=360)<0&&(t+=360),t}clone(){return new mz({rotation:this.rotation,scale:this.scale,targetGeometry:v(this.targetGeometry)?this.targetGeometry.clone():null,camera:v(this.camera)?this.camera.clone():null})}};function xU(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:xU}}}}})],A0.prototype,"rotation",void 0),u([Gt("rotation")],A0.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:xU}}}}})],A0.prototype,"scale",void 0),u([d({types:tx,json:{read:um,write:!0,origins:{"web-scene":{read:um,write:{overridePolicy:xU}}}}})],A0.prototype,"targetGeometry",void 0),u([d({type:qh,json:{write:!0}})],A0.prototype,"camera",void 0),A0=mz=u([P("esri.Viewpoint")],A0);const Vc=A0;let KLe=class wfe{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(Pk),this._values=new Map,this.multipleOriginsSupported=!0}clone(e){const r=new wfe,i=this._originStores[Gr.DEFAULTS];i&&i.forEach((s,n)=>{r.set(n,te(s),Gr.DEFAULTS)});for(let s=Gr.SERVICE;s<Pk;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{e&&e.has(a)||r.set(a,te(o),s)})}return r}get(e,r){const i=r===void 0?this._values:this._originStores[r];return i?i.get(e):void 0}keys(e){const r=e==null?this._values:this._originStores[e];return r?[...r.keys()]:[]}set(e,r,i=Gr.USER){let s=this._originStores[i];if(s||(s=new Map,this._originStores[i]=s),s.set(e,r),!this._values.has(e)||this._propertyOriginMap.get(e)<=i){const n=this._values.get(e);return this._values.set(e,r),this._propertyOriginMap.set(e,i),n!==r}return!1}delete(e,r=Gr.USER){const i=this._originStores[r];if(!i)return;const s=i.get(e);if(i.delete(e),this._values.has(e)&&this._propertyOriginMap.get(e)===r){this._values.delete(e);for(let n=r-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(e)){this._values.set(e,o.get(e)),this._propertyOriginMap.set(e,n);break}}}return s}has(e,r){const i=r===void 0?this._values:this._originStores[r];return!!i&&i.has(e)}revert(e,r){for(;r>0&&!this.has(e,r);)--r;const i=this._originStores[r],s=i&&i.get(e),n=this._values.get(e);return this._values.set(e,s),this._propertyOriginMap.set(e,r),n!==s}originOf(e){return this._propertyOriginMap.get(e)||Gr.DEFAULTS}forEach(e){this._values.forEach(e)}};const xfe=t=>{let e=class extends t{constructor(...r){super(...r);const i=nl(this),s=i.store,n=new KLe;i.store=n,Yde(i,s,n)}read(r,i){Jde(this,r,i)}getAtOrigin(r,i){const s=TU(this),n=x_(i);if(typeof r=="string")return s.get(r,n);const o={};return r.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(r){return MN(this.originIdOf(r))}originIdOf(r){return TU(this).originOf(r)}revert(r,i){const s=TU(this),n=x_(i),o=nl(this);let a;a=typeof r=="string"?r==="*"?s.keys(n):[r]:r,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return e=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],e),e};function TU(t){return nl(t).store}let yee=class extends xfe(Te){};yee=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],yee);const QLe=t=>{let e=class extends t{constructor(...r){super(...r)}clear(r,i="user"){return SU(this).delete(r,x_(i))}write(r={},i){return epe(this,r=r||{},i),r}setAtOrigin(r,i,s){nl(this).setAtOrigin(r,i,x_(s))}removeOrigin(r){const i=SU(this),s=x_(r),n=i.keys(s);for(const o of n)i.originOf(o)===s&&i.set(o,i.get(o,s),Gr.USER)}updateOrigin(r,i){const s=SU(this),n=x_(i),o=this.get(r);for(let a=n+1;a<Pk;++a)s.delete(r,a);s.set(r,o,n)}toJSON(r){return this.write({},r)}};return e=u([P("esri.core.WriteableMultiOriginJSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function SU(t){return nl(t).store}const hX=t=>{let e=class extends QLe(xfe(t)){constructor(...r){super(...r)}};return e=u([P("esri.core.MultiOriginJSONSupport")],e),e};let gz=class extends hX(Te){};gz=u([P("esri.core.MultiOriginJSONSupport")],gz);function eDe(t){return t&&"getAtOrigin"in t&&"originOf"in t}function _ee(t){t&&t.writtenProperties&&t.writtenProperties.forEach(({target:e,propName:r,newOrigin:i})=>{eDe(e)&&i&&e.originOf(r)!==i&&e.updateOrigin(r,i)})}var LA;const JN=Ra()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),Tfe=JN.jsonValues.slice();r3(Tfe,"orthometric");const uO=Ra()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let bd=LA=class extends fe{constructor(t){super(t),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(t,e,r){return JN.write(t,e,r)}readHeightModel(t,e,r){return JN.read(t)||(r&&r.messages&&r.messages.push(tDe(t,{context:r})),null)}readHeightUnit(t,e,r){return uO.read(t)||(r&&r.messages&&r.messages.push(vee(t,{context:r})),null)}readHeightUnitService(t,e,r){return ppe(t)||uO.read(t)||(r&&r.messages&&r.messages.push(vee(t,{context:r})),null)}readVertCRS(t,e){return e.vertCRS||e.ellipsoid||e.geoid}clone(){return new LA({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(t){return!!t&&(this===t||this.heightModel===t.heightModel&&this.heightUnit===t.heightUnit&&this.vertCRS===t.vertCRS)}static deriveUnitFromSR(t,e){const r=iIe(e);return new LA({heightModel:t.heightModel,heightUnit:r,vertCRS:t.vertCRS})}write(t,e){return e={origin:"web-scene",...e},super.write(t,e)}static fromJSON(t){if(!t)return null;const e=new LA;return e.read(t,{origin:"web-scene"}),e}};function vee(t,e){return new lm("height-unit:unsupported",`Height unit of value '${t}' is not supported`,e)}function tDe(t,e){return new lm("height-model:unsupported",`Height model of value '${t}' is not supported`,e)}u([d({type:JN.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:Tfe,default:"ellipsoidal"}}}})],bd.prototype,"heightModel",void 0),u([ke("web-scene","heightModel")],bd.prototype,"writeHeightModel",null),u([Le(["web-scene","service"],"heightModel")],bd.prototype,"readHeightModel",null),u([d({type:uO.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:uO.jsonValues,write:uO.write}}}})],bd.prototype,"heightUnit",void 0),u([Le("web-scene","heightUnit")],bd.prototype,"readHeightUnit",null),u([Le("service","heightUnit")],bd.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],bd.prototype,"vertCRS",void 0),u([Le("service","vertCRS",["vertCRS","ellipsoid","geoid"])],bd.prototype,"readVertCRS",null),bd=LA=u([P("esri.geometry.HeightModelInfo")],bd);const Tv=bd;function kn(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Tm(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_,b){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t[9]=h,t[10]=p,t[11]=f,t[12]=m,t[13]=y,t[14]=_,t[15]=b,t}function Wh(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function kc(t,e){if(t===e){const r=e[1],i=e[2],s=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=s,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function BE(t,e){return Lo(t,e)||Wh(t),t}function Lo(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],_=e[13],b=e[14],x=e[15],T=r*a-i*o,S=r*l-s*o,E=r*c-n*o,O=i*l-s*a,R=i*c-n*a,L=s*c-n*l,I=h*_-p*y,U=h*b-f*y,z=h*x-m*y,B=p*b-f*_,G=p*x-m*_,K=f*x-m*b;let re=T*K-S*G+E*B+O*z-R*U+L*I;return re?(re=1/re,t[0]=(a*K-l*G+c*B)*re,t[1]=(s*G-i*K-n*B)*re,t[2]=(_*L-b*R+x*O)*re,t[3]=(f*R-p*L-m*O)*re,t[4]=(l*z-o*K-c*U)*re,t[5]=(r*K-s*z+n*U)*re,t[6]=(b*E-y*L-x*S)*re,t[7]=(h*L-f*E+m*S)*re,t[8]=(o*G-a*z+c*I)*re,t[9]=(i*z-r*G-n*I)*re,t[10]=(y*R-_*E+x*T)*re,t[11]=(p*E-h*R-m*T)*re,t[12]=(a*U-o*B-l*I)*re,t[13]=(r*B-i*U+s*I)*re,t[14]=(_*S-y*O-b*T)*re,t[15]=(h*O-p*S+f*T)*re,t):null}function rDe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],_=e[13],b=e[14],x=e[15];return t[0]=a*(f*x-m*b)-p*(l*x-c*b)+_*(l*m-c*f),t[1]=-(i*(f*x-m*b)-p*(s*x-n*b)+_*(s*m-n*f)),t[2]=i*(l*x-c*b)-a*(s*x-n*b)+_*(s*c-n*l),t[3]=-(i*(l*m-c*f)-a*(s*m-n*f)+p*(s*c-n*l)),t[4]=-(o*(f*x-m*b)-h*(l*x-c*b)+y*(l*m-c*f)),t[5]=r*(f*x-m*b)-h*(s*x-n*b)+y*(s*m-n*f),t[6]=-(r*(l*x-c*b)-o*(s*x-n*b)+y*(s*c-n*l)),t[7]=r*(l*m-c*f)-o*(s*m-n*f)+h*(s*c-n*l),t[8]=o*(p*x-m*_)-h*(a*x-c*_)+y*(a*m-c*p),t[9]=-(r*(p*x-m*_)-h*(i*x-n*_)+y*(i*m-n*p)),t[10]=r*(a*x-c*_)-o*(i*x-n*_)+y*(i*c-n*a),t[11]=-(r*(a*m-c*p)-o*(i*m-n*p)+h*(i*c-n*a)),t[12]=-(o*(p*b-f*_)-h*(a*b-l*_)+y*(a*f-l*p)),t[13]=r*(p*b-f*_)-h*(i*b-s*_)+y*(i*f-s*p),t[14]=-(r*(a*b-l*_)-o*(i*b-s*_)+y*(i*l-s*a)),t[15]=r*(a*f-l*p)-o*(i*f-s*p)+h*(i*l-s*a),t}function iDe(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11],m=t[12],y=t[13],_=t[14],b=t[15];return(e*o-r*n)*(p*b-f*_)-(e*a-i*n)*(h*b-f*y)+(e*l-s*n)*(h*_-p*y)+(r*a-i*o)*(c*b-f*m)-(r*l-s*o)*(c*_-p*m)+(i*l-s*a)*(c*y-h*m)}function ys(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=e[9],m=e[10],y=e[11],_=e[12],b=e[13],x=e[14],T=e[15];let S=r[0],E=r[1],O=r[2],R=r[3];return t[0]=S*i+E*a+O*p+R*_,t[1]=S*s+E*l+O*f+R*b,t[2]=S*n+E*c+O*m+R*x,t[3]=S*o+E*h+O*y+R*T,S=r[4],E=r[5],O=r[6],R=r[7],t[4]=S*i+E*a+O*p+R*_,t[5]=S*s+E*l+O*f+R*b,t[6]=S*n+E*c+O*m+R*x,t[7]=S*o+E*h+O*y+R*T,S=r[8],E=r[9],O=r[10],R=r[11],t[8]=S*i+E*a+O*p+R*_,t[9]=S*s+E*l+O*f+R*b,t[10]=S*n+E*c+O*m+R*x,t[11]=S*o+E*h+O*y+R*T,S=r[12],E=r[13],O=r[14],R=r[15],t[12]=S*i+E*a+O*p+R*_,t[13]=S*s+E*l+O*f+R*b,t[14]=S*n+E*c+O*m+R*x,t[15]=S*o+E*h+O*y+R*T,t}function ql(t,e,r){const i=r[0],s=r[1],n=r[2];if(e===t)t[12]=e[0]*i+e[4]*s+e[8]*n+e[12],t[13]=e[1]*i+e[5]*s+e[9]*n+e[13],t[14]=e[2]*i+e[6]*s+e[10]*n+e[14],t[15]=e[3]*i+e[7]*s+e[11]*n+e[15];else{const o=e[0],a=e[1],l=e[2],c=e[3],h=e[4],p=e[5],f=e[6],m=e[7],y=e[8],_=e[9],b=e[10],x=e[11];t[0]=o,t[1]=a,t[2]=l,t[3]=c,t[4]=h,t[5]=p,t[6]=f,t[7]=m,t[8]=y,t[9]=_,t[10]=b,t[11]=x,t[12]=o*i+h*s+y*n+e[12],t[13]=a*i+p*s+_*n+e[13],t[14]=l*i+f*s+b*n+e[14],t[15]=c*i+m*s+x*n+e[15]}return t}function t5(t,e,r){const i=r[0],s=r[1],n=r[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Mc(t,e,r,i){let s,n,o,a,l,c,h,p,f,m,y,_,b,x,T,S,E,O,R,L,I,U,z,B,G=i[0],K=i[1],re=i[2],ee=Math.sqrt(G*G+K*K+re*re);return ee<Oa()?null:(ee=1/ee,G*=ee,K*=ee,re*=ee,s=Math.sin(r),n=Math.cos(r),o=1-n,a=e[0],l=e[1],c=e[2],h=e[3],p=e[4],f=e[5],m=e[6],y=e[7],_=e[8],b=e[9],x=e[10],T=e[11],S=G*G*o+n,E=K*G*o+re*s,O=re*G*o-K*s,R=G*K*o-re*s,L=K*K*o+n,I=re*K*o+G*s,U=G*re*o+K*s,z=K*re*o-G*s,B=re*re*o+n,t[0]=a*S+p*E+_*O,t[1]=l*S+f*E+b*O,t[2]=c*S+m*E+x*O,t[3]=h*S+y*E+T*O,t[4]=a*R+p*L+_*I,t[5]=l*R+f*L+b*I,t[6]=c*R+m*L+x*I,t[7]=h*R+y*L+T*I,t[8]=a*U+p*z+_*B,t[9]=l*U+f*z+b*B,t[10]=c*U+m*z+x*B,t[11]=h*U+y*z+T*B,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function JS(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*s+c*i,t[5]=o*s+h*i,t[6]=a*s+p*i,t[7]=l*s+f*i,t[8]=c*s-n*i,t[9]=h*s-o*i,t[10]=p*s-a*i,t[11]=f*s-l*i,t}function r5(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[0],o=e[1],a=e[2],l=e[3],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s-c*i,t[1]=o*s-h*i,t[2]=a*s-p*i,t[3]=l*s-f*i,t[8]=n*i+c*s,t[9]=o*i+h*s,t[10]=a*i+p*s,t[11]=l*i+f*s,t}function KS(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[0],o=e[1],a=e[2],l=e[3],c=e[4],h=e[5],p=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s+c*i,t[1]=o*s+h*i,t[2]=a*s+p*i,t[3]=l*s+f*i,t[4]=c*s-n*i,t[5]=h*s-o*i,t[6]=p*s-a*i,t[7]=f*s-l*i,t}function i5(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function sDe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Fu(t,e,r){if(e===0)return Wh(t);let i,s,n,o=r[0],a=r[1],l=r[2],c=Math.sqrt(o*o+a*a+l*l);return c<Oa()?null:(c=1/c,o*=c,a*=c,l*=c,i=Math.sin(e),s=Math.cos(e),n=1-s,t[0]=o*o*n+s,t[1]=a*o*n+l*i,t[2]=l*o*n-a*i,t[3]=0,t[4]=o*a*n-l*i,t[5]=a*a*n+s,t[6]=l*a*n+o*i,t[7]=0,t[8]=o*l*n+a*i,t[9]=a*l*n-o*i,t[10]=l*l*n+s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Sfe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function nDe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Efe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Cfe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=i+i,l=s+s,c=n+n,h=i*a,p=i*l,f=i*c,m=s*l,y=s*c,_=n*c,b=o*a,x=o*l,T=o*c;return t[0]=1-(m+_),t[1]=p+T,t[2]=f-x,t[3]=0,t[4]=p-T,t[5]=1-(h+_),t[6]=y+b,t[7]=0,t[8]=f+x,t[9]=y-b,t[10]=1-(h+m),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function oDe(t,e){const r=aDe,i=-e[0],s=-e[1],n=-e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=i*i+s*s+n*n+o*o;return p>0?(r[0]=2*(a*o+h*i+l*n-c*s)/p,r[1]=2*(l*o+h*s+c*i-a*n)/p,r[2]=2*(c*o+h*n+a*s-l*i)/p):(r[0]=2*(a*o+h*i+l*n-c*s),r[1]=2*(l*o+h*s+c*i-a*n),r[2]=2*(c*o+h*n+a*s-l*i)),Cfe(t,e,r),t}const aDe=M();function lDe(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function Afe(t,e){const r=e[0],i=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return t[0]=Math.sqrt(r*r+i*i+s*s),t[1]=Math.sqrt(n*n+o*o+a*a),t[2]=Math.sqrt(l*l+c*c+h*h),t}function cDe(t,e){const r=e[0]+e[5]+e[10];let i=0;return r>0?(i=2*Math.sqrt(r+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i),t}function uDe(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,m=s*h,y=n*c,_=n*h,b=o*h,x=a*l,T=a*c,S=a*h,E=i[0],O=i[1],R=i[2];return t[0]=(1-(y+b))*E,t[1]=(f+S)*E,t[2]=(m-T)*E,t[3]=0,t[4]=(f-S)*O,t[5]=(1-(p+b))*O,t[6]=(_+x)*O,t[7]=0,t[8]=(m+T)*R,t[9]=(_-x)*R,t[10]=(1-(p+y))*R,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function hDe(t,e,r,i,s){const n=e[0],o=e[1],a=e[2],l=e[3],c=n+n,h=o+o,p=a+a,f=n*c,m=n*h,y=n*p,_=o*h,b=o*p,x=a*p,T=l*c,S=l*h,E=l*p,O=i[0],R=i[1],L=i[2],I=s[0],U=s[1],z=s[2],B=(1-(_+x))*O,G=(m+E)*O,K=(y-S)*O,re=(m-E)*R,ee=(1-(f+x))*R,q=(b+T)*R,$=(y+S)*L,N=(b-T)*L,F=(1-(f+_))*L;return t[0]=B,t[1]=G,t[2]=K,t[3]=0,t[4]=re,t[5]=ee,t[6]=q,t[7]=0,t[8]=$,t[9]=N,t[10]=F,t[11]=0,t[12]=r[0]+I-(B*I+re*U+$*z),t[13]=r[1]+U-(G*I+ee*U+N*z),t[14]=r[2]+z-(K*I+q*U+F*z),t[15]=1,t}function dDe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r+r,a=i+i,l=s+s,c=r*o,h=i*o,p=i*a,f=s*o,m=s*a,y=s*l,_=n*o,b=n*a,x=n*l;return t[0]=1-p-y,t[1]=h+x,t[2]=f-b,t[3]=0,t[4]=h-x,t[5]=1-c-y,t[6]=m+_,t[7]=0,t[8]=f+b,t[9]=m-_,t[10]=1-c-p,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Rfe(t,e,r,i,s,n,o){const a=1/(r-e),l=1/(s-i),c=1/(n-o);return t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(r+e)*a,t[9]=(s+i)*l,t[10]=(o+n)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*n*2*c,t[15]=0,t}function pDe(t,e,r,i,s){const n=1/Math.tan(e/2);let o;return t[0]=n/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,s!=null&&s!==1/0?(o=1/(i-s),t[10]=(s+i)*o,t[14]=2*s*i*o):(t[10]=-1,t[14]=-2*i),t}function fDe(t,e,r,i){const s=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(o-a)*l*.5,t[9]=(s-n)*c*.5,t[10]=i/(r-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*r/(r-i),t[15]=0,t}function Ofe(t,e,r,i,s,n,o){const a=1/(e-r),l=1/(i-s),c=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*a,t[13]=(s+i)*l,t[14]=(o+n)*c,t[15]=1,t}function s5(t,e,r,i){let s,n,o,a,l,c,h,p,f,m;const y=e[0],_=e[1],b=e[2],x=i[0],T=i[1],S=i[2],E=r[0],O=r[1],R=r[2],L=Oa();return Math.abs(y-E)<L&&Math.abs(_-O)<L&&Math.abs(b-R)<L?Wh(t):(h=y-E,p=_-O,f=b-R,m=1/Math.sqrt(h*h+p*p+f*f),h*=m,p*=m,f*=m,s=T*f-S*p,n=S*h-x*f,o=x*p-T*h,m=Math.sqrt(s*s+n*n+o*o),m?(m=1/m,s*=m,n*=m,o*=m):(s=0,n=0,o=0),a=p*o-f*n,l=f*s-h*o,c=h*n-p*s,m=Math.sqrt(a*a+l*l+c*c),m?(m=1/m,a*=m,l*=m,c*=m):(a=0,l=0,c=0),t[0]=s,t[1]=a,t[2]=h,t[3]=0,t[4]=n,t[5]=l,t[6]=p,t[7]=0,t[8]=o,t[9]=c,t[10]=f,t[11]=0,t[12]=-(s*y+n*_+o*b),t[13]=-(a*y+l*_+c*b),t[14]=-(h*y+p*_+f*b),t[15]=1,t)}function Mfe(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=i[0],l=i[1],c=i[2];let h=s-r[0],p=n-r[1],f=o-r[2],m=h*h+p*p+f*f;m>0&&(m=1/Math.sqrt(m),h*=m,p*=m,f*=m);let y=l*f-c*p,_=c*h-a*f,b=a*p-l*h;return m=y*y+_*_+b*b,m>0&&(m=1/Math.sqrt(m),y*=m,_*=m,b*=m),t[0]=y,t[1]=_,t[2]=b,t[3]=0,t[4]=p*b-f*_,t[5]=f*y-h*b,t[6]=h*_-p*y,t[7]=0,t[8]=h,t[9]=p,t[10]=f,t[11]=0,t[12]=s,t[13]=n,t[14]=o,t[15]=1,t}function mDe(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function gDe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2+t[9]**2+t[10]**2+t[11]**2+t[12]**2+t[13]**2+t[14]**2+t[15]**2)}function yDe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t}function Pfe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}function _De(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t}function vDe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t[9]=e[9]+r[9]*i,t[10]=e[10]+r[10]*i,t[11]=e[11]+r[11]*i,t[12]=e[12]+r[12]*i,t[13]=e[13]+r[13]*i,t[14]=e[14]+r[14]*i,t[15]=e[15]+r[15]*i,t}function Ife(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function dX(t,e){if(t===e)return!0;const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],m=t[11],y=t[12],_=t[13],b=t[14],x=t[15],T=e[0],S=e[1],E=e[2],O=e[3],R=e[4],L=e[5],I=e[6],U=e[7],z=e[8],B=e[9],G=e[10],K=e[11],re=e[12],ee=e[13],q=e[14],$=e[15],N=Oa();return Math.abs(r-T)<=N*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(i-S)<=N*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(s-E)<=N*Math.max(1,Math.abs(s),Math.abs(E))&&Math.abs(n-O)<=N*Math.max(1,Math.abs(n),Math.abs(O))&&Math.abs(o-R)<=N*Math.max(1,Math.abs(o),Math.abs(R))&&Math.abs(a-L)<=N*Math.max(1,Math.abs(a),Math.abs(L))&&Math.abs(l-I)<=N*Math.max(1,Math.abs(l),Math.abs(I))&&Math.abs(c-U)<=N*Math.max(1,Math.abs(c),Math.abs(U))&&Math.abs(h-z)<=N*Math.max(1,Math.abs(h),Math.abs(z))&&Math.abs(p-B)<=N*Math.max(1,Math.abs(p),Math.abs(B))&&Math.abs(f-G)<=N*Math.max(1,Math.abs(f),Math.abs(G))&&Math.abs(m-K)<=N*Math.max(1,Math.abs(m),Math.abs(K))&&Math.abs(y-re)<=N*Math.max(1,Math.abs(y),Math.abs(re))&&Math.abs(_-ee)<=N*Math.max(1,Math.abs(_),Math.abs(ee))&&Math.abs(b-q)<=N*Math.max(1,Math.abs(b),Math.abs(q))&&Math.abs(x-$)<=N*Math.max(1,Math.abs(x),Math.abs($))}function pX(t){const e=Oa(),r=t[0],i=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return Math.abs(1-(r*r+n*n+l*l))<=e&&Math.abs(1-(i*i+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}function n5(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[8]===0&&t[9]===0&&t[10]===1}const bDe=ys,wDe=Pfe;Object.freeze(Object.defineProperty({__proto__:null,add:yDe,adjoint:rDe,copy:kn,determinant:iDe,equals:dX,exactEquals:Ife,frob:gDe,fromQuat:dDe,fromQuat2:oDe,fromRotation:Fu,fromRotationTranslation:Cfe,fromRotationTranslationScale:uDe,fromRotationTranslationScaleOrigin:hDe,fromScaling:sDe,fromTranslation:i5,fromXRotation:Sfe,fromYRotation:nDe,fromZRotation:Efe,frustum:Rfe,getRotation:cDe,getScaling:Afe,getTranslation:lDe,hasIdentityRotation:n5,identity:Wh,invert:Lo,invertOrIdentity:BE,isOrthoNormal:pX,lookAt:s5,mul:bDe,multiply:ys,multiplyScalar:_De,multiplyScalarAndAdd:vDe,ortho:Ofe,perspective:pDe,perspectiveFromFieldOfView:fDe,rotate:Mc,rotateX:JS,rotateY:r5,rotateZ:KS,scale:t5,set:Tm,str:mDe,sub:wDe,subtract:Pfe,targetTo:Mfe,translate:ql,transpose:kc},Symbol.toStringTag,{value:"Module"}));let EU,oe=null;function $fe(){return!!oe}function xDe(){return!!de("esri-wasm")}function Lfe(){return EU||(EU=ie(()=>import("./pe-wasm-67793c2f.js"),[],import.meta.url).then(t=>t.p).then(({default:t})=>t({locateFile:e=>Kr(`esri/geometry/support/${e}`)})).then(t=>{Nfe(t)}),EU)}var yz,Bs,_z;(function(t){function e(n,o,a){oe.ensureCache.prepare();const l=Cb(a),c=a===l,h=oe.ensureFloat64(l),p=oe._pe_geog_to_proj(oe.getPointer(n),o,h);return p&&p_(a,o,h,c),p}function r(n,o,a,l){switch(l){case Bs.PE_TRANSFORM_P_TO_G:return i(n,o,a);case Bs.PE_TRANSFORM_G_TO_P:return e(n,o,a)}return 0}function i(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){oe.ensureCache.prepare();const c=Cb(a),h=a===c,p=oe.ensureFloat64(c),f=oe._pe_proj_to_geog_center(oe.getPointer(n),o,p,l);return f&&p_(a,o,p,h),f}t.geogToProj=e,t.projGeog=r,t.projToGeog=i,t.projToGeogCenter=s})(yz||(yz={})),function(t){function e(){t.PE_BUFFER_MAX=oe.PeDefs.prototype.PE_BUFFER_MAX,t.PE_NAME_MAX=oe.PeDefs.prototype.PE_NAME_MAX,t.PE_MGRS_MAX=oe.PeDefs.prototype.PE_MGRS_MAX,t.PE_USNG_MAX=oe.PeDefs.prototype.PE_USNG_MAX,t.PE_DD_MAX=oe.PeDefs.prototype.PE_DD_MAX,t.PE_DDM_MAX=oe.PeDefs.prototype.PE_DDM_MAX,t.PE_DMS_MAX=oe.PeDefs.prototype.PE_DMS_MAX,t.PE_UTM_MAX=oe.PeDefs.prototype.PE_UTM_MAX,t.PE_PARM_MAX=oe.PeDefs.prototype.PE_PARM_MAX,t.PE_TYPE_NONE=oe.PeDefs.prototype.PE_TYPE_NONE,t.PE_TYPE_GEOGCS=oe.PeDefs.prototype.PE_TYPE_GEOGCS,t.PE_TYPE_PROJCS=oe.PeDefs.prototype.PE_TYPE_PROJCS,t.PE_TYPE_GEOGTRAN=oe.PeDefs.prototype.PE_TYPE_GEOGTRAN,t.PE_TYPE_COORDSYS=oe.PeDefs.prototype.PE_TYPE_COORDSYS,t.PE_TYPE_UNIT=oe.PeDefs.prototype.PE_TYPE_UNIT,t.PE_TYPE_LINUNIT=oe.PeDefs.prototype.PE_TYPE_LINUNIT,t.PE_STR_OPTS_NONE=oe.PeDefs.prototype.PE_STR_OPTS_NONE,t.PE_STR_AUTH_NONE=oe.PeDefs.prototype.PE_STR_AUTH_NONE,t.PE_STR_AUTH_TOP=oe.PeDefs.prototype.PE_STR_AUTH_TOP,t.PE_STR_NAME_CANON=oe.PeDefs.prototype.PE_STR_NAME_CANON,t.PE_PARM_X0=oe.PeDefs.prototype.PE_PARM_X0,t.PE_PARM_ND=oe.PeDefs.prototype.PE_PARM_ND,t.PE_TRANSFORM_1_TO_2=oe.PeDefs.prototype.PE_TRANSFORM_1_TO_2,t.PE_TRANSFORM_2_TO_1=oe.PeDefs.prototype.PE_TRANSFORM_2_TO_1,t.PE_TRANSFORM_P_TO_G=oe.PeDefs.prototype.PE_TRANSFORM_P_TO_G,t.PE_TRANSFORM_G_TO_P=oe.PeDefs.prototype.PE_TRANSFORM_G_TO_P,t.PE_HORIZON_RECT=oe.PeDefs.prototype.PE_HORIZON_RECT,t.PE_HORIZON_POLY=oe.PeDefs.prototype.PE_HORIZON_POLY,t.PE_HORIZON_LINE=oe.PeDefs.prototype.PE_HORIZON_LINE,t.PE_HORIZON_DELTA=oe.PeDefs.prototype.PE_HORIZON_DELTA}t.init=e}(Bs||(Bs={})),function(t){const e={},r={},i=m=>{if(m){const y=m.getType();switch(y){case Bs.PE_TYPE_GEOGCS:m=oe.castObject(m,oe.PeGeogcs);break;case Bs.PE_TYPE_PROJCS:m=oe.castObject(m,oe.PeProjcs);break;case Bs.PE_TYPE_GEOGTRAN:m=oe.castObject(m,oe.PeGeogtran);break;default:y&Bs.PE_TYPE_UNIT&&(m=oe.castObject(m,oe.PeUnit))}}return m};function s(){oe.PeFactory.prototype.initialize(null)}function n(m){return o(Bs.PE_TYPE_COORDSYS,m)}function o(m,y){let _=null,b=e[m];if(b||(b={},e[m]=b),b.hasOwnProperty(String(y)))_=b[y];else{const x=oe.PeFactory.prototype.factoryByType(m,y);oe.compare(x,oe.NULL)||(_=x,b[y]=_)}return _=i(_),_}function a(m,y){let _=null,b=r[m];if(b||(b={},r[m]=b),b.hasOwnProperty(y))_=b[y];else{const x=oe.PeFactory.prototype.fromString(m,y);oe.compare(x,oe.NULL)||(_=x,b[y]=_)}return _=i(_),_}function l(m){return o(Bs.PE_TYPE_GEOGCS,m)}function c(m){return o(Bs.PE_TYPE_GEOGTRAN,m)}function h(m){return oe.PeFactory.prototype.getCode(m)}function p(m){return o(Bs.PE_TYPE_PROJCS,m)}function f(m){return o(Bs.PE_TYPE_UNIT,m)}t.initialize=s,t.coordsys=n,t.factoryByType=o,t.fromString=a,t.geogcs=l,t.geogtran=c,t.getCode=h,t.projcs=p,t.unit=f}(_z||(_z={}));let Dfe=null;var KN,vz,bz,wz,QN,xz,eF,tF,Tz;function Nfe(t){function e(n,o,a){n[o]=a(n[o])}oe=t,Bs.init(),KN.init(),QN.init(),eF.init(),tF.init(),Dfe=class extends oe.PeGCSExtent{destroy(){oe.destroy(this)}};const r=[oe.PeDatum,oe.PeGeogcs,oe.PeGeogtran,oe.PeObject,oe.PeParameter,oe.PePrimem,oe.PeProjcs,oe.PeSpheroid,oe.PeUnit];for(const n of r)e(n.prototype,"getName",o=>function(){return o.call(this,new Array(Bs.PE_NAME_MAX))});for(const n of[oe.PeGeogtran,oe.PeProjcs])e(n.prototype,"getParameters",o=>function(){const a=new Array(Bs.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=oe.getValue(l,"*");a[c]=h?oe.wrapPointer(h,oe.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});e(oe.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return p_(a,o,n.call(this)),a}),e(oe.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=oe._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!oe.compare(l,oe.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=oe.getPointer(l);for(let p=1;p<c;p++)a.push(oe.wrapPointer(h+o*p,oe.PeGTlistExtendedGTs))}}return a}});const i=oe._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!oe.compare(l,oe.NULL)){a=[l];const c=l.getNump();if(c>1){const h=oe.getPointer(l);for(let p=1;p<c;p++)a.push(oe.wrapPointer(h+i*p,oe.PeHorizon))}}return o.set(n,a),a};e(oe.PeProjcs.prototype,"horizonGcsGenerate",s),e(oe.PeProjcs.prototype,"horizonPcsGenerate",s),oe.PeObject.prototype.toString=function(n=Bs.PE_STR_OPTS_NONE){oe.ensureCache.prepare();const o=oe.getPointer(this),a=oe.ensureInt8(new Array(Bs.PE_BUFFER_MAX));return oe.UTF8ToString(oe._pe_object_to_string_ext(o,n,a))}}function Dm(t){if(!t)return;const e=oe.getClass(t);if(!e)return;const r=oe.getCache(e);if(!r)return;const i=oe.getPointer(t);i&&delete r[i]}function PP(t,e){const r=[],i=new Array(e);for(let s=0;s<t;s++)r.push(oe.ensureInt8(i));return r}function Cb(t){let e;return Array.isArray(t[0])?(e=[],t.forEach(r=>{e.push(r[0],r[1])})):e=t,e}function p_(t,e,r,i=!1){if(i)for(let s=0;s<2*e;s++)t[s]=oe.getValue(r+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=t.length===0;for(let n=0;n<e;n++)s&&(t[n]=new Array(2)),t[n][0]=oe.getValue(r,"double"),t[n][1]=oe.getValue(r+Float64Array.BYTES_PER_ELEMENT,"double"),r+=2*Float64Array.BYTES_PER_ELEMENT}}(function(t){let e;function r(){t.PE_GTLIST_OPTS_COMMON=oe.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,e=oe._pe_getPeGTlistExtendedEntrySize()}function i(s,n,o,a,l,c){let h=null;const p=new oe.PeInteger(c);try{const f=oe.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const m=oe.getPointer(f);for(let y=1;y<c;y++)h.push(oe.wrapPointer(m+e*y,oe.PeGTlistExtendedEntry))}}finally{oe.destroy(p)}return h}t.init=r,t.getGTlist=i})(KN||(KN={})),function(t){function e(r){if(r&&r.length){for(const i of r)Dm(i),i.getEntries().forEach(s=>{Dm(s);const n=s.getGeogtran();Dm(n),n.getParameters().forEach(Dm),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{Dm(o);const a=o.getDatum();Dm(a),Dm(a.getSpheroid()),Dm(o.getPrimem()),Dm(o.getUnit())})});oe.PeGTlistExtendedEntry.prototype.Delete(r[0])}}t.destroy=e}(vz||(vz={})),function(t){function e(r,i,s,n,o){oe.ensureCache.prepare();const a=Cb(s),l=s===a,c=oe.ensureFloat64(a);let h=0;n&&(h=oe.ensureFloat64(n));const p=oe._pe_geog_to_geog(oe.getPointer(r),i,c,h,o);return p&&p_(s,i,c,l),p}t.geogToGeog=e}(bz||(bz={})),function(t){const e=(c,h,p,f,m,y)=>{let _,b;switch(oe.ensureCache.prepare(),c){case"dd":_=oe._pe_geog_to_dd,b=Bs.PE_DD_MAX;break;case"ddm":_=oe._pe_geog_to_ddm,b=Bs.PE_DDM_MAX;break;case"dms":_=oe._pe_geog_to_dms,b=Bs.PE_DMS_MAX}let x=0;h&&(x=oe.getPointer(h));const T=Cb(f),S=oe.ensureFloat64(T),E=PP(p,b),O=_(x,p,S,m,oe.ensureInt32(E));if(O)for(let R=0;R<p;R++)y[R]=oe.UTF8ToString(E[R]);return O},r=(c,h,p,f,m)=>{let y;switch(oe.ensureCache.prepare(),c){case"dd":y=oe._pe_dd_to_geog;break;case"ddm":y=oe._pe_ddm_to_geog;break;case"dms":y=oe._pe_dms_to_geog}let _=0;h&&(_=oe.getPointer(h));const b=f.map(E=>oe.ensureString(E)),x=oe.ensureInt32(b),T=oe.ensureFloat64(new Array(2*p)),S=y(_,p,x,T);return S&&p_(m,p,T),S};function i(c,h,p,f,m){return e("dms",c,h,p,f,m)}function s(c,h,p,f){return r("dms",c,h,p,f)}function n(c,h,p,f,m){return e("ddm",c,h,p,f,m)}function o(c,h,p,f){return r("ddm",c,h,p,f)}function a(c,h,p,f,m){return e("dd",c,h,p,f,m)}function l(c,h,p,f){return r("dd",c,h,p,f)}t.geogToDms=i,t.dmsToGeog=s,t.geogToDdm=n,t.ddmToGeog=o,t.geogToDd=a,t.ddToGeog=l}(wz||(wz={})),function(t){function e(){t.PE_MGRS_STYLE_NEW=oe.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,t.PE_MGRS_STYLE_OLD=oe.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,t.PE_MGRS_STYLE_AUTO=oe.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,t.PE_MGRS_180_ZONE_1_PLUS=oe.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,t.PE_MGRS_ADD_SPACES=oe.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function r(s,n,o,a,l,c,h){oe.ensureCache.prepare();let p=0;s&&(p=oe.getPointer(s));const f=Cb(o),m=oe.ensureFloat64(f),y=PP(n,Bs.PE_MGRS_MAX),_=oe.ensureInt32(y),b=oe._pe_geog_to_mgrs_extended(p,n,m,a,l,c,_);if(b)for(let x=0;x<n;x++)h[x]=oe.UTF8ToString(y[x]);return b}function i(s,n,o,a,l){oe.ensureCache.prepare();let c=0;s&&(c=oe.getPointer(s));const h=o.map(y=>oe.ensureString(y)),p=oe.ensureInt32(h),f=oe.ensureFloat64(new Array(2*n)),m=oe._pe_mgrs_to_geog_extended(c,n,p,a,f);return m&&p_(l,n,f),m}t.init=e,t.geogToMgrsExtended=r,t.mgrsToGeogExtended=i}(QN||(QN={})),function(t){function e(i,s,n,o,a,l,c){oe.ensureCache.prepare();let h=0;i&&(h=oe.getPointer(i));const p=Cb(n),f=oe.ensureFloat64(p),m=PP(s,Bs.PE_MGRS_MAX),y=oe.ensureInt32(m),_=oe._pe_geog_to_usng(h,s,f,o,a,l,y);if(_)for(let b=0;b<s;b++)c[b]=oe.UTF8ToString(m[b]);return _}function r(i,s,n,o){oe.ensureCache.prepare();let a=0;i&&(a=oe.getPointer(i));const l=n.map(f=>oe.ensureString(f)),c=oe.ensureInt32(l),h=oe.ensureFloat64(new Array(2*s)),p=oe._pe_usng_to_geog(a,s,c,h);return p&&p_(o,s,h),p}t.geogToUsng=e,t.usngToGeog=r}(xz||(xz={})),function(t){function e(){t.PE_UTM_OPTS_NONE=oe.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,t.PE_UTM_OPTS_ADD_SPACES=oe.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,t.PE_UTM_OPTS_NS=oe.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function r(s,n,o,a,l){oe.ensureCache.prepare();let c=0;s&&(c=oe.getPointer(s));const h=Cb(o),p=oe.ensureFloat64(h),f=PP(n,Bs.PE_UTM_MAX),m=oe.ensureInt32(f),y=oe._pe_geog_to_utm(c,n,p,a,m);if(y)for(let _=0;_<n;_++)l[_]=oe.UTF8ToString(f[_]);return y}function i(s,n,o,a,l){oe.ensureCache.prepare();let c=0;s&&(c=oe.getPointer(s));const h=o.map(y=>oe.ensureString(y)),p=oe.ensureInt32(h),f=oe.ensureFloat64(new Array(2*n)),m=oe._pe_utm_to_geog(c,n,p,a,f);return m&&p_(l,n,f),m}t.init=e,t.geogToUtm=r,t.utmToGeog=i}(eF||(eF={})),function(t){const e=new Map;function r(){t.PE_PCSINFO_OPTION_NONE=oe.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,t.PE_PCSINFO_OPTION_DOMAIN=oe.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,t.PE_POLE_OUTSIDE_BOUNDARY=oe.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,t.PE_POLE_POINT=oe.PePCSInfo.prototype.PE_POLE_POINT}function i(s,n=t.PE_PCSINFO_OPTION_DOMAIN){let o=null,a=null;return e.has(s)&&(a=e.get(s),a[n]&&(o=a[n])),o||(o=oe.PePCSInfo.prototype.generate(s,n),a||(a=[],e.set(s,a)),a[n]=o),o}t.init=r,t.generate=i}(tF||(tF={})),function(t){function e(){return oe.PeVersion.prototype.version_string()}t.versionString=e}(Tz||(Tz={}));const TDe=Object.freeze(Object.defineProperty({__proto__:null,get PeCSTransformations(){return yz},get PeDefs(){return Bs},get PeFactory(){return _z},get PeGCSExtent(){return Dfe},get PeGTTransformations(){return bz},get PeGTlistExtended(){return KN},get PeGTlistExtendedEntry(){return vz},get PeNotationDms(){return wz},get PeNotationMgrs(){return QN},get PeNotationUsng(){return xz},get PeNotationUtm(){return eF},get PePCSInfo(){return tF},get PeVersion(){return Tz},_init:Nfe,get _pe(){return oe},isLoaded:$fe,isSupported:xDe,load:Lfe},Symbol.toStringTag,{value:"Module"}));function hr(t=ADe){return[t[0],t[1],t[2],t[3]]}function vSt(t){return[t[0],t[1],t[2],t[3]]}function oy(t,e){return t!==e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t}function fX(t,e,r,i,s=hr()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function Ffe(t,e=hr()){return e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax,e}function o5(t,e){return new Hr({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}function mX(t,e){e[0]<t[0]&&(t[0]=e[0]),e[0]>t[2]&&(t[2]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>t[3]&&(t[3]=e[1])}function z_(t,e,r){if(C(e))oy(r,t);else if("length"in e)Cz(e)?(r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r[3]=Math.max(t[3],e[3])):e.length!==2&&e.length!==3||(r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.max(t[2],e[0]),r[3]=Math.max(t[3],e[1]));else switch(e.type){case"extent":r[0]=Math.min(t[0],e.xmin),r[1]=Math.min(t[1],e.ymin),r[2]=Math.max(t[2],e.xmax),r[3]=Math.max(t[3],e.ymax);break;case"point":r[0]=Math.min(t[0],e.x),r[1]=Math.min(t[1],e.y),r[2]=Math.max(t[2],e.x),r[3]=Math.max(t[3],e.y)}}function CU(t,e,r=t){const i=e.length;let s=t[0],n=t[1],o=t[2],a=t[3];for(let l=0;l<i;l++){const c=e[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return r[0]=s,r[1]=n,r[2]=o,r[3]=a,r}function Sz(t){for(let e=0;e<4;e++)if(!isFinite(t[e]))return!1;return!0}function Cu(t){return C(t)||t[0]>=t[2]?0:t[2]-t[0]}function wp(t){return t[1]>=t[3]?0:t[3]-t[1]}function Ufe(t){return Cu(t)*wp(t)}function gX(t,e=[0,0]){return e[0]=(t[0]+t[2])/2,e[1]=(t[1]+t[3])/2,e}function Vfe(t,e){return a5(t,e[0],e[1])}function bee(t,e){const r=e[3],i=.5*(t[0]+t[2]),s=Math.abs(e[0]-i),n=.5*(t[2]-t[0]);if(s>r+n)return!1;const o=.5*(t[1]+t[3]),a=.5*(t[3]-t[1]),l=Math.abs(e[1]-o);if(l>r+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=r*r}function bSt(t,e,r){const i=t[0],s=t[1],n=t[2],o=t[3],{x:a,y:l}=e,{x:c,y:h}=r,p=(b,x)=>(h-l)*b+(a-c)*x+(c*l-a*h)<0,f=p(i,o),m=p(n,o),y=p(n,s),_=p(i,s);return!(f===m&&m===y&&y===_&&_===f||a<i&&c<i||a>n&&c>n||l>o&&h>o||l<s&&h<s)}function wSt(t,e){return a5(t,e.x,e.y)}function a5(t,e,r){return e>=t[0]&&r>=t[1]&&e<=t[2]&&r<=t[3]}function SDe(t,e,r){return e[0]>=t[0]-r&&e[1]>=t[1]-r&&e[0]<=t[2]+r&&e[1]<=t[3]+r}function l5(t,e){return Math.max(e[0],t[0])<=Math.min(e[2],t[2])&&Math.max(e[1],t[1])<=Math.min(e[3],t[3])}function wee(t,e){return e[0]>=t[0]&&e[2]<=t[2]&&e[1]>=t[1]&&e[3]<=t[3]}function Ez(t,e,r){if(C(e))return oy(r,t);const i=e[0],s=e[1],n=e[2],o=e[3];return r[0]=ye(t[0],i,n),r[1]=ye(t[1],s,o),r[2]=ye(t[2],i,n),r[3]=ye(t[3],s,o),r}function EDe(t,e){const r=(t[0]+t[2])/2,i=(t[1]+t[3])/2,s=Math.max(Math.abs(e[0]-r)-Cu(t)/2,0),n=Math.max(Math.abs(e[1]-i)-wp(t)/2,0);return Math.sqrt(s*s+n*n)}function rF(t,e,r,i=t){return i[0]=t[0]+e,i[1]=t[1]+r,i[2]=t[2]+e,i[3]=t[3]+r,i}function Xh(t){return t?oy(t,Az):hr(Az)}function Cz(t){return t!=null&&t.length===4}function CDe(t){return!(Cu(t)!==0&&isFinite(t[0])||wp(t)!==0&&isFinite(t[1]))}function iw(t,e){return Cz(t)&&Cz(e)?t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]:t===e}const xSt=[-1/0,-1/0,1/0,1/0],Az=[1/0,1/0,-1/0,-1/0],ADe=[0,0,0,0],TSt=Math.PI/180,SSt=/SPHEROID\[([^\]]+)]/i,By=br.radius,cd=br.eccentricitySquared,RDe={a1:By*cd,a2:By*cd*By*cd,a3:By*cd*cd/2,a4:By*cd*By*cd*2.5,a5:By*cd+By*cd*cd/2,a6:1-cd},ESt={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:br.radius,f:br.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:ny.radius,f:ny.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:Jf.radius,f:Jf.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:Jf.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let IP=0,AU=class Rz{static fromGE(e){const r=new Rz;return r._wkt=e.wkt,r._wkid=e.wkid,r._isInverse=e.isInverse,r}constructor(e){this.uid=IP++,e?(this._wkt=e.wkt!=null?e.wkt:null,this._wkid=e.wkid!=null?e.wkid:-1,this._isInverse=e.isInverse!=null&&e.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}get wkt(){return this._wkt}set wkt(e){this._wkt=e,this.uid=IP++}get wkid(){return this._wkid}set wkid(e){this._wkid=e,this.uid=IP++}get isInverse(){return this._isInverse}set isInverse(e){this._isInverse=e,this.uid=IP++}getInverse(){const e=new Rz;return e._wkt=this.wkt,e._wkid=this._wkid,e._isInverse=!this.isInverse,e}},Oz=class DA{static cacheKey(e,r){return[e.wkid!==void 0&&e.wkid!==null?e.wkid.toString():"-1",e.wkt!==void 0&&e.wkt!==null?e.wkt.toString():"",r.wkid!==void 0&&r.wkid!==null?r.wkid.toString():"-1",r.wkt!==void 0&&r.wkt!==null?r.wkt.toString():""].join(",")}static fromGE(e){const r=new DA;let i="";for(const s of e.steps){const n=AU.fromGE(s);r.steps.push(n),i+=n.uid.toString()+","}return r._cachedProjection={},r._gtlistentry=null,r._chain=i,r}constructor(e){if(this.steps=[],this._cachedProjection={},this._chain="",this._gtlistentry=null,e&&e.steps)for(const r of e.steps)r instanceof AU?this.steps.push(r):this.steps.push(new AU({wkid:r.wkid,wkt:r.wkt,isInverse:r.isInverse}))}getInverse(){const e=new DA;e.steps=[];for(let r=this.steps.length-1;r>=0;r--){const i=this.steps[r];e.steps.push(i.getInverse())}return e}getGTListEntry(){let e="";for(const r of this.steps)e+=r.uid.toString()+",";return e!==this._chain&&(this._gtlistentry=null,this._cachedProjection={},this._chain=e),this._gtlistentry}assignCachedGe(e,r,i){this._cachedProjection[DA.cacheKey(e,r)]=i}getCachedGeTransformation(e,r){let i="";for(const n of this.steps)i+=n.uid.toString()+",";i!==this._chain&&(this._gtlistentry=null,this._cachedProjection={},this._chain=i);const s=this._cachedProjection[DA.cacheKey(e,r)];return s===void 0?null:s}};function kfe(t,e,r){if(C(e)||C(r)||r.vcsWkid||Cn(e,r))return null;const i=ww(e)/ww(r);if(i===1)return null;switch(t){case"point":case"esriGeometryPoint":return s=>ODe(s,i);case"polyline":case"esriGeometryPolyline":return s=>PDe(s,i);case"polygon":case"esriGeometryPolygon":return s=>MDe(s,i);case"multipoint":case"esriGeometryMultipoint":return s=>IDe(s,i);case"extent":case"esriGeometryExtent":return s=>$De(s,i);default:return null}}function ODe(t,e){t&&t.z!=null&&(t.z*=e)}function MDe(t,e){if(t)for(const r of t.rings)for(const i of r)i.length>2&&(i[2]*=e)}function PDe(t,e){if(t)for(const r of t.paths)for(const i of r)i.length>2&&(i[2]*=e)}function IDe(t,e){if(t)for(const r of t.points)r.length>2&&(r[2]*=e)}function $De(t,e){t&&t.zmin!=null&&t.zmax!=null&&(t.zmin*=e,t.zmax*=e)}let B_=null,d3=null,RU=null,OU={};const zfe=new AW;function yX(){return!!B_&&$fe()}function iF(t){return C(RU)&&(RU=Promise.all([Lfe(),ie(()=>import("./geometryEngineBase-e1a33b0a.js"),[],import.meta.url).then(e=>e.g),ie(()=>import("./hydrated-739aa8cc.js"),[],import.meta.url)])),RU.then(([,e,{hydratedAdapter:r}])=>{ur(t),d3=r,B_=e.default,B_._enableProjection(TDe),zfe.notify()})}function GE(t,e,r=null,i=null){return Array.isArray(t)?t.length===0?[]:xee(d3,t,t[0].spatialReference,e,r,i):xee(d3,[t],t.spatialReference,e,r,i)[0]}function xee(t,e,r,i,s=null,n=null){if(C(r)||C(i))return e;if(rv(r,i,s))return e.map(o=>Bfe(o,r,i));if(C(s)){const o=Oz.cacheKey(r,i);OU[o]!==void 0?s=OU[o]:(s=DDe(r,i,void 0),C(s)&&(s=new Oz),OU[o]=s)}if(C(B_)||C(t))throw new _X;return v(n)?B_._project(t,e,r,i,s,n):B_._project(t,e,r,i,s)}function CSt(t,e){const r=LDe([t],e);return v(r.pending)?{pending:r.pending,geometry:null}:v(r.geometries)?{pending:null,geometry:r.geometries[0]}:{pending:null,geometry:null}}function LDe(t,e){if(!yX()){for(const r of t)if(v(r)&&!Cn(r.spatialReference,e)&&va(r.spatialReference)&&va(e)&&!rv(r.spatialReference,e))return vr(zfe),{pending:iF(),geometries:null}}return{pending:null,geometries:t.map(r=>C(r)?null:Cn(r.spatialReference,e)?r:va(r.spatialReference)&&va(e)?NDe(r,e):null)}}function DDe(t,e,r=null){if(C(t)||C(e))return null;if(C(B_)||C(d3))throw new _X;const i=B_._getTransformation(d3,t,e,r,r==null?void 0:r.spatialReference);return i!==null?Oz.fromGE(i):null}class _X extends j{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}var Z;(function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",t[t.WGS84=2]="WGS84",t[t.WEB_MERCATOR=3]="WEB_MERCATOR",t[t.WGS84_ECEF=4]="WGS84_ECEF",t[t.CGCS2000=5]="CGCS2000",t[t.WGS84_COMPARABLE_LON_LAT=6]="WGS84_COMPARABLE_LON_LAT",t[t.SPHERICAL_MARS_PCPF=7]="SPHERICAL_MARS_PCPF",t[t.GCSMARS2000=8]="GCSMARS2000",t[t.SPHERICAL_MOON_PCPF=9]="SPHERICAL_MOON_PCPF",t[t.GCSMOON2000=10]="GCSMOON2000",t[t.LON_LAT=11]="LON_LAT",t[t.PLATE_CARREE=12]="PLATE_CARREE"})(Z||(Z={}));function NDe(t,e){try{const r=GE(t,e);if(r==null)return null;"xmin"in t&&"xmin"in r&&(r.zmin=t.zmin,r.zmax=t.zmax);const i=kfe(r.type,t.spatialReference,e);return v(i)&&i(r),r}catch(r){if(!(r instanceof _X))throw r;return null}}function rv(t,e,r){return!r&&(!!Cn(t,e)||va(t)&&va(e)&&!!xX(t,e,SX))}async function FDe(t,e,r,i){if(yX())return RQ(i);if(Array.isArray(t)){for(const{source:s,dest:n,geographicTransformation:o}of t)if(!rv(s,n,o))return iF(i)}else if(!rv(t,e,r))return iF(i);return RQ(i)}function ASt(t,e){switch(xX(t,e,SX)){case Di:return"copy3";case C_:return"wgs84ToSphericalECEF";case Cw:return"wgs84ToWebMercator";case E_:return"wgs84ToPlateCarree";case R_:return"wgs84ToWGS84ECEF";case sw:return"webMercatorToWGS84";case Xfe:return"webMercatorToSphericalECEF";case Yfe:return"webMercatorToWGS84ECEF";case Zfe:return"webMercatorToPlateCarree";case O_:return"wgs84ECEFToWGS84";case Qfe:return"wgs84ECEFToSphericalECEF";case eme:return"wgs84ECEFToWebMercator";case A_:return"sphericalECEFToWGS84";case Jfe:return"sphericalECEFToWebMercator";case $z:return"sphericalMarsPCPFToMars2000";case Iz:return"sphericalMoonPCPFToMoon2000";case Kfe:return"sphericalECEFToWGS84ECEF";case Pz:return"mars2000ToSphericalPCPF";case Mz:return"moon2000ToSphericalPCPF";default:return null}}function Bfe(t,e,r){return t?"x"in t?Gfe(t,e,new _t,r,0):"xmin"in t?zDe(t,e,new Hr,r,0):"rings"in t?jfe(t,e,new bp,r,0):"paths"in t?kDe(t,e,new ip,r,0):"points"in t?VDe(t,e,new OM,r,0):null:null}function UDe(t,e,r=e.spatialReference,i=0){return v(r)&&v(t.spatialReference)&&v(Gfe(t,t.spatialReference,e,r,i))}function Gfe(t,e,r,i,s){ii[0]=t.x,ii[1]=t.y;const n=t.z;return ii[2]=n!==void 0?n:s,vs(ii,e,0,ii,i,0,1)?(r.x=ii[0],r.y=ii[1],r.spatialReference=i,n===void 0?(r.z=void 0,r.hasZ=!1):(r.z=ii[2],r.hasZ=!0),t.m===void 0?(r.m=void 0,r.hasM=!1):(r.m=t.m,r.hasM=!0),r):null}function VDe(t,e,r,i,s){const{points:n,hasZ:o,hasM:a}=t,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!vs(h,e,0,h,i,0,c))return null;for(let p=0;p<c;++p){const f=3*p,m=h[f],y=h[f+1];o&&a?l.push([m,y,h[f+2],n[p][3]]):o?l.push([m,y,h[f+2]]):a?l.push([m,y,n[p][2]]):l.push([m,y])}return r.points=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r}function kDe(t,e,r,i,s){const{paths:n,hasZ:o,hasM:a}=t,l=[];return qfe(n,o??!1,a??!1,e,l,i,s)?(r.paths=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r):null}function RSt(t,e,r=e.spatialReference,i=0){return v(t.spatialReference)&&v(r)&&v(jfe(t,t.spatialReference,e,r,i))}function jfe(t,e,r,i,s){const{rings:n,hasZ:o,hasM:a}=t,l=[];return qfe(n,o??!1,a??!1,e,l,i,s)?(r.rings=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r):null}function zDe(t,e,r,i,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=t;return Tee(n,o,c?t.zmin:s,e,ii,i)?(r.xmin=ii[0],r.ymin=ii[1],c&&(r.zmin=ii[2]),Tee(a,l,c?t.zmax:s,e,ii,i)?(r.xmax=ii[0],r.ymax=ii[1],c&&(r.zmax=ii[2]),h&&(r.mmin=t.mmin,r.mmax=t.mmax),r.spatialReference=i,r):null):null}function iv(t,e,r){if(C(e)||C(r))return null;const i=new _t({spatialReference:r});return vs(t,e,0,ii,r,0,1)?(i.x=ii[0],i.y=ii[1],i.z=ii[2],i):null}function Hfe(t,e,r){return vs(t,e,0,ii,r.spatialReference,0,1)?(r.x=ii[0],r.y=ii[1],r.z=ii[2],r):null}function ta(t,e,r,i=0){ii[0]=t.x,ii[1]=t.y;const s=t.z;return ii[2]=s!==void 0?s:i,vs(ii,t.spatialReference,0,e,r,0,1)}function Tee(t,e,r,i,s,n){return fs[0]=t,fs[1]=e,fs[2]=r,vs(fs,i,0,s,n,0,1)}function uo(t,e,r,i){return!(C(e)||C(i)||t.length<2)&&(t.length===2&&(fs[0]=t[0],fs[1]=t[1],fs[2]=0,t=fs),vs(t,e,0,r,i,0,1))}function BDe(t,e){ii[0]=t.x,ii[1]=t.y;const r=t.z;return ii[2]=r!==void 0?r:0,GDe(ii,t.spatialReference,e)}function GDe(t,e,r){return jDe(t,e,r)}function jDe(t,e,r){if(C(e))return!1;const i=sv(e,u5),s=jf[i][Z.WGS84_COMPARABLE_LON_LAT];return!C(s)&&(s(t,0,fs,0),r!==fs&&(r[0]=fs[0],r[1]=fs[1],r.length>2&&(r[2]=fs[2])),!0)}function vs(t,e,r,i,s,n,o=1){const a=xX(e,s,SX);if(C(a))return!1;if(a===Di){if(t===i&&r===n)return!0;const c=r+3*o;for(let h=r,p=n;h<c;h++,p++)i[p]=t[h];return!0}const l=r+3*o;for(let c=r,h=n;c<l;c+=3,h+=3)a(t,c,i,h);return!0}function OSt(t,e,r,i,s){le(ii,t),me($P,t,e),uo(ii,r,ii,s),uo($P,r,$P,s),ge(i,$P,ii),ve(i,i)}function qfe(t,e,r,i,s,n,o=0){const a=new Array;for(const c of t)for(const h of c)a.push(h[0],h[1],e?h[2]:o);if(!vs(a,i,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of t){const h=new Array;for(const p of c)e&&r?h.push([a[l++],a[l++],a[l++],p[3]]):e?h.push([a[l++],a[l++],a[l++]]):r?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function MSt(t,e,r,i){if(C(e)||C(i))return!1;const s=tme(e,i,QDe);if(s.projector===Di)return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],!0;if(C(s.projector))return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===Z.WEB_MERCATOR){const a=jf[n.spatialReferenceId][Z.WGS84];return!C(a)&&(a(t,0,Gd,0),Cw(Gd,0,r,0),r[3]=See(Gd[1],t[2],t[3],br.radius),!0)}if(n.spatialReferenceId!==Z.WGS84&&n.spatialReferenceId!==Z.CGCS2000||o.spatialReferenceId!==Z.PLATE_CARREE){s.projector(t,0,r,0);const a=n.metersPerUnit??1,l=o.metersPerUnit??1;r[3]=t[3]*a/l}else{const a=jf[n.spatialReferenceId][Z.SPHERICAL_ECEF],l=jf[Z.SPHERICAL_ECEF][Z.PLATE_CARREE];let c=t[3];v(a)&&v(l)&&(c=See(t[1],t[2],t[3],br.radius)),s.projector(t,0,r,0),r[3]=c}return!0}function See(t,e,r,i){const s=i+e;if(s<i/2||r>s)return Number.MAX_VALUE;const n=Math.abs(sp*t)+Math.asin(r/s);return n>=Math.PI/2?Number.MAX_VALUE:r/Math.cos(n)}function c5(t,e,r,i){return t!=null&&(Cn(e,i)?(oy(r,t),!0):(fs[0]=t[0],fs[1]=t[1],fs[2]=0,!!vs(fs,e,0,fs,i,0,1)&&(r[0]=fs[0],r[1]=fs[1],fs[0]=t[2],fs[1]=t[3],fs[2]=0,!!vs(fs,e,0,fs,i,0,1)&&(r[2]=fs[0],r[3]=fs[1],!0))))}function PSt(t,e,r,i){if(C(e)||C(i))return!1;const s=sv(e,u5),n=sv(i,rme);if(s===n&&s!==Z.UNKNOWN||Cn(e,i))return r[0]=1,r[1]=1,r[2]=1,!0;if(s===Z.SPHERICAL_ECEF){const o=Me(t),a=o/Math.sqrt(t[0]*t[0]+t[1]*t[1]),l=o/br.radius;if(n===Z.WEB_MERCATOR)return r[0]=a*l,r[1]=a*l,r[2]=1,!0;if(n===Z.WGS84||n===Z.CGCS2000){const c=hO;return r[0]=c*a*l,r[1]=c*l,r[2]=1,!0}}else if(s===Z.PLATE_CARREE){if(n===Z.WGS84||n===Z.CGCS2000)return r[0]=hO,r[1]=hO,r[2]=1,!0;if(n===Z.WEB_MERCATOR){const o=t[1]/br.radius;return r[0]=1,r[1]=1/Math.cos(o),r[2]=1,!0}}return!1}function xp(t,e,r,i){if(C(t)||C(i))return!1;const s=sv(t,u5),n=sv(i,rme);if(s===n&&!Eee(n)&&(s!==Z.UNKNOWN||Cn(t,i)))return i5(r,e),!0;if(Eee(n)){const o=jf[s][Z.LON_LAT],a=jf[Z.LON_LAT][n];return!C(o)&&!C(a)&&(o(e,0,Gd,0),a(Gd,0,Gy,0),Wfe(sp*Gd[0],sp*Gd[1],r),r[12]=Gy[0],r[13]=Gy[1],r[14]=Gy[2],!0)}if((n===Z.WEB_MERCATOR||n===Z.PLATE_CARREE)&&(s===Z.WGS84||s===Z.CGCS2000&&n===Z.PLATE_CARREE||s===Z.SPHERICAL_ECEF||s===Z.WEB_MERCATOR)){const o=jf[s][Z.LON_LAT],a=jf[Z.LON_LAT][n];return!C(o)&&!C(a)&&(o(e,0,Gd,0),a(Gd,0,Gy,0),s===Z.SPHERICAL_ECEF?HDe(sp*Gd[0],sp*Gd[1],r):Wh(r),r[12]=Gy[0],r[13]=Gy[1],r[14]=Gy[2],!0)}return!1}function Eee(t){return t===Z.SPHERICAL_ECEF||t===Z.SPHERICAL_MARS_PCPF||t===Z.SPHERICAL_MOON_PCPF}function Wfe(t,e,r){const i=Math.sin(t),s=Math.cos(t),n=Math.sin(e),o=Math.cos(e),a=r;return a[0]=-i,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*i,a[9]=o*i,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function HDe(t,e,r){return Wfe(t,e,r),kc(r,r),r}function sv(t,e){return t?e.spatialReference===t?e.spatialReferenceId:(e.spatialReference=t,"metersPerUnit"in e&&(e.metersPerUnit=al(t,1)),t.wkt===npe.wkt?e.spatialReferenceId=Z.SPHERICAL_ECEF:a3(t)?e.spatialReferenceId=Z.WGS84:bw(t)?e.spatialReferenceId=Z.WEB_MERCATOR:$W(t)?e.spatialReferenceId=Z.PLATE_CARREE:t.wkt===ope.wkt?e.spatialReferenceId=Z.WGS84_ECEF:t.wkid===$h.CGCS2000?e.spatialReferenceId=Z.CGCS2000:t.wkt===FW.wkt?e.spatialReferenceId=Z.SPHERICAL_MARS_PCPF:t.wkt===UW.wkt?e.spatialReferenceId=Z.SPHERICAL_MOON_PCPF:wm(t)?e.spatialReferenceId=Z.GCSMARS2000:xm(t)?e.spatialReferenceId=Z.GCSMOON2000:e.spatialReferenceId=Z.UNKNOWN):Z.UNKNOWN}function Di(t,e,r,i){t!==r&&(r[i++]=t[e++],r[i++]=t[e++],r[i]=t[e])}function sw(t,e,r,i){r[i++]=QS*(t[e++]/br.radius),r[i++]=QS*(Math.PI/2-2*Math.atan(Math.exp(-t[e++]/br.radius))),r[i]=t[e]}function Xfe(t,e,r,i){sw(t,e,r,i),C_(r,i,r,i)}function Yfe(t,e,r,i){sw(t,e,r,i),R_(r,i,r,i)}function vX(t,e,r,i,s){const n=.4999999*Math.PI,o=ye(sp*t[e+1],-n,n),a=Math.sin(o);r[i++]=sp*t[e]*s.radius,r[i++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),r[i]=t[e+2]}function Cw(t,e,r,i){vX(t,e,r,i,br)}const Cee=br.radius*Math.PI/180,hO=180/(br.radius*Math.PI);function E_(t,e,r,i){r[i]=t[e]*Cee,r[i+1]=t[e+1]*Cee,r[i+2]=t[e+2]}function Bb(t,e,r,i){r[i]=t[e]*hO,r[i+1]=t[e+1]*hO,r[i+2]=t[e+2]}function Zfe(t,e,r,i){sw(t,e,r,i),E_(r,i,r,i)}function qDe(t,e,r,i){O_(t,e,r,i),E_(r,i,r,i)}function WDe(t,e,r,i){A_(t,e,r,i),E_(r,i,r,i)}function XDe(t,e,r,i){Bb(t,e,r,i),C_(r,i,r,i)}function YDe(t,e,r,i){Bb(t,e,r,i),Cw(r,i,r,i)}function ZDe(t,e,r,i){Bb(t,e,r,i),R_(r,i,r,i)}function Aw(t){if(C(t))return!1;const e=sv(t,u5);return!!jf[e][Z.WGS84_COMPARABLE_LON_LAT]}function JDe(t,e,r,i){const s=Math.cos(r);t[0]=Math.cos(e)*s*i,t[1]=Math.sin(e)*s*i,t[2]=Math.sin(r)*i}function bX(t,e,r,i,s){const n=s+t[e+2],o=sp*t[e+1],a=sp*t[e],l=Math.cos(o);r[i++]=Math.cos(a)*l*n,r[i++]=Math.sin(a)*l*n,r[i]=Math.sin(o)*n}function Mz(t,e,r,i){bX(t,e,r,i,ny.radius)}function Pz(t,e,r,i){bX(t,e,r,i,Jf.radius)}function C_(t,e,r,i){bX(t,e,r,i,br.radius)}function wX(t,e,r,i,s){const n=t[e],o=t[e+1],a=t[e+2],l=Math.sqrt(n*n+o*o+a*a),c=Hh(a/(l===0?1:l)),h=Math.atan2(o,n);r[i++]=QS*h,r[i++]=QS*c,r[i]=l-s}function Iz(t,e,r,i){wX(t,e,r,i,ny.radius)}function $z(t,e,r,i){wX(t,e,r,i,Jf.radius)}function A_(t,e,r,i){wX(t,e,r,i,br.radius)}function Jfe(t,e,r,i){A_(t,e,r,i),Cw(r,i,r,i)}function Kfe(t,e,r,i){A_(t,e,r,i),R_(r,i,r,i)}function KDe(t,e,r,i,s){const n=sp*t[e],o=sp*t[e+1],a=t[e+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);r[i++]=(h+a)*c*Math.cos(n),r[i++]=(h+a)*c*Math.sin(n),r[i++]=(h*(1-s.eccentricitySquared)+a)*l}function R_(t,e,r,i){KDe(t,e,r,i,br)}function O_(t,e,r,i){const s=RDe,n=t[e],o=t[e+1],a=t[e+2];let l,c,h,p,f,m,y,_,b,x,T,S,E,O,R,L,I,U,z,B,G;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),B=Math.atan2(o,n),m=a*a/p,y=c/p,O=s.a2/f,R=s.a3-s.a4/f,y>.3?(_=l/f*(1+y*(s.a1+O+m*R)/f),z=Math.asin(_),x=_*_,b=Math.sqrt(1-x)):(b=h/f*(1-m*(s.a5-O-y*R)/f),z=Math.acos(b),x=1-b*b,_=Math.sqrt(x)),T=1-br.eccentricitySquared*x,S=br.radius/Math.sqrt(T),E=s.a6*S,O=h-S*b,R=l-E*_,I=b*O+_*R,L=b*R-_*O,U=L/(E/T+I),z+=U,G=I+L*U/2,a<0&&(z=-z),r[i++]=QS*B,r[i++]=QS*z,r[i]=G}function Qfe(t,e,r,i){O_(t,e,r,i),C_(r,i,r,i)}function eme(t,e,r,i){O_(t,e,r,i),Cw(r,i,r,i)}const jf={[Z.WGS84]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Di,[Z.WGS84_COMPARABLE_LON_LAT]:Di,[Z.SPHERICAL_ECEF]:C_,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Cw,[Z.PLATE_CARREE]:E_,[Z.WGS84]:Di,[Z.WGS84_ECEF]:R_},[Z.CGCS2000]:{[Z.CGCS2000]:Di,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Di,[Z.WGS84_COMPARABLE_LON_LAT]:Di,[Z.SPHERICAL_ECEF]:C_,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:E_,[Z.WGS84]:null,[Z.WGS84_ECEF]:R_},[Z.GCSMARS2000]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:Di,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Di,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:Pz,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.GCSMOON2000]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:Di,[Z.LON_LAT]:Di,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:Mz,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.WEB_MERCATOR]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:sw,[Z.WGS84_COMPARABLE_LON_LAT]:sw,[Z.SPHERICAL_ECEF]:Xfe,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Di,[Z.PLATE_CARREE]:Zfe,[Z.WGS84]:sw,[Z.WGS84_ECEF]:Yfe},[Z.WGS84_ECEF]:{[Z.CGCS2000]:O_,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:O_,[Z.WGS84_COMPARABLE_LON_LAT]:O_,[Z.SPHERICAL_ECEF]:Qfe,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:eme,[Z.PLATE_CARREE]:qDe,[Z.WGS84]:O_,[Z.WGS84_ECEF]:Di},[Z.SPHERICAL_ECEF]:{[Z.CGCS2000]:A_,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:A_,[Z.WGS84_COMPARABLE_LON_LAT]:A_,[Z.SPHERICAL_ECEF]:Di,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Jfe,[Z.PLATE_CARREE]:WDe,[Z.WGS84]:A_,[Z.WGS84_ECEF]:Kfe},[Z.SPHERICAL_MARS_PCPF]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:$z,[Z.GCSMOON2000]:null,[Z.LON_LAT]:$z,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:Di,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.SPHERICAL_MOON_PCPF]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:Iz,[Z.LON_LAT]:Iz,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:Di,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.UNKNOWN]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:null,[Z.WGS84_COMPARABLE_LON_LAT]:null,[Z.SPHERICAL_ECEF]:null,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:Di,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:null,[Z.WGS84]:null,[Z.WGS84_ECEF]:null},[Z.LON_LAT]:{[Z.CGCS2000]:Di,[Z.GCSMARS2000]:Di,[Z.GCSMOON2000]:Di,[Z.LON_LAT]:Di,[Z.WGS84_COMPARABLE_LON_LAT]:Di,[Z.SPHERICAL_ECEF]:C_,[Z.SPHERICAL_MARS_PCPF]:Pz,[Z.SPHERICAL_MOON_PCPF]:Mz,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:Cw,[Z.PLATE_CARREE]:E_,[Z.WGS84]:Di,[Z.WGS84_ECEF]:R_},[Z.WGS84_COMPARABLE_LON_LAT]:{[Z.CGCS2000]:null,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Di,[Z.WGS84_COMPARABLE_LON_LAT]:Di,[Z.SPHERICAL_ECEF]:C_,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:null,[Z.PLATE_CARREE]:E_,[Z.WGS84]:Di,[Z.WGS84_ECEF]:R_},[Z.PLATE_CARREE]:{[Z.CGCS2000]:Bb,[Z.GCSMARS2000]:null,[Z.GCSMOON2000]:null,[Z.LON_LAT]:Bb,[Z.WGS84_COMPARABLE_LON_LAT]:Bb,[Z.SPHERICAL_ECEF]:XDe,[Z.SPHERICAL_MARS_PCPF]:null,[Z.SPHERICAL_MOON_PCPF]:null,[Z.UNKNOWN]:null,[Z.WEB_MERCATOR]:YDe,[Z.PLATE_CARREE]:Di,[Z.WGS84]:Bb,[Z.WGS84_ECEF]:ZDe}};function xX(t,e,r=TX()){return C(t)||C(e)?null:tme(t,e,r).projector}function tme(t,e,r){if(C(t)||C(e)||r.source.spatialReference===t&&r.dest.spatialReference===e)return r;const i=sv(t,r.source),s=sv(e,r.dest);return i===Z.UNKNOWN&&s===Z.UNKNOWN?Cn(t,e)?r.projector=Di:r.projector=null:r.projector=jf[i][s],r}function TX(){return{source:{spatialReference:null,spatialReferenceId:Z.UNKNOWN,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:Z.UNKNOWN,metersPerUnit:1},projector:Di}}const u5={spatialReference:null,spatialReferenceId:Z.UNKNOWN},rme={spatialReference:null,spatialReferenceId:Z.UNKNOWN},SX=TX(),QDe=TX(),sp=jt(1),QS=ol(1),fs=M(),Gd=M(),Gy=M(),ii=M(),$P=M();function jE(t,e){const r=e&&e.url&&e.url.path;if(t&&r&&(t=Eu(t,r,{preserveProtocolRelative:!0}),e.portalItem&&e.readResourcePaths)){const i=uW(t,e.portalItem.itemUrl);i!=null&&eNe.test(i)&&e.readResourcePaths.push(e.portalItem.resourceFromPath(i).path)}return Lz(t,e&&e.portal)}function Rw(t,e,r=p3.YES){if(t==null)return t;!Mu(t)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(t);let i=Eu(t);if(e){const s=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;if(s){const n=Lz(s,e.portal),o=Lz(i,e.portal);i=uW(o,n,n),i!=null&&i!==o&&i!==t&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(i)}}return i=sme(i,e==null?void 0:e.portal),Mu(i)&&(i=Uh(i)),e!=null&&e.resources&&(e!=null&&e.portalItem)&&!Mu(i)&&!bm(i)&&r===p3.YES&&e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(i),compress:!1}),i}function EX(t,e,r){return jE(t,r)}function nv(t,e,r,i){const s=Rw(t,i);s!==void 0&&(e[r]=s)}const ime=/\/items\/([^\/]+)\/resources\/(.*)/,eNe=/^\.\/resources\//;function tNe(t){var e;return((e=(t==null?void 0:t.match(ime))??null)==null?void 0:e[1])??null}function rNe(t){const e=(t==null?void 0:t.match(ime))??null;if(e==null)return null;const r=e[2],i=r.lastIndexOf("/");if(i===-1){const{path:o,extension:a}=_Q(r);return{prefix:null,filename:o,extension:a}}const{path:s,extension:n}=_Q(r.slice(i+1));return{prefix:r.slice(0,i),filename:s,extension:n}}function sme(t,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?Ak(t,`${e.urlKey}.${e.customBaseUrl}`,e.portalHostname):t}function Lz(t,e){if(!e||e.isPortal||!e.urlKey||!e.customBaseUrl)return t;const r=`${e.urlKey}.${e.customBaseUrl}`,i=aW();return NS(i,`${i.scheme}://${r}`)?Ak(t,e.portalHostname,r):Ak(t,r,e.portalHostname)}var p3;(function(t){t[t.YES=0]="YES",t[t.NO=1]="NO"})(p3||(p3={}));const ISt=Object.freeze(Object.defineProperty({__proto__:null,get MarkKeep(){return p3},ensureMainOnlineDomain:sme,fromJSON:jE,itemIdFromResourceUrl:tNe,prefixAndFilenameFromResourceUrl:rNe,read:EX,toJSON:Rw,write:nv},Symbol.toStringTag,{value:"Module"})),nme={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},ome=Object.values(nme),ame=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${ome.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),iNe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${ome.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),sNe=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function $St(t){return!!ame.test(t)}function HE(t){if(C(t))return null;const e=lo(t),r=e.path.match(ame)||e.path.match(iNe);if(!r)return null;const[,i,s,n,o]=r,a=s.indexOf("/");return{title:CX(a!==-1?s.slice(a+1):s),serverType:nme[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:i}}}function nNe(t){const e=lo(t).path.match(sNe);return e?{serviceUrl:e[1],sublayerId:Number(e[2])}:null}function CX(t){return(t=t.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+t.slice(1)}function oNe(t,e){const r=[];if(t){const i=HE(t);v(i)&&i.title&&r.push(i.title)}if(e){const i=CX(e);r.push(i)}if(r.length===2){if(r[0].toLowerCase().includes(r[1].toLowerCase()))return r[0];if(r[1].toLowerCase().includes(r[0].toLowerCase()))return r[1]}return r.join(" - ")}function lme(t){if(!t)return!1;const e=".arcgis.com/",r="//services",i="//tiles",s="//features",n=(t=t.toLowerCase()).includes(e),o=t.includes(r)||t.includes(i)||t.includes(s);return n&&o}function aNe(t,e){return t&&Qhe(tde(t,e))}function lNe(t){let{url:e}=t;if(!e)return{url:e};e=tde(e,t.logger);const r=lo(e),i=HE(r.path);let s;if(v(i))i.sublayer!=null&&t.layer.layerId==null&&(s=i.sublayer),e=i.url.path;else if(t.nonStandardUrlAllowed){const n=nNe(r.path);v(n)&&(e=n.serviceUrl,s=n.sublayerId)}return{url:Qhe(e),layerId:s}}function cNe(t,e,r,i,s){nv(e,i,"url",s),i.url&&t.layerId!=null&&(i.url=Nu(i.url,r,t.layerId.toString()))}function LSt(t){if(!t)return!1;const e=t.toLowerCase(),r=e.includes("/services/"),i=e.includes("/mapserver/wmsserver"),s=e.includes("/imageserver/wmsserver"),n=e.includes("/wmsserver");return r&&(i||s||n)}function uNe(t,e){if(!t)return null;if(!Dz(t))return new j("webscene:unsupported-height-model-info","The vertical coordinate system of the scene is not supported",{heightModelInfo:t});const r=t.heightUnit,i=Tv.deriveUnitFromSR(t,e).heightUnit;return r!==i?new j("webscene:incompatible-height-unit",`The vertical units of the scene (${r}) must match the horizontal units of the scene (${i})`,{verticalUnit:r,horizontalUnit:i}):null}function DSt(t,e,r){const i=cme(t),s=e,n=hNe(i,s,r);if(i){const o=Tv.deriveUnitFromSR(i,t.spatialReference).heightUnit;if(!r&&o!==i.heightUnit){const a=new j("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${o})`,{horizontalUnit:o});return new j("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i,error:a})}}if(!dNe(t)||n===_c.Unsupported)return new j("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i});switch(n){case _c.Units:{const o=(i==null?void 0:i.heightUnit)||"unknown",a=(s==null?void 0:s.heightUnit)||"unknown",l=new j("layerview:incompatible-height-unit",`The vertical units of the layer (${o}) must match the vertical units of the scene (${a})`,{layerUnit:o,sceneUnit:a});return new j("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}case _c.HeightModel:{const o=(i==null?void 0:i.heightModel)||"unknown",a=(s==null?void 0:s.heightModel)||"unknown",l=new j("layerview:incompatible-height-model",`The height model of the layer (${o}) must match the height model of the scene (${a})`,{layerHeightModel:o,sceneHeightModel:a});return new j("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}case _c.CRS:{const o=(i==null?void 0:i.vertCRS)||"unknown",a=(s==null?void 0:s.vertCRS)||"unknown",l=new j("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${o}) must match the vertical datum of the scene (${a})`,{layerDatum:o,sceneDatum:a});return new j("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}}return null}function hNe(t,e,r){if(!Dz(t)||!Dz(e))return _c.Unsupported;if(t==null||e==null)return _c.Ok;if(!r&&t.heightUnit!==e.heightUnit)return _c.Units;if(t.heightModel!==e.heightModel)return _c.HeightModel;switch(t.heightModel){case"gravity-related-height":return _c.Ok;case"ellipsoidal":return t.vertCRS===e.vertCRS?_c.Ok:_c.CRS;default:return _c.Unsupported}}var _c;function Dz(t){return t==null||t.heightModel!=null&&t.heightUnit!=null}function dNe(t){return"heightModelInfo"in t&&t.heightModelInfo!=null||t.spatialReference!=null||!dme(t)}function cme(t){var i;const e=t.url?HE(t.url):void 0;return!(((i=t.spatialReference)==null?void 0:i.vcsWkid)==null&&v(e)&&e.serverType==="ImageServer")&&ume(t)&&t.heightModelInfo?t.heightModelInfo:dme(t)?Tv.deriveUnitFromSR(fNe,t.spatialReference):null}function ume(t){return"heightModelInfo"in t}function hme(t){if(t.type==="unknown"||!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"oriented-imagery":case"wfs":case"knowledge-graph-sublayer":return!0;default:return!1}}function dme(t){return hme(t)?!!(t.capabilities&&t.capabilities.data&&t.capabilities.data.supportsZ):pme(t)}function pNe(t){return t.layers!=null||pme(t)||hme(t)||ume(t)}function pme(t){switch(t.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"dimension":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-image":case"map-notes":case"media":case"ogc-feature":case"open-street-map":case"oriented-imagery":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(function(t){t[t.Ok=0]="Ok",t[t.Units=1]="Units",t[t.HeightModel=2]="HeightModel",t[t.CRS=3]="CRS",t[t.Unsupported=4]="Unsupported"})(_c||(_c={}));const fNe=new Tv({heightModel:"gravity-related-height"});let R0=class extends fe{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};u([d({type:String,json:{write:!0}})],R0.prototype,"facilityIdField",void 0),u([d({type:String,json:{write:!0}})],R0.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],R0.prototype,"nameField",void 0),u([d({type:String,json:{write:!0}})],R0.prototype,"siteIdField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],R0.prototype,"sublayerId",void 0),R0=u([P("esri.layers.support.FacilityLayerInfo")],R0);const mNe=R0;let wd=class extends fe{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.levelIdField=null,this.levelNumberField=null,this.longNameField=null,this.shortNameField=null,this.sublayerId=null,this.verticalOrderField=null}};u([d({type:String,json:{write:!0}})],wd.prototype,"facilityIdField",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"levelIdField",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"levelNumberField",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"longNameField",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"shortNameField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],wd.prototype,"sublayerId",void 0),u([d({type:String,json:{write:!0}})],wd.prototype,"verticalOrderField",void 0),wd=u([P("esri.layers.support.LevelLayerInfo")],wd);const gNe=wd;let E1=class extends fe{constructor(e){super(e),this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};u([d({type:String,json:{write:!0}})],E1.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],E1.prototype,"nameField",void 0),u([d({type:String,json:{write:!0}})],E1.prototype,"siteIdField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],E1.prototype,"sublayerId",void 0),E1=u([P("esri.layers.support.SiteLayerInfo")],E1);const yNe=E1;let IT=class extends fe{constructor(e){super(e),this.levelLayer=null,this.facilityLayer=null,this.siteLayer=null}};u([d({type:gNe,json:{write:!0}})],IT.prototype,"levelLayer",void 0),u([d({type:mNe,json:{write:!0}})],IT.prototype,"facilityLayer",void 0),u([d({type:yNe,json:{write:!0}})],IT.prototype,"siteLayer",void 0),IT=u([P("esri.support.MapFloorInfo")],IT);const _Ne=IT,vNe="webscene:failed-to-copy-embedded-resources",bNe="webscene:schema-validation";function wNe(){return new j(vNe,"Copying of embedded resources is currently not supported")}function xNe(t){return new j(bNe,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:t})}var Be;function Aee(t){return t==="global"?Be.Global:Be.Local}function MU(t){return t===Be.Global?"global":"local"}(function(t){t[t.Global=1]="Global",t[t.Local=2]="Local"})(Be||(Be={}));function eE(t,e){return t!=null&&(e==null||(e===Be.Local?!t.isGeographic||t.isWGS84||t.wkid===$h.CGCS2000:t.isWebMercator||t.isWGS84||t.wkid===$h.CGCS2000||t.wkid===$h.GCSMARS2000||t.wkid===$h.GCSMARS2000_SPHERE||t.wkid===$h.GCSMOON2000))}const TNe="randomUUID"in crypto;function fme(){if(TNe)return crypto.randomUUID();const t=crypto.getRandomValues(new Uint16Array(8));t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;const e=r=>t[r].toString(16).padStart(4,"0");return e(0)+e(1)+"-"+e(2)+"-"+e(3)+"-"+e(4)+"-"+e(5)+e(6)+e(7)}async function SNe(t,e={},r){await t.load(r);const i=Nu(t.itemUrl,"resources"),{start:s=1,num:n=10,sortOrder:o="asc",sortField:a="created"}=e,l={query:{start:s,num:n,sortOrder:o,sortField:a,token:t.apiKey},signal:Js(r,"signal")},c=await t.portal.request(i,l);return{total:c.total,nextStart:c.nextStart,resources:c.resources.map(({created:h,size:p,resource:f})=>({created:new Date(h),size:p,resource:t.resourceFromPath(f)}))}}async function ENe(t,e,r,i){if(!t.hasPath())throw new j(`portal-item-resource-${e}:invalid-path`,"Resource does not have a valid path");const s=t.portalItem;await s.load(i);const n=Nu(s.userItemUrl,e==="add"?"addResources":"updateResources"),[o,a]=mme(t.path),l=await gme(r),c=new FormData;return o&&o!=="."&&c.append("resourcesPrefix",o),v(i)&&i.compress&&c.append("compress","true"),c.append("fileName",a),c.append("file",l,a),c.append("f","json"),v(i)&&i.access&&c.append("access",i.access),await s.portal.request(n,{method:"post",body:c,signal:Js(i,"signal")}),t}async function CNe(t,e,r){if(!e.hasPath())throw new j("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await t.load(r);const i=Nu(t.userItemUrl,"removeResources");await t.portal.request(i,{method:"post",query:{resource:e.path},signal:Js(r,"signal")}),e.portalItem=null}async function ANe(t,e){await t.load(e);const r=Nu(t.userItemUrl,"removeResources");return t.portal.request(r,{method:"post",query:{deleteAll:!0},signal:Js(e,"signal")})}function mme(t){const e=t.lastIndexOf("/");return e===-1?[".",t]:[t.slice(0,e),t.slice(e+1)]}function AX(t){const[e,r]=RNe(t),[i,s]=mme(e);return[i,s,r]}function RNe(t){const e=q3e(t);return C(e)?[t,""]:[t.slice(0,t.length-e.length-1),`.${e}`]}async function gme(t){return t instanceof Blob?t:(await Pi(t.url,{responseType:"blob"})).data}function ONe(t,e){if(!t.hasPath())return null;const[r,,i]=AX(t.path);return t.portalItem.resourceFromPath(Nu(r,e+i))}function yme(t,e){if(!t.hasPath())return null;const[r,,i]=AX(t.path);return t.portalItem.resourceFromPath(Nu(r,e+i))}const NA=Object.freeze(Object.defineProperty({__proto__:null,addOrUpdateResource:ENe,contentToBlob:gme,fetchResources:SNe,getSiblingOfSameType:ONe,getSiblingOfSameTypeI:yme,removeAllResources:ANe,removeResource:CNe,splitPrefixFileNameAndExtension:AX},Symbol.toStringTag,{value:"Module"}));async function Ree(t,e,r){if(!e||!e.resources)return;const i=e.portalItem===t.portalItem?new Set(t.paths):new Set;t.paths.length=0,t.portalItem=e.portalItem;const s=new Set(e.resources.toKeep.map(c=>c.resource.path)),n=new Set,o=[];s.forEach(c=>{i.delete(c),t.paths.push(c)});for(const c of e.resources.toUpdate)if(i.delete(c.resource.path),s.has(c.resource.path)||n.has(c.resource.path)){const{resource:h,content:p,finish:f,error:m}=c,y=yme(h,fme());t.paths.push(y.path),o.push(Oee({resource:y,content:p,compress:c.compress,finish:f,error:m},r))}else t.paths.push(c.resource.path),o.push(MNe(c,r)),n.add(c.resource.path);for(const c of e.resources.toAdd)o.push(Oee(c,r)),t.paths.push(c.resource.path);if(i.forEach(c=>{if(e.portalItem){const h=e.portalItem.resourceFromPath(c);o.push(h.portalItem.removeResource(h).catch(()=>{}))}}),o.length===0)return;const a=await co(o);ur(r);const l=a.filter(c=>"error"in c).map(c=>c.error);if(l.length>0)throw new j("save:resources","Failed to save one or more resources",{errors:l})}async function Oee(t,e){var s,n;const r={...v(e)?e:{},compress:t.compress},i=await Uc(t.resource.portalItem.addResource(t.resource,t.content,r));if(i.ok!==!0)throw(s=t.error)==null||s.call(t,i.error),i.error;(n=t.finish)==null||n.call(t,t.resource)}async function MNe(t,e){var i,s;const r=await Uc(t.resource.update(t.content,e));if(r.ok!==!0)throw(i=t.error)==null||i.call(t,r.error),r.error;(s=t.finish)==null||s.call(t,t.resource)}const PNe={width:600,height:400},LP=1.5;function INe(t,e){e=e||PNe;let{width:r,height:i}=e;const s=r/i;return s<LP?i=r/LP:s>LP&&(r=i*LP),r>t.width&&(i*=t.width/r,r=t.width),i>t.height&&(r*=t.height/i,i=t.height),{width:Math.round(r),height:Math.round(i)}}function Mee(t){return{enabled:!!(t!=null&&t.length)}}const RX=new Vr({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"});var Nz;let $T=Nz=class extends fe{constructor(t){super(t),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new Nz({exactMatch:this.exactMatch,type:this.type,name:this.name})}};u([d({type:Boolean,json:{write:!0}})],$T.prototype,"exactMatch",void 0),u([d({type:String,json:{write:!0}})],$T.prototype,"name",void 0),u([mt(RX)],$T.prototype,"type",void 0),$T=Nz=u([P("esri.webdoc.applicationProperties.SearchLayerField")],$T);const $Ne=$T;var Fz;let LT=Fz=class extends fe{constructor(t){super(t),this.field=null,this.id=null,this.subLayer=null}clone(){return new Fz(te({field:this.field,id:this.id,subLayer:this.subLayer}))}};u([d({type:$Ne,json:{write:{isRequired:!0}}})],LT.prototype,"field",void 0),u([d({type:String,json:{write:{isRequired:!0}}})],LT.prototype,"id",void 0),u([d({type:Ti,json:{write:!0}})],LT.prototype,"subLayer",void 0),LT=Fz=u([P("esri.webdoc.applicationProperties.SearchLayer")],LT);const LNe=LT;var Uz;let DT=Uz=class extends fe{constructor(t){super(t),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new Uz({exactMatch:this.exactMatch,type:this.type,name:this.name})}};u([d({type:Boolean,json:{write:!0}})],DT.prototype,"exactMatch",void 0),u([d({type:String,json:{write:!0}})],DT.prototype,"name",void 0),u([mt(RX)],DT.prototype,"type",void 0),DT=Uz=u([P("esri.webdoc.applicationProperties.SearchTableField")],DT);const DNe=DT;var Vz;let FA=Vz=class extends fe{constructor(t){super(t),this.field=null,this.id=null}clone(){return new Vz(te({field:this.field,id:this.id}))}};u([d({type:DNe,json:{write:{isRequired:!0}}})],FA.prototype,"field",void 0),u([d({type:String,json:{write:{isRequired:!0}}})],FA.prototype,"id",void 0),FA=Vz=u([P("esri.webdoc.applicationProperties.SearchTable")],FA);const NNe=FA;var kz;const _me=ft.ofType(LNe),vme=ft.ofType(NNe);let af=kz=class extends fe{constructor(t){super(t),this.addressSearchEnabled=!0,this.enabled=!0,this.hintText=null,this.layers=new _me,this.tables=new vme}readAddressSearchEnabled(t){return!t}writeAddressSearchEnabled(t,e,r){e[r]=!t}clone(){return new kz(te({addressSearchEnabled:this.addressSearchEnabled,enabled:this.enabled,hintText:this.hintText,layers:this.layers,tables:this.tables}))}};u([d({type:Boolean,nonNullable:!0,json:{read:{source:"disablePlaceFinder"},write:{target:"disablePlaceFinder",isRequired:!0},origins:{"web-scene":{read:!1,write:!1}}}})],af.prototype,"addressSearchEnabled",void 0),u([Le("addressSearchEnabled")],af.prototype,"readAddressSearchEnabled",null),u([ke("addressSearchEnabled")],af.prototype,"writeAddressSearchEnabled",null),u([d({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-map":{write:{isRequired:!0}},"web-scene":{default:!0,write:!0}}}})],af.prototype,"enabled",void 0),u([d({type:String,json:{write:!0}})],af.prototype,"hintText",void 0),u([d({type:_me,json:{write:{overridePolicy:Mee},origins:{"web-scene":{write:{isRequired:!0}}}}})],af.prototype,"layers",void 0),u([d({type:vme,json:{read:!0,write:{overridePolicy:Mee}}})],af.prototype,"tables",void 0),af=kz=u([P("esri.webdoc.applicationProperties.Search")],af);const FNe=af;var zz;let OL=zz=class extends fe{constructor(t){super(t),this.search=null}clone(){return new zz(te({search:this.search}))}};u([d({type:FNe,json:{write:!0}})],OL.prototype,"search",void 0),OL=zz=u([P("esri.webdoc.applicationProperties.Viewing")],OL);const UNe=OL;var Bz;let ML=Bz=class extends fe{constructor(t){super(t),this.viewing=null}clone(){return new Bz({viewing:this.viewing?this.viewing.clone():null})}};u([d({type:UNe,json:{write:!0}})],ML.prototype,"viewing",void 0),ML=Bz=u([P("esri.webscene.ApplicationProperties")],ML);const VNe=ML;var Gz;let UA=Gz=class extends fe{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new Gz({cloudCover:this.cloudCover})}};u([mt({sunny:"sunny"})],UA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],UA.prototype,"cloudCover",void 0),UA=Gz=u([P("esri.views.3d.environment.SunnyWeather")],UA);const sF=UA;var jz;let VA=jz=class extends fe{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new jz({cloudCover:this.cloudCover})}};u([mt({cloudy:"cloudy"})],VA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],VA.prototype,"cloudCover",void 0),VA=jz=u([P("esri.views.3d.environment.CloudyWeather")],VA);const kNe=VA;var Hz;let kA=Hz=class extends fe{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new Hz({fogStrength:this.fogStrength})}};u([mt({foggy:"foggy"})],kA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],kA.prototype,"fogStrength",void 0),kA=Hz=u([P("esri.views.3d.environment.FoggyWeather")],kA);const zNe=kA;var qz;let NT=qz=class extends fe{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new qz({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([mt({rainy:"rainy"})],NT.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],NT.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],NT.prototype,"precipitation",void 0),NT=qz=u([P("esri.views.3d.environment.RainyWeather")],NT);const BNe=NT;var Wz;let C1=Wz=class extends fe{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new Wz({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([mt({snowy:"snowy"})],C1.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],C1.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],C1.prototype,"precipitation",void 0),u([d({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],C1.prototype,"snowCover",void 0),C1=Wz=u([P("esri.views.3d.environment.SnowyWeather")],C1);const GNe=C1,OX={key:"type",base:sF,typeMap:{sunny:sF,cloudy:kNe,rainy:BNe,snowy:GNe,foggy:zNe}},jNe=Object.keys(OX.typeMap);function HNe(t,e){return!!jNe.includes(t)||(e.error(`"${t}" is not a valid weather type`),!1)}const Sh=1e4;var Xz;let lh=Xz=class extends fe{constructor(t){super(t),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(t,e){return e.datetime!=null&&new Date(e.datetime)||null}writeDate(t,e,r){e[r]=t.getTime()}readDirectShadowsEnabled(t,e){return!!e.directShadows}writedirectShadowsEnabled(t,e,r){t&&(e[r]=t)}writeDisplayUTCOffset(t,e){t!=null&&(e.displayUTCOffset=t)}clone(){return new Xz(this.cloneConstructProperties())}cloneConstructProperties(){const t={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(t.date=new Date(this.date.getTime())),t}};u([d({readOnly:!0,type:["sun"],json:{write:!0}})],lh.prototype,"type",void 0),u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],lh.prototype,"date",void 0),u([Le("date",["datetime"])],lh.prototype,"readDate",null),u([ke("date")],lh.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],lh.prototype,"directShadowsEnabled",void 0),u([Le("directShadowsEnabled",["directShadows"])],lh.prototype,"readDirectShadowsEnabled",null),u([ke("directShadowsEnabled")],lh.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],lh.prototype,"displayUTCOffset",void 0),u([ke("displayUTCOffset")],lh.prototype,"writeDisplayUTCOffset",null),lh=Xz=u([P("esri.webscene.SunLighting")],lh);const Ow=lh;var Yz;let zA=Yz=class extends fe{constructor(t){super(t),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new Yz(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};u([d({readOnly:!0,type:["virtual"],json:{write:!0}})],zA.prototype,"type",void 0),u([d({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],zA.prototype,"directShadowsEnabled",void 0),zA=Yz=u([P("esri.webscene.VirtualLighting")],zA);const PM=zA,bme={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Ow,virtual:PM}};let PL=class extends fe{constructor(e){super(e)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],PL.prototype,"type",void 0),PL=u([P("esri.webscene.background.Background")],PL);const wme=PL,qNe=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,WNe="screenUtils.toPt: input not recognized!",xme=96;function $o(t){return t?t/72*xme:0}function Yh(t){return t?72*t/xme:0}function hi(t){if(typeof t=="string"){const e=t.match(qNe);if(e){const r=Number(e[1]),i=e[3]&&e[3].toLowerCase(),s=t.charAt(0)==="-",n=i==="px"?Yh(r):r;return s?-n:n}return console.warn(WNe),null}return t}function Zh(t=0,e=0){return{x:t,y:e}}function cs(t=0,e=0){return[t,e]}function Tme(t=0,e=0){return[t,e]}function Zo(t=0,e=0,r=0){return[t,e,r]}function zSt(t){return t}function BSt(t){return t}function GSt(t){return t}function Ff(t,e){return e?(e[0]=t.x,e[1]=t.y,e.length>2&&(e[2]=0),e):[t.x,t.y]}function XNe(t,e){const r=e.transparency!=null?XS(e.transparency):1,i=e.color;return i&&Array.isArray(i)?new Ze([i[0]||0,i[1]||0,i[2]||0,r]):null}function YNe(t,e){e.color=t.toJSON().slice(0,3);const r=RM(t.a);r!==0&&(e.transparency=r)}const gy={type:Ze,json:{type:[Ti],default:null,read:{source:["color","transparency"],reader:XNe},write:{target:{color:{type:[Ti]},transparency:{type:Ti}},writer:YNe}}},hm={type:Number,cast:hi,json:{write:!0}};var Zz;const ZNe={...gy,nonNullable:!0};let BA=Zz=class extends wme{constructor(t){super(t),this.type="color",this.color=new Ze([0,0,0,1])}clone(){return new Zz(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([mt({color:"color"},{readOnly:!0})],BA.prototype,"type",void 0),u([d(ZNe)],BA.prototype,"color",void 0),BA=Zz=u([P("esri.webscene.background.ColorBackground")],BA);const Sme=BA,Pee={base:wme,key:"type",typeMap:{color:Sme}};function JNe(t){return(e,r,i)=>{if(!e)return e;for(const s in t.typeMap)if(e.type===s){const n=new t.typeMap[s];return n.read(e,i),n}}}const KNe={types:Pee,json:{read:JNe(Pee),write:{overridePolicy:(t,e,r)=>({enabled:!r||!r.isPresentation})}}};var Jz;const Eme="esri.webscene.Environment",QNe=se.getLogger(Eme),Iee=(t,e,r)=>({enabled:!r||!r.isPresentation});let O0=Jz=class extends fe{constructor(t){super(t),this.lighting=new Ow,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(t){HNe(t==null?void 0:t.type,QNe)&&this._set("weather",t)}clone(){return new Jz(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?PM.prototype.clone.call(this.lighting):Ow.prototype.clone.call(this.lighting),background:te(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};u([d({types:bme,nonNullable:!0,json:{write:!0}})],O0.prototype,"lighting",void 0),u([d(KNe)],O0.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Iee}}})],O0.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Iee}}})],O0.prototype,"starsEnabled",void 0),u([d({types:OX,nonNullable:!0,json:{write:!0},value:new sF})],O0.prototype,"weather",null),O0=Jz=u([P(Eme)],O0);const tE=O0;var Kz;let A1=Kz=class extends fe{constructor(t){super(t),this.environment=new tE,this.spatialReference=null,this.viewpoint=null}set viewingMode(t){this._set("viewingMode",t)}clone(){return new Kz({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};u([d({type:tE,json:{write:{isRequired:!0}}})],A1.prototype,"environment",void 0),u([d({type:We})],A1.prototype,"spatialReference",void 0),u([d({type:["local","global"]})],A1.prototype,"viewingMode",null),u([d({type:Vc,json:{write:{isRequired:!0}}})],A1.prototype,"viewpoint",void 0),A1=Kz=u([P("esri.webscene.InitialViewProperties")],A1);const nF=A1;function ne(t,e,r={}){return MX(t,e,r,Cme)}function ra(t,e,r={}){return MX(t,e,r,Ame)}function MX(t,e,r={},i){let s=null;const n=r.once?(o,a)=>{i(o)&&(Vi(s),e(o,a))}:(o,a)=>{i(o)&&e(o,a)};if(s=GMe(t,n,r.sync,r.equals),r.initial){const o=t();n(o,o)}return s}function an(t,e,r,i={}){let s=null,n=null,o=null;function a(){var h;s&&n&&(n.remove(),(h=i.onListenerRemove)==null||h.call(i,s),s=null,n=null)}function l(h){i.once&&i.once&&Vi(o),r(h)}const c=ne(t,(h,p)=>{var f;a(),H4(h)&&(s=h,n=wM(h,e,l),(f=i.onListenerAdd)==null||f.call(i,h))},{sync:i.sync,initial:!0});return o=yp(()=>{c.remove(),a()}),o}function f3(t,e){return eFe(t,Ame,e)}function eFe(t,e,r){if(Fn(r))return Promise.reject(qr());const i=t();if(e!=null&&e(i))return Promise.resolve(i);let s=null;function n(){s=Vi(s)}return new Promise((o,a)=>{s=US([ba(r,()=>{n(),a(qr())}),MX(t,l=>{n(),o(l)},{sync:!1,once:!0},e??Cme)])})}function Cme(t){return!0}function Ame(t){return!!t}const ri={sync:!0},kt={initial:!0},qs={sync:!0,initial:!0},tFe={"web-scene/operational-layers":{ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!0,LineOfSightLayer:!0},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":{ArcGISAnnotationLayer:!0,ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,MediaLayer:!0,OGCFeatureLayer:!0,OrientedImageryLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-map/basemap":{ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},"web-map/tables":{ArcGISFeatureLayer:!0},"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0,OrientedImageryLayer:!0}},$ee={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},rFe={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function iFe(t,e){const r=new Date(t,e+1,1);return r.setDate(0),r.getDate()}function nw(t,e,r){const i=new Date(t.getTime());if(e&&r){const s=rFe[r],{getter:n,setter:o,multiplier:a}=s;if(r==="months"){const l=iFe(i.getFullYear(),i.getMonth()+e);i.getDate()>l&&i.setDate(l)}i[o](i[n]()+e*a)}return i}function Lee(t,e){switch(e){case"milliseconds":return new Date(t.getTime());case"seconds":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds());case"minutes":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes());case"hours":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());case"days":return new Date(t.getFullYear(),t.getMonth(),t.getDate());case"weeks":return new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay());case"months":return new Date(t.getFullYear(),t.getMonth(),1);case"years":return new Date(t.getFullYear(),0,1);case"decades":return new Date(t.getFullYear()-t.getFullYear()%10,0,1);case"centuries":return new Date(t.getFullYear()-t.getFullYear()%100,0,1);default:return new Date}}function sFe(t,e,r){return t===0?0:t*$ee[e]/$ee[r]}var xd;let du=xd=class extends fe{static get allTime(){return Dee}static get empty(){return nFe}constructor(t){super(t),this.end=null,this.start=null}readEnd(t,e){return e.end!=null?new Date(e.end):null}writeEnd(t,e){e.end=t?t.getTime():null}get isAllTime(){return this.equals(xd.allTime)}get isEmpty(){return this.equals(xd.empty)}readStart(t,e){return e.start!=null?new Date(e.start):null}writeStart(t,e){e.start=t?t.getTime():null}clone(){return new xd({end:this.end,start:this.start})}equals(t){if(!t)return!1;const e=v(this.start)?this.start.getTime():this.start,r=v(this.end)?this.end.getTime():this.end,i=v(t.start)?t.start.getTime():t.start,s=v(t.end)?t.end.getTime():t.end;return e===i&&r===s}expandTo(t){if(this.isEmpty||this.isAllTime)return this.clone();const e=ao(this.start,i=>Lee(i,t)),r=ao(this.end,i=>{const s=Lee(i,t);return i.getTime()===s.getTime()?s:nw(s,1,t)});return new xd({start:e,end:r})}intersection(t){if(!t)return this.clone();if(this.isEmpty||t.isEmpty)return xd.empty;if(this.isAllTime)return t.clone();if(t.isAllTime)return this.clone();const e=xu(this.start,-1/0,a=>a.getTime()),r=xu(this.end,1/0,a=>a.getTime()),i=xu(t.start,-1/0,a=>a.getTime()),s=xu(t.end,1/0,a=>a.getTime());let n,o;if(i>=e&&i<=r?n=i:e>=i&&e<=s&&(n=e),r>=i&&r<=s?o=r:s>=e&&s<=r&&(o=s),n!=null&&o!=null&&!isNaN(n)&&!isNaN(o)){const a=new xd;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return xd.empty}offset(t,e){if(this.isEmpty||this.isAllTime)return this.clone();const r=new xd,{start:i,end:s}=this;return v(i)&&(r.start=nw(i,t,e)),v(s)&&(r.end=nw(s,t,e)),r}union(t){if(!t||t.isEmpty)return this.clone();if(this.isEmpty)return t.clone();if(this.isAllTime||t.isAllTime)return Dee.clone();const e=v(this.start)&&v(t.start)?new Date(Math.min(this.start.getTime(),t.start.getTime())):null,r=v(this.end)&&v(t.end)?new Date(Math.max(this.end.getTime(),t.end.getTime())):null;return new xd({start:e,end:r})}};u([d({type:Date,json:{write:{allowNull:!0}}})],du.prototype,"end",void 0),u([Le("end")],du.prototype,"readEnd",null),u([ke("end")],du.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],du.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],du.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],du.prototype,"start",void 0),u([Le("start")],du.prototype,"readStart",null),u([ke("start")],du.prototype,"writeStart",null),du=xd=u([P("esri.TimeExtent")],du);const Dee=new du,nFe=new du({start:void 0,end:void 0}),Sm=du;function oFe(t){if(!t)return t;const{start:e,end:r}=t;return new Sm({start:v(e)?nw(e,-e.getTimezoneOffset(),"minutes"):e,end:v(r)?nw(r,-r.getTimezoneOffset(),"minutes"):r})}function aFe(t){if(!t)return t;const{start:e,end:r}=t;return new Sm({start:v(e)?nw(e,e.getTimezoneOffset(),"minutes"):e,end:v(r)?nw(r,r.getTimezoneOffset(),"minutes"):r})}var rE;function lFe(t,e){switch(t.type){case"range":{const r="range"in t?t.range[0]:t.minValue,i="range"in t?t.range[1]:t.maxValue;if(r!=null&&+e<r||i!=null&&+e>i)return rE.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(t.codedValues==null||t.codedValues.every(r=>r==null||r.code!==e))return rE.INVALID_CODED_VALUE}return null}(function(t){t.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",t.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(rE||(rE={}));const cFe=se.getLogger("esri.support.arcadeOnDemand");let PU;function dm(){return PU||(PU=(async()=>{const t=await ie(()=>import("./arcadeUtils-25d26f6d.js").then(e=>e.ax),["./arcadeUtils-25d26f6d.js","./arcadeTimeUtils-486f1fea.js","./executionError-fb3f283a.js","./number-01f3944a.js","./hash-0ddfbf4b.js"],import.meta.url);return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}})()),PU}const uFe=(t,e,r)=>PX.create(t,e,r,null,["$feature"]),hFe=(t,e,r)=>PX.create(t,e,r,null,["$feature","$view"]),dFe=(t,e,r,i)=>PX.create(t,e,r,i,["$feature","$view"]);let PX=class Rme{constructor(e,r,i,s,n,o,a){this.script=e,this.evaluate=s;const l=Array.isArray(o)?o:o.fields;this.fields=l,this._syntaxTree=i,this._arcade=r,this._arcadeFeature=n,this._spatialReference=a,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(e,r,i,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await dm(),h=We.fromJSON(r);let p;try{p=a.parseScript(e,o)}catch(I){return cFe.error(new j("arcade-bad-expression","Failed to parse arcade script",{script:e,error:I})),null}const f=n.reduce((I,U)=>({...I,[U]:null}),{});let m=null;v(s)&&(m=new c(s),m.immutable=!0,f.$config=null);const y=a.scriptUsesGeometryEngine(p),_=y&&a.enableGeometrySupport(),b=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),x=a.scriptIsAsync(p),T=x&&a.enableAsyncSupport(),S={vars:f,spatialReference:h,useAsync:!!T};await Promise.all([_,b,T]);const E=new Set;await a.loadDependentModules(E,p,null,x,y);const O=new c;O.immutable=!1,O.setField("scale",0);const R=a.compileScript(p,S),L=I=>("$view"in I&&I.$view&&(O.setField("scale",typeof I.$view=="object"?I.$view.scale:void 0),I.$view=O),m&&(I.$config=m),R({vars:I,spatialReference:h}));return new Rme(e,a,p,L,new l,i,h)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};const pFe=/^([0-9])/,fFe=/[^a-z0-9_\u0080-\uffff]/gi,mFe=/_{2,}/g,gFe=/^_/,yFe=/_$/;function _Fe(t){return t==null?null:t.trim().replace(fFe,"_").replace(mFe,"_").replace(gFe,"").replace(yFe,"").replace(pFe,"F$1")||null}const vFe=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],bFe=["field","normalizationField"];function Nee(t,e){if(t!=null&&e!=null){for(const r of Array.isArray(t)?t:[t])if(Fee(vFe,r,e),"visualVariables"in r&&r.visualVariables)for(const i of r.visualVariables)Fee(bFe,i,e)}}function Fee(t,e,r){if(t)for(const i of t){const s=yM(i,e),n=s&&typeof s!="function"&&r.get(s);n&&sl(i,n.name,e)}}function Ome(t,e){var r;if(t!=null&&((r=e==null?void 0:e.fields)!=null&&r.length))if("startField"in t){const i=e.get(t.startField),s=e.get(t.endField);t.startField=(i==null?void 0:i.name)??null,t.endField=(s==null?void 0:s.name)??null}else{const i=e.get(t.startTimeField),s=e.get(t.endTimeField);t.startTimeField=(i==null?void 0:i.name)??null,t.endTimeField=(s==null?void 0:s.name)??null}}const IU=new Set;function Mme(t,e){return t&&e?(IU.clear(),m3(IU,t,e),Array.from(IU).sort()):[]}function m3(t,e,r){var i;if(r)if((i=e==null?void 0:e.fields)!=null&&i.length)if(r.includes("*"))for(const{name:s}of e.fields)t.add(s);else for(const s of r)Pu(t,e,s);else{if(r.includes("*"))return t.clear(),void t.add("*");for(const s of r)s!=null&&t.add(s)}}function Pu(t,e,r){if(typeof r=="string")if(e){const i=e.get(r);i&&t.add(i.name)}else t.add(r)}function jSt(t,e){return C(e)||C(t)?[]:e.includes("*")?(t.fields??[]).map(r=>r.name):e}async function Wl(t,e,r){var n;if(!r)return;const{arcadeUtils:i}=await dm(),s=i.extractFieldNames(r,(n=e==null?void 0:e.fields)==null?void 0:n.map(o=>o.name));for(const o of s)Pu(t,e,o)}async function Pme(t,e,r){if(r&&r!=="1=1"){const i=(await ie(()=>import("./WhereClause-544968d0.js").then(s=>s.W),["./WhereClause-544968d0.js","./executionError-fb3f283a.js"],import.meta.url)).WhereClause.create(r,e);if(!i.isStandardized)throw new j("fieldUtils:collectFilterFields","Where clause is not standardized",{where:r});m3(t,e,i.fieldNames)}}function wFe({displayField:t,fields:e}){return t||(e&&e.length?$U(e,"name-or-title")||$U(e,"unique-identifier")||$U(e,"type-or-category")||xFe(e):null)}function xFe(t){for(const e of t){if(!e||!e.name)continue;const r=e.name.toLowerCase();if(r.includes("name")||r.includes("title"))return e.name}return null}function $U(t,e){for(const r of t)if(r&&r.valueType&&r.valueType===e)return r.name;return null}async function HSt(t,e){var i;if(!e)return;const r=(i=e.elevationInfo)==null?void 0:i.featureExpressionInfo;return r?r.collectRequiredFields(t,e.fieldsIndex):void 0}function TFe(t,e,r){r.onStatisticExpression?Wl(t,e,r.onStatisticExpression.expression):t.add(r.onStatisticField)}async function qSt(t,e,r){if(!e||!r||!("fields"in r))return;const i=[],s=r.popupTemplate;i.push(SFe(t,e,s)),r.fields&&i.push(...r.fields.map(async n=>TFe(t,e.fieldsIndex,n))),await Promise.all(i)}async function SFe(t,e,r){const i=[];r!=null&&r.expressionInfos&&i.push(...r.expressionInfos.map(n=>Wl(t,e.fieldsIndex,n.expression)));const s=r==null?void 0:r.content;if(Array.isArray(s))for(const n of s)n.type==="expression"&&n.expressionInfo&&i.push(Wl(t,e.fieldsIndex,n.expressionInfo.expression));await Promise.all(i)}async function WSt(t,e,r){e&&(e.timeInfo&&v(r)&&r.timeExtent&&m3(t,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),e.floorInfo&&m3(t,e.fieldsIndex,[e.floorInfo.floorField]),v(r)&&v(r.where)&&await Pme(t,e.fieldsIndex,r.where))}async function XSt(t,e,r){e&&r&&await Promise.all(r.map(i=>EFe(t,e,i)))}async function EFe(t,e,r){e&&r&&(r.valueExpression?await Wl(t,e.fieldsIndex,r.valueExpression):r.field&&Pu(t,e.fieldsIndex,r.field))}function YSt(t){if(!t)return[];const e="editFieldsInfo"in t&&t.editFieldsInfo;return e?Mme(t.fieldsIndex,[e&&e.creatorField,e&&e.creationDateField,e&&e.editorField,e&&e.editDateField]):[]}async function ZSt(t,e){const{labelingInfo:r,fieldsIndex:i}=e;r&&r.length&&await Promise.all(r.map(s=>CFe(t,i,s)))}async function CFe(t,e,r){if(!r)return;const i=r.getLabelExpression(),s=r.where;if(i.type==="arcade")await Wl(t,e,i.expression);else{const n=i.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{Pu(t,e,o.slice(1,-1))})}await Pme(t,e,s)}function AFe(t){const e=t.defaultValue;return e!==void 0&&Lme(t,e)?e:t.nullable?null:void 0}function Ime(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function RFe(t){return t===null||Ime(t)}const IX="isInteger"in Number?Number.isInteger:t=>typeof t=="number"&&isFinite(t)&&Math.floor(t)===t;function OFe(t){return t===null||IX(t)}function $me(t){return t!=null&&typeof t=="string"}function MFe(t){return t===null||$me(t)}function PFe(){return!0}function Lme(t,e){let r;switch(t.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":r=t.nullable?OFe:IX;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":r=t.nullable?RFe:Ime;break;case"string":case"esriFieldTypeString":r=t.nullable?MFe:$me;break;default:r=PFe}return arguments.length===1?r:r(e)}const IFe=["integer","small-integer","single","double"],$Fe=new Set([...IFe,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function h5(t){return t!=null&&$Fe.has(t.type)}function JSt(t){return t!=null&&(t.type==="string"||t.type==="esriFieldTypeString")}var oF,aF;function KSt(t){return t==null||typeof t=="number"&&isNaN(t)?null:t}function QSt(t,e){return t==null||t.nullable&&e===null?null:h5(t)&&!LFe(t.type,Number(e))?oF.OUT_OF_RANGE:Lme(t,e)?t.domain?lFe(t.domain,e):null:aF.INVALID_TYPE}function LFe(t,e){const r=typeof t=="string"?Dme(t):t;if(!r)return!1;const i=r.min,s=r.max;return r.isInteger?IX(e)&&e>=i&&e<=s:e>=i&&e<=s}function Dme(t){switch(t){case"esriFieldTypeSmallInteger":case"small-integer":return DFe;case"esriFieldTypeInteger":case"integer":return NFe;case"esriFieldTypeSingle":case"single":return FFe;case"esriFieldTypeDouble":case"double":return UFe}}(function(t){t.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(oF||(oF={})),function(t){t.INVALID_TYPE="type-validation-error::invalid-type"}(aF||(aF={}));const DFe={min:-32768,max:32767,isInteger:!0},NFe={min:-2147483648,max:2147483647,isInteger:!0},FFe={min:-34e37,max:12e37,isInteger:!1},UFe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function eEt(t,e,r){switch(t){case rE.INVALID_CODED_VALUE:return`Value ${r} is not in the coded domain - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case rE.VALUE_OUT_OF_RANGE:return`Value ${r} is out of the range of valid values - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case aF.INVALID_TYPE:return`Value ${r} is not a valid value for the field type - field: ${e.name}, type: ${e.type}, nullable: ${e.nullable}`;case oF.OUT_OF_RANGE:{const{min:i,max:s}=Dme(e.type);return`Value ${r} is out of range for the number type - field: ${e.name}, type: ${e.type}, value range is ${i} to ${s}`}}}function VFe(t,e){return!kFe(t,e,null)}function kFe(t,e,r){if(!e||!e.attributes||!t){if(v(r))for(const n of t??[])r.add(n);return!0}const i=e.attributes;let s=!1;for(const n of t)if(!(n in i)){if(s=!0,!v(r))break;r.add(n)}return s}function Nme(t){return!!t&&["raster.itempixelvalue","raster.servicepixelvalue"].some(e=>t.toLowerCase().startsWith(e))}var Qz;let GA=Qz=class extends fe{constructor(t){super(t)}async collectRequiredFields(t,e){return Wl(t,e,this.expression)}clone(){return new Qz({expression:this.expression,title:this.title})}equals(t){return this.expression===t.expression&&this.title===t.title}};u([d({type:String,json:{write:!0}})],GA.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],GA.prototype,"title",void 0),GA=Qz=u([P("esri.layers.support.FeatureExpressionInfo")],GA);const Uee=GA,iE={inches:vn(1,"meters","inches"),feet:vn(1,"meters","feet"),"us-feet":vn(1,"meters","us-feet"),yards:vn(1,"meters","yards"),miles:vn(1,"meters","miles"),"nautical-miles":vn(1,"meters","nautical-miles"),millimeters:vn(1,"meters","millimeters"),centimeters:vn(1,"meters","centimeters"),decimeters:vn(1,"meters","decimeters"),meters:vn(1,"meters","meters"),kilometers:vn(1,"meters","kilometers"),"decimal-degrees":1/rIe(1,"meters",br.radius)};function zFe(t){return!!t&&iE[t]!=null}function BFe(t){return 1/(iE[t]||1)}function GFe(){const t=Object.keys(iE);return t.sort(),t}const jFe=GFe();var eB;const DP=Ra()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),Vee=new Vr({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let sg=eB=class extends fe{constructor(t){super(t),this.offset=null}readFeatureExpressionInfo(t,e){return t??(e.featureExpression&&e.featureExpression.value===0?{expression:"0"}:void 0)}writeFeatureExpressionInfo(t,e,r,i){e[r]=t.write({},i),t.expression==="0"&&(e.featureExpression={value:0})}get mode(){const{offset:t,featureExpressionInfo:e}=this;return this._isOverridden("mode")?this._get("mode"):v(t)||e?"relative-to-ground":"on-the-ground"}set mode(t){this._override("mode",t)}set unit(t){this._set("unit",t)}write(t,e){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(t,e):null}clone(){return new eB({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}equals(t){return this.mode===t.mode&&this.offset===t.offset&&this.unit===t.unit&&JOe(this.featureExpressionInfo,t.featureExpressionInfo)}};u([d({type:Uee,json:{write:!0}})],sg.prototype,"featureExpressionInfo",void 0),u([Le("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],sg.prototype,"readFeatureExpressionInfo",null),u([ke("featureExpressionInfo",{featureExpressionInfo:{type:Uee},"featureExpression.value":{type:[0]}})],sg.prototype,"writeFeatureExpressionInfo",null),u([d({type:DP.apiValues,nonNullable:!0,json:{type:DP.jsonValues,read:DP.read,write:{writer:DP.write,isRequired:!0}}})],sg.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],sg.prototype,"offset",void 0),u([d({type:jFe,json:{type:String,read:Vee.read,write:Vee.write}})],sg.prototype,"unit",null),sg=eB=u([P("esri.layers.support.ElevationInfo")],sg);const HFe=sg,qFe={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},$X={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(t,e)=>!e.disablePopup},write:{enabled:!0,writer(t,e,r){e[r]=!t}}}},LX={type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",write:!0}},WFe={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:nv}}},XFe={type:Boolean,value:!0,nonNullable:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},YFe={value:null,type:HFe,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function tEt(t){return{type:t,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const Fme={write:!0,read:!0},tB={type:Number,json:{origins:{"web-document":Fme,"portal-item":{write:!0}}}},ZFe={...tB,json:{...tB.json,origins:{"web-document":{...Fme,write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}}},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(t,e,r)=>r&&r.origin!=="service"||!e.drawingInfo||e.drawingInfo.transparency===void 0?e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.transparency!==void 0?XS(e.layerDefinition.drawingInfo.transparency):void 0:XS(e.drawingInfo.transparency)}}},rEt={type:Sm,readOnly:!0,get(){var a,l;if(!((a=this.layer)!=null&&a.timeInfo))return null;const{datesInUnknownTimezone:t,timeOffset:e,useViewTime:r}=this.layer,i=(l=this.view)==null?void 0:l.timeExtent;let s=this.layer.timeExtent;t&&(s=aFe(s));let n=r?i&&s?i.intersection(s):i||s:s;if(!n||n.isEmpty||n.isAllTime)return n;e&&(n=n.offset(-e.value,e.unit)),t&&(n=oFe(n));const o=this._get("timeExtent");return n.equals(o)?o:n}},iEt={type:Hr,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(t,e)=>{const r=Hr.fromJSON(t);return e.spatialReference!=null&&typeof e.spatialReference=="object"&&(r.spatialReference=We.fromJSON(e.spatialReference)),r}}}},read:!1}},JFe={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},KFe={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},QFe={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},Ume={json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}},e4e=t=>{let e=class extends t{constructor(){super(...arguments),this.title=null}writeListMode(r,i,s,n){(n&&n.layerContainerType==="ground"||r&&IPe(this,s,{},n))&&(i[s]=r)}writeOperationalLayerType(r,i,s,n){!r||n&&n.layerContainerType==="tables"||(i.layerType=r)}writeTitle(r,i){i.title=r??"Layer"}read(r,i){i&&(i.layer=this),Kde(this,r,s=>super.read(r,s),i)}write(r,i){var o,a;if(i!=null&&i.origin){const l=`${i.origin}/${i.layerContainerType||"operational-layers"}`,c=tFe[l];let h=c&&c[this.operationalLayerType];if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&l==="web-scene/operational-layers"&&(h=!1),this.operationalLayerType==="ArcGISDimensionLayer"&&l==="web-map/operational-layers"&&(h=!1),!h)return(o=i.messages)==null||o.push(new j("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${l}'`,{layer:this})),null}const s=super.write(r,{...i,layer:this}),n=!!i&&!!i.messages&&!!i.messages.filter(l=>l instanceof j&&l.name==="web-document-write:property-required").length;return FS(s==null?void 0:s.url)?((a=i==null?void 0:i.messages)==null||a.push(new j("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&n?null:s}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],e.prototype,"id",void 0),u([d(Ume)],e.prototype,"listMode",void 0),u([ke("listMode")],e.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],e.prototype,"operationalLayerType",void 0),u([ke("operationalLayerType")],e.prototype,"writeOperationalLayerType",null),u([d(tB)],e.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],e.prototype,"title",void 0),u([ke("title"),ke(["web-scene"],"title")],e.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility"}})],e.prototype,"visible",void 0),e=u([P("esri.layers.mixins.OperationalLayer")],e),e};function t4e(t){return"operationalLayerType"in t}function Mw(t){const e=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],r=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],i=t[2]*t[2]+t[6]*t[6]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))}function r4e(t,e){const r=Math.sqrt(e[0]*e[0]+e[4]*e[4]+e[8]*e[8]),i=Math.sqrt(e[1]*e[1]+e[5]*e[5]+e[9]*e[9]),s=Math.sqrt(e[2]*e[2]+e[6]*e[6]+e[10]*e[10]);return ce(t,r,i,s),t}function sEt(t,e,r){r=r||t;const i=_e(t,e);ce(r,t[0]-i*e[0],t[1]-i*e[1],t[2]-i*e[2]),ve(r,r)}function nEt(t,e,r){Math.abs(t[0])>Math.abs(t[1])?ce(e,0,1,0):ce(e,1,0,0),pt(r,t,e),ve(e,e),pt(e,r,t),ve(r,r)}function i4e(t,e){return(t%e+e)%e}function NP(t,e,r,i,s,n){const o=t+(e-t)*s;return o+(r+(i-r)*s-o)*n}function s4e(t,e,r,i=M()){const s=Me(t),n=Me(e),o=_e(t,e)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-r)*s+r*n)/Math.sin(a),c=l/s*Math.sin((1-r)*a),h=l/n*Math.sin(r*a);return ae(Gb,t,c),ae(jb,e,h),me(i,Gb,jb)}return Qs(i,t,e,r)}function oEt(t,e,r,i=M(),s=M()){const n=Me(t),o=Me(e),a=_e(t,e)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(r*l),p=Math.sin((1-r)*l),f=(1-r)*n+r*o;{const m=f/c,y=m/o*h;ae(Gb,t,m/n*p),ae(jb,e,y),me(i,Gb,jb)}{const m=1/n*(-Math.cos((1-r)*l)*l*f+p*(-n+o));ae(Gb,t,m);const y=1/o*(Math.cos(r*l)*l*f+h*(-n+o));ae(jb,e,y),me(s,Gb,jb),ae(s,s,1/c)}return s}return Qs(i,t,e,r),ge(s,e,t),ve(s,s),s}function IL(t,e,r){t=ve(Gb,t),e=ve(jb,e);const i=An(_e(t,e));if(r){const s=pt(n4e,t,e);if(_e(s,r)<0)return-i}return i}function $L(t){const e=t.length;return r=>{if(r<=t[0][0])return t[0][1];if(r>=t[e-1][0])return t[e-1][1];let i=1;for(;r>t[i][0];)i++;const s=t[i-1][0],n=t[i][0],o=(n-r)/(n-s);return o*t[i-1][1]+(1-o)*t[i][1]}}function aEt(t,e,r,i){ge(kee,e,t),ge(zee,r,t),pt(i,kee,zee),ve(i,i),i[3]=-_e(t,i)}const kee=M(),zee=M(),n4e=M(),Gb=M(),jb=M();let LL=class extends fe{constructor(e){super(e),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression","relationship"],readOnly:!0,json:{read:!1,write:!0}})],LL.prototype,"type",void 0),LL=u([P("esri.popup.content.Content")],LL);const Sv=LL;var rB;let R1=rB=class extends Sv{constructor(t){super(t),this.description=null,this.displayType="auto",this.title=null,this.type="attachments"}clone(){return new rB({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],R1.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],R1.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],R1.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],R1.prototype,"type",void 0),R1=rB=u([P("esri.popup.content.AttachmentsContent")],R1);const g3=R1;var iB;let O1=iB=class extends Sv{constructor(t){super(t),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new iB({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?te(this.outFields):null})}};u([d()],O1.prototype,"creator",void 0),u([d()],O1.prototype,"destroyer",void 0),u([d()],O1.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],O1.prototype,"type",void 0),O1=iB=u([P("esri.popup.content.CustomContent")],O1);const o4e=O1;var sB;let FT=sB=class extends fe{constructor(t){super(t),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new sB({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],FT.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],FT.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],FT.prototype,"returnType",void 0),FT=sB=u([P("esri.popup.ElementExpressionInfo")],FT);const Vme=FT;var nB;let jA=nB=class extends Sv{constructor(t){super(t),this.expressionInfo=null,this.type="expression"}clone(){var t;return new nB({expressionInfo:(t=this.expressionInfo)==null?void 0:t.clone()})}};u([d({type:Vme,json:{write:!0}})],jA.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],jA.prototype,"type",void 0),jA=nB=u([P("esri.popup.content.ExpressionContent")],jA);const DX=jA,y3=Ra()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});y3.toJSON.bind(y3);y3.fromJSON.bind(y3);const Np={year:"numeric",month:"numeric",day:"numeric"},xC={year:"numeric",month:"long",day:"numeric"},TC={year:"numeric",month:"short",day:"numeric"},SC={year:"numeric",month:"long",weekday:"long",day:"numeric"},ch={hour:"numeric",minute:"numeric"},ud={...ch,second:"numeric"},NX={"short-date":Np,"short-date-short-time":{...Np,...ch},"short-date-short-time-24":{...Np,...ch,hour12:!1},"short-date-long-time":{...Np,...ud},"short-date-long-time-24":{...Np,...ud,hour12:!1},"short-date-le":Np,"short-date-le-short-time":{...Np,...ch},"short-date-le-short-time-24":{...Np,...ch,hour12:!1},"short-date-le-long-time":{...Np,...ud},"short-date-le-long-time-24":{...Np,...ud,hour12:!1},"long-month-day-year":xC,"long-month-day-year-short-time":{...xC,...ch},"long-month-day-year-short-time-24":{...xC,...ch,hour12:!1},"long-month-day-year-long-time":{...xC,...ud},"long-month-day-year-long-time-24":{...xC,...ud,hour12:!1},"day-short-month-year":TC,"day-short-month-year-short-time":{...TC,...ch},"day-short-month-year-short-time-24":{...TC,...ch,hour12:!1},"day-short-month-year-long-time":{...TC,...ud},"day-short-month-year-long-time-24":{...TC,...ud,hour12:!1},"long-date":SC,"long-date-short-time":{...SC,...ch},"long-date-short-time-24":{...SC,...ch,hour12:!1},"long-date-long-time":{...SC,...ud},"long-date-long-time-24":{...SC,...ud,hour12:!1},"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":ch,"long-time":ud},_3=Ra()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});_3.apiValues;_3.toJSON.bind(_3);_3.fromJSON.bind(_3);const a4e={ar:"ar-u-nu-latn-ca-gregory"};let oB=new WeakMap,kme=NX["short-date-short-time"];function l4e(t){const e=t||kme;let r=oB.get(e);if(!r){const i=Vh(),s=a4e[Vh()]||i;r=new Intl.DateTimeFormat(s,e),oB.set(e,r)}return r}function d5(t){return t?NX[t]:null}function pm(t,e){return l4e(e).format(t)}BW(()=>{oB=new WeakMap,kme=NX["short-date-short-time"]});const c4e={ar:"ar-u-nu-latn"};let DL=new WeakMap,zme={};function u4e(t){const e=t||zme;if(!DL.has(e)){const r=Vh(),i=c4e[Vh()]||r;DL.set(e,new Intl.NumberFormat(i,t))}return DL.get(e)}function Bme(t={}){const e={};return t.digitSeparator!=null&&(e.useGrouping=t.digitSeparator),t.places!=null&&(e.minimumFractionDigits=e.maximumFractionDigits=t.places),e}function fm(t,e){return t===-0&&(t=0),u4e(e).format(t)}BW(()=>{DL=new WeakMap,zme={}});var aB;let M1=aB=class extends fe{constructor(t){super(t),this.dateFormat=null,this.dateTimeFormatOptions=null,this.digitSeparator=!1,this.places=null}clone(){return new aB({dateFormat:this.dateFormat,digitSeparator:this.digitSeparator,places:this.places})}format(t){return this.dateFormat?pm(t,{...d5(this.dateFormat),...this.dateTimeFormatOptions}):fm(t,Bme(this))}formatRasterPixelValue(t){if(t.includes("-"))return t;let e,r;return t.trim().includes(",")?(e=",",r=e+" ",this._formatDelimitedString(t,e,r,this)):t.trim().includes(";")?(e=";",r=e+" ",this._formatDelimitedString(t,e,r,this)):t.trim().includes(" ")?(e=r=" ",this._formatDelimitedString(t,e,r,this)):this.format(Number(t))}_formatDelimitedString(t,e,r,i){return t&&e&&r&&i?t.trim().split(e).map(s=>this.format(Number(s))).join(r):t}};u([mt(y3)],M1.prototype,"dateFormat",void 0),u([d({type:Object,json:{read:!1}})],M1.prototype,"dateTimeFormatOptions",void 0),u([d({type:Boolean,json:{write:!0}})],M1.prototype,"digitSeparator",void 0),u([d({type:Ti,json:{write:!0}})],M1.prototype,"places",void 0),M1=aB=u([P("esri.popup.support.FieldInfoFormat")],M1);const D2=M1;var lB;let Td=lB=class extends fe{constructor(t){super(t),this.fieldName=null,this.format=null,this.isEditable=!1,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new lB({fieldName:this.fieldName,format:this.format?te(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],Td.prototype,"fieldName",void 0),u([d({type:D2,json:{write:!0}})],Td.prototype,"format",void 0),u([d({type:Boolean,json:{write:!0,default:!1}})],Td.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],Td.prototype,"label",void 0),u([mt(new Vr({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],Td.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],Td.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],Td.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],Td.prototype,"visible",void 0),Td=lB=u([P("esri.popup.FieldInfo")],Td);const IM=Td;var cB;let ng=cB=class extends Sv{constructor(t){super(t),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(t,e){e.fieldInfos=t&&t.map(r=>r.toJSON())}clone(){return new cB(te({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],ng.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],ng.prototype,"description",void 0),u([d({type:[IM]})],ng.prototype,"fieldInfos",void 0),u([ke("fieldInfos")],ng.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],ng.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],ng.prototype,"type",void 0),ng=cB=u([P("esri.popup.content.FieldsContent")],ng);const sE=ng;let P1=class extends fe{constructor(e){super(e),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],P1.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],P1.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],P1.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],P1.prototype,"type",void 0),P1=u([P("esri.popup.content.mixins.MediaInfo")],P1);const FX=P1;var uB;let UT=uB=class extends Te{constructor(t){super(t),this.fieldName=null,this.tooltip=null,this.value=null}clone(){return new uB({fieldName:this.fieldName,tooltip:this.tooltip,value:this.value})}};u([d()],UT.prototype,"fieldName",void 0),u([d()],UT.prototype,"tooltip",void 0),u([d()],UT.prototype,"value",void 0),UT=uB=u([P("esri.popup.content.support.ChartMediaInfoValueSeries")],UT);const Gme=UT;var hB;let I1=hB=class extends fe{constructor(t){super(t),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new hB({fields:te(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],I1.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],I1.prototype,"normalizeField",void 0),u([d({type:[Gme],json:{read:!1}})],I1.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],I1.prototype,"tooltipField",void 0),I1=hB=u([P("esri.popup.content.support.ChartMediaInfoValue")],I1);const h4e=I1;let HA=class extends FX{constructor(e){super(e),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],HA.prototype,"type",void 0),u([d({type:h4e,json:{write:!0}})],HA.prototype,"value",void 0),HA=u([P("esri.popup.content.mixins.ChartMediaInfo")],HA);const p5=HA,f5=Ra()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var dB;let NL=dB=class extends p5{constructor(t){super(t),this.type="bar-chart"}clone(){return new dB({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:f5.write}})],NL.prototype,"type",void 0),NL=dB=u([P("esri.popup.content.BarChartMediaInfo")],NL);const jme=NL;var pB;let FL=pB=class extends p5{constructor(t){super(t),this.type="column-chart"}clone(){return new pB({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:f5.write}})],FL.prototype,"type",void 0),FL=pB=u([P("esri.popup.content.ColumnChartMediaInfo")],FL);const Hme=FL;var fB;let qA=fB=class extends fe{constructor(t){super(t),this.linkURL=null,this.sourceURL=null}clone(){return new fB({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],qA.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],qA.prototype,"sourceURL",void 0),qA=fB=u([P("esri.popup.content.support.ImageMediaInfoValue")],qA);const d4e=qA;var mB;let VT=mB=class extends FX{constructor(t){super(t),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new mB({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],VT.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],VT.prototype,"type",void 0),u([d({type:d4e,json:{write:!0}})],VT.prototype,"value",void 0),VT=mB=u([P("esri.popup.content.ImageMediaInfo")],VT);const qme=VT;var gB;let UL=gB=class extends p5{constructor(t){super(t),this.type="line-chart"}clone(){return new gB({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:f5.write}})],UL.prototype,"type",void 0),UL=gB=u([P("esri.popup.content.LineChartMediaInfo")],UL);const Wme=UL;var yB;let VL=yB=class extends p5{constructor(t){super(t),this.type="pie-chart"}clone(){return new yB({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:f5.write}})],VL.prototype,"type",void 0),VL=yB=u([P("esri.popup.content.PieChartMediaInfo")],VL);const Xme=VL,Yme={base:FX,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":jme,"column-chart":Hme,"line-chart":Wme,"pie-chart":Xme,image:qme}};var _B;let Sd=_B=class extends Sv{constructor(t){super(t),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(t){return t&&t.map(e=>e.type==="image"?qme.fromJSON(e):e.type==="barchart"?jme.fromJSON(e):e.type==="columnchart"?Hme.fromJSON(e):e.type==="linechart"?Wme.fromJSON(e):e.type==="piechart"?Xme.fromJSON(e):void 0).filter(Boolean)}writeMediaInfos(t,e){e.mediaInfos=t&&t.map(r=>r.toJSON())}clone(){return new _B(te({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],Sd.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],Sd.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],Sd.prototype,"description",void 0),u([d({types:[Yme]})],Sd.prototype,"mediaInfos",void 0),u([Le("mediaInfos")],Sd.prototype,"readMediaInfos",null),u([ke("mediaInfos")],Sd.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],Sd.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],Sd.prototype,"type",void 0),Sd=_B=u([P("esri.popup.content.MediaContent")],Sd);const v3=Sd;var vB;let WA=vB=class extends fe{constructor(t){super(t),this.field=null,this.order=null}clone(){return new vB({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],WA.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],WA.prototype,"order",void 0),WA=vB=u([P("esri.popup.support.RelatedRecordsInfoFieldOrder")],WA);const UX=WA;let lf=class extends bs(Sv){constructor(e){super(e),this.description=null,this.displayCount=null,this.displayType="list",this.orderByFields=null,this.relationshipId=null,this.title=null,this.type="relationship"}};u([d({type:String,json:{write:!0}})],lf.prototype,"description",void 0),u([d({type:Number,json:{type:Ti,write:!0}})],lf.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],lf.prototype,"displayType",void 0),u([d({type:[UX],json:{write:!0}})],lf.prototype,"orderByFields",void 0),u([d({type:Number,json:{type:Ti,write:!0}})],lf.prototype,"relationshipId",void 0),u([d({type:String,json:{write:!0}})],lf.prototype,"title",void 0),u([d({type:["relationship"],readOnly:!0,json:{read:!1,write:!0}})],lf.prototype,"type",void 0),lf=u([P("esri.popup.content.RelationshipContent")],lf);const lF=lf;var bB;let XA=bB=class extends Sv{constructor(t){super(t),this.text=null,this.type="text"}clone(){return new bB({text:this.text})}};u([d({type:String,json:{write:!0}})],XA.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],XA.prototype,"type",void 0),XA=bB=u([P("esri.popup.content.TextContent")],XA);const nE=XA,p4e={base:null,key:"type",typeMap:{attachment:g3,media:v3,text:nE,expression:DX,field:sE,relationship:lF}};var wB;let $1=wB=class extends fe{constructor(t){super(t),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new wB({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],$1.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],$1.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],$1.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],$1.prototype,"returnType",void 0),$1=wB=u([P("esri.popup.ExpressionInfo")],$1);const Zme=$1;var xB;let YA=xB=class extends fe{constructor(t){super(t),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new xB({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],YA.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],YA.prototype,"showNoDataRecords",void 0),YA=xB=u([P("esri.popup.LayerOptions")],YA);const f4e=YA;var TB;let ZA=TB=class extends fe{constructor(t){super(t),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new TB({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?te(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],ZA.prototype,"showRelatedRecords",void 0),u([d({type:[UX],json:{write:!0}})],ZA.prototype,"orderByFields",void 0),ZA=TB=u([P("esri.popup.RelatedRecordsInfo")],ZA);const m4e=ZA;var SB;let Ed=SB=class extends MM(Te){constructor(t){super(t),this.active=!1,this.className=null,this.disabled=!1,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new SB({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],Ed.prototype,"active",void 0),u([d()],Ed.prototype,"className",void 0),u([d()],Ed.prototype,"disabled",void 0),u([d()],Ed.prototype,"id",void 0),u([d()],Ed.prototype,"indicator",void 0),u([d()],Ed.prototype,"title",void 0),u([d()],Ed.prototype,"type",void 0),u([d()],Ed.prototype,"visible",void 0),Ed=SB=u([P("esri.support.actions.ActionBase")],Ed);const m5=Ed;var EB;let kL=EB=class extends m5{constructor(t){super(t),this.image=null,this.type="button"}clone(){return new EB({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],kL.prototype,"image",void 0),kL=EB=u([P("esri.support.Action.ActionButton")],kL);const qE=kL;var CB;let JA=CB=class extends m5{constructor(t){super(t),this.image=null,this.type="toggle",this.value=!1}clone(){return new CB({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],JA.prototype,"image",void 0),u([d()],JA.prototype,"value",void 0),JA=CB=u([P("esri.support.Action.ActionToggle")],JA);const Jme=JA,g4e="esri.PopupTemplate",y4e=se.getLogger(g4e),EC="relationships/",Bee="expression/",_4e=ft.ofType({key:"type",defaultKeyValue:"button",base:m5,typeMap:{button:qE,toggle:Jme}}),v4e={base:Sv,key:"type",typeMap:{media:v3,custom:o4e,text:nE,attachments:g3,fields:sE,expression:DX,relationship:lF}},b4e=["attachments","fields","media","text","expression","relationship"];let vo=class extends bs(fe){constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title=""}castContent(e){return Array.isArray(e)?e.map(r=>_p(v4e,r)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||Gu(e)?e:(y4e.error("content error","unsupported content value",{value:e}),null)}readContent(e,r){const{popupElements:i}=r;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(r.description,r.mediaInfos,i):this._readPopupInfo(r)}writeContent(e,r,i,s){typeof e!="string"?Array.isArray(e)&&(r.popupElements=e.filter(n=>b4e.includes(n.type)).map(n=>n&&n.toJSON(s)),r.popupElements.forEach(n=>{n.type==="attachments"?this._writeAttachmentContent(r):n.type==="media"?this._writeMediaContent(n,r):n.type==="text"?this._writeTextContent(n,r):n.type==="relationship"&&this._writeRelationshipContent(n,r)})):r.description=e}writeFieldInfos(e,r,i,s){const{content:n}=this,o=Array.isArray(n)?n:null;if(e){const a=o?o.filter(c=>c.type==="fields"):[],l=a.length&&a.every(c=>{var h;return(h=c.fieldInfos)==null?void 0:h.length});r.fieldInfos=e.filter(Boolean).map(c=>{const h=c.toJSON(s);return l&&(h.visible=!1),h})}if(o)for(const a of o)a.type==="fields"&&this._writeFieldsContent(a,r)}writeLayerOptions(e,r,i,s){r[i]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(s)}writeTitle(e,r){r.title=e||""}async collectRequiredFields(e,r){const i=this.expressionInfos||[];await this._collectExpressionInfoFields(e,r,[...i,...this._getContentExpressionInfos(this.content,i)]),m3(e,r,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(e){const r=new Set;return await this.collectRequiredFields(r,e),[...r].sort()}_writeFieldsContent(e,r){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const i=te(e.fieldInfos);Array.isArray(r.fieldInfos)?i.forEach(s=>{const n=r.fieldInfos.find(o=>o.fieldName.toLowerCase()===s.fieldName.toLowerCase());n?n.visible=!0:r.fieldInfos.push(s)}):r.fieldInfos=i}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeRelationshipContent(e,r){var n,o;const i=((n=e.orderByFields)==null?void 0:n.map(a=>this._toFieldOrderJSON(a,e.relationshipId)))||[],s=[...((o=r.relatedRecordsInfo)==null?void 0:o.orderByFields)||[],...i];r.relatedRecordsInfo={showRelatedRecords:!0,...(s==null?void 0:s.length)&&{orderByFields:s}}}_writeTextContent(e,r){!r.description&&e.text&&(r.description=e.text)}_writeMediaContent(e,r){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const i=te(e.mediaInfos);Array.isArray(r.mediaInfos)?r.mediaInfos=[...r.mediaInfos,...i]:r.mediaInfos=i}_readPopupInfoElements(e,r,i){const s={description:!1,mediaInfos:!1};return i.map(n=>n.type==="media"?(n.mediaInfos||!r||s.mediaInfos||(n.mediaInfos=r,s.mediaInfos=!0),v3.fromJSON(n)):n.type==="text"?(n.text||!e||s.description||(n.text=e,s.description=!0),nE.fromJSON(n)):n.type==="attachments"?g3.fromJSON(n):n.type==="fields"?sE.fromJSON(n):n.type==="expression"?DX.fromJSON(n):n.type==="relationship"?lF.fromJSON(n):void 0).filter(Boolean)}_toRelationshipContent(e){const{field:r,order:i}=e;if(!(r!=null&&r.startsWith(EC)))return null;const s=r.replace(EC,"").split("/");if(s.length!==2)return null;const n=parseInt(s[0],10),o=s[1];return typeof n=="number"&&o?lF.fromJSON({relationshipId:n,orderByFields:[{field:o,order:i}]}):null}_toFieldOrderJSON(e,r){const{order:i,field:s}=e;return{field:`${EC}${r}/${s}`,order:i}}_readPopupInfo({description:e,mediaInfos:r,showAttachments:i,relatedRecordsInfo:s={showRelatedRecords:!1}}){const n=[];e?n.push(new nE({text:e})):n.push(new sE),Array.isArray(r)&&r.length&&n.push(v3.fromJSON({mediaInfos:r})),i&&n.push(g3.fromJSON({displayType:"auto"}));const{showRelatedRecords:o,orderByFields:a}=s;return o&&(a!=null&&a.length)&&a.forEach(l=>{const c=this._toRelationshipContent(l);c&&n.push(c)}),n.length?n:e}_getContentElementFields(e){const r=e==null?void 0:e.type;if(r==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(r==="custom")return e.outFields||[];if(r==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos??this.fieldInfos)];if(r==="media"){const i=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...i.reduce((s,n)=>[...s,...this._getMediaInfoFields(n)],[])]}return r==="text"?this._extractFieldNames(e.text):[]}_getMediaInfoFields(e){const{caption:r,title:i,value:s}=e,n=s||{},{fields:o,normalizeField:a,tooltipField:l,sourceURL:c,linkURL:h}=n,p=[...this._extractFieldNames(i),...this._extractFieldNames(r),...this._extractFieldNames(c),...this._extractFieldNames(h),...o??[]];return a&&p.push(a),l&&p.push(l),p}_getContentExpressionInfos(e,r){return Array.isArray(e)?e.reduce((i,s)=>[...i,...s.type==="expression"&&s.expressionInfo?[s.expressionInfo]:[]],r):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((r,i)=>[...r,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(e,r,i){i&&await Promise.all(i.map(s=>Wl(e,r,s.expression)))}_getFieldInfoFields(e){return e?e.filter(r=>r.visible===void 0||!!r.visible).map(r=>r.fieldName).filter(r=>!r.startsWith(EC)&&!r.startsWith(Bee)):[]}_getActionsFields(e){return e?e.toArray().reduce((r,i)=>[...r,...this._getActionFields(i)],[]):[]}_getActionFields(e){const{className:r,title:i,type:s}=e,n=s==="button"||s==="toggle"?e.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(r),...this._extractFieldNames(n)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){if(!e||typeof e!="string")return[];const r=/{[^}]*}/g,i=e.match(r);if(!i)return[];const s=/\{(\w+):.+\}/,n=i.filter(o=>!(o.indexOf(`{${EC}`)===0||o.indexOf(`{${Bee}`)===0)).map(o=>o.replace(s,"{$1}"));return n?n.map(o=>o.slice(1,-1)):[]}};u([d({type:_4e})],vo.prototype,"actions",void 0),u([d()],vo.prototype,"content",void 0),u([Gt("content")],vo.prototype,"castContent",null),u([Le("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments","relatedRecordsInfo"])],vo.prototype,"readContent",null),u([ke("content",{popupElements:{type:ft.ofType(p4e)},showAttachments:{type:Boolean},mediaInfos:{type:ft.ofType(Yme)},description:{type:String},relatedRecordsInfo:{type:m4e}})],vo.prototype,"writeContent",null),u([d({type:[Zme],json:{write:!0}})],vo.prototype,"expressionInfos",void 0),u([d({type:[IM]})],vo.prototype,"fieldInfos",void 0),u([ke("fieldInfos")],vo.prototype,"writeFieldInfos",null),u([d({type:f4e})],vo.prototype,"layerOptions",void 0),u([ke("layerOptions")],vo.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],vo.prototype,"lastEditInfoEnabled",void 0),u([d()],vo.prototype,"outFields",void 0),u([d()],vo.prototype,"overwriteActions",void 0),u([d()],vo.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],vo.prototype,"title",void 0),u([ke("title")],vo.prototype,"writeTitle",null),vo=u([P("esri.PopupTemplate")],vo);const $M=vo,Gee=new Vr({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let w4e=0,kT=class extends fe{constructor(e){super(e),this.id="sym"+w4e++,this.type=null,this.color=new Ze([0,0,0,1])}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}async collectRequiredFields(e,r){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:Gee.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:Gee.write}}})],kT.prototype,"type",void 0),u([d({type:Ze,json:{write:{allowNull:!0}}})],kT.prototype,"color",void 0),u([Le("color")],kT.prototype,"readColor",null),kT=u([P("esri.symbols.Symbol")],kT);const Gc=kT;var AB;let M0=AB=class extends Gc{constructor(t){super(t),this.data=null,this.type="cim"}readData(t,e){return e}writeData(t,e){if(t)for(const r in t)e[r]=t[r]}async collectRequiredFields(t,e){var r;if(((r=this.data)==null?void 0:r.type)==="CIMSymbolReference"){const i=this.data.primitiveOverrides;if(i){const s=i.map(n=>{const o=n.valueExpressionInfo;return Wl(t,e,o.expression)});await Promise.all(s)}}}clone(){return new AB({data:te(this.data)})}hash(){return nW(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],M0.prototype,"color",void 0),u([d({json:{write:!0}})],M0.prototype,"data",void 0),u([Le("data",["symbol"])],M0.prototype,"readData",null),u([ke("data",{})],M0.prototype,"writeData",null),u([mt({CIMSymbolReference:"cim"},{readOnly:!0})],M0.prototype,"type",void 0),M0=AB=u([P("esri.symbols.CIMSymbol")],M0);const WE=M0;let zT=class extends fe{constructor(e){super(e),this.enabled=!0,this.type=null}writeEnabled(e,r,i){e||(r[i]=e)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],zT.prototype,"enabled",void 0),u([ke("enabled")],zT.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],zT.prototype,"type",void 0),zT=u([P("esri.symbols.Symbol3DLayer")],zT);const Em=zT;let L1=class extends fe{constructor(e){super(e),this.color=new Ze([0,0,0,1]),this.extensionLength=0,this.size=Yh(1)}clone(){}cloneProperties(){return{color:te(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],L1.prototype,"type",void 0),u([d(gy)],L1.prototype,"color",void 0),u([d({...hm,json:{write:{overridePolicy:t=>({enabled:!!t})}}})],L1.prototype,"extensionLength",void 0),u([d(hm)],L1.prototype,"size",void 0),L1=u([P("esri.symbols.edges.Edges3D")],L1);const VX=L1;var RB;let zL=RB=class extends VX{constructor(t){super(t),this.type="sketch"}clone(){return new RB(this.cloneProperties())}};u([mt({sketch:"sketch"},{readOnly:!0})],zL.prototype,"type",void 0),zL=RB=u([P("esri.symbols.edges.SketchEdges3D")],zL);const x4e=zL;var OB;let BL=OB=class extends VX{constructor(t){super(t),this.type="solid"}clone(){return new OB(this.cloneProperties())}};u([mt({solid:"solid"},{readOnly:!0})],BL.prototype,"type",void 0),BL=OB=u([P("esri.symbols.support.SolidEdges3D")],BL);const T4e=BL,Kme={types:{key:"type",base:VX,typeMap:{solid:T4e,sketch:x4e}},json:{write:!0}};var MB;let Iu=MB=class extends fe{constructor(t){super(t),this.color=null}clone(){const t={color:v(this.color)?this.color.clone():null};return new MB(t)}};u([d(gy)],Iu.prototype,"color",void 0),Iu=MB=u([P("esri.symbols.support.Symbol3DMaterial")],Iu);var PB;let P0=PB=class extends Em{constructor(t){super(t),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new PB({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:v(this.material)?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([mt({Extrude:"extrude"},{readOnly:!0})],P0.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],P0.prototype,"size",void 0),u([d({type:Iu,json:{write:!0}})],P0.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],P0.prototype,"castShadows",void 0),u([d(Kme)],P0.prototype,"edges",void 0),P0=PB=u([P("esri.symbols.ExtrudeSymbol3DLayer")],P0);const Qme=P0;let KA=class extends Gc{constructor(e){super(e),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([mt({esriSLS:"simple-line"},{readOnly:!0})],KA.prototype,"type",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],KA.prototype,"width",void 0),KA=u([P("esri.symbols.LineSymbol")],KA);const S4e=KA,E4e=["begin","end","begin-end"],ege=["arrow","circle","square","diamond","cross","x"];var IB;let cf=IB=class extends fe{constructor(t){super(t),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(t,e,r,i){e[r]=(i==null?void 0:i.origin)==="web-map"?"arrow":t}set color(t){this._set("color",t)}readColor(t){return t&&t[0]!=null?[t[0],t[1],t[2],t[3]/255]:t}writeColor(t,e,r,i){(i==null?void 0:i.origin)==="web-map"||(e[r]=t)}clone(){return new IB({color:te(this.color),placement:this.placement,style:this.style})}hash(){var t;return`${this.placement}.${(t=this.color)==null?void 0:t.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],cf.prototype,"placement",void 0),u([mt({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],cf.prototype,"type",void 0),u([d({type:ege})],cf.prototype,"style",void 0),u([ke("style")],cf.prototype,"writeStyle",null),u([d({type:Ze,value:null,json:{write:{allowNull:!0}}})],cf.prototype,"color",null),u([Le("color")],cf.prototype,"readColor",null),u([ke("color")],cf.prototype,"writeColor",null),cf=IB=u([P("esri.symbols.LineSymbolMarker")],cf);const C4e=cf;var $B;const LU=new Vr({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let og=$B=class extends S4e{constructor(...t){super(...t),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(t,e,r,i,s,n){if(t&&typeof t!="string")return t;const o={};return t!=null&&(o.style=t),e!=null&&(o.color=e),r!=null&&(o.width=hi(r)),i!=null&&(o.cap=i),s!=null&&(o.join=s),n!=null&&(o.miterLimit=hi(n)),o}clone(){var t;return new $B({color:te(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:(t=this.marker)==null?void 0:t.clone()})}hash(){var t,e;return`${super.hash()}.${(t=this.color)==null?void 0:t.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${(e=this.marker)==null?void 0:e.hash()}`}};u([mt({esriSLS:"simple-line"},{readOnly:!0})],og.prototype,"type",void 0),u([d({type:LU.apiValues,json:{read:LU.read,write:LU.write}})],og.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(t,e,r)=>({enabled:t!=="round"&&(r==null||r.origin==null)})}}})],og.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(t,e,r)=>({enabled:t!=="round"&&(r==null||r.origin==null)})}}})],og.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":C4e}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],og.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],og.prototype,"miterLimit",void 0),og=$B=u([P("esri.symbols.SimpleLineSymbol")],og);const rd=og;let QA=class extends Gc{constructor(e){super(e),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":rd}},json:{default:null,write:!0}})],QA.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],QA.prototype,"type",void 0),QA=u([P("esri.symbols.FillSymbol")],QA);const tge=QA;let GL=class extends fe{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],GL.prototype,"type",void 0),GL=u([P("esri.symbols.patterns.LinePattern3D")],GL);const rge=GL,A4e=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var LB;const R4e=Ra()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let eR=LB=class extends rge{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new LB(t)}};u([d({type:["style"]})],eR.prototype,"type",void 0),u([mt(R4e),d({type:A4e})],eR.prototype,"style",void 0),eR=LB=u([P("esri.symbols.patterns.LineStylePattern3D")],eR);const kX=eR;let jL=class extends fe{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],jL.prototype,"type",void 0),jL=u([P("esri.symbols.patterns.Pattern3D")],jL);const ige=jL,O4e=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var DB;let tR=DB=class extends ige{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new DB(t)}};u([d({type:["style"]})],tR.prototype,"type",void 0),u([d({type:O4e,json:{read:!0,write:!0}})],tR.prototype,"style",void 0),tR=DB=u([P("esri.symbols.patterns.StylePattern3D")],tR);const sge=tR,M4e={types:{key:"type",base:ige,typeMap:{style:sge}},json:{write:!0}},nge={types:{key:"type",base:rge,typeMap:{style:kX}},json:{write:!0}},dO=new Ze("white");new Ze("black");const P4e=new Ze([255,255,255,0]);function I4e(t){return t.r===0&&t.g===0&&t.b===0}var NB;let pO=NB=class extends Iu{constructor(t){super(t),this.colorMixMode=null}clone(){const t={color:v(this.color)?this.color.clone():null,colorMixMode:this.colorMixMode};return new NB(t)}};u([mt({multiply:"multiply",replace:"replace",tint:"tint"})],pO.prototype,"colorMixMode",void 0),pO=NB=u([P("esri.symbols.support.Symbol3DFillMaterial")],pO);function Rn(t=uge){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function Pw(t,e,r,i,s,n,o=Rn()){return o[0]=t,o[1]=e,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o}function bEt(t,e){const r=isFinite(t[2])||isFinite(t[5]);return new Hr(r?{xmin:t[0],xmax:t[3],ymin:t[1],ymax:t[4],zmin:t[2],zmax:t[5],spatialReference:e}:{xmin:t[0],xmax:t[3],ymin:t[1],ymax:t[4],spatialReference:e})}function oE(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[3]),t[4]=Math.max(t[4],e[4]),t[5]=Math.max(t[5],e[5])}function $4e(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[3]=Math.max(t[3],e[2]),t[4]=Math.max(t[4],e[3])}function mm(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}function Ou(t,e,r=0,i=e.length/3){let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];for(let h=0;h<i;h++)s=Math.min(s,e[r+3*h]),n=Math.min(n,e[r+3*h+1]),o=Math.min(o,e[r+3*h+2]),a=Math.max(a,e[r+3*h]),l=Math.max(l,e[r+3*h+1]),c=Math.max(c,e[r+3*h+2]);t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function DU(t,e,r){const i=e.length;let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];if(r)for(let h=0;h<i;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<i;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function L4e(t){for(let e=0;e<6;e++)if(!isFinite(t[e]))return!1;return!0}function rx(t){return t[0]>=t[3]?0:t[3]-t[0]}function ix(t){return t[1]>=t[4]?0:t[4]-t[1]}function Ev(t){return t[2]>=t[5]?0:t[5]-t[2]}function oge(t){const e=rx(t),r=Ev(t),i=ix(t);return Math.sqrt(e*e+r*r+i*i)}function np(t,e=[0,0,0]){return e[0]=t[0]+rx(t)/2,e[1]=t[1]+ix(t)/2,e[2]=t[2]+Ev(t)/2,e}function FP(t,e=[0,0,0]){return e[0]=rx(t),e[1]=ix(t),e[2]=Ev(t),e}function zX(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[0]<=t[3]&&e[1]<=t[4]&&e[2]<=t[5]}function wEt(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[3]<=t[3]&&e[4]<=t[4]&&e[5]<=t[5]}function D4e(t,e){return Math.max(e[0],t[0])<=Math.min(e[3],t[3])&&Math.max(e[1],t[1])<=Math.min(e[4],t[4])&&Math.max(e[2],t[2])<=Math.min(e[5],t[5])}function op(t,e){return!!C(e)||D4e(t,e)}function age(t,e,r,i,s=t){return s[0]=t[0]+e,s[1]=t[1]+r,s[2]=t[2]+i,s[3]=t[3]+e,s[4]=t[4]+r,s[5]=t[5]+i,s}function xEt(t,e,r=t){const i=t[0]+rx(t)/2,s=t[1]+ix(t)/2,n=t[2]+Ev(t)/2;return r[0]=i+(t[0]-i)*e,r[1]=s+(t[1]-s)*e,r[2]=n+(t[2]-n)*e,r[3]=i+(t[3]-i)*e,r[4]=s+(t[4]-s)*e,r[5]=n+(t[5]-n)*e,r}function lge(t,e,r=t){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r!==t&&(r[3]=t[3],r[4]=t[4],r[5]=t[5]),r}function cge(t,e,r=t){return r[3]=e[0],r[4]=e[1],r[5]=e[2],r!==t&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),t}function g5(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function Mi(t){return t?g5(t,jee):Rn(jee)}function BX(t,e){return e||(e=hr()),e[0]=t[0],e[1]=t[1],e[2]=t[3],e[3]=t[4],e}function TEt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=Number.NEGATIVE_INFINITY,t[3]=e[2],t[4]=e[3],t[5]=Number.POSITIVE_INFINITY,t}function N4e(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=Number.NEGATIVE_INFINITY,t[3]=i,t[4]=s,t[5]=Number.POSITIVE_INFINITY,t}function FB(t){return t.length===6}function GX(t){return rx(t)===0&&ix(t)===0&&Ev(t)===0}function SEt(t,e,r){if(C(t)||C(e))return t===e;if(!FB(t)||!FB(e))return!1;if(r){for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1}else for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function F4e(t,e,r,i,s,n){return Pw(t,e,r,i,s,n,U4e)}const EEt=[-1/0,-1/0,-1/0,1/0,1/0,1/0],jee=[1/0,1/0,1/0,-1/0,-1/0,-1/0],uge=[0,0,0,0,0,0],U4e=Rn();function NU(t,{isPrimitive:e,width:r,depth:i,height:s}){const n=e?10:1;if(r==null&&s==null&&i==null)return[n*t[0],n*t[1],n*t[2]];const o=$e(r,i,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/t[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=t[l]*a);return o}const V4e=Pw(-.5,-.5,-.5,.5,.5,.5),k4e=Pw(-.5,-.5,0,.5,.5,1),z4e=Pw(-.5,-.5,0,.5,.5,.5);function B4e(t){switch(t){case"sphere":case"cube":case"diamond":return V4e;case"cylinder":case"cone":case"inverted-cone":return k4e;case"tetrahedron":return z4e;default:return}}const jX=["butt","square","round"],G4e=[...jX,"none"],hge=["miter","bevel","round"];var UB;let D1=UB=class extends fe{constructor(t){super(t),this.color=new Ze([0,0,0,1]),this.size=Yh(1),this.pattern=null,this.patternCap="butt"}clone(){const t={color:v(this.color)?this.color.clone():null,size:this.size,pattern:v(this.pattern)?this.pattern.clone():null,patternCap:this.patternCap};return new UB(t)}};u([d(gy)],D1.prototype,"color",void 0),u([d(hm)],D1.prototype,"size",void 0),u([d(nge)],D1.prototype,"pattern",void 0),u([d({type:jX,json:{default:"butt",write:{overridePolicy(){return{enabled:v(this.pattern)}}}}})],D1.prototype,"patternCap",void 0),D1=UB=u([P("esri.symbols.support.Symbol3DOutline")],D1);var HL;let ag=HL=class extends Em{constructor(t){super(t),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const t={edges:v(this.edges)?this.edges.clone():null,enabled:this.enabled,material:v(this.material)?this.material.clone():null,pattern:v(this.pattern)?this.pattern.clone():null,castShadows:this.castShadows,outline:v(this.outline)?this.outline.clone():null};return new HL(t)}static fromSimpleFillSymbol(t){var i,s,n;const e=t.outline&&t.outline.style&&t.outline.style!=="inside-frame"&&t.outline.style!=="solid"?new kX({style:t.outline.style}):null,r={size:((i=t.outline)==null?void 0:i.width)??0,color:(((s=t.outline)==null?void 0:s.color)??dO).clone(),pattern:e};return e&&((n=t.outline)!=null&&n.cap)&&(r.patternCap=t.outline.cap),new HL({material:new pO({color:(t.color??P4e).clone()}),pattern:t.style&&t.style!=="solid"?new sge({style:t.style}):null,outline:r})}};u([mt({Fill:"fill"},{readOnly:!0})],ag.prototype,"type",void 0),u([d({type:pO,json:{write:!0}})],ag.prototype,"material",void 0),u([d(M4e)],ag.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],ag.prototype,"castShadows",void 0),u([d({type:D1,json:{write:!0}})],ag.prototype,"outline",void 0),u([d(Kme)],ag.prototype,"edges",void 0),ag=HL=u([P("esri.symbols.FillSymbol3DLayer")],ag);const LM=ag,j4e=["none","underline","line-through"],H4e=["normal","italic","oblique"],q4e=["normal","lighter","bold","bolder"],dge={type:Number,cast:t=>{const e=Ch(t);return e===0?1:ye(e,.1,4)},nonNullable:!0},W4e=["left","right","center"],X4e=["baseline","top","middle","bottom"],pge={type:W4e,nonNullable:!0},fge={type:X4e,nonNullable:!0};var VB;let lg=VB=class extends fe{constructor(t){super(t),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(t){return hi(t)}clone(){return new VB({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:j4e,json:{default:"none",write:!0}})],lg.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],lg.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,r)=>({enabled:!r||!r.textSymbol3D})}}})],lg.prototype,"size",void 0),u([Gt("size")],lg.prototype,"castSize",null),u([d({type:H4e,json:{default:"normal",write:!0}})],lg.prototype,"style",void 0),u([d({type:q4e,json:{default:"normal",write:!0}})],lg.prototype,"weight",void 0),lg=VB=u([P("esri.symbols.Font")],lg);const y5=lg;var kB;const Y4e=Ra()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let N1=kB=class extends fe{constructor(t){super(t)}readHref(t,e,r){return t?jE(t,r):e.dataURI}writeHref(t,e,r,i){t&&(bm(t)?e.dataURI=t:(e.href=Rw(t,i),Mu(e.href)&&(e.href=Uh(e.href))))}clone(){return new kB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],N1.prototype,"href",void 0),u([Le("href")],N1.prototype,"readHref",null),u([ke("href",{href:{type:String},dataURI:{type:String}})],N1.prototype,"writeHref",null),u([mt(Y4e)],N1.prototype,"primitive",void 0),N1=kB=u([P("esri.symbols.support.IconSymbol3DLayerResource")],N1);const Z4e="circle";var zB;let N2=zB=class extends Te{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new zB({x:this.x,y:this.y})}};u([d({type:Number})],N2.prototype,"x",void 0),u([d({type:Number})],N2.prototype,"y",void 0),N2=zB=u([P("esri.symbols.support.Symbol3DAnchorPosition2D")],N2);var BB;let rR=BB=class extends fe{constructor(t){super(t),this.color=new Ze([0,0,0,1]),this.size=Yh(1)}clone(){const t={color:v(this.color)?this.color.clone():null,size:this.size};return new BB(t)}};u([d(gy)],rR.prototype,"color",void 0),u([d(hm)],rR.prototype,"size",void 0),rR=BB=u([P("esri.symbols.support.Symbol3DIconOutline")],rR);var BT;const mge="esri.symbols.IconSymbol3DLayer";let uf=BT=class extends Em{constructor(t){super(t),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=null,this.outline=null}clone(){return new BT({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:v(this.material)?this.material.clone():null,outline:v(this.outline)?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(t){const e=t.color||dO,r=Hee(t),i=t.outline&&t.outline.width>0?{size:t.outline.width,color:(t.outline.color||dO).clone()}:null;return new BT({size:t.size,resource:{primitive:K4e(t.style)},material:{color:e},outline:i,anchor:r?"relative":void 0,anchorPosition:r})}static fromPictureMarkerSymbol(t){const e=!t.color||I4e(t.color)?dO:t.color,r=Hee(t);return new BT({size:t.width<=t.height?t.height:t.width,resource:{href:t.url},material:{color:e.clone()},anchor:r?"relative":void 0,anchorPosition:r})}static fromCIMSymbol(t){return new BT({resource:{href:Khe({mediaType:"application/json",data:JSON.stringify(t.data)})}})}};function Hee(t){const e="width"in t?t.width:t.size,r="height"in t?t.height:t.size,i=qee(t.xoffset),s=qee(t.yoffset);return(i||s)&&e&&r?{x:-i/e,y:s/r}:null}function qee(t){return isFinite(t)?t:0}u([d({type:Iu,json:{write:!0}})],uf.prototype,"material",void 0),u([d({type:N1,json:{write:!0}})],uf.prototype,"resource",void 0),u([mt({Icon:"icon"},{readOnly:!0})],uf.prototype,"type",void 0),u([d(hm)],uf.prototype,"size",void 0),u([mt({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],uf.prototype,"anchor",void 0),u([d({type:N2,json:{type:[Number],read:{reader:t=>new N2({x:t[0],y:t[1]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],uf.prototype,"anchorPosition",void 0),u([d({type:rR,json:{write:!0}})],uf.prototype,"outline",void 0),uf=BT=u([P(mge)],uf);const J4e={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function K4e(t){return J4e[t]||(se.getLogger(mge).warn(`${t} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const M_=uf;let F1=class extends bs(fe){constructor(e){super(e),this.type="style",this.placement="begin-end",this.style="arrow",this.color=null}equals(e){return v(e)&&e.placement===this.placement&&e.style===this.style&&(C(this.color)&&C(e.color)||v(this.color)&&v(e.color)&&this.color.toJSON()===e.color.toJSON())}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],F1.prototype,"type",void 0),u([d({type:E4e,json:{default:"begin-end",write:!0}})],F1.prototype,"placement",void 0),u([d({type:ege,json:{default:"arrow",write:!0}})],F1.prototype,"style",void 0),u([d({type:Ze,json:{type:[Ti],default:null,write:!0}})],F1.prototype,"color",void 0),F1=u([P("esri.symbols.LineStyleMarker3D")],F1);const GB=F1;var qL;let hf=qL=class extends Em{constructor(t){super(t),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=Yh(1),this.pattern=null,this.marker=null}clone(){const t={enabled:this.enabled,material:v(this.material)?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:v(this.pattern)?this.pattern.clone():null,marker:v(this.marker)?this.marker.clone():null};return new qL(t)}static fromSimpleLineSymbol(t){var r;const e={enabled:!0,size:t.width??Yh(1),cap:t.cap||"butt",join:t.join||"miter",pattern:t.style&&t.style!=="inside-frame"?new kX({style:t.style}):null,material:new Iu({color:(t.color||dO).clone()}),marker:t.marker?new GB({placement:t.marker.placement,style:t.marker.style,color:((r=t.marker.color)==null?void 0:r.clone())??null}):null};return new qL(e)}};u([d({type:Iu,json:{write:!0}})],hf.prototype,"material",void 0),u([mt({Line:"line"},{readOnly:!0})],hf.prototype,"type",void 0),u([d({type:hge,json:{write:!0,default:"miter"}})],hf.prototype,"join",void 0),u([d({type:jX,json:{write:!0,default:"butt"}})],hf.prototype,"cap",void 0),u([d(hm)],hf.prototype,"size",void 0),u([d(nge)],hf.prototype,"pattern",void 0),u([d({types:{key:"type",base:GB,typeMap:{style:GB}},json:{write:!0}})],hf.prototype,"marker",void 0),hf=qL=u([P("esri.symbols.LineSymbol3DLayer")],hf);const DM=hf;var jB;const Q4e=Ra()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let iR=jB=class extends fe{clone(){return new jB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:EX,write:nv}})],iR.prototype,"href",void 0),u([mt(Q4e)],iR.prototype,"primitive",void 0),iR=jB=u([P("esri.symbols.support.ObjectSymbol3DLayerResource")],iR);const gge="sphere";var HB;let Ab=HB=class extends Te{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new HB({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],Ab.prototype,"x",void 0),u([d({type:Number})],Ab.prototype,"y",void 0),u([d({type:Number})],Ab.prototype,"z",void 0),Ab=HB=u([P("esri.symbols.support.Symbol3DAnchorPosition3D")],Ab);var qB;let ka=qB=class extends Em{constructor(t){super(t),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new qB({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:v(this.material)?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:Iu,json:{write:!0}})],ka.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],ka.prototype,"castShadows",void 0),u([d({type:iR,json:{write:!0}})],ka.prototype,"resource",void 0),u([mt({Object:"object"},{readOnly:!0})],ka.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"depth",void 0),u([mt({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],ka.prototype,"anchor",void 0),u([d({type:Ab,json:{type:[Number],read:{reader:t=>new Ab({x:t[0],y:t[1],z:t[2]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y,t.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],ka.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],ka.prototype,"roll",void 0),u([d({readOnly:!0})],ka.prototype,"isPrimitive",null),ka=qB=u([P("esri.symbols.ObjectSymbol3DLayer")],ka);const HX=ka;var WB;let Tl=WB=class extends Em{constructor(t){super(t),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(t,e){return t??(e.height==null&&e.size!=null?e.size:void 0)}readHeight(t,e){return t??(e.width==null&&e.size!=null?e.size:void 0)}clone(){return new WB({enabled:this.enabled,material:v(this.material)?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:Iu,json:{write:!0}})],Tl.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Tl.prototype,"castShadows",void 0),u([mt({Path:"path"},{readOnly:!0})],Tl.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],Tl.prototype,"profile",void 0),u([d({type:hge,json:{write:!0,default:"miter"}})],Tl.prototype,"join",void 0),u([d({type:G4e,json:{write:!0,default:"butt"}})],Tl.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],Tl.prototype,"width",void 0),u([Le("width",["width","size","height"])],Tl.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],Tl.prototype,"height",void 0),u([Le("height",["height","size","width"])],Tl.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],Tl.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],Tl.prototype,"profileRotation",void 0),Tl=WB=u([P("esri.symbols.PathSymbol3DLayer")],Tl);const qX=Tl;var XB;let F2=XB=class extends fe{constructor(){super(...arguments),this.color=new Ze([0,0,0,1]),this.size=0}clone(){const t={color:te(this.color),size:this.size};return new XB(t)}};u([d(gy)],F2.prototype,"color",void 0),u([d(hm)],F2.prototype,"size",void 0),F2=XB=u([P("esri.symbols.support.Symbol3DHalo")],F2);let fO=class extends bs(fe){constructor(e){super(e),this.color=null}};u([d(gy)],fO.prototype,"color",void 0),fO=u([P("esri.symbols.support.Symbol3DTextBackground")],fO);var WL;let ic=WL=class extends Em{constructor(t){super(t),this._userSize=void 0,this.halo=null,this.horizontalAlignment="center",this.lineHeight=1,this.material=null,this.background=null,this.text=null,this.type="text",this.verticalAlignment="baseline"}get font(){return this._get("font")||null}set font(t){v(t)&&v(this._userSize)&&(t.size=this._userSize),this._set("font",t)}writeFont(t,e,r,i){const s={...i,textSymbol3D:!0};e.font=t.write({},s),delete e.font.size}get size(){return v(this._userSize)?this._userSize:v(this.font)&&this.font.size!=null?this.font.size:9}set size(t){this._userSize=t,v(this.font)&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){const t=new WL({enabled:this.enabled,font:this.font&&te(this.font),halo:this.halo&&te(this.halo),horizontalAlignment:this.horizontalAlignment,lineHeight:this.lineHeight,material:v(this.material)?this.material.clone():null,text:this.text,verticalAlignment:this.verticalAlignment,background:te(this.background)});return t._userSize=this._userSize,t}static fromTextSymbol(t){return new WL({font:v(t.font)?t.font.clone():new y5,halo:e5e(t.haloColor,t.haloSize),horizontalAlignment:t.horizontalAlignment,lineHeight:t.lineHeight,material:t.color?new Iu({color:t.color.clone()}):null,text:t.text,verticalAlignment:t.verticalAlignment,background:t.backgroundColor?new fO({color:t.backgroundColor.clone()}):null})}};function e5e(t,e){return t&&e!=null&&e>0?new F2({color:te(t),size:e}):null}u([d({type:y5,json:{write:!0}})],ic.prototype,"font",null),u([ke("font")],ic.prototype,"writeFont",null),u([d({type:F2,json:{write:!0}})],ic.prototype,"halo",void 0),u([d({...pge,json:{default:"center",write:!0}})],ic.prototype,"horizontalAlignment",void 0),u([d({...dge,json:{default:1,write:!0}})],ic.prototype,"lineHeight",void 0),u([d({type:Iu,json:{write:!0}})],ic.prototype,"material",void 0),u([d({type:fO,json:{write:!0}})],ic.prototype,"background",void 0),u([d(hm)],ic.prototype,"size",null),u([d({type:String,json:{write:!0}})],ic.prototype,"text",void 0),u([mt({Text:"text"},{readOnly:!0})],ic.prototype,"type",void 0),u([d({...fge,json:{default:"baseline",write:!0}})],ic.prototype,"verticalAlignment",void 0),ic=WL=u([P("esri.symbols.TextSymbol3DLayer")],ic);const sx=ic;var YB;let I0=YB=class extends Em{constructor(t){super(t),this.color=ZB.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new YB({color:te(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:Ze,nonNullable:!0,json:{type:[Ti],write:(t,e,r)=>e[r]=t.toArray(Ze.AlphaMode.UNLESS_OPAQUE),default:()=>ZB.clone(),defaultEquals:t=>t.toCss(!0)===ZB.toCss(!0)}})],I0.prototype,"color",void 0),u([mt({Water:"water"},{readOnly:!0})],I0.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],I0.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],I0.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],I0.prototype,"waveStrength",void 0),I0=YB=u([P("esri.symbols.WaterSymbol3DLayer")],I0);const ZB=new Ze([0,119,190]),yge=I0;var JB;let U1=JB=class extends Te{constructor(t){super(t),this.name=null,this.styleUrl=null,this.styleName=null,this.portal=null}clone(){return new JB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],U1.prototype,"name",void 0),u([d({type:String})],U1.prototype,"styleUrl",void 0),u([d({type:String})],U1.prototype,"styleName",void 0),u([d({type:Io})],U1.prototype,"portal",void 0),U1=JB=u([P("esri.symbols.support.StyleOrigin")],U1);const KB=U1;var QB;let mO=QB=class extends Te{constructor(){super(...arguments),this.url=""}clone(){return new QB({url:this.url})}};u([d({type:String})],mO.prototype,"url",void 0),mO=QB=u([P("esri.symbols.support.Thumbnail")],mO);const _ge={icon:M_,object:HX,line:DM,path:qX,fill:LM,extrude:Qme,text:sx,water:yge},t5e=ft.ofType({base:Em,key:"type",typeMap:_ge,errorContext:"symbol-layer"});let df=class extends Gc{constructor(e){super(e),this.styleOrigin=null,this.thumbnail=null,this.type=null;const r=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=r&&r.type||ft;this._set("symbolLayers",new i)}get color(){return null}set color(e){this.constructed&&se.getLogger(this.declaredClass).error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(e){sy(e,this._get("symbolLayers"))}readStyleOrigin(e,r,i){if(e.styleUrl&&e.name){const s=jE(e.styleUrl,i);return new KB({styleUrl:s,name:e.name})}if(e.styleName&&e.name)return new KB({portal:i&&i.portal||Io.getDefault(),styleName:e.styleName,name:e.name});i&&i.messages&&i.messages.push(new lm("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:e}))}writeStyleOrigin(e,r,i,s){if(e.styleUrl&&e.name){let n=Rw(e.styleUrl,s);Mu(n)&&(n=Uh(n)),r.styleOrigin={styleUrl:n,name:e.name}}else e.styleName&&e.name&&(e.portal&&s&&s.portal&&!Zhe(e.portal.restUrl,s.portal.restUrl)?s&&s.messages&&s.messages.push(new lm("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):r.styleOrigin={styleName:e.styleName,name:e.name})}normalizeCtorArgs(e){return e instanceof Em||e&&_ge[e.type]?{symbolLayers:[e]}:Array.isArray(e)?{symbolLayers:e}:e}};u([d({json:{read:!1,write:!1}})],df.prototype,"color",null),u([d({type:t5e,nonNullable:!0,json:{write:!0}}),Gt(RW)],df.prototype,"symbolLayers",null),u([d({type:KB})],df.prototype,"styleOrigin",void 0),u([Le("styleOrigin")],df.prototype,"readStyleOrigin",null),u([ke("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],df.prototype,"writeStyleOrigin",null),u([d({type:mO,json:{read:!1}})],df.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],df.prototype,"type",void 0),df=u([P("esri.symbols.Symbol3D")],df);const XE=df;let sR=class extends fe{constructor(e){super(e),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],sR.prototype,"type",void 0),u([d({readOnly:!0})],sR.prototype,"visible",void 0),sR=u([P("esri.symbols.callouts.Callout3D")],sR);const vge=sR;var e7;let XL=e7=class extends fe{constructor(){super(...arguments),this.color=new Ze("white")}clone(){return new e7({color:te(this.color)})}};u([d(gy)],XL.prototype,"color",void 0),XL=e7=u([P("esri.symbols.callouts.LineCallout3DBorder")],XL);const bge=XL;Object.freeze(Object.defineProperty({__proto__:null,default:bge},Symbol.toStringTag,{value:"Module"}));var t7;let $0=t7=class extends vge{constructor(t){super(t),this.type="line",this.color=new Ze([0,0,0,1]),this.size=Yh(1),this.border=null}get visible(){return this.size>0&&v(this.color)&&this.color.a>0}clone(){return new t7({color:te(this.color),size:this.size,border:te(this.border)})}};u([mt({line:"line"},{readOnly:!0})],$0.prototype,"type",void 0),u([d(gy)],$0.prototype,"color",void 0),u([d(hm)],$0.prototype,"size",void 0),u([d({type:bge,json:{write:!0}})],$0.prototype,"border",void 0),u([d({readOnly:!0})],$0.prototype,"visible",null),$0=t7=u([P("esri.symbols.callouts.LineCallout3D")],$0);const r5e=$0;function WX(t){if(!t)return!1;const e=t.verticalOffset;return!!e&&!(e.screenLength<=0||v(e.maxWorldLength)&&e.maxWorldLength<=0)}function wge(t){if(!t||!t.supportsCallout||!t.supportsCallout())return!1;const e=t.callout;return!!e&&!!e.visible&&!!WX(t)}function XX(t){return t.type==="point-3d"||t.type==="label-3d"}function xge(t){return t.horizontalAlignment==="center"}const Tge={types:{key:"type",base:vge,typeMap:{line:r5e}},json:{write:!0}};var r7;let GT=r7=class extends fe{constructor(t){super(t),this.screenLength=0,this.minWorldLength=0,this.maxWorldLength=null}clone(){return new r7({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(hm)],GT.prototype,"screenLength",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0,default:0}})],GT.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],GT.prototype,"maxWorldLength",void 0),GT=r7=u([P("esri.symbols.support.Symbol3DVerticalOffset")],GT);const Sge=GT;var YL;const Ege=ft.ofType({base:null,key:"type",typeMap:{text:sx}});let L0=YL=class extends XE{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new Ege,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return wge(this)}hasVisibleVerticalOffset(){return WX(this)}clone(){return new YL({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail),callout:te(this.callout),verticalOffset:te(this.verticalOffset)})}static fromTextSymbol(t){return new YL({symbolLayers:[sx.fromTextSymbol(t)]})}};u([d({type:Sge,json:{write:!0}})],L0.prototype,"verticalOffset",void 0),u([d(Tge)],L0.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],L0.prototype,"styleOrigin",void 0),u([d({type:Ege})],L0.prototype,"symbolLayers",void 0),u([mt({LabelSymbol3D:"label-3d"},{readOnly:!0})],L0.prototype,"type",void 0),L0=YL=u([P("esri.symbols.LabelSymbol3D")],L0);const _5=L0;var ZL;const Cge=ft.ofType({base:null,key:"type",typeMap:{line:DM,path:qX}}),i5e=ft.ofType({base:null,key:"type",typeMap:{line:DM,path:qX}});let nR=ZL=class extends XE{constructor(t){super(t),this.symbolLayers=new Cge,this.type="line-3d"}clone(){return new ZL({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromSimpleLineSymbol(t){return new ZL({symbolLayers:[DM.fromSimpleLineSymbol(t)]})}};u([d({type:Cge,json:{type:i5e}})],nR.prototype,"symbolLayers",void 0),u([mt({LineSymbol3D:"line-3d"},{readOnly:!0})],nR.prototype,"type",void 0),nR=ZL=u([P("esri.symbols.LineSymbol3D")],nR);const v5=nR;let D0=class extends Gc{constructor(e){super(e),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],D0.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],D0.prototype,"type",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],D0.prototype,"xoffset",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],D0.prototype,"yoffset",void 0),u([d({type:Number,cast:t=>t==="auto"?t:hi(t),json:{write:!0}})],D0.prototype,"size",void 0),D0=u([P("esri.symbols.MarkerSymbol")],D0);const Age=D0;var JL;const Rge=ft.ofType({base:null,key:"type",typeMap:{fill:LM}});let oR=JL=class extends XE{constructor(t){super(t),this.symbolLayers=new Rge,this.type="mesh-3d"}clone(){return new JL({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromSimpleFillSymbol(t){return new JL({symbolLayers:[LM.fromSimpleFillSymbol(t)]})}};u([d({type:Rge})],oR.prototype,"symbolLayers",void 0),u([mt({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],oR.prototype,"type",void 0),oR=JL=u([P("esri.symbols.MeshSymbol3D")],oR);const b5=oR;function s5e(t,e,r){return e.imageData?Khe({mediaType:e.contentType||"image/png",isBase64:!0,data:e.imageData}):Oge(e.url,r)}function Oge(t,e){var r;return o5e(e)&&!Mu(t)&&((r=e==null?void 0:e.layer)!=null&&r.parsedUrl)?Nu(e.layer.parsedUrl.path,"images",t):jE(t,e)}function n5e(t,e,r,i){if(bm(t)){const s=_M(t);if(!s)return;e.contentType=s.mediaType,e.imageData=s.data,r&&r.imageData===e.imageData&&r.url&&nv(r.url,e,"url",i)}else nv(t,e,"url",i)}const Mge={json:{read:{source:["imageData","url"],reader:s5e},write:{writer(t,e,r,i){n5e(t,e,this.source,i)}}}},Pge={readOnly:!0,json:{read:{source:["imageData","url"],reader(t,e,r){const i={};return e.imageData&&(i.imageData=e.imageData),e.contentType&&(i.contentType=e.contentType),e.url&&(i.url=Oge(e.url,r)),i}}}};function o5e(t){var e,r;return!(t==null||t.origin!=="service"&&t.origin!=="portal-item"||((e=t.layer)==null?void 0:e.type)!=="feature"&&((r=t.layer)==null?void 0:r.type)!=="stream")}var i7;let uh=i7=class extends tge{constructor(...t){super(...t),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(t,e,r,i){if(t&&typeof t!="string"&&t.imageData==null)return t;const s={};return t&&(s.url=t),e&&(s.outline=e),r!=null&&(s.width=hi(r)),i!=null&&(s.height=hi(i)),s}clone(){const t=new i7({color:te(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return t._set("source",te(this.source)),t}hash(){var t;return`${super.hash()}.${(t=this.color)==null?void 0:t.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([mt({esriPFS:"picture-fill"},{readOnly:!0})],uh.prototype,"type",void 0),u([d(Mge)],uh.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],uh.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],uh.prototype,"yscale",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],uh.prototype,"width",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],uh.prototype,"height",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],uh.prototype,"xoffset",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],uh.prototype,"yoffset",void 0),u([d(Pge)],uh.prototype,"source",void 0),uh=i7=u([P("esri.symbols.PictureFillSymbol")],uh);const Ige=uh;var s7;let Cd=s7=class extends Age{constructor(...t){super(...t),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string"&&t.imageData==null)return t;const i={};return t&&(i.url=t),e!=null&&(i.width=hi(e)),r!=null&&(i.height=hi(r)),i}readHeight(t,e){return e.size||t}readWidth(t,e){return e.size||t}clone(){const t=new s7({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return t._set("source",te(this.source)),t}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],Cd.prototype,"color",void 0),u([mt({esriPMS:"picture-marker"},{readOnly:!0})],Cd.prototype,"type",void 0),u([d(Mge)],Cd.prototype,"url",void 0),u([d(Pge)],Cd.prototype,"source",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Cd.prototype,"height",void 0),u([Le("height",["height","size"])],Cd.prototype,"readHeight",null),u([d({type:Number,cast:hi,json:{write:!0}})],Cd.prototype,"width",void 0),u([d({json:{write:!1}})],Cd.prototype,"size",void 0),Cd=s7=u([P("esri.symbols.PictureMarkerSymbol")],Cd);const w5=Cd;var V1;const $ge=ft.ofType({base:null,key:"type",typeMap:{icon:M_,object:HX,text:sx}});let k1=V1=class extends XE{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.symbolLayers=new $ge,this.type="point-3d"}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const t of this.symbolLayers.items)switch(t.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return wge(this)}hasVisibleVerticalOffset(){return WX(this)}clone(){return new V1({verticalOffset:te(this.verticalOffset),callout:te(this.callout),styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromSimpleMarkerSymbol(t){return new V1({symbolLayers:[M_.fromSimpleMarkerSymbol(t)]})}static fromPictureMarkerSymbol(t){return new V1({symbolLayers:[M_.fromPictureMarkerSymbol(t)]})}static fromCIMSymbol(t){var i,s;if(((s=(i=t.data)==null?void 0:i.symbol)==null?void 0:s.type)!=="CIMPointSymbol")return null;const r=t.data.symbol;return new V1(r!=null&&r.callout?{symbolLayers:[M_.fromCIMSymbol(t)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}:{symbolLayers:[M_.fromCIMSymbol(t)]})}static fromTextSymbol(t){return new V1({symbolLayers:[sx.fromTextSymbol(t)]})}};u([d({type:Sge,json:{write:!0}})],k1.prototype,"verticalOffset",void 0),u([d(Tge)],k1.prototype,"callout",void 0),u([d({type:$ge,json:{origins:{"web-scene":{write:!0}}}})],k1.prototype,"symbolLayers",void 0),u([mt({PointSymbol3D:"point-3d"},{readOnly:!0})],k1.prototype,"type",void 0),k1=V1=u([P("esri.symbols.PointSymbol3D")],k1);const P_=k1;var aR;const Lge=ft.ofType({base:null,key:"type",typeMap:{extrude:Qme,fill:LM,icon:M_,line:DM,object:HX,text:sx,water:yge}});let lR=aR=class extends XE{constructor(t){super(t),this.symbolLayers=new Lge,this.type="polygon-3d"}clone(){return new aR({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromJSON(t){const e=new aR;if(e.read(t),e.symbolLayers.length===2&&e.symbolLayers.getItemAt(0).type==="fill"&&e.symbolLayers.getItemAt(1).type==="line"){const r=e.symbolLayers.getItemAt(0),i=e.symbolLayers.getItemAt(1);!i.enabled||t.symbolLayers&&t.symbolLayers[1]&&t.symbolLayers[1].enable===!1||(r.outline={size:i.size,color:v(i.material)?i.material.color:null}),e.symbolLayers.removeAt(1)}return e}static fromSimpleFillSymbol(t){return new aR({symbolLayers:[LM.fromSimpleFillSymbol(t)]})}};u([d({type:Lge,json:{write:!0}})],lR.prototype,"symbolLayers",void 0),u([mt({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],lR.prototype,"type",void 0),lR=aR=u([P("esri.symbols.PolygonSymbol3D")],lR);const NM=lR;var n7;const FU=new Vr({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let z1=n7=class extends tge{constructor(...t){super(...t),this.color=new Ze([0,0,0,.25]),this.outline=new rd,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string")return t;const i={};return t&&(i.style=t),e&&(i.outline=e),r&&(i.color=r),i}clone(){return new n7({color:te(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],z1.prototype,"color",void 0),u([d()],z1.prototype,"outline",void 0),u([mt({esriSFS:"simple-fill"},{readOnly:!0})],z1.prototype,"type",void 0),u([d({type:FU.apiValues,json:{read:FU.read,write:FU.write}})],z1.prototype,"style",void 0),z1=n7=u([P("esri.symbols.SimpleFillSymbol")],z1);const Cv=z1;var o7;const UU=new Vr({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let pf=o7=class extends Age{constructor(...t){super(...t),this.color=new Ze([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new rd}normalizeCtorArgs(t,e,r,i){if(t&&typeof t!="string")return t;const s={};return t&&(s.style=t),e!=null&&(s.size=hi(e)),r&&(s.outline=r),i&&(s.color=i),s}writeColor(t,e){t&&this.style!=="x"&&this.style!=="cross"&&(e.color=t.toJSON()),t===null&&(e.color=null)}set path(t){this.style="path",this._set("path",t)}clone(){return new o7({angle:this.angle,color:te(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var t;return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${(t=this.outline)==null?void 0:t.hash()}`}};u([d()],pf.prototype,"color",void 0),u([ke("color")],pf.prototype,"writeColor",null),u([mt({esriSMS:"simple-marker"},{readOnly:!0})],pf.prototype,"type",void 0),u([d()],pf.prototype,"size",void 0),u([d({type:UU.apiValues,json:{read:UU.read,write:UU.write}})],pf.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],pf.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":rd}},json:{default:null,write:!0}})],pf.prototype,"outline",void 0),pf=o7=u([P("esri.symbols.SimpleMarkerSymbol")],pf);const Av=pf;var a7;let Vs=a7=class extends Gc{constructor(...t){super(...t),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new y5,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment="baseline",this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string")return t;const i={};return t&&(i.text=t),e&&(i.font=e),r&&(i.color=r),i}writeLineWidth(t,e,r,i){i&&typeof i!="string"?i.origin:e[r]=t}castLineWidth(t){return hi(t)}writeLineHeight(t,e,r,i){i&&typeof i!="string"?i.origin:e[r]=t}clone(){return new a7({angle:this.angle,backgroundColor:te(this.backgroundColor),borderLineColor:te(this.borderLineColor),borderLineSize:this.borderLineSize,color:te(this.color),font:this.font&&this.font.clone(),haloColor:te(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var t;return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${(t=this.color)==null?void 0:t.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:Ze,json:{write:!0}})],Vs.prototype,"backgroundColor",void 0),u([d({type:Ze,json:{write:!0}})],Vs.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0},cast:hi})],Vs.prototype,"borderLineSize",void 0),u([d({type:y5,json:{write:!0}})],Vs.prototype,"font",void 0),u([d({...pge,json:{write:!0}})],Vs.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],Vs.prototype,"kerning",void 0),u([d({type:Ze,json:{write:!0}})],Vs.prototype,"haloColor",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Vs.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],Vs.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],Vs.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],Vs.prototype,"text",void 0),u([mt({esriTS:"text"},{readOnly:!0})],Vs.prototype,"type",void 0),u([d({...fge,json:{write:!0}})],Vs.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Vs.prototype,"xoffset",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Vs.prototype,"yoffset",void 0),u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],Vs.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],Vs.prototype,"width",void 0),u([d({type:Number})],Vs.prototype,"lineWidth",void 0),u([ke("lineWidth")],Vs.prototype,"writeLineWidth",null),u([Gt("lineWidth")],Vs.prototype,"castLineWidth",null),u([d(dge)],Vs.prototype,"lineHeight",void 0),u([ke("lineHeight")],Vs.prototype,"writeLineHeight",null),Vs=a7=u([P("esri.symbols.TextSymbol")],Vs);const YE=Vs;var l7;let Ad=l7=class extends Gc{constructor(t){super(t),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}get _fetchCacheKey(){const t=v(this.portal)?this.portal:Io.getDefault(),e=t.user?t.user.username:null;return`${this.styleName}:${this.styleUrl}:${this.name}:${e}:${t.url}`}read(t,e){this.portal=e==null?void 0:e.portal,super.read(t,e)}clone(){return new l7({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(t){return this._fetchSymbol("webRef",t)}fetchCIMSymbol(t){return this._fetchSymbol("cimRef",t)}async _fetchSymbol(t,e){const r=v(e)?e.cache:null,i=r?this._fetchCacheKey:null;if(v(r)){const a=i&&r.get(i);if(a)return a.clone()}const s=await a5e();ur(e);const n=s.resolveWebStyleSymbol(this,{portal:this.portal},t,e);n.catch(a=>{se.getLogger(this.declaredClass).error("#fetchSymbol()","Failed to create symbol from style",a)});const o=await n;return t==="webRef"&&o.type==="point-3d"||t==="cimRef"&&o.type==="cim"?(v(r)&&r.set(i,o.clone()),o):null}};function a5e(){return ie(()=>import("./webStyleSymbolUtils-e72807fd.js"),[],import.meta.url)}u([d({json:{write:!1}})],Ad.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Ad.prototype,"styleName",void 0),u([d({type:Io,json:{write:!1}})],Ad.prototype,"portal",void 0),u([d({type:String,json:{read:EX,write:nv}})],Ad.prototype,"styleUrl",void 0),u([d({type:mO,json:{read:!1}})],Ad.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],Ad.prototype,"name",void 0),u([mt({styleSymbolReference:"web-style"},{readOnly:!0})],Ad.prototype,"type",void 0),u([d()],Ad.prototype,"_fetchCacheKey",null),Ad=l7=u([P("esri.symbols.WebStyleSymbol")],Ad);const nx=Ad;function x5(t){if(!t)return!1;switch(t.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function aE(t){if(!t)return!1;switch(t.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const ow={base:Gc,key:"type",typeMap:{"simple-fill":Cv,"picture-fill":Ige,"picture-marker":w5,"simple-line":rd,"simple-marker":Av,text:YE,"label-3d":_5,"line-3d":v5,"mesh-3d":b5,"point-3d":P_,"polygon-3d":NM,"web-style":nx,cim:WE},errorContext:"symbol"},l5e={base:Gc,key:"type",typeMap:{"picture-marker":w5,"simple-marker":Av,text:YE,"web-style":nx,cim:WE},errorContext:"symbol"},c5e=wv({types:ow}),T5={base:Gc,key:"type",typeMap:{"simple-fill":Cv,"picture-fill":Ige,"picture-marker":w5,"simple-line":rd,"simple-marker":Av,text:YE,"line-3d":v5,"mesh-3d":b5,"point-3d":P_,"polygon-3d":NM,"web-style":nx,cim:WE},errorContext:"symbol"},u5e={base:Gc,key:"type",typeMap:{text:YE,"label-3d":_5},errorContext:"symbol"},Wee={base:Gc,key:"type",typeMap:{"line-3d":v5,"mesh-3d":b5,"point-3d":P_,"polygon-3d":NM,"web-style":nx,cim:WE},errorContext:"symbol"},h5e={base:Gc,key:"type",typeMap:{"label-3d":_5},errorContext:"symbol"},Dge=_p(ow);function d5e(t){if(!t)return null;const e={};for(const r in t){const i=um(t[r]);i&&(e[r]=i)}return Object.keys(e).length!==0?e:null}function p5e(t){if(!v(t))return null;const e={};for(const r in t){const i=t[r];i&&(e[r]=i.toJSON())}return Object.keys(e).length!==0?e:null}let sc=class extends bs(fe){constructor(...e){super(...e),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:$c(),configurable:!0})}normalizeCtorArgs(e,r,i,s){return e&&!e.declaredClass?e:{geometry:e,symbol:r,attributes:i,popupTemplate:s}}set aggregateGeometries(e){const r=this._get("aggregateGeometries");JSON.stringify(r)!==JSON.stringify(e)&&this._set("aggregateGeometries",e)}set attributes(e){const r=this._get("attributes");r!==e&&(this._set("attributes",e),this._notifyLayer("attributes",r,e))}set geometry(e){const r=this._get("geometry");r!==e&&(this._set("geometry",e),this._notifyLayer("geometry",r,e))}set symbol(e){const r=this._get("symbol");r!==e&&(this._set("symbol",e),this._notifyLayer("symbol",r,e))}set visible(e){const r=this._get("visible");r!==e&&(this._set("visible",e),this._notifyLayer("visible",r,e))}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;for(const r of[this.sourceLayer,this.layer])if(r){if("popupTemplate"in r&&r.popupTemplate)return r.popupTemplate;if(e&&"defaultPopupTemplate"in r&&v(r.defaultPopupTemplate))return r.defaultPopupTemplate}return null}getAttribute(e){var r;return(r=this.attributes)==null?void 0:r[e]}setAttribute(e,r){if(this.attributes){const i=this.getAttribute(e);this.attributes[e]=r,this._notifyLayer("attributes",i,r,e)}else this.attributes={[e]:r},this._notifyLayer("attributes",void 0,r,e)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{aggregateGeometries:p5e(this.aggregateGeometries),geometry:v(this.geometry)?this.geometry.toJSON():null,symbol:v(this.symbol)?this.symbol.toJSON():null,attributes:{...this.attributes},popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}notifyMeshTransformChanged(){v(this.geometry)&&this.geometry.type==="mesh"&&this._notifyLayer("transform",this.geometry.transform,this.geometry.transform)}_notifyLayer(e,r,i,s){if(!this.layer||!("graphicChanged"in this.layer))return;const n={graphic:this,property:e,oldValue:r,newValue:i};e==="attributes"&&(n.attributeName=s),this.layer.graphicChanged(n)}};u([d({value:null,json:{read:d5e}})],sc.prototype,"aggregateGeometries",null),u([d({value:null})],sc.prototype,"attributes",null),u([d({value:null,types:tx,json:{read:um}})],sc.prototype,"geometry",null),u([d({type:Boolean})],sc.prototype,"isAggregate",void 0),u([d({clonable:"reference"})],sc.prototype,"layer",void 0),u([d({type:$M})],sc.prototype,"popupTemplate",void 0),u([d({clonable:"reference"})],sc.prototype,"sourceLayer",void 0),u([d({value:null,types:ow})],sc.prototype,"symbol",null),u([d({type:Boolean,value:!0})],sc.prototype,"visible",null),sc=u([P("esri.Graphic")],sc),function(t){t.generateUID=$c}(sc||(sc={}));const Sa=sc;function Jh(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function f5e(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function YX(t,e,r,i,s,n,o,a,l,c){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t}function ZX(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Kh(t,e){if(t===e){const r=e[1],i=e[2],s=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=i,t[7]=s}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function ox(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l;let y=r*p+i*f+s*m;return y?(y=1/y,t[0]=p*y,t[1]=(-h*i+s*c)*y,t[2]=(a*i-s*o)*y,t[3]=f*y,t[4]=(h*r-s*l)*y,t[5]=(-a*r+s*n)*y,t[6]=m*y,t[7]=(-c*r+i*l)*y,t[8]=(o*r-i*n)*y,t):null}function m5e(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return t[0]=o*h-a*c,t[1]=s*c-i*h,t[2]=i*a-s*o,t[3]=a*l-n*h,t[4]=r*h-s*l,t[5]=s*n-r*a,t[6]=n*c-o*l,t[7]=i*l-r*c,t[8]=r*o-i*n,t}function g5e(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8];return e*(c*n-o*l)+r*(-c*s+o*a)+i*(l*s-n*a)}function lE(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=r[0],m=r[1],y=r[2],_=r[3],b=r[4],x=r[5],T=r[6],S=r[7],E=r[8];return t[0]=f*i+m*o+y*c,t[1]=f*s+m*a+y*h,t[2]=f*n+m*l+y*p,t[3]=_*i+b*o+x*c,t[4]=_*s+b*a+x*h,t[5]=_*n+b*l+x*p,t[6]=T*i+S*o+E*c,t[7]=T*s+S*a+E*h,t[8]=T*n+S*l+E*p,t}function cF(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=r[0],m=r[1];return t[0]=i,t[1]=s,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=f*i+m*o+c,t[7]=f*s+m*a+h,t[8]=f*n+m*l+p,t}function JX(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=Math.sin(r),m=Math.cos(r);return t[0]=m*i+f*o,t[1]=m*s+f*a,t[2]=m*n+f*l,t[3]=m*o-f*i,t[4]=m*a-f*s,t[5]=m*l-f*n,t[6]=c,t[7]=h,t[8]=p,t}function KX(t,e,r){const i=r[0],s=r[1],n=r[2];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t[6]=n*e[6],t[7]=n*e[7],t[8]=n*e[8],t}function y5e(t,e,r){const i=r[0],s=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t}function _5e(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function v5e(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=-r,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function b5e(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function w5e(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function QX(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r+r,a=i+i,l=s+s,c=r*o,h=i*o,p=i*a,f=s*o,m=s*a,y=s*l,_=n*o,b=n*a,x=n*l;return t[0]=1-p-y,t[3]=h-x,t[6]=f+b,t[1]=h+x,t[4]=1-c-y,t[7]=m-_,t[2]=f-b,t[5]=m+_,t[8]=1-c-p,t}function Nge(t,e){const r=e[0],i=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l,y=r*p+i*f+s*m;if(!y)return null;const _=1/y;return t[0]=p*_,t[1]=(-h*i+s*c)*_,t[2]=(a*i-s*o)*_,t[3]=f*_,t[4]=(h*r-s*l)*_,t[5]=(-a*r+s*n)*_,t[6]=m*_,t[7]=(-c*r+i*l)*_,t[8]=(o*r-i*n)*_,t}function cE(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],_=e[13],b=e[14],x=e[15],T=r*a-i*o,S=r*l-s*o,E=r*c-n*o,O=i*l-s*a,R=i*c-n*a,L=s*c-n*l,I=h*_-p*y,U=h*b-f*y,z=h*x-m*y,B=p*b-f*_,G=p*x-m*_,K=f*x-m*b;let re=T*K-S*G+E*B+O*z-R*U+L*I;return re?(re=1/re,t[0]=(a*K-l*G+c*B)*re,t[1]=(l*z-o*K-c*U)*re,t[2]=(o*G-a*z+c*I)*re,t[3]=(s*G-i*K-n*B)*re,t[4]=(r*K-s*z+n*U)*re,t[5]=(i*z-r*G-n*I)*re,t[6]=(_*L-b*R+x*O)*re,t[7]=(b*E-y*L-x*S)*re,t[8]=(y*R-_*E+x*T)*re,t):null}function x5e(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function T5e(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function S5e(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2)}function E5e(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t}function Fge(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}function C5e(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t}function A5e(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t}function R5e(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function O5e(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=e[0],f=e[1],m=e[2],y=e[3],_=e[4],b=e[5],x=e[6],T=e[7],S=e[8],E=Oa();return Math.abs(r-p)<=E*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(i-f)<=E*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(s-m)<=E*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(n-y)<=E*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(o-_)<=E*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(a-b)<=E*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(l-x)<=E*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-T)<=E*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(h-S)<=E*Math.max(1,Math.abs(h),Math.abs(S))}function eY(t){const e=Oa(),r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return Math.abs(1-(r*r+n*n+l*l))<=e&&Math.abs(1-(i*i+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}const M5e=lE,P5e=Fge;Object.freeze(Object.defineProperty({__proto__:null,add:E5e,adjoint:m5e,copy:f5e,determinant:g5e,equals:O5e,exactEquals:R5e,frob:S5e,fromMat2d:w5e,fromMat4:Jh,fromQuat:QX,fromRotation:v5e,fromScaling:b5e,fromTranslation:_5e,identity:ZX,invert:ox,isOrthoNormal:eY,mul:M5e,multiply:lE,multiplyScalar:C5e,multiplyScalarAndAdd:A5e,normalFromMat4:cE,normalFromMat4Legacy:Nge,projection:x5e,rotate:JX,scale:KX,scaleByVec2:y5e,set:YX,str:T5e,sub:P5e,subtract:Fge,translate:cF,transpose:Kh},Symbol.toStringTag,{value:"Module"}));function rs(){return[1,0,0,0,1,0,0,0,1]}function I5e(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}function $5e(t,e,r,i,s,n,o,a,l){return[t,e,r,i,s,n,o,a,l]}function Uge(t,e){return new Float64Array(t,e,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:I5e,create:rs,createView:Uge,fromValues:$5e},Symbol.toStringTag,{value:"Module"}));function Ie(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function uE(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}function tY(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_){return[t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_]}function Vge(t,e){return new Float64Array(t,e,16)}const Uu=Ie();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:Uu,clone:uE,create:Ie,createView:Vge,fromValues:tY},Symbol.toStringTag,{value:"Module"}));let yy=class{constructor(e){this._allocator=e,this._items=[],this._itemsPtr=0,this._grow()}get(){return this._itemsPtr===0&&VS(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const e=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*Xee);this._items.length=Math.min(e,this._items.length),this._itemsPtr=0}_grow(){for(let e=0;e<Math.max(8,Math.min(this._items.length,Xee));e++)this._items.push(this._allocator())}};const Xee=1024;function nr(){return[0,0,0,0]}function FM(t){return[t[0],t[1],t[2],t[3]]}function qt(t,e,r,i){return[t,e,r,i]}function rY(t){const e=nr(),r=Math.min(4,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function kge(t,e){return new Float64Array(t,e,4)}function zge(){return nr()}function Bge(){return qt(1,1,1,1)}function Gge(){return qt(1,0,0,0)}function jge(){return qt(0,1,0,0)}function Hge(){return qt(0,0,1,0)}function qge(){return qt(0,0,0,1)}const Kf=zge(),Lh=Bge(),L5e=Gge(),D5e=jge(),N5e=Hge(),F5e=qge();Object.freeze(Object.defineProperty({__proto__:null,ONES:Lh,UNIT_W:F5e,UNIT_X:L5e,UNIT_Y:D5e,UNIT_Z:N5e,ZEROS:Kf,clone:FM,create:nr,createView:kge,fromArray:rY,fromValues:qt,ones:Bge,unitW:qge,unitX:Gge,unitY:jge,unitZ:Hge,zeros:zge},Symbol.toStringTag,{value:"Module"}));function Wge(t){return 32+t.length}function Xge(t){return 16}function Yge(t){if(!t)return 0;let e=Kge;for(const r in t)if(t.hasOwnProperty(r)){const i=t[r];switch(typeof i){case"string":e+=Wge(i);break;case"number":e+=Xge();break;case"boolean":e+=4}}return e}function Zge(t){if(!t)return 0;if(Array.isArray(t))return U5e(t);let e=Kge;for(const r in t)t.hasOwnProperty(r)&&(e+=Jge(t[r]));return e}function U5e(t){const e=t.length;if(e===0||typeof t[0]=="number")return 32+8*e;let r=Qge;for(let i=0;i<e;i++)r+=Jge(t[i]);return r}function Jge(t){switch(typeof t){case"object":return Zge(t);case"string":return Wge(t);case"number":return Xge();case"boolean":return 4;default:return 8}}function $Et(t,e){return Qge+t.length*e}const Kge=32,Qge=32;var hE;(function(t){t[t.KILOBYTES=1024]="KILOBYTES",t[t.MEGABYTES=1048576]="MEGABYTES",t[t.GIGABYTES=1073741824]="GIGABYTES"})(hE||(hE={}));function id(){return[0,0,0,1]}function V5e(t){return[t[0],t[1],t[2],t[3]]}function k5e(t,e,r,i){return[t,e,r,i]}function eye(t,e){return new Float64Array(t,e,4)}const z5e=id();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:z5e,clone:V5e,create:id,createView:eye,fromValues:k5e},Symbol.toStringTag,{value:"Module"}));function Ke(){return[0,0]}function cR(t){return[t[0],t[1]]}function Fr(t,e){return[t,e]}function tye(t){const e=Ke(),r=Math.min(2,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function rye(t,e){return new Float64Array(t,e,2)}function iye(){return Ke()}function sye(){return Fr(1,1)}function nye(){return Fr(1,0)}function oye(){return Fr(0,1)}const Xl=iye(),aye=sye(),B5e=nye(),G5e=oye();Object.freeze(Object.defineProperty({__proto__:null,ONES:aye,UNIT_X:B5e,UNIT_Y:G5e,ZEROS:Xl,clone:cR,create:Ke,createView:rye,fromArray:tye,fromValues:Fr,ones:sye,unitX:nye,unitY:oye,zeros:iye},Symbol.toStringTag,{value:"Module"}));let ZE=class B1{constructor(e,r,i){this._itemByteSize=e,this._itemCreate=r,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(i/this._itemByteSize)}get(){this._itemsPtr===0&&VS(()=>this._reset());const e=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=e;){const r=new ArrayBuffer(this._itemsPerBuffer*this._itemByteSize);for(let i=0;i<this._itemsPerBuffer;++i)this._items.push(this._itemCreate(r,i*this._itemByteSize));this._buffers.push(r)}return this._items[this._itemsPtr++]}_reset(){const e=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>e;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(e=_x){return new B1(16,rye,e)}static createVec3f64(e=_x){return new B1(24,qW,e)}static createVec4f64(e=_x){return new B1(32,kge,e)}static createMat3f64(e=_x){return new B1(72,Uge,e)}static createMat4f64(e=_x){return new B1(128,Vge,e)}static createQuatf64(e=_x){return new B1(32,eye,e)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this._itemByteSize}}};const _x=4*hE.KILOBYTES,LEt=ZE.createVec2f64(),He=ZE.createVec3f64(),iY=ZE.createVec4f64();ZE.createMat3f64();const sY=ZE.createMat4f64(),DEt=ZE.createQuatf64();function no(t){return t?Yee(gs(t.origin),gs(t.direction)):Yee(M(),M())}function Yee(t,e){return{origin:t,direction:e}}function NEt(t,e){return ry(t.origin,e.origin)&&ry(t.direction,e.direction)}function Vu(t,e){const r=W5e.get();return r.origin=t,r.direction=e,r}function uF(t,e=no()){return lye(t.origin,t.direction,e)}function j5e(t,e,r=no()){return le(r.origin,t),ge(r.direction,e,t),r}function lye(t,e,r=no()){return le(r.origin,t),le(r.direction,e),r}function H5e(t,e){const r=pt(He.get(),ve(He.get(),t.direction),ge(He.get(),e,t.origin));return _e(r,r)}function q5e(t,e,r){const i=_e(t.direction,ge(r,e,t.origin));return me(r,t.origin,ae(r,t.direction,i)),r}const W5e=new yy(()=>no());function S5(t){return t?{ray:no(t.ray),c0:t.c0,c1:t.c1}:{ray:no(),c0:0,c1:Number.MAX_VALUE}}function X5e(t,e=S5()){return uF(t,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function Y5e(t,e,r=S5()){const i=Me(t.vector);return lye(t.origin,e,r.ray),r.c0=0,r.c1=i,r}function FEt(t,e){return cye(t,t.c0,e)}function UEt(t,e){return cye(t,t.c1,e)}function cye(t,e,r){return me(r,t.ray.origin,ae(r,t.ray.direction,e))}new yy(()=>S5());var Pc;(function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"})(Pc||(Pc={}));function gO(t,e){return _e(t,e)/Me(t)}function nY(t,e){const r=_e(t,e)/(Me(t)*Me(e));return-An(r)}function uye(t,e,r){ve(UP,t),ve(VU,e);const i=_e(UP,VU),s=An(i),n=pt(UP,UP,VU);return _e(n,r)<0?2*Math.PI-s:s}const UP=M(),VU=M();function cn(){return nr()}function dE(t,e=cn()){return rp(e,t)}function hye(t,e){return qt(t[0],t[1],t[2],e)}function Z5e(t){return t}function dye(t){t[0]=t[1]=t[2]=t[3]=0}function E5(t,e){return t[0]=t[1]=t[2]=0,t[3]=e,t}function Hg(t){return t[3]}function J5e(t){return t}function pye(t,e,r,i){return qt(t,e,r,i)}function K5e(t,e,r){return t!==r&&le(r,t),r[3]=t[3]+e,r}function Q5e(t,e,r){return se.getLogger("esri.geometry.support.sphere").error("sphere.setExtent is not yet supported"),t===r?r:dE(t,r)}function Rv(t,e,r){if(C(e))return!1;const{origin:i,direction:s}=e,n=e6e;n[0]=i[0]-t[0],n[1]=i[1]-t[1],n[2]=i[2]-t[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2];if(o===0)return!1;const a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-t[3]*t[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(r&&(r[0]=i[0]+s[0]*h,r[1]=i[1]+s[1]*h,r[2]=i[2]+s[2]*h),!0)}const e6e=M();function c7(t,e){return Rv(t,e,null)}function t6e(t,e,r){if(Rv(t,e,r))return r;const i=JE(t,e,He.get());return me(r,e.origin,ae(He.get(),e.direction,Si(e.origin,i)/Me(e.direction))),r}function JE(t,e,r){const i=He.get(),s=sY.get();pt(i,e.origin,e.direction);const n=Hg(t);pt(r,i,e.origin),ae(r,r,1/Me(r)*n);const o=gye(t,e.origin),a=nY(e.origin,r);return Fu(s,a+o,i),Xe(r,r,s),r}function r6e(t,e,r){return Rv(t,e,r)?r:(q5e(e,t,r),fye(t,r,r))}function fye(t,e,r){const i=ge(He.get(),e,t),s=ae(He.get(),i,t[3]/Me(i));return me(r,s,t)}function mye(t,e){const r=ge(He.get(),e,t),i=ga(r),s=t[3]*t[3];return Math.sqrt(Math.abs(i-s))}function gye(t,e){const r=ge(He.get(),e,t),i=Me(r),s=Hg(t),n=s+Math.abs(s-i);return An(s/n)}const kU=M();function yye(t,e,r,i){const s=ge(kU,e,t);switch(r){case Pc.X:{const n=oee(s,kU)[2];return ce(i,-Math.sin(n),Math.cos(n),0)}case Pc.Y:{const n=oee(s,kU),o=n[1],a=n[2],l=Math.sin(o);return ce(i,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case Pc.Z:return ve(i,s);default:return}}function _ye(t,e){const r=ge(u7,e,t);return Me(r)-t[3]}function i6e(t,e,r,i){const s=_ye(t,e),n=yye(t,e,Pc.Z,u7),o=ae(u7,n,r-s);return me(i,e,o)}function s6e(t,e){const r=Vn(t,e),i=Hg(t);return r<=i*i}const u7=M(),C5=cn(),n6e=Object.freeze(Object.defineProperty({__proto__:null,altitudeAt:_ye,angleToSilhouette:gye,axisAt:yye,clear:dye,closestPoint:r6e,closestPointOnSilhouette:JE,containsPoint:s6e,copy:dE,create:cn,distanceToSilhouette:mye,elevate:K5e,fromCenterAndRadius:hye,fromRadius:E5,fromValues:pye,getCenter:J5e,getRadius:Hg,intersectRay:Rv,intersectRayClosestSilhouette:t6e,intersectsRay:c7,projectPoint:fye,setAltitudeAt:i6e,setExtent:Q5e,tmpSphere:C5,wrap:Z5e},Symbol.toStringTag,{value:"Module"}));function Br(t=uR){return[t[0],t[1],t[2],t[3]]}function o6e(t=uR[0],e=uR[1],r=uR[2],i=uR[3]){return oY(t,e,r,i,iY.get())}function A5(t,e){return oY(e[0],e[1],e[2],e[3],t)}function oY(t,e,r,i,s=Br()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function vye(t,e,r){return le(r,t),r[3]=e,r}function UM(t,e,r){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],s=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=-(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]),r}function fa(t,e,r,i=Br()){const s=r[0]-e[0],n=r[1]-e[1],o=r[2]-e[2],a=t[0]-e[0],l=t[1]-e[1],c=t[2]-e[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,m=h*h+p*p+f*f,y=Math.abs(m-1)>1e-5&&m>1e-12?1/Math.sqrt(m):1;return i[0]=h*y,i[1]=p*y,i[2]=f*y,i[3]=-(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]),i}function bye(t,e,r,i,s){const n=t.length/3;if(n<3)return!1;ce(CC,t[3*r],t[3*r+1],t[3*r+2]);let o=i,a=!1;for(;o<n-1&&!a;){const l=3*o;ce(vx,t[l],t[l+1],t[l+2]),o++,a=!Qa(CC,vx)}if(!a)return!1;for(o=Math.max(o,s),a=!1;o<n&&!a;){const l=3*o;ce(Rb,t[l],t[l+1],t[l+2]),o++,ge(VP,CC,vx),ve(VP,VP),ge(kP,vx,Rb),ve(kP,kP),a=!Qa(CC,Rb)&&!Qa(vx,Rb)&&Math.abs(_e(VP,kP))<a6e}return a?(fa(CC,vx,Rb,e),!0):(r!==0||i!==1||s!==2)&&bye(t,e,0,1,2)}const a6e=.99619469809,CC=M(),vx=M(),Rb=M(),VP=M(),kP=M();function h7(t,e,r){return e!==t&&A5(t,e),t[3]=-_e(t,r),t}function d7(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function b3(t,e,r,i){return pt(Rb,e,t),UM(r,Rb,i)}function VEt(t,e,r,i){return R5(t,e,ge(He.get(),r,e),p6e,i)}function ax(t,e,r){return!!v(e)&&R5(t,e.origin,e.direction,f6e,r)}function l6e(t,e,r){return R5(t,e.origin,e.vector,Qf.NONE,r)}function c6e(t,e,r){return R5(t,e.origin,e.vector,Qf.CLAMP,r)}function wye(t,e){return wi(t,e)>=0}function u6e(t,e){const r=_e(t,e.ray.direction),i=-wi(t,e.ray.origin);if(i<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return i>0;if((i<0||r<0)&&!(i<0&&r<0))return!0;const s=i/r;return r>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function h6e(t,e){const r=_e(t,e.ray.direction),i=-wi(t,e.ray.origin);if(r>-1e-6&&r<1e-6)return i>0;const s=i/r;return r>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function d6e(t,e,r){const i=ae(He.get(),t,-t[3]),s=p7(t,ge(He.get(),e,i),He.get());return me(r,s,i),r}function p7(t,e,r){const i=ae(He.get(),t,_e(t,e));return ge(r,e,i),r}function wi(t,e){return _e(t,e)+t[3]}function R5(t,e,r,i,s){const n=_e(t,r);if(n===0)return!1;let o=-(_e(t,e)+t[3])/n;return i&Qf.CLAMP&&(o=ye(o,0,1)),!(!(i&Qf.INFINITE_MIN)&&o<0||!(i&Qf.INFINITE_MAX)&&o>1)&&(me(s,e,ae(s,r,o)),!0)}function kEt(t){return t}const uR=[0,0,1,0];var Qf;(function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.INFINITE_MIN=4]="INFINITE_MIN",t[t.INFINITE_MAX=8]="INFINITE_MAX"})(Qf||(Qf={}));const p6e=Qf.INFINITE_MIN|Qf.INFINITE_MAX,f6e=Qf.INFINITE_MAX;function w3(t){return t?[Br(t[0]),Br(t[1]),Br(t[2]),Br(t[3]),Br(t[4]),Br(t[5])]:[Br(),Br(),Br(),Br(),Br(),Br()]}function xye(){return[M(),M(),M(),M(),M(),M(),M(),M()]}function hF(t,e){for(let r=0;r<ov.NUM;r++)A5(t[r],e[r])}function Tye(t,e,r,i=v6e){const s=ys(sY.get(),e,t);Lo(s,s);for(let n=0;n<f7.NUM;++n){const o=Ru(iY.get(),_6e[n],s);ce(i[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}Sye(r,i)}function Sye(t,e){fa(e[nt.FAR_BOTTOM_LEFT],e[nt.NEAR_BOTTOM_LEFT],e[nt.NEAR_TOP_LEFT],t[bi.LEFT]),fa(e[nt.NEAR_BOTTOM_RIGHT],e[nt.FAR_BOTTOM_RIGHT],e[nt.FAR_TOP_RIGHT],t[bi.RIGHT]),fa(e[nt.FAR_BOTTOM_LEFT],e[nt.FAR_BOTTOM_RIGHT],e[nt.NEAR_BOTTOM_RIGHT],t[bi.BOTTOM]),fa(e[nt.NEAR_TOP_LEFT],e[nt.NEAR_TOP_RIGHT],e[nt.FAR_TOP_RIGHT],t[bi.TOP]),fa(e[nt.NEAR_BOTTOM_LEFT],e[nt.NEAR_BOTTOM_RIGHT],e[nt.NEAR_TOP_RIGHT],t[bi.NEAR]),fa(e[nt.FAR_BOTTOM_RIGHT],e[nt.FAR_BOTTOM_LEFT],e[nt.FAR_TOP_LEFT],t[bi.FAR])}function I_(t,e){for(let r=0;r<ov.NUM;r++){const i=t[r];if(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]>=e[3])return!1}return!0}function m6e(t,e){return Cye(t,X5e(e,Aye.get()))}function zEt(t,e){for(let r=0;r<ov.NUM;r++){const i=t[r];if(!h6e(i,e))return!1}return!0}function g6e(t,e,r){return Cye(t,Y5e(e,r,Aye.get()))}function Eye(t,e){for(let r=0;r<ov.NUM;r++)if(wi(t[r],e)>0)return!1;return!0}function Cye(t,e){for(let r=0;r<ov.NUM;r++)if(!u6e(t[r],e))return!1;return!0}var bi,nt;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.NEAR=4]="NEAR",t[t.FAR=5]="FAR"})(bi||(bi={})),function(t){t[t.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",t[t.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",t[t.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",t[t.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",t[t.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",t[t.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",t[t.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",t[t.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(nt||(nt={}));const y6e={bottom:[nt.FAR_BOTTOM_RIGHT,nt.NEAR_BOTTOM_RIGHT,nt.NEAR_BOTTOM_LEFT,nt.FAR_BOTTOM_LEFT],near:[nt.NEAR_BOTTOM_LEFT,nt.NEAR_BOTTOM_RIGHT,nt.NEAR_TOP_RIGHT,nt.NEAR_TOP_LEFT],far:[nt.FAR_BOTTOM_RIGHT,nt.FAR_BOTTOM_LEFT,nt.FAR_TOP_LEFT,nt.FAR_TOP_RIGHT],right:[nt.NEAR_BOTTOM_RIGHT,nt.FAR_BOTTOM_RIGHT,nt.FAR_TOP_RIGHT,nt.NEAR_TOP_RIGHT],left:[nt.FAR_BOTTOM_LEFT,nt.NEAR_BOTTOM_LEFT,nt.NEAR_TOP_LEFT,nt.FAR_TOP_LEFT],top:[nt.FAR_TOP_LEFT,nt.NEAR_TOP_LEFT,nt.NEAR_TOP_RIGHT,nt.FAR_TOP_RIGHT]};var ov,f7;(function(t){t[t.NUM=6]="NUM"})(ov||(ov={})),function(t){t[t.NUM=8]="NUM"}(f7||(f7={}));const _6e=[qt(-1,-1,-1,1),qt(1,-1,-1,1),qt(1,1,-1,1),qt(-1,1,-1,1),qt(-1,-1,1,1),qt(1,-1,1,1),qt(1,1,1,1),qt(-1,1,1,1)],Aye=new yy(S5),v6e=xye(),aY=96;function BEt(t,e){const r=e||t.extent,i=t.width,s=al(r&&r.spatialReference);return r&&i?r.width/i*s*VW*aY:0}function b6e(t,e){return t/(al(e)*VW*aY)}function w6e(t){return t/(VW*aY)}var ts,Do;(function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL"})(ts||(ts={}));let x6e=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=Do.ALL}};(function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"})(Do||(Do={}));let T6e=class{constructor(e,r,i){this.object=e,this.geometryId=r,this.triangleNr=i}},S6e=class extends T6e{constructor(e,r,i,s){super(e,r,i),this.center=v(s)?gs(s):null}},Rye=class{constructor(e){this.layerUid=e}},O5=class extends Rye{constructor(e,r){super(e),this.graphicUid=r}};function Rp(t){return t?{origin:gs(t.origin),vector:gs(t.vector)}:{origin:M(),vector:M()}}function E6e(t,e){const r=A6e.get();return r.origin=t,r.vector=e,r}function XEt(t,e=Rp()){return C6e(t.origin,t.vector,e)}function C6e(t,e,r=Rp()){return le(r.origin,t),le(r.vector,e),r}function aw(t,e,r=Rp()){return le(r.origin,t),ge(r.vector,e,t),r}function lY(t,e){const r=ge(He.get(),e,t.origin),i=_e(t.vector,r),s=_e(t.vector,t.vector),n=ye(i/s,0,1),o=ge(He.get(),ae(He.get(),t.vector,n),r);return _e(o,o)}function YEt(t,e,r){return m7(t,e,0,1,r)}function ZEt(t,e,r){return me(r,t.origin,ae(r,t.vector,e))}function m7(t,e,r,i,s){const{vector:n,origin:o}=t,a=ge(He.get(),e,o),l=_e(n,a)/ga(n);return ae(s,n,ye(l,r,i)),me(s,s,t.origin)}function JEt(t,e){if(Mye(t,E6e(e.origin,e.direction),!1,dF)){const{tA:r,pB:i,distance2:s}=dF;if(r>=0&&r<=1)return s;if(r<0)return Vn(t.origin,i);if(r>1)return Vn(me(He.get(),t.origin,t.vector),i)}return null}function Oye(t,e,r){return!!Mye(t,e,!0,dF)&&(le(r,dF.pA),!0)}function Mye(t,e,r,i){const n=t.origin,o=me(He.get(),n,t.vector),a=e.origin,l=me(He.get(),a,e.vector),c=He.get(),h=He.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<1e-6&&Math.abs(h[1])<1e-6&&Math.abs(h[2])<1e-6)return!1;const p=He.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<1e-6&&Math.abs(p[1])<1e-6&&Math.abs(p[2])<1e-6)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],m=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],y=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],_=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],b=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*_-m*m;if(Math.abs(b)<1e-6)return!1;let x=(f*m-y*_)/b,T=(f+m*x)/_;r&&(x=ye(x,0,1),T=ye(T,0,1));const S=He.get(),E=He.get();return S[0]=n[0]+x*p[0],S[1]=n[1]+x*p[1],S[2]=n[2]+x*p[2],E[0]=a[0]+T*h[0],E[1]=a[1]+T*h[1],E[2]=a[2]+T*h[2],i.tA=x,i.tB=T,i.pA=S,i.pB=E,i.distance2=Vn(S,E),!0}const dF={tA:0,tB:0,pA:M(),pB:M(),distance2:0},A6e=new yy(()=>Rp()),zU=se.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");let R6e=class{constructor(){this.plane=Br(),this.origin=M(),this.basis1=M(),this.basis2=M()}};const Pye=R6e;function _y(t=Bye){return{plane:Br(t.plane),origin:gs(t.origin),basis1:gs(t.basis1),basis2:gs(t.basis2)}}function O6e(t,e,r){const i=z6e.get();return i.origin=t,i.basis1=e,i.basis2=r,i.plane=o6e(0,0,0,0),M5(i),i}function lx(t,e=_y()){return cY(t.origin,t.basis1,t.basis2,e)}function M6e(t,e){le(e.origin,t.origin),le(e.basis1,t.basis1),le(e.basis2,t.basis2),A5(e.plane,t.plane)}function cY(t,e,r,i=_y()){return le(i.origin,t),le(i.basis1,e),le(i.basis2,r),M5(i),V6e(i,"fromValues()"),i}function M5(t){b3(t.basis2,t.basis1,t.origin,t.plane)}function Iye(t,e,r){t!==r&&lx(t,r);const i=ae(He.get(),ay(t),e);return me(r.origin,r.origin,i),r.plane[3]-=e,r}function P6e(t,e,r){return $ye(e,r),Iye(r,pY(t,t.origin),r),r}function $ye(t,e=_y()){const r=(t[2]-t[0])/2,i=(t[3]-t[1])/2;return ce(e.origin,t[0]+r,t[1]+i,0),ce(e.basis1,r,0,0),ce(e.basis2,0,i,0),oY(0,0,1,0,e.plane),e}function uY(t,e,r){return!!ax(t.plane,e,r)&&kye(t,r)}function I6e(t,e,r){if(uY(t,e,r))return r;const i=Lye(t,e,He.get());return me(r,e.origin,ae(He.get(),e.direction,Si(e.origin,i)/Me(e.direction))),r}function Lye(t,e,r){const i=pF.get();zye(t,e,i,pF.get());let s=Number.POSITIVE_INFINITY;for(const n of mY){const o=fY(t,n,P5.get()),a=He.get();if(l6e(i,o,a)){const l=my(He.get(),e.origin,a),c=Math.abs(An(_e(e.direction,l)));c<s&&(s=c,le(r,a))}}return s===Number.POSITIVE_INFINITY?Dye(t,e,r):r}function Dye(t,e,r){if(uY(t,e,r))return r;const i=pF.get(),s=pF.get();zye(t,e,i,s);let n=Number.POSITIVE_INFINITY;for(const o of mY){const a=fY(t,o,P5.get()),l=He.get();if(c6e(i,a,l)){const c=H5e(e,l);if(!wye(s,l))continue;c<n&&(n=c,le(r,l))}}return hY(t,e.origin)<n&&Nye(t,e.origin,r),r}function Nye(t,e,r){const i=d6e(t.plane,e,He.get()),s=m7(Zee(t,t.basis1),i,-1,1,He.get()),n=m7(Zee(t,t.basis2),i,-1,1,He.get());return ge(r,me(He.get(),s,n),t.origin),r}function Fye(t,e,r){const{origin:i,basis1:s,basis2:n}=t,o=ge(He.get(),e,i),a=gO(s,o),l=gO(n,o),c=gO(ay(t),o);return ce(r,a,l,c)}function hY(t,e){const r=Fye(t,e,He.get()),{basis1:i,basis2:s}=t,n=Me(i),o=Me(s),a=Math.max(Math.abs(r[0])-n,0),l=Math.max(Math.abs(r[1])-o,0),c=r[2];return a*a+l*l+c*c}function $6e(t,e){return Math.sqrt(hY(t,e))}function L6e(t,e){let r=Number.NEGATIVE_INFINITY;for(const i of mY){const s=fY(t,i,P5.get()),n=lY(s,e);n>r&&(r=n)}return Math.sqrt(r)}function dY(t,e){return wye(t.plane,e)&&kye(t,e)}function D6e(t,e,r,i){return U6e(t,r,i)}function pY(t,e){const r=-t.plane[3];return gO(ay(t),e)-r}function N6e(t,e,r,i){const s=pY(t,e),n=ae(k6e,ay(t),r-s);return me(i,e,n),i}function Uye(t,e){return Qa(t.basis1,e.basis1)&&Qa(t.basis2,e.basis2)&&Qa(t.origin,e.origin)}function Vye(t,e,r){return t!==r&&lx(t,r),Lo(bx,e),kc(bx,bx),Xe(r.basis1,t.basis1,bx),Xe(r.basis2,t.basis2,bx),Xe(r.plane,t.plane,bx),Xe(r.origin,t.origin,e),h7(r.plane,r.plane,r.origin),r}function F6e(t,e,r,i){return t!==i&&lx(t,i),Fu(BU,e,r),Xe(i.basis1,t.basis1,BU),Xe(i.basis2,t.basis2,BU),M5(i),i}function ay(t){return t.plane}function U6e(t,e,r){switch(e){case Pc.X:le(r,t.basis1),ve(r,r);break;case Pc.Y:le(r,t.basis2),ve(r,r);break;case Pc.Z:le(r,ay(t))}return r}function kye(t,e){const r=ge(He.get(),e,t.origin),i=ga(t.basis1),s=ga(t.basis2),n=_e(t.basis1,r),o=_e(t.basis2,r);return-n-i<0&&n-i<0&&-o-s<0&&o-s<0}function Zee(t,e){const r=P5.get();return le(r.origin,t.origin),le(r.vector,e),r}function fY(t,e,r){const{basis1:i,basis2:s,origin:n}=t,o=ae(He.get(),i,e.origin[0]),a=ae(He.get(),s,e.origin[1]);me(r.origin,o,a),me(r.origin,r.origin,n);const l=ae(He.get(),i,e.direction[0]),c=ae(He.get(),s,e.direction[1]);return ae(r.vector,me(l,l,c),2),r}function V6e(t,e){Math.abs(_e(t.basis1,t.basis2)/(Me(t.basis1)*Me(t.basis2)))>1e-6&&zU.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(_e(t.basis1,ay(t)))>1e-6&&zU.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-_e(ay(t),t.origin)-t.plane[3])>1e-6&&zU.warn(e,"Plane offset is not consistent with plane origin")}function zye(t,e,r,i){const s=ay(t);b3(s,e.direction,e.origin,r),b3(r,s,e.origin,i)}const Bye={plane:Br(),origin:$e(0,0,0),basis1:$e(1,0,0),basis2:$e(0,1,0)},pF=new yy(Br),P5=new yy(Rp),k6e=M(),z6e=new yy(()=>_y()),mY=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],bx=Ie(),BU=Ie(),B6e=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:Pye,UP:Bye,altitudeAt:pY,axisAt:D6e,closestPoint:Dye,closestPointOnSilhouette:Lye,copy:lx,copyWithoutVerify:M6e,create:_y,distance:$6e,distance2:hY,distanceToSilhouette:L6e,elevate:Iye,equals:Uye,extrusionContainsPoint:dY,fromAABoundingRect:$ye,fromValues:cY,intersectRay:uY,intersectRayClosestSilhouette:I6e,normal:ay,projectPoint:Nye,projectPointLocal:Fye,rotate:F6e,setAltitudeAt:N6e,setExtent:P6e,transform:Vye,updateUnboundedPlane:M5,wrap:O6e},Symbol.toStringTag,{value:"Module"}));function Op(t){return v(t)&&v(t.dist)}function Jee(t){return(e,r,i)=>(Qs(Kee,e,r,i),!dY(t,Kee))}function I5(t){return Op(t)&&t.intersector===ts.OBJECT&&!!t.target}function $5(t){return Op(t)&&t.intersector===ts.HUD&&!!t.target&&"center"in t.target&&v(t.target.center)}const Kee=M();function G6e(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function fF(t,e,r){r*=.5;const i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t}function gY(t,e){const r=2*Math.acos(e[3]),i=Math.sin(r/2);return i>Oa()?(t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i):(t[0]=1,t[1]=0,t[2]=0),r}function yY(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1],c=r[2],h=r[3];return t[0]=i*h+o*a+s*c-n*l,t[1]=s*h+o*l+n*a-i*c,t[2]=n*h+o*c+i*l-s*a,t[3]=o*h-i*a-s*l-n*c,t}function j6e(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+o*a,t[1]=s*l+n*a,t[2]=n*l-s*a,t[3]=o*l-i*a,t}function H6e(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l-n*a,t[1]=s*l+o*a,t[2]=n*l+i*a,t[3]=o*l-s*a,t}function q6e(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+s*a,t[1]=s*l-i*a,t[2]=n*l+o*a,t[3]=o*l-n*a,t}function W6e(t,e){const r=e[0],i=e[1],s=e[2];return t[0]=r,t[1]=i,t[2]=s,t[3]=Math.sqrt(Math.abs(1-r*r-i*i-s*s)),t}function KL(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3];let l,c,h,p,f,m=r[0],y=r[1],_=r[2],b=r[3];return c=s*m+n*y+o*_+a*b,c<0&&(c=-c,m=-m,y=-y,_=-_,b=-b),1-c>Oa()?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-i)*l)/h,f=Math.sin(i*l)/h):(p=1-i,f=i),t[0]=p*s+f*m,t[1]=p*n+f*y,t[2]=p*o+f*_,t[3]=p*a+f*b,t}function X6e(t){const e=CM,r=e(),i=e(),s=e(),n=Math.sqrt(1-r),o=Math.sqrt(r);return t[0]=n*Math.sin(2*Math.PI*i),t[1]=n*Math.cos(2*Math.PI*i),t[2]=o*Math.sin(2*Math.PI*s),t[3]=o*Math.cos(2*Math.PI*s),t}function Y6e(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r*r+i*i+s*s+n*n,a=o?1/o:0;return t[0]=-r*a,t[1]=-i*a,t[2]=-s*a,t[3]=n*a,t}function Iw(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function Gye(t,e){const r=e[0]+e[4]+e[8];let i;if(r>0)i=Math.sqrt(r+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;i=Math.sqrt(e[3*s+s]-e[3*n+n]-e[3*o+o]+1),t[s]=.5*i,i=.5/i,t[3]=(e[3*n+o]-e[3*o+n])*i,t[n]=(e[3*n+s]+e[3*s+n])*i,t[o]=(e[3*o+s]+e[3*s+o])*i}return t}function Z6e(t,e,r,i){const s=.5*Math.PI/180;e*=s,r*=s,i*=s;const n=Math.sin(e),o=Math.cos(e),a=Math.sin(r),l=Math.cos(r),c=Math.sin(i),h=Math.cos(i);return t[0]=n*l*h-o*a*c,t[1]=o*a*h+n*l*c,t[2]=o*l*c-n*a*h,t[3]=o*l*h+n*a*c,t}function J6e(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}const _Y=rp,K6e=ti,Q6e=ZW,eUe=yY,tUe=kE,rUe=Zpe,iUe=e5,jye=JW,sUe=jye,Hye=KW,nUe=Hye,vY=Ype,oUe=uS,aUe=QW;function lUe(t,e,r){const i=_e(e,r);return i<-.999999?(pt(Fp,cUe,e),yc(Fp)<1e-6&&pt(Fp,uUe,e),ve(Fp,Fp),fF(t,Fp,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(pt(Fp,e,r),t[0]=Fp[0],t[1]=Fp[1],t[2]=Fp[2],t[3]=1+i,vY(t,t))}const Fp=M(),cUe=$e(1,0,0),uUe=$e(0,1,0);function hUe(t,e,r,i,s,n){return KL(Qee,e,s,n),KL(ete,r,i,n),KL(t,Qee,ete,2*n*(1-n)),t}const Qee=id(),ete=id();function dUe(t,e,r,i){const s=pUe;return s[0]=r[0],s[3]=r[1],s[6]=r[2],s[1]=i[0],s[4]=i[1],s[7]=i[2],s[2]=-e[0],s[5]=-e[1],s[8]=-e[2],vY(t,Gye(t,s))}const pUe=rs();Object.freeze(Object.defineProperty({__proto__:null,add:Q6e,calculateW:W6e,conjugate:Iw,copy:_Y,dot:rUe,equals:aUe,exactEquals:oUe,fromEuler:Z6e,fromMat3:Gye,getAxisAngle:gY,identity:G6e,invert:Y6e,len:sUe,length:jye,lerp:iUe,mul:eUe,multiply:yY,normalize:vY,random:X6e,rotateX:j6e,rotateY:H6e,rotateZ:q6e,rotationTo:lUe,scale:tUe,set:K6e,setAxes:dUe,setAxisAngle:fF,slerp:KL,sqlerp:hUe,sqrLen:nUe,squaredLength:Hye,str:J6e},Symbol.toStringTag,{value:"Module"}));function Gi(){return new Float32Array(3)}function mF(t){const e=new Float32Array(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Xr(t,e,r){const i=new Float32Array(3);return i[0]=t,i[1]=e,i[2]=r,i}function qye(t,e){return new Float32Array(t,e,3)}function bY(){return Gi()}function Wye(){return Xr(1,1,1)}function Xye(){return Xr(1,0,0)}function Yye(){return Xr(0,1,0)}function Zye(){return Xr(0,0,1)}const fUe=bY(),mUe=Wye(),gUe=Xye(),yUe=Yye(),_Ue=Zye();Object.freeze(Object.defineProperty({__proto__:null,ONES:mUe,UNIT_X:gUe,UNIT_Y:yUe,UNIT_Z:_Ue,ZEROS:fUe,clone:mF,create:Gi,createView:qye,fromValues:Xr,ones:Wye,unitX:Xye,unitY:Yye,unitZ:Zye,zeros:bY},Symbol.toStringTag,{value:"Module"}));let vUe=class{constructor(){this._transform=Ie(),this._transformInverse=new zP({value:this._transform},Lo,Ie),this._transformInverseTranspose=new zP(this._transformInverse,kc,Ie),this._transformTranspose=new zP({value:this._transform},kc,Ie),this._transformInverseRotation=new zP({value:this._transform},Nge,rs)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){kn(this._transform,e)}multiplyTransform(e){ys(this._transform,this._transform,e)}set(e){kn(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,r){this.setTransformMatrix(e),this.multiplyTransform(r),this._invalidateLazyTransforms()}},zP=class{constructor(e,r,i){this._original=e,this._update=r,this._dirty=!0,this._transform=i()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}},bUe=class{constructor(e=0){this.offset=e,this.tmpVertex=M()}applyToVertex(e,r,i){const s=e+this.localOrigin[0],n=r+this.localOrigin[1],o=i+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=e+s*a,this.tmpVertex[1]=r+n*a,this.tmpVertex[2]=i+o*a,this.tmpVertex}applyToAabb(e){for(let n=0;n<3;++n)jy[n]=e[0+n]+this.localOrigin[n],BP[n]=e[3+n]+this.localOrigin[n],wx[n]=jy[n];const r=this.applyToVertex(jy[0],jy[1],jy[2]);for(let n=0;n<3;++n)e[n]=r[n],e[n+3]=r[n];const i=n=>{const o=this.applyToVertex(n[0],n[1],n[2]);for(let a=0;a<3;++a)e[a+0]=Math.min(e[a+0],o[a]),e[a+3]=Math.max(e[a+3],o[a])};for(let n=1;n<8;++n){for(let o=0;o<3;++o)wx[o]=n&1<<o?BP[o]:jy[o];i(wx)}let s=0;for(let n=0;n<3;++n)jy[n]*BP[n]<0&&(s|=1<<n);if(s!==0&&s!==7){for(let n=0;n<8;++n)if(!(s&n)){for(let o=0;o<3;++o)s[o]?wx[o]=0:wx[o]=n&1<<o?jy[o]:BP[o];i(wx)}}for(let n=0;n<3;++n)e[n+0]-=this.localOrigin[n],e[n+3]-=this.localOrigin[n];return e}};const jy=M(),BP=M(),wx=M();let wUe=class{constructor(e=0){this.componentLocalOriginLength=0,this._tmpVertex=M(),this._mbs=cn(),this._obb={center:M(),halfSize:Gi(),quaternion:null},this._totalOffset=0,this._offset=0,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,r,i){const s=e,n=r,o=i+this.componentLocalOriginLength,a=this._totalOffset/Math.sqrt(s*s+n*n+o*o);return this._tmpVertex[0]=e+s*a,this._tmpVertex[1]=r+n*a,this._tmpVertex[2]=i+o*a,this._tmpVertex}applyToAabb(e){const r=e[0],i=e[1],s=e[2]+this.componentLocalOriginLength,n=e[3],o=e[4],a=e[5]+this.componentLocalOriginLength,l=r*n<0?0:Math.min(Math.abs(r),Math.abs(n)),c=i*o<0?0:Math.min(Math.abs(i),Math.abs(o)),h=s*a<0?0:Math.min(Math.abs(s),Math.abs(a)),p=Math.sqrt(l*l+c*c+h*h);if(p<this._totalOffset)return e[0]-=r<0?this._totalOffset:0,e[1]-=i<0?this._totalOffset:0,e[2]-=s<0?this._totalOffset:0,e[3]+=n>0?this._totalOffset:0,e[4]+=o>0?this._totalOffset:0,e[5]+=a>0?this._totalOffset:0,e;const f=Math.max(Math.abs(r),Math.abs(n)),m=Math.max(Math.abs(i),Math.abs(o)),y=Math.max(Math.abs(s),Math.abs(a)),_=Math.sqrt(f*f+m*m+y*y),b=this._totalOffset/_,x=this._totalOffset/p;return e[0]+=r*(r>0?b:x),e[1]+=i*(i>0?b:x),e[2]+=s*(s>0?b:x),e[3]+=n*(n<0?b:x),e[4]+=o*(o<0?b:x),e[5]+=a*(a<0?b:x),e}applyToMbs(e){const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this._totalOffset/r;return this._mbs[0]=e[0]+e[0]*i,this._mbs[1]=e[1]+e[1]*i,this._mbs[2]=e[2]+e[2]*i,this._mbs[3]=e[3]+e[3]*this._totalOffset/r,this._mbs}applyToObb(e){const r=e.center,i=this._totalOffset/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);this._obb.center[0]=r[0]+r[0]*i,this._obb.center[1]=r[1]+r[1]*i,this._obb.center[2]=r[2]+r[2]*i,pp(this._obb.halfSize,e.halfSize,e.quaternion),me(this._obb.halfSize,this._obb.halfSize,e.center);const s=this._totalOffset/Math.sqrt(this._obb.halfSize[0]*this._obb.halfSize[0]+this._obb.halfSize[1]*this._obb.halfSize[1]+this._obb.halfSize[2]*this._obb.halfSize[2]);return this._obb.halfSize[0]+=this._obb.halfSize[0]*s,this._obb.halfSize[1]+=this._obb.halfSize[1]*s,this._obb.halfSize[2]+=this._obb.halfSize[2]*s,ge(this._obb.halfSize,this._obb.halfSize,e.center),Iw(ste,e.quaternion),pp(this._obb.halfSize,this._obb.halfSize,ste),this._obb.halfSize[0]*=this._obb.halfSize[0]<0?-1:1,this._obb.halfSize[1]*=this._obb.halfSize[1]<0?-1:1,this._obb.halfSize[2]*=this._obb.halfSize[2]<0?-1:1,this._obb.quaternion=e.quaternion,this._obb}},xUe=class{constructor(e=0){this.offset=e,this.sphere=cn(),this.tmpVertex=M()}applyToVertex(e,r,i){const s=this.objectTransform.transform;let n=s[0]*e+s[4]*r+s[8]*i+s[12],o=s[1]*e+s[5]*r+s[9]*i+s[13],a=s[2]*e+s[6]*r+s[10]*i+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(e,r){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const s=this.offset/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);r[0]+=r[0]*s,r[1]+=r[1]*s,r[2]+=r[2]*s}applyToAabb(e){const r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;const i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}applyToBoundingSphere(e){const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/r;return this.sphere[0]=e[0]+e[0]*i,this.sphere[1]=e[1]+e[1]*i,this.sphere[2]=e[2]+e[2]*i,this.sphere[3]=e[3]+e[3]*this.offset/r,this.sphere}};const tte=new xUe;function g7(t){return v(t)?(tte.offset=t,tte):null}const rte=new wUe;function TUe(t){return v(t)?(rte.offset=t,rte):null}const ite=new bUe;function SUe(t){return v(t)?(ite.offset=t,ite):null}const f_="terrain",ste=id(),pE=1e-5;let EUe=class{constructor(e){this.options=new x6e,this._results=new CUe,this.transform=new vUe,this.tolerance=pE,this.verticalOffset=null,this._ray=no(),this._rayEnd=M(),this._rayBeginTransformed=M(),this._rayEndTransformed=M(),this.viewingMode=e??Be.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,r,i){this.resetWithRay(j5e(e,r,this._ray),i)}resetWithRay(e,r){this.camera=r,e!==this._ray&&uF(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===Be.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,me(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,r,i,s,n){this.point=r,this.filterPredicate=s,this.tolerance=i??pE;const o=g7(this.verticalOffset);if(v(e)&&e.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of e){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();v(c)?(v(o)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(e){const r=e.geometries;if(!r)return;const i=e.transformation,s=g7(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:o,id:a}=n;this.transform.setAndInvalidateLazyTransforms(i,n.shaderTransformation),Xe(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Xe(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;v(s)&&(s.objectTransform=this.transform),o.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(c,h,p,f,m,y)=>{if(c>=0){if(v(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,c))return;const _=f?this._results.hud:this._results,b=f?x=>{const T=new S6e(e,a,p,y);x.set(ts.HUD,T,c,h,Uu,m)}:x=>x.set(ts.OBJECT,{object:e,geometryId:a,triangleNr:p},c,h,l,m);if((_.min.drapedLayerOrder==null||m>=_.min.drapedLayerOrder)&&(_.min.dist==null||c<_.min.dist)&&b(_.min),this.options.store!==Do.MIN&&(_.max.drapedLayerOrder==null||m<_.max.drapedLayerOrder)&&(_.max.dist==null||c>_.max.dist)&&b(_.max),this.options.store===Do.ALL)if(f){const x=new y7(this._ray);b(x),this._results.hud.all.push(x)}else{const x=new dS(this._ray);b(x),this._results.all.push(x)}}})}}sortResults(e=this._results.all){e.sort((r,i)=>r.dist!==i.dist?It(r.dist,0)-It(i.dist,0):r.drapedLayerOrder!==i.drapedLayerOrder?It(r.drapedLayerOrder,Number.MAX_VALUE)-It(i.drapedLayerOrder,Number.MAX_VALUE):It(i.drapedLayerGraphicOrder,Number.MIN_VALUE)-It(r.drapedLayerGraphicOrder,Number.MIN_VALUE))}};function Qh(t){return new EUe(t)}let CUe=class{constructor(){this.min=new dS(no()),this.max=new dS(no()),this.hud={min:new y7(no()),max:new y7(no()),all:new Array},this.ground=new dS(no()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}},dS=class{get ray(){return this._ray}get distanceInRenderSpace(){return v(this.dist)?(ae(GP,this.ray.direction,this.dist),Me(GP)):null}getIntersectionPoint(e){return!!Op(this)&&(ae(GP,this.ray.direction,this.dist),me(e,this.ray.origin,GP),!0)}getTransformedNormal(e){return le(AC,this.normal),AC[3]=0,Ru(AC,AC,this.transformation),le(e,AC),ve(e,e)}constructor(e){this.intersector=ts.OBJECT,this.normal=M(),this.transformation=Ie(),this._ray=no(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=ts.OBJECT,uF(e,this._ray)}set(e,r,i,s,n,o,a){this.intersector=e,this.dist=i,le(this.normal,It(s,kpe)),kn(this.transformation,It(n,Uu)),this.target=r,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(e){uF(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,le(this.normal,e.normal),kn(this.transformation,e.transformation)}},y7=class extends dS{constructor(){super(...arguments),this.intersector=ts.HUD}};function wY(t){return new dS(t)}const GP=M(),AC=nr();function Jye(t,e,r,i){return v(t.renderCoordsHelper.fromRenderCoords(e.eye,gF,i))&&Vfe(r,gF)}function L5(t,e){return t.elevationProvider?It(t.elevationProvider.getElevation(e[0],e[1],e[2],t.renderCoordsHelper.spatialReference,"ground"),0):0}function cx(t,e,r,i){const s=t.state.camera.clone();e&&r&&i&&(s.eye=e,s.center=r,s.up=i),AUe(t,s.ray,Hy)||le(Hy,s.center);const n=t.state.constraints,o=n.minimumPoiDistance;if(Vn(s.eye,Hy)<o){const a=n.collision.enabled;le(Fv,s.viewForward),ae(Fv,Fv,o),a?s.eye=ge(gF,Hy,Fv):me(Hy,s.eye,Fv);const l=t.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(ge(Fv,Hy,s.eye),s.eye=l.setAltitude(gF,h,s.eye),me(Hy,s.eye,Fv))}return s.center=Hy,s}function nte(t,e,r){if(!t.state.isGlobal||!t.stateManager.constraintsManager)return!1;const i=L5(t,e),s=t.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(e,r,t.renderDataExtent,i,OUe),o=n*n;return Vn(e,r)>o}function AUe(t,e,r){let i=ote[t.viewingMode];i||(i=Qh(t.state.viewingMode),i.options.backfacesTerrain=!t.state.isGlobal,i.options.invisibleTerrain=!0,ote[t.viewingMode]=i);const{isGlobal:s}=t.state;return!(!t.sceneIntersectionHelper.intersectRay(e,i,r)||nte(t,e.origin,r))||!(!t.renderCoordsHelper.intersectManifold(e,0,r)||nte(t,e.origin,r))||!!s&&RUe(e,r,Yr(t.spatialReference).radius)}function RUe(t,e,r){const i=_e(t.origin,t.origin)-r*r,s=i>0?Math.sqrt(i)/3:1;return ae(e,t.direction,s/Me(t.direction)),me(e,e,t.origin),!0}const ote={},gF=M(),Hy=M(),Fv=M(),OUe={near:0,far:0},MUe=M(),jP=M();function xY(){return{direction:M(),up:M()}}function Kye(t,e,r,i,s){let n=ve(MUe,t),o=_e(n,i);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(_e(e,i)),o<.99?(le(n,e),a&&ae(n,n,-1)):n=null);let l=0;if(n){ae(jP,i,_e(i,n)),ge(n,n,jP);const h=_e(n,s)/(Me(n)*Me(s));pt(jP,n,s),l=(_e(jP,i)>0?1:-1)*ol(An(h))}const c=ol(An(-_e(i,t)/Me(t)));return r?(r.heading=l,r.tilt=c,r):{heading:l,tilt:c}}const Qye=$e(0,1,0),e0e=$e(0,0,1),RC=Ie(),Nm=M(),Fm=M();function t0e(t,e,r,i=xY()){const{direction:s,up:n}=i;return Efe(RC,-jt(e)),JS(RC,RC,jt(r)),Xe(s,e0e,RC),ae(s,s,-1),Xe(n,Qye,RC),i}function PUe(t,e,r,i){return Kye(e,r,i,e0e,Qye)}function IUe(t,e,r,i){const s=t0e(t,r,i),n=M();return ae(n,s.direction,-e),me(n,n,t),{up:s.up,eye:n,heading:r,tilt:i}}function $Ue(t){return ol(t)}function LUe(t){return jt(t)}function r0e(t,e,r,i,s){const n=t.renderSpatialReference,o=t.map&&t.spatialReference||e.spatialReference;return ta(e,Nm,n),ta(e,Fm,n),Nm[0]-=r/2,Fm[0]+=r/2,Nm[1]-=i/2,Fm[1]+=i/2,uo(Nm,n,Nm,o),uo(Fm,n,Fm,o),s?(s.xmin=Nm[0],s.ymin=Nm[1],s.xmax=Fm[0],s.ymax=Fm[1],s.spatialReference=o):s=new Hr(Nm[0],Nm[1],Fm[0],Fm[1],o),s}const DUe=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:PUe,eyeForCenterWithHeadingTilt:IUe,eyeTiltToLookAtTilt:LUe,headingTiltToDirectionUp:t0e,lookAtTiltToEyeTilt:$Ue,toExtent:r0e},Symbol.toStringTag,{value:"Module"}));function ate(t,e,r){if(C(e.longitude)||C(e.latitude)||C(r.longitude)||C(r.latitude))throw new Error("Invalid points: no lon/lat");return NUe(t,e.longitude,e.latitude,r.longitude,r.latitude)}function NUe(t,e,r,i,s){const n=jt(r),o=jt(s),a=n-o,l=jt(e)-jt(i),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Hh(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*t;return Math.round(1e4*p)/1e4}function FUe(t,e,r){const i=e.spatialReference,s=Yr(i),n=new _t(e.x,t.y,i),o=new _t(r.x,t.y,i),a=new _t(t.x,e.y,i),l=new _t(t.x,r.y,i);return{lon:ate(s.radius,n,o),lat:ate(s.radius,a,l)}}function UUe(t,e,r){const i=e/r,s=jt(t),n=Math.sin(i/2),o=Math.cos(s),a=2*Hh(Math.sqrt(n*n/(o*o)));return ol(a)}function VUe(t,e){let r=t/15;return e||(r=Math.round(r)),r}function lte(t,e){const r=t==null?void 0:t[0];if(r==null)return null;e||(e={hours:0,minutes:0,seconds:0}),e.hours=VUe(r,!0);const i=e.hours%1;e.hours-=i,e.minutes=60*i;const s=e.minutes%1;return e.minutes-=s,e.seconds=Math.round(60*s),e}const i0e=$e(0,0,1),s0e=ve(M(),$e(1,1,1)),kUe=new ev(-180,180),OC=Ie(),i_=M(),xx=M();function n0e(t,e,r,i=xY()){pt(i_,t,i0e),_e(i_,i_)===0&&pt(i_,t,s0e),Fu(OC,-jt(e),t),Mc(OC,OC,-jt(r),i_);const{up:s,direction:n}=i;return pt(s,i_,t),ve(s,s),Xe(s,s,OC),ve(n,t),xa(n,n),Xe(n,n,OC),i}function zUe(t,e,r,i){const s=i_,n=xx;return ve(s,t),pt(xx,s,i0e),_e(xx,xx)===0&&pt(xx,s,s0e),pt(n,xx,s),Kye(e,r,i,s,n)}function BUe(t,e,r,i){const s={eye:M(),up:null,tilt:i,heading:r},n=i_;n[0]=t[0],n[1]=t[2],n[2]=-t[1];const o=e,a=jt(r),l=jt(i),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),m=Me(n);let y;if(Math.abs(l)<1e-8)y=o+m;else{const q=m/p,$=Hh(o/q),N=Math.PI-l-$;y=q*Math.sin(N)}const _=f*o,b=o*o*(p*p),x=h*h*b,T=y-_,S=T*T,E=x*(x+S-n[1]*n[1]);if(E<0)return ae(s.eye,n,y/m),s.tilt=0,HP(s,t);const O=Math.sqrt(E),R=n[1]*T,L=x+S;let I;if(I=h>0?-O+R:O+R,Math.abs(L)<1e-8)return m<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):ae(s.eye,n,y/m),s.tilt=0,GU(s.eye),HP(s,t);s.eye[1]=I/L;const U=c*c*b,z=p*o,B=h*z*s.eye[1],G=s.eye[1]*s.eye[1],K=1-G,re=Math.sqrt(K),ee=x*G+U-2*B*re*T+K*S;return Math.abs(ee)<1e-8?(ae(s.eye,n,y/m),s.tilt=0,GU(s.eye),HP(s,t)):(s.eye[0]=(K*(y*n[0]-_*n[0])-z*re*(n[0]*s.eye[1]*h+n[2]*c))/ee,s.eye[2]=(K*(y*n[2]-_*n[2])-z*re*(n[2]*s.eye[1]*h-n[0]*c))/ee,ae(s.eye,s.eye,y),GU(s.eye),HP(s,t))}function GU(t){const e=t[1];t[1]=-t[2],t[2]=e}function HP(t,e){const r=n0e(e,t.heading,t.tilt);return t.up=r.up,t}function GUe(t,e,r){const i=Me(e),s=Math.sqrt(r*r+i*i-2*r*i*Math.cos(Math.PI-t)),n=Hh(r/(s/Math.sin(t)));return ol(t-n)}function jUe(t,e,r){const i=jt(t),s=Me(e);return Hh(r/(s/Math.sin(i)))+i}function o0e(t,e,r,i,s){let n,o,a,l;const c=e.latitude,h=Yr(t.spatialReference).radius,p=e.longitude,f=UUe(c,r,h)/2;n=p-f,o=p+f;const m=jt(c),y=(1+Math.sin(m))/(1-Math.sin(m)),_=(y+1)*Math.tan(i/h/2),b=_*_;function x(S){const E=Math.PI/2;return(S=JLe.normalize(S,-E))>E&&(S=Math.PI-S),S}if(a=1.5*Math.PI-2*Math.atan(.5*(_+Math.sqrt(4*y+b))),l=a+i/h,a=x(a),l=x(l),l<a){const S=l;l=a,a=S}if(a=Math.max(ol(a),-90),l=Math.min(ol(l),90),o=kUe.monotonic(n,o),o-n>180){const S=(o-n-180)/2;n+=S,o-=S}const T=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:We.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=T):s=new Hr(n,a,o,l,T),t.spatialReference&&t.spatialReference.isWebMercator&&jg(s,!1,s),s}const HUe=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:zUe,eyeForCenterWithHeadingTilt:BUe,eyeTiltToLookAtTilt:jUe,headingTiltToDirectionUp:n0e,lookAtTiltToEyeTilt:GUe,toExtent:o0e},Symbol.toStringTag,{value:"Module"}));function yF(t){return t.type==="point"}let a0e=class{constructor(e,r=null,i=0){this.array=e,this.spatialReference=r,this.offset=i}};function l0e(t){return"array"in t}function Hf(t,e,r="ground"){if(yF(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,r);if(l0e(e)){let i=e.offset;return t.getElevation(e.array[i++],e.array[i++],e.array[i]||0,It(e.spatialReference,t.spatialReference),r)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,r)}const c0e=se.getLogger("esri.views.3d.support.cameraUtils"),u0e=39.37,h0e=96,_7=1,qUe=8,WUe=5,d0e=1,cte=M(),XUe={heading:0,tilt:0},m_=new _t,YUe=new ev(-20037508342788905e-9,20037508342788905e-9),ZUe=new ev(-180,180);var Jo;function VM(t){return t.spatialReference||We.WGS84}function KE(t){return t.viewingMode==="global"?HUe:DUe}function JUe(t,e,r,i,s){return KE(t).headingTiltToDirectionUp(e,r,i,s)}function Cg(t,e){if(C(e))return null;const r=t.renderSpatialReference,i=KE(t).headingTiltToDirectionUp,s=M();if(!ta(e.position,s,r))return null;const n=i(s,e.heading,e.tilt);ae(n.direction,n.direction,t.state.camera.distance),me(n.direction,n.direction,s);const o=cx(t,s,n.direction,n.up);return o.fov=jt(e.fov),o}(function(t){t[t.LOCKED=0]="LOCKED",t[t.ADJUST=1]="ADJUST"})(Jo||(Jo={}));const Tx=M();function fE(t,e,r){const i=t.renderSpatialReference,s=D5(t,e.eye,e.viewForward,e.up,XUe);let n=VM(t);return uo(e.eye,i,Tx,n)||(n=We.WGS84,uo(e.eye,i,Tx,n)),C(r)?new qh(new _t(Tx,n),s.heading,s.tilt,ol(e.fov)):(r.position.x=Tx[0],r.position.y=Tx[1],r.position.z=Tx[2],r.position.spatialReference=n,r.heading=s.heading,r.tilt=s.tilt,r.fov=ol(e.fov),r)}function TY(t,e,r){const i=t.state.camera,s=i.width/2/i.pixelRatio;return t.renderCoordsHelper.viewingMode===Be.Global&&r!=null&&(e*=Math.cos(jt(r))),e/=t.renderCoordsHelper.unitInMeters,s/(h0e*u0e/e)/Math.tan(i.fovX/2)}function $w(t,e,r){const i=t.state.camera,s=e*Math.tan(i.fovX/2),n=i.width/2/i.pixelRatio;let o=h0e*u0e/(n/s);return t.renderCoordsHelper.viewingMode===Be.Global&&r!=null&&(o/=Math.cos(jt(r))),o*=t.renderCoordsHelper.unitInMeters,o}function p0e(t,e,r,i,s,n){return f0e(t,e,TY(t,r,e.latitude),i,s,n)}function f0e(t,e,r,i,s,n){if(lw(n)){const a=new QE(n.signal);return x3(t,i.heading,i.tilt,e,r,s,a),void a.resolver.promise.then(l=>{const c=vF(t,l,i.fov);if(!C(c))return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=x3(t,i.heading,i.tilt,e,r,s);return vF(t,o,i.fov,n)}function D5(t,e,r,i,s){return KE(t).directionToHeadingTilt(e,r,i,s)}function KUe(t,e){return!!(t.basemapTerrain&&t.renderCoordsHelper.fromRenderCoords(e,m_,t.spatialReference)&&t.elevationProvider&&It(Hf(t.elevationProvider,m_),0)>(m_.z??0)-d0e)}async function QUe(t,e,r){if(!t.renderCoordsHelper.fromRenderCoords(e,m_,t.spatialReference)||!t.elevationProvider)return!1;const i=m_.z??0,s=await t.elevationProvider.queryElevation(m_.x,m_.y,i,m_.spatialReference,"ground",r);return It(s,0)>i-d0e}async function e8e(t,e,r){const i=M();if(e)if(e instanceof _t){if(ta(e,i,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null&&t.elevationProvider!=null){const s=await t.elevationProvider.queryElevation(e.x,e.y,e.z??0,e.spatialReference,"ground",r);return v(s)&&t.renderCoordsHelper.setAltitude(i,s),i}}else le(i,e);else le(i,t.state.camera.center);return i}function t8e(t,e){const r=M();if(e&&e instanceof _t){if(ta(e,r,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null&&t.elevationProvider!=null){const i=Hf(t.elevationProvider,e);v(i)&&t.renderCoordsHelper.setAltitude(r,i)}}else le(r,e||t.state.camera.center);return r}function x3(t,e,r,i,s,n,o){const a=i&&i instanceof _t?i:null;if(lw(o))return e8e(t,i,o.signal).then(c=>{v7(t,e,r,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=t8e(t,i);return v7(t,e,r,a,l,s,n,o)}function v7(t,e,r,i,s,n,o,a){if(C(i)){const p=t.renderSpatialReference;if(i=iv(s,p,VM(t)),C(i))return null}n=Math.max(n,t.state.constraints.minimumPoiDistance);const l=s8e(t,e,r,s,n,o),c=(0,KE(t).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===Jo.ADJUST&&t.viewingMode==="global"&&r>0){const p=()=>{const m=m0e(t,s,n,o8e(t,n,r,s));return o=r-m<1?Jo.LOCKED:Jo.ADJUST,v7(t,e,m,i,s,n,o,a)},f=t.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(KUe(t,c.eye))return p();if(lw(a))return QUe(t,c.eye,a.signal).then(m=>m?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:gs(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||lw(a)?{center:M(),eye:M(),up:M(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=gs(s),h.heading=c.heading,h.tilt=c.tilt,lw(a)&&a.resolver.resolve(h),h}function yO(t,e,r,i,s,n=null){let o,a,l;if(t.state.isGlobal){if(!eE(e.spatialReference,Be.Global))return lw(n)&&n.resolver.reject(),null;const b=new _t(e.xmin,e.ymin,e.spatialReference),x=new _t(e.xmax,e.ymax,e.spatialReference),T=e.spatialReference.isGeographic?ZUe:YUe;o=new _t({x:T.center(b.x,x.x),y:(x.y+b.y)/2,z:e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0,spatialReference:e.spatialReference});const S=Yr(e.spatialReference),E=FUe(o,b,x);a=E.lon,l=E.lat,T.diff(b.x,x.x)>T.range/2&&(a+=S.halfCircumference),a=Math.min(a,S.halfCircumference),l=Math.min(l,S.halfCircumference)}else{const b=It(t.renderSpatialReference,e.spatialReference);b.equals(e.spatialReference)||(e=GE(e,b)),a=e.xmax-e.xmin,l=e.ymax-e.ymin;const x=e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0;o=new _t({x:e.xmin+.5*a,y:e.ymin+.5*l,z:x,spatialReference:b})}const c=e.zmax!=null&&e.zmin!=null?e.zmax-e.zmin:0,h=t.state.camera,p=1/Math.tan(h.fovX/2),f=1/Math.tan(h.fovY/2),m=1/Math.tan(h.fov/2),y=Math.max(.5*a*p,.5*l*f,.5*c*m)/_7;if(lw(n)){const b=new QE(n.signal);return x3(t,r,i,o,y,s,b),void b.resolver.promise.then(x=>{const T=vF(t,x,t.camera.fov);if(!C(T))return n.resolver.resolve(T);n.resolver.reject()},x=>n.resolver.reject(x))}const _=x3(t,r,i,o,y,s);return vF(t,_,t.camera.fov,n)}function r8e(t,e,r){const i=t.renderSpatialReference,s=iv(r,i,VM(t));if(C(s))return null;const n=Math.tan(e.fovX/2),o=Math.tan(e.fovY/2),a=AM(e.eye,r),l=2*a*n*_7,c=2*a*o*_7;return t.viewingMode==="global"?o0e(t,s,l,c):r0e(t,s,l,c)}function i8e(t,e,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/i)/Math.LN2>qUe)return!0;const s=t.renderSpatialReference,n=VM(t),o=iv(e,s,n),a=iv(t.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(C(o)||C(a))return!1;const l=Math.tan(.5*t.state.camera.fov)*i;return a.distance(o)/l>WUe}function s8e(t,e,r,i,s,n){let o=0;return n===Jo.ADJUST&&i8e(t,i,s)?(e=0,o=n8e(t,s,r,i)):o=SY(t,i,s,r),o=t.state.constraints.clampTilt(s,o),{heading:e,tilt:r=m0e(t,i,s,o)}}const _F=.7;function n8e(t,e,r,i){const s=SY(t,i,e,r);if(!t.state.constraints.tilt)return s;const n=t.state.constraints.tilt(e);n.max=Math.min(n.max,.5*Math.PI);const o=n.min*(1-_F)+n.max*_F;return Math.min(s,o)}function o8e(t,e,r,i){let s=SY(t,i,e,r);if(!t.state.constraints.tilt)return s;const n=t.state.constraints.tilt(e);return s=Math.min(s,.5*Math.PI),n.min*(1-_F)+s*_F}function m0e(t,e,r,i){return KE(t).lookAtTiltToEyeTilt(i,e,r)}function SY(t,e,r,i){return KE(t).eyeTiltToLookAtTilt(i,e,r)}function vF(t,e,r,i){if(C(e))return null;const s=t.renderSpatialReference,n=iv(e.eye,s,VM(t));return C(n)?null:v(i)?(i.position=n,i.heading=e.heading,i.tilt=e.tilt,i.fov=r,i):new qh(n,e.heading,e.tilt,r)}function a8e(t,e){var i;const r=(i=t.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.levelAtScale(e);c0e.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function g0e(t,e){var i;const r=(i=t.basemapTerrain)==null?void 0:i.tilingScheme;if(r)return r.scaleAtLevel(e);c0e.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function y0e(t,e){return uo(e.center,t.renderSpatialReference,cte,We.WGS84),$w(t,e.distance,cte[1])}let QE=class{constructor(e){this.signal=e,this.resolver=K_()}};function lw(t){return t&&"resolver"in t}const l8e=.66;function _0e(t){return 360-uX.normalize(t)}function N5(t){return uX.normalize(360-t)}function MC(t){return v(t)&&t.resolver&&t.resolver.reject(),null}function c8e(t,e){return v(t)&&t.resolver&&t.resolver.resolve(e),e}function EY(t,e,r,i=null){if(!e)return MC(i);const s=t.spatialReference||We.WGS84;if(v(e.camera)){const c=ex(e.camera.position,s);if(C(c))return MC(i);const h=e.camera.clone();return h.position=c,c8e(i,h)}if(C(e.targetGeometry))return MC(i);const n=e.get("targetGeometry.spatialReference");if(n&&!k_(n,s))return MC(i);const o=fE(t,t.state.camera);let a=Jo.ADJUST;if(e.rotation!=null&&(o.heading=_0e(e.rotation),a=Jo.LOCKED),r!=null&&(o.tilt=r),e.targetGeometry.type==="point"){const c=e.targetGeometry;let h;const p=e.targetGeometry.clone();return h=e.scale!=null?TY(t,e.scale,c.latitude):t.state.camera.distance,f0e(t,p,h,o,a,i)}const l=e.targetGeometry.extent;return l?yO(t,l,o.heading,o.tilt,a,i):MC(i)}function u8e(t,e,r=null){return C(r)&&(r=new Vc),RY(t,null,e.clone(),r)}async function h8e(t,e,r){const i=w8e(t,e);if(!i)throw new j("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new qh({fov:t.camera.fov}),n=new Vc({camera:s});if(i.target instanceof Vc)return Uv(await f8e(t,i.target,i,r,n));if(i.target instanceof qh)return Uv(b0e(t,i.target,n));const o=i.scale!=null||i.zoom!=null;if(i.target instanceof Hr){const c=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return Uv(o||c?await b7(t,i,i.target.center,s,r,n):await _8e(t,i,i.target,s,r,n))}const a={boundingBox:Mi(),hasZ:!1,screenSpaceObjects:[]},l=o?d8e(t,i):void 0;if(await v0e(t,i.target,l,a),isFinite(a.boundingBox[0])){let c;if(np(a.boundingBox,js),gu.x=js[0],gu.y=js[1],gu.z=js[2],gu.spatialReference=t.spatialReference,isFinite(gu.z)&&a.hasZ?c=GX(a.boundingBox):(gu.z=void 0,c=CDe(BX(a.boundingBox,T8e))),o||c)return Uv(await b7(t,i,gu,s,r,n));const h=x8e(t,a.screenSpaceObjects);return Uv(await b8e(t,i,gu,a.boundingBox,h,s,r,n))}return i.position?Uv(g8e(t,i,s,n)):Uv(await y8e(t,i,s,r,n))}function CY(t,e){return e.scale==null&&e.zoom!=null?g0e(t,e.zoom):e.scale}function d8e(t,e){const r=CY(t,e);return r?w6e(r):void 0}function AY(t,e){let r=!1;return e.heading!=null?(t.heading=e.heading,r=!0):e.rotation!=null&&(t.heading=_0e(e.rotation),r=!0),e.tilt!=null&&(t.tilt=e.tilt,r=!0),e.fov!=null&&(t.fov=e.fov),r}function RY(t,e,r,i){const s=t.spatialReference||We.WGS84;return e=v(e)?e:Cg(t,r),C(e)||(i.targetGeometry=iv(e.center,t.renderSpatialReference,s),i.scale=y0e(t,e),i.rotation=N5(r.heading),i.camera=r),i}function bF(t,e,r){var a,l;const i=()=>new j("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!e)throw i();if(!k_(e.spatialReference,t.spatialReference))throw new j("viewpointutils:incompatible-spatialreference",`Spatial reference (${e.spatialReference?e.spatialReference.wkid:"unknown"}) is incompatible with the view (${(a=t.spatialReference)==null?void 0:a.wkid})`,{geometry:e});const s=[];if(!e.hasZ&&t.basemapTerrain){let c;switch(e.type){case"point":c=e;break;case"multipoint":case"polyline":c=(l=e.extent)==null?void 0:l.center;break;case"mesh":c=e.origin;break;case"extent":c=e.center;break;case"polygon":c=e.centroid}c&&v(t.basemapTerrain.spatialReference)&&k_(c,t.basemapTerrain.spatialReference)&&t.elevationProvider?js[2]=It(Hf(t.elevationProvider,c),0):js[2]=0}(0,S8e[e.type])(e,c=>{s.push(c[0],c[1],c[2])},js);const n=s.length/3;if(n===0)throw i();const o=new Array(s.length);if(vs(s,e.spatialReference,0,o,t.spatialReference,0,n)){e.hasZ&&(r.hasZ=!0);for(let c=0;c<o.length;c+=3)e.hasZ?(js[0]=o[c+0],js[1]=o[c+1],js[2]=o[c+2]):(js[0]=o[c+0],js[1]=o[c+1]),mm(r.boundingBox,js)}}async function p8e(t,e,r,i){const s=await Uc(t.whenViewForGraphic(e));if(s.ok===!1||C(s.value)||!("whenGraphicBounds"in s.value))return void bF(t,e.geometry,i);const n=s.value,o=await Uc(n.whenGraphicBounds(e,{minDemResolution:r}));if(o.ok===!1)return void bF(t,e.geometry,i);const{screenSpaceObjects:a,boundingBox:l}=o.value;oE(i.boundingBox,l),a&&a.forEach(c=>{i.screenSpaceObjects.push(c)}),isFinite(l[2])&&(i.hasZ=!0)}async function v0e(t,e,r,i){var s;if(Array.isArray(e)&&e.length===2){const n=e[0],o=e[1];if(typeof n=="number"&&typeof o=="number")return gu.x=n,gu.y=o,gu.z=void 0,gu.spatialReference=(s=t.spatialReference)!=null&&s.isGeographic?t.spatialReference:We.WGS84,void bF(t,gu,i)}e&&typeof e.map=="function"?await co(e.map(n=>v0e(t,n,r,i))):e instanceof xv?bF(t,e,i):e instanceof Sa&&await p8e(t,e,r,i)}async function f8e(t,e,r,i,s){if(v(e.camera))return b0e(t,e.camera,s);s.scale=e.scale,s.rotation=e.rotation,s.targetGeometry=v(e.targetGeometry)?e.targetGeometry.clone():null,s.camera=null,r.heading!=null?s.rotation=N5(r.heading):r.rotation!=null&&(s.rotation=r.rotation);const n=CY(t,r);n!=null&&(s.scale=n);const o=new QE(i);return EY(t,s,r.tilt,o),s.camera=await o.resolver.promise,s}function b0e(t,e,r){const i=t.spatialReference,s=ex(e.position,i);return C(s)?null:((e=e.clone()).fov=t.camera.fov,e.position=s,RY(t,null,e,r))}function m8e(t,e,r,i,s,n){const o=t.renderSpatialReference;return ta(r,WP,o),ta(e,jU,o),n.targetGeometry=new _t(e),s.position=new _t(r),ge(wF,jU,WP),D5(t,WP,wF,i.up,s),n.scale=$w(t,Si(WP,jU),n.targetGeometry.latitude),n.rotation=N5(s.heading),n.camera=s,n}async function b7(t,e,r,i,s,n){if(C(r))throw new j("createfromcenter","invalid point");n.targetGeometry=r.clone();const o=cx(t);if(e.position)return m8e(t,n.targetGeometry,e.position,o,i,n);if(e.zoomFactor){const l=o.distance/e.zoomFactor,c=ae(js,o.viewForward,-l);o.eye=me(js,o.center,c),n.scale=$w(t,l,r.latitude)}fE(t,o,i);const a=AY(i,e)?Jo.LOCKED:Jo.ADJUST;if(!e.zoomFactor){const l=CY(t,e);l==null?(ta(r,js,t.renderSpatialReference),Eye(o.frustum,js)?n.scale=$w(t,Si(o.eye,js),r.latitude):n.scale=y0e(t,o)):n.scale=l;const c=new QE(s);p0e(t,n.targetGeometry,n.scale,i,a,c),n.camera=await c.resolver.promise}return n}function g8e(t,e,r,i){const s=cx(t);return le(wF,s.viewForward),D5(t,s.eye,wF,s.up,HU),r.position=new _t(e.position),r.heading=e.heading!=null?e.heading:HU.heading,r.tilt=e.tilt!=null?e.tilt:HU.tilt,RY(t,null,r,i)}async function y8e(t,e,r,i,s){const n=cx(t);return b7(t,e,iv(n.center,t.renderSpatialReference,t.spatialReference),r,i,s)}async function _8e(t,e,r,i,s,n){n.targetGeometry=r.clone();const o=cx(t);fE(t,o,i);const a=AY(i,e)?Jo.LOCKED:Jo.ADJUST,l=new QE(s);return yO(t,r,i.heading,i.tilt,a,l),n.camera=await l.resolver.promise,n}function v8e(t,e,r,i,s){let n=0;r.z!=null?n=r.z:t.basemapTerrain&&t.elevationProvider&&(n=Hf(t.elevationProvider,r)),ce(js,r.x,r.y,n),xp(t.spatialReference,js,ute,t.renderSpatialReference),Jh(qP,ute),Kh(qP,qP),Mi(PC);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let y=0;y<o.length;y++){const _=o[y];let b=i[_[2]];isFinite(b)||(b=n),ce(js,i[_[0]],i[_[1]],b),uo(js,t.spatialReference,js,t.renderSpatialReference),mm(PC,Oc(js,js,qP))}const a=rx(PC),l=Ev(PC),c=ix(PC),h=1/Math.tan(e.fovX/2),p=1/Math.tan(e.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,m=.5*l*p+.5*Math.max(a,c);return Math.max(f,m)/s}async function b8e(t,e,r,i,s,n,o,a){a.targetGeometry=r.clone();const l=cx(t),c=v8e(t,l,r,i,s);fE(t,l,n);const h=AY(n,e)?Jo.LOCKED:Jo.ADJUST;a.scale=$w(t,c,a.targetGeometry.latitude);const p=new QE(o);return p0e(t,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function w8e(t,e){if(!e||!t.spatialReference)return null;const r={target:void 0};if("declaredClass"in e||Array.isArray(e))r.target=e;else{for(const i in e)r[i]=e[i];e.center&&!r.target&&(r.target=e.center)}return r}function Uv(t){return t&&v(t.camera)&&(t.rotation=N5(t.camera.heading)),t}function x8e(t,e){const r=l8e;if(!e.length)return r;let i=Number.NEGATIVE_INFINITY;for(let s=0;s<e.length;s++){const n=e[s].screenSpaceBoundingRect;i=Math.max(i,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return r-i/Math.min(t.width,t.height)*2}const js=M(),ute=Ie(),qP=rs(),PC=Rn(),T8e=hr(),wF=M(),WP=M(),jU=M(),HU={heading:0,tilt:0},gu=new _t,S8e={point(t,e,r){r[0]=t.x,r[1]=t.y,t.z!=null&&(r[2]=t.z),e(r)},polygon(t,e,r){const i=t.hasZ;for(let s=0;s<t.rings.length;s++){const n=t.rings[s];for(let o=0;o<n.length;o++)r[0]=n[o][0],r[1]=n[o][1],i&&(r[2]=n[o][2]),e(r)}},polyline(t,e,r){const i=t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s];for(let o=0;o<n.length;o++)r[0]=n[o][0],r[1]=n[o][1],i&&(r[2]=n[o][2]),e(r)}},multipoint(t,e,r){const i=t.points,s=t.hasZ;for(let n=0;n<i.length;n++)r[0]=i[n][0],r[1]=i[n][1],s&&(r[2]=i[n][2]),e(r)},extent(t,e,r){t.zmin!=null&&t.zmax!=null?(e(ce(r,t.xmin,t.ymin,t.zmin)),e(ce(r,t.xmax,t.ymin,t.zmin)),e(ce(r,t.xmin,t.ymax,t.zmin)),e(ce(r,t.xmax,t.ymax,t.zmin)),e(ce(r,t.xmin,t.ymin,t.zmax)),e(ce(r,t.xmax,t.ymin,t.zmax)),e(ce(r,t.xmin,t.ymax,t.zmax)),e(ce(r,t.xmax,t.ymax,t.zmax))):(e(ce(r,t.xmin,t.ymin,r[2])),e(ce(r,t.xmax,t.ymin,r[2])),e(ce(r,t.xmin,t.ymax,r[2])),e(ce(r,t.xmax,t.ymax,r[2])))},mesh(t,e,r){const i=t.vertexAttributes&&t.vertexAttributes.position;if(i)for(let s=0;s<i.length;s+=3)e(ce(r,i[s+0],i[s+1],i[s+2]))}};let xF=class{constructor(e){this._observable=new AW,this._value=e}get(){return vr(this._observable),this._value}set(e){e!==this._value&&(this._value=e,this._observable.notify())}},E8e=class{constructor(){this._tasks=new Array,this._running=new xF(!1)}get length(){return this._tasks.length}get running(){return this._running.get()}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,r,i){return this._running.set(!0),new Promise((s,n)=>this._tasks.push(new hte(s,n,e,r,i)))}unshift(e,r,i){return this._running.set(!0),new Promise((s,n)=>this._tasks.unshift(new hte(s,n,e,r,i)))}_process(e){var i;if(this._tasks.length===0)return!1;const r=this._tasks.shift();try{const s=Fn(r.signal);if(s&&!r.abortCallback)r.reject(qr());else{const n=s?(i=r.abortCallback)==null?void 0:i.call(r,qr()):r.callback(e);Gu(n)?n.then(r.resolve,r.reject):r.resolve(n)}}catch(s){r.reject(s)}return this._running.set(this._tasks.length>0),!0}cancelAll(){const e=qr();for(const r of this._tasks)if(r.abortCallback){const i=r.abortCallback(e);r.resolve(i)}else r.reject(e);this._tasks.length=0,this._running.set(!1)}},hte=class{constructor(e,r,i,s,n){this.resolve=e,this.reject=r,this.callback=i,this.signal=s,this.abortCallback=n}},hR=class extends Te{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],hR.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],hR.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),hR=u([P("esri.views.support.DebugFlags")],hR);const C8e=new hR;var Tr;(function(t){t[t.ANIMATING=0]="ANIMATING",t[t.INTERACTING=1]="INTERACTING",t[t.IDLE=2]="IDLE"})(Tr||(Tr={}));function A8e(){return new TF.Scheduler}var ea,yt;(function(t){t[t.YIELD=1]="YIELD"})(ea||(ea={})),function(t){t.RESOURCE_CONTROLLER_IMMEDIATE="immediate",t.RESOURCE_CONTROLLER="schedule",t.SLIDE="slide",t.STREAM_DATA_LOADER="stream loader",t.ELEVATION_QUERY="elevation query",t.TERRAIN_SURFACE="terrain",t.SURFACE_GEOMETRY_UPDATES="surface geometry updates",t.LOD_RENDERER="LoD renderer",t.GRAPHICS_CORE="Graphics3D",t.I3S_CONTROLLER="I3S",t.POINT_CLOUD_LAYER="point cloud",t.FEATURE_TILE_FETCHER="feature fetcher",t.OVERLAY="overlay",t.STAGE="stage",t.GRAPHICS_DECONFLICTOR="graphics deconflictor",t.FILTER_VISIBILITY="Graphics3D filter visibility",t.SCALE_VISIBILITY="Graphics3D scale visibility",t.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",t.POINT_OF_INTEREST_FREQUENT="POI frequent",t.POINT_OF_INTEREST_INFREQUENT="POI infrequent",t.LABELER="labeler",t.FEATURE_QUERY_ENGINE="feature query",t.FEATURE_TILE_TREE="feature tile tree",t.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",t.ELEVATION_ALIGNMENT="elevation alignment",t.TEXT_TEXTURE_ATLAS="text texture atlas",t.TEXTURE_UNLOAD="texture unload",t.LINE_OF_SIGHT_TOOL="line of sight tool",t.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",t.ELEVATION_PROFILE="elevation profile",t.SNAPPING="snapping",t.SHADOW_ACCUMULATOR="shadow accumulator",t.CLOUDS_GENERATOR="clouds generator",t[t.TEST_PRIO=1]="TEST_PRIO"}(yt||(yt={}));const $f=0,dte=new Map([[yt.RESOURCE_CONTROLLER_IMMEDIATE,$f],[yt.RESOURCE_CONTROLLER,4],[yt.SLIDE,$f],[yt.STREAM_DATA_LOADER,$f],[yt.ELEVATION_QUERY,$f],[yt.TERRAIN_SURFACE,1],[yt.SURFACE_GEOMETRY_UPDATES,1],[yt.LOD_RENDERER,2],[yt.GRAPHICS_CORE,2],[yt.I3S_CONTROLLER,2],[yt.POINT_CLOUD_LAYER,2],[yt.FEATURE_TILE_FETCHER,2],[yt.OVERLAY,4],[yt.STAGE,4],[yt.GRAPHICS_DECONFLICTOR,4],[yt.FILTER_VISIBILITY,4],[yt.SCALE_VISIBILITY,4],[yt.FRUSTUM_VISIBILITY,4],[yt.CLOUDS_GENERATOR,4],[yt.POINT_OF_INTEREST_FREQUENT,6],[yt.POINT_OF_INTEREST_INFREQUENT,30],[yt.LABELER,8],[yt.FEATURE_QUERY_ENGINE,8],[yt.FEATURE_TILE_TREE,16],[yt.FEATURE_TILE_TREE_ACTIVE,$f],[yt.ELEVATION_ALIGNMENT,12],[yt.TEXT_TEXTURE_ATLAS,12],[yt.TEXTURE_UNLOAD,12],[yt.LINE_OF_SIGHT_TOOL,16],[yt.LINE_OF_SIGHT_TOOL_INTERACTIVE,$f],[yt.SNAPPING,$f],[yt.SHADOW_ACCUMULATOR,30]]);function pte(t){return dte.has(t)?dte.get(t):typeof t=="number"?t:1}const fte=6.5,mte=1,R8e=30,gte=1e3/30,yte=100,_te=.9;var TF,Vv;(function(t){class e{get updating(){return this._updating.get()}_updatingChanged(){this._updating.set(this._tasks.some(n=>n.needsUpdate))}constructor(){this._updating=new xF(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new Ug("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new i,this._state=Tr.INTERACTING,this._tasks=new Kt,this._runQueue=new Kt,this._load=0,this._idleStateCallbacks=new Kt,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=ne(()=>C8e.SCHEDULER_LOG_SLOW_TASKS,o=>this._debug=o,kt);for(const o of Object.keys(yt))this.performanceInfo.tasks.set(yt[o],new Ug(yt[o]));const n=this;this._test={FRAME_SAFETY_BUDGET:fte,INTERACTING_BUDGET:gte,IDLE_BUDGET:yte,get availableBudget(){return n._budget.budget},usedBudget:0,getBudget:()=>n._budget,setBudget:o=>n._budget=o,updateTask:o=>this._updateTask(o),getState:o=>this._getState(o),getRuntime:o=>this._getRuntime(o),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(n=>n.remove()),this._tasks.clear(),Vi(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(n){this._updatingChanged(),n&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this.frame())}))}registerTask(n,o){const a=pte(n),l=new r(this,n,o,a);return this._tasks.push(l),this._updatingChanged(),this.performanceInfo.tasks.has(n)||this.performanceInfo.tasks.set(n,new Ug(n)),l}registerIdleStateCallbacks(n,o){const a={idleBegin:n,idleEnd:o};this._idleStateCallbacks.push(a),this.state===Tr.IDLE&&this._idleUpdatesStartFired&&a.idleBegin();const l=this;return{remove:()=>this._removeIdleStateCallbacks(a),set idleBegin(c){l._idleUpdatesStartFired&&(a.idleEnd(),l._state===Tr.IDLE&&c()),a.idleBegin=c},set idleEnd(c){a.idleEnd=c}}}get load(){return this._load}set state(n){this._state!==n&&(this._state=n,this.state!==Tr.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(o=>o.idleEnd())))}get state(){return this._state}updateBudget(n){this._test.usedBudget=0,++this._frameNumber;let o=fte,a=n.frameDuration,l=mte;switch(this.state){case Tr.IDLE:o=0,a=Math.max(yte,n.frameDuration),l=R8e;break;case Tr.INTERACTING:a=Math.max(gte,n.frameDuration);case Tr.ANIMATING:}return a=a-n.elapsedFrameTime-o,this.state!==Tr.IDLE&&a<mte&&!this._forceTask?(this._forceTask=!0,!1):(a=Math.max(a,l),this._budget.reset(a,this.state),this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case Tr.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(n=>n.idleBegin())),this._runIdle();break;case Tr.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(0,this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(n){this._idleUpdatesStartFired&&n.idleEnd(),this._idleStateCallbacks.removeUnordered(n)}removeTask(n){this._tasks.removeUnordered(n),this._runQueue.removeUnordered(n),this._updatingChanged()}_updateTask(n){this._tasks.forAll(o=>{o.name===n&&o.setPriority(n)})}_getState(n){if(this._runQueue.some(a=>a.name===n))return Vv.SCHEDULED;let o=Vv.IDLE;return this._tasks.forAll(a=>{a.name===n&&a.needsUpdate&&(a.schedulePriority<=1?o=Vv.READY:o!==Vv.READY&&(o=Vv.WAITING))}),o}_getRuntime(n){let o=0;return this._tasks.forAll(a=>{a.name===n&&(o+=a.runtime)}),o}_resetRuntimes(){this._tasks.forAll(n=>n.runtime=0)}_getRunning(){const n=new Map;if(this._tasks.forAll(a=>{a.needsUpdate&&n.set(a.name,(n.get(a.name)||0)+1)}),n.size===0)return null;let o="";return n.forEach((a,l)=>{o+=a>1?` ${a}x ${l}`:` ${l}`}),o}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const n=this._tasks.reduce((o,a)=>a.needsUpdate?++o:o,0);this._load=this._load*_te+n*(1-_te)}_schedule(){for(this._runQueue.filterInPlace(n=>!!n.needsUpdate||(n.schedulePriority=n.basePriority,!1)),this._tasks.forAll(n=>{n.basePriority===$f&&n.needsUpdate&&!this._runQueue.includes(n)&&n.blockFrame!==this._frameNumber&&this._runQueue.unshift(n)});this._runQueue.length===0;){let n=!1,o=0;if(this._tasks.forAll(a=>{a.needsUpdate&&a.schedulePriority!==0&&a.basePriority!==$f&&a.blockFrame!==this._frameNumber&&(n=!0,o=Math.max(o,a.basePriority),a.schedulePriority===1?(a.schedulePriority=0,this._runQueue.push(a)):--a.schedulePriority)}),!n)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){const n=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const o=this._budget.now(),a=this._runQueue.pop();this._budget.resetProgress();try{a.task.runTask(this._budget)===ea.YIELD&&(a.blockFrame=this._frameNumber)}catch(c){se.getLogger("esri.views.support.Scheduler").error(`Exception in task "${a.name}"`,c)}!this._budget.hasProgressed&&a.blockFrame!==this._frameNumber&&a.needsUpdate&&(a.name,yt.I3S_CONTROLLER,a.blockFrame=this._frameNumber),a.schedulePriority=a.basePriority;const l=this._budget.now()-o;if(a.runtime+=l,this._frameTaskTimes.set(a.priority,this._frameTaskTimes.get(a.priority)+l),this._debug&&l>2*this._budget.budget&&console.log("Task",a.name,"used",l,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this._updatingChanged(),void this._recordFrameTaskTimes(this._budget.now()-n)}while(this._schedule());this._updatingChanged(),this._recordFrameTaskTimes(this._budget.now()-n)}_startFrameTaskTimes(){for(const n of Object.keys(yt))this._frameTaskTimes.set(yt[n],0)}_recordFrameTaskTimes(n){this._frameTaskTimes.forEach((o,a)=>this.performanceInfo.tasks.get(a).record(o)),this.performanceInfo.total.record(n)}get test(){return this._test}}t.Scheduler=e;class r{get task(){return this._task.get()}get updating(){return this._queue.running}constructor(n,o,a,l){this._scheduler=n,this.name=o,this._basePriority=l,this.blockFrame=0,this.runtime=0,this._queue=new E8e,this._handles=new Zr,this.schedulePriority=this._basePriority,this._task=new xF(v(a)?a:this._queue),this._handles.add(ra(()=>this.task.running,c=>n.taskRunningChanged(c)))}remove(){this.processQueue(Ja),this._scheduler.removeTask(this),this.schedule=mE.schedule,this.reschedule=mE.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(n){this.name=n;const o=pte(n);this._basePriority!==$f&&this.schedulePriority===0||(this.schedulePriority=o),this._basePriority=o}get priority(){return this.name}set priority(n){this.setPriority(n)}get needsUpdate(){return this.updating||this.task.running}schedule(n,o,a){return this._queue.push(n,o,a)}reschedule(n,o,a){return this._queue.unshift(n,o,a)}processQueue(n){this._queue.runTask(n)}}class i{constructor(){this._begin=typeof performance<"u"?performance.now():0,this._budget=0,this._state=Tr.IDLE,this._done=!1,this._progressed=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return performance.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}t.Budget=i})(TF||(TF={})),function(t){t.SCHEDULED="s",t.READY="r",t.WAITING="w",t.IDLE="i"}(Vv||(Vv={}));const Ja=(()=>{const t=new TF.Budget;return t.enabled=!1,t})();let O8e=class{remove(){}processQueue(){}schedule(e,r,i){try{if(Fn(r)){const s=qr();return i?Promise.resolve(i(s)):Promise.reject(s)}return Nk(e(Ja))}catch(s){return Promise.reject(s)}}reschedule(e,r,i){return this.schedule(e,r,i)}};const mE=new O8e;var w7;let Vg=w7=class extends fe{constructor(){super(...arguments),this.url=""}destroy(){this.url=""}clone(){return new w7({url:this.url})}};u([d({type:String,json:{write:{isRequired:!0}}})],Vg.prototype,"url",void 0),Vg=w7=u([P("esri.webdoc.support.SlideThumbnail")],Vg);var x7;let QL=x7=class extends fe{constructor(){super(...arguments),this.text=""}clone(){return new x7({text:this.text})}};u([d({type:String,json:{write:!0}})],QL.prototype,"text",void 0),QL=x7=u([P("esri.webscene.support.Description")],QL);const eD=QL;var T7;let U2=T7=class extends fe{constructor(){super(...arguments),this.lighting=new Ow,this.weather=new sF}clone(){return new T7({lighting:te(this.lighting),weather:te(this.weather)})}};u([d({types:bme,json:{write:!0}})],U2.prototype,"lighting",void 0),u([d({types:OX,json:{write:!0}})],U2.prototype,"weather",void 0),U2=T7=u([P("esri.webscene.Environment")],U2);var tD;let rD=tD=class extends fe{constructor(){super(...arguments),this.opacity=null}clone(){return new tD({opacity:this.opacity})}cloneAndApplyTo(t){return this.opacity==null||((t=t!=null?t.clone():new c3).opacity=this.opacity),t}static fromGround(t){return new tD({opacity:t.opacity})}};u([d({type:Number,json:{type:Ti,read:{reader:XS,source:"transparency"},write:{writer:(t,e)=>{e.transparency=RM(t)},target:"transparency"}}})],rD.prototype,"opacity",void 0),rD=tD=u([P("esri.webscene.support.SlideGround")],rD);const w0e=rD;var S7;let V2=S7=class extends fe{constructor(t){super(t),this.id="",this.sublayerIds=null}clone(){return new S7({id:this.id,sublayerIds:te(this.sublayerIds)})}};u([d({type:String,json:{write:!0}})],V2.prototype,"id",void 0),u([d({type:[Ti],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],V2.prototype,"sublayerIds",void 0),V2=S7=u([P("esri.webscene.support.SlideVisibleLayer")],V2);var E7;let iD=E7=class extends fe{constructor(){super(...arguments),this.text=""}clone(){return new E7({text:this.text})}};u([d({type:String,json:{write:{isRequired:!0}}})],iD.prototype,"text",void 0),iD=E7=u([P("esri.webscene.support.Title")],iD);const _O=iD;let M8e=0;const C7=ft.ofType(V2);let ua=class extends fe{constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+M8e++,this.title=new _O,this.description=new eD,this.thumbnail=new Vg,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new U2,this.visibleLayers=new C7}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail=Ve(this.thumbnail),this.description=null,this.title=null,this.thumbnail=null}castTitle(e){return typeof e=="string"?new _O({text:e}):Ls(_O,e)}castDescription(e){return typeof e=="string"?new eD({text:e}):Ls(eD,e)}castThumbnail(e){return typeof e=="string"?new Vg({url:e}):Ls(Vg,e)}castBasemap(e){return eX(e)}set visibleLayers(e){this._set("visibleLayers",sy(e,this._get("visibleLayers"),C7))}castVisibleLayers(e){return e&&typeof e.map=="function"?e.map(r=>{if(typeof r=="string")return{id:r};if(r instanceof h3){const i=vte(r);return{id:r.id,sublayerIds:i}}return r.id?{id:r.id,sublayerIds:"sublayerIds"in r?r.sublayerIds:void 0}:(se.getLogger(this.declaredClass).warn('Invalid visible layer, expected { id }, Layer or "id"'),r)}):null}clone(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(e){const r=[];return co(this._getLayers(e.map).map(i=>e.whenLayerView(i).then(s=>{if(s.visible){const n=vte(i);r.push(new V2({id:s.layer.id,sublayerIds:n}))}})).toArray()).then(()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(r)})}updateFrom(e,r){const i={format:"png",quality:80,width:120,height:75,disableDecorations:!0,...r&&r.screenshot};return e.when(()=>(this.viewpoint=e.viewpoint.clone(),this.environment.lighting=e.environment.lighting.type==="virtual"?PM.prototype.clone.apply(e.environment.lighting):Ow.prototype.clone.apply(e.environment.lighting),this.environment.weather=e.environment.weather.clone(),this.basemap=e.map.basemap&&e.map.basemap.clone()||null,this.ground=e.map.ground?w0e.fromGround(e.map.ground):null,this._updateVisibleLayersFrom(e))).then(()=>e.takeScreenshot(i)).then(s=>(this.thumbnail=new Vg({url:s.dataUrl}),this))}async applyTo(e,r){v(this._applyToController)&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const s=W4(r,()=>i==null?void 0:i.abort()),n=e.resourceController.scheduler.registerTask(yt.SLIDE);let o=!1;const a={animate:!0,...r,signal:this._applyToController.signal},l=async()=>{await Promise.all([n.schedule(()=>o=this._setViewpointOfInterest(e,a)),n.schedule(()=>this._applyBasemap(e,a),a.signal)]),await Promise.all([n.schedule(()=>this._applyLayerVisibility(e),a.signal),n.schedule(()=>this._applyGround(e),a.signal),n.schedule(()=>this._applyViewpoint(e,a),a.signal)]),await n.schedule(()=>e.environment.weather=this.environment.weather.clone())},c=await Uc(e.addUpdatingPromise(l()));if(o&&(e.contentCamera=null),n.remove(),this._applyToController===i&&(this._applyToController=null),i=null,s==null||s.remove(),c.ok===!1)throw c.error;return this}async _applyBasemap(e,r){if(this.basemap){try{await this.basemap.load(r)}catch(i){if(Ks(i))throw i}e.map.basemap=xLe(this.basemap,e.map.basemap)}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground))}_getLayers(e){const r=new ft;return this._collectLayers(e,r),this._collectLayers(e.ground,r),r}_collectLayers(e,r){e.layers.forEach(i=>{t4e(i)&&(r.add(i),"layers"in i&&this._collectLayers(i,r))})}_applyLayerVisibility(e){this.visibleLayers&&this._getLayers(e.map).forEach(r=>{const i=this.visibleLayers.find(o=>o.id===r.id);r.visible=i!=null;const s=i&&i.sublayerIds,n=x0e(r);s&&n&&n.forEach(o=>o.visible=s.includes(o.id))})}_setViewpointOfInterest(e,r){if(e.state.fixedContentCamera||!this.viewpoint||r!=null&&r.ignoreViewpoint||!(r!=null&&r.useDestinationCamera))return!1;const i=EY(e,this.viewpoint);return e.contentCamera=i,v(i)}async _applyViewpoint(e,r){if(this._applyCachedCameraTrackingEnabled(e),this.viewpoint&&!r.ignoreViewpoint){if(v(this.viewpoint.camera)&&(this.viewpoint.camera.fov=e.camera.fov),r.animate&&this.get("environment.lighting.date"))return this._animateToLighting(e,r);r.animate&&(e.environment.applyLighting(this.environment.lighting.clone()),await e.goTo(this.viewpoint,r)),e.viewpoint=this.viewpoint}e.environment.applyLighting(this.environment.lighting.clone())}async _animateToLighting(e,r){let i=null;return e.environment.lighting.type!=="virtual"&&this.environment.lighting.type!=="virtual"&&(e.viewingMode==="global"&&(i=this._animateLightingWithCamera(e,e.environment.lighting,this.environment.lighting)),e.environment.cachedCameraTrackingEnabled=e.environment.lighting.cameraTrackingEnabled,e.environment.lighting.cameraTrackingEnabled=!1),e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,this.environment.lighting.type==="virtual"||e.environment.lighting.type==="virtual"?(e.environment.applyLighting(this.environment.lighting.clone()),e.environment.lighting.type!=="virtual"&&(e.environment.cachedCameraTrackingEnabled=e.environment.lighting.cameraTrackingEnabled,e.environment.lighting.cameraTrackingEnabled=!1)):this.environment.lighting.displayUTCOffset!=null&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),e.goTo(this.viewpoint,r).then(()=>{this._applyCachedCameraTrackingEnabled(e),e.environment.applyLighting(this.environment.lighting.clone())}).catch(s=>{throw C(e.animation)&&this._applyCachedCameraTrackingEnabled(e),s}).finally(()=>{Vi(i)})}_applyCachedCameraTrackingEnabled(e){v(e.environment.cachedCameraTrackingEnabled)&&(e.environment.lighting.cameraTrackingEnabled=e.environment.cachedCameraTrackingEnabled,e.environment.cachedCameraTrackingEnabled=null)}_getTime(e){return[e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]}_setTime(e,r,i){return e.setTime(r),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e,r,i){const s=new Date(r.date.toString()),[n,o]=this._getTime(s),[a,l]=this._getTime(i.date),c=P8e(o,l),h=e.renderCoordsHelper,p=M();h.toRenderCoords(e.camera.position,p);const f=M(),m=M();v(this.viewpoint.camera)&&h.toRenderCoords(this.viewpoint.camera.position,f);const y=new Date;return ra(()=>e.camera,_=>{h.toRenderCoords(_.position,m);const b=Vn(p,m),x=Vn(f,m);let T=0;b+x!==0&&(T=b/(b+x));const S=n+(a-n)*T,E=I8e(o,c*T);r.date=this._setTime(y,S,E)})}static createFrom(e,r){return new this().updateFrom(e,r)}};function x0e(t){if(t.type==="building-scene"||t.type==="map-image")return t.allSublayers.toArray()}function vte(t){const e=x0e(t);if(e)return e.filter(r=>r.visible).map(r=>r.id)}u([d({type:String,json:{write:{isRequired:!0}}})],ua.prototype,"id",void 0),u([d({type:_O,json:{default:()=>new _O({text:""}),write:{isRequired:!0}}})],ua.prototype,"title",void 0),u([Gt("title")],ua.prototype,"castTitle",null),u([d({type:eD,json:{write:{overridePolicy:t=>({enabled:!(!t||!t.text)})}}})],ua.prototype,"description",void 0),u([Gt("description")],ua.prototype,"castDescription",null),u([d({type:Vg,json:{default:()=>new Vg({url:""}),write:{isRequired:!0}}})],ua.prototype,"thumbnail",void 0),u([Gt("thumbnail")],ua.prototype,"castThumbnail",null),u([d({type:Vc,nonNullable:!0,json:{write:{isRequired:!0}}})],ua.prototype,"viewpoint",void 0),u([d({type:HS,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],ua.prototype,"basemap",void 0),u([Gt("basemap")],ua.prototype,"castBasemap",null),u([d({type:w0e,json:{write:!0}})],ua.prototype,"ground",void 0),u([d({type:C7,json:{write:{isRequired:!0}}})],ua.prototype,"visibleLayers",null),u([Gt("visibleLayers")],ua.prototype,"castVisibleLayers",null),u([d({type:U2,json:{write:!0}})],ua.prototype,"environment",void 0),ua=u([P("esri.webscene.Slide")],ua);const A7=86400,bte=43200;function P8e(t,e){let r=e-t;return r>bte&&(r-=A7),r<-bte&&(r+=A7),r}function I8e(t,e){return i4e(t+e,A7)}const $8e=ua,R7=ft.ofType($8e);let sD=class extends fe{constructor(e){super(e),this.slides=new R7}destroy(){this.slides.forEach(e=>e.destroy()),this.slides.removeAll()}set slides(e){e&&(e=e.filter(r=>!!r.viewpoint)),this._set("slides",sy(e,this._get("slides"),R7))}clone(){return new this.constructor({slides:this.slides.clone()})}};u([d({type:R7,nonNullable:!0,json:{write:!0}}),Gt(RW)],sD.prototype,"slides",null),sD=u([P("esri.webscene.Presentation")],sD);const T0e=sD;var O7;let jT=O7=class extends fe{constructor(t){super(t)}clone(){return new O7({name:this.name,path:this.path,title:this.title})}};u([d({type:String,json:{write:!0}})],jT.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],jT.prototype,"path",void 0),u([d({type:String,json:{write:!0}})],jT.prototype,"title",void 0),jT=O7=u([P("esri.webscene.TransportationNetwork")],jT);const L8e=jT;let Lw=class{constructor(e,r,i=""){this.major=e,this.minor=r,this._context=i}lessThan(e,r){return this.major<e||e===this.major&&this.minor<r}since(e,r){return!this.lessThan(e,r)}validate(e){if(this.major!==e.major){const r=this._context&&this._context+":",i=this._context&&this._context+" ";throw new j(r+"unsupported-version",`Required major ${i}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:e})}}clone(){return new Lw(this.major,this.minor,this._context)}static parse(e,r=""){const[i,s]=e.split("."),n=/^\s*\d+\s*$/;if(!i||!i.match||!i.match(n))throw new j((r&&r+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!s||!s.match||!s.match(n))throw new j((r&&r+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});const o=parseInt(i,10),a=parseInt(s,10);return new Lw(o,a,r)}},SF=class extends Lw{constructor(e,r){super(e,r,"webscene")}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}},D8e=null;function N8e(){return D8e}const cw=new SF(1,30),F8e=()=>{const e=[],r=cw.major;for(let i=8;i<=cw.minor;i++)e.push(`${r}.${i}`);return e},qU="Web Scene",XP="ViewingMode-Local";let fi=class extends cm.LoadableMixin(SM(hX(bfe))){constructor(e){super(e),this._layersIdGCTimeoutId=void 0,this._handles=new Zr,this._updateFromPromise=null,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=void 0,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new T0e,this.initialViewProperties=new nF,this.portalItem=null,this.resourceInfo=null,this._debouncedSaveOperations=vW(async(r,i,s)=>{switch(r){case k2.SAVE:return this._saveImpl(i);case k2.SAVE_AS:return this._saveAsImpl(s,i)}}),this._resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch(e=>{se.getLogger(this.declaredClass).error("#load()","Failed to load web scene",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(r){return void this.addResolvingPromise(Promise.reject(r))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this._handles.add(this.allLayers.on("change",()=>this._scheduleLayersIdGC()))}destroy(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();const e=this.portalItem;this.portalItem=null,e==null||e.destroy()}writeClippingArea(e,r){r.clippingArea||(r.clippingArea={}),r.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,r){return!!r.clippingArea&&!!r.clippingArea.clip}writeClippingEnabled(e,r){this.clippingArea&&(r.clippingArea||(r.clippingArea={}),r.clippingArea.clip=e)}writeLayers(e,r,i,s){const n={...s,layerContainerType:"operational-layers"},o=e.map(a=>this.verifyWriteLayer(a,s)?a.write({},n):null).filter(a=>!!a);r[i]=o.toArray()}verifyWriteLayer(e,r){return"write"in e||(r&&r.messages&&r.messages.push(new j("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1)}readSourceVersion(e,r){const[i,s]=r.version.split(".");return new SF(parseInt(i,10),parseInt(s,10))}writeSourceVersion(e,r,i){r[i]=`${cw.major}.${cw.minor}`}get thumbnailUrl(){var e;return((e=this.portalItem)==null?void 0:e.thumbnailUrl)??null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,r){e&&this._isAuthoringAppSetByUser?r.authoringApp=e:r.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,r){e&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=e:r.authoringAppVersion=mW}writeGround(e,r,i,s){r[i]=e?e.write({},s):{transparency:0,layers:[]}}readInitialViewProperties(e,r){const i={};return r.initialState&&r.initialState.environment&&(i.environment=tE.fromJSON(r.initialState.environment)),r.spatialReference?i.spatialReference=We.fromJSON(r.spatialReference):i.spatialReference=We.WebMercator,i.viewingMode=r.viewingMode||"global",r.initialState&&r.initialState.viewpoint&&(i.viewpoint=Vc.fromJSON(r.initialState.viewpoint)),new nF(i)}get spatialReference(){var e;return((e=this.initialViewProperties)==null?void 0:e.spatialReference)??We.WebMercator}get viewingMode(){var e;return((e=this.initialViewProperties)==null?void 0:e.viewingMode)??"global"}load(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return PW(this,e=>{const r=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,r&&r.map(i=>i.basemap))})}read(e,r){var n;r={...r,origin:"web-scene"};const i=this._isAuthoringAppVersionSetByUser,s=this._isAuthoringAppSetByUser;if(Kde(this,e,o=>super.read(e,o),r),s||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&((n=this.sourceVersion)==null?void 0:n.supportsVisibleElevationLayersInSlides)){const o=e.baseMap.elevationLayers.map(h=>({id:h.id})),a=this.presentation.slides,l=(h,p)=>h.visibleLayers.some(f=>f.id===p),c=o.filter(h=>!a.some(p=>l(p,h.id)));a.forEach(h=>{h.visibleLayers.addMany(c)})}}_writeBasemapElevationLayers(e){const r=e.ground&&e.ground.layers;!e.baseMap&&r&&r.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=te(r))}write(e,r){var n;if(this.loadStatus!=="loaded"){const o=new j("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw se.getLogger(this.declaredClass).error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),o}this._runLayersIdGC();const i=!(r!=null&&r.messages);r={messages:[],...r,origin:"web-scene"};const s=super.write(e,r);if(i){const o=((n=r.messages)==null?void 0:n.filter(a=>a.name==="web-document-write:property-required"))??[];if(o.length){const a=new j("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:o});throw se.getLogger(this.declaredClass).error("#toJSON()","One or more properties that are required in the webscene JSON are missing",o),a}}return this._writeBasemapElevationLayers(s),s}async save(e){return this._debouncedSaveOperations(k2.SAVE,e)}async _saveImpl(e){var n;if(!this.portalItem)throw se.getLogger(this.declaredClass).error("save(): requires the .portalItem property to be set"),await Promise.resolve(),new j("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene");if(((n=this.portalItem)==null?void 0:n.type)!==qU)throw await Promise.resolve(),new j("webscene:portal-item-wrong-type",`Portal item needs to have type "${qU}"`);const r=this._updateFromPromise;await this._ensureLoadBeforeSave();const i=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl?lo(this.portalItem.itemUrl):null,messages:[],portal:this.portalItem.portal??Io.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),s=this.write({},i);return await Promise.all(i.resources.pendingOperations),await this._verifySave(s,i,e),this._updateTypeKeywords(this.portalItem),await this.portalItem.update({data:s}),await Ree(this._resourceReferences,i,null),_ee(i),r&&await r,await this._saveThumbnail(),this.portalItem}async saveAs(e,r){return this._debouncedSaveOperations(k2.SAVE_AS,r,e)}async _saveAsImpl(e,r){var c;let i=tw.from(e);i||(se.getLogger(this.declaredClass).error("saveAs(portalItem): requires a portal item parameter"),await Promise.reject(new j("webscene:portal-item-required","saveAs requires a portal item to save to"))),i.id&&(i=i.clone(),i.id=null);const s=i.portal||Io.getDefault();await this._ensureLoadBeforeSave(),i.type=qU,i.portal=s;const n=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:s,portalItem:i,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),o=this.write({},n);await Promise.all(n.resources.pendingOperations),await this._verifySaveAs(o,n,r);const a=this.thumbnailUrl,l=!this._isOverridden("thumbnailUrl");return this._updateTypeKeywords(i),await s.signIn(),await((c=s.user)==null?void 0:c.addItem({item:i,folder:r&&r.folder,data:o})),await Ree(this._resourceReferences,n,null),this.portalItem=i,gz.prototype.read.call(this,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl&&lo(i.itemUrl)}),_ee(n),a&&(this.thumbnailUrl=l?fW(a,"w","8192"):a),n.portalItem=i,await this._saveThumbnail(),i}async _saveThumbnail(){var e;this._isOverridden("thumbnailUrl")&&(await((e=this.portalItem)==null?void 0:e.updateThumbnail({thumbnail:this.thumbnailUrl})),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}_verifySave(e,r,i,s=!1){var c;if(!BS(this.spatialReference))return Promise.reject(new j("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let n,o=((c=r.messages)==null?void 0:c.filter(h=>h.type==="error").map(h=>new j(h.name,h.message,h.details)))??[];r.blockedRelativeUrls&&(o=o.concat(r.blockedRelativeUrls.map(h=>new j("url:unsupported",`Relative url '${h}' is not supported in Web Scene`)))),i&&i.ignoreUnsupported&&(o=o.filter(h=>h.name!=="layer:unsupported"&&h.name!=="symbol:unsupported"&&h.name!=="symbol-layer:unsupported"&&h.name!=="property:unsupported"&&h.name!=="url:unsupported"&&h.name!=="scenemodification:unsupported")),i!=null&&i.requiredPropertyChecksDisabled&&(o=o.filter(h=>h.name!=="web-document-write:property-required"));const a=!!(i!=null&&i.strictSchemaValidationEnabled),l=N8e();return n=a&&l?l().then(h=>{const p=h.validate(e);if(p.length>0){const f=`webscene did not validate:
${p.join(`
`)}`;se.getLogger(this.declaredClass).error(`${s?"saveAs":"save"}(): ${f}`)}return p.map(f=>new j("webscene:schema-validation",f))}).then(h=>{if(h.length>0)throw xNe(h.concat(o));return o}):Promise.resolve(o),n.then(h=>{if(h.length>0)throw new j("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:h})})}_verifySaveAs(e,r,i){return this.canNotSaveAs(r)?Promise.reject(wNe()):this._verifySave(e,r,i,!0)}verifySaveAs(e){const r=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),i=this.write({},r);return this._verifySaveAs(i,r,e)}canNotSaveAs(e){var r,i;return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},e)),(((i=(r=e.verifyItemRelativeUrls)==null?void 0:r.writtenUrls)==null?void 0:i.length)??0)>0}async updateFrom(e,r={}){const i=this._updateFrom(e,r);this._updateFromPromise=i,await i,this._updateFromPromise===i&&(this._updateFromPromise=null)}async _updateFrom(e,r={}){if(await e.whenReady(),!r.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=tE.prototype.clone.apply(e.environment)),!r.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,v(e.clippingArea)?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const i of e.allLayerViews){const s="visible";s in i&&s in i.layer&&i._isOverridden(s)&&(i.layer[s]=i[s])}(r.thumbnailExcluded===!1||r.thumbnailExcluded==null&&!r.viewpointExcluded)&&await this._updateFromThumbnail(e,r.thumbnailSize??void 0)}async _updateFromThumbnail(e,r){const i=INe(e,r),s=await e.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableDecorations:!0});this.thumbnailUrl=s.dataUrl}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,r){const i=this._validateJSON(e);return this.read(i,r),this._loadFromJSON(i,r)}_extractOperationalLayers(e){var n;const r=[];if(!((n=this.sourceVersion)!=null&&n.supportsGround)&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const o of e.baseMap.elevationLayers)r.push(o);const i=[],s=o=>{var a;return o.layers&&(o.layers=o.layers.filter(s)),o.layerType!=="ArcGISTiledElevationServiceLayer"||((a=this.sourceVersion)!=null&&a.supportsGround||i.push(o),!1)};return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(s):[],operationalElevationLayers:i,basemapElevationLayers:r}}_loadFromJSON(e,r){const i=new ft;return this._validateSpatialReference().then(()=>this._validateHeightModelInfo()).then(()=>ie(()=>import("./layersCreator-0c0184a0.js"),["./layersCreator-0c0184a0.js","./lazyLayerLoader-de1ad940.js","./portalLayers-adce7908.js","./layersLoader-9600ea66.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url)).then(({populateOperationalLayers:s})=>{const{operationalLayers:n,operationalElevationLayers:o,basemapElevationLayers:a}=this._extractOperationalLayers(e),l=[],c={context:{...r,layerContainerType:"operational-layers"}};if(this.portalItem&&(c.context.portal=this.portalItem.portal||Io.getDefault()),a.length>0){const h={...c,context:{...c.context,layerContainerType:"ground"}};h.defaultLayerType="ArcGISTiledElevationServiceLayer",l.push(s(this.ground.layers,a,h))}if(o.length>0){const h={...c,context:{...c.context,layerContainerType:"ground"}};h.defaultLayerType="ArcGISTiledElevationServiceLayer",l.push(s(i,o,h))}return n&&n.length>0&&l.push(s(this.layers,n,c)),co(l).then(()=>{})}).then(()=>this._loadObjectsWithLayers()).then(()=>{this.ground.layers.addMany(i)})}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[];for(const r of this.allLayers.items)if("beforeSave"in r&&typeof r.beforeSave=="function"){const i=r.beforeSave();i&&e.push(i)}await co(e)}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach(r=>{r.basemap&&e.push(r.basemap.load())}),await co(e)}async _loadFromItem(e){if(await e.load().catch(s=>{throw new j("webscene:load-portal-item","Failed to load portal item",{error:s})}),e.type!=="Web Scene")throw new j("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const r=await e.fetchData();this.resourceInfo=r;const i={origin:"web-scene",url:lo(e.itemUrl),portal:e.portal||Io.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(r,i),this._resourceReferences={portalItem:e,paths:i.readResourcePaths??[]}}_validateSpatialReference(){const e=this.initialViewProperties,r=this._sceneSpatialReference;let i;if(e.viewingMode!=="local"){if(!eE(r,Be.Global))return Promise.reject(new j("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:r,viewingMode:e.viewingMode}));i=l=>!l||rv(l,r)}else{if(!eE(r,Be.Local))return Promise.reject(new j("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:r,viewingMode:e.viewingMode}));i=l=>!l||l.equals(r)}const s=l=>{var c,h;return((c=l==null?void 0:l.camera)==null?void 0:c.position.spatialReference)??((h=l==null?void 0:l.targetGeometry)==null?void 0:h.spatialReference)},n=e.viewpoint,o=s(n);if(o&&!i(o))return Promise.reject(new j("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:o,sceneSpatialReference:r,viewingMode:e.viewingMode}));const a=this.presentation.slides.find(l=>!i(s(l.viewpoint)));if(a){const l=s(a.viewpoint);return Promise.reject(new j("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:l,sceneSpatialReference:r,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,r=uNe(this.heightModelInfo,e);return r?Promise.reject(r):Promise.resolve()}_validateJSON(e){const r=SF.parse(e.version||"","webscene");return cw.validate(r),e.version=`${r.major}.${r.minor}`,r.major===1&&r.minor<=2&&(e.spatialReference=We.WebMercator.toJSON()),e}_updateTypeKeywords(e){this.initialViewProperties.viewingMode==="local"?e.typeKeywords?e.typeKeywords.includes(XP)||e.typeKeywords.push(XP):e.typeKeywords=[XP]:this.initialViewProperties.viewingMode==="global"&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(r=>r!==XP)),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((r,i,s)=>s.indexOf(r)===i))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||We.WebMercator}get _verifyItemRelativeRootPath(){var e;return(e=this.portalItem)!=null&&e.itemUrl?lo(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const r=this._verifyItemRelativeRootPath;return r&&(e.verifyItemRelativeUrls={rootPath:r,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout(()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()},3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,r=s=>this.allLayers.some(n=>n.id===s);e&&e.layers&&(e.layers=e.layers.filter(s=>r(s.id)));const i=this.presentation&&this.presentation.slides;i&&i.forEach(s=>{s.visibleLayers&&(s.visibleLayers=s.visibleLayers.filter(n=>r(n.id)))})}static fromJSON(e){if(!e)throw new j("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};var k2;fi.version=`${cw.major}.${cw.minor}`,u([d({type:VNe,json:{write:!0}})],fi.prototype,"applicationProperties",void 0),u([d({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],fi.prototype,"basemap",void 0),u([d({type:Hr,json:{read:{source:"clippingArea.geometry",reader:um},write:{target:"clippingArea.geometry"}}})],fi.prototype,"clippingArea",void 0),u([ke("clippingArea")],fi.prototype,"writeClippingArea",null),u([d({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],fi.prototype,"clippingEnabled",void 0),u([Le("clippingEnabled",["clippingArea"])],fi.prototype,"readClippingEnabled",null),u([ke("clippingEnabled")],fi.prototype,"writeClippingEnabled",null),u([d({type:_Ne,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],fi.prototype,"floorInfo",void 0),u([d({type:Tv,json:{write:!0}})],fi.prototype,"heightModelInfo",void 0),u([d({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],fi.prototype,"layers",void 0),u([ke("layers")],fi.prototype,"writeLayers",null),u([d({readOnly:!0,type:SF,json:{type:F8e(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],fi.prototype,"sourceVersion",void 0),u([Le("sourceVersion",["version"])],fi.prototype,"readSourceVersion",null),u([ke("sourceVersion")],fi.prototype,"writeSourceVersion",null),u([d({json:{read:!1,write:!1}})],fi.prototype,"tables",void 0),u([d()],fi.prototype,"thumbnailUrl",null),u([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],fi.prototype,"authoringApp",null),u([ke("authoringApp")],fi.prototype,"writeAuthoringApp",null),u([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],fi.prototype,"authoringAppVersion",null),u([ke("authoringAppVersion")],fi.prototype,"writeAuthoringAppVersion",null),u([d({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],fi.prototype,"ground",void 0),u([ke("ground")],fi.prototype,"writeGround",null),u([d({type:ft.ofType(L8e),json:{write:!0}})],fi.prototype,"transportationNetworks",void 0),u([d({type:T0e,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(t,e,r,i)=>{if(t.slides&&t.slides.length>0){const s={...i,isPresentation:!0};e.presentation=t.write({},s)}}}}})],fi.prototype,"presentation",void 0),u([d({type:nF,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new nF({viewingMode:"global",spatialReference:We.WebMercator})}})],fi.prototype,"initialViewProperties",void 0),u([Le("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],fi.prototype,"readInitialViewProperties",null),u([d({type:We,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],fi.prototype,"spatialReference",null),u([d({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],fi.prototype,"viewingMode",null),u([d({type:tw})],fi.prototype,"portalItem",void 0),u([d()],fi.prototype,"resourceInfo",void 0),fi=u([P("esri.WebScene")],fi),function(t){t[t.SAVE=0]="SAVE",t[t.SAVE_AS=1]="SAVE_AS"}(k2||(k2={}));const U8e=fi;function F5(t){return typeof t=="string"?document.getElementById(t):t??null}function S0e(t){for(;t.hasChildNodes();)t.removeChild(t.firstChild)}function wte(t,e){const r=e.parentNode;r&&r.insertBefore(t,e)}function xte(t,e){for(;;){const r=t.firstChild;if(!r)break;e.appendChild(r)}}let M7=class{constructor(e=r=>r.values().next().value){this._peeker=e,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}last(){if(this._items.size===0)return;let e;for(e of this._items);return e}peek(){if(this._items.size!==0)return this._peeker(this._items)}push(e){this.contains(e)||this._items.add(e)}contains(e){return this._items.has(e)}pop(){if(this.length===0)return;const e=this.peek();return this._items.delete(e),e}popLast(){if(this.length===0)return;const e=this.last();return this._items.delete(e),e}remove(e){this._items.delete(e)}filter(e){return this._items.forEach(r=>{e(r)||this._items.delete(r)}),this}};var Xo;(function(t){t[t.HANDSHAKE=0]="HANDSHAKE",t[t.OPEN=1]="OPEN",t[t.OPENED=2]="OPENED",t[t.RESPONSE=3]="RESPONSE",t[t.INVOKE=4]="INVOKE",t[t.ABORT=5]="ABORT",t[t.CLOSE=6]="CLOSE",t[t.OPEN_PORT=7]="OPEN_PORT",t[t.ON=8]="ON"})(Xo||(Xo={}));let V8e=0;function E0e(){return V8e++}function k8e(t){return t&&typeof t=="object"&&("result"in t||"transferList"in t)}function T3(t){return t?typeof t=="string"?JSON.stringify({name:"message",message:t}):t.toJSON?JSON.stringify(t):JSON.stringify({name:t.name,message:t.message,details:t.details||{stack:t.stack}}):null}function OY(t,e,r,i){if(e.type===Xo.OPEN_PORT)return void t.postMessage(e,[e.port]);if(e.type!==Xo.INVOKE&&e.type!==Xo.RESPONSE)return void t.postMessage(e);let s;if(k8e(r)?(s=Tte(r.transferList),e.data=r.result):(s=Tte(i),e.data=r),s){if(de("ff")){for(const n of s)if("byteLength"in n&&n.byteLength>267386880){const o="Worker call with large ArrayBuffer would crash Firefox";switch(e.type){case Xo.INVOKE:throw o;case Xo.RESPONSE:return void OY(t,{type:Xo.RESPONSE,jobId:e.jobId,error:T3(o)})}}}t.postMessage(e,s)}else t.postMessage(e)}function S3(t){if(!t)return null;const e=t.data;return e?typeof e=="string"?JSON.parse(e):e:null}function Tte(t){if(!t||!t.length)return null;if(de("esri-workers-arraybuffer-transfer"))return t;const e=t.filter(r=>!z8e(r));return e.length?e:null}function z8e(t){return t instanceof ArrayBuffer||t&&t.constructor&&t.constructor.name==="ArrayBuffer"}const B8e={statsWorker:()=>ie(()=>import("./statsWorker-9288c5cd.js"),["./statsWorker-9288c5cd.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js"],import.meta.url),geometryEngineWorker:()=>ie(()=>import("./geometryEngineWorker-8a57eda3.js"),["./geometryEngineWorker-8a57eda3.js","./geometryEngineJSON-3f330436.js","./geometryEngineBase-e1a33b0a.js","./json-48e3ea08.js"],import.meta.url),CSVSourceWorker:()=>ie(()=>import("./CSVSourceWorker-95ac76c1.js"),["./CSVSourceWorker-95ac76c1.js","./json-48e3ea08.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./QueryEngine-784c28ef.js","./QueryEngineCapabilities-42e44ded.js","./number-01f3944a.js","./clientSideDefaults-f782f4b2.js"],import.meta.url),EdgeProcessingWorker:()=>ie(()=>import("./EdgeProcessingWorker-e495272f.js"),[],import.meta.url),ElevationSamplerWorker:()=>ie(()=>import("./ElevationSamplerWorker-3ac4fe78.js"),["./ElevationSamplerWorker-3ac4fe78.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./georeference-a830443c.js"],import.meta.url),FeatureServiceSnappingSourceWorker:()=>ie(()=>import("./FeatureServiceSnappingSourceWorker-23600cd6.js"),["./FeatureServiceSnappingSourceWorker-23600cd6.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngine-784c28ef.js","./QueryEngineCapabilities-42e44ded.js","./symbologySnappingCandidates-77ca3418.js"],import.meta.url),GeoJSONSourceWorker:()=>ie(()=>import("./GeoJSONSourceWorker-065036d1.js"),["./GeoJSONSourceWorker-065036d1.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngine-784c28ef.js","./QueryEngineCapabilities-42e44ded.js","./geojson-55ba829b.js","./clientSideDefaults-f782f4b2.js","./sourceUtils-23d0b241.js"],import.meta.url),LercWorker:()=>ie(()=>import("./LercWorker-b7b882a2.js"),[],import.meta.url),MemorySourceWorker:()=>ie(()=>import("./MemorySourceWorker-5cd33ecf.js"),["./MemorySourceWorker-5cd33ecf.js","./objectIdUtils-789e911a.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngine-784c28ef.js","./QueryEngineCapabilities-42e44ded.js","./clientSideDefaults-f782f4b2.js","./sourceUtils-23d0b241.js"],import.meta.url),PBFDecoderWorker:()=>ie(()=>import("./PBFDecoderWorker-33ce36b5.js"),[],import.meta.url),Pipeline:()=>ie(()=>import("./Pipeline-a1253ec9.js").then(t=>t.P),["./Pipeline-a1253ec9.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./StreamFeatureManager-b8c144f8.js","./quickselect-56c5966e.js","./arcadeTimeUtils-486f1fea.js","./centroid-57d0b643.js","./ogcFeatureUtils-8d14f804.js","./geojson-55ba829b.js","./clientSideDefaults-f782f4b2.js","./createConnection-292048b8.js","./enums-c655c737.js","./TileInfoView-9eeb1a4a.js","./number-b10bd8f5.js"],import.meta.url),PointCloudWorker:()=>ie(()=>import("./PointCloudWorker-92326cee.js"),["./PointCloudWorker-92326cee.js","./PointCloudWorkerUtil-ffa21555.js","./PointCloudUniqueValueRenderer-a7b43d4e.js","./I3SBinaryReader-9bc79bf8.js"],import.meta.url),RasterWorker:()=>ie(()=>import("./RasterWorker-cb149ea6.js"),["./RasterWorker-cb149ea6.js","./dataUtils-feefe27b.js","./colorUtils-c0f43caf.js","./utils-b9f72319.js","./rasterProjectionHelper-e9780e55.js"],import.meta.url),SceneLayerSnappingSourceWorker:()=>ie(()=>import("./SceneLayerSnappingSourceWorker-91cdea9c.js"),["./SceneLayerSnappingSourceWorker-91cdea9c.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js"],import.meta.url),SceneLayerWorker:()=>ie(()=>import("./SceneLayerWorker-3c694ac0.js").then(t=>t.S),["./SceneLayerWorker-3c694ac0.js","./I3SNode-3c21486f.js"],import.meta.url),WFSSourceWorker:()=>ie(()=>import("./WFSSourceWorker-e0c8a158.js"),["./WFSSourceWorker-e0c8a158.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngine-784c28ef.js","./QueryEngineCapabilities-42e44ded.js","./geojson-55ba829b.js","./sourceUtils-23d0b241.js","./wfsUtils-9a717d66.js","./xmlUtils-444cb4c0.js"],import.meta.url),WorkerTileHandler:()=>ie(()=>import("./WorkerTileHandler-ebb5f097.js"),["./WorkerTileHandler-ebb5f097.js","./TileClipper-ae6eca9e.js","./StyleRepository-b88ac024.js","./enums-c655c737.js","./colorUtils-c0f43caf.js","./Rect-98da58d6.js","./TurboLine-b9a54344.js","./BidiEngine-836b7ef6.js"],import.meta.url)},{CLOSE:Ste,ABORT:Ete,INVOKE:Cte,RESPONSE:IC,OPEN_PORT:Ate,ON:G8e}=Xo,j8e=2;let H8e=class{constructor(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}push(e){e.type===Xo.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}},av=class HT{static connect(e){const r=new MessageChannel;let i;i=typeof e=="function"?new e:"default"in e&&typeof e.default=="function"?new e.default:e;const s=new HT(r.port1,{channel:r,client:i},()=>null);return typeof i=="object"&&"remoteClient"in i&&(i.remoteClient=s),HT.clients.set(s,i),r.port2}static loadWorker(e){const r=B8e[e];return r?r():Promise.resolve(null)}constructor(e,r,i){this._port=e,this._getNextJob=i,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new H8e(s=>this._onInvokeMessage(s)),this._client=r.client,this._onMessage=this._onMessage.bind(this),this._channel=r.channel,this._schedule=r.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}close(){this._post({type:Ste}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,r,i){const s=i&&i.signal,n=i&&i.transferList;if(!this._port)return Promise.reject(new j("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:r}));const o=E0e();return new Promise((a,l)=>{if(Fn(s))return this._processWork(),void l(qr());const c=ba(s,()=>{const p=this._outJobs.get(o);p&&(this._outJobs.delete(o),this._processWork(),Vi(p.abortHandle),this._post({type:Ete,jobId:o}),l(qr()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:e};this._outJobs.set(o,h),this._post({type:Cte,jobId:o,methodName:e,abortable:s!=null},r,n)})}on(e,r){const i=new MessageChannel;function s(n){r(n.data)}return this._port.postMessage({type:Xo.ON,eventType:e,port:i.port2},[i.port2]),i.port1.addEventListener("message",s),i.port1.start(),{remove(){i.port1.postMessage({type:Xo.CLOSE}),i.port1.close(),i.port1.removeEventListener("message",s)}}}jobAdded(){this._processWork()}openPort(){const e=new MessageChannel;return this._post({type:Ate,port:e.port2}),e.port1}_processWork(){if(this._outJobs.size>=j8e)return;const e=this._getNextJob();if(!e)return;const{methodName:r,data:i,invokeOptions:s,deferred:n}=e;this.invoke(r,i,s).then(o=>n.resolve(o)).catch(o=>n.reject(o))}_close(){this._channel&&(this._channel=void 0),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(e=>{Vi(e.abortHandle),e.reject(qr(`Worker closing, aborting job calling '${e.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null}_onMessage(e){v(this._schedule)?this._schedule(()=>this._processMessage(e)):this._processMessage(e)}_processMessage(e){const r=S3(e);if(r)switch(r.type){case IC:this._onResponseMessage(r);break;case Cte:this._invokeQueue.push(r);break;case Ete:this._onAbortMessage(r);break;case Ste:this._onCloseMessage();break;case Ate:this._onOpenPortMessage(r);break;case G8e:this._onOnMessage(r)}}_onAbortMessage(e){const r=this._inJobs,i=e.jobId,s=r.get(i);this._invokeQueue.push(e),s&&(s.controller&&s.controller.abort(),r.delete(i))}_onCloseMessage(){const e=this._client;this._close(),e&&"destroy"in e&&HT.clients.get(this)===e&&e.destroy(),HT.clients.delete(this),e&&e.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){const{methodName:r,jobId:i,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[r];try{if(!h&&r&&r.includes(".")){const p=r.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${r} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:IC,jobId:i,error:T3(p)})}Gu(l)?(a.set(i,{controller:o,promise:l}),l.then(p=>{a.has(i)&&(a.delete(i),this._post({type:IC,jobId:i},p))},p=>{a.has(i)&&(a.delete(i),Ks(p)||this._post({type:IC,jobId:i,error:T3(p||{message:`Error encountered at method ${r}`})}))})):this._post({type:IC,jobId:i},l)}_onOpenPortMessage(e){new HT(e.port,{client:this._client},()=>null)}_onOnMessage(e){const{port:r}=e,i=this._client.on(e.eventType,n=>{r.postMessage(n)}),s=wM(e.port,"message",n=>{var o;((o=S3(n))==null?void 0:o.type)===Xo.CLOSE&&(s.remove(),i.remove(),r.close())})}_onResponseMessage(e){const{jobId:r,error:i,data:s}=e,n=this._outJobs;if(!n.has(r))return;const o=n.get(r);n.delete(r),this._processWork(),Vi(o.abortHandle),i?o.reject(j.fromJSON(JSON.parse(i))):o.resolve(s)}_post(e,r,i){return OY(this._port,e,r,i)}};av.kernelInfo={revision:sde,version:mW,buildDate:ide},av.clients=new Map;let q8e=class{constructor(){this._inUseClients=new Array,this._clients=new Array,this._clientPromises=new Array,this._ongoingJobsQueue=new M7}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(e,r){return new Promise((i,s)=>{let n=!0;const o=a=>{ur(r.signal),n&&(n=!1,a())};this._clients.length=e.length,this._clientPromises.length=e.length,this._inUseClients.length=e.length;for(let a=0;a<e.length;++a){const l=e[a];Gu(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new av(c,r,()=>this._ongoingJobsQueue.pop()??null),o(i),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new av(l,r,()=>this._ongoingJobsQueue.pop()??null),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(i))}})}broadcast(e,r,i){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a==null?void 0:a.invoke(e,r,i))}return s}close(){let e;for(;e=this._ongoingJobsQueue.pop();)e.deferred.reject(qr(`Worker closing, aborting job calling '${e.methodName}'`));for(const r of this._clientPromises)r.then(i=>i==null?void 0:i.close());this._clients.length=0,this._clientPromises.length=0}invoke(e,r,i){let s;Array.isArray(i)?(se.getLogger("esri.core.workers.Connection").warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:i}):s=i;const n=J_();this._ongoingJobsQueue.push({methodName:e,data:r,invokeOptions:s,deferred:n});for(let o=0;o<this._clientPromises.length;o++){const a=this._clients[o];a?a.jobAdded():this._clientPromises[o].then(l=>l==null?void 0:l.jobAdded())}return n.promise}on(e,r){return Promise.all(this._clientPromises).then(()=>US(this._clients.map(i=>i.on(e,r))))}openPorts(){return new Promise(e=>{const r=new Array(this._clientPromises.length);let i=r.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{n&&(r[s]=n.openPort()),--i==0&&e(r)})})}get test(){return{numClients:this._clients.length}}};const C0e=se.getLogger("esri.intl.substitute");function Of(t,e,r={}){const{format:i={}}=r;return om(t,s=>W8e(s,e,i))}function W8e(t,e,r){let i,s;const n=t.indexOf(":");if(n===-1?i=t.trim():(i=t.slice(0,n).trim(),s=t.slice(n+1).trim()),!i)return"";const o=yM(i,e);if(o==null)return"";const a=(s?r==null?void 0:r[s]:null)??(r==null?void 0:r[i]);return a?X8e(o,a):s?Y8e(o,s):MY(o)}function X8e(t,e){switch(e.type){case"date":return pm(t,e.intlOptions);case"number":return fm(t,e.intlOptions);default:return C0e.warn("missing format descriptor for key {key}"),MY(t)}}function Y8e(t,e){switch(e.toLowerCase()){case"dateformat":return pm(t);case"numberformat":return fm(t);default:return C0e.warn(`inline format is unsupported since 4.12: ${e}`),/^(dateformat|datestring)/i.test(e)?pm(t):/^numberformat/i.test(e)?fm(t):MY(t)}}function MY(t){switch(typeof t){case"string":return t;case"number":return fm(t);case"boolean":return""+t;default:return t instanceof Date?pm(t):""}}async function Z8e(t,e,r,i){const s=e.exec(r);if(!s)throw new j("esri-intl:invalid-bundle",`Bundle id "${r}" is not compatible with the pattern "${e}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=u$e(i),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await Rte(t(c))}catch(p){if(c===l)throw new j("intl:unknown-bundle",`Bundle "${r}" cannot be loaded`,{error:p});try{h=await Rte(t(l))}catch(f){throw new j("intl:unknown-bundle",`Bundle "${r}" cannot be loaded`,{error:f})}}return h}async function Rte(t){if(v(Ote.fetchBundleAsset))return Ote.fetchBundleAsset(t);const e=await Pi(t,{responseType:"text"});return JSON.parse(e.data)}let J8e=class{constructor({base:e="",pattern:r,location:i=new URL(window.location.href)}){let s;s=typeof i=="string"?n=>new URL(n,new URL(i,window.location.href)).href:i instanceof URL?n=>new URL(n,i).href:i,this.pattern=typeof r=="string"?new RegExp(`^${r}`):r,this.getAssetUrl=s,e=e?e.endsWith("/")?e:e+"/":"",this.matcher=new RegExp(`^${e}(?:(.*)/)?(.*)$`)}fetchMessageBundle(e,r){return Z8e(this.getAssetUrl,this.matcher,e,r)}};function K8e(t){return new J8e(t)}const Ote={};c$e(K8e({pattern:"esri/",location:Kr}));const Q8e={};function e9e(t){const e={async:t.async,isDebug:t.isDebug,locale:t.locale,baseUrl:t.baseUrl,has:{...t.has},map:{...t.map},packages:t.packages&&t.packages.concat()||[],paths:{...t.paths}};return t.hasOwnProperty("async")||(e.async=!0),t.hasOwnProperty("isDebug")||(e.isDebug=!1),t.baseUrl||(e.baseUrl=Q8e.baseUrl),e}let t9e=class{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(r=>{this[r]=(...i)=>e[r](...i)})}},nD=class{constructor(){this._dispatcher=new t9e,this._workerPostMessage({type:Xo.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){VS(()=>{this._workerMessageHandler(new MessageEvent("message",{data:e}))})}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,r,i){this._dispatcher.addEventListener(e,r,i)}removeEventListener(e,r,i){this._dispatcher.removeEventListener(e,r,i)}_workerPostMessage(e){VS(()=>{this.dispatchEvent(new MessageEvent("message",{data:e}))})}async _workerMessageHandler(e){const r=S3(e);if(r&&r.type===Xo.OPEN){const{modulePath:i,jobId:s}=r;let n=await av.loadWorker(i);n||(n=await ie(()=>import(i),[],import.meta.url));const o=av.connect(n);this._workerPostMessage({type:Xo.OPENED,jobId:s,data:o})}}};const P7=se.getLogger("esri.core.workers.workerFactory"),{HANDSHAKE:r9e}=Xo,i9e='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,version:r}=configuration.kernelInfo,{revision:t,version:n}=e.kernelInfo;esriConfig.assetsPath!==esriConfig.defaultAssetsPath&&o!==t&&console.warn(`Version mismatch detected between ArcGIS API for JavaScript modules and assets. For more information visit https://bit.ly/3QnsuSo.\\nModules version: ${r}\\nAssets version: ${n}`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let n;function t(e){const o=n.connect(e);self.postMessage({type:2,jobId:r,data:o},[o])}"function"==typeof define&&define.amd?require([workerPath],(e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((e=>(n=e.default,checkWorkerRevision(n),n.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),n=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(n),n.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const i=outgoing.get(r);outgoing.delete(r),o.error?i.reject(JSON.parse(o.error)):i.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let YP,ZP;const Mte="Failed to create Worker. Fallback to execute module in main thread";async function s9e(){if(!de("esri-workers")||(de("mozilla"),0))return Pte(new nD);if(!YP&&!ZP)try{const e=i9e.split('"{CONFIGURATION}"').join(`'${n9e()}'`);YP=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}catch(e){ZP=e||{}}let t;if(YP)try{t=new Worker(YP,{name:"esri-worker-"+o9e++})}catch{P7.warn(Mte,ZP),t=new nD}else P7.warn(Mte,ZP),t=new nD;return Pte(t)}async function Pte(t){return new Promise(e=>{function r(s){const n=S3(s);n&&n.type===r9e&&(t.removeEventListener("message",r),t.removeEventListener("error",i),e(t))}function i(s){s.preventDefault(),t.removeEventListener("message",r),t.removeEventListener("error",i),P7.warn("Failed to create Worker. Fallback to execute module in main thread",s),(t=new nD).addEventListener("message",r),t.addEventListener("error",i)}t.addEventListener("message",r),t.addEventListener("error",i)})}function n9e(){let t;if(Qr.default!=null){const s={...Qr};delete s.default,t=JSON.parse(JSON.stringify(s))}else t=JSON.parse(JSON.stringify(Qr));t.assetsPath=Eu(t.assetsPath),t.defaultAssetsPath=t.defaultAssetsPath?Eu(t.defaultAssetsPath):void 0,t.request.interceptors=[],t.log.interceptors=[],t.locale=Vh(),t.has={"esri-csp-restrictions":de("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":de("esri-2d-update-debug"),"featurelayer-pbf":de("featurelayer-pbf"),"featurelayer-simplify-thresholds":de("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":de("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":de("featurelayer-simplify-mobile-factor"),"esri-atomics":de("esri-atomics"),"esri-shared-array-buffer":de("esri-shared-array-buffer"),"esri-tiles-debug":de("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":de("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":de("feature-polyline-generalization-factor"),"host-webworker":1,"polylabel-placement-enabled":de("polylabel-placement-enabled")},t.workers.loaderUrl&&(t.workers.loaderUrl=Eu(t.workers.loaderUrl)),t.workers.workerPath?t.workers.workerPath=Eu(t.workers.workerPath):t.workers.workerPath=Eu(Kr("esri/core/workers/RemoteClient.js")),t.workers.useDynamicImport=!1;const e=Qr.workers.loaderConfig,r=e9e({baseUrl:e==null?void 0:e.baseUrl,locale:Vh(),has:{"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1,...e==null?void 0:e.has},map:{...e==null?void 0:e.map},paths:{...e==null?void 0:e.paths},packages:(e==null?void 0:e.packages)||[]});return JSON.stringify({esriConfig:t,loaderConfig:r,kernelInfo:{version:mW,buildDate:ide,revision:sde}})}let o9e=0;const{ABORT:Ite,INVOKE:a9e,OPEN:l9e,OPENED:c9e,RESPONSE:$C}=Xo;let u9e=class A0e{static async create(e){const r=await s9e();return new A0e(r,e)}constructor(e,r){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=r,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",i=>{i.preventDefault(),se.getLogger("esri.core.workers.WorkerOwner").error(i)})}terminate(){this.worker.terminate()}async open(e,r={}){const{signal:i}=r,s=E0e();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:W4(i,()=>{this._outJobs.delete(s),this._post({type:Ite,jobId:s})})};this._outJobs.set(s,a),this._post({type:l9e,jobId:s,modulePath:e})})}_onMessage(e){const r=S3(e);if(r)switch(r.type){case c9e:this._onOpenedMessage(r);break;case $C:this._onResponseMessage(r);break;case Ite:this._onAbortMessage(r);break;case a9e:this._onInvokeMessage(r)}}_onAbortMessage(e){const r=this._inJobs,i=e.jobId,s=r.get(i);s&&(s.controller&&s.controller.abort(),r.delete(i))}_onInvokeMessage(e){const{methodName:r,jobId:i,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs,l=X3e[r];let c;try{if(typeof l!="function")throw new TypeError(`${r} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:$C,jobId:i,error:T3(h)})}Gu(c)?(a.set(i,{controller:o,promise:c}),c.then(h=>{a.has(i)&&(a.delete(i),this._post({type:$C,jobId:i},h))},h=>{a.has(i)&&(a.delete(i),h||(h={message:"Error encountered at method"+r}),Ks(h)||this._post({type:$C,jobId:i,error:T3(h||{message:`Error encountered at method ${r}`})}))})):this._post({type:$C,jobId:i},c)}_onOpenedMessage(e){const{jobId:r,data:i}=e,s=this._outJobs.get(r);s&&(this._outJobs.delete(r),Vi(s.abortHandle),s.resolve(i))}_onResponseMessage(e){const{jobId:r,error:i,data:s}=e,n=this._outJobs.get(r);n&&(this._outJobs.delete(r),Vi(n.abortHandle),i?n.reject(j.fromJSON(JSON.parse(i))):n.resolve(s))}_post(e,r,i){return OY(this.worker,e,r,i)}},Hb=de("esri-workers-debug")?1:de("esri-mobile")?Math.min(navigator.hardwareConcurrency-1,3):de("host-browser")?navigator.hardwareConcurrency-1:0;Hb||(Hb=de("safari")&&de("mac")?7:2);let $te=0;const oD=[];function h9e(){O0e()}async function JP(t,e){const r=new q8e;return await r.open(t,e),r}async function R0e(t,e={}){if(typeof t!="string")throw new j("workers:undefined-module","modulePath is missing");let r=e.strategy||"distributed";if(de("host-webworker")&&!de("esri-workers")&&(r="local"),r==="local"){let i=await av.loadWorker(t);i||(i=await ie(()=>import(t),[],import.meta.url)),ur(e.signal);const s=e.client||i;return JP([av.connect(i)],{...e,client:s})}if(await O0e(),ur(e.signal),r==="dedicated"){const i=$te++%Hb;return JP([await oD[i].open(t,e)],e)}if(e.maxNumWorkers&&e.maxNumWorkers>0){const i=Math.min(e.maxNumWorkers,Hb);if(i<Hb){const s=new Array(i);for(let n=0;n<i;++n){const o=$te++%Hb;s[n]=oD[o].open(t,e)}return JP(s,e)}}return JP(oD.map(i=>i.open(t,e)),e)}let KP=null;async function O0e(){if(KP)return KP;new AbortController;const t=[];for(let e=0;e<Hb;e++){const r=u9e.create(e).then(i=>(oD[e]=i,i));t.push(r)}return KP=Promise.all(t),KP}let em=class extends Te{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._handles=new Zr,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll(),this._handles.destroy()}add(e,r,i={}){return this._installWatch(e,r,i,ne)}addWhen(e,r,i={}){return this._installWatch(e,r,i,ra)}addOnCollectionChange(e,r,{initial:i=!1,final:s=!1}={}){const n=++this._handleId;return this._handles.add([an(e,"after-changes",this._createSyncUpdatingCallback(),ri),an(e,"change",r,{onListenerAdd:i?o=>r({added:o.toArray(),removed:[]}):void 0,onListenerRemove:s?o=>r({added:[],removed:o.toArray()}):void 0})],n),{remove:()=>this._handles.remove(n)}}addPromise(e){if(C(e))return e;const r=++this._handleId;this._handles.add({remove:()=>{this._pendingPromises.delete(e)&&(this._pendingPromises.size!==0||this._handles.has(QP)||this._set("updating",!1))}},r),this._pendingPromises.add(e),this._set("updating",!0);const i=()=>this._handles.remove(r);return e.then(i,i),e}removeAll(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)}_installWatch(e,r,i={},s){const n=++this._handleId;i.sync||this._installSyncUpdatingWatch(e,n);const o=s(e,r,i);return this._handles.add(o,n),{remove:()=>this._handles.remove(n)}}_installSyncUpdatingWatch(e,r){const i=this._createSyncUpdatingCallback(),s=ne(e,i,{sync:!0,equals:()=>!1});return this._handles.add(s,r),s}_createSyncUpdatingCallback(){return()=>{this._handles.remove(QP),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this._handles.add(VE(()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this._handles.remove(QP))}),QP)}}};u([d({readOnly:!0})],em.prototype,"updating",void 0),em=u([P("esri.core.support.WatchUpdatingTracking")],em);const QP=-42,ux=t=>{let e=class extends t{destroy(){var r,i;this.destroyed||((r=this._get("handles"))==null||r.destroy(),(i=this._get("updatingHandles"))==null||i.destroy())}get handles(){return this._get("handles")||new Zr}get updatingHandles(){return this._get("updatingHandles")||new em}};return u([d({readOnly:!0})],e.prototype,"handles",null),u([d({readOnly:!0})],e.prototype,"updatingHandles",null),e=u([P("esri.core.HandleOwner")],e),e};let E3=class extends ux(Te){};E3=u([P("esri.core.HandleOwner")],E3);let vO=class extends ux(ft){constructor(e){super(e),this.handles.add([this.on("before-add",r=>{C(r.item)&&r.preventDefault()}),this.on("after-add",r=>this._own(r.item)),this.on("after-remove",r=>this._release(r.item))])}get owner(){return this._get("owner")}set owner(e){e!==this._get("owner")&&(this._releaseAll(),this._set("owner",e),this._ownAll())}_ownAll(){for(const e of this.items)this._own(e)}_releaseAll(){for(const e of this.items)this._release(e)}_createNewInstance(e){return this.itemType?new(ft.ofType(this.itemType.Type))(e):new ft(e)}};function I7(t,e){return{type:t,cast:RW,set(r){const i=sy(r,this._get(e),t);i.owner=this,this._set(e,i)}}}u([d()],vO.prototype,"owner",null),vO=u([P("esri.core.support.OwningCollection")],vO);const d9e=new We(npe),Lte=new We(FW),Dte=new We(UW),OCt=new We(ope);function U5(t){return t&&(wm(t)||Cn(t,Lte))?Lte:t&&(xm(t)||Cn(t,Dte))?Dte:d9e}function p9e(t){const{value:e,operations:r}=t;return{operations:r,value:r.create(e)}}function f9e(t,e,r){return t.operations.setExtent(t.value,e,r.value),r}function m9e(t){return{operations:t,value:t.create()}}function M0e(t,e,r=m9e(t)){return r.operations=t,t.copy(e,r.value),r}function g9e(t){return M0e(n6e,pye(0,0,0,Yr(t).radius))}const Nte=2**50;function y9e(){return M0e(B6e,cY([0,0,0],[Nte,0,0],[0,Nte,0]))}function _9e(t,e,r){return t.operations.axisAt(t.value,e,Pc.Z,r)}function v9e(t,e,r,i){return t.operations.axisAt(t.value,e,r,i)}function b9e(t,e,r){return t.operations.intersectRay(t.value,e,r)}function w9e(t,e,r){return t.operations.intersectRayClosestSilhouette(t.value,e,r)}function x9e(t,e){return t.operations.altitudeAt(t.value,e)}function P0e(t,e,r,i){return t.operations.setAltitudeAt(t.value,e,r,i)}function T9e(t,e,r,i){return e!==i&&kn(i,e),ce(Sx,i[12],i[13],i[14]),P0e(t,Sx,r,Sx),i[12]=Sx[0],i[13]=Sx[1],i[14]=Sx[2],i}function WU(t,e,r){return t.operations.elevate(t.value,e,r.value)}const Sx=M();function Fte(t,e,r,i,s){return s[0]=_e(t,e),s[1]=_e(t,r),s[2]=_e(t,i),s}function $7(t,e,r,i,s){le(r,t),le(eI,e),ve(eI,eI),pt(i,eI,r),pt(s,i,r)}function I0e(t,e){return t?U5(e):e.isGeographic?We.PlateCarree:e}const eI=M(),$0e="OBJECTID";let gE=class extends vO{constructor(e){super(e),this.handles.add(this.on("before-add",r=>{C(r.item)||r.item.parent===this.owner&&(se.getLogger(this.declaredClass).warn("Analysis inside the collection must be unique. Not adding this element again."),r.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};gE=u([P("esri.support.AnalysesCollection")],gE);const aD={widthBreakpoint:{getValue(t){const e=t.viewSize[0],r=t.breakpoints,i=this.values;return e<=r.xsmall?i.xsmall:e<=r.small?i.small:e<=r.medium?i.medium:e<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(t){const e=t.viewSize[1],r=t.breakpoints,i=this.values;return e<=r.xsmall?i.xsmall:e<=r.small?i.small:e<=r.medium?i.medium:e<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(t){const e=t.viewSize,r=e[0],i=e[1],s=this.values;return i>=r?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},XU={xsmall:544,small:768,medium:992,large:1200};function S9e(t){const e=t;return e&&e.xsmall<e.small&&e.small<e.medium&&e.medium<e.large}function YU(t,e){return e?aD[t].valueToClassName[e].split(" "):[]}const E9e=t=>{let e=class extends t{constructor(...r){super(...r),this._breakpointsHandles=new Zr,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=XU}initialize(){this._breakpointsHandles.add(ne(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),kt))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=Ve(this._breakpointsHandles))}set breakpoints(r){if(r===this._get("breakpoints"))return;const i=S9e(r);if(!i){const s=JSON.stringify(XU,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}r=i?r:XU,this._set("breakpoints",{...r})}_updateClassNames(){if(!this.container)return;const r=Tc.acquire(),i=Tc.acquire();let s,n=!1;for(s in aD){const o=this[s],a=aD[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,YU(s,o).forEach(l=>i.push(l)),YU(s,a).forEach(l=>r.push(l)))}n&&(this._applyClassNameChanges(r,i),Tc.release(r),Tc.release(i))}_applyClassNameChanges(r,i){const s=this.container;s&&(i.forEach(n=>s.classList.remove(n)),r.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const r=this.container;if(!r)return;let i;for(i in aD)YU(i,this[i]).forEach(s=>r.classList.remove(s))}};return u([d()],e.prototype,"breakpoints",null),u([d()],e.prototype,"orientation",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),u([d()],e.prototype,"heightBreakpoint",void 0),e=u([P("esri.views.BreakpointsOwner")],e),e};/*!
 * @esri/arcgis-html-sanitizer - v3.0.1 - Tue Nov 15 2022 09:46:54 GMT-0800 (Pacific Standard Time)
 * Copyright (c) 2022 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2018 Zongmin Lei() <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 */var C9e=function(t){if(typeof t!="object"||t===null||Object.prototype.toString.call(t)!=="[object Object]")return!1;var e=Object.getPrototypeOf(t);if(e===null)return!0;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e},Ob={exports:{}},un={},C3={exports:{}},hx={};function L0e(){var t={};return t["align-content"]=!1,t["align-items"]=!1,t["align-self"]=!1,t["alignment-adjust"]=!1,t["alignment-baseline"]=!1,t.all=!1,t["anchor-point"]=!1,t.animation=!1,t["animation-delay"]=!1,t["animation-direction"]=!1,t["animation-duration"]=!1,t["animation-fill-mode"]=!1,t["animation-iteration-count"]=!1,t["animation-name"]=!1,t["animation-play-state"]=!1,t["animation-timing-function"]=!1,t.azimuth=!1,t["backface-visibility"]=!1,t.background=!0,t["background-attachment"]=!0,t["background-clip"]=!0,t["background-color"]=!0,t["background-image"]=!0,t["background-origin"]=!0,t["background-position"]=!0,t["background-repeat"]=!0,t["background-size"]=!0,t["baseline-shift"]=!1,t.binding=!1,t.bleed=!1,t["bookmark-label"]=!1,t["bookmark-level"]=!1,t["bookmark-state"]=!1,t.border=!0,t["border-bottom"]=!0,t["border-bottom-color"]=!0,t["border-bottom-left-radius"]=!0,t["border-bottom-right-radius"]=!0,t["border-bottom-style"]=!0,t["border-bottom-width"]=!0,t["border-collapse"]=!0,t["border-color"]=!0,t["border-image"]=!0,t["border-image-outset"]=!0,t["border-image-repeat"]=!0,t["border-image-slice"]=!0,t["border-image-source"]=!0,t["border-image-width"]=!0,t["border-left"]=!0,t["border-left-color"]=!0,t["border-left-style"]=!0,t["border-left-width"]=!0,t["border-radius"]=!0,t["border-right"]=!0,t["border-right-color"]=!0,t["border-right-style"]=!0,t["border-right-width"]=!0,t["border-spacing"]=!0,t["border-style"]=!0,t["border-top"]=!0,t["border-top-color"]=!0,t["border-top-left-radius"]=!0,t["border-top-right-radius"]=!0,t["border-top-style"]=!0,t["border-top-width"]=!0,t["border-width"]=!0,t.bottom=!1,t["box-decoration-break"]=!0,t["box-shadow"]=!0,t["box-sizing"]=!0,t["box-snap"]=!0,t["box-suppress"]=!0,t["break-after"]=!0,t["break-before"]=!0,t["break-inside"]=!0,t["caption-side"]=!1,t.chains=!1,t.clear=!0,t.clip=!1,t["clip-path"]=!1,t["clip-rule"]=!1,t.color=!0,t["color-interpolation-filters"]=!0,t["column-count"]=!1,t["column-fill"]=!1,t["column-gap"]=!1,t["column-rule"]=!1,t["column-rule-color"]=!1,t["column-rule-style"]=!1,t["column-rule-width"]=!1,t["column-span"]=!1,t["column-width"]=!1,t.columns=!1,t.contain=!1,t.content=!1,t["counter-increment"]=!1,t["counter-reset"]=!1,t["counter-set"]=!1,t.crop=!1,t.cue=!1,t["cue-after"]=!1,t["cue-before"]=!1,t.cursor=!1,t.direction=!1,t.display=!0,t["display-inside"]=!0,t["display-list"]=!0,t["display-outside"]=!0,t["dominant-baseline"]=!1,t.elevation=!1,t["empty-cells"]=!1,t.filter=!1,t.flex=!1,t["flex-basis"]=!1,t["flex-direction"]=!1,t["flex-flow"]=!1,t["flex-grow"]=!1,t["flex-shrink"]=!1,t["flex-wrap"]=!1,t.float=!1,t["float-offset"]=!1,t["flood-color"]=!1,t["flood-opacity"]=!1,t["flow-from"]=!1,t["flow-into"]=!1,t.font=!0,t["font-family"]=!0,t["font-feature-settings"]=!0,t["font-kerning"]=!0,t["font-language-override"]=!0,t["font-size"]=!0,t["font-size-adjust"]=!0,t["font-stretch"]=!0,t["font-style"]=!0,t["font-synthesis"]=!0,t["font-variant"]=!0,t["font-variant-alternates"]=!0,t["font-variant-caps"]=!0,t["font-variant-east-asian"]=!0,t["font-variant-ligatures"]=!0,t["font-variant-numeric"]=!0,t["font-variant-position"]=!0,t["font-weight"]=!0,t.grid=!1,t["grid-area"]=!1,t["grid-auto-columns"]=!1,t["grid-auto-flow"]=!1,t["grid-auto-rows"]=!1,t["grid-column"]=!1,t["grid-column-end"]=!1,t["grid-column-start"]=!1,t["grid-row"]=!1,t["grid-row-end"]=!1,t["grid-row-start"]=!1,t["grid-template"]=!1,t["grid-template-areas"]=!1,t["grid-template-columns"]=!1,t["grid-template-rows"]=!1,t["hanging-punctuation"]=!1,t.height=!0,t.hyphens=!1,t.icon=!1,t["image-orientation"]=!1,t["image-resolution"]=!1,t["ime-mode"]=!1,t["initial-letters"]=!1,t["inline-box-align"]=!1,t["justify-content"]=!1,t["justify-items"]=!1,t["justify-self"]=!1,t.left=!1,t["letter-spacing"]=!0,t["lighting-color"]=!0,t["line-box-contain"]=!1,t["line-break"]=!1,t["line-grid"]=!1,t["line-height"]=!1,t["line-snap"]=!1,t["line-stacking"]=!1,t["line-stacking-ruby"]=!1,t["line-stacking-shift"]=!1,t["line-stacking-strategy"]=!1,t["list-style"]=!0,t["list-style-image"]=!0,t["list-style-position"]=!0,t["list-style-type"]=!0,t.margin=!0,t["margin-bottom"]=!0,t["margin-left"]=!0,t["margin-right"]=!0,t["margin-top"]=!0,t["marker-offset"]=!1,t["marker-side"]=!1,t.marks=!1,t.mask=!1,t["mask-box"]=!1,t["mask-box-outset"]=!1,t["mask-box-repeat"]=!1,t["mask-box-slice"]=!1,t["mask-box-source"]=!1,t["mask-box-width"]=!1,t["mask-clip"]=!1,t["mask-image"]=!1,t["mask-origin"]=!1,t["mask-position"]=!1,t["mask-repeat"]=!1,t["mask-size"]=!1,t["mask-source-type"]=!1,t["mask-type"]=!1,t["max-height"]=!0,t["max-lines"]=!1,t["max-width"]=!0,t["min-height"]=!0,t["min-width"]=!0,t["move-to"]=!1,t["nav-down"]=!1,t["nav-index"]=!1,t["nav-left"]=!1,t["nav-right"]=!1,t["nav-up"]=!1,t["object-fit"]=!1,t["object-position"]=!1,t.opacity=!1,t.order=!1,t.orphans=!1,t.outline=!1,t["outline-color"]=!1,t["outline-offset"]=!1,t["outline-style"]=!1,t["outline-width"]=!1,t.overflow=!1,t["overflow-wrap"]=!1,t["overflow-x"]=!1,t["overflow-y"]=!1,t.padding=!0,t["padding-bottom"]=!0,t["padding-left"]=!0,t["padding-right"]=!0,t["padding-top"]=!0,t.page=!1,t["page-break-after"]=!1,t["page-break-before"]=!1,t["page-break-inside"]=!1,t["page-policy"]=!1,t.pause=!1,t["pause-after"]=!1,t["pause-before"]=!1,t.perspective=!1,t["perspective-origin"]=!1,t.pitch=!1,t["pitch-range"]=!1,t["play-during"]=!1,t.position=!1,t["presentation-level"]=!1,t.quotes=!1,t["region-fragment"]=!1,t.resize=!1,t.rest=!1,t["rest-after"]=!1,t["rest-before"]=!1,t.richness=!1,t.right=!1,t.rotation=!1,t["rotation-point"]=!1,t["ruby-align"]=!1,t["ruby-merge"]=!1,t["ruby-position"]=!1,t["shape-image-threshold"]=!1,t["shape-outside"]=!1,t["shape-margin"]=!1,t.size=!1,t.speak=!1,t["speak-as"]=!1,t["speak-header"]=!1,t["speak-numeral"]=!1,t["speak-punctuation"]=!1,t["speech-rate"]=!1,t.stress=!1,t["string-set"]=!1,t["tab-size"]=!1,t["table-layout"]=!1,t["text-align"]=!0,t["text-align-last"]=!0,t["text-combine-upright"]=!0,t["text-decoration"]=!0,t["text-decoration-color"]=!0,t["text-decoration-line"]=!0,t["text-decoration-skip"]=!0,t["text-decoration-style"]=!0,t["text-emphasis"]=!0,t["text-emphasis-color"]=!0,t["text-emphasis-position"]=!0,t["text-emphasis-style"]=!0,t["text-height"]=!0,t["text-indent"]=!0,t["text-justify"]=!0,t["text-orientation"]=!0,t["text-overflow"]=!0,t["text-shadow"]=!0,t["text-space-collapse"]=!0,t["text-transform"]=!0,t["text-underline-position"]=!0,t["text-wrap"]=!0,t.top=!1,t.transform=!1,t["transform-origin"]=!1,t["transform-style"]=!1,t.transition=!1,t["transition-delay"]=!1,t["transition-duration"]=!1,t["transition-property"]=!1,t["transition-timing-function"]=!1,t["unicode-bidi"]=!1,t["vertical-align"]=!1,t.visibility=!1,t["voice-balance"]=!1,t["voice-duration"]=!1,t["voice-family"]=!1,t["voice-pitch"]=!1,t["voice-range"]=!1,t["voice-rate"]=!1,t["voice-stress"]=!1,t["voice-volume"]=!1,t.volume=!1,t["white-space"]=!1,t.widows=!1,t.width=!0,t["will-change"]=!1,t["word-break"]=!0,t["word-spacing"]=!0,t["word-wrap"]=!0,t["wrap-flow"]=!1,t["wrap-through"]=!1,t["writing-mode"]=!1,t["z-index"]=!1,t}function A9e(t,e,r){}function R9e(t,e,r){}var O9e=/javascript\s*\:/img;function M9e(t,e){return O9e.test(e)?"":e}hx.whiteList=L0e();hx.getDefaultWhiteList=L0e;hx.onAttr=A9e;hx.onIgnoreAttr=R9e;hx.safeAttrValue=M9e;var P9e={indexOf:function(t,e){var r,i;if(Array.prototype.indexOf)return t.indexOf(e);for(r=0,i=t.length;r<i;r++)if(t[r]===e)return r;return-1},forEach:function(t,e,r){var i,s;if(Array.prototype.forEach)return t.forEach(e,r);for(i=0,s=t.length;i<s;i++)e.call(r,t[i],i,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(t){return String.prototype.trimRight?t.trimRight():t.replace(/(\s*$)/g,"")}},LC=P9e;function I9e(t,e){t=LC.trimRight(t),t[t.length-1]!==";"&&(t+=";");var r=t.length,i=!1,s=0,n=0,o="";function a(){if(!i){var h=LC.trim(t.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=LC.trim(h.slice(0,p)),m=LC.trim(h.slice(p+1));if(f){var y=e(s,o.length,f,m,h);y&&(o+=y+"; ")}}}s=n+1}for(;n<r;n++){var l=t[n];if(l==="/"&&t[n+1]==="*"){var c=t.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,i=!1}else l==="("?i=!0:l===")"?i=!1:l===";"?i||a():l===`
`&&a()}return LC.trim(o)}var $9e=I9e,tI=hx,L9e=$9e;function Ute(t){return t==null}function D9e(t){var e={};for(var r in t)e[r]=t[r];return e}function D0e(t){t=D9e(t||{}),t.whiteList=t.whiteList||tI.whiteList,t.onAttr=t.onAttr||tI.onAttr,t.onIgnoreAttr=t.onIgnoreAttr||tI.onIgnoreAttr,t.safeAttrValue=t.safeAttrValue||tI.safeAttrValue,this.options=t}D0e.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,r=e.options,i=r.whiteList,s=r.onAttr,n=r.onIgnoreAttr,o=r.safeAttrValue,a=L9e(t,function(l,c,h,p,f){var m=i[h],y=!1;if(m===!0?y=m:typeof m=="function"?y=m(p):m instanceof RegExp&&(y=m.test(p)),y!==!0&&(y=!1),p=o(h,p),!!p){var _={position:c,sourcePosition:l,source:f,isWhite:y};if(y){var b=s(h,p,_);return Ute(b)?h+":"+p:b}else{var b=n(h,p,_);if(!Ute(b))return b}}});return a};var N9e=D0e;(function(t,e){var r=hx,i=N9e;function s(o,a){var l=new i(a);return l.process(o)}e=t.exports=s,e.FilterCSS=i;for(var n in r)e[n]=r[n]})(C3,C3.exports);var PY={indexOf:function(t,e){var r,i;if(Array.prototype.indexOf)return t.indexOf(e);for(r=0,i=t.length;r<i;r++)if(t[r]===e)return r;return-1},forEach:function(t,e,r){var i,s;if(Array.prototype.forEach)return t.forEach(e,r);for(i=0,s=t.length;i<s;i++)e.call(r,t[i],i,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(t){var e=/\s|\n|\t/,r=e.exec(t);return r?r.index:-1}},F9e=C3.exports.FilterCSS,U9e=C3.exports.getDefaultWhiteList,EF=PY;function N0e(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var F0e=new F9e;function V9e(t,e,r){}function k9e(t,e,r){}function z9e(t,e,r){}function B9e(t,e,r){}function U0e(t){return t.replace(j9e,"&lt;").replace(H9e,"&gt;")}function G9e(t,e,r,i){if(r=j0e(r),e==="href"||e==="src"){if(r=EF.trim(r),r==="#")return"#";if(!(r.substr(0,7)==="http://"||r.substr(0,8)==="https://"||r.substr(0,7)==="mailto:"||r.substr(0,4)==="tel:"||r.substr(0,11)==="data:image/"||r.substr(0,6)==="ftp://"||r.substr(0,2)==="./"||r.substr(0,3)==="../"||r[0]==="#"||r[0]==="/"))return""}else if(e==="background"){if(rI.lastIndex=0,rI.test(r))return""}else if(e==="style"){if(Vte.lastIndex=0,Vte.test(r)||(kte.lastIndex=0,kte.test(r)&&(rI.lastIndex=0,rI.test(r))))return"";i!==!1&&(i=i||F0e,r=i.process(r))}return r=H0e(r),r}var j9e=/</g,H9e=/>/g,q9e=/"/g,W9e=/&quot;/g,X9e=/&#([a-zA-Z0-9]*);?/gim,Y9e=/&colon;?/gim,Z9e=/&newline;?/gim,rI=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,Vte=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,kte=/u\s*r\s*l\s*\(.*/gi;function V0e(t){return t.replace(q9e,"&quot;")}function k0e(t){return t.replace(W9e,'"')}function z0e(t){return t.replace(X9e,function(r,i){return i[0]==="x"||i[0]==="X"?String.fromCharCode(parseInt(i.substr(1),16)):String.fromCharCode(parseInt(i,10))})}function B0e(t){return t.replace(Y9e,":").replace(Z9e," ")}function G0e(t){for(var e="",r=0,i=t.length;r<i;r++)e+=t.charCodeAt(r)<32?" ":t.charAt(r);return EF.trim(e)}function j0e(t){return t=k0e(t),t=z0e(t),t=B0e(t),t=G0e(t),t}function H0e(t){return t=V0e(t),t=U0e(t),t}function J9e(){return""}function K9e(t,e){typeof e!="function"&&(e=function(){});var r=!Array.isArray(t);function i(o){return r?!0:EF.indexOf(t,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(i(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return e(o,a,l)},remove:function(o){var a="",l=0;return EF.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function Q9e(t){for(var e="",r=0;r<t.length;){var i=t.indexOf("<!--",r);if(i===-1){e+=t.slice(r);break}e+=t.slice(r,i);var s=t.indexOf("-->",i);if(s===-1)break;r=s+3}return e}function eVe(t){var e=t.split("");return e=e.filter(function(r){var i=r.charCodeAt(0);return i===127?!1:i<=31?i===10||i===13:!0}),e.join("")}un.whiteList=N0e();un.getDefaultWhiteList=N0e;un.onTag=V9e;un.onIgnoreTag=k9e;un.onTagAttr=z9e;un.onIgnoreTagAttr=B9e;un.safeAttrValue=G9e;un.escapeHtml=U0e;un.escapeQuote=V0e;un.unescapeQuote=k0e;un.escapeHtmlEntities=z0e;un.escapeDangerHtml5Entities=B0e;un.clearNonPrintableCharacter=G0e;un.friendlyAttrValue=j0e;un.escapeAttrValue=H0e;un.onIgnoreTagStripAll=J9e;un.StripTagBody=K9e;un.stripCommentTag=Q9e;un.stripBlankChar=eVe;un.cssFilter=F0e;un.getDefaultCSSWhiteList=U9e;var V5={},s_=PY;function tVe(t){var e=s_.spaceIndex(t),r;return e===-1?r=t.slice(1,-1):r=t.slice(1,e+1),r=s_.trim(r).toLowerCase(),r.slice(0,1)==="/"&&(r=r.slice(1)),r.slice(-1)==="/"&&(r=r.slice(0,-1)),r}function rVe(t){return t.slice(0,2)==="</"}function iVe(t,e,r){var i="",s=0,n=!1,o=!1,a=0,l=t.length,c="",h="";e:for(a=0;a<l;a++){var p=t.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){i+=r(t.slice(s,a)),n=a,s=a;continue}if(p===">"){i+=r(t.slice(s,n)),h=t.slice(n,a+1),c=tVe(h),i+=e(n,i.length,c,h,rVe(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,m=t.charAt(a-f);m.trim()===""||m==="=";){if(m==="="){o=p;continue e}m=t.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<t.length&&(i+=r(t.substr(s))),i}var sVe=/[^a-zA-Z0-9\\_:.-]/gim;function nVe(t,e){var r=0,i=0,s=[],n=!1,o=t.length;function a(f,m){if(f=s_.trim(f),f=f.replace(sVe,"").toLowerCase(),!(f.length<1)){var y=e(f,m||"");y&&s.push(y)}}for(var l=0;l<o;l++){var c=t.charAt(l),h,p;if(n===!1&&c==="="){n=t.slice(r,l),r=l+1,i=t.charAt(r)==='"'||t.charAt(r)==="'"?r:aVe(t,l+1);continue}if(n!==!1&&l===i){if(p=t.indexOf(c,l+1),p===-1)break;h=s_.trim(t.slice(i+1,p)),a(n,h),n=!1,l=p,r=l+1;continue}if(/\s|\n|\t/.test(c))if(t=t.replace(/\s|\n|\t/g," "),n===!1)if(p=oVe(t,l),p===-1){h=s_.trim(t.slice(r,l)),a(h),n=!1,r=l+1;continue}else{l=p-1;continue}else if(p=lVe(t,l-1),p===-1){h=s_.trim(t.slice(r,l)),h=zte(h),a(n,h),n=!1,r=l+1;continue}else continue}return r<t.length&&(n===!1?a(t.slice(r)):a(n,zte(s_.trim(t.slice(r))))),s_.trim(s.join(" "))}function oVe(t,e){for(;e<t.length;e++){var r=t[e];if(r!==" ")return r==="="?e:-1}}function aVe(t,e){for(;e<t.length;e++){var r=t[e];if(r!==" ")return r==="'"||r==='"'?e:-1}}function lVe(t,e){for(;e>0;e--){var r=t[e];if(r!==" ")return r==="="?e:-1}}function cVe(t){return t[0]==='"'&&t[t.length-1]==='"'||t[0]==="'"&&t[t.length-1]==="'"}function zte(t){return cVe(t)?t.substr(1,t.length-2):t}V5.parseTag=iVe;V5.parseAttr=nVe;var uVe=C3.exports.FilterCSS,jd=un,q0e=V5,hVe=q0e.parseTag,dVe=q0e.parseAttr,lD=PY;function iI(t){return t==null}function pVe(t){var e=lD.spaceIndex(t);if(e===-1)return{html:"",closing:t[t.length-2]==="/"};t=lD.trim(t.slice(e+1,-1));var r=t[t.length-1]==="/";return r&&(t=lD.trim(t.slice(0,-1))),{html:t,closing:r}}function fVe(t){var e={};for(var r in t)e[r]=t[r];return e}function mVe(t){var e={};for(var r in t)Array.isArray(t[r])?e[r.toLowerCase()]=t[r].map(function(i){return i.toLowerCase()}):e[r.toLowerCase()]=t[r];return e}function W0e(t){t=fVe(t||{}),t.stripIgnoreTag&&(t.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),t.onIgnoreTag=jd.onIgnoreTagStripAll),t.whiteList||t.allowList?t.whiteList=mVe(t.whiteList||t.allowList):t.whiteList=jd.whiteList,t.onTag=t.onTag||jd.onTag,t.onTagAttr=t.onTagAttr||jd.onTagAttr,t.onIgnoreTag=t.onIgnoreTag||jd.onIgnoreTag,t.onIgnoreTagAttr=t.onIgnoreTagAttr||jd.onIgnoreTagAttr,t.safeAttrValue=t.safeAttrValue||jd.safeAttrValue,t.escapeHtml=t.escapeHtml||jd.escapeHtml,this.options=t,t.css===!1?this.cssFilter=!1:(t.css=t.css||{},this.cssFilter=new uVe(t.css))}W0e.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,r=e.options,i=r.whiteList,s=r.onTag,n=r.onIgnoreTag,o=r.onTagAttr,a=r.onIgnoreTagAttr,l=r.safeAttrValue,c=r.escapeHtml,h=e.cssFilter;r.stripBlankChar&&(t=jd.stripBlankChar(t)),r.allowCommentTag||(t=jd.stripCommentTag(t));var p=!1;r.stripIgnoreTagBody&&(p=jd.StripTagBody(r.stripIgnoreTagBody,n),n=p.onIgnoreTag);var f=hVe(t,function(m,y,_,b,x){var T={sourcePosition:m,position:y,isClosing:x,isWhite:Object.prototype.hasOwnProperty.call(i,_)},S=s(_,b,T);if(!iI(S))return S;if(T.isWhite){if(T.isClosing)return"</"+_+">";var E=pVe(b),O=i[_],R=dVe(E.html,function(L,I){var U=lD.indexOf(O,L)!==-1,z=o(_,L,I,U);return iI(z)?U?(I=l(_,L,I,h),I?L+'="'+I+'"':L):(z=a(_,L,I,U),iI(z)?void 0:z):z});return b="<"+_,R&&(b+=" "+R),E.closing&&(b+=" /"),b+=">",b}else return S=n(_,b,T),iI(S)?c(b):S},c);return p&&(f=p.remove(f)),f};var gVe=W0e;(function(t,e){var r=un,i=V5,s=gVe;function n(a,l){var c=new s(l);return c.process(a)}e=t.exports=n,e.filterXSS=n,e.FilterXSS=s,function(){for(var a in r)e[a]=r[a];for(var l in i)e[l]=i[l]}();function o(){return typeof self<"u"&&typeof DedicatedWorkerGlobalScope<"u"&&self instanceof DedicatedWorkerGlobalScope}o()&&(self.filterXSS=t.exports)})(Ob,Ob.exports);var yVe=function(){function t(e,r){var i=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?i.sanitizeUrl(a):Ob.exports.safeAttrValue(n,o,a,l)}},this._entityMap={"&":"&#x38;","<":"&#x3C;",">":"&#x3E;",'"':"&#x22;","'":"&#x27;","/":"&#x2F;"};var s;e&&!r?s=e:e&&r?(s=Object.create(this.arcgisFilterOptions),Object.keys(e).forEach(function(n){n==="whiteList"?s.whiteList=i._extendObjectOfArrays([i.arcgisWhiteList,e.whiteList||{}]):s[n]=e[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new Ob.exports.FilterXSS(s)}return t.prototype.sanitize=function(e,r){switch(r===void 0&&(r={}),typeof e){case"number":return isNaN(e)||!isFinite(e)?null:e;case"boolean":return e;case"string":return this._xssFilter.process(e);case"object":return this._iterateOverObject(e,r);default:return r.allowUndefined&&typeof e>"u"?void 0:null}},t.prototype.sanitizeUrl=function(e,r){var i=(r??{}).isProtocolRequired,s=i===void 0?!0:i,n=this._trim(e.substring(0,e.indexOf(":"))),o=e==="/",a=/^#/.test(e),l=n&&this.allowedProtocols.indexOf(n.toLowerCase())>-1;return o||a||l?Ob.exports.escapeAttrValue(e):!n&&!s?Ob.exports.escapeAttrValue("https://".concat(e)):""},t.prototype.sanitizeHTMLAttribute=function(e,r,i,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(e,r,i,s):Ob.exports.safeAttrValue(e,r,i,s)},t.prototype.validate=function(e,r){r===void 0&&(r={});var i=this.sanitize(e,r);return{isValid:e===i,sanitized:i}},t.prototype.encodeHTML=function(e){var r=this;return String(e).replace(/[&<>"'\/]/g,function(i){return r._entityMap[i]})},t.prototype.encodeAttrValue=function(e){var r=/^[a-zA-Z0-9]$/;return String(e).replace(/[\x00-\xFF]/g,function(i,s){return r.test(i)?i:"&#x".concat(Number(e.charCodeAt(s)).toString(16),";")})},t.prototype._extendObjectOfArrays=function(e){var r={};return e.forEach(function(i){Object.keys(i).forEach(function(s){Array.isArray(i[s])&&Array.isArray(r[s])?r[s]=r[s].concat(i[s]):r[s]=i[s]})}),r},t.prototype._iterateOverObject=function(e,r){var i=this;r===void 0&&(r={});try{var s=!1,n=void 0;if(Array.isArray(e))n=e.reduce(function(a,l){var c=i.validate(l,r);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(C9e(e)){var o=Object.keys(e);n=o.reduce(function(a,l){var c=e[l],h=i.validate(c,r);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return r.allowUndefined&&typeof e>"u"?void 0:null;return s?n:e}catch{return null}},t.prototype._trim=function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},t}();const k5=new Map;function X0e(){k5.clear()}function _Ve(t){return k5.get(t)}function vVe(t,e){k5.set(t,e)}function ZU(t){k5.delete(t)}var Dw,yE,bVe=function(t){if("WebkitTransition"in t.style)Dw="webkitTransitionEnd",yE="webkitAnimationEnd";else{if(!("transition"in t.style))throw new Error("Your browser is not supported!");Dw="transitionend",yE="animationend"}},Y0e=function(t){Dw||bVe(t)},wVe=function(t,e){return e===void 0&&(e=t+"-active"),function(r){Y0e(r);var i=!1,s=function(n){i||(i=!0,r.removeEventListener(Dw,s),r.removeEventListener(yE,s),r.classList.remove(t),r.classList.remove(e))};r.classList.add(t),r.addEventListener(Dw,s),r.addEventListener(yE,s),requestAnimationFrame(function(){r.classList.add(e)})}},xVe=function(t,e){return e===void 0&&(e=t+"-active"),function(r,i){Y0e(r);var s=!1,n=function(o){s||(s=!0,r.removeEventListener(Dw,n),r.removeEventListener(yE,n),i())};r.classList.add(t),r.addEventListener(Dw,n),r.addEventListener(yE,n),requestAnimationFrame(function(){r.classList.add(e)})}};const TVe=se.getLogger("esri.widgets.support.widgetUtils");function Z0e(t){const e=Tc.acquire();for(let i=0;i<arguments.length;i++){const s=arguments[i],n=typeof s;if(n==="string")e.push(s);else if(Array.isArray(s))e.push.apply(e,s);else if(n==="object")for(const o in s)s[o]&&e.push(o)}const r=e.join(" ");return Tc.release(e),r}(()=>{const t=new Map,e=new ResizeObserver(r=>{var i;X0e();for(const s of r)(i=t.get(s.target))==null||i(s)});return(r,i,s)=>(t.has(r)&&TVe.error("Already observing element",r),t.set(r,i),e.observe(r,s),yp(()=>{e.unobserve(r),t.delete(r)}))})();function qf(t){const e=t==null?void 0:t.closest("[dir]");return e!==null&&e instanceof HTMLElement&&e.dir==="rtl"||document.dir==="rtl"}function Bte(t){const e="data-node-ref";this[t.getAttribute(e)]=null}function CF(t){const e="data-node-ref";this[t.getAttribute(e)]=t}function SVe(t,e){return(t==="enter"?wVe:xVe)(e)}const EVe=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],CVe=EVe.reduce((t,e)=>(t[e]=[],t),{}),AVe=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],J0e=new yVe({whiteList:CVe,onTagAttr:(t,e,r)=>{const i=`${e}="${r}"`;if(AVe.includes(e))return i},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function RVe(t){return t==="Enter"||t===" "}const K0e="http://www.w3.org/",z5=`${K0e}2000/svg`,Q0e=`${K0e}1999/xlink`;let Gte=[],IY=(t,e)=>{let r={};return Object.keys(t).forEach(i=>{r[i]=t[i]}),e&&Object.keys(e).forEach(i=>{r[i]=e[i]}),r},$Y=(t,e)=>t.vnodeSelector===e.vnodeSelector&&(t.properties&&e.properties?t.properties.key===e.properties.key&&t.properties.bind===e.properties.bind:!t.properties&&!e.properties),e_e=t=>{if(typeof t!="string")throw new Error("Style values must be strings")},OVe=(t,e,r)=>{if(e.vnodeSelector!==""){for(let i=r;i<t.length;i++)if($Y(t[i],e))return i}return-1},JU=(t,e,r,i)=>{let s=t[e];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n&&(n.key===void 0?n.bind:n.key))){for(let o=0;o<t.length;o++)if(o!==e){let a=t[o];if($Y(a,s))throw new Error(`${r.vnodeSelector} had a ${s.vnodeSelector} child ${i==="added"?i:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},MVe=t=>{if(t.properties){let e=t.properties.enterAnimation;e&&e(t.domNode,t.properties)}},L7=[],D7=!1,t_e=t=>{(t.children||[]).forEach(t_e),t.properties&&t.properties.afterRemoved&&t.properties.afterRemoved.apply(t.properties.bind||t.properties,[t.domNode])},jte=()=>{D7=!1,L7.forEach(t_e),L7.length=0},Hte=t=>{L7.push(t),D7||(D7=!0,typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback(jte,{timeout:16}):setTimeout(jte,16))},qte=t=>{let e=t.domNode;if(t.properties){let r=t.properties.exitAnimation;if(r)return e.style.pointerEvents="none",void r(e,()=>{e.parentNode&&(e.parentNode.removeChild(e),Hte(t))},t.properties)}e.parentNode&&(e.parentNode.removeChild(e),Hte(t))},PVe=(t,e,r)=>{if(!e)return;let i=r.eventHandlerInterceptor,s=Object.keys(e),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=e[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")N7(t,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&t.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],m=l[f];m&&(e_e(m),r.styleApplyer(t,f,m))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(i&&(l=i(a,l,t,e)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),t[a]=l):r.namespace===z5?a==="href"?t.setAttributeNS(Q0e,a,l):t.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?t[a]=J0e.sanitize(l):r_e(t)&&a in t?t[a]=l:t.setAttribute(a,l):t[a]=l}}};function r_e(t){if(!(t instanceof Element&&t.tagName.includes("-")))return!1;const e=window.customElements.get(t.tagName.toLowerCase());return!!e&&t instanceof e}let AF,IVe=(t,e,r)=>{if(e)for(let i of e)z2(i,t,void 0,r)},i_e=(t,e,r)=>{IVe(t,e.children,r),e.text&&(t.textContent=e.text),PVe(t,e.properties,r),e.properties&&e.properties.afterCreate&&e.properties.afterCreate.apply(e.properties.bind||e.properties,[t,r,e.vnodeSelector,e.properties,e.children])},z2=(t,e,r,i)=>{let s,n=0,o=t.vnodeSelector,a=e.ownerDocument;if(o==="")s=t.domNode=a.createTextNode(t.text),r!==void 0?e.insertBefore(s,r):e.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(i=IY(i,{namespace:z5})),i.namespace!==void 0?s=t.domNode=a.createElementNS(i.namespace,p):(s=t.domNode=t.domNode||a.createElement(p),p==="input"&&t.properties&&t.properties.type!==void 0&&s.setAttribute("type",t.properties.type)),r!==void 0?e.insertBefore(s,r):s.parentNode!==e&&e.appendChild(s)),n=l+1}}i_e(s,t,i)}},N7=(t,e,r)=>{e&&e.split(" ").forEach(i=>{i&&t.classList.toggle(i,r)})},$Ve=(t,e,r,i)=>{if(!r)return;let s=!1,n=Object.keys(r),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=r[l],h=e[l];if(l==="class")h!==c&&(N7(t,h,!1),N7(t,c,!0));else if(l==="classes"){let p=t.classList,f=Object.keys(c),m=f.length;for(let y=0;y<m;y++){let _=f[y],b=!!c[_];b!==!!h[_]&&(s=!0,b?p.add(_):p.remove(_))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let m=0;m<f;m++){let y=p[m],_=c[y];_!==h[y]&&(s=!0,_?(e_e(_),i.styleApplyer(t,y,_)):i.styleApplyer(t,y,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=t[l];p!==c&&(t["oninput-value"]?p===t["oninput-value"]:c!==h)&&(t[l]=c,t["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&i.eventHandlerInterceptor||(i.namespace===z5?l==="href"?t.setAttributeNS(Q0e,l,c):t.setAttribute(l,c):p==="string"?l==="innerHTML"?t[l]=J0e.sanitize(c):l==="role"&&c===""?t.removeAttribute(l):r_e(t)&&l in t?t[l]=c:t.setAttribute(l,c):t[l]!==c&&(t[l]=c),s=!0)}}return s},LVe=(t,e,r,i,s)=>{if(r===i)return!1;i=i||Gte;let n,o=(r=r||Gte).length,a=i.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?r[l]:void 0,f=i[c];if(p!==void 0&&$Y(p,f))h=AF(p,f,s)||h,l++;else{let m=OVe(r,f,l+1);if(m>=0){for(n=l;n<m;n++)qte(r[n]),JU(r,n,t,"removed");h=AF(r[m],f,s)||h,l=m+1}else z2(f,e,l<o?r[l].domNode:void 0,s),MVe(f),JU(i,c,t,"added")}c++}if(o>l)for(n=l;n<o;n++)qte(r[n]),JU(r,n,t,"removed");return h};AF=(t,e,r)=>{let i=t.domNode,s=!1;if(t===e)return!1;let n=!1;if(e.vnodeSelector===""){if(e.text!==t.text){let o=i.ownerDocument.createTextNode(e.text);return i.parentNode.replaceChild(o,i),e.domNode=o,s=!0,s}e.domNode=i}else e.vnodeSelector.lastIndexOf("svg",0)===0&&(r=IY(r,{namespace:z5})),t.text!==e.text&&(n=!0,e.text===void 0?i.removeChild(i.firstChild):i.textContent=e.text),e.domNode=i,n=LVe(e,i,t.children,e.children,r)||n,n=$Ve(i,t.properties,e.properties,r)||n,e.properties&&e.properties.afterUpdate&&e.properties.afterUpdate.apply(e.properties.bind||e.properties,[i,r,e.vnodeSelector,e.properties,e.children]);return n&&e.properties&&e.properties.updateAnimation&&e.properties.updateAnimation(i,e.properties,t.properties),s};let DC=(t,e)=>({getLastRender:()=>t,update:r=>{if(t.vnodeSelector!==r.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let i=t;t=r,AF(i,r,e)},domNode:t.domNode});const DVe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,r)=>{e.charAt(0)==="-"?t.style.setProperty(e,r):t.style[e]=r}};let qT=t=>IY(DVe,t),$_={create:(t,e)=>(e=qT(e),z2(t,document.createElement("div"),void 0,e),DC(t,e)),append:(t,e,r)=>(r=qT(r),z2(e,t,void 0,r),DC(e,r)),insertBefore:(t,e,r)=>(r=qT(r),z2(e,t.parentNode,t,r),DC(e,r)),merge:(t,e,r)=>(r=qT(r),e.domNode=t,i_e(t,e,r),DC(e,r)),replace:(t,e,r)=>(r=qT(r),z2(e,t.parentNode,t,r),t.parentNode.removeChild(t),DC(e,r))},s_e,NVe=(t,e)=>{let r=[];for(;t&&t!==e;)r.push(t),t=t.parentNode;return r};s_e=Array.prototype.find?(t,e)=>t.find(e):(t,e)=>t.filter(e)[0];let FVe=(t,e)=>{let r=t;return e.forEach(i=>{r=r&&r.children?s_e(r.children,s=>s.domNode===i):void 0}),r},UVe=(t,e,r)=>{let i=function(s){r("domEvent",s);let n=e(),o=NVe(s.currentTarget,n.domNode);o.reverse();let a,l=FVe(n.getLastRender(),o);return t.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),r("domEventProcessed",s),a};return(s,n,o,a)=>i},F7=t=>{let e,r,i=qT(t),s=i.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,m)=>{let y,_=()=>y;i.eventHandlerInterceptor=UVe(e,_,s),y=p(f,m(),i),a.push(y),l.push(m)},h=()=>{if(r=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return e={renderNow:h,scheduleRender:()=>{r||o||(r=requestAnimationFrame(h))},stop:()=>{r&&(cancelAnimationFrame(r),r=void 0),o=!0},resume:()=>{o=!1,n=!0,e.scheduleRender()},append:(p,f)=>{c($_.append,p,f)},insertBefore:(p,f)=>{c($_.insertBefore,p,f)},merge:(p,f)=>{c($_.merge,p,f)},replace:(p,f)=>{c($_.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},e},N0=class extends Te{constructor(){super(...arguments),this.items=new ft,this._watchUpdatingTracking=new em,this._callbacks=new Map,this._projector=F7(),this._hiddenProjector=F7()}get needsRender(){return this.items.length>0}get updating(){var e;return((e=this._watchUpdatingTracking)==null?void 0:e.updating)??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,r=>{for(const i of r.added){const s=()=>i.render();this._callbacks.set(i,s),this._projector.append(this.surface,s)}for(const i of r.removed){const s=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(s.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const r=this._hiddenSurface,i=this._hiddenProjector;let s;const n=()=>(s=e.render(),s);i.append(r,n),i.renderNow();const o={left:0,top:0,right:0,bottom:0};if(s&&s.domNode){const a=s.domNode.getBoundingClientRect();o.left=a.left,o.top=a.top,o.right=a.right,o.bottom=a.bottom}for(i.detach(n);r.firstChild;)r.removeChild(r.firstChild);return o}overlaps(e,r){const i=this.computeBoundingRect(e),s=this.computeBoundingRect(r);return Math.max(i.left,s.left)<=Math.min(i.right,s.right)&&Math.max(i.top,s.top)<=Math.min(i.bottom,s.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e){if(!this.items.some(i=>i.visible))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach(i=>{r.save(),i.renderCanvas(r),r.restore()}),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};u([d({readOnly:!0})],N0.prototype,"surface",void 0),u([d({readOnly:!0})],N0.prototype,"items",void 0),u([d({readOnly:!0})],N0.prototype,"needsRender",null),u([d({readOnly:!0})],N0.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],N0.prototype,"updating",null),N0=u([P("esri.views.overlay.ViewOverlay")],N0);const Wte=N0;function pS(t,e,r,i){let s=null,n=1e3;typeof e=="number"?(n=e,i=r):(s=e??null,n=r);let o,a=0;const l=()=>{a=0,t.apply(i,o)},c=(...h)=>{s&&s.apply(i,h),o=h,n?a||(a=setTimeout(l,n)):l()};return c.remove=()=>{a&&(clearTimeout(a),a=0)},c.forceUpdate=()=>{a&&(clearTimeout(a),l())},c.hasPendingUpdates=()=>!!a,c}const VVe={handleInterceptedEvent:(t,e,r,i)=>(t.scheduleRender(),e.properties[`on${i.type}`].apply(e.properties.bind||r,[i]))},kVe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,r)=>{t.style[e]=r}},zVe=t=>({...kVe,...t}),BVe=(t,e)=>{const r=[];for(;t&&t!==e;)r.push(t),t=t.parentNode;return r},GVe=(t,e)=>t.find(e),Xte=(t,e,r=!1)=>{let i=t;return e.forEach((s,n)=>{const o=i!=null&&i.children?GVe(i.children,a=>a.domNode===s):void 0;r&&!o&&n!==e.length-1||(i=o)}),i},jVe=t=>{let e;const r={...VVe,...t},i=zVe(r),s=i.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,m,y)=>{var x;let _;i.eventHandlerInterceptor=(T,S,E,O)=>function(R){let L;s("domEvent",R);const I=BVe(R.currentTarget,_.domNode),U=I.some(B=>{var G;return customElements.get((G=B==null?void 0:B.tagName)==null?void 0:G.toLowerCase())});if(R.eventPhase===Event.CAPTURING_PHASE||!U)I.reverse(),L=Xte(_.getLastRender(),I);else{const B=R.composedPath(),G=B.slice(B.indexOf(R.currentTarget),B.indexOf(_.domNode)).filter(K=>K.getRootNode()===K.ownerDocument).reverse();L=Xte(_.getLastRender(),G,!0)}let z;return L&&(z=r.handleInterceptedEvent(e,L,this,R)),s("domEventProcessed",R),z},(x=r.postProcessProjectionOptions)==null||x.call(r,i);const b=y();_=f(m,b,i),l.push(_),c.push(y),r.afterFirstVNodeRendered&&r.afterFirstVNodeRendered(_,b)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const m=c[f]();s("rendered",void 0),l[f].update(m),s("patched",void 0)}s("renderDone",void 0),o=!0}};return r.modifyDoRenderImplementation&&(p=r.modifyDoRenderImplementation(p,l,c)),e={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,e.scheduleRender()},append:(f,m)=>{h($_.append,f,m)},insertBefore:(f,m)=>{h($_.insertBefore,f,m)},merge:(f,m)=>{h($_.merge,f,m)},replace:(f,m)=>{h($_.replace,f,m)},detach:f=>{for(let m=0;m<c.length;m++)if(c[m]===f)return c.splice(m,1),l.splice(m,1)[0];throw new Error("renderFunction was not found")}},e};/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.0.8-next.4
 */const n_e="calcite-mode-auto",o_e="calcite-mode-dark",HVe="calcite-mode-light",ICt={autoMode:n_e,darkMode:o_e,lightMode:HVe,rtl:"calcite--rtl"};/*!
* tabbable 6.0.1
* @license MIT, https://github.com/focus-trap/tabbable/blob/master/LICENSE
*/var a_e=["input","select","textarea","a[href]","button","[tabindex]:not(slot)","audio[controls]","video[controls]",'[contenteditable]:not([contenteditable="false"])',"details>summary:first-of-type","details"],RF=a_e.join(","),l_e=typeof Element>"u",Nw=l_e?function(){}:Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector,OF=!l_e&&Element.prototype.getRootNode?function(t){return t.getRootNode()}:function(t){return t.ownerDocument},c_e=function(e,r,i){var s=Array.prototype.slice.apply(e.querySelectorAll(RF));return r&&Nw.call(e,RF)&&s.unshift(e),s=s.filter(i),s},u_e=function t(e,r,i){for(var s=[],n=Array.from(e);n.length;){var o=n.shift();if(o.tagName==="SLOT"){var a=o.assignedElements(),l=a.length?a:o.children,c=t(l,!0,i);i.flatten?s.push.apply(s,c):s.push({scopeParent:o,candidates:c})}else{var h=Nw.call(o,RF);h&&i.filter(o)&&(r||!e.includes(o))&&s.push(o);var p=o.shadowRoot||typeof i.getShadowRoot=="function"&&i.getShadowRoot(o),f=!i.shadowRootFilter||i.shadowRootFilter(o);if(p&&f){var m=t(p===!0?o.children:p.children,!0,i);i.flatten?s.push.apply(s,m):s.push({scopeParent:o,candidates:m})}else n.unshift.apply(n,o.children)}}return s},h_e=function(e,r){return e.tabIndex<0&&(r||/^(AUDIO|VIDEO|DETAILS)$/.test(e.tagName)||e.isContentEditable)&&isNaN(parseInt(e.getAttribute("tabindex"),10))?0:e.tabIndex},qVe=function(e,r){return e.tabIndex===r.tabIndex?e.documentOrder-r.documentOrder:e.tabIndex-r.tabIndex},d_e=function(e){return e.tagName==="INPUT"},WVe=function(e){return d_e(e)&&e.type==="hidden"},XVe=function(e){var r=e.tagName==="DETAILS"&&Array.prototype.slice.apply(e.children).some(function(i){return i.tagName==="SUMMARY"});return r},YVe=function(e,r){for(var i=0;i<e.length;i++)if(e[i].checked&&e[i].form===r)return e[i]},ZVe=function(e){if(!e.name)return!0;var r=e.form||OF(e),i=function(a){return r.querySelectorAll('input[type="radio"][name="'+a+'"]')},s;if(typeof window<"u"&&typeof window.CSS<"u"&&typeof window.CSS.escape=="function")s=i(window.CSS.escape(e.name));else try{s=i(e.name)}catch(o){return console.error("Looks like you have a radio button with a name attribute containing invalid CSS selector characters and need the CSS.escape polyfill: %s",o.message),!1}var n=YVe(s,e.form);return!n||n===e},JVe=function(e){return d_e(e)&&e.type==="radio"},KVe=function(e){return JVe(e)&&!ZVe(e)},QVe=function(e){for(var r,i=OF(e).host,s=!!((r=i)!==null&&r!==void 0&&r.ownerDocument.contains(i)||e.ownerDocument.contains(e));!s&&i;){var n;i=OF(i).host,s=!!((n=i)!==null&&n!==void 0&&n.ownerDocument.contains(i))}return s},Yte=function(e){var r=e.getBoundingClientRect(),i=r.width,s=r.height;return i===0&&s===0},eke=function(e,r){var i=r.displayCheck,s=r.getShadowRoot;if(getComputedStyle(e).visibility==="hidden")return!0;var n=Nw.call(e,"details>summary:first-of-type"),o=n?e.parentElement:e;if(Nw.call(o,"details:not([open]) *"))return!0;if(!i||i==="full"||i==="legacy-full"){if(typeof s=="function"){for(var a=e;e;){var l=e.parentElement,c=OF(e);if(l&&!l.shadowRoot&&s(l)===!0)return Yte(e);e.assignedSlot?e=e.assignedSlot:!l&&c!==e.ownerDocument?e=c.host:e=l}e=a}if(QVe(e))return!e.getClientRects().length;if(i!=="legacy-full")return!0}else if(i==="non-zero-area")return Yte(e);return!1},tke=function(e){if(/^(INPUT|BUTTON|SELECT|TEXTAREA)$/.test(e.tagName))for(var r=e.parentElement;r;){if(r.tagName==="FIELDSET"&&r.disabled){for(var i=0;i<r.children.length;i++){var s=r.children.item(i);if(s.tagName==="LEGEND")return Nw.call(r,"fieldset[disabled] *")?!0:!s.contains(e)}return!0}r=r.parentElement}return!1},MF=function(e,r){return!(r.disabled||WVe(r)||eke(r,e)||XVe(r)||tke(r))},U7=function(e,r){return!(KVe(r)||h_e(r)<0||!MF(e,r))},rke=function(e){var r=parseInt(e.getAttribute("tabindex"),10);return!!(isNaN(r)||r>=0)},ike=function t(e){var r=[],i=[];return e.forEach(function(s,n){var o=!!s.scopeParent,a=o?s.scopeParent:s,l=h_e(a,o),c=o?t(s.candidates):a;l===0?o?r.push.apply(r,c):r.push(a):i.push({documentOrder:n,tabIndex:l,item:s,isScope:o,content:c})}),i.sort(qVe).reduce(function(s,n){return n.isScope?s.push.apply(s,n.content):s.push(n.content),s},[]).concat(r)},ske=function(e,r){r=r||{};var i;return r.getShadowRoot?i=u_e([e],r.includeContainer,{filter:U7.bind(null,r),flatten:!1,getShadowRoot:r.getShadowRoot,shadowRootFilter:rke}):i=c_e(e,r.includeContainer,U7.bind(null,r)),ike(i)},$Ct=function(e,r){r=r||{};var i;return r.getShadowRoot?i=u_e([e],r.includeContainer,{filter:MF.bind(null,r),flatten:!0,getShadowRoot:r.getShadowRoot}):i=c_e(e,r.includeContainer,MF.bind(null,r)),i},LCt=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return Nw.call(e,RF)===!1?!1:U7(r,e)},nke=a_e.concat("iframe").join(","),DCt=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return Nw.call(e,nke)===!1?!1:MF(r,e)};const oke={getShadowRoot:!0};function NCt(t){const e="dir",r=`[${e}]`,i=ake(t,r);return i?i.getAttribute(e):"ltr"}function FCt(t,e,r){const i=`[${e}]`,s=t.closest(i);return s?s.getAttribute(e):r}function p_e(t){return t.getRootNode()}function f_e(t){return t.host||null}function UCt(t,{selector:e,id:r}){function i(s){if(!s)return null;s.assignedSlot&&(s=s.assignedSlot);const n=p_e(s),o=r?"getElementById"in n?n.getElementById(r):null:e?n.querySelector(e):null,a=f_e(n);return o||(a?i(a):null)}return i(t)}function ake(t,e){function r(i){return i?i.closest(e)||r(f_e(p_e(i))):null}return r(t)}function lke(t,e){return m_e(t,e)}function m_e(t,e){if(!t)return;const r=e(t);if(r!==void 0)return r;const{parentNode:i}=t;return m_e(i instanceof ShadowRoot?i.host:i,e)}function VCt(t,e){return!!lke(e,r=>r===t?!0:void 0)}function cke(t){return typeof(t==null?void 0:t.setFocus)=="function"}async function kCt(t){if(t)return cke(t)?t.setFocus():t.focus()}function zCt(t){(ske(t,oke)[0]||t).focus()}const A3=":not([slot])";function BCt(t,e,r){e&&!Array.isArray(e)&&typeof e!="string"&&(r=e,e=null);const i=e?Array.isArray(e)?e.map(s=>`[slot="${s}"]`).join(","):`[slot="${e}"]`:A3;return r!=null&&r.all?uke(t,i,r):hke(t,i,r)}function g_e(t,e){return t?Array.from(t.children||[]).filter(r=>r==null?void 0:r.matches(e)):[]}function uke(t,e,r){let i=e===A3?g_e(t,A3):Array.from(t.querySelectorAll(e));i=r&&r.direct===!1?i:i.filter(n=>n.parentElement===t),i=r!=null&&r.matches?i.filter(n=>n==null?void 0:n.matches(r.matches)):i;const s=r==null?void 0:r.selector;return s?i.map(n=>Array.from(n.querySelectorAll(s))).reduce((n,o)=>[...n,...o],[]).filter(n=>!!n):i}function hke(t,e,r){let i=e===A3?g_e(t,A3)[0]||null:t.querySelector(e);i=r&&r.direct===!1||(i==null?void 0:i.parentElement)===t?i:null,i=r!=null&&r.matches?i!=null&&i.matches(r.matches)?i:null:i;const s=r==null?void 0:r.selector;return s?i==null?void 0:i.querySelector(s):i}function GCt(t,e,r){if(typeof e=="string"&&e!=="")return e;if(e==="")return t[r]}function jCt(t){return(!!t).toString()}function HCt(t){return!!dke(t).length}function dke(t){return t.target.assignedElements({flatten:!0})}function qCt(t){return!!(t.isPrimary&&t.button===0)}/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.0.8-next.4
 */function Zte(){const{classList:t}=document.body,e=window.matchMedia("(prefers-color-scheme: dark)").matches,r=()=>t.contains(o_e)||t.contains(n_e)&&e?"dark":"light",i=o=>document.body.dispatchEvent(new CustomEvent("calciteModeChange",{bubbles:!0,detail:{mode:o}})),s=o=>{n!==o&&i(o),n=o};let n=r();i(n),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>s(o.matches?"dark":"light")),new MutationObserver(()=>s(r())).observe(document.body,{attributes:!0,attributeFilter:["class"]})}function pke(){typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document&&(document.readyState==="interactive"?Zte():document.addEventListener("DOMContentLoaded",()=>Zte(),{once:!0}))}const fke=pke;fke();let y_e;function mke(){_he(Eu(Kr(y_e)))}y_e="components/assets";const __e=Symbol("widget"),gke=Symbol("widget-test-data"),yke=[],_ke={},PF=new WeakMap;function v_e(t,e){let r=e.children;if(r&&r.length)for(let s=0;s<r.length;++s)r[s]=v_e(t,r[s]);else r=yke;const i=e.vnodeSelector;if(LY(i)){const s=e.properties||_ke,n=s.key||i;return{vnodeSelector:"div",properties:{key:n,afterCreate:vke,afterUpdate:bke,afterRemoved:b_e,parentWidget:t,widgetConstructor:i,widgetProperties:{...s,key:n,children:r}},children:void 0,text:void 0,domNode:null}}return e}function vke(t,e,r,{parentWidget:i,widgetConstructor:s,widgetProperties:n}){var a;const o=new s(n);o.container=t,PF.set(t,o),(a=o.afterCreate)==null||a.call(o,o,t),i._internalHandles.add(yp(()=>b_e(t)))}function bke(t,e,r,{widgetProperties:i}){var n;const s=PF.get(t);s&&(s.set(i),(n=s.afterUpdate)==null||n.call(s,s,t))}function b_e(t){var r;const e=PF.get(t);e&&((r=e.afterRemoved)==null||r.call(e,e,t),e.destroy(),PF.delete(t))}function LY(t){return typeof t=="function"&&t[__e]}const Jte=new Set;function wke(t){Jte.add(t),t.finally(()=>Jte.delete(t))}var w_e;const xke="esri.widgets.Widget";let Tke=0;const Ske={widgetIcon:"esri-icon-checkbox-unchecked"};function x_e(t,e){for(const r in e)t[r]!=null&&(typeof t[r]=="object"&&typeof e[r]=="object"?x_e(t[r],e==null?void 0:e[r]):t[r]=e[r]);return t}const Eke=jVe({postProcessProjectionOptions(t){const e=t.eventHandlerInterceptor,r=/capture$/i;t.eventHandlerInterceptor=(i,s,n,o)=>{const a=e==null?void 0:e(i,s,n,o),l=r.test(i);if(!((i=i.replace(r,"")).toLowerCase()in n)||l){const c=i[2].toLowerCase()+i.slice(3),h=m=>a==null?void 0:a.call(n,m);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=m=>{f==null||f(m),p()}}return a}},handleInterceptedEvent(t,e,r,i){const{eventPhase:s,type:n}=i,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=e.properties;(l&&a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,l&&a in l))&&(X0e(),t.scheduleRender(),l[a].call(l.bind||r,i))}});let KU=!1,bo=class extends SM(Fs.EventedAccessor){constructor(e,r){super(e,r),this._attached=!1,this._internalHandles=new Zr,this._projector=Eke,this._readyForTrueRender=!1,this.iconClass=Ske.widgetIcon,this.key=this,this._loadLocale=vW(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const o=await co(this._messageBundleProps.map(async({bundlePath:a,propertyName:l})=>{let c=await Ape(a);this.uiStrings&&Object.keys(this.uiStrings)&&(c=x_e(te(c),this.uiStrings)),this[l]=c}));for(const a of o)a.error&&se.getLogger(this.declaredClass).error("widget-intl:locale-error",this.declaredClass,a.error)}await this.loadLocale()}),mke();const i="esri-widget-uid-"+fme(),s=this.render.bind(this);this._trackingTarget=new X4(()=>this.scheduleRender());const n=()=>{var p;if(!this._readyForTrueRender||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:i,class:"",styles:{display:"none"}},domNode:null,children:void 0,text:void 0};const o=s();let{properties:a}=o;a||(o.properties=a={});let{key:l,styles:c}=a;l||(a.key=i),c||(a.styles=c={}),c.display||(c.display="");let h=0;return(p=o.children)==null||p.forEach(f=>{if(LY(f.vnodeSelector))return;let{properties:m}=f;m||(f.properties=m={}),m.key||(m.key=`${this.id}--${h++}`)}),v_e(this,o)};this.render=()=>{if(KU)return n();let o=_Ve(this)??null;if(o)return o;this._trackingTarget.clear(),KU=!0;try{o=iy(this._trackingTarget,n)}catch(a){throw console.error(a),a}finally{KU=!1}return o&&vVe(this,o),o},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()})),wke(this._resourcesFetch)}normalizeCtorArgs(e,r){const i={...e};return r&&(i.container=r),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(Lk)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(Ve(this._trackingTarget),Ve(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,ZU(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return F5(e)}get domNode(){return this.container}set domNode(e){this.container=e}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+Tke++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(w_e=__e,gke)](){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(ZU(this),this._projector.scheduleRender())}classes(...e){return Z0e.apply(this,e)}renderNow(){ZU(this),this._projector.renderNow()}_postInitialize(){var r;if(this.destroyed)return;this.scheduleRender(),(r=this._delegatedEventNames)!=null&&r.length&&this._internalHandles.add(ne(()=>this.viewModel,(i,s)=>{s&&this._internalHandles.remove("delegated-events"),i&&H4(i)&&this._internalHandles.add(this._delegatedEventNames.map(n=>wM(i,n,o=>{this.emit(n,o)})),"delegated-events")},kt)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(Lk),this.scheduleRender()};this._internalHandles.add([Epe(e),ne(()=>this.uiStrings,e),ra(()=>this.container,i=>{this.destroyed||this._attach(i)},{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){var r;this._attached&&(this._projector.detach(this.render),this._attached=!1),(r=e==null?void 0:e.parentNode)==null||r.removeChild(e)}};bo[w_e]=!0,u([d()],bo.prototype,"_readyForTrueRender",void 0),u([d({value:null})],bo.prototype,"container",null),u([Gt("container")],bo.prototype,"castContainer",null),u([d()],bo.prototype,"iconClass",void 0),u([d()],bo.prototype,"id",null),u([d()],bo.prototype,"label",null),u([d()],bo.prototype,"renderable",null),u([d()],bo.prototype,"uiStrings",void 0),u([d()],bo.prototype,"viewModel",void 0),u([d({value:!0})],bo.prototype,"visible",null),u([d()],bo.prototype,"key",void 0),u([d()],bo.prototype,"children",void 0),u([d()],bo.prototype,"afterCreate",void 0),u([d()],bo.prototype,"afterUpdate",void 0),u([d()],bo.prototype,"afterRemoved",void 0),bo=u([P(xke)],bo);const Ma=bo;function Cke(t,e,r){return t.units[e][r]}function B5(t,e,r,i=2,s="abbr"){return`${fm(e,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:e>0?"never":"exceptZero"})} ${Cke(t,r,s)}`}function XCt(t,e,r,i=2,s="abbr"){const n=cpe(e,r);return B5(t,vn(e,r,n),n,i,s)}function YCt(t,e,r,i=2,s="abbr"){const n=upe(e,r);return B5(t,vn(e,r,n),n,i,s)}function ZCt(t,e,r,i=2,s="abbr"){const n=hpe(e,r);return B5(t,vn(e,r,n),n,i,s)}function JCt(t,e,r,i=2,s="abbr"){const n=dpe(e,r);return B5(t,vn(e,r,n),n,i,s)}const Kte=["B","kB","MB","GB","TB"];function Ake(t,e){let r=e===0?0:Math.floor(Math.log(e)/Math.log(hE.KILOBYTES));r=ye(r,0,Kte.length-1);const i=fm(e/hE.KILOBYTES**r,{maximumFractionDigits:2});return om(t.units.bytes[Kte[r]],{fileSize:i})}function Rke(t){const{exifInfo:e,exifName:r,tagName:i}=t;if(!e||!r||!i)return null;const s=e.find(n=>n.name===r);return s?Oke({tagName:i,tags:s.tags}):null}function Oke(t){const{tagName:e,tags:r}=t;if(!r||!e)return null;const i=r.find(s=>s.name===e);return i&&i.value||null}var V7;const Mke={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let nc=V7=class extends fe{constructor(t){super(t),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:t}=this,e=Rke({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:t});return Mke[e]||null}clone(){return new V7({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],nc.prototype,"contentType",void 0),u([d()],nc.prototype,"exifInfo",void 0),u([d({readOnly:!0})],nc.prototype,"orientationInfo",null),u([d({type:Ti})],nc.prototype,"id",void 0),u([d({type:String})],nc.prototype,"globalId",void 0),u([d({type:String})],nc.prototype,"keywords",void 0),u([d({type:String})],nc.prototype,"name",void 0),u([d({json:{read:!1}})],nc.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],nc.prototype,"parentObjectId",void 0),u([d({type:Ti})],nc.prototype,"size",void 0),u([d({json:{read:!1}})],nc.prototype,"url",void 0),nc=V7=u([P("esri.layers.support.AttachmentInfo")],nc);const Pke=nc;var k7;let Go=k7=class extends fe{constructor(t){super(t),this.attachmentTypes=null,this.attachmentsWhere=null,this.cacheHint=void 0,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new k7(te({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,cacheHint:this.cacheHint,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],Go.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],Go.prototype,"attachmentsWhere",void 0),u([d({type:Boolean,json:{write:!0}})],Go.prototype,"cacheHint",void 0),u([d({type:[String],json:{write:!0}})],Go.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],Go.prototype,"globalIds",void 0),u([d({json:{write:!0}})],Go.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Go.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],Go.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Go.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],Go.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Go.prototype,"start",void 0),u([ke("start"),ke("num")],Go.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],Go.prototype,"where",void 0),Go=k7=u([P("esri.rest.support.AttachmentQuery")],Go),Go.from=Ls(Go);const z7=Go,Ike="esri.widgets.Feature.support.featureUtils",Qte=se.getLogger(Ike),$ke=/href=(""|'')/gi,Lke=/(\{([^\{\r\n]+)\})/g,Dke=/\'/g,T_e=/^\s*expression\//i,Nke=/(\n)/gi,Fke=/[\u00A0-\u9999<>\&]/gim,Uke=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,Vke=/^(?:mailto:|tel:)/,S_e="relationships/",B7=d5("short-date-short-time");function E_e(t){if(!C(t))return t.get("sourceLayer")||t.get("layer")}async function IF(t,e){return typeof t=="function"?t.call(null,e):t}function C_e(t=""){if(t)return!Vke.test(t.trim().toLowerCase())}function DY(t){return!!t&&T_e.test(t)}function kke(t,e){if(!DY(e)||!t)return null;const r=e.replace(T_e,"").toLowerCase();let i=null;return t.some(s=>s.name.toLowerCase()===r&&(i=s,!0)),i}function A_e(t,e){const r=kke(e,t==null?void 0:t.fieldName);return r?r.title||null:t?t.label||t.fieldName:null}function zke(t,e){const r=e.get(t.toLowerCase());return`{${r&&r.fieldName||t}}`}function Bke(t){return t.replace($ke,"")}function R3(t,e){const r=NY(e,t);return r?r.name:t}function Gke(t,e){return t&&t.map(r=>R3(r,e))}function NY(t,e){return t&&typeof t.getField=="function"&&e?t.getField(e)??null:null}function R_e(t){return`${t}`.trim()}function qb({attributes:t,globalAttributes:e,layer:r,text:i,expressionAttributes:s,fieldInfoMap:n}){return i?G7({formattedAttributes:e,template:Wke(i,{...e,...s,...t},r),fieldInfoMap:n}):""}function G7({formattedAttributes:t,template:e,fieldInfoMap:r}){return R_e(Bke(om(om(e,i=>zke(i,r)),t)))}function jke(t,e,r=!1){const i=e[t];if(typeof i=="string"){const s="%27",n=(r?encodeURIComponent(i):i).replace(Dke,s);e[t]=n}}function Hke(t,e=!1){const r={...t};return Object.keys(r).forEach(i=>jke(i,r,e)),r}function qke(t,e,r){const i=(e=R_e(e))&&e[0]!=="{";return om(t,Hke(r,i||!1))}function j7(t,e){return t.replace(Lke,(r,i,s)=>{const n=NY(e,s);return n?`{${n.name}}`:i})}function Wke(t,e,r){const i=j7(t,r);return i&&i.replace(Uke,(s,n,o)=>qke(s,n||o,e))}function Xke(t,e){if(typeof t=="string"&&e&&e.dateFormat==null&&(e.places!=null||e.digitSeparator!=null)){const r=Number(t);if(!isNaN(r))return r}return t}function Yke(t){return(t==null?void 0:t.type)==="feature"}function ere(t){return!!(t!=null&&t.layer)}function Zke(t){return(t==null?void 0:t.type)==="map-image"}function Jke(t,e){var c;const r=e.fieldInfos,i=e.fieldName,s=(c=O_e(r,i))==null?void 0:c.clone(),n=e.preventPlacesFormatting,o=e.layer,a=NY(o,i);if(s&&(a==null?void 0:a.type)==="date"){const h=s.format||new D2;h.dateFormat=h.dateFormat||"short-date-short-time",h.dateTimeFormatOptions=!ere(o)&&Yke(o)&&o.datesInUnknownTimezone||ere(o)&&Zke(o.layer)&&o.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,s.format=h}const l=s&&s.format;return typeof t=="string"&&Nme(i)&&l?l.formatRasterPixelValue(t):typeof(t=Xke(t,l))=="string"||t==null||l==null?kM(t):n?fm(t,{...Bme(l),minimumFractionDigits:0,maximumFractionDigits:20}):l.format(t)}function O_e(t,e){if(!t||!t.length||!e)return;const r=e.toLowerCase();let i;return t.some(s=>!(!s.fieldName||s.fieldName.toLowerCase()!==r)&&(i=s,!0)),i}function Kke({fieldName:t,graphic:e,layer:r}){if(kg(t)||!r||typeof r.getFeatureType!="function")return null;const{typeIdField:i}=r;if(!i||t!==i)return null;const s=r.getFeatureType(e);return s?s.name:null}function Qke({fieldName:t,value:e,graphic:r,layer:i}){if(kg(t)||!i||typeof i.getFieldDomain!="function")return null;const s=r&&i.getFieldDomain(t,{feature:r});return s&&s.type==="coded-value"?s.getName(e):null}function eze(t,e){const{creatorField:r,creationDateField:i,editorField:s,editDateField:n}=t;if(!e)return;const o=e[n];if(typeof o=="number"){const l=e[s];return{type:"edit",date:pm(o,B7),user:l}}const a=e[i];if(typeof a=="number"){const l=e[r];return{type:"create",date:pm(a,B7),user:l}}return null}function tze(t,e){const r=new Map;return t&&t.forEach(i=>{const s=R3(i.fieldName,e);i.fieldName=s,r.set(s.toLowerCase(),i)}),r}function tre(t){const e=[];if(!t)return e;const{fieldInfos:r,content:i}=t;return r&&e.push(...r),i&&Array.isArray(i)&&i.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&e.push(...n)}}),e}function FY(t){return t.replace(Fke,e=>`&#${e.charCodeAt(0)};`)}function kM(t){return typeof t=="string"?t.replace(Nke,'<br class="esri-text-new-line" />'):t}function M_e(t){const{value:e,fieldName:r,fieldInfos:i,fieldInfoMap:s,layer:n,graphic:o}=t;if(e==null)return"";const a=Qke({fieldName:r,value:e,graphic:o,layer:n});if(a)return a;const l=Kke({fieldName:r,graphic:o,layer:n});if(l)return l;if(s.get(r.toLowerCase()))return Jke(e,{fieldInfos:i||Array.from(s.values()),fieldName:r,layer:n});const c=n&&n.fieldsIndex;return c&&c.isDateField(r)?pm(e,B7):kM(e)}function QU({fieldInfos:t,attributes:e,layer:r,graphic:i,fieldInfoMap:s,relatedInfos:n}){const o={};return n==null||n.forEach(a=>nze({attributes:o,relatedInfo:a,fieldInfoMap:s,fieldInfos:t,layer:r})),e&&Object.keys(e).forEach(a=>{const l=e[a];o[a]=M_e({fieldName:a,fieldInfos:t,fieldInfoMap:s,layer:r,value:l,graphic:i})}),o}async function P_e(t,e){var h,p;const{layer:r,graphic:i,outFields:s,objectIds:n,returnGeometry:o,spatialReference:a}=t,l=n[0];if(typeof l!="number"&&typeof l!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",m={layer:r,graphic:i,objectId:l,requiredFields:s};return Qte.warn(f,m),null}if(!((p=(h=Ipe(r))==null?void 0:h.operations)!=null&&p.supportsQuery)){const f="The specified layer cannot be queried. The following fields will not be available.",m={layer:r,graphic:i,requiredFields:s,returnGeometry:o};return Qte.warn(f,m),null}const c=r.createQuery();return c.objectIds=n,c.outFields=s!=null&&s.length?s:[r.objectIdField],c.returnGeometry=!!o,c.returnZ=!!o,c.returnM=!!o,c.outSpatialReference=a,(await r.queryFeatures(c,e)).features[0]}async function rze(t){var i;if(!((i=t.expressionInfos)!=null&&i.length))return!1;const e=await dm(),{arcadeUtils:{hasGeometryFunctions:r}}=e;return r(t)}async function ize({graphic:t,popupTemplate:e,layer:r,spatialReference:i},s){if(!r||!e||(typeof r.load=="function"&&await r.load(s),!t.attributes))return;const n=t.attributes[r.objectIdField];if(n==null)return;const o=[n],a=await e.getRequiredFields(r.fieldsIndex),l=VFe(a,t),c=l?[]:a,h=e.returnGeometry||await rze(e);if(l&&!h)return;const p=await P_e({layer:r,graphic:t,outFields:c,objectIds:o,returnGeometry:h,spatialReference:i},s);p&&(p.geometry&&(t.geometry=p.geometry),p.attributes&&(t.attributes={...t.attributes,...p.attributes}))}function kg(t=""){return!!t&&t.includes(S_e)}function sze(t){return t?`${S_e}${t.layerId}/${t.fieldName}`:""}function rre({attributes:t,graphic:e,relatedInfo:r,fieldInfos:i,fieldInfoMap:s,layer:n}){t&&e&&r&&Object.keys(e.attributes).forEach(o=>{const a=sze({layerId:r.relation.id.toString(),fieldName:o}),l=e.attributes[o];t[a]=M_e({fieldName:a,fieldInfos:i,fieldInfoMap:s,layer:n,value:l,graphic:e})})}function nze({attributes:t,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s}){t&&e&&(e.relatedFeatures&&e.relatedFeatures&&e.relatedFeatures.forEach(n=>rre({attributes:t,graphic:n,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s})),e.relatedStatsFeatures&&e.relatedStatsFeatures&&e.relatedStatsFeatures.forEach(n=>rre({attributes:t,graphic:n,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s})))}const ire=t=>{if(!t)return!1;const e=t.toUpperCase();return e.includes("CURRENT_TIMESTAMP")||e.includes("CURRENT_DATE")||e.includes("CURRENT_TIME")},I_e=({layer:t,method:e,query:r,definitionExpression:i})=>{var o,a;if(!((a=(o=t.capabilities)==null?void 0:o.query)!=null&&a.supportsCacheHint)||e==="attachments")return;const s=v(r.where)?r.where:null,n=v(r.geometry)?r.geometry:null;ire(i)||ire(s)||(n==null?void 0:n.type)==="extent"||r.resultType==="tile"||(r.cacheHint=!0)},oze=({query:t,layer:e,method:r})=>{I_e({layer:e,method:r,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})},aze=({queryPayload:t,layer:e,method:r})=>{I_e({layer:e,method:r,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})};function lze(t,e,r){return t&&e&&r?sre(t.allLayers,e,r)||sre(t.allTables,e,r):null}function sre(t,e,r){return t.find(i=>i!==e&&i.type==="feature"&&i.url===e.url&&i.layerId===r.relatedTableId)}const nre={editing:!1,operations:{add:!0,update:!0,delete:!0}},$_e=ft.ofType(Pke);let oc=class extends Te{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities={...nre},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new $_e,this.fileInfos=new ft,this.graphic=null,this.mode="view",this.filesEnabled=!1,this.addHandles(ne(()=>this.graphic,()=>this._graphicChanged(),kt))}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(e){return{...nre,...e}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:e}=this;if(!e)return!1;const r=e.layer||e.sourceLayer;return(r==null?void 0:r.loaded)&&"capabilities"in r&&r.capabilities&&"operations"in r.capabilities&&"supportsResizeAttachments"in r.capabilities.operations&&r.capabilities.operations.supportsResizeAttachments||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:r}=this;if(!e||typeof e.queryAttachments!="function")throw new j("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getObjectId(),s=new z7({objectIds:[i],returnMetadata:!0}),n=[],o=e.queryAttachments(s).then(l=>l[i]||n).catch(()=>n);this._getAttachmentsPromise=o,this.notifyChange("state");const a=await o;return r.removeAll(),a.length&&r.addMany(a),this._getAttachmentsPromise=null,this.notifyChange("state"),a}async addAttachment(e,r=this.graphic){var l;const{_attachmentLayer:i,attachmentInfos:s,abilities:n}=this;if(!r)throw new j("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:r});if(!e)throw new j("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!((l=n.operations)!=null&&l.add))throw new j("invalid-abilities","addAttachment(): add abilities are required.");if(!i||typeof i.addAttachment!="function")throw new j("invalid-layer","addAttachment(): A valid layer is required.");const o=i.addAttachment(r,e).then(c=>this._queryAttachment(c.objectId,r)),a=await o;return s.add(a),a}async deleteAttachment(e){var l;const{_attachmentLayer:r,attachmentInfos:i,graphic:s,abilities:n}=this;if(!e)throw new j("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!((l=n.operations)!=null&&l.delete))throw new j("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!r||typeof r.deleteAttachments!="function")throw new j("invalid-layer","deleteAttachment(): A valid layer is required.");if(!s)throw new j("invalid-graphic","deleteAttachment(): A graphic is required.");const o=r.deleteAttachments(s,[e.id]).then(()=>e),a=await o;return i.remove(a),a}async updateAttachment(e,r=this.activeAttachmentInfo){var h;const{_attachmentLayer:i,attachmentInfos:s,graphic:n,abilities:o}=this;if(!e)throw new j("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!r)throw new j("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:r});if(!((h=o.operations)!=null&&h.update))throw new j("invalid-abilities","updateAttachment(): Update abilities are required.");const a=s.findIndex(p=>p===r);if(!i||typeof i.updateAttachment!="function")throw new j("invalid-layer","updateAttachment(): A valid layer is required.");if(!n)throw new j("invalid-graphic","updateAttachment(): A graphic is required.");const l=i.updateAttachment(n,r.id,e).then(p=>this._queryAttachment(p.objectId)),c=await l;return s.splice(a,1,c),c}async commitFiles(){return await Promise.all(this.fileInfos.items.map(e=>this.addAttachment(e.form))),this.fileInfos.removeAll(),this.getAttachments()}addFile(e,r){if(!e||!r)return null;const i={file:e,form:r};return this.fileInfos.add(i),i}updateFile(e,r,i=this.activeFileInfo){if(!e||!r||!i)return null;const s=this.fileInfos.findIndex(n=>i===n);return s>-1&&this.fileInfos.splice(s,1,{file:e,form:r}),this.fileInfos.items[s]}deleteFile(e){const r=this.fileInfos.find(i=>i.file===e);return r?(this.fileInfos.remove(r),r):null}async _queryAttachment(e,r){const{_attachmentLayer:i}=this;if(!e||!(i!=null&&i.queryAttachments))throw new j("invalid-attachment-id","Could not query attachment.");const s=this._getObjectId(r),n=new z7({objectIds:[s],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return i.queryAttachments(n).then(o=>o[s][0])}_getObjectId(e=this.graphic){return(e==null?void 0:e.getObjectId())??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:e}=this,r=E_e(e);this._attachmentLayer=r?r.type==="scene"&&v(r.associatedLayer)?r.associatedLayer:r:null}};u([d()],oc.prototype,"abilities",void 0),u([Gt("abilities")],oc.prototype,"castAbilities",null),u([d()],oc.prototype,"activeAttachmentInfo",void 0),u([d()],oc.prototype,"activeFileInfo",void 0),u([d({readOnly:!0,type:$_e})],oc.prototype,"attachmentInfos",void 0),u([d()],oc.prototype,"fileInfos",void 0),u([d({type:Sa})],oc.prototype,"graphic",void 0),u([d()],oc.prototype,"mode",void 0),u([d({readOnly:!0})],oc.prototype,"state",null),u([d()],oc.prototype,"filesEnabled",void 0),u([d({readOnly:!0})],oc.prototype,"supportsResizeAttachments",null),oc=u([P("esri.widgets.Attachments.AttachmentsViewModel")],oc);const UY=oc;function ore(t){const e=t.toLowerCase();return e==="image/bmp"||e==="image/emf"||e==="image/exif"||e==="image/gif"||e==="image/x-icon"||e==="image/jpeg"||e==="image/png"||e==="image/tiff"||e==="image/x-wmf"}function cze(t){const e=Kr("esri/themes/base/images/files/");return t?t==="text/plain"?`${e}text-32.svg`:t==="application/pdf"?`${e}pdf-32.svg`:t==="text/csv"?`${e}csv-32.svg`:t==="application/gpx+xml"?`${e}gpx-32.svg`:t==="application/x-dwf"?`${e}cad-32.svg`:t==="application/postscript"||t==="application/json"||t==="text/xml"||t==="model/vrml"?`${e}code-32.svg`:t==="application/x-zip-compressed"||t==="application/x-7z-compressed"||t==="application/x-gzip"||t==="application/x-tar"||t==="application/x-gtar"||t==="application/x-bzip2"||t==="application/gzip"||t==="application/x-compress"||t==="application/x-apple-diskimage"||t==="application/x-rar-compressed"||t==="application/zip"?`${e}zip-32.svg`:t.includes("image/")?`${e}image-32.svg`:t.includes("audio/")?`${e}sound-32.svg`:t.includes("video/")?`${e}video-32.svg`:t.includes("msexcel")||t.includes("ms-excel")||t.includes("spreadsheetml")?`${e}excel-32.svg`:t.includes("msword")||t.includes("ms-word")||t.includes("wordprocessingml")?`${e}word-32.svg`:t.includes("powerpoint")||t.includes("presentationml")?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}function rl(t){return(e,r)=>{e.hasOwnProperty("_messageBundleProps")||(e._messageBundleProps=e._messageBundleProps?e._messageBundleProps.slice():[]),e._messageBundleProps.push({bundlePath:t,propertyName:r})}}var uze=function(t){return{vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}},L_e=function(t,e){for(var r=0,i=t.length;r<i;r++){var s=t[r];Array.isArray(s)?L_e(s,e):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=uze(s)),e.push(s))}},hze=function(t,e){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(r.length===1&&typeof r[0]=="string")return{vnodeSelector:t,properties:e||void 0,children:void 0,text:r[0],domNode:null};var s=[];return L_e(r,s),{vnodeSelector:t,properties:e||void 0,children:s,text:void 0,domNode:null}};function Q(t,e,...r){return typeof t!="function"||LY(t)?hze(t,e,...r):t(e,...r)}const are={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},li="esri-attachments",kv="esri-button",qe={base:li,loaderContainer:`${li}__loader-container`,loader:`${li}__loader`,fadeIn:`${li}--fade-in`,container:`${li}__container`,containerList:`${li}__container--list`,containerPreview:`${li}__container--preview`,actions:`${li}__actions`,deleteButton:`${li}__delete-button`,addAttachmentButton:`${li}__add-attachment-button`,errorMessage:`${li}__error-message`,items:`${li}__items`,item:`${li}__item`,itemButton:`${li}__item-button`,itemMask:`${li}__item-mask`,itemMaskIcon:`${li}__item-mask--icon`,itemImage:`${li}__image`,itemImageResizable:`${li}__image--resizable`,itemLabel:`${li}__label`,itemFilename:`${li}__filename`,itemChevronIcon:`${li}__item-chevron-icon`,itemLink:`${li}__item-link`,itemLinkOverlay:`${li}__item-link-overlay`,itemLinkOverlayIcon:`${li}__item-link-overlay-icon`,itemEditIcon:`${li}__item-edit-icon`,itemAddIcon:`${li}__item-add-icon`,itemAddButton:`${li}__item-add-button`,formNode:`${li}__form-node`,fileFieldset:`${li}__file-fieldset`,fileLabel:`${li}__file-label`,fileName:`${li}__file-name`,fileInput:`${li}__file-input`,metadata:`${li}__metadata`,metadataFieldset:`${li}__metadata-fieldset`,progressBar:`${li}__progress-bar`,esriWidget:"esri-widget",esriButton:kv,buttonDisabled:`${kv}--disabled`,esriButtonSecondary:`${kv}--secondary`,esriButtonTertiary:`${kv}--tertiary`,esriButtonThird:`${kv}--third`,esriButtonSmall:`${kv}--small`,esriButtonHalf:`${kv}--half`,empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},e8=window.CSS;let za=class extends Ma{constructor(e,r){super(e,r),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...are},this._supportsImageOrientation=e8&&e8.supports&&e8.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.viewModel||(this.viewModel=new UY),this.addHandles([an(()=>{var e;return(e=this.viewModel)==null?void 0:e.attachmentInfos},"change",()=>this.scheduleRender()),an(()=>{var e;return(e=this.viewModel)==null?void 0:e.fileInfos},"change",()=>this.scheduleRender()),ne(()=>{var e;return(e=this.viewModel)==null?void 0:e.mode},()=>this._modeChanged(),kt)])}loadDependencies(){return Promise.all([ie(()=>import("./calcite-icon-30f39d3e.js"),["./calcite-icon-30f39d3e.js","./icon-eb8ea09d.js","./observers-4f67f1fb.js"],import.meta.url)])}get abilities(){return this.viewModel.abilities}set abilities(e){this.viewModel.abilities=e}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}castVisibleElements(e){return{...are,...e}}addAttachment(){const{_addAttachmentForm:e,viewModel:r}=this;return this._set("submitting",!0),this._set("error",null),r.addAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),r.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new j("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(e){const{viewModel:r}=this;return this._set("submitting",!0),this._set("error",null),r.deleteAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),r.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new j("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:r}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(r).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new j("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}addFile(){const e=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",e}updateFile(){const{viewModel:e}=this,r=e.updateFile(this.selectedFile,this._updateAttachmentForm,e.activeFileInfo);return e.mode="view",r}deleteFile(e){var i;const r=this.viewModel.deleteFile(e||((i=this.viewModel.activeFileInfo)==null?void 0:i.file));return this.viewModel.mode="view",r}render(){const{submitting:e,viewModel:r}=this,{state:i}=r;return Q("div",{class:this.classes(qe.base,qe.esriWidget)},e?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:r}=this;return e&&r.errorMessage?Q("div",{key:"error-message",class:qe.errorMessage},e.message):null}renderAttachments(){const{activeFileInfo:e,mode:r,activeAttachmentInfo:i}=this.viewModel;return r==="add"?this.renderAddForm():r==="edit"?this.renderDetailsForm(i||e):this.renderAttachmentContainer()}renderLoading(){return Q("div",{class:qe.loaderContainer,key:"loader"},Q("div",{class:qe.loader}))}renderProgressBar(){return this.visibleElements.progressBar?Q("div",{class:qe.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:r}=this,i=e||!r,s=this.visibleElements.cancelAddButton?Q("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(qe.esriButton,qe.esriButtonTertiary,qe.esriButtonSmall,qe.esriButtonHalf,e&&qe.buttonDisabled)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?Q("button",{type:"submit",disabled:i,class:this.classes(qe.esriButton,qe.esriButtonSecondary,qe.esriButtonSmall,qe.esriButtonHalf,{[qe.buttonDisabled]:i})},this.messages.add):null,o=r?Q("span",{key:"file-name",class:qe.fileName},r.name):null,a=Q("form",{bind:this,afterCreate:CF,afterRemoved:Bte,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},Q("fieldset",{class:qe.fileFieldset},o,Q("label",{class:this.classes(qe.fileLabel,qe.esriButton,qe.esriButtonSecondary)},r?this.messages.changeFile:this.messages.selectFile,Q("input",{class:qe.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,s);return Q("div",{key:"add-form-container",class:qe.formNode},a)}renderDetailsForm(e){var E,O,R;const{visibleElements:r,viewModel:i,selectedFile:s,submitting:n}=this,{abilities:o}=i,a=n||!s;let l,c,h,p;s?(l=s.type,c=s.name,h=s.size):e&&"file"in e?(l=e.file.type,c=e.file.name,h=e.file.size):e&&"contentType"in e&&(l=e.contentType,c=e.name,h=e.size,p=e.url);const f=o.editing&&((E=o.operations)!=null&&E.delete)&&r.deleteButton?Q("button",{key:"delete-button",type:"button",disabled:n,bind:this,onclick:L=>this._submitDeleteAttachment(L,e),class:this.classes(qe.esriButton,qe.esriButtonSmall,qe.esriButtonTertiary,qe.deleteButton,{[qe.buttonDisabled]:n})},this.messages.delete):void 0,m=o.editing&&((O=o.operations)!=null&&O.update)&&r.updateButton?Q("button",{disabled:a,key:"update-button",type:"submit",class:this.classes(qe.esriButton,qe.esriButtonSmall,qe.esriButtonThird,{[qe.buttonDisabled]:a})},this.messages.update):void 0,y=this.visibleElements.cancelUpdateButton?Q("button",{disabled:n,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(qe.esriButton,qe.esriButtonSmall,qe.esriButtonTertiary,qe.esriButtonThird,{[qe.buttonDisabled]:n})},this.messages.cancel):void 0,_=o.editing&&((R=o.operations)!=null&&R.update)?Q("fieldset",{key:"file",class:qe.fileFieldset},Q("span",{key:"file-name",class:qe.fileName},c),Q("label",{class:this.classes(qe.fileLabel,qe.esriButton,qe.esriButtonSecondary)},this.messages.changeFile,Q("input",{class:qe.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):void 0,b=Q("fieldset",{key:"size",class:qe.metadataFieldset},Q("label",null,Ake(this.messagesUnits,h??0))),x=Q("fieldset",{key:"content-type",class:qe.metadataFieldset},Q("label",null,l)),T=v(p)?Q("a",{class:qe.itemLink,href:p,rel:"noreferrer",target:"_blank"},this.renderImageMask(e,400),Q("div",{class:qe.itemLinkOverlay},Q("span",{class:qe.itemLinkOverlayIcon},Q("calcite-icon",{icon:"launch"})))):this.renderImageMask(e,400),S=Q("form",{bind:this,afterCreate:CF,afterRemoved:Bte,"data-node-ref":"_updateAttachmentForm",onsubmit:L=>this._submitUpdateAttachment(L,e)},Q("div",{class:qe.metadata},b,x),_,Q("div",{class:qe.actions},f,y,m));return Q("div",{key:"edit-form-container",class:qe.formNode},T,S)}renderImageMask(e,r){return e?"file"in e?this.renderGenericImageMask(e.file.name,e.file.type):this.renderImageMaskForAttachment(e,r):null}renderGenericImageMask(e,r){const{supportsResizeAttachments:i}=this.viewModel,s=cze(r),n={[qe.itemImageResizable]:i};return Q("div",{class:this.classes(qe.itemMaskIcon,qe.itemMask)},Q("img",{title:e,alt:e,src:s,class:this.classes(n,qe.itemImage)}))}renderImageMaskForAttachment(e,r){const{supportsResizeAttachments:i}=this.viewModel;if(!e)return null;const{contentType:s,name:n,url:o}=e;if(!i||!ore(s))return this.renderGenericImageMask(n,s);const a=this._getCSSTransform(e),l=a?{transform:a,"image-orientation":"none"}:{},c=`${o}${o!=null&&o.includes("?")?"&":"?"}w=${r}`,h={[qe.itemImageResizable]:i};return Q("div",{class:this.classes(qe.itemMask)},Q("img",{styles:l,alt:n,title:n,src:c,class:this.classes(h,qe.itemImage)}))}renderFile(e){const{file:r}=e;return Q("li",{class:qe.item,key:r},Q("button",{key:"details-button",bind:this,class:qe.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,onclick:()=>this._startEditFile(e),type:"button"},this.renderImageMask(e),Q("label",{class:qe.itemLabel},Q("span",{class:qe.itemFilename},r.name||this.messages.noTitle),Q("span",{"aria-hidden":"true",class:this.classes(qe.itemChevronIcon,qf(this.container)?qe.iconLeft:qe.iconRight)}))))}renderAttachmentInfo({attachmentInfo:e,displayType:r}){const{viewModel:i,effectiveDisplayType:s}=this,{abilities:n,supportsResizeAttachments:o}=i,{contentType:a,name:l,url:c}=e,h=this.renderImageMask(e,r==="list"?48:400),p=n.editing?Q("span",{"aria-hidden":"true",class:this.classes(qe.itemChevronIcon,qf(this.container)?qe.iconLeft:qe.iconRight)}):null,f=[h,s==="preview"&&o&&ore(a)?null:Q("label",{class:qe.itemLabel},Q("span",{class:qe.itemFilename},l||this.messages.noTitle),p)],m=n.editing?Q("button",{key:"details-button",bind:this,class:qe.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},f):Q("a",{key:"details-link",class:qe.itemButton,href:c??void 0,target:"_blank"},f);return Q("li",{class:qe.item,key:e},m)}renderAttachmentContainer(){var y;const{effectiveDisplayType:e,viewModel:r,visibleElements:i}=this,{attachmentInfos:s,abilities:n,fileInfos:o}=r,a=!!(s!=null&&s.length),l=!!(o!=null&&o.length),c={[qe.containerList]:e!=="preview",[qe.containerPreview]:e==="preview"},h=n.editing&&((y=n.operations)!=null&&y.add)&&i.addButton?Q("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(qe.esriButton,qe.esriButtonTertiary,qe.addAttachmentButton),type:"button"},Q("span",{"aria-hidden":"true",class:this.classes(qe.itemAddIcon,qe.iconPlus)}),this.messages.add):void 0,p=a?Q("ul",{key:"attachments-list",class:qe.items},s.toArray().map(_=>this.renderAttachmentInfo({attachmentInfo:_,displayType:e}))):void 0,f=l?Q("ul",{key:"file-list",class:qe.items},o.toArray().map(_=>this.renderFile(_))):void 0,m=l||a?void 0:Q("div",{class:qe.empty},this.messages.noAttachments);return Q("div",{key:"attachments-container",class:this.classes(qe.container,c)},p,f,m,h)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const r=e.target,i=r&&r.files&&r.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,r){e.preventDefault(),r&&("file"in r?this.deleteFile(r.file):r&&this.deleteAttachment(r))}_submitAddAttachment(e){e.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(e,r){e.preventDefault(),r&&"file"in r?this.updateFile():this.updateAttachment()}_startEditAttachment(e){const{viewModel:r}=this;r.activeFileInfo=null,r.activeAttachmentInfo=e,r.mode="edit"}_startEditFile(e){const{viewModel:r}=this;r.activeAttachmentInfo=null,r.activeFileInfo=e,r.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e){const{orientationInfo:r}=e;return!this._supportsImageOrientation&&r?[r.rotation?`rotate(${r.rotation}deg)`:"",r.mirrored?"scaleX(-1)":""].join(" "):""}};u([d()],za.prototype,"abilities",null),u([d()],za.prototype,"displayType",void 0),u([d({readOnly:!0})],za.prototype,"effectiveDisplayType",null),u([d()],za.prototype,"graphic",null),u([d()],za.prototype,"label",null),u([d(),rl("esri/widgets/Attachments/t9n/Attachments")],za.prototype,"messages",void 0),u([d(),rl("esri/core/t9n/Units")],za.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],za.prototype,"selectedFile",void 0),u([d({readOnly:!0})],za.prototype,"submitting",void 0),u([d({readOnly:!0})],za.prototype,"error",void 0),u([d({type:UY})],za.prototype,"viewModel",void 0),u([d()],za.prototype,"visibleElements",void 0),u([Gt("visibleElements")],za.prototype,"castVisibleElements",null),za=u([P("esri.widgets.Attachments")],za);const dze=za;let dR=class extends UY{constructor(e){super(e),this.description=null,this.title=null}};u([d()],dR.prototype,"description",void 0),u([d()],dR.prototype,"title",void 0),dR=u([P("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],dR);const VY=dR,pze={heading:"esri-widget__heading"};function kY({level:t,class:e,...r},i){const s=fze(t);return Q(`h${s}`,{...r,class:Z0e(pze.heading,e),role:"heading","aria-level":String(s)},i)}function fze(t){return ye(Math.ceil(t),1,6)}const t8="esri-feature-element-info",r8={base:t8,title:`${t8}__title`,description:`${t8}__description`};let WT=class extends Ma{constructor(e,r){super(e,r),this.description=null,this.headingLevel=2,this.title=null}render(){return Q("div",{class:r8.base},this.renderTitle(),this.renderDescription())}renderTitle(){const{title:e}=this;return e?Q(kY,{level:this.headingLevel,class:r8.title},e):null}renderDescription(){const{description:e}=this;return e?Q("div",{key:"description",class:r8.description},e):null}};u([d()],WT.prototype,"description",void 0),u([d()],WT.prototype,"headingLevel",void 0),u([d()],WT.prototype,"title",void 0),WT=u([P("esri.widgets.Feature.support.FeatureElementInfo")],WT);const G5=WT,mze={base:"esri-feature-attachments"};let ff=class extends Ma{constructor(e,r){super(e,r),this._featureElementInfo=null,this.attachmentsWidget=new dze,this.headingLevel=2,this.viewModel=new VY}initialize(){this._featureElementInfo=new G5,this.addHandles([ne(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.description,(r=this.viewModel)==null?void 0:r.title,this.headingLevel]},()=>this._setupFeatureElementInfo(),kt),ne(()=>this.viewModel,e=>this.attachmentsWidget.viewModel=e,kt)])}destroy(){var e;this.attachmentsWidget.destroy(),(e=this._featureElementInfo)==null||e.destroy()}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get displayType(){return this.attachmentsWidget.displayType}set displayType(e){this.attachmentsWidget.displayType=e}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var r;const{attachmentsWidget:e}=this;return Q("div",{class:mze.base},(r=this._featureElementInfo)==null?void 0:r.render(),e==null?void 0:e.render())}_setupFeatureElementInfo(){var s;const{description:e,title:r,headingLevel:i}=this;(s=this._featureElementInfo)==null||s.set({description:e,title:r,headingLevel:i})}};u([d({readOnly:!0})],ff.prototype,"attachmentsWidget",void 0),u([d()],ff.prototype,"description",null),u([d()],ff.prototype,"displayType",null),u([d()],ff.prototype,"graphic",null),u([d()],ff.prototype,"headingLevel",void 0),u([d()],ff.prototype,"title",null),u([d({type:VY})],ff.prototype,"viewModel",void 0),ff=u([P("esri.widgets.Feature.FeatureAttachments")],ff);const gze=ff;let F0=class extends ux(Te){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(ne(()=>this.creator,r=>{this._destroyContent(),this._createContent(r)},kt))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:r,destroyer:i}=this;e&&r&&(IF(i,{graphic:r}).catch(()=>null),this._set("created",null))}async _createContent(e){const r=this.graphic;if(!r||!e)return;const i=IF(e,{graphic:r}).catch(()=>null);this._loadingPromise=i,this.notifyChange("state");const s=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",s))}};u([d({readOnly:!0})],F0.prototype,"created",void 0),u([d()],F0.prototype,"creator",void 0),u([d()],F0.prototype,"destroyer",void 0),u([d({type:Sa})],F0.prototype,"graphic",void 0),u([d({readOnly:!0})],F0.prototype,"state",null),F0=u([P("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],F0);const $F=F0;function bh(){return function(t,e){if(!t[e])throw new TypeError(`Cannot auto bind undefined function '${e}'`);return{value:_ze(t[e])}}}function yze(t){const e=t==null?void 0:t.type;return t instanceof KeyboardEvent||e==="keyup"||e==="keydown"||e==="keypress"}function _ze(t){return function(e,...r){yze(e)?RVe(e.key)&&(e.preventDefault(),e.stopPropagation(),e.target.click()):t.call(this,e,...r)}}function vze(t){return e=>{e.hasOwnProperty("_delegatedEventNames")||(e._delegatedEventNames=e._delegatedEventNames?e._delegatedEventNames.slice():[]);const r=e._delegatedEventNames,i=Array.isArray(t)?t:bze(t);r.push(...i)}}function bze(t){return t.split(",").map(e=>e.trim())}const D_e="calcite-mode-";function wze(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-mode-name").replace(/\s|'|"/g,"")}function LF(){return wze().startsWith("dark")}function xze(){return`${D_e}${LF()?"dark":"light"}`}function Tze(t){Sze(t),t.classList.add(xze())}function Sze(t){Array.from(t.classList).forEach(e=>{e.startsWith(D_e)&&t.classList.remove(e)})}function N_e(t){return t&&typeof t.render=="function"}function Eze(t){return t&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}const i8="esri-feature-content",s8={base:i8,loaderContainer:`${i8}__loader-container`,loader:`${i8}__loader`};let XT=class extends Ma{constructor(e,r){super(e,r),this.viewModel=null,this._addTargetToAnchors=i=>{Array.from(i.querySelectorAll("a")).forEach(s=>{C_e(s.href)&&!s.hasAttribute("target")&&s.setAttribute("target","_blank")})}}get creator(){var e;return(e=this.viewModel)==null?void 0:e.creator}set creator(e){this.viewModel&&(this.viewModel.creator=e)}get graphic(){var e;return(e=this.viewModel)==null?void 0:e.graphic}set graphic(e){this.viewModel&&(this.viewModel.graphic=e)}renderLoading(){return Q("div",{class:s8.loaderContainer,key:"loader"},Q("div",{class:s8.loader}))}renderCreated(){var r;const e=(r=this.viewModel)==null?void 0:r.created;return e?e instanceof HTMLElement?Q("div",{key:e,bind:e,afterCreate:this._attachToNode}):N_e(e)?Q("div",{key:e},!e.destroyed&&e.render()):Q("div",{key:e,innerHTML:e,afterCreate:this._addTargetToAnchors}):null}render(){var r;const e=(r=this.viewModel)==null?void 0:r.state;return Q("div",{class:s8.base},e==="loading"?this.renderLoading():this.renderCreated())}_attachToNode(e){const r=this;e.appendChild(r)}};u([d()],XT.prototype,"creator",null),u([d()],XT.prototype,"graphic",null),u([d({type:$F})],XT.prototype,"viewModel",void 0),XT=u([P("esri.widgets.Feature.FeatureContent")],XT);const cD=XT;let cg=class extends Te{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:r}=this,i=[];return r==null||r.forEach(s=>{if(!(!s.hasOwnProperty("visible")||s.visible))return;const n=s.clone();n.label=A_e(n,e),i.push(n)}),i}};u([d()],cg.prototype,"attributes",void 0),u([d({type:[Zme]})],cg.prototype,"expressionInfos",void 0),u([d()],cg.prototype,"description",void 0),u([d({type:[IM]})],cg.prototype,"fieldInfos",void 0),u([d({readOnly:!0})],cg.prototype,"formattedFieldInfos",null),u([d()],cg.prototype,"title",void 0),cg=u([P("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],cg);const j5=cg,Cze=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function Aze(t){let e=null;return Cze.some(r=>(r.pattern.test(t)&&(e=r),!!e)),e}function Rze(t,e){if(typeof e!="string"||!e)return e;const r=Aze(e);if(!r)return e;const i=e.match(r.pattern),s=i&&i[2],n=om(om(r.label,{messages:t,hierPart:s}),{appName:r.appName}),o=r.target?` target="${r.target}"`:"",a=r.target==="_blank"?' rel="noreferrer"':"";return e.replace(r.pattern,`<a${o} href="$1"${a}>${n}</a>`)}const sI="esri-feature-fields",NC={base:sI,fieldHeader:`${sI}__field-header`,fieldData:`${sI}__field-data`,fieldDataDate:`${sI}__field-data--date`,esriTable:"esri-widget__table"};let Rd=class extends Ma{constructor(e,r){super(e,r),this._featureElementInfo=null,this.viewModel=new j5,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new G5,this.addHandles(ne(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.description,(r=this.viewModel)==null?void 0:r.title]},()=>this._setupFeatureElementInfo(),kt))}destroy(){var e;(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get expressionInfos(){return this.viewModel.expressionInfos}set expressionInfos(e){this.viewModel.expressionInfos=e}get fieldInfos(){return this.viewModel.fieldInfos}set fieldInfos(e){this.viewModel.fieldInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}renderFieldInfo(e,r){const{attributes:i}=this.viewModel,s=e.fieldName,n=e.label||s,o=i?i[s]==null?"":i[s]:"",a=!(!e.format||!e.format.dateFormat),l=typeof o=="number"&&!a?this._forceLTR(o):Rze(this.messagesURIUtils,o),c={[NC.fieldDataDate]:a};return Q("tr",{key:`fields-element-info-row-${s}-${r}`},Q("th",{key:`fields-element-info-row-header-${s}-${r}`,class:NC.fieldHeader,innerHTML:n}),Q("td",{key:`fields-element-info-row-data-${s}-${r}`,class:this.classes(NC.fieldData,c),innerHTML:l}))}renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e!=null&&e.length?Q("table",{class:NC.esriTable,summary:this.messages.fieldsSummary},Q("tbody",null,e.map((r,i)=>this.renderFieldInfo(r,i)))):null}render(){var e;return Q("div",{class:NC.base},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderFields())}_setupFeatureElementInfo(){var i;const{description:e,title:r}=this;(i=this._featureElementInfo)==null||i.set({description:e,title:r})}_forceLTR(e){return`&lrm;${e}`}};u([d()],Rd.prototype,"attributes",null),u([d()],Rd.prototype,"description",null),u([d()],Rd.prototype,"expressionInfos",null),u([d()],Rd.prototype,"fieldInfos",null),u([d()],Rd.prototype,"title",null),u([d({type:j5,nonNullable:!0})],Rd.prototype,"viewModel",void 0),u([d(),rl("esri/widgets/Feature/t9n/Feature")],Rd.prototype,"messages",void 0),u([d(),rl("esri/widgets/support/t9n/uriUtils")],Rd.prototype,"messagesURIUtils",void 0),Rd=u([P("esri.widgets.Feature.FeatureFields")],Rd);const F_e=Rd,Oze={maximumFractionDigits:20};function Mze(t){return fm(t,Oze)}var H7;let G1=H7=class extends fe{constructor(t){super(t),this.color=null,this.label=null,this.value=null}writeValue(t,e,r){e[r]=t??0}clone(){return new H7({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:Ze,json:{type:[Ti],write:!0}})],G1.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],G1.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],G1.prototype,"value",void 0),u([ke("value")],G1.prototype,"writeValue",null),G1=H7=u([P("esri.renderers.visualVariables.support.ColorStop")],G1);const Pze=G1;function zM(){const t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Ize(t){const e=new Float32Array(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function $ze(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_){const b=new Float32Array(16);return b[0]=t,b[1]=e,b[2]=r,b[3]=i,b[4]=s,b[5]=n,b[6]=o,b[7]=a,b[8]=l,b[9]=c,b[10]=h,b[11]=p,b[12]=f,b[13]=m,b[14]=y,b[15]=_,b}function Lze(t,e){return new Float32Array(t,e,16)}const Dze=zM();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:Dze,clone:Ize,create:zM,createView:Lze,fromValues:$ze},Symbol.toStringTag,{value:"Module"}));const Nze=(t,e)=>{const r=Tm(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);return kc(r,r)},Fze=(t,e)=>{const r=Tm(t,e,0,0,.5-.5*e,0,e,0,.5-.5*e,0,0,e,.5-.5*e,0,0,0,1);return kc(r,r)},Uze=(t,e)=>{const r=1-e,i=Tm(t,.2126+.7874*r,.7152-.7152*r,.0722-.0722*r,0,.2126-.2126*r,.7152+.2848*r,.0722-.0722*r,0,.2126-.2126*r,.7152-.7152*r,.0722+.9278*r,0,0,0,0,1);return kc(i,i)},Vze=(t,e)=>{const r=Math.sin(e*Math.PI/180),i=Math.cos(e*Math.PI/180),s=Tm(t,.213+.787*i-.213*r,.715-.715*i-.715*r,.072-.072*i+.928*r,0,.213-.213*i+.143*r,.715+.285*i+.14*r,.072-.072*i-.283*r,0,.213-.213*i-.787*r,.715-.715*i+.715*r,.072+.928*i+.072*r,0,0,0,0,1);return kc(s,s)},kze=(t,e)=>{const r=1-2*e,i=Tm(t,r,0,0,e,0,r,0,e,0,0,r,e,0,0,0,1);return kc(i,i)},zze=(t,e)=>{const r=Tm(t,.213+.787*e,.715-.715*e,.072-.072*e,0,.213-.213*e,.715+.285*e,.072-.072*e,0,.213-.213*e,.715-.715*e,.072+.928*e,0,0,0,0,1);return kc(r,r)},Bze=(t,e)=>{const r=1-e,i=Tm(t,.393+.607*r,.769-.769*r,.189-.189*r,0,.349-.349*r,.686+.314*r,.168-.168*r,0,.272-.272*r,.534-.534*r,.131+.869*r,0,0,0,0,1);return kc(i,i)};let U_e=class V_e{constructor(e,r,i){this.strength=e,this.radius=r,this.threshold=i,this.type="bloom"}interpolate(e,r,i){this.strength=bc(e.strength,r.strength,i),this.radius=bc(e.radius,r.radius,i),this.threshold=bc(e.threshold,r.threshold,i)}clone(){return new V_e(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:bO(this.radius),strength:this.strength,threshold:this.threshold}}},k_e=class z_e{constructor(e){this.radius=e,this.type="blur"}interpolate(e,r,i){this.radius=Math.round(bc(e.radius,r.radius,i))}clone(){return new z_e(this.radius)}toJSON(){return{type:"blur",radius:bO(this.radius)}}},q7=class B_e{constructor(e,r){this.type=e,this.amount=r,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,r,i){this.amount=bc(e.amount,r.amount,i),this._updateMatrix()}clone(){return new B_e(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const e=this._colorMatrix||zM();switch(this.type){case"brightness":this._colorMatrix=Nze(e,this.amount);break;case"contrast":this._colorMatrix=Fze(e,this.amount);break;case"grayscale":this._colorMatrix=Uze(e,this.amount);break;case"invert":this._colorMatrix=kze(e,this.amount);break;case"saturate":this._colorMatrix=zze(e,this.amount);break;case"sepia":this._colorMatrix=Bze(e,this.amount)}}},G_e=class j_e{constructor(e,r,i,s){this.offsetX=e,this.offsetY=r,this.blurRadius=i,this.color=s,this.type="drop-shadow"}interpolate(e,r,i){this.offsetX=bc(e.offsetX,r.offsetX,i),this.offsetY=bc(e.offsetY,r.offsetY,i),this.blurRadius=bc(e.blurRadius,r.blurRadius,i),this.color[0]=Math.round(bc(e.color[0],r.color[0],i)),this.color[1]=Math.round(bc(e.color[1],r.color[1],i)),this.color[2]=Math.round(bc(e.color[2],r.color[2],i)),this.color[3]=bc(e.color[3],r.color[3],i)}clone(){return new j_e(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const e=[...this.color];return e[3]*=255,{type:"drop-shadow",xoffset:bO(this.offsetX),yoffset:bO(this.offsetY),blurRadius:bO(this.blurRadius),color:e}}},H_e=class q_e{constructor(e){this.angle=e,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,r,i){this.angle=bc(e.angle,r.angle,i),this._updateMatrix()}clone(){return new q_e(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const e=this._colorMatrix||zM();this._colorMatrix=Vze(e,this.angle)}},W_e=class X_e{constructor(e){this.amount=e,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(e,r,i){this.amount=bc(e.amount,r.amount,i)}clone(){return new X_e(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}};function bc(t,e,r){return t+(e-t)*r}function bO(t){return Math.round(1e3*Yh(t))/1e3}function Gze(t){switch(t.type){case"grayscale":case"sepia":case"invert":return new q7(t.type,0);case"saturate":case"brightness":case"contrast":return new q7(t.type,1);case"opacity":return new W_e(1);case"hue-rotate":return new H_e(0);case"blur":return new k_e(0);case"drop-shadow":return new G_e(0,0,0,[...HW("transparent")]);case"bloom":return new U_e(0,0,1)}}function jze(t,e){const r=t.length>e.length?t:e;return(t.length>e.length?e:t).every((i,s)=>i.type===r[s].type)}function Hze(t,e){const r=t.length>e.length?t:e,i=t.length>e.length?e:t;for(let s=i.length;s<r.length;s++)i.push(Gze(r[s]))}function qze(t){const e=t[0];return!!e&&"type"in e}var lre,cre,W7={};function Y_e(t){if(!t||t.length===0)return null;if(typeof t=="string"){const r=ure(t);return r&&r.length!==0?r:null}const e=t.map(r=>{if(!Number.isFinite(r.scale)||r.scale<=0)throw new j("effect:invalid-scale","scale must be finite and greater than 0",{stop:r});return{scale:r.scale,effects:ure(r.value)}});e.sort((r,i)=>i.effects.length-r.effects.length);for(let r=0;r<e.length-1;r++){if(!jze(e[r].effects,e[r+1].effects))throw new j("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:e[r].effects,b:e[r+1].effects});Hze(e[r].effects,e[r+1].effects)}return e.sort((r,i)=>i.scale-r.scale),e}function ure(t){let e;if(!t)return[];try{e=W7.parse(t)}catch(r){throw new j("effect:invalid-syntax","Invalid effect syntax",{value:t,error:r})}return e.map(r=>Wze(r))}function Wze(t){try{switch(t.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return Xze(t);case"opacity":return Yze(t);case"hue-rotate":return Zze(t);case"blur":return Jze(t);case"drop-shadow":return Kze(t);case"bloom":return Qze(t)}}catch(e){throw e.details.filter=t,e}throw new j("effect:unknown-effect",`Effect '${t.name}' is not supported`,{effect:t})}function Xze(t){let e=1;return eC(t.parameters,1),t.parameters.length===1&&(e=qd(t.parameters[0])),new q7(t.name,e)}function Yze(t){let e=1;return eC(t.parameters,1),t.parameters.length===1&&(e=qd(t.parameters[0])),new W_e(e)}function Zze(t){let e=0;return eC(t.parameters,1),t.parameters.length===1&&(e=nBe(t.parameters[0])),new H_e(e)}function Jze(t){let e=0;return eC(t.parameters,1),t.parameters.length===1&&(e=GY(t.parameters[0]),BM(e,t.parameters[0])),new k_e(e)}function Kze(t){const e=[];let r=null;for(const i of t.parameters)if(i.type==="color"){if(e.length&&Object.freeze(e),r)throw new j("effect:type-error","Accepts only one color",{});r=oBe(i)}else{const s=GY(i);if(Object.isFrozen(e))throw new j("effect:type-error","<length> parameters not consecutive",{lengths:e});e.push(s),e.length===3&&BM(s,i)}if(e.length<2||e.length>3)throw new j("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${e.length}}`,{lengths:e});return new G_e(e[0],e[1],e[2]||0,r||Z_e("black"))}function Qze(t){let e=1,r=0,i=0;return eC(t.parameters,3),t.parameters[0]&&(e=qd(t.parameters[0])),t.parameters[1]&&(r=GY(t.parameters[1]),BM(r,t.parameters[1])),t.parameters[2]&&(i=qd(t.parameters[2])),new U_e(e,r,i)}function eC(t,e){if(t.length>e)throw new j("effect:type-error",`Function supports up to ${e} parameters, Actual: ${t.length}`,{parameters:t})}function H5(t){if(t.type==="color")return"<color>";if(t.unit){if(BY[t.unit])return"<length>";if(zY[t.unit])return"<angle>";if(t.unit==="%")return"<percentage>"}return"<double>"}function BM(t,e){if(t<0)throw new j("effect:type-error",`Negative values are not allowed, Actual: ${t}`,{term:e})}function eBe(t){if(t.type!=="quantity"||t.unit!==null)throw new j("effect:type-error",`Expected <double>, Actual: ${H5(t)}`,{term:t})}function tBe(t){if(t.type!=="quantity"||t.unit!==null&&t.unit!=="%")throw new j("effect:type-error",`Expected <double> or <percentage>, Actual: ${H5(t)}`,{term:t})}cre=function(){function t(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function e(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,e.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function r(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function i(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:$m},h=$m,p="none",f=")",m=",",y="(",_="%",b="px",x="cm",T="mm",S="in",E="pt",O="pc",R="deg",L="rad",I="grad",U="turn",z="#",B=".",G="e",K=/^[ \t\n\r]/,re=/^[a-z\-]/,ee=/^[0-9a-fA-F]/,q=/^[+\-]/,$=/^[0-9]/,N=cl("none"),F=ss("none",!1),H=ss(")",!1),X=ss(",",!1),J=cl("whitespace"),W=Lv([" ","	",`
`,"\r"],!1,!1),ue=cl("function"),pe=ss("(",!1),we=cl("identifier"),Ce=Lv([["a","z"],"-"],!1,!1),je=cl("percentage"),De=ss("%",!1),xe=cl("length"),Ne=ss("px",!1),Ue=ss("cm",!1),xt=ss("mm",!1),Qe=ss("in",!1),Ut=ss("pt",!1),Xt=ss("pc",!1),er=cl("angle"),Yt=ss("deg",!1),mr=ss("rad",!1),Jr=ss("grad",!1),Sr=ss("turn",!1),xr=cl("number"),it=cl("color"),Je=ss("#",!1),at=Lv([["0","9"],["a","f"],["A","F"]],!1,!1),ut=Lv(["+","-"],!1,!1),St=Lv([["0","9"]],!1,!1),Ht=ss(".",!1),Rr=ss("e",!1),Or=function(){return[]},Mr=function(Y,be){return{type:"function",name:Y,parameters:be||[]}},Pr=function(Y,be){return be.length>0?yC(Y,be,3):[Y]},Ci=function(Y){return{type:"quantity",value:Y.value,unit:Y.unit}},sr=function(Y){return{type:"color",colorType:Y.type,value:Y.value}},wr=function(Y){return Y},gr=function(){return Zl()},xs=function(Y){return{value:Y,unit:"%"}},ni=function(Y){return{value:Y,unit:"px"}},Wi=function(Y){return{value:Y,unit:"cm"}},Ai=function(Y){return{value:Y,unit:"mm"}},ki=function(Y){return{value:Y,unit:"in"}},ds=function(Y){return{value:Y,unit:"pt"}},Us=function(Y){return{value:Y,unit:"pc"}},po=function(Y){return{value:Y,unit:"deg"}},Gn=function(Y){return{value:Y,unit:"rad"}},Ts=function(Y){return{value:Y,unit:"grad"}},Xi=function(Y){return{value:Y,unit:"turn"}},Yi=function(Y){return{value:Y,unit:null}},Ss=function(){return{type:"hex",value:Zl()}},oi=function(Y){return{type:"function",value:Y}},Uo=function(){return{type:"named",value:Zl()}},ll=function(){return parseFloat(Zl())},he=0,yi=0,ad=[{line:1,column:1}],ia=0,qc=[],ht=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function Zl(){return s.substring(yi,he)}function ss(Y,be){return{type:"literal",text:Y,ignoreCase:be}}function Lv(Y,be,Oe){return{type:"class",parts:Y,inverted:be,ignoreCase:Oe}}function sU(){return{type:"end"}}function cl(Y){return{type:"other",description:Y}}function Iy(Y){var be,Oe=ad[Y];if(Oe)return Oe;for(be=Y-1;!ad[be];)be--;for(Oe={line:(Oe=ad[be]).line,column:Oe.column};be<Y;)s.charCodeAt(be)===10?(Oe.line++,Oe.column=1):Oe.column++,be++;return ad[Y]=Oe,Oe}function Im(Y,be){var Oe=Iy(Y),dr=Iy(be);return{source:l,start:{offset:Y,line:Oe.line,column:Oe.column},end:{offset:be,line:dr.line,column:dr.column}}}function tr(Y){he<ia||(he>ia&&(ia=he,qc=[]),qc.push(Y))}function yP(Y,be,Oe){return new e(e.buildMessage(Y,be),Y,be,Oe)}function $m(){var Y;return(Y=$y())===a&&(Y=Ly()),Y}function $y(){var Y,be;return ht++,Y=he,ai(),s.substr(he,4)===p?(be=p,he+=4):(be=a,ht===0&&tr(F)),be!==a?(ai(),yi=Y,Y=Or()):(he=Y,Y=a),ht--,Y===a&&ht===0&&tr(N),Y}function Ly(){var Y,be;if(Y=[],(be=Vo())!==a)for(;be!==a;)Y.push(be),be=Vo();else Y=a;return Y}function Vo(){var Y,be,Oe,dr;return Y=he,ai(),(be=Lp())!==a?(ai(),(Oe=ju())===a&&(Oe=null),ai(),s.charCodeAt(he)===41?(dr=f,he++):(dr=a,ht===0&&tr(H)),dr!==a?(ai(),yi=Y,Y=Mr(be,Oe)):(he=Y,Y=a)):(he=Y,Y=a),Y}function ju(){var Y,be,Oe,dr,jn,Es,hl,Ny;if(Y=he,(be=Hu())!==a){for(Oe=[],dr=he,jn=ai(),s.charCodeAt(he)===44?(Es=m,he++):(Es=a,ht===0&&tr(X)),Es===a&&(Es=null),hl=ai(),(Ny=Hu())!==a?dr=jn=[jn,Es,hl,Ny]:(he=dr,dr=a);dr!==a;)Oe.push(dr),dr=he,jn=ai(),s.charCodeAt(he)===44?(Es=m,he++):(Es=a,ht===0&&tr(X)),Es===a&&(Es=null),hl=ai(),(Ny=Hu())!==a?dr=jn=[jn,Es,hl,Ny]:(he=dr,dr=a);yi=Y,Y=Pr(be,Oe)}else he=Y,Y=a;return Y}function Hu(){var Y,be;return Y=he,(be=gx())===a&&(be=Dv())===a&&(be=yx())===a&&(be=Nv()),be!==a&&(yi=Y,be=Ci(be)),(Y=be)===a&&(Y=he,(be=Dy())!==a&&(yi=Y,be=sr(be)),Y=be),Y}function ai(){var Y,be;for(ht++,Y=[],K.test(s.charAt(he))?(be=s.charAt(he),he++):(be=a,ht===0&&tr(W));be!==a;)Y.push(be),K.test(s.charAt(he))?(be=s.charAt(he),he++):(be=a,ht===0&&tr(W));return ht--,be=a,ht===0&&tr(J),Y}function Lp(){var Y,be,Oe;return ht++,Y=he,(be=Lm())!==a?(s.charCodeAt(he)===40?(Oe=y,he++):(Oe=a,ht===0&&tr(pe)),Oe!==a?(yi=Y,Y=wr(be)):(he=Y,Y=a)):(he=Y,Y=a),ht--,Y===a&&(be=a,ht===0&&tr(ue)),Y}function Lm(){var Y,be,Oe;if(ht++,Y=he,be=[],re.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&tr(Ce)),Oe!==a)for(;Oe!==a;)be.push(Oe),re.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&tr(Ce));else be=a;return be!==a&&(yi=Y,be=gr()),ht--,(Y=be)===a&&(be=a,ht===0&&tr(we)),Y}function gx(){var Y,be,Oe;return ht++,Y=he,ai(),(be=ul())!==a?(s.charCodeAt(he)===37?(Oe=_,he++):(Oe=a,ht===0&&tr(De)),Oe!==a?(yi=Y,Y=xs(be)):(he=Y,Y=a)):(he=Y,Y=a),ht--,Y===a&&ht===0&&tr(je),Y}function Dv(){var Y,be,Oe;return ht++,Y=he,ai(),(be=ul())!==a?(s.substr(he,2)===b?(Oe=b,he+=2):(Oe=a,ht===0&&tr(Ne)),Oe!==a?(yi=Y,Y=ni(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ul())!==a?(s.substr(he,2)===x?(Oe=x,he+=2):(Oe=a,ht===0&&tr(Ue)),Oe!==a?(yi=Y,Y=Wi(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ul())!==a?(s.substr(he,2)===T?(Oe=T,he+=2):(Oe=a,ht===0&&tr(xt)),Oe!==a?(yi=Y,Y=Ai(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ul())!==a?(s.substr(he,2)===S?(Oe=S,he+=2):(Oe=a,ht===0&&tr(Qe)),Oe!==a?(yi=Y,Y=ki(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ul())!==a?(s.substr(he,2)===E?(Oe=E,he+=2):(Oe=a,ht===0&&tr(Ut)),Oe!==a?(yi=Y,Y=ds(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,ai(),(be=ul())!==a?(s.substr(he,2)===O?(Oe=O,he+=2):(Oe=a,ht===0&&tr(Xt)),Oe!==a?(yi=Y,Y=Us(be)):(he=Y,Y=a)):(he=Y,Y=a)))))),ht--,Y===a&&ht===0&&tr(xe),Y}function yx(){var Y,be,Oe;return ht++,Y=he,(be=ul())!==a?(s.substr(he,3)===R?(Oe=R,he+=3):(Oe=a,ht===0&&tr(Yt)),Oe!==a?(yi=Y,Y=po(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,(be=ul())!==a?(s.substr(he,3)===L?(Oe=L,he+=3):(Oe=a,ht===0&&tr(mr)),Oe!==a?(yi=Y,Y=Gn(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,(be=ul())!==a?(s.substr(he,4)===I?(Oe=I,he+=4):(Oe=a,ht===0&&tr(Jr)),Oe!==a?(yi=Y,Y=Ts(be)):(he=Y,Y=a)):(he=Y,Y=a),Y===a&&(Y=he,(be=ul())!==a?(s.substr(he,4)===U?(Oe=U,he+=4):(Oe=a,ht===0&&tr(Sr)),Oe!==a?(yi=Y,Y=Xi(be)):(he=Y,Y=a)):(he=Y,Y=a)))),ht--,Y===a&&(be=a,ht===0&&tr(er)),Y}function Nv(){var Y,be;return ht++,Y=he,ai(),(be=ul())!==a?(yi=Y,Y=Yi(be)):(he=Y,Y=a),ht--,Y===a&&ht===0&&tr(xr),Y}function Dy(){var Y,be,Oe,dr;if(ht++,Y=he,s.charCodeAt(he)===35?(be=z,he++):(be=a,ht===0&&tr(Je)),be!==a){if(Oe=[],ee.test(s.charAt(he))?(dr=s.charAt(he),he++):(dr=a,ht===0&&tr(at)),dr!==a)for(;dr!==a;)Oe.push(dr),ee.test(s.charAt(he))?(dr=s.charAt(he),he++):(dr=a,ht===0&&tr(at));else Oe=a;Oe!==a?(yi=Y,Y=Ss()):(he=Y,Y=a)}else he=Y,Y=a;return Y===a&&(Y=he,(be=Vo())!==a&&(yi=Y,be=oi(be)),(Y=be)===a&&(Y=he,(be=Lm())!==a&&(yi=Y,be=Uo()),Y=be)),ht--,Y===a&&(be=a,ht===0&&tr(it)),Y}function ul(){var Y,be,Oe,dr,jn,Es,hl;for(Y=he,q.test(s.charAt(he))?(s.charAt(he),he++):ht===0&&tr(ut),be=he,Oe=[],$.test(s.charAt(he))?(dr=s.charAt(he),he++):(dr=a,ht===0&&tr(St));dr!==a;)Oe.push(dr),$.test(s.charAt(he))?(dr=s.charAt(he),he++):(dr=a,ht===0&&tr(St));if(s.charCodeAt(he)===46?(dr=B,he++):(dr=a,ht===0&&tr(Ht)),dr!==a){if(jn=[],$.test(s.charAt(he))?(Es=s.charAt(he),he++):(Es=a,ht===0&&tr(St)),Es!==a)for(;Es!==a;)jn.push(Es),$.test(s.charAt(he))?(Es=s.charAt(he),he++):(Es=a,ht===0&&tr(St));else jn=a;jn!==a?be=Oe=[Oe,dr,jn]:(he=be,be=a)}else he=be,be=a;if(be===a)if(be=[],$.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&tr(St)),Oe!==a)for(;Oe!==a;)be.push(Oe),$.test(s.charAt(he))?(Oe=s.charAt(he),he++):(Oe=a,ht===0&&tr(St));else be=a;if(be!==a){if(Oe=he,s.charCodeAt(he)===101?(dr=G,he++):(dr=a,ht===0&&tr(Rr)),dr!==a){if(q.test(s.charAt(he))?(jn=s.charAt(he),he++):(jn=a,ht===0&&tr(ut)),jn===a&&(jn=null),Es=[],$.test(s.charAt(he))?(hl=s.charAt(he),he++):(hl=a,ht===0&&tr(St)),hl!==a)for(;hl!==a;)Es.push(hl),$.test(s.charAt(he))?(hl=s.charAt(he),he++):(hl=a,ht===0&&tr(St));else Es=a;Es!==a?Oe=dr=[dr,jn,Es]:(he=Oe,Oe=a)}else he=Oe,Oe=a;Oe===a&&(Oe=null),yi=Y,Y=ll()}else he=Y,Y=a;return Y}function _P(Y,be){return Y.map(function(Oe){return Oe[be]})}function yC(Y,be,Oe){return[Y].concat(_P(be,Oe))}if((o=h())!==a&&he===s.length)return o;throw o!==a&&he<s.length&&tr(sU()),yP(qc,ia<s.length?s.charAt(ia):null,ia<s.length?Im(ia,ia+1):Im(ia,ia))}return t(e,Error),e.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source+":"+l.line+":"+l.column;if(a){var h=this.location.end,p=r("",l.line.toString().length," "),f=a[l.line-1],m=(l.line===h.line?h.column:f.length+1)-l.column||1;n+=`
 --> `+c+`
`+p+` |
`+l.line+" | "+f+`
`+p+" | "+r("",l.column-1," ")+r("",m,"^")}else n+=`
 at `+c}return n},e.buildMessage=function(s,n){var o={literal:function(m){return'"'+l(m.text)+'"'},class:function(m){var y=m.parts.map(function(_){return Array.isArray(_)?c(_[0])+"-"+c(_[1]):c(_)});return"["+(m.inverted?"^":"")+y.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(m){return m.description}};function a(m){return m.charCodeAt(0).toString(16).toUpperCase()}function l(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function c(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function h(m){return o[m.type](m)}function p(m){var y,_,b=m.map(h);if(b.sort(),b.length>0){for(y=1,_=1;y<b.length;y++)b[y-1]!==b[y]&&(b[_]=b[y],_++);b.length=_}switch(b.length){case 1:return b[0];case 2:return b[0]+" or "+b[1];default:return b.slice(0,-1).join(", ")+", or "+b[b.length-1]}}function f(m){return m?'"'+l(m)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:e,parse:i}},(lre={get exports(){return W7},set exports(t){W7=t}}).exports&&(lre.exports=cre());const zY={deg:1,grad:.9,rad:180/Math.PI,turn:360};function rBe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&zY[t.unit]!=null))throw new j("effect:type-error",`Expected <angle>, Actual: ${H5(t)}`,{term:t})}const BY={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function iBe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&BY[t.unit]!=null))throw new j("effect:type-error",`Expected <length>, Actual: ${H5(t)}`,{term:t})}function qd(t){tBe(t);const e=t.value;return BM(e,t),t.unit==="%"?.01*e:e}function sBe(t){return eBe(t),BM(t.value,t),t.value}function nBe(t){return rBe(t),t.value*zY[t.unit]||0}function GY(t){return iBe(t),t.value*BY[t.unit]||0}function oBe(t){switch(t.colorType){case"hex":return A$e(t.value);case"named":return Z_e(t.value);case"function":return cBe(t.value)}}function Z_e(t){if(!Lpe(t))throw new j("effect:unknown-color",`color '${t}' isn't valid`,{namedColor:t});return C$e(t)}const aBe=/^rgba?/i,lBe=/^hsla?/i;function cBe(t){if(eC(t.parameters,4),aBe.test(t.name))return[qd(t.parameters[0]),qd(t.parameters[1]),qd(t.parameters[2]),t.parameters[3]?qd(t.parameters[3]):1];if(lBe.test(t.name))return Dpe(sBe(t.parameters[0]),qd(t.parameters[1]),qd(t.parameters[2]),t.parameters[3]?qd(t.parameters[3]):1);throw new j("effect:syntax-error",`Invalid color function '${t.name}'`,{colorFunction:t})}function jY(t,e,r){var i;try{return hBe(t)}catch(s){(i=r==null?void 0:r.messages)==null||i.push(s)}return null}function HY(t,e,r,i){try{const s=uBe(t);sl(r,s,e)}catch(s){i.messages&&i.messages.push(s)}}function uBe(t){const e=Y_e(t);return e?qze(e)?e.map(r=>r.toJSON()):e.map(({scale:r,effects:i})=>({scale:r,value:i.map(s=>s.toJSON())})):null}function hBe(t){if(!t||t.length===0)return null;if(dBe(t)){const e=[];for(const r of t)e.push({scale:r.scale,value:hre(r.value)});return e}return hre(t)}function dBe(t){const e=t[0];return!!e&&"scale"in e}function hre(t){if(!t||!t.length)return"";const e=[];for(const r of t){let i=[];switch(r.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":i=[Um(r,"amount")];break;case"blur":i=[Um(r,"radius","pt")];break;case"hue-rotate":i=[Um(r,"angle","deg")];break;case"drop-shadow":i=[Um(r,"xoffset","pt"),Um(r,"yoffset","pt"),Um(r,"blurRadius","pt"),pBe(r,"color")];break;case"bloom":i=[Um(r,"strength"),Um(r,"radius","pt"),Um(r,"threshold")]}const s=`${r.type}(${i.filter(Boolean).join(" ")})`;Y_e(s),e.push(s)}return e.join(" ")}function Um(t,e,r){if(t[e]==null)throw new j("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});return r?t[e]+r:""+t[e]}function pBe(t,e){if(t[e]==null)throw new j("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});const r=t[e];return`rgba(${r[0]||0}, ${r[1]||0}, ${r[2]||0}, ${r[3]/255||0})`}const uD=-3;var Pg;(function(t){t[t.ALL=0]="ALL",t[t.SOME=1]="SOME"})(Pg||(Pg={}));let fBe=class{constructor(e,r,i){this._namespace=e,this._storage=r,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",i&&(this._storage.registerRemoveFunc(this._namespace,i),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(e,r,i,s=0){this._storage.put(this._namespace+e,r,i,s)}get(e){const r=this._storage.get(this._namespace+e);return r===void 0?++this._miss:++this._hit,r}pop(e){const r=this._storage.pop(this._namespace+e);return r===void 0?++this._miss:++this._hit,r}updateSize(e,r,i){this._storage.updateSize(this._namespace+e,r,i)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}},qY=class{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new Kt,this._users=new Kt}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,r){this._removeFuncs.push([e,r])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(r=>r[0]!==e)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,r,i,s){const n=this._db.get(e);if(n&&(this._size-=n.size,this._db.delete(e),n.entry!==r&&this._notifyRemove(e,n.entry,Pg.ALL)),i>this._maxSize)return void this._notifyRemove(e,r,Pg.ALL);if(r===void 0)return void console.warn("Refusing to cache undefined entry ");if(!i||i<0)return void console.warn("Refusing to cache entry with invalid size "+i);const o=1+Math.max(s,uD)-uD;this._db.set(e,{entry:r,size:i,lifetime:o,lives:o}),this._size+=i,this._checkSizeLimit()}updateSize(e,r,i){const s=this._db.get(e);if(s&&s.entry===r){for(this._size-=s.size;i>this._maxSize;){const n=this._notifyRemove(e,r,Pg.SOME);if(!(v(n)&&n>0))return void this._db.delete(e);i=n}s.size=i,this._size+=i,this._checkSizeLimit()}}pop(e){const r=this._db.get(e);if(r)return this._size-=r.size,this._db.delete(e),++this._hit,r.entry;++this._miss}get(e){const r=this._db.get(e);if(r!==void 0)return this._db.delete(e),r.lives=r.lifetime,this._db.set(e,r),++this._hit,r.entry;++this._miss}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},r={},i=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;i[l]=(i[l]||0)+o.size,this._users.forAll(c=>{const h=c.namespace;if(a.startsWith(h)){const p=r[h]||0;r[h]=p+o.size}})});const s={};this._users.forAll(o=>{const a=o.namespace;if(!isNaN(o.hitRate)&&o.hitRate>0){const l=r[a]||0;r[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(r);n.sort((o,a)=>r[a]-r[o]),n.forEach(o=>e[o]=Math.round(r[o]/2**20)+"MB / "+s[o]);for(let o=i.length-1;o>=0;--o){const a=i[o];a&&(e["Priority "+(o+uD-1)]=Math.round(a/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){this._db.forEach((r,i)=>{i.startsWith(e)&&(this._size-=r.size,this._db.delete(i),this._notifyRemove(i,r.entry,Pg.ALL))})}clearAll(){this._db.forEach((e,r)=>this._notifyRemove(r,e.entry,Pg.ALL)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,r,i){let s;return this._removeFuncs.some(n=>{if(e.startsWith(n[0])){const o=n[1](r,i);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,r]of this._db){if(this._db.delete(e),r.lives<=1){this._size-=r.size;const i=this._notifyRemove(e,r.entry,Pg.SOME);v(i)&&i>0&&(this._size+=i,r.lives=r.lifetime,r.size=i,this._db.set(e,r))}else--r.lives,this._db.set(e,r);if(this._size<=.9*this.maxSize)return}}},mBe=class{constructor(e,r){this._storage=new qY,this._storage.maxSize=e,r&&this._storage.registerRemoveFunc("",r)}put(e,r){this._storage.put(e,r,1,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}};new mBe(1e3);new Ze([128,128,128]);const gBe=new Ze("white");function yBe(t){return Fl(t.resource).href}function Ex(t,e){if(!t)return null;let r=null;return aE(t)?r=_Be(t):x5(t)&&(r=t.color?new Ze(t.color):null),r?O3(r,e):null}function _Be(t){const e=t.symbolLayers;if(!e)return null;let r=null;return e.forEach(i=>{var s;i.type==="object"&&((s=i.resource)==null?void 0:s.href)!=null||(r=i.type==="water"?i.color:v(i.material)?i.material.color:null)}),r?new Ze(r):null}function O3(t,e){if(e==null||t==null)return t;const r=t.toRgba();return r[3]=r[3]*e,new Ze(r)}function vBe(t,e,r){const i=t.symbolLayers;if(!i)return;const s=n=>{const o=v(n)?n:null;return O3(e=e??o??(r!=null?gBe:null),r)};i.forEach(n=>{var o;if(n.type!=="object"||((o=n.resource)==null?void 0:o.href)==null||e)if(n.type==="water")n.color=s(n.color);else{const a=v(n.material)?n.material.color:null,l=s(a);C(n.material)?n.material=new Iu({color:l}):n.material.color=l,r!=null&&"outline"in n&&v(n.outline)&&v(n.outline.color)&&(n.outline.color=O3(n.outline.color,r))}})}function bBe(t,e,r){(e=e??t.color)&&(t.color=O3(e,r)),r!=null&&"outline"in t&&t.outline&&t.outline.color&&(t.outline.color=O3(t.outline.color,r))}function n8(t,e,r){t&&(e||r!=null)&&(e&&(e=new Ze(e)),aE(t)?vBe(t,e,r):x5(t)&&bBe(t,e,r))}async function wBe(t,e){const r=t.symbolLayers;r&&await Z4(r,async i=>xBe(i,e))}async function xBe(t,e){switch(t.type){case"extrude":SBe(t,e);break;case"icon":case"line":case"text":TBe(t,e);break;case"path":CBe(t,e);break;case"object":await EBe(t,e)}}function TBe(t,e){const r=J_e(e);v(r)&&(t.size=r)}function J_e(t){for(const e of t)if(typeof e=="number")return e;return null}function SBe(t,e){t.size=typeof e[2]=="number"?e[2]:0}async function EBe(t,e){const{resourceSize:r,symbolSize:i}=await ABe(t),s=K_e(e,r,i);t.width=wO(e[0],i[0],r[0],s),t.depth=wO(e[1],i[1],r[1],s),t.height=wO(e[2],i[2],r[2],s)}function CBe(t,e){const r=K_e(e,Gf,[t.width,void 0,t.height]);t.width=wO(e[0],t.width,1,r),t.height=wO(e[2],t.height,1,r)}function K_e(t,e,r){for(let i=0;i<3;i++){const s=t[i];switch(s){case"symbol-value":{const n=r[i];return n!=null?n/e[i]:1}case"proportional":break;default:if(s&&e[i])return s/e[i]}}return 1}async function ABe(t){const e=await ie(()=>import("./symbolLayerUtils-b1cf5624.js"),[],import.meta.url),r=await e.computeObjectLayerResourceSize(t,10),{width:i,height:s,depth:n}=t,o=[i,n,s];let a=1;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/r[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=r[l]*a);return{resourceSize:r,symbolSize:o}}function wO(t,e,r,i){switch(t){case"proportional":return r*i;case"symbol-value":return e??r;default:return t}}function RBe(t,e){const r=J_e(e);if(!C(r))switch(t.type){case"simple-marker":t.size=r;break;case"picture-marker":{const i=t.width/t.height;i>1?(t.width=r,t.height=r*i):(t.width=r*i,t.height=r);break}case"simple-line":t.width=r;break;case"text":t.font.size=r}}async function OBe(t,e){if(t&&e)return aE(t)?wBe(t,e):void(x5(t)&&RBe(t,e))}function MBe(t,e,r){if(t&&e!=null)if(aE(t)){const i=t.symbolLayers;i&&i.forEach(s=>{if(s&&s.type==="object")switch(r){case"tilt":s.tilt=e;break;case"roll":s.roll=e;break;default:s.heading=e}})}else x5(t)&&(t.type!=="simple-marker"&&t.type!=="picture-marker"&&t.type!=="text"||(t.angle=e))}function uAt(t){return v(t)&&t.type==="polygon-3d"&&t.symbolLayers.some(e=>e.type==="extrude")}async function PBe(t,e){return await t.fetchSymbol(e)||t.fetchCIMSymbol(e)}const IBe="<",$Be=">",LBe=d5("short-date");function DBe(t,e,r,i){let s="";e===0?s=`${IBe} `:e===r&&(s=`${$Be} `);let n=null;return n=i?pm(t,LBe):Mze(t),s+n}const NBe=new Ze([64,64,64]);function FBe(t,e){const r=[],i=t.length-1;return t.length===5?r.push(0,2,4):r.push(0,i),t.map((s,n)=>r.includes(n)?DBe(s,n,i,e):null)}async function UBe(t,e,r){let i=!1,s=[],n=[];if(t.stops){const c=t.stops;s=c.map(h=>h.value),i=c.some(h=>!!h.label),i&&(n=c.map(h=>h.label))}const o=s[0],a=s[s.length-1];if(o==null&&a==null)return null;const l=i?null:FBe(s,r??!1);return(await Promise.all(s.map(async(c,h)=>({value:c,color:t.type==="opacity"?await VBe(c,t,e):(await ie(()=>Promise.resolve().then(()=>oZ),void 0,import.meta.url)).getColor(t,c),label:i?n[h]:(l==null?void 0:l[h])??""})))).reverse()}async function VBe(t,e,r=NBe){const i=new Ze(r),s=(await ie(()=>Promise.resolve().then(()=>oZ),void 0,import.meta.url)).getOpacity(e,t);return s!=null&&(i.a=s),i}var X7;let pR=X7=class extends fe{constructor(t){super(t),this.color=null,this.ratio=null}clone(){return new X7({color:this.color,ratio:this.ratio})}};u([d({type:Ze,json:{type:[Ti],default:null,write:!0}})],pR.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],pR.prototype,"ratio",void 0),pR=X7=u([P("esri.renderers.support.HeatmapColorStop")],pR);const xO=pR;function kBe(t){if(!t.colorStops)return[];const e=[...t.colorStops].filter(i=>{var s;return((s=i.color)==null?void 0:s.a)>0});let r=e.length-1;if(e&&e[0]){const i=e[r];i&&i.ratio!==1&&(e.push(new xO({ratio:1,color:i.color})),r++)}return e.map((i,s)=>{var o,a;let n="";return s===0?n=((o=t.legendOptions)==null?void 0:o.minLabel)||"low":s===r&&(n=((a=t.legendOptions)==null?void 0:a.maxLabel)||"high"),{color:i.color,label:n,ratio:i.ratio}}).reverse()}se.getLogger("esri.renderers.support.utils");async function Wc(t,e,r){wW(t,e,()=>[]).push(...r)}async function zBe(t){var r,i;const e=new Map;if(!t)return e;if("visualVariables"in t&&t.visualVariables){const s=t.visualVariables.filter(n=>n.type==="color");for(const n of s){const o=(await UBe(n)??[]).map(a=>a.color);await Wc(e,n.field||n.valueExpression,o)}}if(t.type==="heatmap"){const s=kBe(t).map(n=>n.color);await Wc(e,t.field||t.valueExpression,s)}else if(t.type==="pie-chart"){for(const s of t.attributes)await Wc(e,s.field||s.valueExpression,[s.color]);await Wc(e,"default",[(r=t==null?void 0:t.othersCategory)==null?void 0:r.color,Ex(t.backgroundFillSymbol,null)])}else if(t.type==="dot-density"){for(const s of t.attributes)await Wc(e,s.field||s.valueExpression,[s.color]);await Wc(e,"default",[t.backgroundColor])}else if(t.type==="unique-value")if(((i=t.authoringInfo)==null?void 0:i.type)==="predominance")for(const s of t.uniqueValueInfos??[])await Wc(e,s.value.toString(),[Ex(s.symbol,null)]);else{const s=(t.uniqueValueInfos??[]).map(c=>Ex(c.symbol,null)),{field:n,field2:o,field3:a,valueExpression:l}=t;(n||l)&&await Wc(e,n||l,s),o&&await Wc(e,o,s),a&&await Wc(e,a,s)}else if(t.type==="class-breaks"){const s=t.classBreakInfos.map(a=>Ex(a.symbol,null)),{field:n,valueExpression:o}=t;await Wc(e,n??o,s)}else t.type==="simple"&&await Wc(e,"default",[Ex(t.symbol,null)]);return"defaultSymbol"in t&&t.defaultSymbol&&await Wc(e,"default",[Ex(t.defaultSymbol,null)]),e.forEach((s,n)=>{const o=gM(s.filter(Boolean),(a,l)=>JSON.stringify(a)===JSON.stringify(l));e.set(n,o)}),e}var Y7;let fR=Y7=class extends fe{constructor(t){super(t),this.name=null,this.code=null}clone(){return new Y7({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],fR.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],fR.prototype,"code",void 0),fR=Y7=u([P("esri.layers.support.CodedValue")],fR);const BBe=new Vr({inherited:"inherited",codedValue:"coded-value",range:"range"});let mR=class extends fe{constructor(e){super(e),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],mR.prototype,"name",void 0),u([mt(BBe)],mR.prototype,"type",void 0),mR=u([P("esri.layers.support.Domain")],mR);const q5=mR;var Z7;let gR=Z7=class extends q5{constructor(t){super(t),this.codedValues=null,this.type="coded-value"}getName(t){let e=null;if(this.codedValues){const r=String(t);this.codedValues.some(i=>(String(i.code)===r&&(e=i.name),!!e))}return e}clone(){return new Z7({codedValues:te(this.codedValues),name:this.name})}};u([d({type:[fR],json:{write:!0}})],gR.prototype,"codedValues",void 0),u([mt({codedValue:"coded-value"})],gR.prototype,"type",void 0),gR=Z7=u([P("esri.layers.support.CodedValueDomain")],gR);const Q_e=gR;var J7;let hD=J7=class extends q5{constructor(t){super(t),this.type="inherited"}clone(){return new J7}};u([mt({inherited:"inherited"})],hD.prototype,"type",void 0),hD=J7=u([P("esri.layers.support.InheritedDomain")],hD);const eve=hD;var K7;let YT=K7=class extends q5{constructor(t){super(t),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new K7({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(t,e,r){e[r]=[this.minValue||0,t]}}}})],YT.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[0]},write:{target:"range",writer(t,e,r){e[r]=[t,this.maxValue||0]}}}})],YT.prototype,"minValue",void 0),u([mt({range:"range"})],YT.prototype,"type",void 0),YT=K7=u([P("esri.layers.support.RangeDomain")],YT);const tve=YT,rve={key:"type",base:q5,typeMap:{range:tve,"coded-value":Q_e,inherited:eve}};function WY(t){if(!t||!t.type)return null;switch(t.type){case"range":return tve.fromJSON(t);case"codedValue":return Q_e.fromJSON(t);case"inherited":return eve.fromJSON(t)}return null}var Q7;const GBe=new Vr({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let Ba=Q7=class extends fe{constructor(t){super(t),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null,this.visible=!0}readDescription(t,{description:e}){let r=null;try{r=e?JSON.parse(e):null}catch{}return(r==null?void 0:r.value)??null}readValueType(t,{description:e}){let r=null;try{r=e?JSON.parse(e):null}catch{}return r?GBe.fromJSON(r.fieldValueType):null}clone(){return new Q7({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType,visible:this.visible})}};u([d({type:String,json:{write:!0}})],Ba.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],Ba.prototype,"defaultValue",void 0),u([d()],Ba.prototype,"description",void 0),u([Le("description")],Ba.prototype,"readDescription",null),u([d({types:rve,json:{read:{reader:WY},write:!0}})],Ba.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Ba.prototype,"editable",void 0),u([d({type:Ti,json:{write:!0}})],Ba.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],Ba.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],Ba.prototype,"nullable",void 0),u([mt(RX)],Ba.prototype,"type",void 0),u([d()],Ba.prototype,"valueType",void 0),u([Le("valueType",["description"])],Ba.prototype,"readValueType",null),u([d({type:Boolean,json:{read:!1}})],Ba.prototype,"visible",void 0),Ba=Q7=u([P("esri.layers.support.Field")],Ba);const W5=Ba;var eG;let ZT=eG=class extends fe{constructor(t){super(t),this.type="map-layer"}clone(){const{mapLayerId:t,gdbVersion:e}=this;return new eG({mapLayerId:t,gdbVersion:e})}};u([mt({mapLayer:"map-layer"})],ZT.prototype,"type",void 0),u([d({type:Ti,json:{write:!0}})],ZT.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],ZT.prototype,"gdbVersion",void 0),ZT=eG=u([P("esri.layers.support.source.MapLayerSource")],ZT);var tG;let ug=tG=class extends fe{constructor(t){super(t),this.type="query-table"}clone(){const{workspaceId:t,query:e,oidFields:r,spatialReference:i,geometryType:s}=this,n={workspaceId:t,query:e,oidFields:r,spatialReference:(i==null?void 0:i.clone())??void 0,geometryType:s};return new tG(n)}};u([mt({queryTable:"query-table"})],ug.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],ug.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],ug.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],ug.prototype,"oidFields",void 0),u([d({type:We,json:{write:!0}})],ug.prototype,"spatialReference",void 0),u([mt(yfe)],ug.prototype,"geometryType",void 0),ug=tG=u([P("esri.layers.support.source.QueryTableDataSource")],ug);var rG;let JT=rG=class extends fe{constructor(t){super(t),this.type="raster"}clone(){const{workspaceId:t,dataSourceName:e}=this;return new rG({workspaceId:t,dataSourceName:e})}};u([mt({raster:"raster"})],JT.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],JT.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],JT.prototype,"workspaceId",void 0),JT=rG=u([P("esri.layers.support.source.RasterDataSource")],JT);var iG;let j1=iG=class extends fe{constructor(t){super(t),this.type="table"}clone(){const{workspaceId:t,gdbVersion:e,dataSourceName:r}=this;return new iG({workspaceId:t,gdbVersion:e,dataSourceName:r})}};u([mt({table:"table"})],j1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],j1.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],j1.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],j1.prototype,"dataSourceName",void 0),j1=iG=u([P("esri.layers.support.source.TableDataSource")],j1);var sG,nG;const jBe=Ra()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let iu=sG=class extends fe{constructor(t){super(t),this.type="join-table"}readLeftTableSource(t,e,r){return dre()(t,e,r)}castLeftTableSource(t){return _p(oG(),t)}readRightTableSource(t,e,r){return dre()(t,e,r)}castRightTableSource(t){return _p(oG(),t)}clone(){const{leftTableKey:t,rightTableKey:e,leftTableSource:r,rightTableSource:i,joinType:s}=this,n={leftTableKey:t,rightTableKey:e,leftTableSource:(r==null?void 0:r.clone())??void 0,rightTableSource:(i==null?void 0:i.clone())??void 0,joinType:s};return new sG(n)}};u([mt({joinTable:"join-table"})],iu.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],iu.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],iu.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],iu.prototype,"leftTableSource",void 0),u([Le("leftTableSource")],iu.prototype,"readLeftTableSource",null),u([Gt("leftTableSource")],iu.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],iu.prototype,"rightTableSource",void 0),u([Le("rightTableSource")],iu.prototype,"readRightTableSource",null),u([Gt("rightTableSource")],iu.prototype,"castRightTableSource",null),u([mt(jBe)],iu.prototype,"joinType",void 0),iu=sG=u([P("esri.layers.support.source.JoinTableDataSource")],iu);let o8=null;function dre(){return o8||(o8=wv({types:oG()})),o8}let a8=null;function oG(){return a8||(a8={key:"type",base:null,typeMap:{"data-layer":Wd,"map-layer":ZT}}),a8}const HBe={key:"type",base:null,typeMap:{"join-table":iu,"query-table":ug,raster:JT,table:j1}};let Wd=nG=class extends fe{constructor(t){super(t),this.type="data-layer"}clone(){const{fields:t,dataSource:e}=this;return new nG({fields:t,dataSource:e})}};u([mt({dataLayer:"data-layer"})],Wd.prototype,"type",void 0),u([d({type:[W5],json:{write:!0}})],Wd.prototype,"fields",void 0),u([d({types:HBe,json:{write:!0}})],Wd.prototype,"dataSource",void 0),Wd=nG=u([P("esri.layers.support.source.DataLayerSource")],Wd),Wd.from=Ls(Wd);function qBe(t,e){return e?{...e,query:{...t??{},...e.query}}:{query:t}}function X5(t){return typeof t=="string"?lo(t):te(t)}function WBe(t,e,r){const i={};for(const s in t){if(s==="declaredClass")continue;const n=t[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){i[s]=[];for(let o=0;o<n.length;o++)i[s][o]=WBe(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(r&&r[s]);i[s]=e?o:JSON.stringify(o)}else i[s]=e?n:JSON.stringify(n);else i[s]=n}return i}const nI={102100:{maxX:20037508342788905e-9,minX:-20037508342788905e-9,plus180Line:new ip({paths:[[[20037508342788905e-9,-20037508342788905e-9],[20037508342788905e-9,20037508342788905e-9]]],spatialReference:We.WebMercator}),minus180Line:new ip({paths:[[[-20037508342788905e-9,-20037508342788905e-9],[-20037508342788905e-9,20037508342788905e-9]]],spatialReference:We.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new ip({paths:[[[180,-180],[180,180]]],spatialReference:We.WGS84}),minus180Line:new ip({paths:[[[-180,-180],[-180,180]]],spatialReference:We.WGS84})}};function Wb(t,e){return Math.ceil((t-e)/(2*e))}function ive(t,e){const r=TO(t);for(const i of r)for(const s of i)s[0]+=e;return t}function TO(t){return rw(t)?t.rings:t.paths}async function XBe(t,e,r,i){const s=X5(t),n=e[0].spatialReference,o={...i,query:{...s.query,f:"json",sr:JSON.stringify(n),target:JSON.stringify({geometryType:zE(e[0]),geometries:e}),cutter:JSON.stringify(r)}},a=await Pi(s.path+"/cut",o),{cutIndexes:l,geometries:c=[]}=a.data;return{cutIndexes:l,geometries:c.map(h=>{const p=um(h);return p.spatialReference=n,p})}}function YBe(t){return{geometryType:zE(t[0]),geometries:t.map(e=>e.toJSON())}}function sve(t,e,r){const i=qLe(e);return t.map(s=>{const n=i.fromJSON(s);return n.spatialReference=r,n})}async function ZBe(t,e,r){const i=typeof t=="string"?lo(t):t,s=e[0].spatialReference,n=zE(e[0]),o={...r,query:{...i.query,f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(YBe(e))}},{data:a}=await Pi(i.path+"/simplify",o);return sve(a.geometries,n,s)}const nve=se.getLogger("esri.geometry.support.normalizeUtils");function JBe(t){return t.type==="polygon"}function KBe(t){return t[0].type==="polygon"}function QBe(t){return t[0].type==="polyline"}function e7e(t,e){if(!(t instanceof ip||t instanceof bp)){const s="straightLineDensify: the input geometry is neither polyline nor polygon";throw nve.error(s),new j(s)}const r=TO(t),i=[];for(const s of r){const n=[];i.push(n),n.push([s[0][0],s[0][1]]);for(let o=0;o<s.length-1;o++){const a=s[o][0],l=s[o][1],c=s[o+1][0],h=s[o+1][1],p=Math.sqrt((c-a)*(c-a)+(h-l)*(h-l)),f=(h-l)/p,m=(c-a)/p,y=p/e;if(y>1){for(let T=1;T<=y-1;T++){const S=T*e,E=m*S+a,O=f*S+l;n.push([E,O])}const _=(p+Math.floor(y-1)*e)/2,b=m*_+a,x=f*_+l;n.push([b,x])}n.push([c,h])}}return JBe(t)?new bp({rings:i,spatialReference:t.spatialReference}):new ip({paths:i,spatialReference:t.spatialReference})}function pre(t,e,r){if(e){const i=e7e(t,1e6);t=L2(i,!0)}return r&&(t=ive(t,r)),t}function fre(t,e,r){if(Array.isArray(t)){const i=t[0];if(i>e){const s=Wb(i,e);t[0]=i+s*(-2*e)}else if(i<r){const s=Wb(i,r);t[0]=i+s*(-2*r)}}else{const i=t.x;if(i>e){const s=Wb(i,e);t=t.clone().offset(s*(-2*e),0)}else if(i<r){const s=Wb(i,r);t=t.clone().offset(s*(-2*r),0)}}return t}function t7e(t,e){let r=-1;for(let i=0;i<e.cutIndexes.length;i++){const s=e.cutIndexes[i],n=e.geometries[i],o=TO(n);for(let a=0;a<o.length;a++){const l=o[a];l.some(c=>{if(c[0]<180)return!0;{let h=0;for(let f=0;f<l.length;f++){const m=l[f][0];h=m>h?m:h}h=Number(h.toFixed(9));const p=-360*Wb(h,180);for(let f=0;f<l.length;f++){const m=n.getPoint(a,f);n.setPoint(a,f,m.clone().offset(p,0))}return!0}})}if(s===r){if(KBe(t))for(const a of TO(n))t[s]=t[s].addRing(a);else if(QBe(t))for(const a of TO(n))t[s]=t[s].addPath(a)}else r=s,t[s]=n}return t}async function ove(t,e,r){if(!Array.isArray(t))return ove([t],e);e&&typeof e!="string"&&nve.warn("normalizeCentralMeridian()","The url object is deprecated, use the url string instead");const i=typeof e=="string"?e:(e==null?void 0:e.url)??Qr.geometryServiceUrl;let s,n,o,a,l,c,h,p,f=0;const m=[],y=[];for(const E of t)if(C(E))y.push(E);else if(s||(s=E.spatialReference,n=V_(s),o=s.isWebMercator,c=o?102100:4326,a=nI[c].maxX,l=nI[c].minX,h=nI[c].plus180Line,p=nI[c].minus180Line),n)if(E.type==="mesh")y.push(E);else if(E.type==="point")y.push(fre(E.clone(),a,l));else if(E.type==="multipoint"){const O=E.clone();O.points=O.points.map(R=>fre(R,a,l)),y.push(O)}else if(E.type==="extent"){const O=E.clone()._normalize(!1,!1,n);y.push(O.rings?new bp(O):O)}else if(E.extent){const O=E.extent,R=Wb(O.xmin,l)*(2*a);let L=R===0?E.clone():ive(E.clone(),R);O.offset(R,0),O.intersects(h)&&O.xmax!==a?(f=O.xmax>f?O.xmax:f,L=pre(L,o),m.push(L),y.push("cut")):O.intersects(p)&&O.xmin!==l?(f=O.xmax*(2*a)>f?O.xmax*(2*a):f,L=pre(L,o,360),m.push(L),y.push("cut")):y.push(L)}else y.push(E.clone());else y.push(E);let _=Wb(f,a),b=-90;const x=_,T=new ip;for(;_>0;){const E=360*_-180;T.addPath([[E,b],[E,-1*b]]),b*=-1,_--}if(m.length>0&&x>0){const E=t7e(m,await XBe(i,m,T,r)),O=[],R=[];for(let U=0;U<y.length;U++){const z=y[U];if(z!=="cut")R.push(z);else{const B=E.shift(),G=t[U];v(G)&&G.type==="polygon"&&G.rings&&G.rings.length>1&&B.rings.length>=G.rings.length?(O.push(B),R.push("simplify")):R.push(o?jg(B):B)}}if(!O.length)return R;const L=await ZBe(i,O,r),I=[];for(let U=0;U<R.length;U++){const z=R[U];z!=="simplify"?I.push(z):I.push(o?jg(L.shift()):L.shift())}return I}const S=[];for(let E=0;E<y.length;E++){const O=y[E];if(O!=="cut")S.push(O);else{const R=m.shift();S.push(o===!0?jg(R):R)}}return S}function ave(t){const e={};for(const r in t){if(r==="declaredClass")continue;const i=t[r];if(i!=null&&typeof i!="function")if(Array.isArray(i)){e[r]=[];for(let s=0;s<i.length;s++)e[r][s]=ave(i[s])}else typeof i=="object"?i.toJSON&&(e[r]=JSON.stringify(i)):e[r]=i}return e}var n_;(function(t){t[t.varint=0]="varint",t[t.fixed64=1]="fixed64",t[t.delimited=2]="delimited",t[t.fixed32=5]="fixed32",t[t.unknown=99]="unknown"})(n_||(n_={}));const mre=4294967296,r7e=new TextDecoder("utf-8"),i7e=de("safari")||de("ios")?6:de("ff")?12:32;let aG=class dD{constructor(e,r,i=0,s=e?e.byteLength:0){this._tag=0,this._dataType=n_.unknown,this._init(e,r,i,s)}_init(e,r,i,s){this._data=e,this._dataView=r,this._pos=i,this._end=s}asUnsafe(){return this}clone(){return new dD(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(e){this._pos=e}nextTag(e){for(;;){if(this._pos===this._end)return!1;const r=this._decodeVarint();if(this._tag=r>>3,this._dataType=7&r,!e||e===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const e=this._decodeVarint();return this._tag=e>>3,this._dataType=7&e,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let e=4294967295;return e=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?e:(e=(e|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?e:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const e=this.getUInt32();if(e!==void 0)return e>>>1^-(1&e)|0}getSInt64(){return this._decodeSVarint()}getBool(){const e=this._data[this._pos]!==0;return this._skip(1),e}getEnum(){return this._decodeVarint()}getFixed64(){const e=this._dataView,r=this._pos,i=e.getUint32(r,!0)+e.getUint32(r+4,!0)*mre;return this._skip(8),i}getSFixed64(){const e=this._dataView,r=this._pos,i=e.getUint32(r,!0)+e.getInt32(r+4,!0)*mre;return this._skip(8),i}getDouble(){const e=this._dataView.getFloat64(this._pos,!0);return this._skip(8),e}getFixed32(){const e=this._dataView.getUint32(this._pos,!0);return this._skip(4),e}getSFixed32(){const e=this._dataView.getInt32(this._pos,!0);return this._skip(4),e}getFloat(){const e=this._dataView.getFloat32(this._pos,!0);return this._skip(4),e}getString(){const e=this._getLength(),r=this._pos,i=this._toString(this._data,r,r+e);return this._skip(e),i}getBytes(){const e=this._getLength(),r=this._pos,i=this._toBytes(this._data,r,r+e);return this._skip(e),i}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(e,r,i,s){const n=this.getMessage(),o=e(n,r,i,s);return n.release(),o}processMessage(e){const r=this.getMessage(),i=e(r);return r.release(),i}getMessage(){const e=this._getLength(),r=dD.pool.acquire();return r._init(this._data,this._dataView,this._pos,this._pos+e),this._skip(e),r}release(){dD.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case n_.varint:this._decodeVarint();break;case n_.fixed64:this._skip(8);break;case n_.delimited:this._skip(this._getLength());break;case n_.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(e){this._skip(e)}_skip(e){if(this._pos+e>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=e}_decodeVarint(){const e=this._data;let r=this._pos,i=0,s=0;if(this._end-r>=10)do{if(s=e[r++],i|=127&s,(128&s)==0||(s=e[r++],i|=(127&s)<<7,(128&s)==0)||(s=e[r++],i|=(127&s)<<14,(128&s)==0)||(s=e[r++],i|=(127&s)<<21,(128&s)==0)||(s=e[r++],i+=268435456*(127&s),(128&s)==0)||(s=e[r++],i+=34359738368*(127&s),(128&s)==0)||(s=e[r++],i+=4398046511104*(127&s),(128&s)==0)||(s=e[r++],i+=562949953421312*(127&s),(128&s)==0)||(s=e[r++],i+=72057594037927940*(127&s),(128&s)==0)||(s=e[r++],i+=9223372036854776e3*(127&s),(128&s)==0))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(s=e[r],(128&s)!=0);)++r,i+=(127&s)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,i+=s*n}return this._pos=r,i}_decodeSVarint(){const e=this._data;let r=this._pos,i=0,s=0;const n=1&e[r];if(this._end-r>=10)do{if(s=e[r++],i|=127&s,(128&s)==0||(s=e[r++],i|=(127&s)<<7,(128&s)==0)||(s=e[r++],i|=(127&s)<<14,(128&s)==0)||(s=e[r++],i|=(127&s)<<21,(128&s)==0)||(s=e[r++],i+=268435456*(127&s),(128&s)==0)||(s=e[r++],i+=34359738368*(127&s),(128&s)==0)||(s=e[r++],i+=4398046511104*(127&s),(128&s)==0)||(s=e[r++],i+=562949953421312*(127&s),(128&s)==0)||(s=e[r++],i+=72057594037927940*(127&s),(128&s)==0)||(s=e[r++],i+=9223372036854776e3*(127&s),(128&s)==0))break;throw new Error("Varint too long!")}while(0);else{let o=1;for(;r!==this._end&&(s=e[r],(128&s)!=0);)++r,i+=(127&s)*o,o*=128;if(r===this._end)throw new Error("Varint overrun!");++r,i+=s*o}return this._pos=r,n?-(i+1)/2:i/2}_getLength(){if(this._dataType!==n_.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(e,r,i){if((i=Math.min(this._end,i))-r>i7e){const o=e.subarray(r,i);return r7e.decode(o)}let s="",n="";for(let o=r;o<i;++o){const a=e[o];128&a?n+="%"+a.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(a),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(e,r,i){return i=Math.min(this._end,i),new Uint8Array(e.buffer,r,i-r)}};aG.pool=new Po(aG,void 0,t=>{t._data=null,t._dataView=null});let Tp=class pD{constructor(e=[],r=[],i=!1){this.lengths=e??[],this.coords=r??[],this.hasIndeterminateRingOrder=i}static fromRect(e){const[r,i,s,n]=e,o=s-r,a=n-i;return new pD([5],[r,i,o,0,0,a,-o,0,0,-a])}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((e,r)=>e+r)}forEachVertex(e){let r=0;this.lengths.length||e(this.coords[0],this.coords[1]);for(let i=0;i<this.lengths.length;i++){const s=this.lengths[i];for(let n=0;n<s;n++)e(this.coords[2*(n+r)],this.coords[2*(n+r)+1]);r+=s}}clone(e){return e?(e.set(this.coords),new pD(this.lengths.slice(),e,this.hasIndeterminateRingOrder)):new pD(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}},lv=class lve{constructor(e=null,r={},i,s){this.geometry=e,this.attributes=r,this.centroid=i,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const e=new lve(this.geometry,this.attributes,this.centroid,this.objectId);return e.displayId=this.displayId,e.geohashX=this.geohashX,e.geohashY=this.geohashY,e}};function s7e(t){return!(C(t.geometry)||!t.geometry.coords||!t.geometry.coords.length)}let dAt=class extends lv{},cve=class uve{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const e=new uve;return e.objectIdFieldName=this.objectIdFieldName,e.globalIdFieldName=this.globalIdFieldName,e.geohashFieldName=this.geohashFieldName,e.geometryProperties=this.geometryProperties,e.geometryType=this.geometryType,e.spatialReference=this.spatialReference,e.hasZ=this.hasZ,e.hasM=this.hasM,e.features=this.features,e.fields=this.fields,e.transform=this.transform,e.exceededTransferLimit=this.exceededTransferLimit,e.uniqueIdField=this.uniqueIdField,e.queryGeometry=this.queryGeometry,e.queryGeometryType=this.queryGeometryType,e}};const hve=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];let fAt=class{constructor(e){this._options=e,this.geometryTypes=hve,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new cve}prepareFeatures(e){this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&this._vertexDimension++}finishFeatureResult(e){if(!e||!e.features||!e.hasZ||!this._options.sourceSpatialReference||!e.spatialReference||Cn(e.spatialReference,this._options.sourceSpatialReference)||e.spatialReference.vcsWkid)return;const r=ww(this._options.sourceSpatialReference)/ww(e.spatialReference);if(r!==1)for(const i of e.features){if(!s7e(i))continue;const s=i.geometry.coords;for(let n=2;n<s.length;n+=3)s[n]*=r}}addFeature(e,r){e.features.push(r)}createFeature(){return new lv}createSpatialReference(){return{wkid:0}}createGeometry(){return new Tp}addField(e,r){e.fields.push(r)}allocateCoordinates(e){e.coords.length=e.lengths.reduce((r,i)=>r+i,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(e,r){e.coords[this._coordinatePtr++]=r}addCoordinatePoint(e,r){e.coords.push(r)}addLength(e,r){e.lengths.push(r)}addQueryGeometry(e,r){e.queryGeometry=r.queryGeometry,e.queryGeometryType=r.queryGeometryType}createPointGeometry(){return new Tp}};const gre=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],yre=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],_re=["upperLeft","lowerLeft"];function vre(t){return t>=gre.length?null:gre[t]}function n7e(t){return t>=yre.length?null:yre[t]}function bre(t){return t>=_re.length?null:_re[t]}function wre(t,e){return e>=t.geometryTypes.length?null:t.geometryTypes[e]}function o7e(t,e,r){const s=t.asUnsafe(),n=e.createPointGeometry(r);for(;s.next();)switch(s.tag()){case 3:{const o=s.getUInt32(),a=s.pos()+o;let l=0;for(;s.pos()<a;)e.addCoordinatePoint(n,s.getSInt64(),l++);break}default:s.skip()}return n}function a7e(t,e,r){const n=t.asUnsafe(),o=e.createGeometry(r),a=2+(r.hasZ?1:0)+(r.hasM?1:0);for(;n.next();)switch(n.tag()){case 2:{const l=n.getUInt32(),c=n.pos()+l;let h=0;for(;n.pos()<c;)e.addLength(o,n.getUInt32(),h++);break}case 3:{const l=n.getUInt32(),c=n.pos()+l;let h=0;for(e.allocateCoordinates(o);n.pos()<c;)e.addCoordinate(o,n.getSInt64(),h),h++,h===a&&(h=0);break}default:n.skip()}return o}function l7e(t){const s=t.asUnsafe(),n=new Tp;let o="esriGeometryPoint";for(;s.next();)switch(s.tag()){case 2:{const a=s.getUInt32(),l=s.pos()+a;for(;s.pos()<l;)n.lengths.push(s.getUInt32());break}case 3:{const a=s.getUInt32(),l=s.pos()+a;for(;s.pos()<l;)n.coords.push(s.getSInt64());break}case 1:o=hve[s.getEnum()];break;default:s.skip()}return{queryGeometry:n,queryGeometryType:o}}function c7e(t){const h=t.asUnsafe();for(;h.next();)switch(h.tag()){case 1:return h.getString();case 2:return h.getFloat();case 3:return h.getDouble();case 4:return h.getSInt32();case 5:return h.getUInt32();case 6:return h.getInt64();case 7:return h.getUInt64();case 8:return h.getSInt64();case 9:return h.getBool();default:return h.skip(),null}return null}function u7e(t){const a=t.asUnsafe(),l={type:vre(0)};for(;a.next();)switch(a.tag()){case 1:l.name=a.getString();break;case 2:l.type=vre(a.getEnum());break;case 3:l.alias=a.getString();break;case 4:l.sqlType=n7e(a.getEnum());break;case 5:a.skip();break;case 6:l.defaultValue=a.getString();break;default:a.skip()}return l}function h7e(t){const i={},s=t.asUnsafe();for(;s.next();)switch(s.tag()){case 1:i.name=s.getString();break;case 2:i.isSystemMaintained=s.getBool();break;default:s.skip()}return i}function d7e(t,e,r,i){const a=e.createFeature(r);let l=0;for(;t.next();)switch(t.tag()){case 1:{const c=i[l++].name;a.attributes[c]=t.processMessage(c7e);break}case 2:a.geometry=t.processMessageWithArgs(a7e,e,r);break;case 4:a.centroid=t.processMessageWithArgs(o7e,e,r);break;default:t.skip()}return a}function p7e(t){const n=[1,1,1,1],o=t.asUnsafe();for(;o.next();)switch(o.tag()){case 1:n[0]=o.getDouble();break;case 2:n[1]=o.getDouble();break;case 4:n[2]=o.getDouble();break;case 3:n[3]=o.getDouble();break;default:o.skip()}return n}function f7e(t){const n=[0,0,0,0],o=t.asUnsafe();for(;o.next();)switch(o.tag()){case 1:n[0]=o.getDouble();break;case 2:n[1]=o.getDouble();break;case 4:n[2]=o.getDouble();break;case 3:n[3]=o.getDouble();break;default:o.skip()}return n}function m7e(t){const s={originPosition:bre(0)},n=t.asUnsafe();for(;n.next();)switch(n.tag()){case 1:s.originPosition=bre(n.getEnum());break;case 2:s.scale=n.processMessage(p7e);break;case 3:s.translate=n.processMessage(f7e);break;default:n.skip()}return s}function g7e(t){const s={},n=t.asUnsafe();for(;n.next();)switch(n.tag()){case 1:s.shapeAreaFieldName=n.getString();break;case 2:s.shapeLengthFieldName=n.getString();break;case 3:s.units=n.getString();break;default:n.skip()}return s}function y7e(t,e){const a=e.createSpatialReference();for(;t.next();)switch(t.tag()){case 1:a.wkid=t.getUInt32();break;case 5:a.wkt=t.getString();break;case 2:a.latestWkid=t.getUInt32();break;case 3:a.vcsWkid=t.getUInt32();break;case 4:a.latestVcsWkid=t.getUInt32();break;default:t.skip()}return a}function _7e(t,e){const _=e.createFeatureResult(),b=t.asUnsafe();_.geometryType=wre(e,0);let x=!1;for(;b.next();)switch(b.tag()){case 1:_.objectIdFieldName=b.getString();break;case 3:_.globalIdFieldName=b.getString();break;case 4:_.geohashFieldName=b.getString();break;case 5:_.geometryProperties=b.processMessage(g7e);break;case 7:_.geometryType=wre(e,b.getEnum());break;case 8:_.spatialReference=b.processMessageWithArgs(y7e,e);break;case 10:_.hasZ=b.getBool();break;case 11:_.hasM=b.getBool();break;case 12:_.transform=b.processMessage(m7e);break;case 9:{const T=b.getBool();_.exceededTransferLimit=T;break}case 13:e.addField(_,b.processMessage(u7e));break;case 15:x||(e.prepareFeatures(_),x=!0),e.addFeature(_,b.processMessageWithArgs(d7e,e,_,_.fields));break;case 2:_.uniqueIdField=b.processMessage(h7e);break;default:b.skip()}return e.finishFeatureResult(_),_}function v7e(t,e){const s={};let n=null;for(;t.next();)switch(t.tag()){case 4:n=t.processMessageWithArgs(l7e);break;case 1:s.featureResult=t.processMessageWithArgs(_7e,e);break;default:t.skip()}return v(n)&&s.featureResult&&e.addQueryGeometry(s,n),s}function b7e(t,e){try{const i=new aG(new Uint8Array(t),new DataView(t)),s={};for(;i.next();)i.tag()===2?s.queryResult=i.processMessageWithArgs(v7e,e):i.skip();return s}catch(r){throw new j("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:r})}}function w7e(t,e){const r=b7e(t,e),i=r.queryResult.featureResult,s=r.queryResult.queryGeometry,n=r.queryResult.queryGeometryType;if(i&&i.features&&i.features.length&&i.objectIdFieldName){const o=i.objectIdFieldName;for(const a of i.features)a.attributes&&(a.objectId=a.attributes[o])}return i&&(i.queryGeometry=s,i.queryGeometryType=n),i}function lG(t,e,r){if(!r||!r.features||!r.hasZ)return;const i=kfe(r.geometryType,e,t.outSpatialReference);if(!C(i))for(const s of r.features)i(s.geometry)}const xre="Layer does not support extent calculation.";function x7e(t,e){if(e&&t.type==="extent")return`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`;if(e&&t.type==="point")return`${t.x},${t.y}`;const r=t.toJSON();return delete r.spatialReference,JSON.stringify(r)}function T7e(t,e){const r=t.geometry,i=t.toJSON();delete i.compactGeometryEnabled,delete i.defaultSpatialReferenceEnabled;const s=i;let n,o,a;if(v(r)&&(o=r.spatialReference,a=r.spatialReference.wkid||JSON.stringify(r.spatialReference),s.geometryType=zE(r),s.geometry=x7e(r,t.compactGeometryEnabled),s.inSR=a),i.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=i.groupByFieldsForStatistics.join(",")),i.objectIds&&(s.objectIds=i.objectIds.join(",")),i.orderByFields&&(s.orderByFields=i.orderByFields.join(",")),!i.outFields||!i.returnDistinctValues&&(e!=null&&e.returnCountOnly||e!=null&&e.returnExtentOnly||e!=null&&e.returnIdsOnly)?delete s.outFields:i.outFields.includes("*")?s.outFields="*":s.outFields=i.outFields.join(","),i.outSR?(s.outSR=i.outSR.wkid||JSON.stringify(i.outSR),n=t.outSpatialReference):r&&(i.returnGeometry||i.returnCentroid)&&(s.outSR=s.inSR,n=o),i.returnGeometry&&delete i.returnGeometry,i.outStatistics&&(s.outStatistics=JSON.stringify(i.outStatistics)),i.fullText&&(s.fullText=JSON.stringify(i.fullText)),i.pixelSize&&(s.pixelSize=JSON.stringify(i.pixelSize)),i.quantizationParameters&&(t.defaultSpatialReferenceEnabled&&v(o)&&v(t.quantizationParameters)&&v(t.quantizationParameters.extent)&&o.equals(t.quantizationParameters.extent.spatialReference)&&delete i.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(i.quantizationParameters)),i.parameterValues&&(s.parameterValues=JSON.stringify(i.parameterValues)),i.rangeValues&&(s.rangeValues=JSON.stringify(i.rangeValues)),i.dynamicDataSource&&(s.layer=JSON.stringify({source:i.dynamicDataSource}),delete i.dynamicDataSource),i.timeExtent){const l=i.timeExtent,{start:c,end:h}=l;c==null&&h==null||(s.time=c===h?c:`${c??"null"},${h??"null"}`),delete i.timeExtent}return t.defaultSpatialReferenceEnabled&&v(o)&&v(n)&&o.equals(n)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function S7e(t,e,r,i){const s=v(e.timeExtent)&&e.timeExtent.isEmpty?{data:{features:[]}}:await GM(t,e,"json",i);return lG(e,r,s.data),s}async function gAt(t,e,r,i){if(v(e.timeExtent)&&e.timeExtent.isEmpty)return{data:r.createFeatureResult()};const s=await E7e(t,e,i),n=s;return n.data=w7e(s.data,r),n}function E7e(t,e,r){return GM(t,e,"pbf",r)}function yAt(t,e,r){return v(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):GM(t,e,"json",r,{returnIdsOnly:!0})}function C7e(t,e,r){return v(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):GM(t,e,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}function _At(t,e,r){return v(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):GM(t,e,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then(i=>{const s=i.data;if(s.hasOwnProperty("extent"))return i;if(s.features)throw new Error(xre);if(s.hasOwnProperty("count"))throw new Error(xre);return i})}function GM(t,e,r,i={},s={}){const n=typeof t=="string"?lo(t):t,o=e.geometry?[e.geometry]:[];return i.responseType=r==="pbf"?"array-buffer":"json",ove(o,null,i).then(a=>{const l=a&&a[0];v(l)&&((e=e.clone()).geometry=l);const c=ave({...n.query,f:r,...s,...T7e(e,s)});return Pi(Nu(n.path,"query"),{...i,query:{...c,...i.query}})})}var cG;const uG=new Vr({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let jo=cG=class extends fe{constructor(t){super(t),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(t,e){var s;const r=We.fromJSON(e.spatialReference),i=[];for(let n=0;n<t.length;n++){const o=t[n],a=Sa.fromJSON(o),l=o.geometry&&o.geometry.spatialReference;v(a.geometry)&&!l&&(a.geometry.spatialReference=r);const c=o.aggregateGeometries,h=a.aggregateGeometries;if(c&&v(h))for(const p in h){const f=h[p],m=(s=c[p])==null?void 0:s.spatialReference;v(f)&&!m&&(f.spatialReference=r)}i.push(a)}return i}writeGeometryType(t,e,r,i){if(t)return void uG.write(t,e,r,i);const{features:s}=this;if(s){for(const n of s)if(n&&v(n.geometry))return void uG.write(n.geometry.type,e,r,i)}}readQueryGeometry(t,e){if(!t)return null;const r=!!t.spatialReference,i=um(t);return i&&!r&&e.spatialReference&&(i.spatialReference=We.fromJSON(e.spatialReference)),i}writeSpatialReference(t,e){if(t)return void(e.spatialReference=t.toJSON());const{features:r}=this;if(r){for(const i of r)if(i&&v(i.geometry)&&i.geometry.spatialReference)return void(e.spatialReference=i.geometry.spatialReference.toJSON())}}clone(){return new cG(this.cloneProperties())}cloneProperties(){return te({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(t){const e=this.write();if(e.features&&Array.isArray(t)&&t.length>0)for(let r=0;r<e.features.length;r++){const i=e.features[r];if(i.geometry){const s=t&&t[r];i.geometry=s&&s.toJSON()||i.geometry}}return e}quantize(t){const{scale:[e,r],translate:[i,s]}=t,n=c=>Math.round((c-i)/e),o=c=>Math.round((s-c)/r),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l!=null&&l(a[c].geometry)||(a.splice(c,1),c--,h--);return this.transform=t,this}unquantize(){const{geometryType:t,features:e,transform:r}=this;if(!r)return this;const{translate:[i,s],scale:[n,o]}=r,a=h=>h*n+i,l=h=>s-h*o,c=this._getHydrationFunction(t,a,l);for(const{geometry:h}of e)v(h)&&c&&c(h);return this.transform=null,this}_quantizePoints(t,e,r){let i,s;const n=[];for(let o=0,a=t.length;o<a;o++){const l=t[o];if(o>0){const c=e(l[0]),h=r(l[1]);c===i&&h===s||(n.push([c-i,h-s]),i=c,s=h)}else i=e(l[0]),s=r(l[1]),n.push([i,s])}return n.length>0?n:null}_getQuantizationFunction(t,e,r){return t==="point"?i=>(i.x=e(i.x),i.y=r(i.y),i):t==="polyline"||t==="polygon"?i=>{const s=rw(i)?i.rings:i.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,e,r);c&&n.push(c)}return n.length>0?(rw(i)?i.rings=n:i.paths=n,i):null}:t==="multipoint"?i=>{const s=this._quantizePoints(i.points,e,r);return s&&s.length>0?(i.points=s,i):null}:t==="extent"?i=>i:null}_getHydrationFunction(t,e,r){return t==="point"?i=>{i.x=e(i.x),i.y=r(i.y)}:t==="polyline"||t==="polygon"?i=>{const s=rw(i)?i.rings:i.paths;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];for(let h=0,p=c.length;h<p;h++){const f=c[h];h>0?(n+=f[0],o+=f[1]):(n=f[0],o=f[1]),f[0]=e(n),f[1]=r(o)}}}:t==="extent"?i=>{i.xmin=e(i.xmin),i.ymin=r(i.ymin),i.xmax=e(i.xmax),i.ymax=r(i.ymax)}:t==="multipoint"?i=>{const s=i.points;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];a>0?(n+=c[0],o+=c[1]):(n=c[0],o=c[1]),c[0]=e(n),c[1]=r(o)}}:null}};u([d({type:String,json:{write:!0}})],jo.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],jo.prototype,"exceededTransferLimit",void 0),u([d({type:[Sa],json:{write:!0}})],jo.prototype,"features",void 0),u([Le("features")],jo.prototype,"readFeatures",null),u([d({type:[W5],json:{write:!0}})],jo.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:uG.read}}})],jo.prototype,"geometryType",void 0),u([ke("geometryType")],jo.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],jo.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],jo.prototype,"hasZ",void 0),u([d({types:tx,json:{write:!0}})],jo.prototype,"queryGeometry",void 0),u([Le("queryGeometry")],jo.prototype,"readQueryGeometry",null),u([d({type:We,json:{write:!0}})],jo.prototype,"spatialReference",void 0),u([ke("spatialReference")],jo.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],jo.prototype,"transform",void 0),jo=cG=u([P("esri.rest.support.FeatureSet")],jo),jo.prototype.toJSON.isDefaultToJSON=!0;const XY=jo;let H1=class extends bs(fe){constructor(e){super(e),this.onFields=null,this.operator=null,this.searchTerm=null,this.searchType=null}};u([d({type:[String],json:{write:{enabled:!0,overridePolicy(){return{enabled:v(this.onFields)&&this.onFields.length>0}}}}})],H1.prototype,"onFields",void 0),u([d({type:String,json:{write:!0}})],H1.prototype,"operator",void 0),u([d({type:String,json:{write:!0}})],H1.prototype,"searchTerm",void 0),u([d({type:String,json:{write:!0}})],H1.prototype,"searchType",void 0),H1=u([P("esri.rest.support.FullTextSearch")],H1);const A7e=H1;var hG;const Tre=new Vr({upperLeft:"upper-left",lowerLeft:"lower-left"});let q1=hG=class extends fe{constructor(t){super(t),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new hG(te({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:Hr,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],q1.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],q1.prototype,"mode",void 0),u([d({type:String,json:{read:Tre.read,write:Tre.write}})],q1.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],q1.prototype,"tolerance",void 0),q1=hG=u([P("esri.rest.support.QuantizationParameters")],q1);const R7e=q1;var dG;const Sre=new Vr({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete",EnvelopeAggregate:"envelope-aggregate",CentroidAggregate:"centroid-aggregate",ConvexHullAggregate:"convex-hull-aggregate"});let Od=dG=class extends fe{constructor(t){super(t),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(t,e){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(e.statisticParameters=te(t))}clone(){return new dG({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:te(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],Od.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],Od.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],Od.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],Od.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],Od.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:Sre.read},write:{target:"statisticType",writer:Sre.write}}})],Od.prototype,"statisticType",void 0),u([d({type:Object})],Od.prototype,"statisticParameters",void 0),u([ke("statisticParameters")],Od.prototype,"writeStatisticParameters",null),Od=dG=u([P("esri.rest.support.StatisticDefinition")],Od);const dve=Od;var fS;const O7e=new Vr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),M7e=new Vr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Bt=fS=class extends fe{static from(t){return zS(fS,t)}constructor(t){super(t),this.aggregateIds=null,this.cacheHint=void 0,this.compactGeometryEnabled=!1,this.datumTransformation=null,this.defaultSpatialReferenceEnabled=!1,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.fullText=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}castDatumTransformation(t){return typeof t=="number"||typeof t=="object"?t:null}writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeParameterValues(t,e){if(t){const r={};for(const i in t){const s=t[i];Array.isArray(s)?r[i]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?r[i]=s.getTime():r[i]=s}e.parameterValues=r}}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,e.where="1=1"}writeWhere(t,e){e.where=t||"1=1"}clone(){return new fS(te({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,compactGeometryEnabled:this.compactGeometryEnabled,datumTransformation:this.datumTransformation,defaultSpatialReferenceEnabled:this.defaultSpatialReferenceEnabled,distance:this.distance,fullText:this.fullText,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:v(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};Bt.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],Bt.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],Bt.prototype,"cacheHint",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"compactGeometryEnabled",void 0),u([d({json:{write:!0}})],Bt.prototype,"datumTransformation",void 0),u([Gt("datumTransformation")],Bt.prototype,"castDatumTransformation",null),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"defaultSpatialReferenceEnabled",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],Bt.prototype,"distance",void 0),u([d({type:Wd,json:{write:!0}})],Bt.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],Bt.prototype,"formatOf3DObjects",void 0),u([d({type:[A7e],json:{write:{enabled:!0,overridePolicy(){return{enabled:v(this.fullText)&&this.fullText.length>0}}}}})],Bt.prototype,"fullText",void 0),u([d({type:String,json:{write:!0}})],Bt.prototype,"gdbVersion",void 0),u([d({types:tx,json:{read:um,write:!0}})],Bt.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Bt.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],Bt.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],Bt.prototype,"having",void 0),u([d({type:Date})],Bt.prototype,"historicMoment",void 0),u([ke("historicMoment")],Bt.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],Bt.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:t=>t<1?1:t>fS.MAX_MAX_RECORD_COUNT_FACTOR?fS.MAX_MAX_RECORD_COUNT_FACTOR:t,json:{write:{overridePolicy:t=>({enabled:t>1})}}})],Bt.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],Bt.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Bt.prototype,"num",void 0),u([d({json:{write:!0}})],Bt.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Bt.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Bt.prototype,"outFields",void 0),u([d({type:We,json:{name:"outSR",write:!0}})],Bt.prototype,"outSpatialReference",void 0),u([d({type:[dve],json:{write:{enabled:!0,overridePolicy(){return{enabled:v(this.outStatistics)&&this.outStatistics.length>0}}}}})],Bt.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],Bt.prototype,"parameterValues",void 0),u([ke("parameterValues")],Bt.prototype,"writeParameterValues",null),u([d({type:_t,json:{write:!0}})],Bt.prototype,"pixelSize",void 0),u([d({type:R7e,json:{write:!0}})],Bt.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],Bt.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],Bt.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],Bt.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],Bt.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],Bt.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Bt.prototype,"returnZ",void 0),u([d({type:We,json:{write:!0}})],Bt.prototype,"sourceSpatialReference",void 0),u([mt(O7e,{ignoreUnknown:!1,name:"spatialRel"})],Bt.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Bt.prototype,"start",void 0),u([ke("start"),ke("num")],Bt.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],Bt.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],Bt.prototype,"text",void 0),u([d({type:Sm,json:{write:!0}})],Bt.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Bt.prototype,"timeReferenceUnknownClient",void 0),u([mt(M7e,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(t){return{enabled:!!t&&this.distance!=null&&this.distance>0}}}}})],Bt.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(t){return{enabled:t!=null||this.start!=null&&this.start>0}}}}})],Bt.prototype,"where",void 0),u([ke("where")],Bt.prototype,"writeWhere",null),Bt=fS=u([P("esri.rest.support.Query")],Bt);const Lc=Bt;async function SO(t,e,r){const i=await P7e(t,e,r);return XY.fromJSON(i)}async function P7e(t,e,r){const i=X5(t),s={...r},n=Lc.from(e),{data:o}=await S7e(i,n,n.sourceSpatialReference,s);return o}function Ea(t,e){return t?e?4:3:e?3:2}const jM=se.getLogger("esri.layers.graphics.featureConversionUtils"),pve={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},I7e=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n},Ere=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+2]},$7e=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+3]},L7e=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+2],t[r+3]=e[i+3]};function YY(t,e,r,i){if(t){if(r)return e&&i?L7e:Ere;if(e&&i)return $7e}else if(e&&i)return Ere;return I7e}function l8({scale:t,translate:e},r){return Math.round((r-e[0])/t[0])}function c8({scale:t,translate:e},r){return Math.round((e[1]-r)/t[1])}function u8({scale:t,translate:e},r,i){return r*t[i]+e[i]}function bAt(t,e,r){return t?e?r?KY(t):ZY(t):r?JY(t):Y5(t):null}function Y5(t){const e=t.coords;return{x:e[0],y:e[1]}}function fve(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function ZY(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function D7e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function JY(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function N7e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function KY(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function F7e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function U7e(t,e,r,i){let s=Y5;r&&i?s=KY:r?s=ZY:i&&(s=JY);for(const n of e){const{geometry:o,attributes:a}=n,l=v(o)?s(o):null;t.push({attributes:a,geometry:l})}return t}function QY(t,e){return t&&e?F7e:t?D7e:e?N7e:fve}function V7e(t,e,r,i,s){const n=QY(r,i);for(const{geometry:o,attributes:a}of e){const l=v(o)?n(new Tp,o):null;t.push(new lv(l,a,null,s?a[s]:void 0))}return t}function wAt(t,e,r=QY(e.z!=null,e.m!=null)){return r(t,e)}function k7e(t,e,r,i){for(const{geometry:s,attributes:n}of e)t.push({attributes:n,geometry:v(s)?mve(s,r,i):null});return t}function mve(t,e,r){if(C(t))return null;const i=Ea(e,r),s=[];for(let n=0;n<t.coords.length;n+=i){const o=[];for(let a=0;a<i;a++)o.push(t.coords[n+a]);s.push(o)}return e?r?{points:s,hasZ:e,hasM:r}:{points:s,hasZ:e}:r?{points:s,hasM:r}:{points:s}}function z7e(t,e,r,i,s){const n=Ea(r,i);for(const{geometry:o,attributes:a}of e){const l=v(o)?gve(new Tp,o,n):null;t.push(new lv(l,a,null,s?a[s]:void 0))}return t}function gve(t,e,r=Ea(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const i=t.coords;let s=0;for(const n of e.points)for(let o=0;o<r;o++)i[s++]=n[o];return t}function B7e(t,e,r,i){for(const{geometry:s,attributes:n}of e)t.push({attributes:n,geometry:v(s)?yve(s,r,i):null});return t}function yve(t,e,r){if(!t)return null;const i=Ea(e,r),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<i;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?r?{paths:o,hasZ:e,hasM:r}:{paths:o,hasZ:e}:r?{paths:o,hasM:r}:{paths:o}}function G7e(t,e,r,i,s){const n=Ea(r,i);for(const{geometry:o,attributes:a}of e){const l=v(o)?_ve(new Tp,o,n):null;t.push(new lv(l,a,null,s?a[s]:void 0))}return t}function _ve(t,e,r=Ea(e.hasZ,e.hasM)){const{lengths:i,coords:s}=t;let n=0;for(const o of e.paths){for(const a of o)for(let l=0;l<r;l++)s[n++]=a[l];i.push(o.length)}return t}function j7e(t,e,r,i){for(const{geometry:s,attributes:n,centroid:o}of e){const a=v(s)?vve(s,r,i):null;if(v(o)){const l=Y5(o);t.push({attributes:n,centroid:l,geometry:a})}else t.push({attributes:n,geometry:a})}return t}function vve(t,e,r){if(!t)return null;const i=Ea(e,r),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<i;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?r?{rings:o,hasZ:e,hasM:r}:{rings:o,hasZ:e}:r?{rings:o,hasM:r}:{rings:o}}function H7e(t,e,r,i,s){for(const{geometry:n,centroid:o,attributes:a}of e){const l=v(n)?bve(new Tp,n,r,i):null,c=s?a[s]:void 0;v(o)?t.push(new lv(l,a,fve(new Tp,o),c)):t.push(new lv(l,a,null,c))}return t}function bve(t,e,r=e.hasZ,i=e.hasM){return q7e(t,e.rings,r,i),t}function q7e(t,e,r,i){const s=Ea(r,i),{lengths:n,coords:o}=t;let a=0;qg(t);for(const l of e){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return t}const mS=[],EO=[];function xAt(t,e,r,i,s){mS[0]=t;const[n]=wve(EO,mS,e,r,i,s);return Sp(mS),Sp(EO),n}function wve(t,e,r,i,s,n){if(Sp(t),!r){for(const o of e){const a=n?o.attributes[n]:void 0;t.push(new lv(null,o.attributes,null,a))}return t}switch(r){case"esriGeometryPoint":return V7e(t,e,i,s,n);case"esriGeometryMultipoint":return z7e(t,e,i,s,n);case"esriGeometryPolyline":return G7e(t,e,i,s,n);case"esriGeometryPolygon":return H7e(t,e,i,s,n);default:jM.error("convertToFeatureSet:unknown-geometry",new j(`Unable to parse unknown geometry type '${r}'`)),Sp(t)}return t}function TAt(t,e,r,i){EO[0]=t,xve(mS,EO,e,r,i);const s=mS[0];return Sp(mS),Sp(EO),s}function W7e(t,e,r){if(C(t))return null;const i=new Tp;return"hasZ"in t&&e==null&&(e=t.hasZ),"hasM"in t&&r==null&&(r=t.hasM),aX(t)?QY(e??t.z!=null,r??t.m!=null)(i,t):rw(t)?bve(i,t,e,r):lX(t)?_ve(i,t,Ea(e,r)):oX(t)?gve(i,t,Ea(e,r)):void jM.error("convertFromGeometry:unknown-geometry",new j(`Unable to parse unknown geometry type '${t}'`))}function X7e(t,e,r,i){const s=t&&("coords"in t?t:t.geometry);if(C(s))return null;switch(e){case"esriGeometryPoint":{let n=Y5;return r&&i?n=KY:r?n=ZY:i&&(n=JY),n(s)}case"esriGeometryMultipoint":return mve(s,r,i);case"esriGeometryPolyline":return yve(s,r,i);case"esriGeometryPolygon":return vve(s,r,i);default:return jM.error("convertToGeometry:unknown-geometry",new j(`Unable to parse unknown geometry type '${e}'`)),null}}function Y7e(t,e){for(const r of e)t.push({attributes:r.attributes});return t}function xve(t,e,r,i,s){if(Sp(t),C(r))return Y7e(t,e);switch(r){case"esriGeometryPoint":return U7e(t,e,i,s);case"esriGeometryMultipoint":return k7e(t,e,i,s);case"esriGeometryPolyline":return B7e(t,e,i,s);case"esriGeometryPolygon":return j7e(t,e,i,s);default:jM.error("convertToFeatureSet:unknown-geometry",new j(`Unable to parse unknown geometry type '${r}'`))}return t}function SAt(t){const{objectIdFieldName:e,spatialReference:r,transform:i,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=t,m={features:xve([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:e,spatialReference:r,uniqueIdField:h,queryGeometry:X7e(p,f,!1,!1)};return i&&(m.transform=i),c&&(m.exceededTransferLimit=c),n&&(m.hasM=n),o&&(m.hasZ=o),m}function EAt(t,e){const r=new cve,{hasM:i,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=t;return p&&(r.fields=p),r.geometryType=l??null,r.objectIdFieldName=o??e??null,r.spatialReference=a??null,r.objectIdFieldName?(n&&wve(r.features,n,l,s,i,r.objectIdFieldName),c&&(r.exceededTransferLimit=c),i&&(r.hasM=i),s&&(r.hasZ=s),h&&(r.transform=h),r):(jM.error(new j("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),r)}function CAt(t){const{transform:e,features:r,hasM:i,hasZ:s}=t;if(!e)return t;for(const n of r)v(n.geometry)&&Are(n.geometry,n.geometry,i,s,e),v(n.centroid)&&Are(n.centroid,n.centroid,i,s,e);return t.transform=null,t}function AAt(t,e){const{geometryType:r,features:i,hasM:s,hasZ:n}=e;if(!t)return e;for(let o=0;o<i.length;o++){const a=i[o],l=a.weakClone();l.geometry=new Tp,Cre(l.geometry,a.geometry,s,n,r,t),a.centroid&&(l.centroid=new Tp,Cre(l.centroid,a.centroid,s,n,"esriGeometryPoint",t)),i[o]=l}return e.transform=t,e}function Cre(t,e,r,i,s,n,o=r,a=i){if(qg(t),C(e)||!e.coords.length)return null;const l=pve[s],{coords:c,lengths:h}=e,p=Ea(r,i),f=Ea(r&&o,i&&a),m=YY(r,i,o,a);if(!h.length)return m(t.coords,c,0,0,l8(n,c[0]),c8(n,c[1])),qg(t,p,0),t;let y,_,b,x,T=0,S=0,E=S;for(const O of h){if(O<l)continue;let R=0;S=E,b=y=l8(n,c[T]),x=_=c8(n,c[T+1]),m(t.coords,c,S,T,b,x),R++,T+=p,S+=f;for(let L=1;L<O;L++,T+=p)b=l8(n,c[T]),x=c8(n,c[T+1]),b===y&&x===_||(m(t.coords,c,S,T,b-y,x-_),S+=f,R++,y=b,_=x);R>=l&&(t.lengths.push(R),E=S)}return Sp(t.coords,E),t.coords.length?t:null}function RAt(t,e,r,i,s,n,o=r,a=i){if(qg(t),!e||!e.coords.length)return null;const l=pve[s],{coords:c,lengths:h}=e,p=Ea(r,i),f=Ea(r&&o,i&&a),m=YY(r,i,o,a);if(!h.length)return m(t.coords,c,0,0,c[0],c[1]),qg(t,p,0),t;let y=0;const _=n*n;for(const b of h){if(b<l){y+=b*p;continue}const x=t.coords.length/f,T=y,S=y+(b-1)*p;m(t.coords,c,t.coords.length,T,c[T],c[T+1]),pG(t.coords,c,p,_,m,T,S),m(t.coords,c,t.coords.length,S,c[S],c[S+1]);const E=t.coords.length/f-x;E>=l?t.lengths.push(E):Sp(t.coords,x*f),y+=b*p}return t.coords.length?t:null}function Z7e(t,e,r,i){const s=t[e],n=t[e+1],o=t[r],a=t[r+1],l=t[i],c=t[i+1];let h=o,p=a,f=l-h,m=c-p;if(f!==0||m!==0){const y=((s-h)*f+(n-p)*m)/(f*f+m*m);y>1?(h=l,p=c):y>0&&(h+=f*y,p+=m*y)}return f=s-h,m=n-p,f*f+m*m}function pG(t,e,r,i,s,n,o){let a,l=i,c=0;for(let h=n+r;h<o;h+=r)a=Z7e(e,h,n,o),a>l&&(c=h,l=a);l>i&&(c-n>r&&pG(t,e,r,i,s,n,c),s(t,e,t.length,c,e[c],e[c+1]),o-c>r&&pG(t,e,r,i,s,c,o))}function OAt(t,e,r,i){if(C(e)||!e.coords||!e.coords.length)return null;const s=Ea(r,i);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(e&&e.coords){const c=e.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return FB(t)?N4e(t,n,o,a,l):fX(n,o,a,l,t),t}function Are(t,e,r,i,s){const{coords:n,lengths:o}=e,a=Ea(r,i);if(!n.length)return t!==e&&qg(t),t;z4(s);const{originPosition:l,scale:c,translate:h}=s,p=K7e;p.originPosition=l;const f=p.scale;f[0]=c[0]??1,f[1]=-(c[1]??1),f[2]=c[2]??1,f[3]=c[3]??1;const m=p.translate;if(m[0]=h[0]??0,m[1]=h[1]??0,m[2]=h[2]??0,m[3]=h[3]??0,!o.length){for(let _=0;_<a;++_)t.coords[_]=u8(p,n[_],_);return t!==e&&qg(t,a,0),t}let y=0;for(let _=0;_<o.length;_++){const b=o[_];t.lengths[_]=b;for(let S=0;S<a;++S)t.coords[y+S]=u8(p,n[y+S],S);let x=t.coords[y],T=t.coords[y+1];y+=a;for(let S=1;S<b;S++,y+=a){x+=n[y]*f[0],T+=n[y+1]*f[1],t.coords[y]=x,t.coords[y+1]=T;for(let E=2;E<a;++E)t.coords[y+E]=u8(p,n[y+E],E)}}return t!==e&&qg(t,n.length,o.length),t}function MAt(t,e,r,i,s,n){if(qg(t),t.lengths.push(...e.lengths),r===s&&i===n)for(let o=0;o<e.coords.length;o++)t.coords.push(e.coords[o]);else{const o=Ea(r,i),a=YY(r,i,s,n),l=e.coords;for(let c=0;c<l.length;c+=o)a(t.coords,l,t.coords.length,c,l[c],l[c+1])}return t}function J7e(t,e,r,i){let s=0,n=t[i*e],o=t[i*(e+1)];for(let a=1;a<r;a++){const l=n+t[i*(e+a)],c=o+t[i*(e+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function PAt(t,e){const{coords:r,lengths:i}=t;let s=0,n=0;for(let o=0;o<i.length;o++){const a=i[o];n+=J7e(r,s,a,e),s+=a}return Math.abs(n)}function IAt(t,e){if(C(t))return null;const r=t.clone(),i=t.coords,s=t.lengths;let n=0;for(let o=0;o<s.length;o++){const a=s[o];let l=i[e*n],c=i[e*n+1];for(let h=1;h<a;h++){const p=l+i[e*(n+h)],f=c+i[e*(n+h)+1];r.coords[e*(n+h)]=p,r.coords[e*(n+h)+1]=f,l=p,c=f}n+=a}return r}function qg(t,e=0,r=0){Sp(t.lengths,r),Sp(t.coords,e)}function Sp(t,e=0){t.length!==e&&(t.length=e)}const K7e={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};var fG;let en=fG=class extends fe{constructor(t){super(t),this.cacheHint=void 0,this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(e.definitionExpression="1=1")}clone(){return new fG(te({cacheHint:this.cacheHint,dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:Boolean,json:{write:!0}})],en.prototype,"cacheHint",void 0),u([d({type:Wd,json:{write:!0}})],en.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],en.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],en.prototype,"geometryPrecision",void 0),u([d({type:Date})],en.prototype,"historicMoment",void 0),u([ke("historicMoment")],en.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],en.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],en.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],en.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],en.prototype,"outFields",void 0),u([d({type:We,json:{read:{source:"outSR"},write:{target:"outSR"}}})],en.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],en.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],en.prototype,"start",void 0),u([ke("start"),ke("num")],en.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],en.prototype,"num",void 0),u([d({json:{write:!0}})],en.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],en.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],en.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],en.prototype,"where",void 0),en=fG=u([P("esri.rest.support.RelationshipQuery")],en),en.from=Ls(en);const _E=en,$At=Object.freeze(Object.defineProperty({__proto__:null,default:_E},Symbol.toStringTag,{value:"Module"}));var mG;let KT=mG=class extends fe{constructor(t){super(t),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new mG({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],KT.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],KT.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],KT.prototype,"orderByFields",void 0),KT=mG=u([P("esri.rest.support.TopFilter")],KT);const Q7e=KT;var gG;const Rre=new Vr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),Ore=new Vr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Rs=gG=class extends fe{constructor(t){super(t),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new gG(te({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],Rs.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],Rs.prototype,"distance",void 0),u([d({types:tx,json:{read:um,write:!0}})],Rs.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Rs.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],Rs.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Rs.prototype,"num",void 0),u([d({json:{write:!0}})],Rs.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Rs.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Rs.prototype,"outFields",void 0),u([d({type:We,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Rs.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],Rs.prototype,"resultType",void 0),u([d({json:{write:!0}})],Rs.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Rs.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Rs.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Rs.prototype,"start",void 0),u([ke("start"),ke("num")],Rs.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:Rre.read},write:{target:"spatialRel",writer:Rre.write}}})],Rs.prototype,"spatialRelationship",void 0),u([d({type:Sm,json:{write:!0}})],Rs.prototype,"timeExtent",void 0),u([d({type:Q7e,json:{write:!0}})],Rs.prototype,"topFilter",void 0),u([d({type:String,json:{read:Ore.read,write:{writer:Ore.write,overridePolicy(t){return{enabled:v(t)&&v(this.distance)&&this.distance>0}}}}})],Rs.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],Rs.prototype,"where",void 0),Rs=gG=u([P("esri.rest.support.TopFeaturesQuery")],Rs),Rs.from=Ls(Rs);const oI=Rs,eGe="esri.widgets.Feature.support.relatedFeatureUtils",Mre=se.getLogger(eGe),Pre=new Map;function fD(t){if(!kg(t))return null;const[e,r]=t.split("/").slice(1);return{layerId:e,fieldName:r}}function tGe(t,e){if(!e.relationships)return null;let r=null;const{relationships:i}=e;return i.some(s=>s.id===parseInt(t,10)&&(r=s,!0)),r}function rGe({originRelationship:t,relationships:e,layerId:r}){let i=null;return e&&e.some(s=>(`${s.relatedTableId}`===r&&s.id===(t==null?void 0:t.id)&&(i=s),!!i)),i}function iGe(t,e){const r=e.toLowerCase();for(const i in t)if(i.toLowerCase()===r)return t[i];return null}function sGe(t,e){const r=tGe(t,e);if(r)return{url:`${e.url}/${r.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:r,relatedFields:[],outStatistics:[]}}function nGe(t,e){if(!e||!t)return;const{features:r,statsFeatures:i}=t,s=r&&r.value;e.relatedFeatures=s?s.features:[];const n=i&&i.value;e.relatedStatsFeatures=n?n.features:[]}function oGe(t,e,r,i){var n;const s=new _E;return s.outFields=["*"],s.relationshipId=typeof e.id=="number"?e.id:parseInt(e.id,10),s.objectIds=[t.attributes[r.objectIdField]],((n=r.queryRelatedFeatures)==null?void 0:n.call(r,s,i))??Promise.resolve({})}function aGe(t,e,r){let i=0;const s=[];for(;i<e.length;)s.push(`${t} IN (${e.slice(i,r+i)})`),i+=r;return s.join(" OR ")}async function lGe(t,e,r,i){const s=r.layerId.toString(),{layerInfo:n,relation:o,relatedFields:a,outStatistics:l,url:c,sourceSpatialReference:h}=e;if(!n||!o)return null;const p=rGe({originRelationship:o,relationships:n.relationships,layerId:s});if(p!=null&&p.relationshipTableId&&p.keyFieldInRelationshipTable){const m=(await oGe(t,p,r,i))[t.attributes[r.objectIdField]];if(!m)return null;const y=m.features.map(_=>_.attributes[n.objectIdField]);if(l!=null&&l.length&&n.supportsStatistics){const _=new Lc;_.where=aGe(n.objectIdField,y,1e3),_.outFields=a,_.outStatistics=l,_.sourceSpatialReference=h;const b={features:Promise.resolve(m),statsFeatures:SO(c,_)};return co(b)}}const f=p==null?void 0:p.keyField;if(f){const m=h5(pGe(n.fields,f)),y=iGe(t.attributes,o.keyField),_=m?`${f}=${y}`:`${f}='${y}'`,b=SO(c,new Lc({where:_,outFields:e.relatedFields,sourceSpatialReference:h}),i),x=e.outStatistics&&e.outStatistics.length>0&&n.supportsStatistics?SO(c,new Lc({where:_,outFields:e.relatedFields,outStatistics:e.outStatistics,sourceSpatialReference:h}),i):null,T={features:b};return x&&(T.statsFeatures=x),co(T)}return null}function cGe(t,e){return Pi(t,{query:{f:"json"},signal:e&&e.signal})}function uGe({relatedInfos:t,layer:e},r){const i={};return t.forEach((s,n)=>{const{relation:o}=s;if(!o){const p=new j("relation-required","A relation is required on a layer to retrieve related records.");throw Mre.error(p),p}const{relatedTableId:a}=o;if(typeof a!="number"){const p=new j("A related table ID is required on a layer to retrieve related records.");throw Mre.error(p),p}const l=`${e.url}/${a}`,c=Pre.get(l),h=c||cGe(l);c||Pre.set(l,h),i[n]=h}),_W(co(i),r)}function hGe({graphic:t,relatedInfos:e,layer:r},i){const s={};return e.forEach((n,o)=>{n.layerInfo&&(s[o]=lGe(t,n,r,i))}),co(s)}function dGe({relatedInfo:t,fieldName:e,fieldInfo:r}){var i,s;if((i=t.relatedFields)==null||i.push(e),r.statisticType){const n=new dve({statisticType:r.statisticType,onStatisticField:e,outStatisticFieldName:e});(s=t.outStatistics)==null||s.push(n)}}function pGe(t,e){if(t!=null){e=e.toLowerCase();for(const r of t)if(r&&r.name.toLowerCase()===e)return r}return null}const Ire={chartAnimation:!0};let Hn=class extends Te{constructor(e){super(e),this.abilities={...Ire},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return{...Ire,...e}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:r}=this,i=(e+r)%r;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){const{activeMediaInfoIndex:r}=this,i=r+e;this._setContentElementMedia(i)}_formatMediaInfos(){const{mediaInfos:e,layer:r}=this,i=this.attributes??{},s=this.formattedAttributes??{},n=this.expressionAttributes??{},o=this.fieldInfoMap??new Map;return(e==null?void 0:e.map(a=>{const l=a==null?void 0:a.clone();if(!l)return null;if(l.title=qb({attributes:i,fieldInfoMap:o,globalAttributes:s,expressionAttributes:n,layer:r,text:l.title}),l.caption=qb({attributes:i,fieldInfoMap:o,globalAttributes:s,expressionAttributes:n,layer:r,text:l.caption}),l.altText=qb({attributes:i,fieldInfoMap:o,globalAttributes:s,expressionAttributes:n,layer:r,text:l.altText}),l.type==="image"){const{value:c}=l;return this._setImageValue({value:c,formattedAttributes:s,layer:r}),l.value.sourceURL?l:void 0}if(l.type==="pie-chart"||l.type==="line-chart"||l.type==="column-chart"||l.type==="bar-chart"){const{value:c}=l;return this._setChartValue({value:c,chartType:l.type,attributes:i,formattedAttributes:s,layer:r,expressionAttributes:n}),l}return null}).filter(v))??[]}_setImageValue(e){const r=this.fieldInfoMap??new Map,{value:i,formattedAttributes:s,layer:n}=e,{linkURL:o,sourceURL:a}=i;if(a){const l=j7(a,n);i.sourceURL=G7({formattedAttributes:s,template:l,fieldInfoMap:r})}if(o){const l=j7(o,n);i.linkURL=G7({formattedAttributes:s,template:l,fieldInfoMap:r})}}_setChartValue(e){const{value:r,attributes:i,formattedAttributes:s,chartType:n,layer:o,expressionAttributes:a}=e,{popupTemplate:l,relatedInfos:c}=this,{fields:h,normalizeField:p}=r,f=o;if(r.fields=Gke(h,f),p&&(r.normalizeField=R3(p,f)),!h.some(y=>!!(s[y]!=null||kg(y)&&(c!=null&&c.size))))return;const m=(l==null?void 0:l.fieldInfos)??[];h.forEach(y=>{if(kg(y))return void(r.series=[...r.series,...this._getRelatedChartInfos({fieldInfos:m,fieldName:y,formattedAttributes:s,chartType:n,value:r})]);const _=this._getChartOption({value:r,attributes:i,chartType:n,formattedAttributes:s,expressionAttributes:a,fieldName:y,fieldInfos:m});r.series.push(_)})}_getRelatedChartInfos(e){var m;const{fieldInfos:r,fieldName:i,formattedAttributes:s,chartType:n,value:o}=e,a=[],l=fD(i),c=l&&((m=this.relatedInfos)==null?void 0:m.get(l.layerId.toString()));if(!c)return a;const{relatedFeatures:h,relation:p}=c;if(!p||!h)return a;const{cardinality:f}=p;return h.forEach(y=>{const{attributes:_}=y;_&&Object.keys(_).forEach(b=>{b===l.fieldName&&a.push(this._getChartOption({value:o,attributes:_,formattedAttributes:s,fieldName:i,chartType:n,relatedFieldName:b,hasMultipleRelatedFeatures:(h==null?void 0:h.length)>1,fieldInfos:r}))})}),f==="one-to-many"||f==="many-to-many"?a:[a[0]]}_getTooltip({label:e,value:r,chartType:i}){return i==="pie-chart"?`${e}`:`${e}: ${r}`}_getChartOption(e){var R;const{value:r,attributes:i,formattedAttributes:s,expressionAttributes:n,fieldName:o,relatedFieldName:a,fieldInfos:l,chartType:c,hasMultipleRelatedFeatures:h}=e,p=this.layer,f=this.fieldInfoMap??new Map,{normalizeField:m,tooltipField:y}=r,_=m?kg(m)?i[fD(m).fieldName]:i[m]:null,b=DY(o)&&n&&n[o]!==void 0?n[o]:a&&i[a]!==void 0?i[a]:i[o]!==void 0?i[o]:s[o],x=new Gme({fieldName:o,value:b===void 0?null:b&&_?b/_:b});if(kg(o)){const L=f.get(o.toLowerCase()),I=y&&f.get(y.toLowerCase()),U=(L==null?void 0:L.fieldName)??o,z=h&&y?fD(y).fieldName:(I==null?void 0:I.fieldName)??y,B=h&&z?i[z]:s[z]??(L==null?void 0:L.label)??(L==null?void 0:L.fieldName)??a,G=h&&a?i[a]:s[U];return x.tooltip=this._getTooltip({label:B,value:G,chartType:c}),x}const T=O_e(l,o),S=R3(o,p),E=y&&s[y]!==void 0?s[y]:A_e(T||new IM({fieldName:S}),(R=this.popupTemplate)==null?void 0:R.expressionInfos),O=s[S];return x.tooltip=this._getTooltip({label:E,value:O,chartType:c}),x}};u([d()],Hn.prototype,"abilities",void 0),u([Gt("abilities")],Hn.prototype,"castAbilities",null),u([d()],Hn.prototype,"activeMediaInfoIndex",void 0),u([d({readOnly:!0})],Hn.prototype,"activeMediaInfo",null),u([d()],Hn.prototype,"attributes",void 0),u([d()],Hn.prototype,"description",void 0),u([d()],Hn.prototype,"fieldInfoMap",void 0),u([d()],Hn.prototype,"formattedAttributes",void 0),u([d()],Hn.prototype,"expressionAttributes",void 0),u([d({readOnly:!0})],Hn.prototype,"formattedMediaInfos",null),u([d()],Hn.prototype,"isAggregate",void 0),u([d()],Hn.prototype,"layer",void 0),u([d({readOnly:!0})],Hn.prototype,"formattedMediaInfoCount",null),u([d()],Hn.prototype,"mediaInfos",void 0),u([d()],Hn.prototype,"popupTemplate",void 0),u([d()],Hn.prototype,"relatedInfos",void 0),u([d()],Hn.prototype,"title",void 0),Hn=u([P("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],Hn);const Xb=Hn;var $re=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],fGe=[].concat($re.slice(30,39),$re.slice(28,30).reverse()),mGe=[{name:"default",colors:fGe},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const Lre="en-us",eZ=new Map([["ar",()=>ie(()=>import("./ar-bb1fe5ab.js"),["./ar-bb1fe5ab.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.a)],["bg-bg",()=>ie(()=>import("./bg_BG-184a2bfa.js"),["./bg_BG-184a2bfa.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.b)],["bs-ba",()=>ie(()=>import("./bs_BA-f32cc344.js"),["./bs_BA-f32cc344.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.b)],["ca-es",()=>ie(()=>import("./ca_ES-d17ee95b.js"),["./ca_ES-d17ee95b.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.c)],["cs-cz",()=>ie(()=>import("./cs_CZ-bcd1e782.js"),["./cs_CZ-bcd1e782.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.c)],["da-dk",()=>ie(()=>import("./da_DK-27b1b06e.js"),["./da_DK-27b1b06e.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.d)],["de-de",()=>ie(()=>import("./de_DE-c0a1d8dd.js"),["./de_DE-c0a1d8dd.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.d)],["de-ch",()=>ie(()=>import("./de_CH-be7b4255.js"),["./de_CH-be7b4255.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.d)],["el-gr",()=>ie(()=>import("./el_GR-05fb9ec0.js"),["./el_GR-05fb9ec0.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.e)],["en-us",()=>ie(()=>import("./en_US-170979d8.js"),["./en_US-170979d8.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.e)],["en-ca",()=>ie(()=>import("./en_CA-170979d8.js"),["./en_CA-170979d8.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.e)],["es-es",()=>ie(()=>import("./es_ES-d0b66640.js"),["./es_ES-d0b66640.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.e)],["et-ee",()=>ie(()=>import("./et_EE-56dd74d3.js"),["./et_EE-56dd74d3.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.e)],["fi-fi",()=>ie(()=>import("./fi_FI-91d58cb9.js"),["./fi_FI-91d58cb9.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.f)],["fr-fr",()=>ie(()=>import("./fr_FR-a11503e0.js"),["./fr_FR-a11503e0.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.f)],["he-il",()=>ie(()=>import("./he_IL-90db98c4.js"),["./he_IL-90db98c4.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.h)],["hr-hr",()=>ie(()=>import("./hr_HR-fac8bb29.js"),["./hr_HR-fac8bb29.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.h)],["hu-hu",()=>ie(()=>import("./hu_HU-e8803856.js"),["./hu_HU-e8803856.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.h)],["id-id",()=>ie(()=>import("./id_ID-86e57d06.js"),["./id_ID-86e57d06.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.i)],["it-it",()=>ie(()=>import("./it_IT-2d4485ba.js"),["./it_IT-2d4485ba.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.i)],["ja-jp",()=>ie(()=>import("./ja_JP-77c6c16d.js"),["./ja_JP-77c6c16d.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.j)],["ko-kr",()=>ie(()=>import("./ko_KR-e155b9ab.js"),["./ko_KR-e155b9ab.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.k)],["lt-lt",()=>ie(()=>import("./lt_LT-fde47ae9.js"),["./lt_LT-fde47ae9.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.l)],["lv-lv",()=>ie(()=>import("./lv_LV-359be050.js"),["./lv_LV-359be050.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.l)],["nb-no",()=>ie(()=>import("./nb_NO-30d57c1a.js"),["./nb_NO-30d57c1a.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.n)],["nl-nl",()=>ie(()=>import("./nl_NL-cb904b48.js"),["./nl_NL-cb904b48.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.n)],["pl-pl",()=>ie(()=>import("./pl_PL-58c54c9f.js"),["./pl_PL-58c54c9f.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.p)],["pt-br",()=>ie(()=>import("./pt_BR-d2e10248.js"),["./pt_BR-d2e10248.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.p)],["pt-pt",()=>ie(()=>import("./pt_PT-65a41842.js"),["./pt_PT-65a41842.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.p)],["ro-ro",()=>ie(()=>import("./ro_RO-15e90e9f.js"),["./ro_RO-15e90e9f.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.r)],["ru-ru",()=>ie(()=>import("./ru_RU-a74d21e5.js"),["./ru_RU-a74d21e5.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.r)],["sk-sk",()=>ie(()=>import("./sk_SK-a928dbd1.js"),["./sk_SK-a928dbd1.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.s)],["sl-sl",()=>ie(()=>import("./sl_SL-1a3c3078.js"),["./sl_SL-1a3c3078.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.s)],["sr-rs",()=>ie(()=>import("./sr_RS-0b18b911.js"),["./sr_RS-0b18b911.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.s)],["sv-se",()=>ie(()=>import("./sv_SE-ce7e3f84.js"),["./sv_SE-ce7e3f84.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.s)],["th-th",()=>ie(()=>import("./th_TH-1448f333.js"),["./th_TH-1448f333.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.t)],["tr-tr",()=>ie(()=>import("./tr_TR-dd92f630.js"),["./tr_TR-dd92f630.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.t)],["uk-ua",()=>ie(()=>import("./uk_UA-fe4434ed.js"),["./uk_UA-fe4434ed.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.u)],["vi-vn",()=>ie(()=>import("./vi_VN-41938633.js"),["./vi_VN-41938633.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.v)],["zh-cn",()=>ie(()=>import("./zh_Hans-524a1291.js"),["./zh_Hans-524a1291.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.z)],["zh-hk",()=>ie(()=>import("./zh_Hant-0e1f08e5.js"),["./zh_Hant-0e1f08e5.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.z)],["zh-tw",()=>ie(()=>import("./zh_Hant-0e1f08e5.js"),["./zh_Hant-0e1f08e5.js","./_commonjsHelpers-2f3e7994.js","./_commonjs-dynamic-modules-42bbacb3.js"],import.meta.url).then(t=>t.z)]]);function gGe(t){const e=t.split("-")[0].toLowerCase();let r=null;for(const i of eZ.keys())if(i.startsWith(e)){r=i;break}return r}function yGe(t){return t?eZ.has(t.toLowerCase())?t.toLowerCase():gGe(t)||Lre:Lre}let Cx=null,FC=null;async function _Ge(t=Vh()){if(t=yGe(t),Cx&&t===FC)return Cx;Cx=ie(()=>import("./index-a1a574a3.js"),["./index-a1a574a3.js","./_commonjsHelpers-2f3e7994.js"],import.meta.url).then(e=>e.i),FC=t;try{const[e,r]=await Promise.all([Cx,eZ.get(FC)()]);FC===t&&(e.am4core.options.defaultLocale=r.default),e.am4core.options.suppressWarnings=!0,e.am4core.options.autoDispose=!0}catch{return Cx=null,FC=null,null}return Cx}function vGe(t,e="default"){const r=mGe.find(i=>i.name===e);return r?r.colors.map(i=>t.color(i)):null}const dl="esri-feature-media",sn={base:dl,mediaContainer:`${dl}__container`,mediaItemContainer:`${dl}__item-container`,mediaItem:`${dl}__item`,mediaItemTitle:`${dl}__item-title`,mediaItemCaption:`${dl}__item-caption`,mediaPrevious:`${dl}__previous`,mediaPreviousIconLTR:`${dl}__previous-icon`,mediaPreviousIconRTL:`${dl}__previous-icon--rtl`,mediaNext:`${dl}__next`,mediaNextIconLTR:`${dl}__next-icon`,mediaNextIconRTL:`${dl}__next-icon--rtl`,mediaChart:`${dl}__chart`,mediaButton:`${dl}__button`,mediaIcon:`${dl}__icon`,iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},h8=.05,d8=.95,p8=15,Vm="color",qy="tooltip",UC="value",Dre="default-line-value";let ac=class extends Ma{constructor(e,r){super(e,r),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this.viewModel=new Xb,this.messages=null,this._getChartDependencies=async i=>{const s=await _Ge(),{destroyed:n,viewModel:o}=this;if(n||!o||!i)return;const{activeMediaInfo:a}=o,l=await this._getRendererColors(s);this._renderChart({chartDiv:i,mediaInfo:a,chartsModule:s,colorMap:l})}}initialize(){this._featureElementInfo=new G5,this.addHandles([ne(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.activeMediaInfo,(r=this.viewModel)==null?void 0:r.activeMediaInfoIndex]},()=>this._setupMediaRefreshTimer(),kt),ne(()=>{var e,r;return[(e=this.viewModel)==null?void 0:e.description,(r=this.viewModel)==null?void 0:r.title]},()=>this._setupFeatureElementInfo(),kt)])}destroy(){var e;this._clearMediaRefreshTimer(),(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get activeMediaInfoIndex(){return this.viewModel.activeMediaInfoIndex}set activeMediaInfoIndex(e){this.viewModel.activeMediaInfoIndex=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get fieldInfoMap(){return this.viewModel.fieldInfoMap}set fieldInfoMap(e){this.viewModel.fieldInfoMap=e}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get mediaInfos(){return this.viewModel.mediaInfos}set mediaInfos(e){this.viewModel.mediaInfos=e}get popupTemplate(){return this.viewModel.popupTemplate}set popupTemplate(e){this.viewModel.popupTemplate=e}get relatedInfos(){return this.viewModel.relatedInfos}set relatedInfos(e){this.viewModel.relatedInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var e;return Q("div",{bind:this,class:sn.base,onkeyup:this._handleMediaKeyup},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?Q("div",{key:"media-element-container",class:sn.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:r}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:s}=this.viewModel,{value:n,refreshInterval:o,altText:a,title:l,type:c}=e,{sourceURL:h,linkURL:p}=n,f=C_e(p??void 0)?"_blank":"_self",m=f==="_blank"?"noreferrer":"",y=o?r:null,_=y?y.timestamp:0,b=y?y.sourceURL:h,x=Q("img",{alt:a||l,key:`media-${c}-${i}-${s}-${_}`,src:b??void 0});return(p?Q("a",{title:l,href:p,rel:m,target:f},x):null)||x}renderChartMediaInfo(e){const{activeMediaInfoIndex:r,formattedMediaInfoCount:i}=this.viewModel;return Q("div",{key:`media-${e.type}-${r}-${i}`,bind:this,class:sn.mediaChart,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?e.type==="image"?this.renderImageMediaInfo(e):e.type.includes("chart")?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const r=e.title?Q("div",{key:"media-title",class:sn.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?Q("div",{key:"media-caption",class:sn.mediaItemCaption,innerHTML:e.caption}):null;return Q("div",{key:"media-container",class:sn.mediaItemContainer},Q("div",{key:"media-item-container",class:sn.mediaItem},this.renderMediaInfoType()),r,i)}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const r=e==="previous",i=r?this.messages.previous:this.messages.next,s=r?this.classes(sn.mediaButton,sn.mediaPrevious):this.classes(sn.mediaButton,sn.mediaNext),n=r?this.classes(sn.mediaIcon,sn.mediaPreviousIconLTR,sn.iconLeftTriangleArrow):this.classes(sn.mediaIcon,sn.mediaNextIconLTR,sn.iconRightTriangleArrow),o=r?this.classes(sn.mediaIcon,sn.mediaPreviousIconRTL,sn.iconRightTriangleArrow):this.classes(sn.mediaIcon,sn.mediaNextIconRTL,sn.iconLeftTriangleArrow),a=r?"media-previous":"media-next",l=r?this._previous:this._next;return Q("button",{type:"button",key:a,title:i,"aria-label":i,tabIndex:0,class:s,bind:this,onclick:l},Q("span",{"aria-hidden":"true",class:n}),Q("span",{"aria-hidden":"true",class:o}))}_setupFeatureElementInfo(){var i;const{description:e,title:r}=this;(i=this._featureElementInfo)==null||i.set({description:e,title:r})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_getRenderer(){const{isAggregate:e,layer:r}=this.viewModel;return e&&(r!=null&&r.featureReduction)&&"renderer"in r.featureReduction?r.featureReduction.renderer:r==null?void 0:r.renderer}async _getRendererColors(e){const{am4core:r}=e,i=new Map,s=this._getRenderer(),n="default";if(!s)return i;const o=await zBe(s);return o.delete(n),Array.from(o.values()).every(a=>(a==null?void 0:a.length)===1)&&(i.set(Dre,r.color({r:50,g:50,b:50,a:1})),Array.from(o.keys()).forEach(a=>{var l;a&&i.set(a,r.color((l=o.get(a))==null?void 0:l[0].toCss(!0)))})),i}_handleMediaKeyup(e){const r=Sb(e);r==="ArrowLeft"&&(e.stopPropagation(),this.viewModel.previous()),r==="ArrowRight"&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{abilities:r}=this.viewModel,{chartsModule:i,chartDiv:s,mediaInfo:n,colorMap:o}=e,{value:a,type:l}=n,{am4core:c}=i,h=vGe(c);function p(y){y instanceof c.ColorSet&&h&&(y.list=h)}LF()&&c.useTheme(i.am4themes_dark);const f=window.matchMedia("(prefers-reduced-motion: reduce)");r.chartAnimation&&!f.matches?c.useTheme(i.am4themes_animated):c.unuseTheme(i.am4themes_animated),c.useTheme(p);const m=l==="pie-chart"?this._createPieChart(e):this._createXYChart(e);s.setAttribute("aria-label",n.altText||n.title),m.data=a.series.map(y=>({[qy]:y.tooltip,[UC]:y.value,[Vm]:o.get(y.fieldName)})).filter(y=>l!=="pie-chart"||y.value!=null&&y.value>0)}_customizeChartTooltip(e,r){e&&(e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=r.color("#ffffff"),e.background.fill=r.color({r:0,g:0,b:0,a:.7}))}_createPieChart(e){const{chartDiv:r,chartsModule:i}=e,{am4core:s,am4charts:n}=i,o=s.create(r,n.PieChart);o.rtl=qf(this.container);const a=o.series.push(new n.PieSeries);return a.labels.template.disabled=!0,a.ticks.template.disabled=!0,a.dataFields.value=UC,a.dataFields.category=qy,this._customizeChartTooltip(a.tooltip,s),a.slices.template.propertyFields.fill=Vm,a.slices.template.propertyFields.stroke=Vm,o}_getMinSeriesValue(e){let r=0;return e.forEach(i=>r=Math.min(i.value,r)),r}_createColumnChart(e,r){const{chartsModule:i,mediaInfo:s}=r,{value:n}=s,{am4core:o,am4charts:a}=i,l=e.xAxes.push(new a.CategoryAxis);l.dataFields.category=qy,l.renderer.labels.template.disabled=!0;const c=l.tooltip;this._customizeChartTooltip(c,o),c.events.on("sizechanged",()=>{c.dy=-c.contentHeight});const h=e.yAxes.push(new a.ValueAxis),p=h.renderer.labels.template;h.renderer.minLabelPosition=h8,h.renderer.maxLabelPosition=d8,h.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(h.tooltip,o),p.wrap=!0;const f=e.series.push(new a.ColumnSeries);f.dataFields.valueY=UC,f.dataFields.categoryX=qy,f.columns.template.propertyFields.fill=Vm,f.columns.template.propertyFields.stroke=Vm,e.cursor=new a.XYCursor,n.series.length>p8&&(e.scrollbarX=new o.Scrollbar)}_createBarChart(e,r){const{chartsModule:i,mediaInfo:s}=r,{value:n}=s,{am4core:o,am4charts:a}=i,l=e.yAxes.push(new a.CategoryAxis);l.dataFields.category=qy,l.renderer.inversed=!0,l.renderer.labels.template.disabled=!0;const c=l.tooltip;this._customizeChartTooltip(c,o),c.events.on("sizechanged",()=>{c.dx=c.contentWidth});const h=e.xAxes.push(new a.ValueAxis),p=h.renderer.labels.template;h.renderer.minLabelPosition=h8,h.renderer.maxLabelPosition=d8,h.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(h.tooltip,o),p.wrap=!0;const f=e.series.push(new a.ColumnSeries);f.dataFields.valueX=UC,f.dataFields.categoryY=qy,f.columns.template.propertyFields.fill=Vm,f.columns.template.propertyFields.stroke=Vm,e.cursor=new a.XYCursor,n.series.length>p8&&(e.scrollbarY=new o.Scrollbar)}_createLineChart(e,r){const{chartsModule:i,mediaInfo:s,colorMap:n}=r,{value:o}=s,{am4core:a,am4charts:l}=i,c=e.xAxes.push(new l.CategoryAxis);c.dataFields.category=qy,c.renderer.labels.template.disabled=!0;const h=c.tooltip;this._customizeChartTooltip(h,a),h.events.on("sizechanged",()=>{h.dy=-h.contentHeight});const p=e.yAxes.push(new l.ValueAxis),f=p.renderer.labels.template;p.renderer.minLabelPosition=h8,p.renderer.maxLabelPosition=d8,p.min=this._getMinSeriesValue(o.series),this._customizeChartTooltip(p.tooltip,a),f.wrap=!0;const m=e.series.push(new l.LineSeries);m.dataFields.categoryX=qy,m.dataFields.valueY=UC,m.strokeWidth=1;const y=n.get(Dre);y&&(m.stroke=y);const _=m.bullets.push(new l.CircleBullet);_.propertyFields.fill=Vm,_.propertyFields.stroke=Vm,e.cursor=new l.XYCursor,o.series.length>p8&&(e.scrollbarX=new a.Scrollbar)}_createXYChart(e){const{chartDiv:r,chartsModule:i,mediaInfo:s}=e,{type:n}=s,{am4core:o,am4charts:a}=i,l=o.create(r,a.XYChart);return l.rtl=qf(this.container),n==="column-chart"&&this._createColumnChart(l,e),n==="bar-chart"&&this._createBarChart(l,e),n==="line-chart"&&this._createLineChart(l,e),l}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const r=Date.now();this._refreshIntervalInfo={timestamp:r,sourceURL:e&&this._getImageSource(e,r)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&e.type==="image"&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:r,value:i}=e;if(!r)return;const s=6e4*r;this._updateMediaInfoTimestamp(i.sourceURL);const n=setInterval(()=>{this._updateMediaInfoTimestamp(i.sourceURL)},s);this._refreshTimer=n}_getImageSource(e,r){const i=e.includes("?")?"&":"?",[s,n=""]=e.split("#");return`${s}${i}timestamp=${r}${n?"#":""}${n}`}};u([d()],ac.prototype,"attributes",null),u([d()],ac.prototype,"activeMediaInfoIndex",null),u([d()],ac.prototype,"description",null),u([d()],ac.prototype,"fieldInfoMap",null),u([d()],ac.prototype,"layer",null),u([d()],ac.prototype,"mediaInfos",null),u([d()],ac.prototype,"popupTemplate",null),u([d()],ac.prototype,"relatedInfos",null),u([d()],ac.prototype,"title",null),u([d({type:Xb})],ac.prototype,"viewModel",void 0),u([d(),rl("esri/widgets/Feature/t9n/Feature")],ac.prototype,"messages",void 0),ac=u([P("esri.widgets.Feature.FeatureMedia")],ac);const Tve=ac;var yG;let yR=yG=class extends fe{constructor(t){super(t),this.minValue=0,this.maxValue=0}clone(){return new yG({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],yR.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],yR.prototype,"maxValue",void 0),yR=yG=u([P("esri.renderer.support.AuthoringInfoClassBreakInfo")],yR);var _G;let o_=_G=class extends fe{constructor(t){super(t),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new _G({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:te(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],o_.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],o_.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],o_.prototype,"label",void 0),u([d({type:[yR],json:{write:!0}})],o_.prototype,"classBreakInfos",void 0),o_=_G=u([P("esri.renderers.support.AuthoringInfoFieldInfo")],o_);var vG;const aI=new Vr({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),lI=new Vr({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),Nre={key:t=>typeof t=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},Fre=["high-to-low","above-and-below","centered-on","extremes"],Ure=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],Vre=["seconds","minutes","hours","days","months","years"];let lc=vG=class extends fe{constructor(t){super(t),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(t){return typeof t=="string"||typeof t=="number"?t:null}castStartTime(t){return typeof t=="string"||typeof t=="number"?t:null}get style(){return this.type==="color"?this._get("style"):null}set style(t){this._set("style",t)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(t){this._set("theme",t)}clone(){return new vG({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:Nre,json:{write:!0}})],lc.prototype,"endTime",void 0),u([Gt("endTime")],lc.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],lc.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],lc.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],lc.prototype,"minSliderValue",void 0),u([d({types:Nre,json:{write:!0}})],lc.prototype,"startTime",void 0),u([Gt("startTime")],lc.prototype,"castStartTime",null),u([d({type:aI.apiValues,value:null,json:{type:aI.jsonValues,read:aI.read,write:aI.write}})],lc.prototype,"style",null),u([d({type:Ure,value:null,json:{type:Ure,origins:{"web-scene":{type:Fre,write:{writer:(t,e)=>{Fre.includes(t)&&(e.theme=t)}}}},write:!0}})],lc.prototype,"theme",null),u([d({type:lI.apiValues,json:{type:lI.jsonValues,read:lI.read,write:lI.write}})],lc.prototype,"type",void 0),u([d({type:Vre,json:{type:Vre,write:!0}})],lc.prototype,"units",void 0),lc=vG=u([P("esri.renderers.support.AuthoringInfoVisualVariable")],lc);const bGe=lc;let mD=class extends fe{constructor(e){super(e),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],mD.prototype,"type",void 0),mD=u([P("esri.rest.support.ColorRamp")],mD);const tZ=mD;var bG;let W1=bG=class extends tZ{constructor(t){super(t),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new bG({fromColor:te(this.fromColor),toColor:te(this.toColor),algorithm:this.algorithm})}};u([mt({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],W1.prototype,"algorithm",void 0),u([d({type:Ze,json:{type:[Ti],write:!0}})],W1.prototype,"fromColor",void 0),u([d({type:Ze,json:{type:[Ti],write:!0}})],W1.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],W1.prototype,"type",void 0),W1=bG=u([P("esri.rest.support.AlgorithmicColorRamp")],W1);const rZ=W1;var wG;let _R=wG=class extends tZ{constructor(t){super(t),this.colorRamps=null,this.type="multipart"}clone(){return new wG({colorRamps:te(this.colorRamps)})}};u([d({type:[rZ],json:{write:!0}})],_R.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],_R.prototype,"type",void 0),_R=wG=u([P("esri.rest.support.MultipartColorRamp")],_R);const Sve=_R,wGe={key:"type",base:tZ,typeMap:{algorithmic:rZ,multipart:Sve}};function xGe(t){return t&&t.type?t.type==="algorithmic"?rZ.fromJSON(t):t.type==="multipart"?Sve.fromJSON(t):null:null}var xG;const zv=new Vr({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),cI=new Vr({pieChart:"pie-chart",classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density",flow:"flow"}),kre=new Vr({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),zre=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],TGe=["high-to-low","above-and-below","above","below","90-10"],SGe=["flow-line","wave-front"],EGe=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let nn=xG=class extends fe{constructor(t){super(t),this.colorRamp=null,this.fadeRatio=null,this.isAutoGenerated=!1,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const t=this._get("classificationMethod"),e=this.type;return e&&e!=="relationship"?e==="class-breaks-size"||e==="class-breaks-color"?t||"manual":null:t}set classificationMethod(t){this._set("classificationMethod",t)}readColorRamp(t){return t?xGe(t):void 0}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(t){this._set("fields",t)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(t){this._set("field1",t)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(t){this._set("field2",t)}get flowTheme(){return this.type==="flow"?this._get("flowTheme"):null}set flowTheme(t){this._set("flowTheme",t)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(t){this._set("focus",t)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(t){this._set("numClasses",t)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(t){this._set("statistics",t)}get standardDeviationInterval(){const t=this.type;return t&&t!=="relationship"&&t!=="class-breaks-size"&&t!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(t){this._set("standardDeviationInterval",t)}get type(){return this._get("type")}set type(t){let e=t;t==="classed-size"?e="class-breaks-size":t==="classed-color"&&(e="class-breaks-color"),this._set("type",e)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(t){this._set("univariateSymbolStyle",t)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(t){this._set("univariateTheme",t)}clone(){return new xG({classificationMethod:this.classificationMethod,colorRamp:te(this.colorRamp),fadeRatio:te(this.fadeRatio),fields:this.fields&&this.fields.slice(0),field1:te(this.field1),field2:te(this.field2),isAutoGenerated:this.isAutoGenerated,focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(t=>t.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme,flowTheme:this.flowTheme})}};u([d({type:zv.apiValues,value:null,json:{type:zv.jsonValues,read:zv.read,write:zv.write,origins:{"web-document":{default:"manual",type:zv.jsonValues,read:zv.read,write:zv.write}}}})],nn.prototype,"classificationMethod",null),u([d({types:wGe,json:{write:!0}})],nn.prototype,"colorRamp",void 0),u([Le("colorRamp")],nn.prototype,"readColorRamp",null),u([d({json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"fadeRatio",void 0),u([d({type:[String],value:null,json:{write:!0}})],nn.prototype,"fields",null),u([d({type:o_,value:null,json:{write:!0}})],nn.prototype,"field1",null),u([d({type:o_,value:null,json:{write:!0}})],nn.prototype,"field2",null),u([d({type:SGe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],nn.prototype,"flowTheme",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],nn.prototype,"focus",null),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],nn.prototype,"isAutoGenerated",void 0),u([d({type:Number,value:null,json:{type:Ti,write:!0}})],nn.prototype,"numClasses",null),u([d({type:zre,json:{type:zre,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],nn.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],nn.prototype,"standardDeviationInterval",null),u([d({type:cI.apiValues,value:null,json:{type:cI.jsonValues,read:cI.read,write:cI.write,origins:{"web-scene":{type:kre.jsonValues,write:{writer:kre.write,overridePolicy:t=>({enabled:t!=="flow"})}}}}})],nn.prototype,"type",null),u([d({type:[bGe],json:{write:!0}})],nn.prototype,"visualVariables",void 0),u([d({type:EGe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],nn.prototype,"univariateSymbolStyle",null),u([d({type:TGe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],nn.prototype,"univariateTheme",null),nn=xG=u([P("esri.renderers.support.AuthoringInfo")],nn);const iZ=nn,f8=new Vr({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary",pieChart:"pie-chart"},{ignoreUnknown:!0});let vR=class extends fe{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const r=new Set;return await this.collectRequiredFields(r,e),Array.from(r).sort()}getSymbol(e,r){}async getSymbolAsync(e,r){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:iZ,json:{write:!0}})],vR.prototype,"authoringInfo",void 0),u([d({type:f8.apiValues,readOnly:!0,json:{type:f8.jsonValues,read:!1,write:{writer:f8.write,ignoreOrigin:!0}}})],vR.prototype,"type",void 0),vR=u([P("esri.renderers.Renderer")],vR);const vy=vR;function CGe(t){var e,r;return((r=(e=t.match(AGe))==null?void 0:e[1])==null?void 0:r.replace(/\\'/g,"'"))??null}const AGe=/^hash\(\$feature\['((\\'|[^'])+)'\]\) \* 8\.381e-8$/;var TG;let gS=TG=class extends fe{constructor(){super(...arguments),this.title=null}clone(){return new TG({title:this.title})}};u([d({type:String,json:{write:!0}})],gS.prototype,"title",void 0),gS=TG=u([P("esri.renderers.support.LegendOptions")],gS);var SG;let gD=SG=class extends gS{constructor(){super(...arguments),this.showLegend=null}clone(){return new SG({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],gD.prototype,"showLegend",void 0),gD=SG=u([P("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],gD);const Eve=gD,m8=new Vr({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let Md=class extends fe{constructor(e){super(e),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(e){return e==null?e:typeof e=="function"?(se.getLogger(this.declaredClass).error(".field: field must be a string value"),null):xM(e)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],Md.prototype,"index",void 0),u([d({type:m8.apiValues,readOnly:!0,json:{read:m8.read,write:m8.write}})],Md.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Md.prototype,"field",void 0),u([Gt("field")],Md.prototype,"castField",null),u([d({type:String,json:{write:!0}})],Md.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Md.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],Md.prototype,"arcadeRequired",null),u([d({type:Eve,json:{write:!0}})],Md.prototype,"legendOptions",void 0),Md=u([P("esri.renderers.visualVariables.VisualVariable")],Md);const HM=Md;var EG;let X1=EG=class extends HM{constructor(t){super(t),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value),this._set("stops",t)}clone(){return new EG({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],X1.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],X1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],X1.prototype,"normalizationField",void 0),u([d({type:[Pze],json:{write:!0}})],X1.prototype,"stops",null),X1=EG=u([P("esri.renderers.visualVariables.ColorVariable")],X1);const Cve=X1;var CG;let U0=CG=class extends fe{constructor(t){super(t),this.label=null,this.opacity=null,this.value=null}readOpacity(t,e){return XS(e.transparency)}writeOpacity(t,e,r){e[r]=RM(t)}clone(){return new CG({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],U0.prototype,"label",void 0),u([d({type:Number,json:{type:Ti,write:{target:"transparency"}}})],U0.prototype,"opacity",void 0),u([Le("opacity",["transparency"])],U0.prototype,"readOpacity",null),u([ke("opacity")],U0.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],U0.prototype,"value",void 0),U0=CG=u([P("esri.renderers.visualVariables.support.OpacityStop")],U0);const RGe=U0;var AG;let Y1=AG=class extends HM{constructor(t){super(t),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value),this._set("stops",t)}clone(){return new AG({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],Y1.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],Y1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Y1.prototype,"normalizationField",void 0),u([d({type:[RGe],json:{write:!0}})],Y1.prototype,"stops",null),Y1=AG=u([P("esri.renderers.visualVariables.OpacityVariable")],Y1);const Ave=Y1;var RG;let hg=RG=class extends HM{constructor(t){super(t),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(t,e,r,i){if(i&&i.messages){const s=`visualVariables[${this.index}]`;i.messages.push(new j("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:i}))}}clone(){return new RG({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],hg.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],hg.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],hg.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],hg.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],hg.prototype,"valueExpressionTitle",void 0),u([ke("web-scene","valueExpressionTitle")],hg.prototype,"writeValueExpressionTitleWebScene",null),hg=RG=u([P("esri.renderers.visualVariables.RotationVariable")],hg);const Rve=hg;var OG;let QT=OG=class extends fe{constructor(t){super(t),this.label=null,this.size=null,this.value=null}clone(){return new OG({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],QT.prototype,"label",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],QT.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],QT.prototype,"value",void 0),QT=OG=u([P("esri.renderers.visualVariables.support.SizeStop")],QT);const e2=QT;var MG;let yD=MG=class extends Eve{constructor(){super(...arguments),this.customValues=null}clone(){return new MG({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],yD.prototype,"customValues",void 0),yD=MG=u([P("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],yD);const OGe=yD;var Wg,Ro;function L_(t){return t&&t.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function M3(t){return t!=null&&!isNaN(t)&&isFinite(t)}function Ove(t){return t.valueExpression?Wg.Expression:t.field&&typeof t.field=="string"?Wg.Field:Wg.Unknown}function MGe(t,e){const r=e||Ove(t),i=t.valueUnit||"unknown";return r===Wg.Unknown?Ro.Constant:t.stops?Ro.Stops:t.minSize!=null&&t.maxSize!=null&&t.minDataValue!=null&&t.maxDataValue!=null?Ro.ClampedLinear:i==="unknown"?t.minSize!=null&&t.minDataValue!=null?t.minSize&&t.minDataValue?Ro.Proportional:Ro.Additive:Ro.Identity:Ro.RealWorldSize}(function(t){t.Unknown="unknown",t.Expression="expression",t.Field="field"})(Wg||(Wg={})),function(t){t.Unknown="unknown",t.Stops="stops",t.ClampedLinear="clamped-linear",t.Proportional="proportional",t.Additive="additive",t.Constant="constant",t.Identity="identity",t.RealWorldSize="real-world-size"}(Ro||(Ro={}));const cv=se.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),Bre=new Sa,_D=Math.PI,Mve=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function Pve(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(y=>y.type==="color"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void cv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=i.field,{ipData:c,hasExpression:h}=i.cache;let p=i.cache.compiledFunc;if(!l&&!h){const y=i.stops;return y&&y[0]&&y[0].color}if(typeof a!="number")if(h){if(C(r)||C(r.arcade))return void cv.error("Use of arcade expressions requires an arcade context");const y={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},_=r.arcade.arcadeUtils,b=_.getViewInfo(y),x=_.createExecContext(n,b);if(!p){const T=_.createSyntaxTree(i.valueExpression);p=_.createFunction(T),i.cache.compiledFunc=p}a=_.executeFunction(p,x)}else o&&(a=o[l]);const f=i.normalizationField,m=o!=null&&f!=null?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const y=nZ(a,c);if(y){const _=y[0],b=y[1],x=_===b?i.stops[_].color:Ze.blendColors(i.stops[_].color,i.stops[b].color,y[2],v(r)?r.color:void 0);return new Ze(x)}}}function Ive(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(y=>y.type==="opacity"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void cv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=i.field,{ipData:c,hasExpression:h}=i.cache;let p=i.cache.compiledFunc;if(!l&&!h){const y=i.stops;return y&&y[0]&&y[0].opacity}if(typeof a!="number")if(h){if(C(r)||C(r.arcade))return void cv.error("Use of arcade expressions requires an arcade context");const y={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},_=r.arcade.arcadeUtils,b=_.getViewInfo(y),x=_.createExecContext(n,b);if(!p){const T=_.createSyntaxTree(i.valueExpression);p=_.createFunction(T),i.cache.compiledFunc=p}a=_.executeFunction(p,x)}else o&&(a=o[l]);const f=i.normalizationField,m=o!=null&&f!=null?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const y=nZ(a,c);if(y){const _=y[0],b=y[1];if(_===b)return i.stops[_].opacity;{const x=i.stops[_].opacity;return x+(i.stops[b].opacity-x)*y[2]}}}}function $ve(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(m=>m.type==="rotation"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void cv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=i.axis||"heading",n=s==="heading"&&i.rotationType==="arithmetic"?90:0,o=s==="heading"&&i.rotationType==="arithmetic"?-1:1,a=typeof e=="number"?null:e,l=a&&a.attributes,c=i.field,{hasExpression:h}=i.cache;let p=i.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(C(r)||C(r.arcade))return void cv.error("Use of arcade expressions requires an arcade context");const m={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},y=r.arcade.arcadeUtils,_=y.getViewInfo(m),b=y.createExecContext(a,_);if(!p){const x=y.createSyntaxTree(i.valueExpression);p=y.createFunction(x),i.cache.compiledFunc=p}f=y.executeFunction(p,b)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function PGe(t,e,r){const i=typeof e=="number",s=i?null:e,n=s&&s.attributes;let o=i?e:null;const{isScaleDriven:a}=t.cache;let l=t.cache.compiledFunc;if(a){const h=v(r)?r.scale:void 0,p=v(r)?r.view:void 0;o=h==null||p==="3d"?IGe(t):h}else if(!i)switch(t.inputValueType){case Wg.Expression:{if(C(r)||C(r.arcade))return void cv.error("Use of arcade expressions requires an arcade context");const h={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},p=r.arcade.arcadeUtils,f=p.getViewInfo(h),m=p.createExecContext(s,f);if(!l){const y=p.createSyntaxTree(t.valueExpression);l=p.createFunction(y),t.cache.compiledFunc=l}o=p.executeFunction(l,m);break}case Wg.Field:n&&(o=n[t.field]);break;case Wg.Unknown:o=null}if(!M3(o))return null;if(i||!t.normalizationField)return o;const c=n?parseFloat(n[t.normalizationField]):null;return M3(c)&&c!==0?o/c:null}function IGe(t){let e=null,r=null;const i=t.stops;return i?(e=i[0].value,r=i[i.length-1].value):(e=t.minDataValue||0,r=t.maxDataValue||0),(e+r)/2}function Z5(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(n=>n.type==="size"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void cv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=Dve(PGe(i,e,r),i,e,r,i.cache.ipData);return s==null||isNaN(s)?0:s}function Dc(t,e,r){return t==null?null:L_(t)?Z5(t,e,r):M3(t)?t:null}function Lve(t,e,r){return M3(r)&&t>r?r:M3(e)&&t<e?e:t}function $Ge(t,e,r,i){return t+((Dc(e.minSize,r,i)||e.minDataValue)??0)}function LGe(t,e,r){const i=t.stops;let s=i&&i.length&&i[0].size;return s==null&&(s=t.minSize),Dc(s,e,r)}function DGe(t,e,r,i){const s=(t-e.minDataValue)/(e.maxDataValue-e.minDataValue),n=Dc(e.minSize,r,i),o=Dc(e.maxSize,r,i),a=v(i)?i.shape:void 0;if(t<=e.minDataValue)return n;if(t>=e.maxDataValue)return o;if(n==null||o==null)return null;if(e.scaleBy==="area"&&a){const l=a==="circle",c=l?_D*(n/2)**2:n*n,h=c+s*((l?_D*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/_D):Math.sqrt(h)}return n+s*(o-n)}function NGe(t,e,r,i){const s=v(i)?i.shape:void 0,n=t/e.minDataValue,o=Dc(e.minSize,r,i),a=Dc(e.maxSize,r,i);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,Lve(l,o,a)}function FGe(t,e,r,i,s){var l,c,h;const[n,o,a]=nZ(t,s);if(n===o)return Dc((l=e.stops)==null?void 0:l[n].size,r,i);{const p=Dc((c=e.stops)==null?void 0:c[n].size,r,i);return p+(Dc((h=e.stops)==null?void 0:h[o].size,r,i)-p)*a}}function UGe(t,e,r,i){const s=(v(i)&&i.resolution?i.resolution:1)*iE[e.valueUnit],n=Dc(e.minSize,r,i),o=Dc(e.maxSize,r,i),{valueRepresentation:a}=e;let l=null;return l=a==="area"?2*Math.sqrt(t/_D)/s:a==="radius"||a==="distance"?2*t/s:t/s,Lve(l,n,o)}function Dve(t,e,r,i,s){switch(e.transformationType){case Ro.Additive:return $Ge(t,e,r,i);case Ro.Constant:return LGe(e,r,i);case Ro.ClampedLinear:return DGe(t,e,r,i);case Ro.Proportional:return NGe(t,e,r,i);case Ro.Stops:return FGe(t,e,r,i,s);case Ro.RealWorldSize:return UGe(t,e,r,i);case Ro.Identity:return t;case Ro.Unknown:return null}}function VGe(t,e,r){const{isScaleDriven:i}=t.cache;if(!(i&&r==="3d"||e))return null;const s={scale:e,view:r};let n=Dc(t.minSize,Bre,s),o=Dc(t.maxSize,Bre,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function sZ(t,e,r){if(!t.visualVariables)return;const i=[],s=[],n=[],o=[],a=[];for(const l of t.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=Pve(l,e,r);i.push({variable:l,value:c})}),n.forEach(l=>{const c=Ive(l,e,r);i.push({variable:l,value:c})}),a.forEach(l=>{const c=$ve(l,e,r);i.push({variable:l,value:c})}),o.forEach(l=>{const c=Z5(l,e,r);i.push({variable:l,value:c})}),i.filter(l=>l.value!=null)}function nZ(t,e){if(!e)return;let r=0,i=e.length-1;return e.some((s,n)=>t<s?(i=n,!0):(r=n,!1)),[r,i,(t-e[r])/(e[i]-e[r])]}function kGe(t,e,r){const i=["proportional","proportional","proportional"];for(const s of t){const n=s.useSymbolValue?"symbol-value":Z5(s,e,r);switch(s.axis){case"width":i[0]=n;break;case"depth":i[1]=n;break;case"height":i[2]=n;break;case"width-and-depth":i[0]=n,i[1]=n;break;case"all":case void 0:case null:i[0]=n,i[1]=n,i[2]=n;break;default:s.axis}}return i}const oZ=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:kGe,getColor:Pve,getOpacity:Ive,getRotationAngle:$ve,getSize:Z5,getSizeForValue:Dve,getSizeFromNumberOrVariable:Dc,getSizeRangeAtScale:VGe,getVisualVariableValues:sZ,viewScaleRE:Mve},Symbol.toStringTag,{value:"Module"}));var PG;const uI=new Vr({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),IG=new Vr({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function Gre(t){if(t!=null)return typeof t=="string"||typeof t=="number"?hi(t):t.type==="size"?L_(t)?t:(delete(t={...t}).type,new _i(t)):void 0}function jre(t,e,r){if(typeof t!="object")return t;const i=new _i;return i.read(t,r),i}let _i=PG=class extends HM{constructor(t){super(t),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:this.valueExpression!=null&&Mve.test(this.valueExpression)}}set expression(t){se.getLogger(this.declaredClass).warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),t==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",t)):this._set("expression",null)}set index(t){L_(this.maxSize)&&(this.maxSize.index=`visualVariables[${t}].maxSize`),L_(this.minSize)&&(this.minSize.index=`visualVariables[${t}].minSize`),this._set("index",t)}get inputValueType(){return Ove(this)}set maxDataValue(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set maxDataValue when stops is not null."),t=null),this._set("maxDataValue",t)}set maxSize(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set maxSize when stops is not null."),t=null),this._set("maxSize",t)}castMaxSize(t){return Gre(t)}readMaxSize(t,e,r){return jre(t,e,r)}set minDataValue(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set minDataValue when stops is not null."),t=null),this._set("minDataValue",t)}set minSize(t){t&&this.stops&&(se.getLogger(this.declaredClass).warn("cannot set minSize when stops is not null."),t=null),this._set("minSize",t)}castMinSize(t){return Gre(t)}readMinSize(t,e,r){return jre(t,e,r)}get arcadeRequired(){return!!this.valueExpression||this.minSize!=null&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize!=null&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(t){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value):t&&(se.getLogger(this.declaredClass).warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),t=null),this._set("stops",t)}get transformationType(){return MGe(this,this.inputValueType)}readValueExpression(t,e){return t||e.expression&&"$view.scale"}writeValueExpressionWebScene(t,e,r,i){if(t==="$view.scale"){if(i&&i.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;i.messages.push(new j("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:i}))}}else e[r]=t}readValueUnit(t){return t?IG.read(t):null}clone(){return new PG({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:L_(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:L_(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType===Ro.ClampedLinear){const{minSize:t,maxSize:e}=this;return this.minSize=e,this.maxSize=t,this}if(this.transformationType===Ro.Stops){const t=this.stops;if(!t)return this;const e=t.map(i=>i.size).reverse(),r=t.length;for(let i=0;i<r;i++)t[i].size=e[i];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],_i.prototype,"cache",null),u([d({type:uI.apiValues,json:{type:uI.jsonValues,origins:{"web-map":{read:!1}},read:uI.read,write:uI.write}})],_i.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],_i.prototype,"expression",null),u([d()],_i.prototype,"index",null),u([d({type:String,readOnly:!0})],_i.prototype,"inputValueType",null),u([d({type:OGe,json:{write:!0}})],_i.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],_i.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],_i.prototype,"maxSize",null),u([Gt("maxSize")],_i.prototype,"castMaxSize",null),u([Le("maxSize")],_i.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],_i.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],_i.prototype,"minSize",null),u([Gt("minSize")],_i.prototype,"castMinSize",null),u([Le("minSize")],_i.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],_i.prototype,"normalizationField",void 0),u([d({readOnly:!0})],_i.prototype,"arcadeRequired",null),u([d({type:String})],_i.prototype,"scaleBy",void 0),u([d({type:[e2],value:null,json:{write:!0}})],_i.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],_i.prototype,"target",void 0),u([d({type:String,readOnly:!0})],_i.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],_i.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],_i.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],_i.prototype,"valueExpression",void 0),u([Le("valueExpression",["valueExpression","expression"])],_i.prototype,"readValueExpression",null),u([ke("web-scene","valueExpression")],_i.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],_i.prototype,"valueRepresentation",void 0),u([d({type:IG.apiValues,json:{write:IG.write,origins:{"web-map":{read:!1},"web-scene":{write:!0},"portal-item":{write:!0}}}})],_i.prototype,"valueUnit",void 0),u([Le("valueUnit")],_i.prototype,"readValueUnit",null),_i=PG=u([P("esri.renderers.visualVariables.SizeVariable")],_i);const J5=_i,zGe={color:Cve,size:J5,opacity:Ave,rotation:Rve},BGe=new Vr({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),GGe=/^\[([^\]]+)\]$/i;let vD=class extends Te{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),(e=e&&e.filter(r=>!!r))&&e.length){for(const r of e)switch(r.type){case"color":this.colorVariables.push(r);break;case"opacity":this.opacityVariables.push(r);break;case"rotation":this.rotationVariables.push(r);break;case"size":this.sizeVariables.push(r)}this.sizeVariables.length&&this.sizeVariables.some(r=>!!r.target)&&e.sort((r,i)=>{let s=null;return s=r.target===i.target?0:r.target?1:-1,s});for(let r=0;r<e.length;r++)e[r].index=r;this._set("visualVariables",e)}else this._set("visualVariables",e)}readVariables(e,r,i){const{rotationExpression:s,rotationType:n}=r,o=s&&s.match(GGe),a=o&&o[1];if(a&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:n,field:a})),e)return e.map(l=>{const c=BGe.read(l.type),h=zGe[c];h||(se.getLogger(this.declaredClass).warn(`Unknown variable type: ${c}`),i&&i.messages&&i.messages.push(new lm("visual-variable:unsupported",`visualVariable of type '${c}' is not supported`,{definition:l,context:i})));const p=new h;return p.read(l,i),p})}writeVariables(e,r){const i=[];for(const s of e){const n=s.toJSON(r);n&&i.push(n)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],vD.prototype,"visualVariables",null),vD=u([P("esri.renderers.visualVariables.VisualVariableFactory")],vD);const jGe=vD,HGe={base:HM,key:"type",typeMap:{opacity:Ave,color:Cve,rotation:Rve,size:J5}},tC=t=>{let e=class extends t{constructor(){super(...arguments),this._vvFactory=new jGe}set visualVariables(r){this._vvFactory.visualVariables=r,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(r,i,s){return this._vvFactory.readVariables(r,i,s)}writeVisualVariables(r,i,s,n){i[s]=this._vvFactory.writeVariables(r,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const r of this.visualVariables)if(r.arcadeRequired)return!0;return!1}hasVisualVariables(r,i){return r?this.getVisualVariablesForType(r,i).length>0:this.getVisualVariablesForType("size",i).length>0||this.getVisualVariablesForType("color",i).length>0||this.getVisualVariablesForType("opacity",i).length>0||this.getVisualVariablesForType("rotation",i).length>0}getVisualVariablesForType(r,i){const s=this.visualVariables;return s?s.filter(n=>n.type===r&&(typeof i=="string"?n.target===i:i!==!1||!n.target)):[]}async collectVVRequiredFields(r,i){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&Pu(r,i,n.field),n.normalizationField&&Pu(r,i,n.normalizationField),n.valueExpression&&(qGe(n.valueExpression,r,i)||await Wl(r,i,n.valueExpression)))}};return u([d({types:[HGe],value:null,json:{write:!0}})],e.prototype,"visualVariables",null),u([Le("visualVariables",["visualVariables","rotationType","rotationExpression"])],e.prototype,"readVisualVariables",null),u([ke("visualVariables")],e.prototype,"writeVisualVariables",null),e=u([P("esri.renderers.mixins.VisualVariablesMixin")],e),e};function qGe(t,e,r){const i=CGe(t);return!!v(i)&&(Pu(e,r,i),!0)}const VC={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function WGe(t,e=VC){var a,l;if(!t)return{symbol:null};const{retainId:r=VC.retainId,ignoreDrivers:i=VC.ignoreDrivers,hasLabelingContext:s=VC.hasLabelingContext,retainCIM:n=VC.retainCIM}=e;let o=null;if(aE(t)||t instanceof nx)o=t.clone();else if(t.type==="cim"){const c=(l=(a=t.data)==null?void 0:a.symbol)==null?void 0:l.type;if(c!=="CIMPointSymbol")return{error:new j("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${c||"unknown"}' is unsupported in 3D`,{symbol:t})};o=n?t.clone():P_.fromCIMSymbol(t)}else if(t instanceof rd)o=v5.fromSimpleLineSymbol(t);else if(t instanceof Av)o=P_.fromSimpleMarkerSymbol(t);else if(t instanceof w5)o=P_.fromPictureMarkerSymbol(t);else if(t instanceof Cv)o=e.geometryType&&e.geometryType==="mesh"?b5.fromSimpleFillSymbol(t):NM.fromSimpleFillSymbol(t);else{if(!(t instanceof YE))return{error:new j("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${t.type||t.declaredClass}' is unsupported in 3D`,{symbol:t})};o=s?_5.fromTextSymbol(t):P_.fromTextSymbol(t)}if(r&&o&&o.type!=="cim"&&(o.id=t.id),i&&aE(o))for(let c=0;c<o.symbolLayers.length;++c)o.symbolLayers.getItemAt(c)._ignoreDrivers=!0;return{symbol:o}}function DF(t,e,r,i){const s=Nve(t,{},{context:i,isLabelSymbol:!1});v(s)&&(e[r]=s)}function Hre(t,e,r,i){const s=Nve(t,{},{context:i,isLabelSymbol:!0});v(s)&&(e[r]=s)}function qre(t){return t instanceof XE||t instanceof nx}function Nve(t,e,r){if(C(t))return null;const{context:i,isLabelSymbol:s}=r,n=i==null?void 0:i.origin,o=i==null?void 0:i.messages;if(n==="web-scene"&&!qre(t)){const a=WGe(t,{retainCIM:!0,hasLabelingContext:s});return v(a.symbol)?a.symbol.write(e,i):(o==null||o.push(new j("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:t,context:i,error:a.error})),null)}return(n==="web-map"||n==="portal-item"&&!Ope(i==null?void 0:i.layer))&&qre(t)?(o==null||o.push(new j("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in web maps and portal items. Use 2D symbology and CIMSymbol instead when working with MapView`,{symbol:t,context:i})),null):t.write(e,i)}function kAt(t,e){return c5e(t,null,e)}const rC={types:T5,json:{write:{writer:DF},origins:{"web-scene":{types:Wee,write:{writer:DF},read:{reader:wv({types:Wee})}}}}},Fve={types:{base:Gc,key:"type",typeMap:{"simple-fill":ow.typeMap["simple-fill"],"picture-fill":ow.typeMap["picture-fill"],"polygon-3d":ow.typeMap["polygon-3d"]}},json:{write:{writer:DF},origins:{"web-scene":{type:NM,write:{writer:DF}}}}},bD={cast:t=>t==null||typeof t=="string"||typeof t=="number"?t:`${t}`,json:{type:String,write:{writer:(t,e)=>{e.value=t==null?void 0:t.toString()}}}};var $G;let V0=$G=class extends fe{constructor(t){super(t),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new $G({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${t}`}};u([d({type:String,json:{write:!0}})],V0.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],V0.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],V0.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],V0.prototype,"maxValue",void 0),u([d(rC)],V0.prototype,"symbol",void 0),V0=$G=u([P("esri.renderers.support.ClassBreakInfo")],V0);const NF=V0;var LG;const Uve="log",wD="percent-of-total",xD="field",hI=new Vr({esriNormalizeByLog:Uve,esriNormalizeByPercentOfTotal:wD,esriNormalizeByField:xD}),XGe=Ls(NF);let qn=LG=class extends tC(vy){constructor(t){super(t),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(t,e,r){if(!Array.isArray(t))return;let i=e.minValue;return t.map(s=>{const n=new NF;return n.read(s,r),n.minValue==null&&(n.minValue=i),n.maxValue==null&&(n.maxValue=n.minValue),i=n.maxValue,n})}writeClassBreakInfos(t,e,r,i){const s=t.map(n=>n.write({},i));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),e[r]=s}castField(t){return t==null?t:typeof t=="function"?(se.getLogger(this.declaredClass).error(".field: field must be a string value"),null):xM(t)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let t=this._get("normalizationType");const e=!!this.normalizationField,r=this.normalizationTotal!=null;return e||r?(t=e&&xD||r&&wD||null,e&&r&&se.getLogger(this.declaredClass).warn("warning: both normalizationField and normalizationTotal are set!")):t!==xD&&t!==wD||(t=null),t}set normalizationType(t){this._set("normalizationType",t)}addClassBreakInfo(t,e,r){let i=null;i=typeof t=="number"?new NF({minValue:t,maxValue:e,symbol:Dge(r)}):XGe(te(t)),this.classBreakInfos.push(i),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(t,e){const r=this.classBreakInfos.length;for(let i=0;i<r;i++){const s=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(s[0]===t&&s[1]===e){this.classBreakInfos.splice(i,1);break}}}getBreakIndex(t,e){return this.valueExpression&&(C(e)||C(e.arcade))&&se.getLogger(this.declaredClass).warn(""),this.valueExpression?this._getBreakIndexForExpression(t,e):this._getBreakIndexForField(t)}async getClassBreakInfo(t,e){let r=e;this.valueExpression&&(C(e)||C(e.arcade))&&(r={...r,arcade:await dm()});const i=this.getBreakIndex(t,r);return i!==-1?this.classBreakInfos[i]:null}getSymbol(t,e){if(this.valueExpression&&(C(e)||C(e.arcade)))return void se.getLogger(this.declaredClass).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this.getBreakIndex(t,e);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}async getSymbolAsync(t,e){let r=e;if(this.valueExpression&&(C(e)||C(e.arcade))){const s=await dm(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),r={...r,arcade:s}}const i=this.getBreakIndex(t,r);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}getSymbols(){const t=[];return this.classBreakInfos.forEach(e=>{e.symbol&&t.push(e.symbol)}),this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),r=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${t}.${e}.${this.classBreakInfos.reduce((i,s)=>i+s.getMeshHash(),"")}.${r}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new LG({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:te(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:te(this.visualVariables),legendOptions:te(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(t,e){const r=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(r)}async collectSymbolFields(t,e){const r=[...this.getSymbols().map(i=>i.collectRequiredFields(t,e)),Wl(t,e,this.valueExpression)];Pu(t,e,this.field),Pu(t,e,this.normalizationField),await Promise.all(r)}_getBreakIndexForExpression(t,e){const{viewingMode:r,scale:i,spatialReference:s,arcade:n}=It(e,{}),{valueExpression:o}=this;let a=this._compiledValueExpression.valueExpression===o?this._compiledValueExpression.compiledFunction:null;const l=n.arcadeUtils;if(!a){const h=l.createSyntaxTree(o);a=l.createFunction(h),this._compiledValueExpression.compiledFunction=a}this._compiledValueExpression.valueExpression=o;const c=l.executeFunction(a,l.createExecContext(t,l.getViewInfo({viewingMode:r,scale:i,spatialReference:s})));return this._getBreakIndexfromInfos(c)}_getBreakIndexForField(t){const e=this.field,r=t.attributes,i=this.normalizationType;let s=parseFloat(r[e]);if(i){const n=this.normalizationTotal,o=parseFloat(this.normalizationField?r[this.normalizationField]:void 0);if(i===Uve)s=Math.log(s)*Math.LOG10E;else if(i!==wD||n==null||isNaN(n)){if(i===xD&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(t){const e=this.isMaxInclusive;if(t!=null&&typeof t=="number"&&!isNaN(t))for(let r=0;r<this.classBreakInfos.length;r++){const i=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(i[0]<=t&&(e?t<=i[1]:t<i[1]))return r}return-1}_areClassBreaksConsecutive(){const t=this.classBreakInfos,e=t.length;for(let r=1;r<e;r++)if(t[r-1].maxValue!==t[r].minValue)return!1;return!0}};u([d(Fve)],qn.prototype,"backgroundFillSymbol",void 0),u([d({type:[NF]})],qn.prototype,"classBreakInfos",void 0),u([Le("classBreakInfos")],qn.prototype,"readClassBreakInfos",null),u([ke("classBreakInfos")],qn.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],qn.prototype,"defaultLabel",void 0),u([d(rC)],qn.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],qn.prototype,"field",void 0),u([Gt("field")],qn.prototype,"castField",null),u([d({type:Boolean})],qn.prototype,"isMaxInclusive",void 0),u([d({type:gS,json:{write:!0}})],qn.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],qn.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],qn.prototype,"normalizationField",void 0),u([d({type:Number,cast:t=>Ch(t),json:{write:!0}})],qn.prototype,"normalizationTotal",void 0),u([d({type:hI.apiValues,value:null,json:{type:hI.jsonValues,read:hI.read,write:hI.write}})],qn.prototype,"normalizationType",null),u([mt({classBreaks:"class-breaks"})],qn.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],qn.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],qn.prototype,"valueExpressionTitle",void 0),qn=LG=u([P("esri.renderers.ClassBreaksRenderer")],qn);const Vve=qn;let YGe=class{constructor(e,r){this._storage=new qY,this._storage.maxSize=e,r&&this._storage.registerRemoveFunc("",r)}put(e,r,i){this._storage.put(e,r,i,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}};const Wre="esri.renderers.support.DictionaryLoader",ZGe={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let aZ=class{constructor(e,r,i){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new YGe(100),this._dictionaryPromise=null,this.url=e,this.config=r,this.fieldMap=i}getSymbolFields(){return this._symbolFields}async getSymbolAsync(e,r){let i;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(r));try{i=await this._dictionaryPromise}catch(m){if(Ks(m))return this._dictionaryPromise=null,null}const s={};if(this.fieldMap)for(const m of this._symbolFields){const y=this.fieldMap[m];if(y&&e.attributes[y]!=null){const _=""+e.attributes[y];s[m]=_}else s[m]=""}const n=i==null?void 0:i(s,r);if(!n||typeof n!="string")return null;const o=nW(n).toString(),a=this._symbolCache.get(o);if(a)return a.catch(()=>{this._symbolCache.pop(o)}),a;const l=n.split(";"),c=[],h=[];for(const m of l)if(m)if(m.includes("po:")){const y=m.substr(3).split("|");if(y.length===3){const _=y[0],b=y[1];let x=y[2];if(b==="DashTemplate")x=x.split(" ").map(T=>Number(T));else if(b==="Color"){const T=new Ze(x).toRgba();x=[T[0],T[1],T[2],255*T[3]]}else x=Number(x);h.push({primitiveName:_,propertyName:b,value:x})}}else if(m.includes("|")){for(const y of m.split("|"))if(this._itemNames.has(y)){c.push(y);break}}else this._itemNames.has(m)&&c.push(m);const p=!v(e.geometry)||!e.geometry.hasZ&&e.geometry.type==="point",f=this._cimPartsToCIMSymbol(c,h,p,r);return this._symbolCache.put(o,f,1),f}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void se.getLogger(Wre).error("no valid URL!");const r=Pi(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:v(e)?e.signal:null}),[{data:i}]=await Promise.all([r,dm()]);if(!i)throw this._dictionaryPromise=null,new j("esri.renderers.DictionaryRenderer","Bad dictionary data!");const s=i.expression,n=i.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=new Set(i.itemsNames),this._symbolFields=n.symbol;const o={};if(this.config){const c=this.config;for(const h in c)o[h]=c[h]}if(n.configuration)for(const c of n.configuration)o.hasOwnProperty(c.name)||(o[c.name]=c.value);const a=[];if(v(e)&&e.fields&&this.fieldMap)for(const c of this._symbolFields){const h=this.fieldMap[c],p=e.fields.filter(f=>f.name===h);p.length>0&&a.push({...p[0],name:c})}const l=dFe(s,v(e)?e.spatialReference:null,a,o).then(c=>{const h={scale:0};return(p,f)=>{if(C(c))return null;const m=c.repurposeFeature({geometry:null,attributes:p});return h.scale=v(f)?f.scale??void 0:void 0,c.evaluate({$feature:m,$view:h})}}).catch(c=>(se.getLogger(Wre).error("Creating dictinoary expression failed:",c),null));return this._dictionaryPromise=l,l}async _cimPartsToCIMSymbol(e,r,i,s){const n=new Array(e.length);for(let l=0;l<e.length;l++)n[l]=this._getSymbolPart(e[l],s);const o=await Promise.all(n),a=this.fieldMap;if(a)for(const l of o)kve(l,a);return new WE({data:this._combineSymbolParts(o,r,i)})}async _getSymbolPart(e,r){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then(n=>n.data);const i=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,e),s=Pi(i,{responseType:"json",query:{f:"json"},...r});this._ongoingRequests.set(e,s);try{return(await s).data}catch(n){throw this._ongoingRequests.delete(e),n}}_combineSymbolParts(e,r,i){if(!e||e.length===0)return null;const s={...e[0]};if(e.length>1){s.symbolLayers=[];for(const n of e){const o=n;s.symbolLayers.unshift(...o.symbolLayers)}}return i&&(s.callout=ZGe),{type:"CIMSymbolReference",symbol:s,primitiveOverrides:r}}};function kve(t,e){if(!t)return;const r=t.symbolLayers;if(!r)return;let i=r.length;for(;i--;){const s=r[i];s&&s.enable!==!1&&s.type==="CIMVectorMarker"&&JGe(s,e)}}function JGe(t,e){const r=t.markerGraphics;if(r)for(const i of r){if(!i)continue;const s=i.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":kve(s,e);break;case"CIMTextSymbol":s.fieldMap=e}}}const GAt=Object.freeze(Object.defineProperty({__proto__:null,DictionaryLoader:aZ},Symbol.toStringTag,{value:"Module"}));var DG;let Pd=DG=class extends tC(vy){constructor(t){super(t),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new aZ(this.url,this.config,this.fieldMap)}writeData(t,e){t&&(e.scalingExpressionInfo={expression:t,returnType:"number"})}writeVisualVariables(t,e,r,i){i!=null&&i.origin||super.writeVisualVariables(t,e,r,i)}clone(){return new DG({config:te(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:te(this.fieldMap),url:te(this.url),visualVariables:te(this.visualVariables)})}async getSymbolAsync(t,e){return this._loader.getSymbolAsync(t,e)}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e),this.scaleExpression&&await Wl(t,e,this.scaleExpression);for(const r in this.fieldMap){const i=this.fieldMap[r];e.has(i)&&t.add(i)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};u([d({type:aZ})],Pd.prototype,"_loader",null),u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],Pd.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],Pd.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],Pd.prototype,"scaleExpression",void 0),u([ke("scaleExpression")],Pd.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&!!this.scaleExpression}}}}})],Pd.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],Pd.prototype,"url",void 0),u([ke("visualVariables")],Pd.prototype,"writeVisualVariables",null),Pd=DG=u([P("esri.renderers.DictionaryRenderer")],Pd);const KGe=Pd;var NG;let dg=NG=class extends fe{constructor(t){super(t),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(t){return t==null?t:typeof t=="function"?(se.getLogger(this.declaredClass).error(".field: field must be a string value"),null):xM(t)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new NG({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:Ze,json:{type:[Number],write:!0}})],dg.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],dg.prototype,"field",void 0),u([Gt("field")],dg.prototype,"castField",null),u([d({type:String,json:{write:!0}})],dg.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],dg.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],dg.prototype,"valueExpressionTitle",void 0),dg=NG=u([P("esri.renderers.support.AttributeColorInfo")],dg);const zve=dg;var FG;let TD=FG=class extends fe{constructor(){super(...arguments),this.unit=null}clone(){return new FG({unit:this.unit})}};u([d({type:String,json:{write:!0}})],TD.prototype,"unit",void 0),TD=FG=u([P("esri.renderers.support.DotDensityLegendOptions")],TD);const QGe=TD;var UG;let cc=UG=class extends tC(vy){constructor(t){super(t),this.attributes=null,this.backgroundColor=new Ze([0,0,0,0]),this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new rd,this.dotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(t){if(this.referenceScale==null)return this.dotValue;const e=t/this.referenceScale*this.dotValue;return e<1?1:e}getSymbol(){return new Cv({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){var t;return((t=this.attributes)==null?void 0:t.reduce((e,r)=>e+r.getAttributeHash(),""))??""}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new UG({attributes:te(this.attributes),backgroundColor:te(this.backgroundColor),dotBlendingEnabled:te(this.dotBlendingEnabled),dotShape:te(this.dotShape),dotSize:te(this.dotSize),dotValue:te(this.dotValue),legendOptions:te(this.legendOptions),outline:te(this.outline),referenceScale:te(this.referenceScale),visualVariables:te(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){var e;return`${(e=this.attributes)==null?void 0:e.map(r=>r.field||r.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e);for(const r of this.attributes??[])r.valueExpression&&await Wl(t,e,r.valueExpression),r.field&&t.add(r.field)}};u([d({type:[zve],json:{write:!0}})],cc.prototype,"attributes",void 0),u([d({type:Ze,json:{write:!0}})],cc.prototype,"backgroundColor",void 0),u([d({type:Boolean,json:{write:!0}})],cc.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],cc.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!0}})],cc.prototype,"dotSize",void 0),u([d({type:QGe,json:{write:!0}})],cc.prototype,"legendOptions",void 0),u([d({type:rd,json:{default:null,write:!0}})],cc.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],cc.prototype,"dotValue",void 0),u([d({type:Number,json:{write:!0}})],cc.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],cc.prototype,"seed",void 0),u([mt({dotDensity:"dot-density"})],cc.prototype,"type",void 0),cc=UG=u([P("esri.renderers.DotDensityRenderer")],cc);const eje=cc;let t2=class extends bs(fe){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};u([d({type:String,json:{write:!0}})],t2.prototype,"minLabel",void 0),u([d({type:String,json:{write:!0}})],t2.prototype,"maxLabel",void 0),u([d({type:String,json:{write:!0}})],t2.prototype,"title",void 0),t2=u([P("esri.renderers.support.HeatmapLegendOptions")],t2);const lZ=2.4;function tje(t){return Yh(t*lZ)}function rje(t){return $o(t)/lZ}function ije(t,e,r,i){let{color:s,ratio:n}=e,{color:o,ratio:a}=r;a===n&&(a===1?n-=1e-6:a+=1e-6);const l=ye((i-n)/(a-n),0,1);e5(t,s.toArray(),o.toArray(),l)}function HAt(t){const r=new Uint8ClampedArray(2048);if(t=t.filter(({ratio:a})=>a>=0&&a<=1).sort((a,l)=>a.ratio-l.ratio).map(({color:a,ratio:l})=>({color:a,ratio:Math.max(l,.001)})),t.length<1)return r;let i=t[0],s=t[0],n=1;const o=nr();for(let a=0;a<512;a++){const l=(a+.5)/512;for(;l>s.ratio&&n<t.length;)i=s,s=t[n++];ije(o,i,s,l),r.set(o,4*a)}return r}function qAt(t,e,r,i){const{radius:s,fieldOffset:n,field:o}=e,a=Math.round($o(s)),l=new Float64Array(r*i);let c,h=Number.NEGATIVE_INFINITY;const p=nje(o,n),f=new Set;for(const m of t){const y=m.getCursor();for(;y.next();){const _=y.getObjectId();if(f.has(_))continue;f.add(_);const b=y.readLegacyPointGeometry(),x=128;if(b.x<-x||b.x>=r+x||b.y<-x||b.y>i+x)continue;const T=+p(y),S=Math.max(0,Math.round(b.x)-a),E=Math.max(0,Math.round(b.y)-a),O=Math.min(i,Math.round(b.y)+a),R=Math.min(r,Math.round(b.x)+a);for(let L=E;L<O;L++)for(let I=S;I<R;I++){const U=L*r+I,z=sje(b.x-I,b.y-L,a);c=l[U]+=z*T,c>h&&(h=c)}}}return{matrix:l.buffer,max:h}}function sje(t,e,r){const i=Math.sqrt(t**2+e**2)/r;return i>1?0:3/(Math.PI*r**2)*(1-i**2)**2}function WAt(t,e){return typeof t=="function"?t:t?typeof e=="string"?r=>-1*+r[t]:r=>+r[t]+e:()=>1}function nje(t,e){return t!=null?typeof e=="string"?r=>-1*+r.readAttribute(t):r=>+r.readAttribute(t)+e:r=>1}var VG;const Bve="esri.renderers.HeatmapRenderer",oje=se.getLogger(Bve);function Xre(t){if(t!=null){const{maxDensity:e,minDensity:r,radius:i}=t;if(e!=null||r!=null||i!=null){const{blurRadius:s,maxPixelIntensity:n,minPixelIntensity:o,...a}=t;return a}}return t}let wo=VG=class extends vy{constructor(t){super(t),this.authoringInfo=null,this.colorStops=[new xO({ratio:0,color:new Ze("rgba(255, 140, 0, 0)")}),new xO({ratio:.75,color:new Ze("rgba(255, 140, 0, 1)")}),new xO({ratio:.9,color:new Ze("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null,this._warnedProps={blurRadius:!1,maxPixelIntensity:!1,minPixelIntensity:!1}}normalizeCtorArgs(t){return Xre(t)}get blurRadius(){return rje(this.radius)}set blurRadius(t){const e=this.maxPixelIntensity,r=this.minPixelIntensity;this._set("radius",tje(t)),this._warnAboutDeprecatedGaussianBlurProp("blurRadius","radius"),this._set("maxDensity",e*this._pixelIntensityToDensity),this._set("minDensity",r*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(t){this._set("maxDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("maxPixelIntensity","maxDensity")}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(t){this._set("minDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("minPixelIntensity","minDensity")}get _pixelIntensityToDensity(){return 24/(lZ**2*this.blurRadius**4)}_warnAboutDeprecatedGaussianBlurProp(t,e){this._warnedProps[t]||nl(this).getDefaultOrigin()==="user"&&(this._warnedProps[t]=!0,VE(()=>{$k(oje,t,{replacement:`${String(e)} (suggested value: ${this._get(e)})`,version:"4.24"})}))}read(t,e){t=Xre(t),super.read(t,e)}getSymbol(){return new Av}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}async collectRequiredFields(t,e){const r=this.field,i=this.valueExpression;r&&typeof r=="string"&&await Pu(t,e,r),i&&typeof i=="string"&&await Wl(t,e,i)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new VG({authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),colorStops:te(this.colorStops),field:this.field,legendOptions:te(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:iZ,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],wo.prototype,"authoringInfo",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],wo.prototype,"blurRadius",null),u([d({type:[xO],json:{write:!0}})],wo.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],wo.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,r)=>({enabled:r==null})},origins:{"web-scene":{write:!1}}}})],wo.prototype,"fieldOffset",void 0),u([d({type:t2,json:{write:!0}})],wo.prototype,"legendOptions",void 0),u([d({type:Number,json:{write:!0}})],wo.prototype,"maxDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],wo.prototype,"maxPixelIntensity",null),u([d({type:Number,json:{write:!0}})],wo.prototype,"minDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],wo.prototype,"minPixelIntensity",null),u([d({type:Number,cast:hi,json:{write:!0}})],wo.prototype,"radius",void 0),u([d({type:Number,range:{min:0},json:{default:0,write:!0}})],wo.prototype,"referenceScale",void 0),u([mt({heatmap:"heatmap"})],wo.prototype,"type",void 0),u([d({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],wo.prototype,"valueExpression",void 0),u([d({type:String})],wo.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],wo.prototype,"_pixelIntensityToDensity",null),wo=VG=u([P(Bve)],wo);const Gve=wo;let Mb=class extends bs(fe){constructor(){super(...arguments),this.color=new Ze([0,0,0,0]),this.label=null,this.threshold=0}};u([d({type:Ze,json:{write:!0}})],Mb.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Mb.prototype,"label",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],Mb.prototype,"threshold",void 0),Mb=u([P("esri.renderers.support.OthersCategory")],Mb);let SD=class extends bs(fe){constructor(){super(...arguments),this.title=null}};u([d({type:String,json:{write:!0}})],SD.prototype,"title",void 0),SD=u([P("esri.renderers.support.PieChartLegendOptions")],SD);let su=class extends tC(bs(vy)){constructor(e){super(e),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new Ze([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new Mb,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart"}getSymbol(){var e;return new Av({size:this.size?this.size/2+(((e=this.outline)==null?void 0:e.width)||0):0})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol(),this.backgroundFillSymbol].filter(v)}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,r)=>e+r.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,r)=>e+JSON.stringify(r),"")}async collectRequiredFields(e,r){await this.collectVVRequiredFields(e,r);for(const i of this.attributes)i.valueExpression&&await Wl(e,r,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[zve],json:{write:!0}})],su.prototype,"attributes",void 0),u([d({type:Cv,json:{default:null,write:!0}})],su.prototype,"backgroundFillSymbol",void 0),u([d({type:Ze,json:{write:!0}})],su.prototype,"defaultColor",void 0),u([d({type:String,json:{write:!0}})],su.prototype,"defaultLabel",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],su.prototype,"holePercentage",void 0),u([d({type:Mb,json:{write:!0}})],su.prototype,"othersCategory",void 0),u([d({type:SD,json:{write:!0}})],su.prototype,"legendOptions",void 0),u([d({type:rd,json:{default:null,write:!0}})],su.prototype,"outline",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],su.prototype,"size",void 0),u([mt({pieChart:"pie-chart"})],su.prototype,"type",void 0),su=u([P("esri.renderers.PieChartRenderer")],su);const aje=su;var kG;let Z1=kG=class extends tC(vy){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(t,e){await Promise.all([this.collectSymbolFields(t,e),this.collectVVRequiredFields(t,e)])}async collectSymbolFields(t,e){await Promise.all(this.getSymbols().map(r=>r.collectRequiredFields(t,e)))}getSymbol(t,e){return this.symbol}async getSymbolAsync(t,e){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((t,e)=>t+JSON.stringify(e),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new kG({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:te(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],Z1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Z1.prototype,"label",void 0),u([d(rC)],Z1.prototype,"symbol",void 0),u([mt({simple:"simple"})],Z1.prototype,"type",void 0),Z1=kG=u([P("esri.renderers.SimpleRenderer")],Z1);const vE=Z1,lje=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function zG(t){return t instanceof Te}function Yre(t){return t instanceof ft?Object.keys(t.items):zG(t)?nl(t).keys():t?Object.keys(t):[]}function dI(t,e){return t instanceof ft?t.items[e]:t[e]}function cje(t,e){return!(!Array.isArray(t)||!Array.isArray(e))&&t.length!==e.length}function CO(t){return t?t.declaredClass:null}function jve(t,e){const r=t.diff;if(r&&typeof r=="function")return r(t,e);const i=Yre(t),s=Yre(e);if(i.length===0&&s.length===0)return;if(!i.length||!s.length||cje(t,e))return{type:"complete",oldValue:t,newValue:e};const n=s.filter(p=>!i.includes(p)),o=i.filter(p=>!s.includes(p)),a=i.filter(p=>s.includes(p)&&dI(t,p)!==dI(e,p)).concat(n,o).sort(),l=CO(t);if(l&&lje.includes(l)&&a.length)return{type:"complete",oldValue:t,newValue:e};let c;const h=zG(t)&&zG(e);for(const p of a){const f=dI(t,p),m=dI(e,p);let y;if((h||typeof f!="function"&&typeof m!="function")&&f!==m&&(f!=null||m!=null)){if(r&&r[p]&&typeof r[p]=="function")y=r[p](f,m);else if(f instanceof Date&&m instanceof Date){if(f.getTime()===m.getTime())continue;y={type:"complete",oldValue:f,newValue:m}}else y=typeof f=="object"&&typeof m=="object"&&CO(f)===CO(m)?jve(f,m):{type:"complete",oldValue:f,newValue:m};v(y)&&(v(c)?c.diff[p]=y:c={type:"partial",diff:{[p]:y}})}}return c}function uje(t,e){if(C(t))return!1;const r=e.split(".");let i=t;for(const s of r){if(i.type==="complete")return!0;if(i.type!=="partial")return!1;{const n=i.diff[s];if(!n)return!1;i=n}}return!0}function JAt(t,e){for(const r of e)if(uje(t,r))return!0;return!1}function hje(t,e){if(!(typeof t=="function"||typeof e=="function"||C(t)&&C(e)))return C(t)||C(e)||typeof t=="object"&&typeof e=="object"&&CO(t)!==CO(e)?{type:"complete",oldValue:t,newValue:e}:jve(t,e)}function pI(t){if(C(t))return!0;switch(t.type){case"complete":return!1;case"collection":{const e=t;for(const r of e.added)if(!pI(r))return!1;for(const r of e.removed)if(!pI(r))return!1;for(const r of e.changed)if(!pI(r))return!1;return!0}case"partial":for(const e in t.diff)if(!pI(t.diff[e]))return!1;return!0}}let r2=class extends bs(fe){constructor(e){super(e),this.value=null,this.value2=null,this.value3=null}};u([d(bD)],r2.prototype,"value",void 0),u([d(bD)],r2.prototype,"value2",void 0),u([d(bD)],r2.prototype,"value3",void 0),r2=u([P("esri.renderers.support.UniqueValue")],r2);const yS=r2;let k0=class extends bs(fe){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(e){if(e==null)return null;const r=typeof(e=Array.isArray(e)?e:[e])[0];return r==="string"||r==="number"?e.map(i=>new yS({value:i})):r==="object"?e[0]instanceof yS?e:e.map(i=>new yS(i)):null}};u([d({type:String,json:{write:!0}})],k0.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],k0.prototype,"label",void 0),u([d(rC)],k0.prototype,"symbol",void 0),u([d({type:[yS],json:{type:[[String]],read:{reader:t=>t?t.map(e=>new yS({value:e[0],value2:e[1],value3:e[2]})):null},write:{writer:(t,e)=>{const r=[];for(const i of t){const s=[i.value,i.value2,i.value3].filter(v).map(n=>n.toString());r.push(s)}e.values=r}}}})],k0.prototype,"values",void 0),u([Gt("values")],k0.prototype,"castValues",null),k0=u([P("esri.renderers.support.UniqueValueClass")],k0);const Hve=k0;let bR=class extends bs(fe){constructor(e){super(e),this.heading=null,this.classes=null}};u([d({type:String,json:{write:!0}})],bR.prototype,"heading",void 0),u([d({type:[Hve],json:{write:!0}})],bR.prototype,"classes",void 0),bR=u([P("esri.renderers.support.UniqueValueGroup")],bR);const BG=bR;var GG;let J1=GG=class extends fe{constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new GG({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${t}`}};u([d({type:String,json:{write:!0}})],J1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],J1.prototype,"label",void 0),u([d(rC)],J1.prototype,"symbol",void 0),u([d(bD)],J1.prototype,"value",void 0),J1=GG=u([P("esri.renderers.support.UniqueValueInfo")],J1);const AO=J1,dje=()=>!!de("enable-feature:force-wosr"),tRt=()=>!!de("enable-feature:direct-3d-object-feature-layer-display"),rRt=()=>!!de("enable-feature:SceneLayer-editing");let g8={};async function pje(t,e){try{return{data:(await yje(t,e)).data,baseUrl:z3e(t),styleUrl:t}}catch(r){return Sc(r),null}}function fje(t,e,r){const i=v(e.portal)?e.portal:Io.getDefault();let s;const n=`${i.url} - ${i.user&&i.user.username} - ${t}`;return g8[n]||(g8[n]=mje(t,i,r).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl??"",styleName:t}))),g8[n]}function mje(t,e,r){return e.load(r).then(()=>{const i=new Lg({disableExtraQuery:!0,query:`owner:${Zre} AND type:${Jre} AND typekeywords:"${t}"`});return e.queryItems(i,r)}).then(({results:i})=>{var o;let s=null;const n=t.toLowerCase();if(i&&Array.isArray(i)){for(const a of i)if(((o=a.typeKeywords)==null?void 0:o.some(c=>c.toLowerCase()===n))&&a.type===Jre&&a.owner===Zre){s=a;break}}if(!s)throw new j("symbolstyleutils:style-not-found",`The style '${t}' could not be found`,{styleName:t});return s.load(r)})}function gje(t,e,r){return t&&v(t.styleUrl)?pje(t.styleUrl,r):t&&v(t.styleName)?fje(t.styleName,e,r):Promise.reject(new j("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function iRt(t){return t===null||t.type==="CIMSymbolReference"?t:{type:"CIMSymbolReference",symbol:t}}function sRt(t,e){if(e==="cimRef")return t.cimRef;if(t.formatInfos&&!dje()){for(const r of t.formatInfos)if(r.type==="gltf")return r.href}return t.webRef}function yje(t,e){const r={responseType:"json",query:{f:"json"},...e};return Pi(Uh(t),r)}const Zre="esri_en",Jre="Style",nRt="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var wR;const qve="esri.renderers.UniqueValueRenderer",Wy=se.getLogger(qve),Kre="uvInfos-watcher",Qre="uvGroups-watcher",_je=",",vje=Ls(AO);function bje(t){const{field1:e,field2:r,field3:i,fieldDelimiter:s,uniqueValueInfos:n,valueExpression:o}=t,a=!(!e||!r);return[{classes:(n??[]).map(l=>{var x;const{symbol:c,label:h,value:p,description:f}=l,[m,y,_]=a?((x=p==null?void 0:p.toString())==null?void 0:x.split(s||""))||[]:[p],b=[];return(e||o)&&b.push(m),r&&b.push(y),i&&b.push(_),{symbol:c,label:h,values:[b],description:f}})}]}let ks=wR=class extends tC(vy){constructor(t){super(t),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(e,r){if(!e&&!r)return;if(!e||!r)return{type:"complete",oldValue:e,newValue:r};let i=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<r.length;n++){const o=e.find(a=>a.value===r[n].value);o?hje(o,r[n])?(s.changed.push({type:"complete",oldValue:o,newValue:r[n]}),i=!0):s.unchanged.push({oldValue:o,newValue:r[n]}):(s.added.push(r[n]),i=!0)}for(let n=0;n<e.length;n++)r.find(o=>o.value===e[n].value)||(s.removed.push(e[n]),i=!0);return i?s:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(t){this._set("field",t),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(t){return t==null||typeof t=="function"?t:xM(t)}writeField(t,e,r,i){typeof t=="string"?e[r]=t:i&&i.messages?i.messages.push(new j("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):Wy.error(".field: cannot write field to JSON since it's not a string value")}set field2(t){this._set("field2",t),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(t){this._set("field3",t),this._updateUniqueValues()}set valueExpression(t){this._set("valueExpression",t),this._updateUniqueValues()}set defaultSymbol(t){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",t)}set fieldDelimiter(t){this._set("fieldDelimiter",t),this._updateUniqueValues()}readPortal(t,e,r){return r.portal||Io.getDefault()}readStyleOrigin(t,e,r){if(e.styleName)return Object.freeze({styleName:e.styleName});if(e.styleUrl){const i=jE(e.styleUrl,r);return Object.freeze({styleUrl:i})}}writeStyleOrigin(t,e,r,i){t.styleName?e.styleName=t.styleName:t.styleUrl&&(e.styleUrl=Rw(t.styleUrl,i))}set uniqueValueGroups(t){this.styleOrigin?Wy.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",t),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(t){this.styleOrigin?Wy.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",t),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(t,e){var i;if(this.styleOrigin)return void Wy.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let r;r=typeof t=="object"?vje(t):new AO({value:t,symbol:Dge(e)}),(i=this.uniqueValueInfos)==null||i.push(r),this._valueInfoMap[r.value]=r,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(t){if(this.styleOrigin)return void Wy.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const e=this.uniqueValueInfos;if(e){for(let r=0;r<e.length;r++)if(e[r].value===t+""){delete this._valueInfoMap[t],e.splice(r,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(t,e){let r=e;return this.valueExpression&&(C(e)||C(e.arcade))&&(r={...r,arcade:await dm()}),this._getUniqueValueInfo(t,r)}getSymbol(t,e){if(this.valueExpression&&(C(e)||C(e.arcade)))return void Wy.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this._getUniqueValueInfo(t,e);return r&&r.symbol||this.defaultSymbol}async getSymbolAsync(t,e){let r=e;if(this.valueExpression&&(C(r)||C(r.arcade))){const s=await dm(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),r={...r,arcade:s}}const i=this._getUniqueValueInfo(t,r);return i&&i.symbol||this.defaultSymbol}getSymbols(){const t=[];for(const e of this.uniqueValueInfos??[])e.symbol&&t.push(e.symbol);return this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){var i;const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),r=(i=this.uniqueValueInfos)==null?void 0:i.reduce((s,n)=>s+n.getMeshHash(),"");return`${t}.${e}.${r}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const t=new wR({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:te(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:te(this.visualVariables),legendOptions:te(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:te(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(t._isDefaultSymbolDerived=!0),t._set("portal",this.portal);const e=te(this.uniqueValueInfos),r=te(this.uniqueValueGroups);return this.styleOrigin&&(t._set("styleOrigin",Object.freeze(te(this.styleOrigin))),Object.freeze(e),Object.freeze(r)),t._set("uniqueValueInfos",e),t._updateValueInfoMap(),t._set("uniqueValueGroups",r),t._isInfosSource=this._isInfosSource,t._watchUniqueValueInfosAndGroups(),t}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(t,e){const r=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(r)}async collectSymbolFields(t,e){const r=[...this.getSymbols().map(i=>i.collectRequiredFields(t,e)),Wl(t,e,this.valueExpression)];Pu(t,e,this.field),Pu(t,e,this.field2),Pu(t,e,this.field3),await Promise.all(r)}populateFromStyle(){return gje(this.styleOrigin,{portal:this.portal}).then(t=>{var r;const e=[];return this._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach(i=>{const s=new nx({styleUrl:t.styleUrl,styleName:t.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==t.data.defaultItem||(this.defaultSymbol=s,this._isDefaultSymbolDerived=!0);const n=new AO({value:i.name,symbol:s});e.push(n),this._valueInfoMap[i.name]=n}),this._set("uniqueValueInfos",Object.freeze(e)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&((r=this.uniqueValueInfos)!=null&&r.length)&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",_je)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:t}=this;if(t)for(const e of t)this._valueInfoMap[e.value+""]=e}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(Kre);const{uniqueValueInfos:t}=this;if(t){const e=[];for(const r of t)e.push(ne(()=>({symbol:r.symbol,value:r.value,label:r.label,description:r.description}),(i,s)=>{i!==s&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(e,Kre)}}_watchUniqueValueGroups(){this.removeHandles(Qre);const{uniqueValueGroups:t}=this;if(t){const e=[];for(const r of t){e.push(ne(()=>({classes:r.classes}),(i,s)=>{i!==s&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const i of r.classes??[])e.push(ne(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(s,n)=>{s!==n&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(e,Qre)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const t=[],{field:e,field2:r,field3:i,fieldDelimiter:s,uniqueValueGroups:n,valueExpression:o}=this;if(!e&&!o)return this._set("uniqueValueInfos",t),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const a=!(!e||!r);for(const l of n)for(const c of l.classes??[]){const{symbol:h,label:p,values:f,description:m}=c;for(const y of f??[]){const{value:_,value2:b,value3:x}=y,T=[_];r&&T.push(b),i&&T.push(x);const S=a?T.join(s||""):T[0];t.push(new AO({symbol:h,label:p,value:S,description:m}))}}this._set("uniqueValueInfos",t),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(t=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:e,field2:r,valueExpression:i,fieldDelimiter:s,uniqueValueInfos:n}=this;if(!e&&!i||!n.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const o=!(!e||!r),a=n.map(c=>{var x;const{symbol:h,label:p,value:f,description:m}=c,[y,_,b]=o?((x=f==null?void 0:f.toString())==null?void 0:x.split(s||""))||[]:[f];return new Hve({symbol:h,label:p,description:m,values:[new yS({value:y,value2:_,value3:b})]})}),l=[new BG({classes:a})];t&&Object.freeze(l),this._set("uniqueValueGroups",l),this._watchUniqueValueGroups()}_getUniqueValueInfo(t,e){return this.valueExpression?this._getUnqiueValueInfoForExpression(t,e):this._getUnqiueValueInfoForFields(t)}_getUnqiueValueInfoForExpression(t,e){const{viewingMode:r,scale:i,spatialReference:s,arcade:n}=It(e,{});let o=this._cache.compiledFunc;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(t,a.getViewInfo({viewingMode:r,scale:i,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(t){const e=this.field,r=t.attributes;let i;if(typeof e!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];e&&o.push(r[e]),s&&o.push(r[s]),n&&o.push(r[n]),i=o.join(this.fieldDelimiter||"")}else typeof e=="function"?i=e(t):e&&(i=r[e]);return this._valueInfoMap[i+""]}static fromPortalStyle(t,e){const r=new wR(e&&e.properties);r._set("styleOrigin",Object.freeze({styleName:t})),r._set("portal",e&&e.portal||Io.getDefault());const i=r.populateFromStyle();return i.catch(s=>{Wy.error(`#fromPortalStyle('${t}'[, ...])`,"Failed to create unique value renderer from style name",s)}),i}static fromStyleUrl(t,e){const r=new wR(e&&e.properties);r._set("styleOrigin",Object.freeze({styleUrl:t}));const i=r.populateFromStyle();return i.catch(s=>{Wy.error(`#fromStyleUrl('${t}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),i}};u([d({readOnly:!0})],ks.prototype,"_cache",null),u([mt({uniqueValue:"unique-value"})],ks.prototype,"type",void 0),u([d(Fve)],ks.prototype,"backgroundFillSymbol",void 0),u([d({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],ks.prototype,"field",null),u([Gt("field")],ks.prototype,"castField",null),u([ke("field")],ks.prototype,"writeField",null),u([d({type:String,value:null,json:{write:!0}})],ks.prototype,"field2",null),u([d({type:String,value:null,json:{write:!0}})],ks.prototype,"field3",null),u([d({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],ks.prototype,"orderByClassesEnabled",void 0),u([d({type:String,value:null,json:{write:!0}})],ks.prototype,"valueExpression",null),u([d({type:String,json:{write:!0}})],ks.prototype,"valueExpressionTitle",void 0),u([d({type:gS,json:{write:!0}})],ks.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],ks.prototype,"defaultLabel",void 0),u([d(zhe({...rC},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],ks.prototype,"defaultSymbol",null),u([d({type:String,value:null,json:{write:!0}})],ks.prototype,"fieldDelimiter",null),u([d({type:Io,readOnly:!0})],ks.prototype,"portal",void 0),u([Le("portal",["styleName"])],ks.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],ks.prototype,"styleOrigin",void 0),u([Le("styleOrigin",["styleName","styleUrl"])],ks.prototype,"readStyleOrigin",null),u([ke("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],ks.prototype,"writeStyleOrigin",null),u([d({type:[BG],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(t,e,r)=>(e.uniqueValueGroups||bje(e)).map(i=>BG.fromJSON(i,r))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],ks.prototype,"uniqueValueGroups",null),u([d({type:[AO],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],ks.prototype,"uniqueValueInfos",null),ks=wR=u([P(qve)],ks);const qM=ks,K5={key:"type",base:vy,typeMap:{heatmap:Gve,simple:vE,"unique-value":qM,"class-breaks":Vve,"dot-density":eje,dictionary:KGe,"pie-chart":aje},errorContext:"renderer"},wje={key:"type",base:vy,typeMap:{simple:vE,"unique-value":qM,"class-breaks":Vve,heatmap:Gve},errorContext:"renderer"},xje=wv({types:K5});function FF(t,e,r){return t?t&&(t.styleName||t.styleUrl)&&t.type!=="uniqueValue"?(r&&r.messages&&r.messages.push(new lm("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+t.type+"'",{definition:t,context:r})),null):xje(t,e,r):null}async function Tje(t,e){const{WhereClause:r}=await ie(()=>import("./WhereClause-544968d0.js").then(i=>i.W),["./WhereClause-544968d0.js","./executionError-fb3f283a.js"],import.meta.url);return r.create(t,e)}function Sje(t,e){return v(t)?v(e)?`(${t}) AND (${e})`:t:e}var jG;let K1=jG=class extends fe{constructor(t){super(t),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new jG({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],K1.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],K1.prototype,"name",void 0),u([d({type:["boolean","date","number","string"],json:{write:!0}})],K1.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],K1.prototype,"title",void 0),K1=jG=u([P("esri.form.ExpressionInfo")],K1);const Eje=K1;let Q1=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],Q1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Q1.prototype,"label",void 0),u([d()],Q1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Q1.prototype,"visibilityExpression",void 0),Q1=u([P("esri.form.elements.Element")],Q1);const bE=Q1;var HG;let ED=HG=class extends fe{constructor(t){super(t),this.type=null}clone(){return new HG({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],ED.prototype,"type",void 0),ED=HG=u([P("esri.form.elements.inputs.AttachmentInput")],ED);const Cje=ED;var qG;let eb=qG=class extends bE{constructor(t){super(t),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new qG({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],eb.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],eb.prototype,"editable",void 0),u([d({type:Cje,json:{read:{source:"inputType"},write:{target:"inputType"}}})],eb.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],eb.prototype,"type",void 0),eb=qG=u([P("esri.form.elements.AttachmentElement")],eb);const eie=eb;let CD=class extends fe{constructor(e){super(e),this.type=null}};u([d()],CD.prototype,"type",void 0),CD=u([P("esri.form.elements.inputs.Input")],CD);const iC=CD;let xR=class extends iC{constructor(e){super(e),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],xR.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],xR.prototype,"minLength",void 0),xR=u([P("esri.form.elements.inputs.TextInput")],xR);const cZ=xR;var WG;let AD=WG=class extends cZ{constructor(t){super(t),this.type="barcode-scanner"}clone(){return new WG({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],AD.prototype,"type",void 0),AD=WG=u([P("esri.form.elements.inputs.BarcodeScannerInput")],AD);const Aje=AD;var XG;let i2=XG=class extends iC{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!0,this.type="combo-box"}clone(){return new XG({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],i2.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],i2.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],i2.prototype,"type",void 0),i2=XG=u([P("esri.form.elements.inputs.ComboBoxInput")],i2);const Rje=i2;var YG;function tie(t){return t!=null?new Date(t):null}function rie(t){return t?t.getTime():null}let Id=YG=class extends iC{constructor(t){super(t),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(t,e){return tie(e.max)}writeMax(t,e){e.max=rie(t)}readMin(t,e){return tie(e.min)}writeMin(t,e){e.min=rie(t)}clone(){return new YG({includeTime:this.includeTime,max:this.max,min:this.min})}};u([d({type:Boolean,json:{write:!0}})],Id.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],Id.prototype,"max",void 0),u([Le("max")],Id.prototype,"readMax",null),u([ke("max")],Id.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],Id.prototype,"min",void 0),u([Le("min")],Id.prototype,"readMin",null),u([ke("min")],Id.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],Id.prototype,"type",void 0),Id=YG=u([P("esri.form.elements.inputs.DateTimePickerInput")],Id);const Oje=Id;var ZG;let s2=ZG=class extends iC{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!0,this.type="radio-buttons"}clone(){return new ZG({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],s2.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],s2.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],s2.prototype,"type",void 0),s2=ZG=u([P("esri.form.elements.inputs.RadioButtonsInput")],s2);const Mje=s2;var JG;let n2=JG=class extends iC{constructor(t){super(t),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new JG({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],n2.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],n2.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],n2.prototype,"type",void 0),n2=JG=u([P("esri.form.elements.inputs.SwitchInput")],n2);const Pje=n2;var KG;let RD=KG=class extends cZ{constructor(t){super(t),this.type="text-area"}clone(){return new KG({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],RD.prototype,"type",void 0),RD=KG=u([P("esri.form.elements.inputs.TextAreaInput")],RD);const Ije=RD;var QG;let OD=QG=class extends cZ{constructor(t){super(t),this.type="text-box"}clone(){return new QG({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],OD.prototype,"type",void 0),OD=QG=u([P("esri.form.elements.inputs.TextBoxInput")],OD);const $je=OD,Lje={base:iC,key:"type",typeMap:{"barcode-scanner":Aje,"combo-box":Rje,"datetime-picker":Oje,"radio-buttons":Mje,switch:Pje,"text-area":Ije,"text-box":$je}};var ej;const Wve="esri.form.elements.FieldElement",iie=se.getLogger(Wve);let hh=ej=class extends bE{constructor(t){super(t),this.domain=null,this.editableExpression=null,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field",this.valueExpression=null}get editable(){return $k(iie,"editable",{replacement:"editableExpression",version:"4.26",warnOnce:!0}),this._get("editable")??!0}set editable(t){$k(iie,"editable",{replacement:"editableExpression",version:"4.26",warnOnce:!0}),this._set("editable",t)}clone(){return new ej({description:this.description,domain:this.domain,editable:this.editable,editableExpression:this.editableExpression,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,valueExpression:this.valueExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:rve,json:{read:{reader:WY},write:!0}})],hh.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],hh.prototype,"editable",null),u([d({type:String,json:{write:!0}})],hh.prototype,"editableExpression",void 0),u([d({type:String,json:{write:!0}})],hh.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],hh.prototype,"hint",void 0),u([d({types:Lje,json:{read:{source:"inputType"},write:{target:"inputType"}}})],hh.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],hh.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],hh.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],hh.prototype,"valueExpression",void 0),hh=ej=u([P(Wve)],hh);const sie=hh;var tj;let pg=tj=class extends bE{constructor(t){super(t),this.displayCount=null,this.displayType="list",this.editable=!0,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new tj({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editable:this.editable,label:this.label,orderByFields:te(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],pg.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],pg.prototype,"displayType",void 0),u([d({type:Boolean,json:{write:!0}})],pg.prototype,"editable",void 0),u([d({type:[UX],json:{write:!0}})],pg.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],pg.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],pg.prototype,"type",void 0),pg=tj=u([P("esri.form.elements.RelationshipElement")],pg);const nie=pg;function Xve(t){return{typesWithGroup:{base:bE,key:"type",typeMap:{attachment:eie,field:sie,group:t,relationship:nie}},typesWithoutGroup:{base:bE,key:"type",typeMap:{attachment:eie,field:sie,relationship:nie}}}}function Yve(t,e,r=!0){if(!t)return null;const i=r?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>i[s.type]).map(s=>i[s.type].fromJSON(s))}function Zve(t,e,r=!0){if(!t)return null;const i=r?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>i[s.type]).map(s=>s.toJSON())}function Jve(t,e,r=!0){return t?t.map(i=>_p(r?e.typesWithGroup:e.typesWithoutGroup,i)):null}var rj;let Mf=rj=class extends bE{constructor(t){super(t),this.elements=null,this.initialState="expanded",this.type="group"}castElements(t){return Jve(t,y8,!1)}readElements(t,e){return Yve(e.formElements,y8,!1)}writeElements(t,e){e.formElements=Zve(t,y8,!1)}clone(){return new rj({description:this.description,elements:te(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Mf.prototype,"elements",void 0),u([Gt("elements")],Mf.prototype,"castElements",null),u([Le("elements",["formElements"])],Mf.prototype,"readElements",null),u([ke("elements")],Mf.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Mf.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Mf.prototype,"type",void 0),Mf=rj=u([P("esri.form.elements.GroupElement")],Mf);const y8=Xve(Mf),Dje=Mf;var ij;const _8=Xve(Dje);let $d=ij=class extends fe{constructor(t){super(t),this.description=null,this.elements=null,this.expressionInfos=null,this.preserveFieldValuesWhenHidden=!1,this.title=null}castElements(t){return Jve(t,_8)}readElements(t,e){return Yve(e.formElements,_8)}writeElements(t,e){e.formElements=Zve(t,_8)}clone(){return new ij({description:this.description,expressionInfos:te(this.expressionInfos),elements:te(this.elements),title:this.title,preserveFieldValuesWhenHidden:this.preserveFieldValuesWhenHidden})}};u([d({type:String,json:{write:!0}})],$d.prototype,"description",void 0),u([d({json:{write:!0}})],$d.prototype,"elements",void 0),u([Gt("elements")],$d.prototype,"castElements",null),u([Le("elements",["formElements"])],$d.prototype,"readElements",null),u([ke("elements")],$d.prototype,"writeElements",null),u([d({type:[Eje],json:{write:!0}})],$d.prototype,"expressionInfos",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],$d.prototype,"preserveFieldValuesWhenHidden",void 0),u([d({type:String,json:{write:!0}})],$d.prototype,"title",void 0),$d=ij=u([P("esri.form.FormTemplate")],$d);const Nje=$d;function oie(t,e,r){if(t.hasM==null||t.hasZ)for(const i of e)for(const s of i)s.length>2&&(s[2]*=r)}function Fje(t,e,r){if(!t&&!e||!r)return;const i=ww(r);aie(t,r,i),aie(e,r,i)}function aie(t,e,r){if(t)for(const i of t)Uje(i.geometry,e,r)}function Uje(t,e,r){if(C(t)||!t.spatialReference||Cn(t.spatialReference,e))return;const i=ww(t.spatialReference)/r;if(i!==1){if("x"in t)t.z!=null&&(t.z*=i);else if("rings"in t)oie(t,t.rings,i);else if("paths"in t)oie(t,t.paths,i);else if("points"in t&&(t.hasM==null||t.hasZ))for(const s of t.points)s.length>2&&(s[2]*=i)}}let Vje=0;const Kve="esri.layers.graphics.sources.MemorySource",v8=se.getLogger(Kve);let Ag=class extends cm.LoadableMixin(SM(ux(ft))){constructor(e){super(e),this._idToClientGraphic=null,this.type="memory"}load(e){const r=v(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(r)),Promise.resolve(this)}destroy(){var e;(e=this._connection)==null||e.close(),this._connection=null}get _workerGeometryType(){var r;const e=(r=this.layer)==null?void 0:r.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null}applyEdits(e){return this.load().then(()=>this._applyEdits(e))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(e,r={}){await this.load(r);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,r);lG(e,this.layer.spatialReference,i);const s=XY.fromJSON(i);if(!this._requiresClientGraphicMapping())return s;const n=this.layer.objectIdField;for(const o of s.features){const a=o.attributes[n],l=this._idToClientGraphic.get(a);l&&(o.geometry=l.geometry)}return s.geometryType=this.layer.geometryType,s}async queryFeaturesJSON(e,r={}){if(this._requiresClientGraphicMapping())throw new j("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(r);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,r);return lG(e,this.layer.spatialReference,i),i}queryFeatureCount(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,r))}queryObjectIds(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,r))}queryExtent(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryExtent",e?e.toJSON():null,r)).then(i=>({count:i.count,extent:Hr.fromJSON(i.extent)}))}querySnapping(e,r={}){return this.load(r).then(()=>this._connection.invoke("querySnapping",e,r))}async _applyEdits(e){if(!this._connection)throw new j("feature-layer-source:edit-failure","Memory source not loaded");const r=this.layer.objectIdField;let i=null;const s=[],n=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const o=h=>"objectId"in h&&h.objectId!=null?h.objectId:"attributes"in h&&h.attributes[r]!=null?h.attributes[r]:null;if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const h of e.deleteFeatures){const p=o(h);p!=null&&s.push(p)}const a=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures){for(const h of e.updateFeatures)if(n.push(this._serializeFeature(h)),a){const p=o(h);p!=null&&a.set(p,h)}}Fje(i?i.features:null,n,this.layer.spatialReference);const{fullExtent:l,featureEditResults:c}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:n,deletes:s});return this.fullExtent=l,i&&i.finish(c.uidToObjectId),this._updateClientGraphicIds(a,c),this._createEditsResult(c)}async _prepareClientMapping(e,r){if(this._layerOrSourceGeometryType!=="mesh"||C(e))return;const i=[];for(const{geometry:s}of e)!v(s)||s.type!=="mesh"||s.hasExtent||s.loaded||i.push(s.load({signal:r}));i.length&&await Promise.all(i)}_updateClientGraphicIds(e,r){if(this._idToClientGraphic){if(e)for(const i of r.updateResults){if(!i.success)continue;const s=e.get(i.objectId);s!=null&&this._addIdToClientGraphic(s)}for(const i of r.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const r=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:r?new j("feature-layer-source:edit-failure",r.description,{code:r.code}):null}}_prepareAddFeatures(e){const r=new Map,i=new Array(e.length);let s=null;for(let o=0;o<e.length;o++){const a=e[o],l=this._serializeFeature(a);!s&&v(a.geometry)&&(s=a.geometry.type),i[o]=l,r.set(`${l.uid}`,a)}const n=this;return{features:i,inferredGeometryType:s,finish(o){const a=n.sourceJSON.objectIdField;for(const l in o){const c=o[l],h=r.get(l);h&&(h.attributes||(h.attributes={}),c===-1?delete h.attributes[a]:h.attributes[a]=c,n._addIdToClientGraphic(h))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const r=this.sourceJSON.objectIdField,i=e.attributes&&e.attributes[r];i!=null&&this._idToClientGraphic.set(i,e)}get _layerOrSourceGeometryType(){var e,r;return((e=this.layer)==null?void 0:e.geometryType)??((r=this.sourceJSON)==null?void 0:r.geometryType)}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this._layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return e==="mesh"||e==="multipatch"||e==="extent"}_serializeFeature(e){const{attributes:r}=e,i=this._geometryForSerialization(e),s=(Vje++).toString();return i?{uid:s,geometry:i.toJSON(),attributes:r}:{uid:s,attributes:r}}_geometryForSerialization(e){const{geometry:r}=e;return C(r)?null:this._geometryRequiresClientGraphicMapping(r)?r.extent?bp.fromExtent(r.extent):null:r}async _startWorker(e){this._connection=await R0e("MemorySourceWorker",{strategy:de("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:r,spatialReference:i,objectIdField:s,hasM:n,hasZ:o,timeInfo:a}=this.layer,l=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,e);const c=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",m=>{v8.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),m.preventDefault()}));const h={features:c.features,fields:r&&r.map(m=>m.toJSON()),geometryType:fee.toJSON(this._workerGeometryType),hasM:this._layerOrSourceGeometryType!=="mesh"&&n,hasZ:this._layerOrSourceGeometryType==="mesh"||o,objectIdField:s,spatialReference:l?null:i&&i.toJSON(),timeInfo:a?a.toJSON():null},p=await this._connection.invoke("load",h,{signal:e});for(const m of p.warnings)v8.warn(m.message,{layer:this.layer,warning:m});p.featureErrors.length&&v8.warn(`Encountered ${p.featureErrors.length} validation errors while loading features`,p.featureErrors);const f=p.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(c.inferredGeometryType)&&(f.geometryType=fee.toJSON(c.inferredGeometryType)),this.sourceJSON=f,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),c.finish(p.assignedObjectIds)}};u([CW({Type:Sa,ensureType:Ls(Sa)})],Ag.prototype,"itemType",void 0),u([d()],Ag.prototype,"type",void 0),u([d({constructOnly:!0})],Ag.prototype,"layer",void 0),u([d({readOnly:!0})],Ag.prototype,"_workerGeometryType",null),u([d()],Ag.prototype,"sourceJSON",void 0),Ag=u([P(Kve)],Ag);function kje(t){return"portalItem"in t}const zje=t=>{let e=class extends t{get apiKey(){var r;return this._isOverridden("apiKey")?this._get("apiKey"):kje(this)?(r=this.portalItem)==null?void 0:r.apiKey:null}set apiKey(r){r!=null?this._override("apiKey",r):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],e.prototype,"apiKey",null),e=u([P("esri.layers.mixins.APIKeyMixin")],e),e},Bje=t=>{let e=class extends t{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const r=HE(this.url);if(v(r)&&r.title)return r.title}return this._get("title")||""}set title(r){this._set("title",r)}set url(r){this._set("url",aNe(r,se.getLogger(this.declaredClass)))}};return u([d()],e.prototype,"title",null),u([d({type:String})],e.prototype,"url",null),e=u([P("esri.layers.mixins.ArcGISService")],e),e},lie={read:{reader:jY},write:{allowNull:!0,writer:HY}},Gje=t=>{let e=class extends t{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0},"portal-item":{read:!0,write:!0}}}})],e.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":lie,"portal-item":lie}}})],e.prototype,"effect",void 0),e=u([P("esri.layers.mixins.BlendLayer")],e),e},jje=t=>{let e=class extends t{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:r=>({enabled:!!(r&&Object.keys(r).length>0)})}}})],e.prototype,"customParameters",void 0),e=u([P("esri.layers.mixins.CustomParametersMixin")],e),e},Hje=new Fs.EventEmitter,Qve="esri.layers.mixins.EditBusLayer",e1e=Symbol(Qve);function uRt(t){return t!=null&&typeof t=="object"&&e1e in t}const qje=t=>{var e;let r=class extends t{constructor(...i){super(...i),this[e]=!0,this.when().then(()=>{this.own([Hje.on("edits",s=>{var h,p,f;const n="layer"in s?s.layer:null,o="layer"in s?(h=s.layer)==null?void 0:h.url:s.serviceUrl,a="layer"in s?(p=s.layer)==null?void 0:p.layerId:s.layerId,l=s.event;if(n===this||o!==this.url)return;if(a!=null&&this.layerId!=null&&a===this.layerId)return void this.emit("edits",te(l));const c=(f=l.editedFeatures)==null?void 0:f.find(({layerId:m})=>m===this.layerId);if(c){const{adds:m,updates:y,deletes:_}=c.editedFeatures,b={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:m?m.map(({attributes:x})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],deletedFeatures:_?_.map(({attributes:x})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],updatedFeatures:y?y.map(({current:{attributes:x}})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],editedFeatures:te(l.editedFeatures),exceededTransferLimit:!1};this.emit("edits",b)}})])},()=>{})}};return e=e1e,r=u([P(Qve)],r),r};var sj;const b8=new Vr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),w8=new Vr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let mf=sj=class extends fe{constructor(t){super(t),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(t={}){const{where:e,geometry:r,spatialRelationship:i,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new Lc({geometry:te(r),objectIds:te(n),spatialRelationship:i,timeExtent:te(s),where:e,units:o,distance:a,...t})}clone(){const{where:t,geometry:e,spatialRelationship:r,timeExtent:i,objectIds:s,units:n,distance:o}=this;return new sj({geometry:te(e),objectIds:te(s),spatialRelationship:r,timeExtent:te(i),where:t,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],mf.prototype,"where",void 0),u([d({types:tx,json:{write:!0}})],mf.prototype,"geometry",void 0),u([d({type:b8.apiValues,json:{name:"spatialRel",read:{reader:b8.read},write:{allowNull:!1,writer:b8.write,overridePolicy(){return{enabled:v(this.geometry)}}}}})],mf.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],mf.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],mf.prototype,"objectIds",void 0),u([d({type:w8.apiValues,json:{read:w8.read,write:{writer:w8.write,overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],mf.prototype,"units",void 0),u([d({type:Sm,json:{write:!0}})],mf.prototype,"timeExtent",void 0),mf=sj=u([P("esri.layers.support.FeatureFilter")],mf);const Wje=mf;var nj;const cie={read:{reader:jY},write:{writer:HY,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}},uie={read:{reader:jY},write:{writer:HY,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}},hie={name:"showExcludedLabels",default:!0};let tb=nj=class extends fe{constructor(t){super(t),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(t,e){var i,s;const r=super.write(t,e);if(e!=null&&e.origin){if(r.filter){const n=Object.keys(r.filter);if(n.length>1||n[0]!=="where")return(i=e.messages)==null||i.push(new j("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:e.layer,effect:this})),null}if("showExcludedLabels"in r)return(s=e.messages)==null||s.push(new j("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:e.layer,effect:this})),null}return r}clone(){return new nj({filter:v(this.filter)?this.filter.clone():null,includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:Wje,json:{write:{allowNull:!0,writer(t,e,r,i){const s=t==null?void 0:t.write({},i);s&&Object.keys(s).length!==0?sl(r,s,e):sl(r,null,e)}}}})],tb.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":cie,"portal-item":cie}}})],tb.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":uie,"portal-item":uie}}})],tb.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":hie,"portal-item":hie}}})],tb.prototype,"excludedLabelsVisible",void 0),tb=nj=u([P("esri.layers.support.FeatureEffect")],tb);const Xje=tb,die={write:{allowNull:!0}},Yje=t=>{let e=class extends t{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:Xje,json:{origins:{"web-map":die,"portal-item":die}}})],e.prototype,"featureEffect",void 0),e=u([P("esri.layers.mixins.FeatureEffectLayer")],e),e},pie=new Map([["AUS Central Standard Time","Australia/Darwin"],["AUS Eastern Standard Time","Australia/Sydney"],["Afghanistan Standard Time","Asia/Kabul"],["Alaskan Standard Time","America/Anchorage"],["Aleutian Standard Time","America/Adak"],["Altai Standard Time","Asia/Barnaul"],["Arab Standard Time","Asia/Riyadh"],["Arabian Standard Time","Asia/Dubai"],["Arabic Standard Time","Asia/Baghdad"],["Argentina Standard Time","America/Buenos_Aires"],["Astrakhan Standard Time","Europe/Astrakhan"],["Atlantic Standard Time","America/Halifax"],["Aus Central W. Standard Time","Australia/Eucla"],["Azerbaijan Standard Time","Asia/Baku"],["Azores Standard Time","Atlantic/Azores"],["Bahia Standard Time","America/Bahia"],["Bangladesh Standard Time","Asia/Dhaka"],["Belarus Standard Time","Europe/Minsk"],["Bougainville Standard Time","Pacific/Bougainville"],["Canada Central Standard Time","America/Regina"],["Cape Verde Standard Time","Atlantic/Cape_Verde"],["Caucasus Standard Time","Asia/Yerevan"],["Cen. Australia Standard Time","Australia/Adelaide"],["Central America Standard Time","America/Guatemala"],["Central Asia Standard Time","Asia/Almaty"],["Central Brazilian Standard Time","America/Cuiaba"],["Central Europe Standard Time","Europe/Budapest"],["Central European Standard Time","Europe/Warsaw"],["Central Pacific Standard Time","Pacific/Guadalcanal"],["Central Standard Time","America/Chicago"],["Central Standard Time (Mexico)","America/Mexico_City"],["Chatham Islands Standard Time","Pacific/Chatham"],["China Standard Time","Asia/Shanghai"],["Cuba Standard Time","America/Havana"],["Dateline Standard Time","Etc/GMT+12"],["E. Africa Standard Time","Africa/Nairobi"],["E. Australia Standard Time","Australia/Brisbane"],["E. Europe Standard Time","Europe/Chisinau"],["E. South America Standard Time","America/Sao_Paulo"],["Easter Island Standard Time","Pacific/Easter"],["Eastern Standard Time","America/New_York"],["Eastern Standard Time (Mexico)","America/Cancun"],["Egypt Standard Time","Africa/Cairo"],["Ekaterinburg Standard Time","Asia/Yekaterinburg"],["FLE Standard Time","Europe/Kiev"],["Fiji Standard Time","Pacific/Fiji"],["GMT Standard Time","Europe/London"],["GTB Standard Time","Europe/Bucharest"],["Georgian Standard Time","Asia/Tbilisi"],["Greenland Standard Time","America/Godthab"],["Greenwich Standard Time","Atlantic/Reykjavik"],["Haiti Standard Time","America/Port-au-Prince"],["Hawaiian Standard Time","Pacific/Honolulu"],["India Standard Time","Asia/Calcutta"],["Iran Standard Time","Asia/Tehran"],["Israel Standard Time","Asia/Jerusalem"],["Jordan Standard Time","Asia/Amman"],["Kaliningrad Standard Time","Europe/Kaliningrad"],["Korea Standard Time","Asia/Seoul"],["Libya Standard Time","Africa/Tripoli"],["Line Islands Standard Time","Pacific/Kiritimati"],["Lord Howe Standard Time","Australia/Lord_Howe"],["Magadan Standard Time","Asia/Magadan"],["Magallanes Standard Time","America/Punta_Arenas"],["Marquesas Standard Time","Pacific/Marquesas"],["Mauritius Standard Time","Indian/Mauritius"],["Middle East Standard Time","Asia/Beirut"],["Montevideo Standard Time","America/Montevideo"],["Morocco Standard Time","Africa/Casablanca"],["Mountain Standard Time","America/Denver"],["Mountain Standard Time (Mexico)","America/Chihuahua"],["Myanmar Standard Time","Asia/Rangoon"],["N. Central Asia Standard Time","Asia/Novosibirsk"],["Namibia Standard Time","Africa/Windhoek"],["Nepal Standard Time","Asia/Katmandu"],["New Zealand Standard Time","Pacific/Auckland"],["Newfoundland Standard Time","America/St_Johns"],["Norfolk Standard Time","Pacific/Norfolk"],["North Asia East Standard Time","Asia/Irkutsk"],["North Asia Standard Time","Asia/Krasnoyarsk"],["North Korea Standard Time","Asia/Pyongyang"],["Omsk Standard Time","Asia/Omsk"],["Pacific SA Standard Time","America/Santiago"],["Pacific Standard Time","America/Los_Angeles"],["Pacific Standard Time (Mexico)","America/Tijuana"],["Pakistan Standard Time","Asia/Karachi"],["Paraguay Standard Time","America/Asuncion"],["Qyzylorda Standard Time","Asia/Qyzylorda"],["Romance Standard Time","Europe/Paris"],["Russia Time Zone 10","Asia/Srednekolymsk"],["Russia Time Zone 11","Asia/Kamchatka"],["Russia Time Zone 3","Europe/Samara"],["Russian Standard Time","Europe/Moscow"],["SA Eastern Standard Time","America/Cayenne"],["SA Pacific Standard Time","America/Bogota"],["SA Western Standard Time","America/La_Paz"],["SE Asia Standard Time","Asia/Bangkok"],["Saint Pierre Standard Time","America/Miquelon"],["Sakhalin Standard Time","Asia/Sakhalin"],["Samoa Standard Time","Pacific/Apia"],["Sao Tome Standard Time","Africa/Sao_Tome"],["Saratov Standard Time","Europe/Saratov"],["Singapore Standard Time","Asia/Singapore"],["South Africa Standard Time","Africa/Johannesburg"],["South Sudan Standard Time","Africa/Juba"],["Sri Lanka Standard Time","Asia/Colombo"],["Sudan Standard Time","Africa/Khartoum"],["Syria Standard Time","Asia/Damascus"],["Taipei Standard Time","Asia/Taipei"],["Tasmania Standard Time","Australia/Hobart"],["Tocantins Standard Time","America/Araguaina"],["Tokyo Standard Time","Asia/Tokyo"],["Tomsk Standard Time","Asia/Tomsk"],["Tonga Standard Time","Pacific/Tongatapu"],["Transbaikal Standard Time","Asia/Chita"],["Turkey Standard Time","Europe/Istanbul"],["Turks And Caicos Standard Time","America/Grand_Turk"],["US Eastern Standard Time","America/Indianapolis"],["US Mountain Standard Time","America/Phoenix"],["UTC","Etc/GMT"],["UTC+01","Etc/GMT-1"],["UTC+02","Etc/GMT-2"],["UTC+03","Etc/GMT-3"],["UTC+04","Etc/GMT-4"],["UTC+05","Etc/GMT-5"],["UTC+06","Etc/GMT-6"],["UTC+07","Etc/GMT-7"],["UTC+08","Etc/GMT-8"],["UTC+09","Etc/GMT-9"],["UTC+10","Etc/GMT-10"],["UTC+11","Etc/GMT-11"],["UTC+12","Etc/GMT-12"],["UTC+13","Etc/GMT-13"],["UTC+14","Etc/GMT-14"],["UTC-01","Etc/GMT+1"],["UTC-02","Etc/GMT+2"],["UTC-03","Etc/GMT+3"],["UTC-04","Etc/GMT+4"],["UTC-05","Etc/GMT+5"],["UTC-06","Etc/GMT+6"],["UTC-07","Etc/GMT+7"],["UTC-08","Etc/GMT+8"],["UTC-09","Etc/GMT+9"],["UTC-10","Etc/GMT+10"],["UTC-11","Etc/GMT+11"],["UTC-12","Etc/GMT+12"],["Ulaanbaatar Standard Time","Asia/Ulaanbaatar"],["Venezuela Standard Time","America/Caracas"],["Vladivostok Standard Time","Asia/Vladivostok"],["Volgograd Standard Time","Europe/Volgograd"],["W. Australia Standard Time","Australia/Perth"],["W. Central Africa Standard Time","Africa/Lagos"],["W. Europe Standard Time","Europe/Berlin"],["W. Mongolia Standard Time","Asia/Hovd"],["West Asia Standard Time","Asia/Tashkent"],["West Bank Standard Time","Asia/Hebron"],["West Pacific Standard Time","Pacific/Port_Moresby"],["Yakutsk Standard Time","Asia/Yakutsk"],["Yukon Standard Time","America/Whitehorse"]]);class dx extends Error{}class Zje extends dx{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class Jje extends dx{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class Kje extends dx{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class TR extends dx{}class t1e extends dx{constructor(e){super(`Invalid unit ${e}`)}}class Ah extends dx{}class Xy extends dx{constructor(){super("Zone is an abstract class")}}const rt="numeric",Ep="short",$u="long",UF={year:rt,month:rt,day:rt},r1e={year:rt,month:Ep,day:rt},Qje={year:rt,month:Ep,day:rt,weekday:Ep},i1e={year:rt,month:$u,day:rt},s1e={year:rt,month:$u,day:rt,weekday:$u},n1e={hour:rt,minute:rt},o1e={hour:rt,minute:rt,second:rt},a1e={hour:rt,minute:rt,second:rt,timeZoneName:Ep},l1e={hour:rt,minute:rt,second:rt,timeZoneName:$u},c1e={hour:rt,minute:rt,hourCycle:"h23"},u1e={hour:rt,minute:rt,second:rt,hourCycle:"h23"},h1e={hour:rt,minute:rt,second:rt,hourCycle:"h23",timeZoneName:Ep},d1e={hour:rt,minute:rt,second:rt,hourCycle:"h23",timeZoneName:$u},p1e={year:rt,month:rt,day:rt,hour:rt,minute:rt},f1e={year:rt,month:rt,day:rt,hour:rt,minute:rt,second:rt},m1e={year:rt,month:Ep,day:rt,hour:rt,minute:rt},g1e={year:rt,month:Ep,day:rt,hour:rt,minute:rt,second:rt},eHe={year:rt,month:Ep,day:rt,weekday:Ep,hour:rt,minute:rt},y1e={year:rt,month:$u,day:rt,hour:rt,minute:rt,timeZoneName:Ep},_1e={year:rt,month:$u,day:rt,hour:rt,minute:rt,second:rt,timeZoneName:Ep},v1e={year:rt,month:$u,day:rt,weekday:$u,hour:rt,minute:rt,timeZoneName:$u},b1e={year:rt,month:$u,day:rt,weekday:$u,hour:rt,minute:rt,second:rt,timeZoneName:$u};class WM{get type(){throw new Xy}get name(){throw new Xy}get ianaName(){return this.name}get isUniversal(){throw new Xy}offsetName(e,r){throw new Xy}formatOffset(e,r){throw new Xy}offset(e){throw new Xy}equals(e){throw new Xy}get isValid(){throw new Xy}}let x8=null;class Q5 extends WM{static get instance(){return x8===null&&(x8=new Q5),x8}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:r,locale:i}){return x1e(e,r,i)}formatOffset(e,r){return OO(this.offset(e),r)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}let MD={};function tHe(t){return MD[t]||(MD[t]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"})),MD[t]}const rHe={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function iHe(t,e){const r=t.format(e).replace(/\u200E/g,""),i=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(r),[,s,n,o,a,l,c,h]=i;return[o,s,n,a,l,c,h]}function sHe(t,e){const r=t.formatToParts(e),i=[];for(let s=0;s<r.length;s++){const{type:n,value:o}=r[s],a=rHe[n];n==="era"?i[a]=o:gi(a)||(i[a]=parseInt(o,10))}return i}let fI={};class ly extends WM{static create(e){return fI[e]||(fI[e]=new ly(e)),fI[e]}static resetCache(){fI={},MD={}}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=ly.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:r,locale:i}){return x1e(e,r,i,this.name)}formatOffset(e,r){return OO(this.offset(e),r)}offset(e){const r=new Date(e);if(isNaN(r))return NaN;const i=tHe(this.name);let[s,n,o,a,l,c,h]=i.formatToParts?sHe(i,r):iHe(i,r);a==="BC"&&(s=-Math.abs(s)+1);const f=dZ({year:s,month:n,day:o,hour:l===24?0:l,minute:c,second:h,millisecond:0});let m=+r;const y=m%1e3;return m-=y>=0?y:1e3+y,(f-m)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let fie={};function nHe(t,e={}){const r=JSON.stringify([t,e]);let i=fie[r];return i||(i=new Intl.ListFormat(t,e),fie[r]=i),i}let oj={};function aj(t,e={}){const r=JSON.stringify([t,e]);let i=oj[r];return i||(i=new Intl.DateTimeFormat(t,e),oj[r]=i),i}let lj={};function oHe(t,e={}){const r=JSON.stringify([t,e]);let i=lj[r];return i||(i=new Intl.NumberFormat(t,e),lj[r]=i),i}let cj={};function aHe(t,e={}){const{base:r,...i}=e,s=JSON.stringify([t,i]);let n=cj[s];return n||(n=new Intl.RelativeTimeFormat(t,e),cj[s]=n),n}let SR=null;function lHe(){return SR||(SR=new Intl.DateTimeFormat().resolvedOptions().locale,SR)}function cHe(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const r=t.indexOf("-u-");if(r===-1)return[t];{let i,s;try{i=aj(t).resolvedOptions(),s=t}catch{const l=t.substring(0,r);i=aj(l).resolvedOptions(),s=l}const{numberingSystem:n,calendar:o}=i;return[s,n,o]}}function uHe(t,e,r){return(r||e)&&(t.includes("-u-")||(t+="-u"),r&&(t+=`-ca-${r}`),e&&(t+=`-nu-${e}`)),t}function hHe(t){const e=[];for(let r=1;r<=12;r++){const i=Cr.utc(2016,r,1);e.push(t(i))}return e}function dHe(t){const e=[];for(let r=1;r<=7;r++){const i=Cr.utc(2016,11,13+r);e.push(t(i))}return e}function mI(t,e,r,i,s){const n=t.listingMode(r);return n==="error"?null:n==="en"?i(e):s(e)}function pHe(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||new Intl.DateTimeFormat(t.intl).resolvedOptions().numberingSystem==="latn"}class fHe{constructor(e,r,i){this.padTo=i.padTo||0,this.floor=i.floor||!1;const{padTo:s,floor:n,...o}=i;if(!r||Object.keys(o).length>0){const a={useGrouping:!1,...i};i.padTo>0&&(a.minimumIntegerDigits=i.padTo),this.inf=oHe(e,a)}}format(e){if(this.inf){const r=this.floor?Math.floor(e):e;return this.inf.format(r)}else{const r=this.floor?Math.floor(e):hZ(e,3);return ro(r,this.padTo)}}}class mHe{constructor(e,r,i){this.opts=i;let s;if(e.zone.isUniversal){const o=-1*(e.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;e.offset!==0&&ly.create(a).valid?(s=a,this.dt=e):(s="UTC",i.timeZoneName?this.dt=e:this.dt=e.offset===0?e:Cr.fromMillis(e.ts+e.offset*60*1e3))}else e.zone.type==="system"?this.dt=e:(this.dt=e,s=e.zone.name);const n={...this.opts};n.timeZone=n.timeZone||s,this.dtf=aj(r,n)}format(){return this.dtf.format(this.dt.toJSDate())}formatToParts(){return this.dtf.formatToParts(this.dt.toJSDate())}resolvedOptions(){return this.dtf.resolvedOptions()}}class gHe{constructor(e,r,i){this.opts={style:"long",...i},!r&&w1e()&&(this.rtf=aHe(e,i))}format(e,r){return this.rtf?this.rtf.format(e,r):$He(r,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,r){return this.rtf?this.rtf.formatToParts(e,r):[]}}class Hs{static fromOpts(e){return Hs.create(e.locale,e.numberingSystem,e.outputCalendar,e.defaultToEN)}static create(e,r,i,s=!1){const n=e||eo.defaultLocale,o=n||(s?"en-US":lHe()),a=r||eo.defaultNumberingSystem,l=i||eo.defaultOutputCalendar;return new Hs(o,a,l,n)}static resetCache(){SR=null,oj={},lj={},cj={}}static fromObject({locale:e,numberingSystem:r,outputCalendar:i}={}){return Hs.create(e,r,i)}constructor(e,r,i,s){const[n,o,a]=cHe(e);this.locale=n,this.numberingSystem=r||o||null,this.outputCalendar=i||a||null,this.intl=uHe(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=pHe(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),r=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&r?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:Hs.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,r=!1,i=!0){return mI(this,e,i,E1e,()=>{const s=r?{month:e,day:"numeric"}:{month:e},n=r?"format":"standalone";return this.monthsCache[n][e]||(this.monthsCache[n][e]=hHe(o=>this.extract(o,s,"month"))),this.monthsCache[n][e]})}weekdays(e,r=!1,i=!0){return mI(this,e,i,R1e,()=>{const s=r?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},n=r?"format":"standalone";return this.weekdaysCache[n][e]||(this.weekdaysCache[n][e]=dHe(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][e]})}meridiems(e=!0){return mI(this,void 0,e,()=>O1e,()=>{if(!this.meridiemCache){const r={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[Cr.utc(2016,11,13,9),Cr.utc(2016,11,13,19)].map(i=>this.extract(i,r,"dayperiod"))}return this.meridiemCache})}eras(e,r=!0){return mI(this,e,r,M1e,()=>{const i={era:e};return this.eraCache[e]||(this.eraCache[e]=[Cr.utc(-40,1,1),Cr.utc(2017,1,1)].map(s=>this.extract(s,i,"era"))),this.eraCache[e]})}extract(e,r,i){const s=this.dtFormatter(e,r),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===i);return o?o.value:null}numberFormatter(e={}){return new fHe(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,r={}){return new mHe(e,this.intl,r)}relFormatter(e={}){return new gHe(this.intl,this.isEnglish(),e)}listFormatter(e={}){return nHe(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}}let T8=null;class el extends WM{static get utcInstance(){return T8===null&&(T8=new el(0)),T8}static instance(e){return e===0?el.utcInstance:new el(e)}static parseSpecifier(e){if(e){const r=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(r)return new el(t6(r[1],r[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${OO(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${OO(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,r){return OO(this.fixed,r)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class yHe extends WM{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function g_(t,e){if(gi(t)||t===null)return e;if(t instanceof WM)return t;if(_He(t)){const r=t.toLowerCase();return r==="default"?e:r==="local"||r==="system"?Q5.instance:r==="utc"||r==="gmt"?el.utcInstance:el.parseSpecifier(r)||ly.create(t)}else return uw(t)?el.instance(t):typeof t=="object"&&t.offset&&typeof t.offset=="number"?t:new yHe(t)}let mie=()=>Date.now(),gie="system",yie=null,_ie=null,vie=null,bie=60,wie;class eo{static get now(){return mie}static set now(e){mie=e}static set defaultZone(e){gie=e}static get defaultZone(){return g_(gie,Q5.instance)}static get defaultLocale(){return yie}static set defaultLocale(e){yie=e}static get defaultNumberingSystem(){return _ie}static set defaultNumberingSystem(e){_ie=e}static get defaultOutputCalendar(){return vie}static set defaultOutputCalendar(e){vie=e}static get twoDigitCutoffYear(){return bie}static set twoDigitCutoffYear(e){bie=e%100}static get throwOnInvalid(){return wie}static set throwOnInvalid(e){wie=e}static resetCaches(){Hs.resetCache(),ly.resetCache()}}function gi(t){return typeof t>"u"}function uw(t){return typeof t=="number"}function e6(t){return typeof t=="number"&&t%1===0}function _He(t){return typeof t=="string"}function vHe(t){return Object.prototype.toString.call(t)==="[object Date]"}function w1e(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function bHe(t){return Array.isArray(t)?t:[t]}function xie(t,e,r){if(t.length!==0)return t.reduce((i,s)=>{const n=[e(s),s];return i&&r(i[0],n[0])===i[0]?i:n},null)[1]}function wHe(t,e){return e.reduce((r,i)=>(r[i]=t[i],r),{})}function wE(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function zg(t,e,r){return e6(t)&&t>=e&&t<=r}function xHe(t,e){return t-e*Math.floor(t/e)}function ro(t,e=2){const r=t<0;let i;return r?i="-"+(""+-t).padStart(e,"0"):i=(""+t).padStart(e,"0"),i}function a_(t){if(!(gi(t)||t===null||t===""))return parseInt(t,10)}function Bv(t){if(!(gi(t)||t===null||t===""))return parseFloat(t)}function uZ(t){if(!(gi(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function hZ(t,e,r=!1){const i=10**e;return(r?Math.trunc:Math.round)(t*i)/i}function XM(t){return t%4===0&&(t%100!==0||t%400===0)}function RO(t){return XM(t)?366:365}function VF(t,e){const r=xHe(e-1,12)+1,i=t+(e-r)/12;return r===2?XM(i)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][r-1]}function dZ(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(e.getUTCFullYear()-1900)),+e}function kF(t){const e=(t+Math.floor(t/4)-Math.floor(t/100)+Math.floor(t/400))%7,r=t-1,i=(r+Math.floor(r/4)-Math.floor(r/100)+Math.floor(r/400))%7;return e===4||i===3?53:52}function uj(t){return t>99?t:t>eo.twoDigitCutoffYear?1900+t:2e3+t}function x1e(t,e,r,i=null){const s=new Date(t),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};i&&(n.timeZone=i);const o={timeZoneName:e,...n},a=new Intl.DateTimeFormat(r,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function t6(t,e){let r=parseInt(t,10);Number.isNaN(r)&&(r=0);const i=parseInt(e,10)||0,s=r<0||Object.is(r,-0)?-i:i;return r*60+s}function T1e(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new Ah(`Invalid unit value ${t}`);return e}function zF(t,e){const r={};for(const i in t)if(wE(t,i)){const s=t[i];if(s==null)continue;r[e(i)]=T1e(s)}return r}function OO(t,e){const r=Math.trunc(Math.abs(t/60)),i=Math.trunc(Math.abs(t%60)),s=t>=0?"+":"-";switch(e){case"short":return`${s}${ro(r,2)}:${ro(i,2)}`;case"narrow":return`${s}${r}${i>0?`:${i}`:""}`;case"techie":return`${s}${ro(r,2)}${ro(i,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function r6(t){return wHe(t,["hour","minute","second","millisecond"])}const THe=["January","February","March","April","May","June","July","August","September","October","November","December"],S1e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],SHe=["J","F","M","A","M","J","J","A","S","O","N","D"];function E1e(t){switch(t){case"narrow":return[...SHe];case"short":return[...S1e];case"long":return[...THe];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const C1e=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],A1e=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],EHe=["M","T","W","T","F","S","S"];function R1e(t){switch(t){case"narrow":return[...EHe];case"short":return[...A1e];case"long":return[...C1e];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const O1e=["AM","PM"],CHe=["Before Christ","Anno Domini"],AHe=["BC","AD"],RHe=["B","A"];function M1e(t){switch(t){case"narrow":return[...RHe];case"short":return[...AHe];case"long":return[...CHe];default:return null}}function OHe(t){return O1e[t.hour<12?0:1]}function MHe(t,e){return R1e(e)[t.weekday-1]}function PHe(t,e){return E1e(e)[t.month-1]}function IHe(t,e){return M1e(e)[t.year<0?0:1]}function $He(t,e,r="always",i=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(t)===-1;if(r==="auto"&&n){const p=t==="days";switch(e){case 1:return p?"tomorrow":`next ${s[t][0]}`;case-1:return p?"yesterday":`last ${s[t][0]}`;case 0:return p?"today":`this ${s[t][0]}`}}const o=Object.is(e,-0)||e<0,a=Math.abs(e),l=a===1,c=s[t],h=i?l?c[1]:c[2]||c[1]:l?s[t][0]:t;return o?`${a} ${h} ago`:`in ${a} ${h}`}function Tie(t,e){let r="";for(const i of t)i.literal?r+=i.val:r+=e(i.val);return r}const LHe={D:UF,DD:r1e,DDD:i1e,DDDD:s1e,t:n1e,tt:o1e,ttt:a1e,tttt:l1e,T:c1e,TT:u1e,TTT:h1e,TTTT:d1e,f:p1e,ff:m1e,fff:y1e,ffff:v1e,F:f1e,FF:g1e,FFF:_1e,FFFF:b1e};class Ka{static create(e,r={}){return new Ka(e,r)}static parseFormat(e){let r=null,i="",s=!1;const n=[];for(let o=0;o<e.length;o++){const a=e.charAt(o);a==="'"?(i.length>0&&n.push({literal:s,val:i}),r=null,i="",s=!s):s||a===r?i+=a:(i.length>0&&n.push({literal:!1,val:i}),i=a,r=a)}return i.length>0&&n.push({literal:s,val:i}),n}static macroTokenToFormatOpts(e){return LHe[e]}constructor(e,r){this.opts=r,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,r){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...r}).format()}formatDateTime(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).format()}formatDateTimeParts(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).formatToParts()}formatInterval(e,r={}){return this.loc.dtFormatter(e.start,{...this.opts,...r}).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).resolvedOptions()}num(e,r=0){if(this.opts.forceSimple)return ro(e,r);const i={...this.opts};return r>0&&(i.padTo=r),this.loc.numberFormatter(i).format(e)}formatDateTimeFromString(e,r){const i=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(m,y)=>this.loc.extract(e,m,y),o=m=>e.isOffsetFixed&&e.offset===0&&m.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,m.format):"",a=()=>i?OHe(e):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(m,y)=>i?PHe(e,m):n(y?{month:m}:{month:m,day:"numeric"},"month"),c=(m,y)=>i?MHe(e,m):n(y?{weekday:m}:{weekday:m,month:"long",day:"numeric"},"weekday"),h=m=>{const y=Ka.macroTokenToFormatOpts(m);return y?this.formatWithSystemDefault(e,y):m},p=m=>i?IHe(e,m):n({era:m},"era"),f=m=>{switch(m){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(e.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(e.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(e.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(e.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return h(m)}};return Tie(Ka.parseFormat(r),f)}formatDurationFromString(e,r){const i=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=i(c);return h?this.num(l.get(h),c.length):c},n=Ka.parseFormat(r),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=e.shiftTo(...o.map(i).filter(l=>l));return Tie(n,s(a))}}class ap{constructor(e,r){this.reason=e,this.explanation=r}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const P1e=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function sC(...t){const e=t.reduce((r,i)=>r+i.source,"");return RegExp(`^${e}$`)}function nC(...t){return e=>t.reduce(([r,i,s],n)=>{const[o,a,l]=n(e,s);return[{...r,...o},a||i,l]},[{},null,1]).slice(0,2)}function oC(t,...e){if(t==null)return[null,null];for(const[r,i]of e){const s=r.exec(t);if(s)return i(s)}return[null,null]}function I1e(...t){return(e,r)=>{const i={};let s;for(s=0;s<t.length;s++)i[t[s]]=a_(e[r+s]);return[i,null,r+s]}}const $1e=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,DHe=`(?:${$1e.source}?(?:\\[(${P1e.source})\\])?)?`,pZ=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,L1e=RegExp(`${pZ.source}${DHe}`),fZ=RegExp(`(?:T${L1e.source})?`),NHe=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,FHe=/(\d{4})-?W(\d\d)(?:-?(\d))?/,UHe=/(\d{4})-?(\d{3})/,VHe=I1e("weekYear","weekNumber","weekDay"),kHe=I1e("year","ordinal"),zHe=/(\d{4})-(\d\d)-(\d\d)/,D1e=RegExp(`${pZ.source} ?(?:${$1e.source}|(${P1e.source}))?`),BHe=RegExp(`(?: ${D1e.source})?`);function _S(t,e,r){const i=t[e];return gi(i)?r:a_(i)}function GHe(t,e){return[{year:_S(t,e),month:_S(t,e+1,1),day:_S(t,e+2,1)},null,e+3]}function aC(t,e){return[{hours:_S(t,e,0),minutes:_S(t,e+1,0),seconds:_S(t,e+2,0),milliseconds:uZ(t[e+3])},null,e+4]}function YM(t,e){const r=!t[e]&&!t[e+1],i=t6(t[e+1],t[e+2]),s=r?null:el.instance(i);return[{},s,e+3]}function ZM(t,e){const r=t[e]?ly.create(t[e]):null;return[{},r,e+1]}const jHe=RegExp(`^T?${pZ.source}$`),HHe=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function qHe(t){const[e,r,i,s,n,o,a,l,c]=t,h=e[0]==="-",p=l&&l[0]==="-",f=(m,y=!1)=>m!==void 0&&(y||m&&h)?-m:m;return[{years:f(Bv(r)),months:f(Bv(i)),weeks:f(Bv(s)),days:f(Bv(n)),hours:f(Bv(o)),minutes:f(Bv(a)),seconds:f(Bv(l),l==="-0"),milliseconds:f(uZ(c),p)}]}const WHe={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function mZ(t,e,r,i,s,n,o){const a={year:e.length===2?uj(a_(e)):a_(e),month:S1e.indexOf(r)+1,day:a_(i),hour:a_(s),minute:a_(n)};return o&&(a.second=a_(o)),t&&(a.weekday=t.length>3?C1e.indexOf(t)+1:A1e.indexOf(t)+1),a}const XHe=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function YHe(t){const[,e,r,i,s,n,o,a,l,c,h,p]=t,f=mZ(e,s,i,r,n,o,a);let m;return l?m=WHe[l]:c?m=0:m=t6(h,p),[f,new el(m)]}function ZHe(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const JHe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,KHe=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,QHe=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function Sie(t){const[,e,r,i,s,n,o,a]=t;return[mZ(e,s,i,r,n,o,a),el.utcInstance]}function eqe(t){const[,e,r,i,s,n,o,a]=t;return[mZ(e,a,r,i,s,n,o),el.utcInstance]}const tqe=sC(NHe,fZ),rqe=sC(FHe,fZ),iqe=sC(UHe,fZ),sqe=sC(L1e),N1e=nC(GHe,aC,YM,ZM),nqe=nC(VHe,aC,YM,ZM),oqe=nC(kHe,aC,YM,ZM),aqe=nC(aC,YM,ZM);function lqe(t){return oC(t,[tqe,N1e],[rqe,nqe],[iqe,oqe],[sqe,aqe])}function cqe(t){return oC(ZHe(t),[XHe,YHe])}function uqe(t){return oC(t,[JHe,Sie],[KHe,Sie],[QHe,eqe])}function hqe(t){return oC(t,[HHe,qHe])}const dqe=nC(aC);function pqe(t){return oC(t,[jHe,dqe])}const fqe=sC(zHe,BHe),mqe=sC(D1e),gqe=nC(aC,YM,ZM);function yqe(t){return oC(t,[fqe,N1e],[mqe,gqe])}const _qe="Invalid Duration",F1e={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},vqe={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...F1e},Wu=146097/400,Ax=146097/4800,bqe={years:{quarters:4,months:12,weeks:Wu/7,days:Wu,hours:Wu*24,minutes:Wu*24*60,seconds:Wu*24*60*60,milliseconds:Wu*24*60*60*1e3},quarters:{months:3,weeks:Wu/28,days:Wu/4,hours:Wu*24/4,minutes:Wu*24*60/4,seconds:Wu*24*60*60/4,milliseconds:Wu*24*60*60*1e3/4},months:{weeks:Ax/7,days:Ax,hours:Ax*24,minutes:Ax*24*60,seconds:Ax*24*60*60,milliseconds:Ax*24*60*60*1e3},...F1e},rb=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],wqe=rb.slice(0).reverse();function Yy(t,e,r=!1){const i={values:r?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new vi(i)}function xqe(t){return t<0?Math.floor(t):Math.ceil(t)}function U1e(t,e,r,i,s){const n=t[s][r],o=e[r]/n,a=Math.sign(o)===Math.sign(i[s]),l=!a&&i[s]!==0&&Math.abs(o)<=1?xqe(o):Math.trunc(o);i[s]+=l,e[r]-=l*n}function Tqe(t,e){wqe.reduce((r,i)=>gi(e[i])?r:(r&&U1e(t,e,r,e,i),i),null)}function Sqe(t){const e={};for(const[r,i]of Object.entries(t))i!==0&&(e[r]=i);return e}class vi{constructor(e){const r=e.conversionAccuracy==="longterm"||!1;let i=r?bqe:vqe;e.matrix&&(i=e.matrix),this.values=e.values,this.loc=e.loc||Hs.create(),this.conversionAccuracy=r?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=i,this.isLuxonDuration=!0}static fromMillis(e,r){return vi.fromObject({milliseconds:e},r)}static fromObject(e,r={}){if(e==null||typeof e!="object")throw new Ah(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new vi({values:zF(e,vi.normalizeUnit),loc:Hs.fromObject(r),conversionAccuracy:r.conversionAccuracy,matrix:r.matrix})}static fromDurationLike(e){if(uw(e))return vi.fromMillis(e);if(vi.isDuration(e))return e;if(typeof e=="object")return vi.fromObject(e);throw new Ah(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,r){const[i]=hqe(e);return i?vi.fromObject(i,r):vi.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,r){const[i]=pqe(e);return i?vi.fromObject(i,r):vi.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,r=null){if(!e)throw new Ah("need to specify a reason the Duration is invalid");const i=e instanceof ap?e:new ap(e,r);if(eo.throwOnInvalid)throw new Kje(i);return new vi({invalid:i})}static normalizeUnit(e){const r={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!r)throw new t1e(e);return r}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,r={}){const i={...r,floor:r.round!==!1&&r.floor!==!1};return this.isValid?Ka.create(this.loc,i).formatDurationFromString(this,e):_qe}toHuman(e={}){const r=rb.map(i=>{const s=this.values[i];return gi(s)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:i.slice(0,-1)}).format(s)}).filter(i=>i);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(r)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=hZ(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const r=this.toMillis();if(r<0||r>=864e5)return null;e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e};const i=this.shiftTo("hours","minutes","seconds","milliseconds");let s=e.format==="basic"?"hhmm":"hh:mm";(!e.suppressSeconds||i.seconds!==0||i.milliseconds!==0)&&(s+=e.format==="basic"?"ss":":ss",(!e.suppressMilliseconds||i.milliseconds!==0)&&(s+=".SSS"));let n=i.toFormat(s);return e.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const r=vi.fromDurationLike(e),i={};for(const s of rb)(wE(r.values,s)||wE(this.values,s))&&(i[s]=r.get(s)+this.get(s));return Yy(this,{values:i},!0)}minus(e){if(!this.isValid)return this;const r=vi.fromDurationLike(e);return this.plus(r.negate())}mapUnits(e){if(!this.isValid)return this;const r={};for(const i of Object.keys(this.values))r[i]=T1e(e(this.values[i],i));return Yy(this,{values:r},!0)}get(e){return this[vi.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const r={...this.values,...zF(e,vi.normalizeUnit)};return Yy(this,{values:r})}reconfigure({locale:e,numberingSystem:r,conversionAccuracy:i,matrix:s}={}){const o={loc:this.loc.clone({locale:e,numberingSystem:r}),matrix:s,conversionAccuracy:i};return Yy(this,o)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return Tqe(this.matrix,e),Yy(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=Sqe(this.normalize().shiftToAll().toObject());return Yy(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(o=>vi.normalizeUnit(o));const r={},i={},s=this.toObject();let n;for(const o of rb)if(e.indexOf(o)>=0){n=o;let a=0;for(const c in i)a+=this.matrix[c][o]*i[c],i[c]=0;uw(s[o])&&(a+=s[o]);const l=Math.trunc(a);r[o]=l,i[o]=(a*1e3-l*1e3)/1e3;for(const c in s)rb.indexOf(c)>rb.indexOf(o)&&U1e(this.matrix,s,c,r,o)}else uw(s[o])&&(i[o]=s[o]);for(const o in i)i[o]!==0&&(r[n]+=o===n?i[o]:i[o]/this.matrix[n][o]);return Yy(this,{values:r},!0).normalize()}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const r of Object.keys(this.values))e[r]=this.values[r]===0?0:-this.values[r];return Yy(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function r(i,s){return i===void 0||i===0?s===void 0||s===0:i===s}for(const i of rb)if(!r(this.values[i],e.values[i]))return!1;return!0}}const Rx="Invalid Interval";function Eqe(t,e){return!t||!t.isValid?mn.invalid("missing or invalid start"):!e||!e.isValid?mn.invalid("missing or invalid end"):e<t?mn.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class mn{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,r=null){if(!e)throw new Ah("need to specify a reason the Interval is invalid");const i=e instanceof ap?e:new ap(e,r);if(eo.throwOnInvalid)throw new Jje(i);return new mn({invalid:i})}static fromDateTimes(e,r){const i=BC(e),s=BC(r),n=Eqe(i,s);return n??new mn({start:i,end:s})}static after(e,r){const i=vi.fromDurationLike(r),s=BC(e);return mn.fromDateTimes(s,s.plus(i))}static before(e,r){const i=vi.fromDurationLike(r),s=BC(e);return mn.fromDateTimes(s.minus(i),s)}static fromISO(e,r){const[i,s]=(e||"").split("/",2);if(i&&s){let n,o;try{n=Cr.fromISO(i,r),o=n.isValid}catch{o=!1}let a,l;try{a=Cr.fromISO(s,r),l=a.isValid}catch{l=!1}if(o&&l)return mn.fromDateTimes(n,a);if(o){const c=vi.fromISO(s,r);if(c.isValid)return mn.after(n,c)}else if(l){const c=vi.fromISO(i,r);if(c.isValid)return mn.before(a,c)}}return mn.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds"){if(!this.isValid)return NaN;const r=this.start.startOf(e),i=this.end.startOf(e);return Math.floor(i.diff(r,e).get(e))+1}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:r}={}){return this.isValid?mn.fromDateTimes(e||this.s,r||this.e):this}splitAt(...e){if(!this.isValid)return[];const r=e.map(BC).filter(o=>this.contains(o)).sort(),i=[];let{s}=this,n=0;for(;s<this.e;){const o=r[n]||this.e,a=+o>+this.e?this.e:o;i.push(mn.fromDateTimes(s,a)),s=a,n+=1}return i}splitBy(e){const r=vi.fromDurationLike(e);if(!this.isValid||!r.isValid||r.as("milliseconds")===0)return[];let{s:i}=this,s=1,n;const o=[];for(;i<this.e;){const a=this.start.plus(r.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(mn.fromDateTimes(i,n)),i=n,s+=1}return o}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const r=this.s>e.s?this.s:e.s,i=this.e<e.e?this.e:e.e;return r>=i?null:mn.fromDateTimes(r,i)}union(e){if(!this.isValid)return this;const r=this.s<e.s?this.s:e.s,i=this.e>e.e?this.e:e.e;return mn.fromDateTimes(r,i)}static merge(e){const[r,i]=e.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return i&&r.push(i),r}static xor(e){let r=null,i=0;const s=[],n=e.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)i+=l.type==="s"?1:-1,i===1?r=l.time:(r&&+r!=+l.time&&s.push(mn.fromDateTimes(r,l.time)),r=null);return mn.merge(s)}difference(...e){return mn.xor([this].concat(e)).map(r=>this.intersection(r)).filter(r=>r&&!r.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()}  ${this.e.toISO()})`:Rx}toLocaleString(e=UF,r={}){return this.isValid?Ka.create(this.s.loc.clone(r),e).formatInterval(this):Rx}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:Rx}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:Rx}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:Rx}toFormat(e,{separator:r="  "}={}){return this.isValid?`${this.s.toFormat(e)}${r}${this.e.toFormat(e)}`:Rx}toDuration(e,r){return this.isValid?this.e.diff(this.s,e,r):vi.invalid(this.invalidReason)}mapEndpoints(e){return mn.fromDateTimes(e(this.s),e(this.e))}}class gI{static hasDST(e=eo.defaultZone){const r=Cr.now().setZone(e).set({month:12});return!e.isUniversal&&r.offset!==r.set({month:6}).offset}static isValidIANAZone(e){return ly.isValidZone(e)}static normalizeZone(e){return g_(e,eo.defaultZone)}static months(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||Hs.create(r,i,n)).months(e)}static monthsFormat(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||Hs.create(r,i,n)).months(e,!0)}static weekdays(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null}={}){return(s||Hs.create(r,i,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null}={}){return(s||Hs.create(r,i,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return Hs.create(e).meridiems()}static eras(e="short",{locale:r=null}={}){return Hs.create(r,null,"gregory").eras(e)}static features(){return{relative:w1e()}}}function Eie(t,e){const r=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),i=r(e)-r(t);return Math.floor(vi.fromMillis(i).as("days"))}function Cqe(t,e,r){const i=[["years",(l,c)=>c.year-l.year],["quarters",(l,c)=>c.quarter-l.quarter+(c.year-l.year)*4],["months",(l,c)=>c.month-l.month+(c.year-l.year)*12],["weeks",(l,c)=>{const h=Eie(l,c);return(h-h%7)/7}],["days",Eie]],s={},n=t;let o,a;for(const[l,c]of i)r.indexOf(l)>=0&&(o=l,s[l]=c(t,e),a=n.plus(s),a>e?(s[l]--,t=n.plus(s)):t=a);return[t,s,a,o]}function Aqe(t,e,r,i){let[s,n,o,a]=Cqe(t,e,r);const l=e-s,c=r.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<e&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=vi.fromObject(n,i);return c.length>0?vi.fromMillis(l,i).shiftTo(...c).plus(h):h}const gZ={arab:"[-]",arabext:"[-]",bali:"[-]",beng:"[-]",deva:"[-]",fullwide:"[-]",gujr:"[-]",hanidec:"[|||||||||]",khmr:"[-]",knda:"[-]",laoo:"[-]",limb:"[-]",mlym:"[-]",mong:"[-]",mymr:"[-]",orya:"[-]",tamldec:"[-]",telu:"[-]",thai:"[-]",tibt:"[-]",latn:"\\d"},Cie={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},Rqe=gZ.hanidec.replace(/[\[|\]]/g,"").split("");function Oqe(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let r=0;r<t.length;r++){const i=t.charCodeAt(r);if(t[r].search(gZ.hanidec)!==-1)e+=Rqe.indexOf(t[r]);else for(const s in Cie){const[n,o]=Cie[s];i>=n&&i<=o&&(e+=i-n)}}return parseInt(e,10)}else return e}function hd({numberingSystem:t},e=""){return new RegExp(`${gZ[t||"latn"]}${e}`)}const Mqe="missing Intl.DateTimeFormat.formatToParts support";function Li(t,e=r=>r){return{regex:t,deser:([r])=>e(Oqe(r))}}const Pqe=String.fromCharCode(160),V1e=`[ ${Pqe}]`,k1e=new RegExp(V1e,"g");function Iqe(t){return t.replace(/\./g,"\\.?").replace(k1e,V1e)}function Aie(t){return t.replace(/\./g,"").replace(k1e," ").toLowerCase()}function dd(t,e){return t===null?null:{regex:RegExp(t.map(Iqe).join("|")),deser:([r])=>t.findIndex(i=>Aie(r)===Aie(i))+e}}function Rie(t,e){return{regex:t,deser:([,r,i])=>t6(r,i),groups:e}}function S8(t){return{regex:t,deser:([e])=>e}}function $qe(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Lqe(t,e){const r=hd(e),i=hd(e,"{2}"),s=hd(e,"{3}"),n=hd(e,"{4}"),o=hd(e,"{6}"),a=hd(e,"{1,2}"),l=hd(e,"{1,3}"),c=hd(e,"{1,6}"),h=hd(e,"{1,9}"),p=hd(e,"{2,4}"),f=hd(e,"{4,6}"),m=b=>({regex:RegExp($qe(b.val)),deser:([x])=>x,literal:!0}),_=(b=>{if(t.literal)return m(b);switch(b.val){case"G":return dd(e.eras("short",!1),0);case"GG":return dd(e.eras("long",!1),0);case"y":return Li(c);case"yy":return Li(p,uj);case"yyyy":return Li(n);case"yyyyy":return Li(f);case"yyyyyy":return Li(o);case"M":return Li(a);case"MM":return Li(i);case"MMM":return dd(e.months("short",!0,!1),1);case"MMMM":return dd(e.months("long",!0,!1),1);case"L":return Li(a);case"LL":return Li(i);case"LLL":return dd(e.months("short",!1,!1),1);case"LLLL":return dd(e.months("long",!1,!1),1);case"d":return Li(a);case"dd":return Li(i);case"o":return Li(l);case"ooo":return Li(s);case"HH":return Li(i);case"H":return Li(a);case"hh":return Li(i);case"h":return Li(a);case"mm":return Li(i);case"m":return Li(a);case"q":return Li(a);case"qq":return Li(i);case"s":return Li(a);case"ss":return Li(i);case"S":return Li(l);case"SSS":return Li(s);case"u":return S8(h);case"uu":return S8(a);case"uuu":return Li(r);case"a":return dd(e.meridiems(),0);case"kkkk":return Li(n);case"kk":return Li(p,uj);case"W":return Li(a);case"WW":return Li(i);case"E":case"c":return Li(r);case"EEE":return dd(e.weekdays("short",!1,!1),1);case"EEEE":return dd(e.weekdays("long",!1,!1),1);case"ccc":return dd(e.weekdays("short",!0,!1),1);case"cccc":return dd(e.weekdays("long",!0,!1),1);case"Z":case"ZZ":return Rie(new RegExp(`([+-]${a.source})(?::(${i.source}))?`),2);case"ZZZ":return Rie(new RegExp(`([+-]${a.source})(${i.source})?`),2);case"z":return S8(/[a-z_+-/]{1,256}?/i);default:return m(b)}})(t)||{invalidReason:Mqe};return _.token=t,_}const Dqe={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function Nqe(t,e){const{type:r,value:i}=t;if(r==="literal")return{literal:!0,val:i};const s=e[r];let n=Dqe[r];if(typeof n=="object"&&(n=n[s]),n)return{literal:!1,val:n}}function Fqe(t){return[`^${t.map(r=>r.regex).reduce((r,i)=>`${r}(${i.source})`,"")}$`,t]}function Uqe(t,e,r){const i=t.match(e);if(i){const s={};let n=1;for(const o in r)if(wE(r,o)){const a=r[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(i.slice(n,n+l))),n+=l}return[i,s]}else return[i,{}]}function Vqe(t){const e=n=>{switch(n){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let r=null,i;return gi(t.z)||(r=ly.create(t.z)),gi(t.Z)||(r||(r=new el(t.Z)),i=t.Z),gi(t.q)||(t.M=(t.q-1)*3+1),gi(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),gi(t.u)||(t.S=uZ(t.u)),[Object.keys(t).reduce((n,o)=>{const a=e(o);return a&&(n[a]=t[o]),n},{}),r,i]}let E8=null;function kqe(){return E8||(E8=Cr.fromMillis(1555555555555)),E8}function zqe(t,e){if(t.literal)return t;const r=Ka.macroTokenToFormatOpts(t.val),i=G1e(r,e);return i==null||i.includes(void 0)?t:i}function z1e(t,e){return Array.prototype.concat(...t.map(r=>zqe(r,e)))}function B1e(t,e,r){const i=z1e(Ka.parseFormat(r),t),s=i.map(o=>Lqe(o,t)),n=s.find(o=>o.invalidReason);if(n)return{input:e,tokens:i,invalidReason:n.invalidReason};{const[o,a]=Fqe(s),l=RegExp(o,"i"),[c,h]=Uqe(e,l,a),[p,f,m]=h?Vqe(h):[null,null,void 0];if(wE(h,"a")&&wE(h,"H"))throw new TR("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:i,regex:l,rawMatches:c,matches:h,result:p,zone:f,specificOffset:m}}}function Bqe(t,e,r){const{result:i,zone:s,specificOffset:n,invalidReason:o}=B1e(t,e,r);return[i,s,n,o]}function G1e(t,e){return t?Ka.create(e,t).formatDateTimeParts(kqe()).map(s=>Nqe(s,t)):null}const j1e=[0,31,59,90,120,151,181,212,243,273,304,334],H1e=[0,31,60,91,121,152,182,213,244,274,305,335];function Nh(t,e){return new ap("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function q1e(t,e,r){const i=new Date(Date.UTC(t,e-1,r));t<100&&t>=0&&i.setUTCFullYear(i.getUTCFullYear()-1900);const s=i.getUTCDay();return s===0?7:s}function W1e(t,e,r){return r+(XM(t)?H1e:j1e)[e-1]}function X1e(t,e){const r=XM(t)?H1e:j1e,i=r.findIndex(n=>n<e),s=e-r[i];return{month:i+1,day:s}}function hj(t){const{year:e,month:r,day:i}=t,s=W1e(e,r,i),n=q1e(e,r,i);let o=Math.floor((s-n+10)/7),a;return o<1?(a=e-1,o=kF(a)):o>kF(e)?(a=e+1,o=1):a=e,{weekYear:a,weekNumber:o,weekday:n,...r6(t)}}function Oie(t){const{weekYear:e,weekNumber:r,weekday:i}=t,s=q1e(e,1,4),n=RO(e);let o=r*7+i-s-3,a;o<1?(a=e-1,o+=RO(a)):o>n?(a=e+1,o-=RO(e)):a=e;const{month:l,day:c}=X1e(a,o);return{year:a,month:l,day:c,...r6(t)}}function C8(t){const{year:e,month:r,day:i}=t,s=W1e(e,r,i);return{year:e,ordinal:s,...r6(t)}}function Mie(t){const{year:e,ordinal:r}=t,{month:i,day:s}=X1e(e,r);return{year:e,month:i,day:s,...r6(t)}}function Gqe(t){const e=e6(t.weekYear),r=zg(t.weekNumber,1,kF(t.weekYear)),i=zg(t.weekday,1,7);return e?r?i?!1:Nh("weekday",t.weekday):Nh("week",t.week):Nh("weekYear",t.weekYear)}function jqe(t){const e=e6(t.year),r=zg(t.ordinal,1,RO(t.year));return e?r?!1:Nh("ordinal",t.ordinal):Nh("year",t.year)}function Y1e(t){const e=e6(t.year),r=zg(t.month,1,12),i=zg(t.day,1,VF(t.year,t.month));return e?r?i?!1:Nh("day",t.day):Nh("month",t.month):Nh("year",t.year)}function Z1e(t){const{hour:e,minute:r,second:i,millisecond:s}=t,n=zg(e,0,23)||e===24&&r===0&&i===0&&s===0,o=zg(r,0,59),a=zg(i,0,59),l=zg(s,0,999);return n?o?a?l?!1:Nh("millisecond",s):Nh("second",i):Nh("minute",r):Nh("hour",e)}const A8="Invalid DateTime",Pie=864e13;function yI(t){return new ap("unsupported zone",`the zone "${t.name}" is not supported`)}function R8(t){return t.weekData===null&&(t.weekData=hj(t.c)),t.weekData}function kC(t,e){const r={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new Cr({...r,...e,old:r})}function J1e(t,e,r){let i=t-e*60*1e3;const s=r.offset(i);if(e===s)return[i,e];i-=(s-e)*60*1e3;const n=r.offset(i);return s===n?[i,s]:[t-Math.min(s,n)*60*1e3,Math.max(s,n)]}function Iie(t,e){t+=e*60*1e3;const r=new Date(t);return{year:r.getUTCFullYear(),month:r.getUTCMonth()+1,day:r.getUTCDate(),hour:r.getUTCHours(),minute:r.getUTCMinutes(),second:r.getUTCSeconds(),millisecond:r.getUTCMilliseconds()}}function PD(t,e,r){return J1e(dZ(t),e,r)}function $ie(t,e){const r=t.o,i=t.c.year+Math.trunc(e.years),s=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,n={...t.c,year:i,month:s,day:Math.min(t.c.day,VF(i,s))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},o=vi.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),a=dZ(n);let[l,c]=J1e(a,r,t.zone);return o!==0&&(l+=o,c=t.zone.offset(l)),{ts:l,o:c}}function zC(t,e,r,i,s,n){const{setZone:o,zone:a}=r;if(t&&Object.keys(t).length!==0){const l=e||a,c=Cr.fromObject(t,{...r,zone:l,specificOffset:n});return o?c:c.setZone(a)}else return Cr.invalid(new ap("unparsable",`the input "${s}" can't be parsed as ${i}`))}function _I(t,e,r=!0){return t.isValid?Ka.create(Hs.create("en-US"),{allowZ:r,forceSimple:!0}).formatDateTimeFromString(t,e):null}function O8(t,e){const r=t.c.year>9999||t.c.year<0;let i="";return r&&t.c.year>=0&&(i+="+"),i+=ro(t.c.year,r?6:4),e?(i+="-",i+=ro(t.c.month),i+="-",i+=ro(t.c.day)):(i+=ro(t.c.month),i+=ro(t.c.day)),i}function Lie(t,e,r,i,s,n){let o=ro(t.c.hour);return e?(o+=":",o+=ro(t.c.minute),(t.c.second!==0||!r)&&(o+=":")):o+=ro(t.c.minute),(t.c.second!==0||!r)&&(o+=ro(t.c.second),(t.c.millisecond!==0||!i)&&(o+=".",o+=ro(t.c.millisecond,3))),s&&(t.isOffsetFixed&&t.offset===0&&!n?o+="Z":t.o<0?(o+="-",o+=ro(Math.trunc(-t.o/60)),o+=":",o+=ro(Math.trunc(-t.o%60))):(o+="+",o+=ro(Math.trunc(t.o/60)),o+=":",o+=ro(Math.trunc(t.o%60)))),n&&(o+="["+t.zone.ianaName+"]"),o}const K1e={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Hqe={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},qqe={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Q1e=["year","month","day","hour","minute","second","millisecond"],Wqe=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Xqe=["year","ordinal","hour","minute","second","millisecond"];function Die(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new t1e(t);return e}function Nie(t,e){const r=g_(e.zone,eo.defaultZone),i=Hs.fromObject(e),s=eo.now();let n,o;if(gi(t.year))n=s;else{for(const c of Q1e)gi(t[c])&&(t[c]=K1e[c]);const a=Y1e(t)||Z1e(t);if(a)return Cr.invalid(a);const l=r.offset(s);[n,o]=PD(t,l,r)}return new Cr({ts:n,zone:r,loc:i,o})}function Fie(t,e,r){const i=gi(r.round)?!0:r.round,s=(o,a)=>(o=hZ(o,i||r.calendary?0:2,!0),e.loc.clone(r).relFormatter(r).format(o,a)),n=o=>r.calendary?e.hasSame(t,o)?0:e.startOf(o).diff(t.startOf(o),o).get(o):e.diff(t,o).get(o);if(r.unit)return s(n(r.unit),r.unit);for(const o of r.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(t>e?-0:0,r.units[r.units.length-1])}function Uie(t){let e={},r;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],r=Array.from(t).slice(0,t.length-1)):r=Array.from(t),[e,r]}class Cr{constructor(e){const r=e.zone||eo.defaultZone;let i=e.invalid||(Number.isNaN(e.ts)?new ap("invalid input"):null)||(r.isValid?null:yI(r));this.ts=gi(e.ts)?eo.now():e.ts;let s=null,n=null;if(!i)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(r))[s,n]=[e.old.c,e.old.o];else{const a=r.offset(this.ts);s=Iie(this.ts,a),i=Number.isNaN(s.year)?new ap("invalid input"):null,s=i?null:s,n=i?null:a}this._zone=r,this.loc=e.loc||Hs.create(),this.invalid=i,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new Cr({})}static local(){const[e,r]=Uie(arguments),[i,s,n,o,a,l,c]=r;return Nie({year:i,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static utc(){const[e,r]=Uie(arguments),[i,s,n,o,a,l,c]=r;return e.zone=el.utcInstance,Nie({year:i,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static fromJSDate(e,r={}){const i=vHe(e)?e.valueOf():NaN;if(Number.isNaN(i))return Cr.invalid("invalid input");const s=g_(r.zone,eo.defaultZone);return s.isValid?new Cr({ts:i,zone:s,loc:Hs.fromObject(r)}):Cr.invalid(yI(s))}static fromMillis(e,r={}){if(uw(e))return e<-Pie||e>Pie?Cr.invalid("Timestamp out of range"):new Cr({ts:e,zone:g_(r.zone,eo.defaultZone),loc:Hs.fromObject(r)});throw new Ah(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,r={}){if(uw(e))return new Cr({ts:e*1e3,zone:g_(r.zone,eo.defaultZone),loc:Hs.fromObject(r)});throw new Ah("fromSeconds requires a numerical input")}static fromObject(e,r={}){e=e||{};const i=g_(r.zone,eo.defaultZone);if(!i.isValid)return Cr.invalid(yI(i));const s=eo.now(),n=gi(r.specificOffset)?i.offset(s):r.specificOffset,o=zF(e,Die),a=!gi(o.ordinal),l=!gi(o.year),c=!gi(o.month)||!gi(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=Hs.fromObject(r);if((h||a)&&p)throw new TR("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new TR("Can't mix ordinal dates with month/day");const m=p||o.weekday&&!h;let y,_,b=Iie(s,n);m?(y=Wqe,_=Hqe,b=hj(b)):a?(y=Xqe,_=qqe,b=C8(b)):(y=Q1e,_=K1e);let x=!1;for(const I of y){const U=o[I];gi(U)?x?o[I]=_[I]:o[I]=b[I]:x=!0}const T=m?Gqe(o):a?jqe(o):Y1e(o),S=T||Z1e(o);if(S)return Cr.invalid(S);const E=m?Oie(o):a?Mie(o):o,[O,R]=PD(E,n,i),L=new Cr({ts:O,zone:i,o:R,loc:f});return o.weekday&&h&&e.weekday!==L.weekday?Cr.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${L.toISO()}`):L}static fromISO(e,r={}){const[i,s]=lqe(e);return zC(i,s,r,"ISO 8601",e)}static fromRFC2822(e,r={}){const[i,s]=cqe(e);return zC(i,s,r,"RFC 2822",e)}static fromHTTP(e,r={}){const[i,s]=uqe(e);return zC(i,s,r,"HTTP",r)}static fromFormat(e,r,i={}){if(gi(e)||gi(r))throw new Ah("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=i,o=Hs.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c,h]=Bqe(o,e,r);return h?Cr.invalid(h):zC(a,l,i,`format ${r}`,e,c)}static fromString(e,r,i={}){return Cr.fromFormat(e,r,i)}static fromSQL(e,r={}){const[i,s]=yqe(e);return zC(i,s,r,"SQL",e)}static invalid(e,r=null){if(!e)throw new Ah("need to specify a reason the DateTime is invalid");const i=e instanceof ap?e:new ap(e,r);if(eo.throwOnInvalid)throw new Zje(i);return new Cr({invalid:i})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,r={}){const i=G1e(e,Hs.fromObject(r));return i?i.map(s=>s?s.val:null).join(""):null}static expandFormat(e,r={}){return z1e(Ka.parseFormat(e),Hs.fromObject(r)).map(s=>s.val).join("")}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?R8(this).weekYear:NaN}get weekNumber(){return this.isValid?R8(this).weekNumber:NaN}get weekday(){return this.isValid?R8(this).weekday:NaN}get ordinal(){return this.isValid?C8(this.c).ordinal:NaN}get monthShort(){return this.isValid?gI.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?gI.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?gI.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?gI.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return XM(this.year)}get daysInMonth(){return VF(this.year,this.month)}get daysInYear(){return this.isValid?RO(this.year):NaN}get weeksInWeekYear(){return this.isValid?kF(this.weekYear):NaN}resolvedLocaleOptions(e={}){const{locale:r,numberingSystem:i,calendar:s}=Ka.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:r,numberingSystem:i,outputCalendar:s}}toUTC(e=0,r={}){return this.setZone(el.instance(e),r)}toLocal(){return this.setZone(eo.defaultZone)}setZone(e,{keepLocalTime:r=!1,keepCalendarTime:i=!1}={}){if(e=g_(e,eo.defaultZone),e.equals(this.zone))return this;if(e.isValid){let s=this.ts;if(r||i){const n=e.offset(this.ts),o=this.toObject();[s]=PD(o,n,e)}return kC(this,{ts:s,zone:e})}else return Cr.invalid(yI(e))}reconfigure({locale:e,numberingSystem:r,outputCalendar:i}={}){const s=this.loc.clone({locale:e,numberingSystem:r,outputCalendar:i});return kC(this,{loc:s})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const r=zF(e,Die),i=!gi(r.weekYear)||!gi(r.weekNumber)||!gi(r.weekday),s=!gi(r.ordinal),n=!gi(r.year),o=!gi(r.month)||!gi(r.day),a=n||o,l=r.weekYear||r.weekNumber;if((a||s)&&l)throw new TR("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new TR("Can't mix ordinal dates with month/day");let c;i?c=Oie({...hj(this.c),...r}):gi(r.ordinal)?(c={...this.toObject(),...r},gi(r.day)&&(c.day=Math.min(VF(c.year,c.month),c.day))):c=Mie({...C8(this.c),...r});const[h,p]=PD(c,this.o,this.zone);return kC(this,{ts:h,o:p})}plus(e){if(!this.isValid)return this;const r=vi.fromDurationLike(e);return kC(this,$ie(this,r))}minus(e){if(!this.isValid)return this;const r=vi.fromDurationLike(e).negate();return kC(this,$ie(this,r))}startOf(e){if(!this.isValid)return this;const r={},i=vi.normalizeUnit(e);switch(i){case"years":r.month=1;case"quarters":case"months":r.day=1;case"weeks":case"days":r.hour=0;case"hours":r.minute=0;case"minutes":r.second=0;case"seconds":r.millisecond=0;break}if(i==="weeks"&&(r.weekday=1),i==="quarters"){const s=Math.ceil(this.month/3);r.month=(s-1)*3+1}return this.set(r)}endOf(e){return this.isValid?this.plus({[e]:1}).startOf(e).minus(1):this}toFormat(e,r={}){return this.isValid?Ka.create(this.loc.redefaultToEN(r)).formatDateTimeFromString(this,e):A8}toLocaleString(e=UF,r={}){return this.isValid?Ka.create(this.loc.clone(r),e).formatDateTime(this):A8}toLocaleParts(e={}){return this.isValid?Ka.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:r=!1,suppressMilliseconds:i=!1,includeOffset:s=!0,extendedZone:n=!1}={}){if(!this.isValid)return null;const o=e==="extended";let a=O8(this,o);return a+="T",a+=Lie(this,o,r,i,s,n),a}toISODate({format:e="extended"}={}){return this.isValid?O8(this,e==="extended"):null}toISOWeekDate(){return _I(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:r=!1,includeOffset:i=!0,includePrefix:s=!1,extendedZone:n=!1,format:o="extended"}={}){return this.isValid?(s?"T":"")+Lie(this,o==="extended",r,e,i,n):null}toRFC2822(){return _I(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return _I(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?O8(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:r=!1,includeOffsetSpace:i=!0}={}){let s="HH:mm:ss.SSS";return(r||e)&&(i&&(s+=" "),r?s+="z":e&&(s+="ZZ")),_I(this,s,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():A8}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const r={...this.c};return e.includeConfig&&(r.outputCalendar=this.outputCalendar,r.numberingSystem=this.loc.numberingSystem,r.locale=this.loc.locale),r}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,r="milliseconds",i={}){if(!this.isValid||!e.isValid)return vi.invalid("created by diffing an invalid DateTime");const s={locale:this.locale,numberingSystem:this.numberingSystem,...i},n=bHe(r).map(vi.normalizeUnit),o=e.valueOf()>this.valueOf(),a=o?this:e,l=o?e:this,c=Aqe(a,l,n,s);return o?c.negate():c}diffNow(e="milliseconds",r={}){return this.diff(Cr.now(),e,r)}until(e){return this.isValid?mn.fromDateTimes(this,e):this}hasSame(e,r){if(!this.isValid)return!1;const i=e.valueOf(),s=this.setZone(e.zone,{keepLocalTime:!0});return s.startOf(r)<=i&&i<=s.endOf(r)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const r=e.base||Cr.fromObject({},{zone:this.zone}),i=e.padding?this<r?-e.padding:e.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=e.unit;return Array.isArray(e.unit)&&(s=e.unit,n=void 0),Fie(r,this.plus(i),{...e,numeric:"always",units:s,unit:n})}toRelativeCalendar(e={}){return this.isValid?Fie(e.base||Cr.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(Cr.isDateTime))throw new Ah("min requires all arguments be DateTimes");return xie(e,r=>r.valueOf(),Math.min)}static max(...e){if(!e.every(Cr.isDateTime))throw new Ah("max requires all arguments be DateTimes");return xie(e,r=>r.valueOf(),Math.max)}static fromFormatExplain(e,r,i={}){const{locale:s=null,numberingSystem:n=null}=i,o=Hs.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return B1e(o,e,r)}static fromStringExplain(e,r,i={}){return Cr.fromFormatExplain(e,r,i)}static get DATE_SHORT(){return UF}static get DATE_MED(){return r1e}static get DATE_MED_WITH_WEEKDAY(){return Qje}static get DATE_FULL(){return i1e}static get DATE_HUGE(){return s1e}static get TIME_SIMPLE(){return n1e}static get TIME_WITH_SECONDS(){return o1e}static get TIME_WITH_SHORT_OFFSET(){return a1e}static get TIME_WITH_LONG_OFFSET(){return l1e}static get TIME_24_SIMPLE(){return c1e}static get TIME_24_WITH_SECONDS(){return u1e}static get TIME_24_WITH_SHORT_OFFSET(){return h1e}static get TIME_24_WITH_LONG_OFFSET(){return d1e}static get DATETIME_SHORT(){return p1e}static get DATETIME_SHORT_WITH_SECONDS(){return f1e}static get DATETIME_MED(){return m1e}static get DATETIME_MED_WITH_SECONDS(){return g1e}static get DATETIME_MED_WITH_WEEKDAY(){return eHe}static get DATETIME_FULL(){return y1e}static get DATETIME_FULL_WITH_SECONDS(){return _1e}static get DATETIME_HUGE(){return v1e}static get DATETIME_HUGE_WITH_SECONDS(){return b1e}}function BC(t){if(Cr.isDateTime(t))return t;if(t&&t.valueOf&&uw(t.valueOf()))return Cr.fromJSDate(t);if(t&&typeof t=="object")return Cr.fromObject(t);throw new Ah(`Unknown datetime argument: ${t}, of type ${typeof t}`)}function Yqe(t,e="system"){if(!t||!pie.has(t.timeZone))return e;const r=pie.get(t.timeZone);return Jqe(t.timeZone)||t.respectsDaylightSaving?r:Zqe(r)}function Zqe(t){const e=Cr.local().setZone(t),r=Math.min(e.set({month:1,day:1}).offset,e.set({month:5}).offset);return r===0?"Etc/UTC":`Etc/GMT${el.instance(-r).formatOffset(0,"narrow")}`}function Jqe(t){return t.startsWith("UTC")}let z0=class extends bs(fe){constructor(e){super(e),this.legacy=null,this.timeZone="system"}readLegacy(e,r){const{timeZone:i,respectsDaylightSaving:s}=r;return{timeZone:i,respectsDaylightSaving:s}}readTimeZone(e,r){return"timeZoneIANA"in r?r.timeZoneIANA:Yqe(r)}writeTimeZone(e,r){r.timeZoneIANA=e}equals(e){return!(C(e)||C(this.timeZone)||C(e.timeZone))&&this.timeZone===e.timeZone}};u([d()],z0.prototype,"legacy",void 0),u([Le("legacy",["timeZone"])],z0.prototype,"readLegacy",null),u([d({type:String,nonNullable:!0})],z0.prototype,"timeZone",void 0),u([Le("timeZone",["timeZone","timeZoneIANA","respectsDaylightSaving"])],z0.prototype,"readTimeZone",null),u([ke("timeZone")],z0.prototype,"writeTimeZone",null),z0=u([P("esri.time.TimeReference")],z0);const xE=z0;let fg=class extends bs(fe){constructor(e){super(e),this.creatorField=null,this.creationDateField=null,this.editorField=null,this.editDateField=null,this.realm=null,this.dateFieldsTimeReference=null}};u([d()],fg.prototype,"creatorField",void 0),u([d()],fg.prototype,"creationDateField",void 0),u([d()],fg.prototype,"editorField",void 0),u([d()],fg.prototype,"editDateField",void 0),u([d()],fg.prototype,"realm",void 0),u([d({type:xE})],fg.prototype,"dateFieldsTimeReference",void 0),fg=u([P("esri.layers.support.EditFieldsInfo")],fg);const Kqe=fg;let Pf=class extends bs(fe){constructor(e){super(e)}};u([d({constructOnly:!0,json:{write:!0}})],Pf.prototype,"name",void 0),u([d({constructOnly:!0,json:{write:!0}})],Pf.prototype,"fields",void 0),u([d({constructOnly:!0,json:{write:!0}})],Pf.prototype,"isAscending",void 0),u([d({constructOnly:!0,json:{write:!0}})],Pf.prototype,"indexType",void 0),u([d({constructOnly:!0,json:{write:!0}})],Pf.prototype,"isUnique",void 0),u([d({constructOnly:!0,json:{write:!0}})],Pf.prototype,"description",void 0),Pf=u([P("esri.layers.support.FeatureIndex")],Pf);const dj=new Vr({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function Qqe(t,e,r,i){const s=await Ov(t);if(await yZ(t,e,i),!s.addAttachment)throw new j(i,"Layer source does not support addAttachment capability");return s.addAttachment(e,r)}function yZ(t,e,r){const{attributes:i}=e,{objectIdField:s}=t;return t.get("capabilities.data.supportsAttachment")?e?i?s&&i[s]?Promise.resolve():Promise.reject(new j(r,`feature is missing the identifying attribute ${s}`)):Promise.reject(new j(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new j(r,"A feature is required to add/delete/update attachments")):Promise.reject(new j(r,"this layer doesn't support attachments"))}async function eWe(t,e,r,i,s){const n=await Ov(t);if(await yZ(t,e,s),!n.updateAttachment)throw new j(s,"Layer source does not support updateAttachment capability");return n.updateAttachment(e,r,i)}async function tWe(t,e,r){const i=await ie(()=>import("./editingSupport-7cebf7cd.js"),["./editingSupport-7cebf7cd.js","./assetEditingSupport-2cebf928.js"],import.meta.url),s=await t.load();return i.applyEdits(s,s.source,e,r)}async function rWe(t,e,r,i){const s=await Ov(t);if(await yZ(t,e,i),!s.deleteAttachments)throw new j(i,"Layer source does not support deleteAttachments capability");return s.deleteAttachments(e,r)}async function iWe(t,e,r){const i=(await t.load({signal:e==null?void 0:e.signal})).source;if(!i.fetchRecomputedExtents)throw new j(r,"Layer source does not support fetchUpdates capability");return i.fetchRecomputedExtents(e)}async function sWe(t,e,r,i){var m,y;e=z7.from(e),await t.load();const s=t.source,n=t.capabilities;if(!((m=n==null?void 0:n.data)!=null&&m.supportsAttachment))throw new j(i,"this layer doesn't support attachments");const{attachmentTypes:o,objectIds:a,globalIds:l,num:c,size:h,start:p,where:f}=e;if(!((y=n==null?void 0:n.operations)!=null&&y.supportsQueryAttachments)&&((o==null?void 0:o.length)>0||(l==null?void 0:l.length)>0||(h==null?void 0:h.length)>0||c||p||f))throw new j(i,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(a!=null&&a.length||l!=null&&l.length||f))throw new j(i,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!s.queryAttachments)throw new j(i,"Layer source does not support queryAttachments capability",e);return s.queryAttachments(e)}async function nWe(t,e,r,i){const s=await Ov(t);if(!s.queryObjectIds)throw new j(i,"Layer source does not support queryObjectIds capability");return s.queryObjectIds(Lc.from(e)??t.createQuery(),r)}async function oWe(t,e,r,i){const s=await Ov(t);if(!s.queryFeatureCount)throw new j(i,"Layer source does not support queryFeatureCount capability");return s.queryFeatureCount(Lc.from(e)??t.createQuery(),r)}async function aWe(t,e,r,i){const s=await Ov(t);if(!s.queryExtent)throw new j(i,"Layer source does not support queryExtent capability");return s.queryExtent(Lc.from(e)??t.createQuery(),r)}async function lWe(t,e,r,i){const s=await Ov(t);if(!s.queryRelatedFeatures)throw new j(i,"Layer source does not support queryRelatedFeatures capability");return s.queryRelatedFeatures(_E.from(e),r)}async function cWe(t,e,r,i){const s=await Ov(t);if(!s.queryRelatedFeaturesCount)throw new j(i,"Layer source does not support queryRelatedFeaturesCount capability");return s.queryRelatedFeaturesCount(_E.from(e),r)}async function uWe(t){const e=t.source;if(e!=null&&e.refresh)try{const{dataChanged:r,updates:i}=await e.refresh();if(v(i)&&(t.sourceJSON={...t.sourceJSON,...i},t.read(i,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await Tje(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function hWe(t){const e=new Lc,r=t.get("capabilities.data"),i=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,i&&(e.compactGeometryEnabled=i.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference),r&&(r.supportsZ&&t.returnZ!=null&&(e.returnZ=t.returnZ),r.supportsM&&t.returnM!=null&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:s,timeExtent:n}=t;return e.timeExtent=s!=null&&n!=null?n.offset(-s.value,s.unit):n||null,e.multipatchOption=t.geometryType==="multipatch"?"xyFootprint":null,e}function ebe(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r){for(const i of r)if(i.type==="esriFieldTypeGlobalID")return i.name}}function tbe(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r){for(const i of r)if(i.type==="esriFieldTypeOID")return i.name}}function dWe(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function Ov(t){return(await t.load()).source}async function pWe(t,e){if(!xi||xi.findCredential(t))return;let r;try{const i=await Ppe(t,e);i&&(r=await xi.checkSignInStatus(`${i}/sharing`))}catch{}if(r)try{const i=v(e)?e.signal:null;await xi.getCredential(t,{signal:i})}catch{}}async function fWe(t,e){var s;const r=(s=t.parsedUrl)==null?void 0:s.path;if(!r)return;const i=t.editFieldsInfo;(t.userHasUpdateItemPrivileges||t.userHasFullEditingPrivileges&&t.capabilities.operations.supportsEditing||i!=null&&i.creatorField||i!=null&&i.editorField)&&await pWe(r,e)}function mWe(t){var e;return!((e=t.sourceJSON)!=null&&e.isMultiServicesView)&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}let o2=class extends bs(fe){constructor(e){super(e),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],o2.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],o2.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:t=>uIe.read(t)||hIe.read(t)}})],o2.prototype,"units",void 0),o2=u([P("esri.layers.support.GeometryFieldsInfo")],o2);const gWe=o2;var pj;let a2=pj=class extends fe{constructor(t){super(t),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new ft}clone(){return new pj({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],a2.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],a2.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],a2.prototype,"viewAllLevelIds",void 0),a2=pj=u([P("esri.layers.support.LayerFloorInfo")],a2);const yWe=a2,Vie=new Vr({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),kie=new Vr({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let dh=class extends bs(fe){constructor(e){super(e),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:Vie.read,write:Vie.write}})],dh.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],dh.prototype,"relationshipTableId",void 0),u([d({json:{read:kie.read,write:kie.write}})],dh.prototype,"role",void 0),dh=u([P("esri.layers.support.Relationship")],dh);const _We=dh,vWe={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function Jt(t,e,r){return!!(t&&t.hasOwnProperty(e)?t[e]:r)}function vI(t,e,r){return t&&t.hasOwnProperty(e)?t[e]:r}function bWe(t){var r;const e=(r=t==null?void 0:t.supportedSpatialAggregationStatistics)==null?void 0:r.map(i=>i.toLowerCase());return{envelope:!!(e!=null&&e.includes("envelopeaggregate")),centroid:!!(e!=null&&e.includes("centroidaggregate")),convexHull:!!(e!=null&&e.includes("convexhullaggregate"))}}function JM(t,e){var i;const r=(i=t==null?void 0:t.supportedOperationsWithCacheHint)==null?void 0:i.map(s=>s.toLowerCase());return!!(r!=null&&r.includes(e.toLowerCase()))}function rbe(t,e){return{analytics:wWe(t),attachment:xWe(t),data:TWe(t),metadata:SWe(t),operations:EWe(t.capabilities,t,e),query:CWe(t,e),queryRelated:AWe(t),queryTopFeatures:RWe(t),editing:OWe(t)}}function wWe(t){return{supportsCacheHint:JM(t.advancedQueryCapabilities,"queryAnalytics")}}function xWe(t){const e=t.attachmentProperties,r={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:JM(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:Jt(t,"supportsAttachmentsResizing",!1)};return e&&Array.isArray(e)&&e.forEach(i=>{const s=vWe[i.name];s&&(r[s]=!!i.isEnabled)}),r}function TWe(t){return{isVersioned:Jt(t,"isDataVersioned",!1),supportsAttachment:Jt(t,"hasAttachments",!1),supportsM:Jt(t,"hasM",!1),supportsZ:Jt(t,"hasZ",!1)}}function SWe(t){return{supportsAdvancedFieldProperties:Jt(t,"supportsFieldDescriptionProperty",!1)}}function EWe(t,e,r){const i=t?t.toLowerCase().split(",").map(f=>f.trim()):[],s=r?HE(r):null,n=i.includes(v(s)&&s.serverType==="MapServer"?"data":"query"),o=i.includes("editing")&&!e.datesInUnknownTimezone;let a=o&&i.includes("create"),l=o&&i.includes("delete"),c=o&&i.includes("update");const h=i.includes("changetracking"),p=e.advancedQueryCapabilities;return o&&!(a||l||c)&&(a=l=c=!0),{supportsCalculate:Jt(e,"supportsCalculate",!1),supportsTruncate:Jt(e,"supportsTruncate",!1),supportsValidateSql:Jt(e,"supportsValidateSql",!1),supportsAdd:a,supportsDelete:l,supportsEditing:o,supportsChangeTracking:h,supportsQuery:n,supportsQueryAnalytics:Jt(p,"supportsQueryAnalytic",!1),supportsQueryAttachments:Jt(p,"supportsQueryAttachments",!1),supportsQueryTopFeatures:Jt(p,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:Jt(e,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:c,supportsExceedsLimitStatistics:Jt(e,"supportsExceedsLimitStatistics",!1)}}function CWe(t,e){const r=t.advancedQueryCapabilities,i=t.ownershipBasedAccessControlForFeatures,s=t.archivingInfo,n=t.currentVersion,o=e==null?void 0:e.includes("MapServer"),a=!o||n>=de("mapserver-pbf-version-support"),l=lme(e),c=new Set((t.supportedQueryFormats??"").split(",").map(h=>h.toLowerCase().trim()));return{supportsStatistics:Jt(r,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:Jt(r,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:Jt(r,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:bWe(r),supportsCentroid:Jt(r,"supportsReturningGeometryCentroid",!1),supportsDistance:Jt(r,"supportsQueryWithDistance",!1),supportsDistinct:Jt(r,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:Jt(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:Jt(r,"supportsReturningGeometryProperties",!1),supportsHavingClause:Jt(r,"supportsHavingClause",!1),supportsOrderBy:Jt(r,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:Jt(r,"supportsPagination",!1),supportsQuantization:Jt(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:Jt(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:Jt(t,"supportsReturningQueryGeometry",!1),supportsResultType:Jt(r,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:Jt(r,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:Jt(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:Jt(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:Jt(r,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:Jt(i,"allowOthersToQuery",!0),supportsHistoricMoment:Jt(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:a&&c.has("pbf"),supportsDisjointSpatialRelationship:Jt(r,"supportsDisjointSpatialRel",!1),supportsCacheHint:Jt(r,"supportsQueryWithCacheHint",!1)||JM(r,"query"),supportsDefaultSpatialReference:Jt(r,"supportsDefaultSR",!1),supportsCompactGeometry:l,supportsFullTextSearch:Jt(r,"supportsFullTextSearch",!1),maxRecordCountFactor:vI(t,"maxRecordCountFactor",void 0),maxRecordCount:vI(t,"maxRecordCount",void 0),standardMaxRecordCount:vI(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:vI(t,"tileMaxRecordCount",void 0)}}function AWe(t){const e=t.advancedQueryCapabilities,r=Jt(e,"supportsAdvancedQueryRelated",!1);return{supportsPagination:Jt(e,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r,supportsCacheHint:JM(e,"queryRelated")}}function RWe(t){return{supportsCacheHint:JM(t.advancedQueryCapabilities,"queryTopFilter")}}function OWe(t){const e=t.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:Jt(t,"allowGeometryUpdates",!0),supportsGlobalId:Jt(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:Jt(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:Jt(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:Jt(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:Jt(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:Jt(e,"allowAnonymousToDelete",!0),supportsDeleteByOthers:Jt(e,"allowOthersToDelete",!0),supportsUpdateByAnonymous:Jt(e,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:Jt(e,"allowOthersToUpdate",!0)}}const MWe=t=>{let e=class extends t{constructor(){super(...arguments),this.capabilities=null,this.copyright=null,this.dateFieldsTimeReference=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.floorInfo=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.isTable=!1,this.layerId=void 0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.preferredTimeReference=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.serviceDefinitionExpression=null,this.serviceItemId=null,this.spatialReference=We.WGS84,this.subtypeField=null,this.trackIdField=null,this.indexes=new(ft.ofType(Pf)),this.version=void 0}readCapabilitiesFromService(r,i){return rbe(i,this.url)}get effectiveCapabilities(){var o;const r=this.capabilities;if(!r)return null;const i=te(r),{operations:s,editing:n}=i;return(o=this.sourceJSON)!=null&&o.isMultiServicesView?(this.userHasUpdateItemPrivileges&&(s.supportsQuery=!0),i):this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=n.supportsDeleteByOthers=n.supportsGeometryUpdate=n.supportsUpdateByOthers=!0,i):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=n.supportsGeometryUpdate=!0),i)}readEditingInfo(r,i){const{editingInfo:s}=i;return s?{lastEditDate:s.lastEditDate!=null?new Date(s.lastEditDate):null}:null}readIsTableFromService(r,i){return i.type==="Table"}readMinScale(r,i){return i.effectiveMinScale||r||0}readMaxScale(r,i){return i.effectiveMaxScale||r||0}readGlobalIdFieldFromService(r,i){return ebe(i)}readObjectIdFieldFromService(r,i){return tbe(i)}readServiceDefinitionExpression(r,i){return i.definitionQuery||i.definitionExpression}set url(r){const i=lNe({layer:this,url:r,nonStandardUrlAllowed:!0,logger:se.getLogger(this.declaredClass)});this._set("url",i.url),i.layerId!=null&&this._set("layerId",i.layerId)}writeUrl(r,i,s,n){cNe(this,r,null,i,n)}readVersion(r,i){return dWe(i)}};return u([d({readOnly:!0,json:{read:!1,origins:{service:{read:{source:["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"]}}}}})],e.prototype,"capabilities",void 0),u([Le("service","capabilities")],e.prototype,"readCapabilitiesFromService",null),u([d({readOnly:!0})],e.prototype,"effectiveCapabilities",null),u([d({type:String,json:{origins:{service:{read:{source:"copyrightText"}}}}})],e.prototype,"copyright",void 0),u([d({type:xE})],e.prototype,"dateFieldsTimeReference",void 0),u([d({type:Boolean})],e.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{origins:{service:{read:{source:"displayField"}}}}})],e.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],e.prototype,"definitionExpression",void 0),u([d({readOnly:!0,type:Kqe})],e.prototype,"editFieldsInfo",void 0),u([d({readOnly:!0})],e.prototype,"editingInfo",void 0),u([Le("editingInfo")],e.prototype,"readEditingInfo",null),u([d((()=>{const r=te(YFe),i=r.json.origins;return i["web-map"]={read:!1,write:!1},i["portal-item"]={read:!1,write:!1},r})())],e.prototype,"elevationInfo",void 0),u([d({type:yWe,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],e.prototype,"floorInfo",void 0),u([d({type:Hr,json:{origins:{service:{read:{source:"extent"}}}}})],e.prototype,"fullExtent",void 0),u([d()],e.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:gWe,json:{read:{source:"geometryProperties"}}})],e.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:dj.read}}}})],e.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}}}})],e.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}}}})],e.prototype,"hasZ",void 0),u([d({readOnly:!0,type:Tv})],e.prototype,"heightModelInfo",void 0),u([d({type:Date})],e.prototype,"historicMoment",void 0),u([d({readOnly:!0})],e.prototype,"isTable",void 0),u([Le("service","isTable",["type"])],e.prototype,"readIsTableFromService",null),u([d({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{read:!1,write:{target:"id"}}},read:!1}})],e.prototype,"layerId",void 0),u([d(KFe)],e.prototype,"minScale",void 0),u([Le("service","minScale",["minScale","effectiveMinScale"])],e.prototype,"readMinScale",null),u([d(QFe)],e.prototype,"maxScale",void 0),u([Le("service","maxScale",["maxScale","effectiveMaxScale"])],e.prototype,"readMaxScale",null),u([d({type:String})],e.prototype,"globalIdField",void 0),u([Le("service","globalIdField",["globalIdField","fields"])],e.prototype,"readGlobalIdFieldFromService",null),u([d({type:String})],e.prototype,"objectIdField",void 0),u([Le("service","objectIdField",["objectIdField","fields"])],e.prototype,"readObjectIdFieldFromService",null),u([d({type:xE})],e.prototype,"preferredTimeReference",void 0),u([d({type:[_We],readOnly:!0})],e.prototype,"relationships",void 0),u([d()],e.prototype,"sourceJSON",void 0),u([d({type:Boolean})],e.prototype,"returnM",void 0),u([d({type:Boolean})],e.prototype,"returnZ",void 0),u([d({readOnly:!0})],e.prototype,"serviceDefinitionExpression",void 0),u([Le("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],e.prototype,"readServiceDefinitionExpression",null),u([d({type:String,readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"serviceItemId",void 0),u([d({type:We,json:{origins:{service:{read:{source:"extent.spatialReference"}}}}})],e.prototype,"spatialReference",void 0),u([d({type:String,readOnly:!0,json:{origins:{service:{read:!0}}}})],e.prototype,"subtypeField",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],e.prototype,"trackIdField",void 0),u([d({readOnly:!0,json:{write:!1}})],e.prototype,"serverGens",void 0),u([d({type:ft.ofType(Pf),readOnly:!0})],e.prototype,"indexes",void 0),u([d(WFe)],e.prototype,"url",null),u([ke("url")],e.prototype,"writeUrl",null),u([d({json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"version",void 0),u([Le("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],e.prototype,"readVersion",null),e=u([P("esri.layers.mixins.FeatureLayerBase")],e),e};let l2=class extends bs(fe){constructor(e){super(e),this.expression=null,this.title=null,this.returnType=null}};u([d({type:String,json:{write:!0}})],l2.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],l2.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],l2.prototype,"returnType",void 0),l2=u([P("esri.layers.support.ExpressionInfo")],l2);const _Z=l2;var fj;let mg=fj=class extends fe{constructor(t){super(t),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new fj({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:te(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};u([d({type:Boolean,json:{write:!0}})],mg.prototype,"isAutoGenerated",void 0),u([d({type:String,json:{write:!0}})],mg.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],mg.prototype,"alias",void 0),u([d({type:String,json:{write:!0}})],mg.prototype,"onStatisticField",void 0),u([d({type:_Z,json:{write:!0}})],mg.prototype,"onStatisticExpression",void 0),u([d({type:String,json:{write:!0}})],mg.prototype,"statisticType",void 0),mg=fj=u([P("esri.layers.support.AggregateField")],mg);const Fw=mg;let G_=class extends fe{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster","binning"],readOnly:!0,json:{read:!1,write:!0}})],G_.prototype,"type",void 0),G_=u([P("esri.layers.support.FeatureReduction")],G_);const vZ="__begin__",bZ="__end__",PWe=new RegExp(vZ,"ig"),IWe=new RegExp(bZ,"ig"),zie=new RegExp("^"+vZ,"i"),Bie=new RegExp(bZ+"$","i"),BF='"',$We=BF+" + ",LWe=" + "+BF;function DWe(t){return t.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")}function NWe(t){return t.replace(new RegExp("\\{","g"),"[").replace(new RegExp("\\}","g"),"]")}function i6(t){const e={expression:"",type:"none"};return t.labelExpressionInfo?t.labelExpressionInfo.value?(e.expression=t.labelExpressionInfo.value,e.type="conventional"):t.labelExpressionInfo.expression&&(e.expression=t.labelExpressionInfo.expression,e.type="arcade"):t.labelExpression!=null&&(e.expression=DWe(t.labelExpression),e.type="conventional"),e}function FWe(t){const e=i6(t);if(!e)return null;switch(e.type){case"conventional":return mj(e.expression);case"arcade":return e.expression}return null}function UWe(t){const e=i6(t);if(!e)return null;switch(e.type){case"conventional":return kWe(e.expression);case"arcade":return wZ(e.expression)}return null}function mj(t){let e;return t?(e=om(t,r=>vZ+'$feature["'+r+'"]'+bZ),e=zie.test(e)?e.replace(zie,""):BF+e,e=Bie.test(e)?e.replace(Bie,""):e+BF,e=e.replace(PWe,$We).replace(IWe,LWe)):e='""',e}const VWe=/^\s*\{([^}]+)\}\s*$/i;function kWe(t){const e=t==null?void 0:t.match(VWe);return e&&e[1].trim()||null}const zWe=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,BWe=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,GWe=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function wZ(t){if(!t)return null;let e=zWe.exec(t)||BWe.exec(t);return e?e[1]||e[3]:(e=GWe.exec(t),e?e[2]:null)}var gj;let B0=gj=class extends fe{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(t,e){return e.value?mj(e.value):t}writeExpression(t,e,r){this.value!=null&&(t=mj(this.value)),t!=null&&(e[r]=t)}clone(){return new gj({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],B0.prototype,"expression",void 0),u([Le("expression",["expression","value"])],B0.prototype,"readExpression",null),u([ke("expression")],B0.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],B0.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],B0.prototype,"value",void 0),B0=gj=u([P("esri.layers.support.LabelExpressionInfo")],B0);const ibe=B0,sbe=[252,146,31,255],_Rt=[153,153,153,255],jWe={type:"esriSMS",style:"esriSMSCircle",size:6,color:sbe,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},HWe={type:"esriSLS",style:"esriSLSSolid",width:.75,color:sbe},qWe={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},WWe={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},XWe={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},YWe={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},ZWe={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},vRt=Av.fromJSON(jWe),bRt=rd.fromJSON(HWe),wRt=Cv.fromJSON(qWe),JWe=YE.fromJSON(WWe);Av.fromJSON(XWe);rd.fromJSON(YWe);Cv.fromJSON(ZWe);var yj;const bI=new Vr({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function wI(t,e,r){return{enabled:!Ope(r==null?void 0:r.layer)}}function nbe(t){var e;return!t||t.origin!=="service"&&((e=t.layer)==null?void 0:e.type)!=="map-image"}function KWe(t){return(t==null?void 0:t.type)==="map-image"}function obe(t){var e,r;return!!KWe(t)&&!!((r=(e=t.capabilities)==null?void 0:e.exportMap)!=null&&r.supportsArcadeExpressionForLabeling)}function QWe(t){return nbe(t)||obe(t==null?void 0:t.layer)}let hn=yj=class extends fe{static evaluateWhere(t,e){const r=(i,s,n)=>{switch(s){case"=":return i==n;case"<>":return i!=n;case">":return i>n;case">=":return i>=n;case"<":return i<n;case"<=":return i<=n}return!1};try{if(t==null)return!0;const i=t.split(" ");if(i.length===3)return r(e[i[0]],i[1],i[2]);if(i.length===7){const s=r(e[i[0]],i[1],i[2]),n=i[3],o=r(e[i[4]],i[5],i[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+t)}}constructor(t){super(t),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=JWe,this.useCodedValues=void 0,this.where=null}readLabelExpression(t,e){const r=e.labelExpressionInfo;if(!r||!r.value&&!r.expression)return t}writeLabelExpression(t,e,r){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)t=NWe(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const i=wZ(this.labelExpressionInfo.expression);i&&(t="["+i+"]")}}t!=null&&(e[r]=t)}writeLabelExpressionInfo(t,e,r,i){if(t==null&&this.labelExpression!=null&&nbe(i))t=new ibe({expression:this.getLabelExpressionArcade()});else if(!t)return;const s=t.toJSON(i);s.expression&&(e[r]=s)}writeMaxScale(t,e){(t||this.minScale)&&(e.maxScale=t)}writeMinScale(t,e){(t||this.maxScale)&&(e.minScale=t)}getLabelExpression(){return i6(this)}getLabelExpressionArcade(){return FWe(this)}getLabelExpressionSingleField(){return UWe(this)}hash(){return JSON.stringify(this)}clone(){return new yj({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:te(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:te(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],hn.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1},"portal-item":{default:!1,write:{overridePolicy:wI}}}}})],hn.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1},"portal-item":{default:"static",write:{overridePolicy:wI}}}}})],hn.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(t,e,r){return this.labelExpressionInfo&&(r==null?void 0:r.origin)==="service"&&obe(r.layer)?{enabled:!1}:{allowNull:!0}}}}})],hn.prototype,"labelExpression",void 0),u([Le("labelExpression")],hn.prototype,"readLabelExpression",null),u([ke("labelExpression")],hn.prototype,"writeLabelExpression",null),u([d({type:ibe,json:{write:{overridePolicy:(t,e,r)=>QWe(r)?{allowNull:!0}:{enabled:!1}}}})],hn.prototype,"labelExpressionInfo",void 0),u([ke("labelExpressionInfo")],hn.prototype,"writeLabelExpressionInfo",null),u([d({type:bI.apiValues,json:{type:bI.jsonValues,read:bI.read,write:bI.write}})],hn.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],hn.prototype,"labelPosition",void 0),u([d({type:Number})],hn.prototype,"maxScale",void 0),u([ke("maxScale")],hn.prototype,"writeMaxScale",null),u([d({type:Number})],hn.prototype,"minScale",void 0),u([ke("minScale")],hn.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:{overridePolicy:wI}}}}})],hn.prototype,"repeatLabel",void 0),u([d({type:Number,cast:hi,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:{overridePolicy:wI}}}}})],hn.prototype,"repeatLabelDistance",void 0),u([d({types:u5e,json:{origins:{"web-scene":{types:h5e,write:Hre,default:null}},write:Hre,default:null}})],hn.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],hn.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],hn.prototype,"where",void 0),hn=yj=u([P("esri.layers.support.LabelClass")],hn);const s6=hn;var _j;const M8=wv({types:T5}),eXe="esri.layers.support.FeatureReductionBinning";let Sl=_j=class extends G_{constructor(t){super(t),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(t,e,r){const i=t.filter(s=>s.statisticType!=="avg_angle").map(s=>s.toJSON());sl(r,i,e)}readRenderer(t,e,r){var s;const i=(s=e.drawingInfo)==null?void 0:s.renderer;return i?FF(i,e,r)??void 0:e.defaultSymbol?e.types&&e.types.length?new qM({defaultSymbol:M8(e.defaultSymbol,e,r),field:e.typeIdField,uniqueValueInfos:e.types.map(n=>({id:n.id,symbol:M8(n.symbol,n,r)}))}):new vE({symbol:M8(e.defaultSymbol,e,r)}):null}clone(){return new _j({fields:te(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:te(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:te(this.popupTemplate),renderer:te(this.renderer)})}};u([mt({binning:"binning"})],Sl.prototype,"type",void 0),u([mt({geohash:"geohash"})],Sl.prototype,"binType",void 0),u([d({type:Number,range:{min:1,max:9},json:{write:!0}})],Sl.prototype,"fixedBinLevel",void 0),u([d({type:[s6],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],Sl.prototype,"labelingInfo",void 0),u([d(LX)],Sl.prototype,"labelsVisible",void 0),u([d({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],Sl.prototype,"maxScale",void 0),u([d($X)],Sl.prototype,"popupEnabled",void 0),u([d({type:$M,json:{name:"popupInfo",write:!0}})],Sl.prototype,"popupTemplate",void 0),u([d({type:[Fw],json:{write:!0}})],Sl.prototype,"fields",void 0),u([ke("fields")],Sl.prototype,"writeFields",null),u([d({types:K5,json:{write:{target:"drawingInfo.renderer"}}})],Sl.prototype,"renderer",void 0),u([Le("renderer",["drawingInfo.renderer"])],Sl.prototype,"readRenderer",null),Sl=_j=u([P(eXe)],Sl);const abe=Sl;var vj;const P8=wv({types:T5}),tXe="esri.layers.support.FeatureReductionCluster";function Gie(t){var e;return t.type==="simple"&&!((e=t.visualVariables)!=null&&e.length)}let Wn=vj=class extends fe{constructor(t){super(t),this.type="cluster",this.clusterRadius=hi("80px"),this.clusterMinSize=hi("12px"),this.clusterMaxSize=hi("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}readRenderer(t,e,r){var s,n;const i=(s=e.drawingInfo)==null?void 0:s.renderer;return(n=i==null?void 0:i.authoringInfo)!=null&&n.isAutoGenerated?null:i?Gie(i)?null:FF(i,e,r)??void 0:e.defaultSymbol?e.types&&e.types.length?new qM({defaultSymbol:P8(e.defaultSymbol,e,r),field:e.typeIdField,uniqueValueInfos:e.types.map(o=>({id:o.id,symbol:P8(o.symbol,o,r)}))}):new vE({symbol:P8(e.defaultSymbol,e,r)}):null}readSymbol(t,e,r){var s,n,o;const i=(s=e.drawingInfo)==null?void 0:s.renderer;return(n=i==null?void 0:i.authoringInfo)!=null&&n.isAutoGenerated?null:i&&Gie(i)?(o=FF(i,e,r))==null?void 0:o.symbol:null}writeSymbol(t,e,r,i){var n,o;const s=(o=(n=this.renderer)==null?void 0:n.authoringInfo)==null?void 0:o.isAutoGenerated;if(!this.renderer||s){const a=new vE({symbol:t});e.drawingInfo={renderer:a.write({},i)}}}writeFields(t,e,r){const i=t.filter(s=>s.statisticType!=="avg_angle").map(s=>s.toJSON());sl(r,i,e)}readFields(t,e,r){return t.filter(i=>!i.isAutoGenerated).map(i=>Fw.fromJSON(i))}clone(){return new vj({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:te(this.labelingInfo),labelsVisible:this.labelsVisible,fields:te(this.fields),maxScale:this.maxScale,renderer:te(this.renderer),symbol:te(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:te(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],Wn.prototype,"type",void 0),u([d({type:Number,cast:t=>t==="auto"?t:hi(t),json:{write:!0}})],Wn.prototype,"clusterRadius",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Wn.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:hi,json:{write:!0}})],Wn.prototype,"clusterMaxSize",void 0),u([d({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],Wn.prototype,"maxScale",void 0),u([d($X)],Wn.prototype,"popupEnabled",void 0),u([d({type:$M,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],Wn.prototype,"popupTemplate",void 0),u([d({types:K5,json:{write:{target:"drawingInfo.renderer"}}})],Wn.prototype,"renderer",void 0),u([Le("renderer",["drawingInfo.renderer"])],Wn.prototype,"readRenderer",null),u([d({types:l5e})],Wn.prototype,"symbol",void 0),u([Le("symbol",["drawingInfo.renderer"])],Wn.prototype,"readSymbol",null),u([ke("symbol")],Wn.prototype,"writeSymbol",null),u([d({type:[s6],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],Wn.prototype,"labelingInfo",void 0),u([d(LX)],Wn.prototype,"labelsVisible",void 0),u([d({type:[Fw],json:{write:!0}})],Wn.prototype,"fields",void 0),u([ke("fields")],Wn.prototype,"writeFields",null),u([Le("fields")],Wn.prototype,"readFields",null),Wn=vj=u([P(tXe)],Wn);const lbe=Wn;var bj;let ID=bj=class extends G_{constructor(t){super(t),this.type="selection"}clone(){return new bj}};u([d({type:["selection"]})],ID.prototype,"type",void 0),ID=bj=u([P("esri.layers.support.FeatureReductionSelection")],ID);const jie=ID,Hie={key:"type",base:G_,typeMap:{cluster:lbe,binning:abe}},rXe={types:{key:"type",base:G_,typeMap:{selection:jie,cluster:lbe,binning:abe}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:Hie},"portal-item":{types:Hie},"web-scene":{types:{key:"type",base:G_,typeMap:{selection:jie}}}}}},Ox={Base64:0,Hex:1,String:2,Raw:3},vS=8,cbe=(1<<vS)-1;function D_(t,e){const r=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(r>>16)<<16|65535&r}function iXe(t){const e=[];for(let r=0,i=t.length*vS;r<i;r+=vS)e[r>>5]|=(t.charCodeAt(r/vS)&cbe)<<r%32;return e}function sXe(t){const e=[];for(let r=0,i=32*t.length;r<i;r+=vS)e.push(String.fromCharCode(t[r>>5]>>>r%32&cbe));return e.join("")}function nXe(t){const e="0123456789abcdef",r=[];for(let i=0,s=4*t.length;i<s;i++)r.push(e.charAt(t[i>>2]>>i%4*8+4&15)+e.charAt(t[i>>2]>>i%4*8&15));return r.join("")}function oXe(t){const e="=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[];for(let s=0,n=4*t.length;s<n;s+=3){const o=(t[s>>2]>>s%4*8&255)<<16|(t[s+1>>2]>>(s+1)%4*8&255)<<8|t[s+2>>2]>>(s+2)%4*8&255;for(let a=0;a<4;a++)8*s+6*a>32*t.length?i.push(e):i.push(r.charAt(o>>6*(3-a)&63))}return i.join("")}function aXe(t,e){return t<<e|t>>>32-e}function n6(t,e,r,i,s,n){return D_(aXe(D_(D_(e,t),D_(i,n)),s),r)}function $a(t,e,r,i,s,n,o){return n6(e&r|~e&i,t,e,s,n,o)}function La(t,e,r,i,s,n,o){return n6(e&i|r&~i,t,e,s,n,o)}function Da(t,e,r,i,s,n,o){return n6(e^r^i,t,e,s,n,o)}function Na(t,e,r,i,s,n,o){return n6(r^(e|~i),t,e,s,n,o)}function lXe(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;let r=1732584193,i=-271733879,s=-1732584194,n=271733878;for(let o=0;o<t.length;o+=16){const a=r,l=i,c=s,h=n;r=$a(r,i,s,n,t[o+0],7,-680876936),n=$a(n,r,i,s,t[o+1],12,-389564586),s=$a(s,n,r,i,t[o+2],17,606105819),i=$a(i,s,n,r,t[o+3],22,-1044525330),r=$a(r,i,s,n,t[o+4],7,-176418897),n=$a(n,r,i,s,t[o+5],12,1200080426),s=$a(s,n,r,i,t[o+6],17,-1473231341),i=$a(i,s,n,r,t[o+7],22,-45705983),r=$a(r,i,s,n,t[o+8],7,1770035416),n=$a(n,r,i,s,t[o+9],12,-1958414417),s=$a(s,n,r,i,t[o+10],17,-42063),i=$a(i,s,n,r,t[o+11],22,-1990404162),r=$a(r,i,s,n,t[o+12],7,1804603682),n=$a(n,r,i,s,t[o+13],12,-40341101),s=$a(s,n,r,i,t[o+14],17,-1502002290),i=$a(i,s,n,r,t[o+15],22,1236535329),r=La(r,i,s,n,t[o+1],5,-165796510),n=La(n,r,i,s,t[o+6],9,-1069501632),s=La(s,n,r,i,t[o+11],14,643717713),i=La(i,s,n,r,t[o+0],20,-373897302),r=La(r,i,s,n,t[o+5],5,-701558691),n=La(n,r,i,s,t[o+10],9,38016083),s=La(s,n,r,i,t[o+15],14,-660478335),i=La(i,s,n,r,t[o+4],20,-405537848),r=La(r,i,s,n,t[o+9],5,568446438),n=La(n,r,i,s,t[o+14],9,-1019803690),s=La(s,n,r,i,t[o+3],14,-187363961),i=La(i,s,n,r,t[o+8],20,1163531501),r=La(r,i,s,n,t[o+13],5,-1444681467),n=La(n,r,i,s,t[o+2],9,-51403784),s=La(s,n,r,i,t[o+7],14,1735328473),i=La(i,s,n,r,t[o+12],20,-1926607734),r=Da(r,i,s,n,t[o+5],4,-378558),n=Da(n,r,i,s,t[o+8],11,-2022574463),s=Da(s,n,r,i,t[o+11],16,1839030562),i=Da(i,s,n,r,t[o+14],23,-35309556),r=Da(r,i,s,n,t[o+1],4,-1530992060),n=Da(n,r,i,s,t[o+4],11,1272893353),s=Da(s,n,r,i,t[o+7],16,-155497632),i=Da(i,s,n,r,t[o+10],23,-1094730640),r=Da(r,i,s,n,t[o+13],4,681279174),n=Da(n,r,i,s,t[o+0],11,-358537222),s=Da(s,n,r,i,t[o+3],16,-722521979),i=Da(i,s,n,r,t[o+6],23,76029189),r=Da(r,i,s,n,t[o+9],4,-640364487),n=Da(n,r,i,s,t[o+12],11,-421815835),s=Da(s,n,r,i,t[o+15],16,530742520),i=Da(i,s,n,r,t[o+2],23,-995338651),r=Na(r,i,s,n,t[o+0],6,-198630844),n=Na(n,r,i,s,t[o+7],10,1126891415),s=Na(s,n,r,i,t[o+14],15,-1416354905),i=Na(i,s,n,r,t[o+5],21,-57434055),r=Na(r,i,s,n,t[o+12],6,1700485571),n=Na(n,r,i,s,t[o+3],10,-1894986606),s=Na(s,n,r,i,t[o+10],15,-1051523),i=Na(i,s,n,r,t[o+1],21,-2054922799),r=Na(r,i,s,n,t[o+8],6,1873313359),n=Na(n,r,i,s,t[o+15],10,-30611744),s=Na(s,n,r,i,t[o+6],15,-1560198380),i=Na(i,s,n,r,t[o+13],21,1309151649),r=Na(r,i,s,n,t[o+4],6,-145523070),n=Na(n,r,i,s,t[o+11],10,-1120210379),s=Na(s,n,r,i,t[o+2],15,718787259),i=Na(i,s,n,r,t[o+9],21,-343485551),r=D_(r,a),i=D_(i,l),s=D_(s,c),n=D_(n,h)}return[r,i,s,n]}function ube(t,e=Ox.Hex){const r=e||Ox.Base64,i=lXe(iXe(t),t.length*vS);switch(r){case Ox.Raw:return i;case Ox.Hex:return nXe(i);case Ox.String:return sXe(i);case Ox.Base64:return oXe(i)}}var wj;let ER=wj=class extends J5{writeLevels(t,e,r){for(const i in t){const s=this.levels[i];return void(e.stops=s)}}clone(){return new wj({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:L_(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:L_(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:te(this.levels)})}};u([d()],ER.prototype,"levels",void 0),u([ke("levels")],ER.prototype,"writeLevels",null),ER=wj=u([P("esri.views.2d.engine.LevelDependentSizeVariable")],ER);const cXe=se.getLogger("esri.views.2d.layers.support.clusterUtils");de.add("esri-cluster-arcade-enabled",!0);const uXe=de("esri-cluster-arcade-enabled"),hXe=(t,e,r,i,s)=>{const n=e.clone();if(!mXe(n))return n;if(n.authoringInfo||(n.authoringInfo=new iZ),n.authoringInfo.isAutoGenerated=!0,"visualVariables"in n){const o=(n.visualVariables||[]).filter(l=>l.valueExpression!=="$view.scale"),a=dXe(o);o.forEach(l=>{l.type==="rotation"?l.field?l.field=Gv(t,l.field,"avg_angle","number"):l.valueExpression&&(l.field=GC(t,l.valueExpression,"avg_angle","number"),l.valueExpression=null):l.normalizationField?(l.field=Gv(t,l.field,"avg_norm","number",l.normalizationField),l.normalizationField=null):l.field?l.field=Gv(t,l.field,"avg","number"):l.valueExpression&&(l.field=GC(t,l.valueExpression,"avg","number"),l.valueExpression=null)}),C(a)&&!pXe(o)&&s&&(o.push(fXe(r,i)),n.dynamicClusterSize=!0),n.visualVariables=o}switch(n.type){case"simple":break;case"pie-chart":for(const o of n.attributes)o.field?o.field=Gv(t,o.field,"sum","number"):o.valueExpression&&(o.field=GC(t,o.valueExpression,"sum","number"),o.valueExpression=null);break;case"unique-value":n.field?n.field=Gv(t,n.field,"mode","string"):n.valueExpression&&(n.field=GC(t,n.valueExpression,"mode","string"),n.valueExpression=null);break;case"class-breaks":n.normalizationField?(n.field=Gv(t,n.field,"avg_norm","number",n.normalizationField),n.normalizationField=null):n.field?n.field=Gv(t,n.field,"avg","number"):n.valueExpression&&(n.field=GC(t,n.valueExpression,"avg","number"),n.valueExpression=null)}return n},dXe=t=>{for(const e of t)if(e.type==="size")return e;return null},pXe=t=>{for(const e of t)if(e.field==="cluster_count")return!0;return!1},fXe=(t,e)=>{const r=[new e2({value:0,size:0}),new e2({value:1})];if(C(e))return new J5({field:"cluster_count",stops:[...r,new e2({value:2,size:0})]});const i=Object.keys(e).reduce((s,n)=>({...s,[n]:[...r,new e2({value:Math.max(2,e[n].minValue),size:t.clusterMinSize}),new e2({value:Math.max(3,e[n].maxValue),size:t.clusterMaxSize})]}),{});return new ER({field:"cluster_count",levels:i})},mXe=t=>{const e=r=>cXe.error(new j("Unsupported-renderer",r,{renderer:t}));switch(t.type){case"unique-value":if(t.field2||t.field3)return e("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(t.normalizationField){const r=t.normalizationType;if(r!=="field")return e(`FeatureReductionCluster does not support a normalizationType of ${r}`),!1}break;case"simple":case"pie-chart":break;default:return e(`FeatureReductionCluster does not support renderers of type ${t.type}`),!1}if(!uXe){if("valueExpression"in t&&t.valueExpression)return e("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in t&&t.visualVariables||[]).some(r=>!(!("valueExpression"in r)||!r.valueExpression)))return e("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function gXe(t,e,r){switch(t){case"sum":return`cluster_sum_${e}`;case"avg":case"avg_angle":return`cluster_avg_${e}`;case"mode":return`cluster_type_${e}`;case"avg_norm":{const i=r,s="field",n=e.toLowerCase()+",norm:"+s+","+i.toLowerCase();return"cluster_avg_"+ube(n)}}}function GC(t,e,r,i){const s=ube(e),n=r==="mode"?`cluster_type_${s}`:r==="sum"?`cluster_sum_${s}`:`cluster_avg_${s}`;return t.some(o=>o.name===n)||t.push(new Fw({name:n,isAutoGenerated:!0,onStatisticExpression:new _Z({expression:e,returnType:i}),statisticType:r})),n}function Gv(t,e,r,i,s){if(e==="cluster_count"||t.some(o=>o.name===e))return e;const n=gXe(r,e,s);return t.some(o=>o.name===n)||(r==="avg_norm"?t.push(new Fw({name:n,isAutoGenerated:!0,onStatisticExpression:new _Z({expression:`$feature.${e} / $feature.${s}`,returnType:i}),statisticType:"avg"})):t.push(new Fw({name:n,isAutoGenerated:!0,onStatisticField:e,statisticType:r}))),n}const yXe=t=>{let e=class extends t{constructor(...r){super(...r),this.own(this.watch("renderer",()=>{if(this.featureReduction){const i=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",i)}},!0))}set featureReduction(r){const i=this._normalizeFeatureReduction(r);this._set("featureReduction",i)}set renderer(r){}_normalizeFeatureReduction(r){var a;if((r==null?void 0:r.type)!=="cluster")return r;const i=r.clone(),s=[new Fw({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],n=(i.fields??[]).filter(l=>!l.isAutoGenerated);if(r.renderer&&!((a=r.renderer.authoringInfo)!=null&&a.isAutoGenerated))return i.fields=[...s,...n],i;if(r.symbol)return i.fields=[...s,...n],i.renderer=null,i;if(!this.renderer)return r;const o=hXe(s,this.renderer,r,null,!1);return i.fields=[...s,...n],i.renderer=o,i}};return u([d(rXe)],e.prototype,"featureReduction",null),e=u([P("esri.layers.mixins.FeatureReductionLayer")],e),e};var xj;const I8=new Vr({asc:"ascending",desc:"descending"});let c2=xj=class extends fe{constructor(t){super(t),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new xj({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],c2.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],c2.prototype,"valueExpression",void 0),u([d({type:I8.apiValues,json:{read:I8.read,write:I8.write}})],c2.prototype,"order",void 0),c2=xj=u([P("esri.layers.support.OrderByInfo")],c2);const hbe=c2;function _Xe(t,e,r){if(!t)return null;const i=t.find(n=>!!n.field);if(!i)return null;const s=new hbe;return s.read(i,r),[s]}function vXe(t,e,r,i){const s=t.find(n=>!!n.field);s&&sl(r,[s.toJSON()],e)}const bXe=t=>{let e=class extends t{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[hbe],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:_Xe},write:{target:"layerDefinition.orderBy",writer:vXe}}})],e.prototype,"orderBy",void 0),e=u([P("esri.layers.mixins.OrderedLayer")],e),e};async function wXe(t){const e=t.spatialReference;if(e.isWGS84)return t.clone();if(e.isWebMercator)return L2(t);const r=We.WGS84;return await FDe(e,r),GE(t,r)}function xRt(t,e){if(!xXe(t,e)){const r=t.typeKeywords;r?r.push(e):t.typeKeywords=[e]}}function xXe(t,e){var r;return!!((r=t.typeKeywords)!=null&&r.includes(e))}function TRt(t,e){const r=t.typeKeywords;if(r){const i=r.indexOf(e);i>-1&&r.splice(i,1)}}async function SRt(t){const e=t.clone().normalize();let r;if(e.length>1)for(const i of e)r?i.width>r.width&&(r=i):r=i;else r=e[0];return wXe(r)}const ERt={DEVELOPER_BASEMAP:"DeveloperBasemap",JSAPI:"ArcGIS API for JavaScript",METADATA:"Metadata",MULTI_LAYER:"Multilayer",SINGLE_LAYER:"Singlelayer",TABLE:"Table"};function qie(t){var l;const{portal:e,isOrgItem:r,itemControl:i}=t,s=(l=e.user)==null?void 0:l.privileges;let n=!s||s.includes("features:user:edit"),o=!!r&&!!(s!=null&&s.includes("features:user:fullEdit"));const a=i==="update"||i==="admin";return a?o=n=!0:o&&(n=!0),{features:{edit:n,fullEdit:o},content:{updateItem:a}}}const TXe=t=>{let e=class extends t{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=Ve(this.portalItem)}set portalItem(r){r!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",r))}readPortalItem(r,i,s){if(i.itemId)return new tw({id:i.itemId,portal:s&&s.portal})}writePortalItem(r,i){r&&r.id&&(i.itemId=r.id)}async loadFromPortal(r,i){if(this.portalItem&&this.portalItem.id)try{const s=await ie(()=>import("./layersLoader-9600ea66.js"),["./layersLoader-9600ea66.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url);return ur(i),await s.load({instance:this,supportedTypes:r.supportedTypes,validateItem:r.validateItem,supportsData:r.supportsData,layerModuleTypeMap:r.layerModuleTypeMap},i)}catch(s){throw Ks(s)||se.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(r){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(r).catch(i=>(Sc(i),!0)))}async _setUserPrivileges(r,i){if(!Qr.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(i);if(this.url)try{const{features:{edit:s,fullEdit:n},content:{updateItem:o}}=await this._fetchUserPrivileges(r,i);this._set("userHasEditingPrivileges",s),this._set("userHasFullEditingPrivileges",n),this._set("userHasUpdateItemPrivileges",o)}catch(s){Sc(s)}}async _fetchUserPrivileges(r,i){let s=this.portalItem;if(!r||!s||!s.loaded||s.sourceUrl)return this._fetchFallbackUserPrivileges(i);const n=r===s.id;if(n&&s.portal.user)return qie(s);let o,a;if(n)o=s.portal.url;else try{o=await Ppe(this.url,i)}catch(p){Sc(p)}if(!o||!P3e(o,s.portal.url))return this._fetchFallbackUserPrivileges(i);try{const p=v(i)?i.signal:null;a=await(xi==null?void 0:xi.getCredential(`${o}/sharing`,{prompt:!1,signal:p}))}catch(p){Sc(p)}const l=!0,c=!1,h=!1;if(!a)return{features:{edit:l,fullEdit:c},content:{updateItem:h}};try{if(n?await s.reload():(s=new tw({id:r,portal:{url:o}}),await s.load(i)),s.portal.user)return qie(s)}catch(p){Sc(p)}return{features:{edit:l,fullEdit:c},content:{updateItem:h}}}async _fetchFallbackUserPrivileges(r){let i=!0;try{i=await this._fetchUserHasEditingPrivileges(r)}catch(s){Sc(s)}return{features:{edit:i,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(r){const i=this.url?xi==null?void 0:xi.findCredential(this.url):null;if(!i)return!0;const s=xI.credential===i?xI.user:await this._fetchEditingUser(r);return xI.credential=i,xI.user=s,C(s)||s.privileges==null||s.privileges.includes("features:user:edit")}async _fetchEditingUser(r){var h,p;const i=(p=(h=this.portalItem)==null?void 0:h.portal)==null?void 0:p.user;if(i)return i;const s=xi.findServerInfo(this.url??"");if(!(s!=null&&s.owningSystemUrl))return null;const n=`${s.owningSystemUrl}/sharing/rest`,o=Io.getDefault();if(o&&o.loaded&&Uh(o.restUrl)===Uh(n))return o.user;const a=`${n}/community/self`,l=v(r)?r.signal:null,c=await Uc(Pi(a,{authMode:"no-prompt",query:{f:"json"},signal:l}));return c.ok?GW.fromJSON(c.value.data):null}read(r,i){i&&(i.layer=this),super.read(r,i)}write(r,i){const s=i&&i.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||Io.getDefault());return s&&n&&!Zhe(n.restUrl,s.restUrl)?(i.messages&&i.messages.push(new j("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(r,{...i,layer:this})}};return u([d({type:tw})],e.prototype,"portalItem",null),u([Le("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null),u([ke("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",null),u([d({clonable:!1})],e.prototype,"resourceReferences",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasFullEditingPrivileges",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasUpdateItemPrivileges",void 0),e=u([P("esri.layers.mixins.PortalLayer")],e),e},xI={credential:null,user:null};let CR=class extends Te{constructor(){super(...arguments),this.updating=!1,this.status="unknown"}};u([d()],CR.prototype,"updating",void 0),u([d()],CR.prototype,"status",void 0),CR=u([P("esri.layers.support.PublishingInfo")],CR);const SXe=CR,dbe="esri.layers.mixins.PublishableLayer",EXe=Symbol(dbe),CXe=t=>{var e;let r=class extends t{constructor(){super(...arguments),this[e]=!0}get publishingInfo(){if(this.destroyed)return null;const i=this._get("publishingInfo");if(i)return i;const s=new SXe;return this._checkPublishingStatus(s),s}_checkPublishingStatus(i){let o=0;const a=async c=>{let h;i.updating=!0;try{h=await this.fetchPublishingStatus()}catch{h="unavailable"}h!=="published"&&h!=="unavailable"||(i.status==="publishing"&&this.refresh(),l.remove()),i.status=h,i.updating=!1,l.removed||(o=setTimeout(a,c,c+125))},l={removed:!1,remove(){this.removed=!0,clearTimeout(o)}};this.when().catch(()=>l.remove()),a(250),this.own(l)}};return e=EXe,u([d({readOnly:!0,clonable:!1})],r.prototype,"publishingInfo",null),r=u([P(dbe)],r),r},P3=new ft,MO=new WeakMap;function AXe(t){pbe(t)&&P3.push(t)}function RXe(t){pbe(t)&&P3.includes(t)&&P3.remove(t)}function pbe(t){return t!=null&&typeof t=="object"&&"refreshInterval"in t&&"refresh"in t}function fbe(t,e){return Number.isFinite(t)&&Number.isFinite(e)?e<=0?t:fbe(e,t%e):0}let $8=0,TI=0;function OXe(){const t=Date.now();for(const e of P3)e.refreshInterval&&t-(MO.get(e)??0)+5>=6e4*e.refreshInterval&&(MO.set(e,t),e.refresh(t))}Ede(()=>{const t=Date.now();let e=0;for(const r of P3)e=fbe(Math.round(6e4*r.refreshInterval),e),r.refreshInterval?MO.get(r)||MO.set(r,t):MO.delete(r);if(e!==TI){if(TI=e,clearInterval($8),TI===0)return void($8=0);$8=setInterval(OXe,TI)}});function MXe(t){return t!=null&&typeof t=="object"&&"refreshTimestamp"in t&&"refresh"in t}const PXe=t=>{let e=class extends t{constructor(...r){super(...r),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=vW(()=>this.hasDataChanged()),this.when().then(()=>{AXe(this)},()=>{})}destroy(){RXe(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(r=Date.now()){oS(this._debounceHasDataChanged()).then(i=>{i&&this._set("refreshTimestamp",r),this.emit("refresh",{dataChanged:i})},i=>{se.getLogger(this.declaredClass).error(i),this.emit("refresh",{dataChanged:!1,error:i})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:r=>r>=.1?r:r<=0?0:.1,json:{write:!0}})],e.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],e.prototype,"refreshTimestamp",void 0),u([d()],e.prototype,"refreshParameters",null),e=u([P("esri.layers.mixins.RefreshableLayer")],e),e},IXe=t=>{let e=class extends t{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get effectiveScaleRange(){const r={minScale:this.minScale,maxScale:this.maxScale},i=this.parent;i&&"effectiveScaleRange"in i&&$Xe(r,i.effectiveScaleRange);const s=this._get("effectiveScaleRange");return s&&s.minScale===r.minScale&&s.maxScale===r.maxScale?s:r}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"maxScale",void 0),u([d({readOnly:!0})],e.prototype,"effectiveScaleRange",null),e=u([P("esri.layers.mixins.ScaleRangeLayer")],e),e};function $Xe(t,e){return t.minScale=t.minScale>0?e.minScale>0?Math.min(t.minScale,e.minScale):t.minScale:e.minScale,t.maxScale=t.maxScale>0?e.maxScale>0?Math.max(t.maxScale,e.maxScale):t.maxScale:e.maxScale,t}const mbe=Ra()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});let AR=class extends bs(fe){constructor(e){super(e),this.unit="milliseconds",this.value=0}toMilliseconds(){return sFe(this.value,this.unit,"milliseconds")}};u([mt(mbe,{nonNullable:!0})],AR.prototype,"unit",void 0),u([d({type:Number,json:{write:!0},nonNullable:!0})],AR.prototype,"value",void 0),AR=u([P("esri.TimeInterval")],AR);const GF=AR;function Wie(t,e){return GF.fromJSON({value:t,unit:e})}let Ga=class extends bs(fe){constructor(e){super(e),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(e,r){if(!r.timeExtent||!Array.isArray(r.timeExtent)||r.timeExtent.length!==2)return null;const i=new Date(r.timeExtent[0]),s=new Date(r.timeExtent[1]);return new Sm({start:i,end:s})}writeFullTimeExtent(e,r){e&&v(e.start)&&v(e.end)?r.timeExtent=[e.start.getTime(),e.end.getTime()]:r.timeExtent=null}readInterval(e,r){return r.timeInterval&&r.timeIntervalUnits?Wie(r.timeInterval,r.timeIntervalUnits):r.defaultTimeInterval&&r.defaultTimeIntervalUnits?Wie(r.defaultTimeInterval,r.defaultTimeIntervalUnits):null}writeInterval(e,r){r.timeInterval=(e==null?void 0:e.toJSON().value)??null,r.timeIntervalUnits=(e==null?void 0:e.toJSON().unit)??null}};u([d({type:Boolean,json:{name:"exportOptions.timeDataCumulative",write:!0}})],Ga.prototype,"cumulative",void 0),u([d({type:String,json:{name:"endTimeField",write:{enabled:!0,allowNull:!0}}})],Ga.prototype,"endField",void 0),u([d({type:Sm,json:{write:{enabled:!0,allowNull:!0}}})],Ga.prototype,"fullTimeExtent",void 0),u([Le("fullTimeExtent",["timeExtent"])],Ga.prototype,"readFullTimeExtent",null),u([ke("fullTimeExtent")],Ga.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],Ga.prototype,"hasLiveData",void 0),u([d({type:GF,json:{write:{enabled:!0,allowNull:!0}}})],Ga.prototype,"interval",void 0),u([Le("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],Ga.prototype,"readInterval",null),u([ke("interval")],Ga.prototype,"writeInterval",null),u([d({type:String,json:{name:"startTimeField",write:{enabled:!0,allowNull:!0}}})],Ga.prototype,"startField",void 0),u([d({type:xE,json:{write:{enabled:!0,allowNull:!0}}})],Ga.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],Ga.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{name:"exportOptions.useTime",write:!0}})],Ga.prototype,"useTime",void 0),Ga=u([P("esri.layers.support.TimeInfo")],Ga);const gbe=Ga,LXe=t=>{let e=class extends t{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(r,i){const s=i.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=mbe.fromJSON(s.timeOffsetUnits);return n&&o?new GF({value:n,unit:o}):null}set timeInfo(r){Ome(r,this.fieldsIndex),this._set("timeInfo",r)}};return u([d({type:Sm,json:{write:!1}})],e.prototype,"timeExtent",void 0),u([d({type:GF})],e.prototype,"timeOffset",void 0),u([Le("service","timeOffset",["timeInfo.exportOptions"])],e.prototype,"readOffset",null),u([d({value:null,type:gbe,json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],e.prototype,"useViewTime",void 0),e=u([P("esri.layers.mixins.TemporalLayer")],e),e},Xie=new Vr({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let G0=class extends bs(fe){constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],G0.prototype,"name",void 0),u([d({json:{write:!0}})],G0.prototype,"description",void 0),u([d({json:{read:Xie.read,write:Xie.write}})],G0.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],G0.prototype,"prototype",void 0),u([d({json:{write:!0}})],G0.prototype,"thumbnail",void 0),G0=u([P("esri.layers.support.FeatureTemplate")],G0);const xZ=G0;let gg=class extends bs(fe){constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const r={};for(const i of Object.keys(e))r[i]=WY(e[i]);return r}writeDomains(e,r){var s;const i={};for(const n of Object.keys(e))e[n]&&(i[n]=(s=e[n])==null?void 0:s.toJSON());r.domains=i}};u([d({json:{write:!0}})],gg.prototype,"id",void 0),u([d({json:{write:!0}})],gg.prototype,"name",void 0),u([d({json:{write:!0}})],gg.prototype,"domains",void 0),u([Le("domains")],gg.prototype,"readDomains",null),u([ke("domains")],gg.prototype,"writeDomains",null),u([d({type:[xZ],json:{write:!0}})],gg.prototype,"templates",void 0),gg=u([P("esri.layers.support.FeatureType")],gg);const ybe=gg;function DXe(t){return t.type==="date"||t.type==="esriFieldTypeDate"}function Yie(t){return t.type==="oid"||t.type==="esriFieldTypeOID"}function Zie(t){return t.type==="global-id"||t.type==="esriFieldTypeGlobalID"}let NXe=class{constructor(e=[]){if(this.fields=[],this._fieldsMap=new Map,this._normalizedFieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!e)return;this.fields=e;const r=[];for(const i of e){const s=i==null?void 0:i.name,n=Kie(i==null?void 0:i.name);if(s&&n){const o=Jie(s);this._fieldsMap.set(s,i),this._fieldsMap.set(o,i),this._normalizedFieldsMap.set(n,i),r.push(o),DXe(i)?(this.dateFields.push(i),this._dateFieldsSet.add(i)):h5(i)&&(this._numericFieldsSet.add(i),this.numericFields.push(i)),Yie(i)||Zie(i)||(i.editable=i.editable==null||!!i.editable,i.nullable=i.nullable==null||!!i.nullable)}}r.sort(),this.uid=r.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const e of this.fields)Yie(e)||Zie(e)||e.nullable||AFe(e)!==void 0||this._requiredFields.push(e)}return this._requiredFields}has(e){return this.get(e)!=null}get(e){if(!e)return;let r=this._fieldsMap.get(e);return r||(r=this._fieldsMap.get(Jie(e))??this._normalizedFieldsMap.get(Kie(e)),r&&this._fieldsMap.set(e,r),r)}isDateField(e){return this._dateFieldsSet.has(this.get(e))}isNumericField(e){return this._numericFieldsSet.has(this.get(e))}normalizeFieldName(e){const r=this.get(e);if(r)return r.name??void 0}};function Jie(t){return t.trim().toLowerCase()}function Kie(t){var e;return((e=_Fe(t))==null?void 0:e.toLowerCase())??""}function FXe(){return{fields:{type:[W5],value:null},fieldsIndex:{readOnly:!0,get(){return new NXe(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(t){this._userOutFields=t,this.notifyChange("outFields")},get:function(){var e;const t=this._userOutFields;if(!t||!t.length)return null;if(t.includes("*"))return["*"];if(!this.fields)return t;for(const r of t)((e=this.fieldsIndex)==null?void 0:e.has(r))||se.getLogger("esri.layers.support.fieldProperties").error("field-attributes-layer:invalid-field",`Invalid field ${r} found in outFields`,{layer:this,outFields:t});return Mme(this.fieldsIndex,t)}}}}const L8=se.getLogger("esri.layers.support.labelingInfo"),UXe=/\[([^\[\]]+)\]/gi;function Qie(t,e,r){return t?t.map(i=>{const s=new s6;if(s.read(i,r),s.labelExpression){const n=e.fields||e.layerDefinition&&e.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replace(UXe,(o,a)=>`[${VXe(a,n)}]`)}return s}):null}function VXe(t,e){if(!e)return t;const r=t.toLowerCase();for(let i=0;i<e.length;i++){const s=e[i].name;if(s.toLowerCase()===r)return s}return t}const kXe={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function IRt(t,e){const r=te(t);return r.some(i=>zXe(i,e))?[]:r}function zXe(t,e){const r=t.labelPlacement,i=kXe[e];if(!t.symbol)return L8.warn("No ILabelClass symbol specified."),!0;if(!i)return L8.error(new j("labeling:unsupported-geometry-type",`Unable to create labels for layer, geometry type '${e}' is not supported`)),!0;if(!i.includes(r)){const s=i[0];r&&L8.warn(`Found invalid label placement type ${r} for ${e}. Defaulting to ${s}`),t.labelPlacement=s}return!1}const Ld=[];function BXe(t,e){if(lme(t.url??""))return!0;const{wkid:r}=e;for(const i of Ld){if((t.version??0)>=i[0])return!0;if(typeof i[1]=="function"&&(i[1]=i[1]()),i[1].has(r))return!1}return!0}Ld.push([10.91,()=>{const t=new Set([9709,9716,9741,9761,9766]);for(let e=9712;e<=9713;e++)t.add(e);for(let e=9748;e<=9749;e++)t.add(e);for(let e=20904;e<=20932;e++)t.add(e);for(let e=21004;e<=21032;e++)t.add(e);for(let e=21207;e<=21264;e++)t.add(e);for(let e=21307;e<=21364;e++)t.add(e);for(let e=102759;e<=102760;e++)t.add(e);for(let e=102901;e<=102955;e++)t.add(e);return t}]),Ld.push([10.9,()=>{const t=new Set([9300,9354,9364,9367,9373,9377,9387,9456,9473,9498,9678,9680,29874,103599,103872,104028]);for(let e=9356;e<=9360;e++)t.add(e);for(let e=9404;e<=9407;e++)t.add(e);for(let e=9476;e<=9482;e++)t.add(e);for(let e=9487;e<=9494;e++)t.add(e);for(let e=9697;e<=9699;e++)t.add(e);return t}]),Ld.push([10.81,()=>{const t=new Set([9265,9333,103598,103699]);for(let e=9248;e<=9254;e++)t.add(e);for(let e=9271;e<=9273;e++)t.add(e);for(let e=9284;e<=9285;e++)t.add(e);for(let e=21453;e<=21463;e++)t.add(e);return t}]),Ld.push([10.8,()=>{const t=new Set([8088,8395,8428,8433,8531,8687,8692,8694,8699,8900,9003,9006,9009,9012,9017,9191]);for(let e=8035;e<=8036;e++)t.add(e);for(let e=8455;e<=8456;e++)t.add(e);for(let e=8518;e<=8529;e++)t.add(e);for(let e=8533;e<=8536;e++)t.add(e);for(let e=8538;e<=8540;e++)t.add(e);for(let e=8677;e<=8679;e++)t.add(e);for(let e=8902;e<=8903;e++)t.add(e);for(let e=8907;e<=8910;e++)t.add(e);for(let e=8949;e<=8951;e++)t.add(e);for(let e=8972;e<=8987;e++)t.add(e);for(let e=9039;e<=9040;e++)t.add(e);for(let e=9068;e<=9069;e++)t.add(e);for(let e=9140;e<=9141;e++)t.add(e);for(let e=9148;e<=9150;e++)t.add(e);for(let e=9153;e<=9159;e++)t.add(e);for(let e=9205;e<=9218;e++)t.add(e);for(let e=9221;e<=9222;e++)t.add(e);for(let e=54098;e<=54101;e++)t.add(e);return t}]),Ld.push([10.71,()=>{const t=new Set([6316]);for(let e=8351;e<=8353;e++)t.add(e);for(let e=9294;e<=9297;e++)t.add(e);for(let e=22619;e<=22621;e++)t.add(e);for(let e=103586;e<=103594;e++)t.add(e);return t}]),Ld.push([10.7,()=>{const t=new Set([8387,8391,8427,8545,8682,8685,8818,31370,104022,104024,104975]);for(let e=8065;e<=8068;e++)t.add(e);for(let e=8082;e<=8083;e++)t.add(e);for(let e=8379;e<=8385;e++)t.add(e);for(let e=8836;e<=8840;e++)t.add(e);for(let e=8857;e<=8860;e++)t.add(e);for(let e=53035;e<=53037;e++)t.add(e);for(let e=54090;e<=54091;e++)t.add(e);for(let e=102498;e<=102499;e++)t.add(e);return t}]),Ld.push([10.61,()=>new Set([102497])]),Ld.push([10.6,()=>{const t=new Set([7803,7805,7887,8086,8232,8237,8240,8246,8249,8252,8255,9019,9391]);for(let e=7755;e<=7787;e++)t.add(e);for(let e=7791;e<=7795;e++)t.add(e);for(let e=7799;e<=7801;e++)t.add(e);for(let e=7825;e<=7831;e++)t.add(e);for(let e=7877;e<=7878;e++)t.add(e);for(let e=7882;e<=7883;e++)t.add(e);for(let e=7991;e<=7992;e++)t.add(e);for(let e=8042;e<=8043;e++)t.add(e);for(let e=8058;e<=8059;e++)t.add(e);for(let e=8311;e<=8348;e++)t.add(e);for(let e=9060;e<=9067;e++)t.add(e);for(let e=102562;e<=102568;e++)t.add(e);for(let e=102799;e<=102900;e++)t.add(e);return t}]),Ld.push([10.51,()=>{const t=new Set([7683,7881,7886,7899,8888,9e3]);for(let e=8013;e<=8032;e++)t.add(e);for(let e=9053;e<=9057;e++)t.add(e);for(let e=104017;e<=104018;e++)t.add(e);for(let e=104971;e<=104974;e++)t.add(e);return t}]),Ld.push([10.5,()=>{const t=new Set([6962,7035,7037,7039,7041,7084,7086,7133,7798,102399]);for(let e=4087;e<=4088;e++)t.add(e);for(let e=5896;e<=5899;e++)t.add(e);for(let e=7005;e<=7007;e++)t.add(e);for(let e=7057;e<=7070;e++)t.add(e);for(let e=7073;e<=7082;e++)t.add(e);for(let e=7109;e<=7128;e++)t.add(e);for(let e=7844;e<=7859;e++)t.add(e);return t}]);async function GXe(t,e,r){const i=t&&t.getAtOrigin&&t.getAtOrigin("renderer",e.origin);if(i&&i.type==="unique-value"&&i.styleOrigin){const s=await Uc(i.populateFromStyle());if(ur(r),s.ok===!1){const n=s.error;e&&e.messages&&e.messages.push(new lm("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:e})),t.clear("renderer",e==null?void 0:e.origin)}}}const jXe=["oid","global-id"],HXe=["oid","global-id","guid"];function qXe({displayField:t,editFieldsInfo:e,fields:r,objectIdField:i,title:s},n){if(!r)return null;const o=KXe({editFieldsInfo:e,fields:r,objectIdField:i},n);if(!o.length)return null;const a=tYe({titleBase:s,fields:r,displayField:t}),l=eYe();return new $M({title:a,content:l,fieldInfos:o})}const WXe=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],XXe=(t,{editFieldsInfo:e,objectIdField:r,visibleFieldNames:i})=>i?i.has(t.name):!_be(t.name,e)&&(!r||t.name!==r)&&!jXe.includes(t.type)&&!WXe.some(s=>s.test(t.name));function YXe(t,e){const r=t;return e&&(t=t.filter(i=>!e.includes(i.type))),t===r&&(t=t.slice()),t.sort(ZXe),t}function ZXe(t,e){return t.type==="oid"?-1:e.type==="oid"?1:ese(t)?-1:ese(e)?1:(t.alias||t.name).toLocaleLowerCase().localeCompare((e.alias||e.name).toLocaleLowerCase())}function _be(t,e){if(!t||!e)return!1;const{creationDateField:r,creatorField:i,editDateField:s,editorField:n}=e;return[r&&r.toLowerCase(),i&&i.toLowerCase(),s&&s.toLowerCase(),n&&n.toLowerCase()].includes(t.toLowerCase())}function JXe(t,e){return t.editable&&!HXe.includes(t.type)&&!_be(t.name,e)}function KXe({editFieldsInfo:t,fields:e,objectIdField:r},i){return YXe(e??[],(i==null?void 0:i.ignoreFieldTypes)||rYe).map(s=>new IM({fieldName:s.name,isEditable:JXe(s,t),label:s.alias,format:QXe(s),visible:XXe(s,{editFieldsInfo:t,objectIdField:r,visibleFieldNames:i==null?void 0:i.visibleFieldNames})}))}function QXe(t){switch(t.type){case"small-integer":case"integer":case"single":return new D2({digitSeparator:!0,places:0});case"double":return new D2({digitSeparator:!0,places:2});case"date":return new D2({dateFormat:"long-month-day-year"});default:return t.type==="string"&&Nme(t.name)?new D2({digitSeparator:!0,places:0}):null}}function eYe(){return[new sE,new g3]}function tYe(t){const e=wFe(t),{titleBase:r}=t;return e?`${r}: {${e.trim()}}`:r??""}function ese(t){return(t.name&&t.name.toLowerCase())==="name"?!0:(t.alias&&t.alias.toLowerCase())==="name"}const rYe=["geometry","blob","raster","guid","xml"],pl="FeatureLayer",vbe="esri.layers.FeatureLayer",iYe=se.getLogger(vbe);function SI(t,e){return new j("layer:unsupported",`Layer (${t.title}, ${t.id}) of type '${t.declaredClass}' ${e}`,{layer:t})}function tse(t){return t&&t instanceof ft}const D8=FXe();function N8(t,e,r){const i=!!(r!=null&&r.writeLayerSchema);return{enabled:i,ignoreOrigin:i}}let vt=class extends MWe(yXe(Yje(CXe(qje(Gje(bXe(LXe(IXe(PXe(Bje(e4e(TXe(hX(jje(zje(bs(h3))))))))))))))))){constructor(...t){super(...t),this._handles=new Zr,this.charts=null,this.copyright=null,this.displayField=null,this.dynamicDataSource=null,this.fields=null,this.fieldsIndex=null,this.formTemplate=null,this.fullExtent=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.legendEnabled=!0,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.screenSizePerspectiveEnabled=!0,this.spatialReference=We.WGS84,this.subtypeCode=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.type="feature",this.typeIdField=null,this.types=null,this.visible=!0}destroy(){var t;(t=this.source)==null||t.destroy(),this._handles=Ve(this._handles)}normalizeCtorArgs(t,e){return typeof t=="string"?{url:t,...e}:t}load(t){var i;const e=v(t)?t.signal:null;if((i=this.portalItem)!=null&&i.loaded&&this.source)return this.addResolvingPromise(this.createGraphicsSource(e).then(s=>this.initLayerProperties(s))),Promise.resolve(this);const r=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},t).catch(Sc).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const s=await this._fetchFirstLayerId(e);s!=null&&(this.layerId=s)}if(!this.url&&!this._hasMemorySource())throw new j("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.initLayerProperties(await this.createGraphicsSource(e))}).then(()=>this._setUserPrivileges(this.serviceItemId,t)).then(()=>fWe(this,t));return this.addResolvingPromise(r),Promise.resolve(this)}readCapabilities(t,e){return e=e.layerDefinition||e,rbe(e,this.url)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")??0)+1}get editingEnabled(){var t;return!(this.loaded&&!((t=this.capabilities)!=null&&t.operations.supportsEditing))&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(t){this._overrideIfSome("editingEnabled",t)}readEditingEnabled(t,e){return this._readEditingEnabled(e,!1)}readEditingEnabledFromWebMap(t,e,r){return this._readEditingEnabled(e,!0,r)}writeEditingEnabled(t,e){this._writeEditingEnabled(t,e,!1)}writeEditingEnabledToWebMap(t,e,r,i){this._writeEditingEnabled(t,e,!0,i)}get effectiveEditingEnabled(){return mWe(this)}readIsTable(t,e){return(e=(e==null?void 0:e.layerDefinition)??e).type==="Table"||!e.geometryType}writeIsTable(t,e,r,i){i!=null&&i.writeLayerSchema&&sl(r,t?"Table":"Feature Layer",e)}readGlobalIdField(t,e){return ebe(e.layerDefinition||e)}readObjectIdField(t,e){return tbe(e.layerDefinition||e)}get parsedUrl(){const t=lo(this.url);return t!=null&&(this.dynamicDataSource!=null?t.path=Nu(t.path,"dynamicLayer"):this.layerId!=null&&(t.path=Nu(t.path,this.layerId.toString()))),t}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(t){Nee(t,this.fieldsIndex),this._set("renderer",t)}readRenderer(t,e,r){var s;const i=(s=(e=e.layerDefinition||e).drawingInfo)==null?void 0:s.renderer;if(i){const n=FF(i,e,r)??void 0;return n||iYe.error("Failed to create renderer",{rendererDefinition:e.drawingInfo.renderer,layer:this,context:r}),n}if(e.defaultSymbol)return e.types&&e.types.length?new qM({defaultSymbol:F8(e.defaultSymbol,e,r),field:e.typeIdField,uniqueValueInfos:e.types.map(n=>({id:n.id,symbol:F8(n.symbol,n,r)}))}):new vE({symbol:F8(e.defaultSymbol,e,r)})}set source(t){const e=this._get("source");e!==t&&(tse(e)&&this._resetMemorySource(e),tse(t)&&this._initMemorySource(t),this._set("source",t))}castSource(t){return t?Array.isArray(t)||t instanceof ft?new Ag({layer:this,items:t}):t:null}readSource(t,e){const r=XY.fromJSON(e.featureSet);return new Ag({layer:this,items:(r==null?void 0:r.features)??[]})}readTemplates(t,e){const r=e.editFieldsInfo,i=r&&r.creatorField,s=r&&r.editorField;return t=t&&t.map(n=>xZ.fromJSON(n)),this._fixTemplates(t,i),this._fixTemplates(t,s),t}readTitle(t,e){var s;const r=((s=e.layerDefinition)==null?void 0:s.name)??e.name,i=e.title||e.layerDefinition&&e.layerDefinition.title;if(r){const n=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?oNe(this.url,r):r;let o=r;if(!o&&this.url){const a=HE(this.url);v(a)&&(o=a.title)}return o?(this.sublayerTitleMode==="item-title-and-service-name"&&n&&n!==o&&(o=n+" - "+o),CX(o)):void 0}if(this.sublayerTitleMode==="item-title"&&i)return i}readTitleFromWebMap(t,e){return e.title||e.layerDefinition&&e.layerDefinition.name}readTypeIdField(t,e){let r=(e=e.layerDefinition||e).typeIdField;if(r&&e.fields){r=r.toLowerCase();const i=e.fields.find(s=>s.name.toLowerCase()===r);i&&(r=i.name)}return r}readTypes(t,e){t=(e=e.layerDefinition||e).types;const r=e.editFieldsInfo,i=r&&r.creatorField,s=r&&r.editorField;return t&&t.map(n=>(n=ybe.fromJSON(n),this._fixTemplates(n.templates,i),this._fixTemplates(n.templates,s),n))}readVisible(t,e){return e.layerDefinition&&e.layerDefinition.defaultVisibility!=null?!!e.layerDefinition.defaultVisibility:e.visibility!=null?!!e.visibility:void 0}async addAttachment(t,e){return Qqe(this,t,e,pl)}async updateAttachment(t,e,r){return eWe(this,t,e,r,pl)}async applyEdits(t,e){return tWe(this,t,e)}on(t,e){return super.on(t,e)}createPopupTemplate(t){return qXe(this,t)}async createGraphicsSource(t){if(this._hasMemorySource()&&this.source)return this.source.load({signal:t});const{default:e}=await _W(ie(()=>import("./FeatureLayerSource-c50b1293.js"),["./FeatureLayerSource-c50b1293.js","./assetEditingSupport-2cebf928.js","./clientSideDefaults-f782f4b2.js","./QueryEngineCapabilities-42e44ded.js","./QueryTask-8c803775.js","./executeForIds-f87b88db.js"],import.meta.url),t);return new e({layer:this}).load({signal:t})}createQuery(){const t=hWe(this);t.dynamicDataSource=this.dynamicDataSource;const e=v(this.subtypeCode)?`${this.subtypeField} = ${this.subtypeCode}`:null,r=Sje(this.definitionExpression,e);return t.where=r||"1=1",t}async deleteAttachments(t,e){return rWe(this,t,e,pl)}async fetchRecomputedExtents(t){return iWe(this,t,pl)}getFeatureType(t){const{typeIdField:e,types:r}=this;if(!e||!t)return null;const i=t.attributes?t.attributes[e]:void 0;if(i==null)return null;let s=null;return r==null||r.some(n=>{const{id:o}=n;return o!=null&&(o.toString()===i.toString()&&(s=n),!!s)}),s}getFieldDomain(t,e){const r=e&&e.feature,i=this.getFeatureType(r);if(i){const s=i.domains&&i.domains[t];if(s&&s.type!=="inherited")return s}return this._getLayerDomain(t)}getField(t){return this.fieldsIndex.get(t)}async queryAttachments(t,e){return sWe(this,t,e,pl)}async queryFeatures(t,e){const r=await this.load(),i=await r.source.queryFeatures(Lc.from(t)??r.createQuery(),e);if(i!=null&&i.features)for(const s of i.features)s.layer=s.sourceLayer=r;return i}async queryObjectIds(t,e){return nWe(this,t,e,pl)}async queryFeatureCount(t,e){return oWe(this,t,e,pl)}async queryExtent(t,e){return aWe(this,t,e,pl)}async queryRelatedFeatures(t,e){return lWe(this,t,e,pl)}async queryRelatedFeaturesCount(t,e){return cWe(this,t,e,pl)}async queryTopFeatures(t,e){var n;const{source:r,capabilities:i}=await this.load();if(!r.queryTopFeatures||!((n=i==null?void 0:i.query)!=null&&n.supportsTopFeaturesQuery))throw new j(pl,"Layer source does not support queryTopFeatures capability");const s=await r.queryTopFeatures(oI.from(t),e);if(s!=null&&s.features)for(const o of s.features)o.layer=o.sourceLayer=this;return s}async queryTopObjectIds(t,e){const{source:r,capabilities:i}=await this.load();if(!r.queryTopObjectIds||!(i!=null&&i.query.supportsTopFeaturesQuery))throw new j(pl,"Layer source does not support queryTopObjectIds capability");return r.queryTopObjectIds(oI.from(t),e)}async queryTopFeaturesExtent(t,e){var s;const{source:r,capabilities:i}=await this.load();if(!r.queryTopExtents||!((s=i==null?void 0:i.query)!=null&&s.supportsTopFeaturesQuery))throw new j(pl,"Layer source does not support queryTopExtents capability");return r.queryTopExtents(oI.from(t),e)}async queryTopFeatureCount(t,e){var s;const{source:r,capabilities:i}=await this.load();if(!r.queryTopCount||!((s=i==null?void 0:i.query)!=null&&s.supportsTopFeaturesQuery))throw new j(pl,"Layer source does not support queryFeatureCount capability");return r.queryTopCount(oI.from(t),e)}read(t,e){const r=t.featureCollection;if(r){const i=r.layers;i&&i.length===1&&(super.read(i[0],e),r.showLegend!=null&&super.read({showLegend:r.showLegend},e))}super.read(t,e),e&&e.origin==="service"&&(this.revert(["objectIdField","fields","timeInfo"],"service"),this.spatialReference||this.revert(["spatialReference"],"service"))}write(t,e){e={...e,origin:(e==null?void 0:e.origin)??void 0,writeLayerSchema:(e==null?void 0:e.writeLayerSchema)??this._hasMemorySource()};const{origin:r,layerContainerType:i,messages:s}=e;if(this.dynamicDataSource)return s==null||s.push(SI(this,"using a dynamic data source cannot be written to web scenes, web maps and feature service items")),null;if(this.isTable){if(r==="web-scene"||r==="web-map"&&i!=="tables")return s==null||s.push(SI(this,"using a table source cannot be written to web scenes and web maps")),null;if(this._hasMemorySource())return s==null||s.push(SI(this,"using an in-memory table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&r==="web-map"&&i==="tables")return s==null||s.push(SI(this,"using a non-table source cannot be written to tables in web maps")),null;return super.write(t,e)}clone(){if(this._hasMemorySource())throw new j(pl,`FeatureLayer (title: ${this.title}, id: ${this.id}) created using in-memory source cannot be cloned`);return super.clone()}serviceSupportsSpatialReference(t){var e;return!!this.loaded&&(((e=this.source)==null?void 0:e.type)==="memory"||BXe(this,t))}async save(t){return(await ie(()=>import("./featureLayerUtils-239ba175.js"),["./featureLayerUtils-239ba175.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url)).save(this,t)}async saveAs(t,e){return(await ie(()=>import("./featureLayerUtils-239ba175.js"),["./featureLayerUtils-239ba175.js","./fetchService-00d56f7a.js","./jsonContext-b300f3de.js"],import.meta.url)).saveAs(this,t,e)}_readEditingEnabled(t,e,r){var s;let i=(s=t.layerDefinition)==null?void 0:s.capabilities;return i?this._hasEditingCapability(i):(i=t.capabilities,e&&(r==null?void 0:r.origin)==="web-map"&&!this._hasMemorySource()&&i?this._hasEditingCapability(i):void 0)}_hasEditingCapability(t){return t.toLowerCase().split(",").map(e=>e.trim()).includes("editing")}_writeEditingEnabled(t,e,r,i){var s,n;if(!t){const o=(n=(s=this.capabilities)==null?void 0:s.operations)!=null&&n.supportsSync?"Query,Sync":"Query";sl("layerDefinition.capabilities",o,e),r&&!(i!=null&&i.writeLayerSchema)&&(e.capabilities=o)}}_getLayerDomain(t){const e=this.fieldsIndex.get(t);return e?e.domain:null}_fetchFirstLayerId(t){return Pi(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:t}).then(e=>{const r=e.data;if(r)return Array.isArray(r.layers)&&r.layers.length>0?r.layers[0].id:Array.isArray(r.tables)&&r.tables.length>0?r.tables[0].id:void 0})}async initLayerProperties(t){var e;return this._set("source",t),t.sourceJSON&&(this.sourceJSON=t.sourceJSON,this.read(t.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:(e=this.portalItem)==null?void 0:e.portal,url:this.parsedUrl})),this._verifySource(),this._verifyFields(),Nee(this.renderer,this.fieldsIndex),Ome(this.timeInfo,this.fieldsIndex),GXe(this,{origin:"service"})}async hasDataChanged(){return uWe(this)}async fetchPublishingStatus(){const t=this.source;return t!=null&&t.fetchPublishingStatus?t.fetchPublishingStatus():"unavailable"}_verifyFields(){var e,r;const t=((e=this.parsedUrl)==null?void 0:e.path)??"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+t+")"),this.isTable||this._hasMemorySource()||t.search(/\/FeatureServer\//i)!==-1||(r=this.fields)!=null&&r.some(i=>i.type==="geometry")||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+t+")")}_fixTemplates(t,e){t&&t.forEach(r=>{const i=r.prototype&&r.prototype.attributes;i&&e&&delete i[e]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new j("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new j("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(t){t.forEach(e=>{e.layer=this,e.sourceLayer=this}),this._handles.add([t.on("after-add",e=>{e.item.layer=this,e.item.sourceLayer=this}),t.on("after-remove",e=>{e.item.layer=null,e.item.sourceLayer=null})],"fl-source")}_resetMemorySource(t){t.forEach(e=>{e.layer=null,e.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}};u([Le("service","capabilities")],vt.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],vt.prototype,"charts",void 0),u([d({readOnly:!0})],vt.prototype,"createQueryVersion",null),u([d({json:{read:{source:"layerDefinition.copyrightText"}}})],vt.prototype,"copyright",void 0),u([d({json:{read:{source:"layerDefinition.displayField"}}})],vt.prototype,"displayField",void 0),u([d({types:ow,readOnly:!0})],vt.prototype,"defaultSymbol",void 0),u([d({type:Wd})],vt.prototype,"dynamicDataSource",void 0),u([d({type:Boolean})],vt.prototype,"editingEnabled",null),u([Le(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],vt.prototype,"readEditingEnabled",null),u([Le("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],vt.prototype,"readEditingEnabledFromWebMap",null),u([ke(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],vt.prototype,"writeEditingEnabled",null),u([ke("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],vt.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],vt.prototype,"effectiveEditingEnabled",null),u([d({...D8.fields,json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:N8}}}}})],vt.prototype,"fields",void 0),u([d(D8.fieldsIndex)],vt.prototype,"fieldsIndex",void 0),u([d({type:Nje,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],vt.prototype,"formTemplate",void 0),u([d({json:{read:{source:"layerDefinition.extent"}}})],vt.prototype,"fullExtent",void 0),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:N8,writer(t,e,r){const i=t?dj.toJSON(t):null;i&&sl(r,i,e)}}}},read:{source:"layerDefinition.geometryType",reader:dj.read}}})],vt.prototype,"geometryType",void 0),u([d({json:{read:{source:"layerDefinition.hasM"}}})],vt.prototype,"hasM",void 0),u([d({json:{read:{source:"layerDefinition.hasZ"}}})],vt.prototype,"hasZ",void 0),u([d(JFe)],vt.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],vt.prototype,"infoFor3D",void 0),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],vt.prototype,"isTable",void 0),u([Le("service","isTable",["type","geometryType"]),Le("isTable",["layerDefinition.type","layerDefinition.geometryType"])],vt.prototype,"readIsTable",null),u([ke("web-map","isTable")],vt.prototype,"writeIsTable",null),u([d(LX)],vt.prototype,"labelsVisible",void 0),u([d({type:[s6],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:Qie},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:Qie},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],vt.prototype,"labelingInfo",void 0),u([d((()=>{const t=te(ZFe);return t.json.origins["portal-item"]={write:{target:"layerDefinition.drawingInfo.transparency",writer(e,r,i){sl(i,RM(e),r)}}},t})())],vt.prototype,"opacity",void 0),u([d(XFe)],vt.prototype,"legendEnabled",void 0),u([d({type:["show","hide"],json:(()=>{const t=te(Ume.json);return t.origins["portal-item"]={read:!1,write:!1},t})()})],vt.prototype,"listMode",void 0),u([Le("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],vt.prototype,"readGlobalIdField",null),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:N8}}}}})],vt.prototype,"objectIdField",void 0),u([Le("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],vt.prototype,"readObjectIdField",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],vt.prototype,"operationalLayerType",void 0),u([d(D8.outFields)],vt.prototype,"outFields",void 0),u([d({readOnly:!0})],vt.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],vt.prototype,"path",void 0),u([d($X)],vt.prototype,"popupEnabled",void 0),u([d({type:$M,json:{name:"popupInfo",write:!0}})],vt.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],vt.prototype,"defaultPopupTemplate",null),u([d({types:K5,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:wje,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(t,e,r)=>({ignoreOrigin:r==null?void 0:r.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(t,e,r)=>({ignoreOrigin:r==null?void 0:r.writeLayerSchema})}}})],vt.prototype,"renderer",null),u([Le("service","renderer",["drawingInfo.renderer","defaultSymbol"]),Le("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],vt.prototype,"readRenderer",null),u([d((()=>{const t=te(qFe);return t.json.origins["portal-item"]={read:!1,write:!1},t})())],vt.prototype,"screenSizePerspectiveEnabled",void 0),u([d({clonable:!1})],vt.prototype,"source",null),u([Gt("source")],vt.prototype,"castSource",null),u([Le("portal-item","source",["featureSet"]),Le("web-map","source",["featureSet"])],vt.prototype,"readSource",null),u([d({json:{read:{source:"layerDefinition.extent.spatialReference"}}})],vt.prototype,"spatialReference",void 0),u([d({type:Number})],vt.prototype,"subtypeCode",void 0),u([d({type:[xZ]})],vt.prototype,"templates",void 0),u([Le("templates",["editFieldsInfo","creatorField","editorField","templates"])],vt.prototype,"readTemplates",null),u([d({type:gbe})],vt.prototype,"timeInfo",void 0),u([d()],vt.prototype,"title",void 0),u([Le("service","title",["name"]),Le("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],vt.prototype,"readTitle",null),u([Le("web-map","title",["layerDefinition.name","title"])],vt.prototype,"readTitleFromWebMap",null),u([d({type:String})],vt.prototype,"sublayerTitleMode",void 0),u([d({json:{read:!1}})],vt.prototype,"type",void 0),u([d({type:String})],vt.prototype,"typeIdField",void 0),u([Le("service","typeIdField"),Le("typeIdField",["layerDefinition.typeIdField"])],vt.prototype,"readTypeIdField",null),u([d({type:[ybe]})],vt.prototype,"types",void 0),u([Le("service","types",["types"]),Le("types",["layerDefinition.types"])],vt.prototype,"readTypes",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],vt.prototype,"visible",void 0),u([Le("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],vt.prototype,"readVisible",null),vt=u([P(vbe)],vt);const F8=wv({types:T5}),bbe=vt,$Rt=Object.freeze(Object.defineProperty({__proto__:null,default:bbe},Symbol.toStringTag,{value:"Module"})),sYe=["$datastore","$map","$layer","$aggregatedfeatures"],nYe="esri.widgets.Feature.support.arcadeFeatureUtils",oYe=se.getLogger(nYe);function aYe(t){return typeof t=="string"?kM(FY(t)):Array.isArray(t)?lYe(t):(t==null?void 0:t.declaredClass)==="esri.arcade.Dictionary"?cYe(t):t}function lYe(t){return`<ul class="esri-widget__list">${t.map(e=>`<li>${typeof e=="string"?kM(FY(e)):e}</li>`).join("")}</ul>`}function cYe(t){return`<table class="esri-widget__table">${t.keys().map(e=>{const r=t.field(e);return`<tr><th>${e}</th><td>${typeof r=="string"?kM(FY(r)):r}</td></tr>`}).join("")}</table>`}function uYe({aggregatedFeatures:t,arcadeUtils:e,featureSetVars:r,context:i,viewInfo:s,map:n,graphic:o,interceptor:a}){r.forEach(l=>{const c=l.toLowerCase(),h=s.sr,p={map:n,spatialReference:h,interceptor:a};if(c==="$map"&&(i.vars[c]=e.convertMapToFeatureSetCollection(p)),c==="$layer"&&(i.vars[c]=e.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:h,interceptor:a})),c==="$datastore"&&(i.vars[c]=e.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:h,interceptor:a})),c==="$aggregatedfeatures"){const f=o.layer,{fields:m,objectIdField:y,geometryType:_,spatialReference:b,displayField:x}=f,T=new bbe({fields:m,objectIdField:y,geometryType:_,spatialReference:b,displayField:x,...f.type==="feature"?{templates:f.templates,typeIdField:f.typeIdField,types:f.types}:null,source:t});i.vars[c]=e.convertFeatureLayerToFeatureSet({layer:T,spatialReference:b,interceptor:a})}})}function wbe(){return ie(()=>import("./arcadeUtils-25d26f6d.js").then(t=>t.ax),["./arcadeUtils-25d26f6d.js","./arcadeTimeUtils-486f1fea.js","./executionError-fb3f283a.js","./number-01f3944a.js","./hash-0ddfbf4b.js"],import.meta.url)}function hYe(t){return"createQuery"in t&&"queryFeatures"in t}async function dYe({graphic:t,view:e}){const{isAggregate:r,layer:i}=t;if(!r||!i||(e==null?void 0:e.type)!=="2d")return[];const s=await e.whenLayerView(i);if(!hYe(s))return[];const n=s.createQuery(),o=t.getObjectId();n.aggregateIds=o!=null?[o]:[];const{features:a}=await s.queryFeatures(n);return a}async function xbe({expressionInfo:t,arcadeUtils:e,interceptor:r,spatialReference:i,map:s,graphic:n,view:o}){if(!t||!t.expression)return null;const a=e.createSyntaxTree(t.expression),l=sYe.filter(m=>e.hasVariable(a,m)),[c]=await Promise.all([dYe({graphic:n,view:o}),e.loadScriptDependencies(a,!0,l)]),h=e.getViewInfo({spatialReference:i}),p=e.createExecContext(n,h);p.interceptor=r,p.useAsync=!0,uYe({aggregatedFeatures:c,arcadeUtils:e,featureSetVars:l,context:p,viewInfo:h,map:s,graphic:n,interceptor:r});const f=e.createFunction(a,p);return e.executeAsyncFunction(f,p).catch(m=>oYe.error("arcade-execution-error",{error:m,graphic:n,expressionInfo:t}))}async function pYe({expressionInfos:t,spatialReference:e,graphic:r,interceptor:i,map:s,view:n}){if(!t||!t.length)return{};const o=await wbe(),a={};for(const h of t)a[`expression/${h.name}`]=xbe({expressionInfo:h,arcadeUtils:o,interceptor:i,spatialReference:e,map:s,graphic:r,view:n});const l=await co(a),c={};for(const h in l)c[h]=aYe(l[h].value);return c}const fYe=1;let nu=class extends ux(Te){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:r}=this;r&&r.abort(),this._abortController=null},this._createVM=()=>{var s,n;const r=(s=this.contentElement)==null?void 0:s.type;(n=this.contentElementViewModel)==null||n.destroy();const i=r==="fields"?new j5:r==="media"?new Xb:r==="text"?new $F:null;this._set("contentElementViewModel",i)},this._compile=async()=>{this._cancelQuery();const r=new AbortController;this._abortController=r,await this._compileExpression(),this._abortController===r&&(this._abortController=null)},this._compileThrottled=pS(this._compile,fYe,this),this._compileExpression=async()=>{const{expressionInfo:r,graphic:i,interceptor:s,spatialReference:n,map:o,view:a,_abortController:l}=this;if(!(r&&i&&n&&o))return void this._set("contentElement",null);const c=await wbe();if(l!==this._abortController)return;const h=await xbe({arcadeUtils:c,expressionInfo:r,graphic:i,interceptor:s,map:o,spatialReference:n,view:a});if(!h||h.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const p=await h.castAsJsonAsync(l==null?void 0:l.signal),f=p==null?void 0:p.type,m=f==="media"?v3.fromJSON(p):f==="text"?nE.fromJSON(p):f==="fields"?sE.fromJSON(p):null;this._set("contentElement",m)},this.handles.add([ne(()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view],()=>this._compileThrottled(),kt),ne(()=>[this.contentElement],()=>this._createVM(),kt)])}destroy(){var e;this._cancelQuery(),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{_abortController:e,contentElement:r,contentElementViewModel:i}=this;return e?"loading":r||i?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)??null}set map(e){this._override("map",e)}};u([d()],nu.prototype,"_abortController",void 0),u([d({type:Vme})],nu.prototype,"expressionInfo",void 0),u([d({type:Sa})],nu.prototype,"graphic",void 0),u([d({readOnly:!0})],nu.prototype,"contentElement",void 0),u([d({readOnly:!0})],nu.prototype,"contentElementViewModel",void 0),u([d()],nu.prototype,"interceptor",void 0),u([d()],nu.prototype,"spatialReference",null),u([d({readOnly:!0})],nu.prototype,"state",null),u([d()],nu.prototype,"map",null),u([d()],nu.prototype,"view",void 0),nu=u([P("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],nu);const TZ=nu,EI={iconLoading:"esri-icon-loading-indicator esri-rotating",base:"esri-feature-expression",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"};let $D=class extends Ma{constructor(e,r){super(e,r),this._contentWidget=null,this.viewModel=new TZ}initialize(){this.addHandles(ne(()=>{var e;return(e=this.viewModel)==null?void 0:e.contentElementViewModel},()=>this._setupExpressionWidget(),kt))}destroy(){this._destroyContentWidget()}renderLoading(){return Q("div",{key:"loading-container",class:EI.loadingSpinnerContainer},Q("span",{class:this.classes(EI.iconLoading,EI.spinner)}))}render(){var r;const{state:e}=this.viewModel;return Q("div",{class:EI.base},e==="loading"?this.renderLoading():e==="disabled"?null:(r=this._contentWidget)==null?void 0:r.render())}_destroyContentWidget(){const{_contentWidget:e}=this;e&&(e.viewModel=null,e.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:e,contentElement:r}=this.viewModel,i=r==null?void 0:r.type;this._destroyContentWidget();const s=e?i==="fields"?new F_e({viewModel:e}):i==="media"?new Tve({viewModel:e}):i==="text"?new cD({viewModel:e}):null:null;this._contentWidget=s,this.scheduleRender()}};u([d({type:TZ})],$D.prototype,"viewModel",void 0),$D=u([P("esri.widgets.Feature.FeatureExpression")],$D);const mYe=$D,U8=100;let Zi=class extends bs(MM(ux(Te))){constructor(e){super(e),this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:r}=this;r&&r.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:r}=this;r&&r.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:r}=this;r&&r.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const r=new AbortController;this._queryAbortController=r,await oS(this._query()),this._queryAbortController===r&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._cancelQueryFeatureCount();const r=new AbortController;this._queryFeatureCountAbortController=r,await oS(this._queryFeatureCount()),this._queryFeatureCountAbortController===r&&(this._queryFeatureCountAbortController=null)},this._queryPageController=async()=>{const r=new AbortController;this._queryPageAbortController=r,await oS(this._queryPage()),this._queryPageAbortController===r&&(this._queryPageAbortController=null)},this._queryThrottled=pS(this._queryController,U8,this),this._queryFeatureCountThrottled=pS(this._queryFeatureCountController,U8,this),this._queryPageThrottled=pS(this._queryPageController,U8,this),this._query=async()=>{const{_queryAbortController:r,relatedFeatures:i}=this;this._destroyRelatedFeatureViewModels(),this.featurePage=1,i.removeAll(),i.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:r==null?void 0:r.signal})))},this.handles.add([ne(()=>[this.displayCount,this.graphic,this.layer,this.map,this.orderByFieldsFixedCasing,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount],()=>this._queryThrottled(),kt),ne(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageThrottled()),ne(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery],()=>this._queryFeatureCountThrottled())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:r,featureCount:i}=this,s=1,n=Math.ceil(i/r)||1;this._set("featurePage",Math.min(Math.max(e,s),n))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:r}=this;return e&&(r!=null&&r.loaded)?e.map(i=>{const s=i.clone(),n=R3(i.field,r);return s.field=n,s}):e??[]}get supportsCacheHint(){var e,r,i;return!!((i=(r=(e=this.layer)==null?void 0:e.capabilities)==null?void 0:r.queryRelated)!=null&&i.supportsCacheHint)}get canQuery(){var r,i;const e=(i=(r=this.layer)==null?void 0:r.capabilities)==null?void 0:i.queryRelated;return!!(this.relatedLayer&&this.relationship&&typeof this.relationshipId=="number"&&typeof this.objectId=="number"&&(e!=null&&e.supportsCount)&&(e!=null&&e.supportsPagination))}get itemDescriptionFieldName(){var e,r;return((r=(e=this.orderByFieldsFixedCasing)==null?void 0:e[0])==null?void 0:r.field)||null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e,0),10))}get displayCount(){return this._get("displayCount")}get objectId(){var e,r;return(this.objectIdField&&((r=(e=this.graphic)==null?void 0:e.attributes)==null?void 0:r[this.objectIdField]))??null}get objectIdField(){var e;return((e=this.layer)==null?void 0:e.objectIdField)||null}get relatedFeatures(){return this._get("relatedFeatures")||new ft}get relatedLayer(){const{layer:e,map:r,relationship:i}=this;return e!=null&&e.loaded&&r&&i?lze(r,e,i)??null:null}get relationship(){var i;const{relationshipId:e,layer:r}=this;return typeof e=="number"?((i=r==null?void 0:r.relationships)==null?void 0:i.find(({id:s})=>s===e))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new ft}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:r,_queryPageAbortController:i,canQuery:s}=this;return r?"loading":e||i?"querying":s?"ready":"disabled"}_destroyRelatedFeatureViewModels(){var e;(e=this.relatedFeatureViewModels)==null||e.forEach(r=>!r.destroyed&&r.destroy()),this.relatedFeatureViewModels.removeAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:r,relationshipId:i,objectId:s,_queryFeatureCountAbortController:n,canQuery:o,supportsCacheHint:a}=this;if(await(e==null?void 0:e.load()),await(r==null?void 0:r.load()),!o||!e||!r)return void this._set("featureCount",0);const l=r.createQuery(),c=new _E({cacheHint:a,relationshipId:i,returnGeometry:!1,objectIds:[s],where:uQ(l.where,void 0)}),h=await e.queryRelatedFeaturesCount(c,{signal:n==null?void 0:n.signal});this._set("featureCount",h[s]||0)}_sliceFeatures(e){const{showAllEnabled:r,displayCount:i}=this;return r?e:i?e.slice(0,i):[]}async _queryPage(){const{relatedFeatures:e,featurePage:r,showAllEnabled:i,_queryPageAbortController:s}=this;!i||r<2||e.addMany(await this._queryRelatedFeatures({signal:s==null?void 0:s.signal}))}async _queryRelatedFeatures(e){var R;const{orderByFieldsFixedCasing:r,showAllEnabled:i,featuresPerPage:s,displayCount:n,layer:o,relationshipId:a,featurePage:l,featureCount:c,relatedLayer:h,supportsCacheHint:p}=this,{canQuery:f,objectId:m}=this;if(!f||!o||!h)return[];const y=i?((l-1)*s+c)%c:0,_=i?s:n,b=h.objectIdField,x=[...r==null?void 0:r.map(L=>L.field),b].filter(v),T=r==null?void 0:r.map(L=>`${L.field} ${L.order}`),S=h.createQuery(),E=new _E({orderByFields:T,start:y,num:_,outFields:x,cacheHint:p,relationshipId:a,returnGeometry:!1,objectIds:[m],where:uQ(S.where,void 0)}),O=((R=(await o.queryRelatedFeatures(E,{signal:e==null?void 0:e.signal}))[m])==null?void 0:R.features)||[];return O.forEach(L=>{L.sourceLayer=h,L.layer=h}),O}};u([d()],Zi.prototype,"_queryAbortController",void 0),u([d()],Zi.prototype,"_queryPageAbortController",void 0),u([d()],Zi.prototype,"_queryFeatureCountAbortController",void 0),u([d({value:1})],Zi.prototype,"featurePage",null),u([d()],Zi.prototype,"featuresPerPage",void 0),u([d({readOnly:!0})],Zi.prototype,"orderByFieldsFixedCasing",null),u([d({readOnly:!0})],Zi.prototype,"supportsCacheHint",null),u([d({readOnly:!0})],Zi.prototype,"canQuery",null),u([d()],Zi.prototype,"description",void 0),u([d({readOnly:!0})],Zi.prototype,"itemDescriptionFieldName",null),u([d({value:3})],Zi.prototype,"displayCount",null),u([d({type:Sa})],Zi.prototype,"graphic",void 0),u([d()],Zi.prototype,"layer",void 0),u([d()],Zi.prototype,"map",void 0),u([d({readOnly:!0})],Zi.prototype,"objectId",null),u([d({readOnly:!0})],Zi.prototype,"objectIdField",null),u([d()],Zi.prototype,"orderByFields",void 0),u([d({readOnly:!0})],Zi.prototype,"relatedFeatures",null),u([d({readOnly:!0})],Zi.prototype,"relatedLayer",null),u([d({readOnly:!0})],Zi.prototype,"relationship",null),u([d()],Zi.prototype,"featureCount",void 0),u([d({readOnly:!0})],Zi.prototype,"relatedFeatureViewModels",null),u([d()],Zi.prototype,"relationshipId",void 0),u([d()],Zi.prototype,"showAllEnabled",void 0),u([d()],Zi.prototype,"state",null),u([d()],Zi.prototype,"title",void 0),Zi=u([P("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],Zi);const SZ=Zi,RR="esri-feature",V8=`${RR}-relationship`,km={base:V8,esriWidget:"esri-widget",listContainer:`${V8}__list`,listContainerQuerying:`${V8}__list--querying`,featureObserver:`${RR}__feature-observer`,stickySpinnerContainer:`${RR}__sticky-loading-container`,loadingSpinnerContainer:`${RR}__loading-container`,spinner:`${RR}__loading-spinner`,iconLoading:"esri-icon-loading-indicator esri-rotating"},rse={title:!0,description:!0};let El=class extends Ma{constructor(e,r){super(e,r),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver(([i])=>{i!=null&&i.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this.headingLevel=2,this.viewModel=new SZ,this.messages=null,this.messagesCommon=null,this.visibleElements={...rse},this._increaseFeaturePage=()=>{const{state:i,showAllEnabled:s,relatedFeatures:n,featuresPerPage:o,featurePage:a}=this.viewModel;i==="ready"&&s&&n.length>=o*a&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new G5,this.addHandles([ne(()=>[this.viewModel.description,this.viewModel.title,this.headingLevel],()=>this._setupFeatureElementInfo(),kt),ne(()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode],()=>this._handleRelatedFeatureObserverChange()),an(()=>this.viewModel.relatedFeatureViewModels,"change",()=>this._setupRelatedFeatureViewModels())])}loadDependencies(){return Promise.all([ie(()=>import("./calcite-list-8a9c0fe9.js"),["./calcite-list-8a9c0fe9.js","./interactive-573cbe88.js","./observers-4f67f1fb.js","./utils3-1ce076c1.js","./loadable-25ad9e4e.js","./debounce-31e0cfcc.js","./t9n-53771394.js","./icon-eb8ea09d.js","./loader-6480f484.js","./guid-9426053f.js","./scrim-ee9ec6c9.js"],import.meta.url),ie(()=>import("./calcite-list-item-35871f47.js"),["./calcite-list-item-35871f47.js","./interactive-573cbe88.js","./utils3-1ce076c1.js","./loadable-25ad9e4e.js","./icon-eb8ea09d.js","./observers-4f67f1fb.js"],import.meta.url),ie(()=>import("./calcite-icon-30f39d3e.js"),["./calcite-icon-30f39d3e.js","./icon-eb8ea09d.js","./observers-4f67f1fb.js"],import.meta.url),ie(()=>import("./calcite-notice-67ba6b61.js"),["./calcite-notice-67ba6b61.js","./observers-4f67f1fb.js","./loadable-25ad9e4e.js","./t9n-53771394.js","./icon-eb8ea09d.js"],import.meta.url)])}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=Ve(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:e,featureCount:r,displayCount:i}=this.viewModel;return!e&&!!r&&(r>i||i===0)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get featureCountDescription(){const{messages:e}=this,{featureCount:r}=this.viewModel;return Of(r===1?e==null?void 0:e.numberRecord:e==null?void 0:e.numberRecords,{number:r})}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}castVisibleElements(e){return{...rse,...e}}renderStickyLoading(){return this.viewModel.state==="querying"?Q("div",{key:"sticky-loader",class:km.stickySpinnerContainer},this.renderLoadingIcon()):null}renderLoadingIcon(){return Q("span",{class:this.classes(km.iconLoading,km.spinner)})}renderLoading(){return Q("div",{key:"loading-container",class:km.loadingSpinnerContainer},this.renderLoadingIcon())}renderShowAllIconNode(){return Q("calcite-icon",{scale:"s",icon:"list",slot:"content-end"})}renderChevronIconNode(){const e=qf(this.container)?"chevron-left":"chevron-right";return Q("calcite-icon",{scale:"s",icon:e,slot:"content-end"})}renderRelatedFeature(e){var n,o;const{itemDescriptionFieldName:r}=this.viewModel,i=e.title;e.description=r&&((n=e.formattedAttributes)==null?void 0:n.global[r]);const s=e.state==="loading";return Q("calcite-list-item",{key:e.uid,label:s?`${(o=this.messagesCommon)==null?void 0:o.loading}`:i,description:s?"":e.description??"",onCalciteListItemSelect:()=>this.emit("select-record",{featureViewModel:e})},this.renderChevronIconNode())}renderShowAllListItem(){var e;return this.displayShowAllButton?Q("calcite-list-item",{key:"show-all-item",label:(e=this.messages)==null?void 0:e.showAll,description:this.featureCountDescription,onCalciteListItemSelect:()=>this.emit("show-all-records")},this.renderShowAllIconNode()):null}renderNoRelatedFeaturesMessage(){var e;return Q("calcite-notice",{key:"no-related-features-message",icon:"information",open:!0,kind:"brand",scale:"s",width:"full"},Q("div",{slot:"message"},(e=this.messages)==null?void 0:e.noRelatedFeatures))}renderFeatureObserver(){return Q("div",{key:"feature-observer",class:km.featureObserver,bind:this,afterCreate:this._relatedFeatureIntersectionObserverCreated})}renderList(){const{relatedFeatureViewModels:e}=this.viewModel;return Q("calcite-list",null,e.toArray().map(r=>this.renderRelatedFeature(r)),this.renderShowAllListItem())}renderRelatedFeatures(){const{displayListItems:e}=this,{state:r}=this.viewModel;return Q("div",{key:"list-container",class:this.classes(km.listContainer,{[km.listContainerQuerying]:r==="querying"})},e?this.renderList():r==="ready"?this.renderNoRelatedFeaturesMessage():null,this.renderStickyLoading(),this.renderFeatureObserver())}renderRelationshipNotFound(){var e;return Q("calcite-notice",{key:"relationship-not-found",icon:"exclamation-mark-triangle",open:!0,kind:"danger",scale:"s",width:"full"},Q("div",{slot:"message"},(e=this.messages)==null?void 0:e.relationshipNotFound))}render(){var r;const{state:e}=this.viewModel;return Q("div",{class:this.classes(km.base,km.esriWidget)},(r=this._featureElementInfo)==null?void 0:r.render(),e==="loading"?this.renderLoading():e==="disabled"?this.renderRelationshipNotFound():this.renderRelatedFeatures())}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:e}=this.viewModel,r="related-feature-viewmodels";this.removeHandles(r),e==null||e.forEach(i=>{this.addHandles(ne(()=>[i.title,i.state],()=>this.scheduleRender(),kt),r)}),this.scheduleRender()}_setupFeatureElementInfo(){var n;const{headingLevel:e,visibleElements:r}=this,i=r.description&&this.description,s=r.title&&this.title;(n=this._featureElementInfo)==null||n.set({description:i,title:s,headingLevel:e})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:e,showAllEnabled:r}=this.viewModel;await _w(0),this._relatedFeatureIntersectionObserverNode&&e==="ready"&&r&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(e){this._relatedFeatureIntersectionObserverNode=e}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};u([d()],El.prototype,"_relatedFeatureIntersectionObserverNode",void 0),u([d({readOnly:!0})],El.prototype,"displayShowAllButton",null),u([d({readOnly:!0})],El.prototype,"displayListItems",null),u([d()],El.prototype,"description",null),u([d({readOnly:!0})],El.prototype,"featureCountDescription",null),u([d()],El.prototype,"headingLevel",void 0),u([d()],El.prototype,"title",null),u([d({type:SZ})],El.prototype,"viewModel",void 0),u([d(),rl("esri/widgets/Feature/t9n/Feature")],El.prototype,"messages",void 0),u([d(),rl("esri/t9n/common")],El.prototype,"messagesCommon",void 0),u([d()],El.prototype,"visibleElements",void 0),u([Gt("visibleElements")],El.prototype,"castVisibleElements",null),El=u([P("esri.widgets.Feature.FeatureRelationship")],El);const ise=El;let gYe=class{constructor(e,r){this.preLayerQueryCallback=e,this.preRequestCallback=r,this.preLayerQueryCallback||(this.preLayerQueryCallback=i=>{}),this.preRequestCallback||(this.preLayerQueryCallback=i=>{})}};var OR;const yYe=1,sse="content-view-models",nse="relationship-view-models",ose={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0};let Os=OR=class extends MM(Te){constructor(t){super(t),this._handles=new Zr,this._error=null,this._featureAbortController=null,this._graphicChangedThrottled=pS(this._graphicChanged,yYe,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...ose},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=e=>{const{abilities:r}=this;return e.type==="attachments"&&!!r.attachmentsContent||e.type==="custom"&&!!r.customContent||e.type==="fields"&&!!r.fieldsContent||e.type==="media"&&!!r.mediaContent||e.type==="text"&&!!r.textContent||e.type==="expression"&&!!r.expressionContent||e.type==="relationship"&&!!r.relationshipContent},this._handles.add(ne(()=>[this.graphic,this._effectivePopupTemplate,this.abilities],()=>this._graphicChangedThrottled(),kt))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return v(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return tze(tre(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return E_e(this.graphic)}castAbilities(t){return{...ose,...t}}get isTable(){var t;return((t=this._sourceLayer)==null?void 0:t.isTable)||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(t){this._set("graphic",t?t.clone():null)}get spatialReference(){var t;return((t=this.view)==null?void 0:t.spatialReference)??null}set spatialReference(t){this._override("spatialReference",t)}get map(){var t;return((t=this.view)==null?void 0:t.map)||null}set map(t){this._override("map",t)}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(t,e){const r=this.contentViewModels[t];r instanceof Xb&&r.setActiveMedia(e)}nextMedia(t){const e=this.contentViewModels[t];e instanceof Xb&&e.next()}previousMedia(t){const e=this.contentViewModels[t];e instanceof Xb&&e.previous()}async updateGeometry(){var o,a;const{graphic:t,spatialReference:e,_sourceLayer:r}=this;await(r==null?void 0:r.load());const i=r==null?void 0:r.objectIdField;if(!i||!t||!r)return;const s=(o=t==null?void 0:t.attributes)==null?void 0:o[i];if(s==null)return;const n=[s];if(!t.geometry){const l=(a=await P_e({layer:r,graphic:t,outFields:[],objectIds:n,returnGeometry:!0,spatialReference:e}))==null?void 0:a.geometry;l&&(t.geometry=l)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:t}=this;if(!t)return;const e=new AbortController;this._featureAbortController=e;try{await this._queryFeature({signal:e.signal})}catch(r){Ks(r)||(this._error=r,se.getLogger(this.declaredClass).error("error","The popupTemplate could not be displayed for this feature.",{error:r,graphic:t,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===e&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:t}=this;t&&t.abort(),this._featureAbortController=null}_compileContentElement(t,e){return t.type==="attachments"?this._compileAttachments(t,e):t.type==="custom"?this._compileCustom(t,e):t.type==="fields"?this._compileFields(t,e):t.type==="media"?this._compileMedia(t,e):t.type==="text"?this._compileText(t,e):t.type==="expression"?this._compileExpression(t,e):t.type==="relationship"?this._compileRelationship(t,e):void 0}_compileContent(t){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(t)?t.filter(this._isAllowedContentType).map((e,r)=>this._compileContentElement(e,r)).filter(v):typeof t=="string"?this._compileText(new nE({text:t}),0).text:t}_destroyContentViewModels(){var t,e;(t=this._handles)==null||t.remove(nse),(e=this._handles)==null||e.remove(sse),this.contentViewModels.forEach(r=>r&&!r.destroyed&&r.destroy()),this._set("contentViewModels",[])}_matchesFeature(t,e){var s;const r=(s=t==null?void 0:t.graphic)==null?void 0:s.getObjectId(),i=e==null?void 0:e.getObjectId();return v(r)&&v(i)&&r===i}_setRelatedFeaturesViewModels({relatedFeatureViewModels:t,relatedFeatures:e,map:r}){const{view:i,spatialReference:s}=this;e==null||e.filter(Boolean).forEach(n=>{t.find(o=>this._matchesFeature(o,n))||t.add(new OR({abilities:{relationshipContent:!1},map:r,view:i,spatialReference:s,graphic:n}))}),t.forEach(n=>{(e==null?void 0:e.find(a=>this._matchesFeature(n,a)))||t.remove(n)})}_setExpressionContentVM(t,e){const r=this.formattedAttributes,{contentElement:i,contentElementViewModel:s}=t,n=i==null?void 0:i.type;s&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:r}),s.set(this._createFieldsVMParams(i,e))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:r}),s.set(this._createMediaVMParams(i,e))),n==="text"&&s.set(this._createTextVMParams(i)))}_compileRelationship(t,e){const{displayCount:r,orderByFields:i,relationshipId:s,title:n,description:o}=t,{_sourceLayer:a,graphic:l,map:c}=this,h=new SZ({displayCount:r,graphic:l,orderByFields:i,relationshipId:s,layer:a,map:c,...this._compileTitleAndDesc({title:n,description:o})});return this.contentViewModels[e]=h,this._handles.add(an(()=>h.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(h)),nse),t}_compileExpression(t,e){const{expressionInfo:r}=t,{graphic:i,map:s,spatialReference:n,view:o}=this,a=new TZ({expressionInfo:r,graphic:i,interceptor:OR.interceptor,map:s,spatialReference:n,view:o});return this.contentViewModels[e]=a,this._handles.add(ne(()=>a.contentElementViewModel,()=>this._setExpressionContentVM(a,e),kt),sse),t}_compileAttachments(t,e){const{graphic:r}=this,{description:i,title:s}=t;return this.contentViewModels[e]=new VY({graphic:r,...this._compileTitleAndDesc({title:s,description:i})}),t}_compileCustom(t,e){const{graphic:r}=this,{creator:i,destroyer:s}=t;return this.contentViewModels[e]=new $F({graphic:r,creator:i,destroyer:s}),t}_compileTitleAndDesc({title:t,description:e}){const{_fieldInfoMap:r,_sourceLayer:i,graphic:s,formattedAttributes:n}=this,o=s==null?void 0:s.attributes,a=this._expressionAttributes,l=n.global;return{title:qb({attributes:o,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:i,text:t}),description:qb({attributes:o,fieldInfoMap:r,globalAttributes:l,expressionAttributes:a,layer:i,text:e})}}_createFieldsVMParams(t,e){var c;const r=this._effectivePopupTemplate,i=this.formattedAttributes,s={...i==null?void 0:i.global,...i==null?void 0:i.content[e]},n=(c=(t==null?void 0:t.fieldInfos)||(r==null?void 0:r.fieldInfos))==null?void 0:c.filter(({fieldName:h})=>DY(h)||kg(h)||s.hasOwnProperty(h)),o=r==null?void 0:r.expressionInfos,{description:a,title:l}=t;return{attributes:s,expressionInfos:o,fieldInfos:n,...this._compileTitleAndDesc({title:l,description:a})}}_compileFields(t,e){const r=t.clone(),i=new j5(this._createFieldsVMParams(t,e));return this.contentViewModels[e]=i,r.fieldInfos=i.formattedFieldInfos.slice(0),r}_createMediaVMParams(t,e){const{abilities:r,graphic:i,_fieldInfoMap:s,_effectivePopupTemplate:n,relatedInfos:o,_sourceLayer:a,_expressionAttributes:l}=this,c=this.formattedAttributes,h=(i==null?void 0:i.attributes)??{},{description:p,mediaInfos:f,title:m}=t;return{abilities:{chartAnimation:r.chartAnimation},activeMediaInfoIndex:t.activeMediaInfoIndex||0,attributes:h,isAggregate:i==null?void 0:i.isAggregate,layer:a,fieldInfoMap:s,formattedAttributes:{...c==null?void 0:c.global,...c==null?void 0:c.content[e]},expressionAttributes:l,mediaInfos:f,popupTemplate:n,relatedInfos:o,...this._compileTitleAndDesc({title:m,description:p})}}_compileMedia(t,e){const r=t.clone(),i=new Xb(this._createMediaVMParams(t,e));return r.mediaInfos=i.formattedMediaInfos.slice(0),this.contentViewModels[e]=i,r}_createTextVMParams(t){var n;const{graphic:e,_fieldInfoMap:r,_sourceLayer:i,_expressionAttributes:s}=this;if(t&&t.text){const o=(e==null?void 0:e.attributes)??{},a=((n=this.formattedAttributes)==null?void 0:n.global)??{};t.text=qb({attributes:o,fieldInfoMap:r,globalAttributes:a,expressionAttributes:s,layer:i,text:t.text})}return{graphic:e,creator:t.text}}_compileText(t,e){const r=t.clone();return this.contentViewModels[e]=new $F(this._createTextVMParams(r)),r}_compileLastEditInfo(){const{_effectivePopupTemplate:t,_sourceLayer:e,graphic:r}=this;if(!t)return;const{lastEditInfoEnabled:i}=t,s=e==null?void 0:e.editFieldsInfo;return i&&s?eze(s,r==null?void 0:r.attributes):void 0}_compileTitle(t){var a;const{_fieldInfoMap:e,_sourceLayer:r,graphic:i,_expressionAttributes:s}=this,n=(i==null?void 0:i.attributes)??{},o=((a=this.formattedAttributes)==null?void 0:a.global)??{};return qb({attributes:n,fieldInfoMap:e,globalAttributes:o,expressionAttributes:s,layer:r,text:t})}async _getTitle(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const r=t==null?void 0:t.title;return IF(r,{graphic:e})}async _getContent(){const{_effectivePopupTemplate:t,graphic:e}=this;if(!e)return null;const r=t==null?void 0:t.content;return IF(r,{graphic:e})}async _queryFeature(t){const{_featureAbortController:e,_sourceLayer:r,graphic:i,_effectivePopupTemplate:s}=this,n=this.map,o=this.view,a=this.spatialReference;if(e!==this._featureAbortController||!i)return;await ize({graphic:i,popupTemplate:s,layer:r,spatialReference:a},t);const{content:{value:l},title:{value:c}}=await co({content:this._getContent(),title:this._getTitle()}),{expressionAttributes:{value:h}}=await co({checkForRelatedFeatures:this._checkForRelatedFeatures(t),expressionAttributes:pYe({expressionInfos:s==null?void 0:s.expressionInfos,spatialReference:a,graphic:i,map:n,interceptor:OR.interceptor,view:o})});e===this._featureAbortController&&i&&(this._expressionAttributes=h,this._graphicExpressionAttributes={...i.attributes,...h},this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:r}){const{_effectivePopupTemplate:i,graphic:s,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;r.content[e]=QU({fieldInfos:i==null?void 0:i.fieldInfos,graphic:s,attributes:{...l,...t.attributes},layer:o,fieldInfoMap:a,relatedInfos:n})}_createFieldsFormattedAttributes({contentElement:t,contentElementIndex:e,formattedAttributes:r}){if(t.fieldInfos){const{graphic:i,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:a}=this;r.content[e]=QU({fieldInfos:t.fieldInfos,graphic:i,attributes:{...a,...t.attributes},layer:n,fieldInfoMap:o,relatedInfos:s})}}_createFormattedAttributes(t){const{_effectivePopupTemplate:e,graphic:r,relatedInfos:i,_sourceLayer:s,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,a=e==null?void 0:e.fieldInfos,l={global:QU({fieldInfos:a,graphic:r,attributes:o,layer:s,fieldInfoMap:n,relatedInfos:i}),content:[]};return Array.isArray(t)&&t.forEach((c,h)=>{c.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l}),c.type==="media"&&this._createMediaFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l})}),l}_checkForRelatedFeatures(t){const{graphic:e,_effectivePopupTemplate:r}=this;return this._queryRelatedInfos(e,tre(r),t)}async _queryRelatedInfos(t,e,r){const{relatedInfos:i,_sourceLayer:s}=this;i.clear();const n=v(s==null?void 0:s.associatedLayer)?await(s==null?void 0:s.associatedLayer.load(r)):s;if(!n||!t)return;const o=e.filter(c=>c&&kg(c.fieldName));if(!o||!o.length)return;e.forEach(c=>this._configureRelatedInfo(c,n));const a=await uGe({relatedInfos:i,layer:n},r);Object.keys(a).forEach(c=>{var f;const h=i.get(c.toString()),p=(f=a[c])==null?void 0:f.value;h&&p&&(h.layerInfo=p.data)});const l=await hGe({graphic:t,relatedInfos:i,layer:n},r);Object.keys(l).forEach(c=>{var h;nGe((h=l[c])==null?void 0:h.value,i.get(c.toString()))})}_configureRelatedInfo(t,e){const{relatedInfos:r}=this,i=fD(t.fieldName);if(!i)return;const{layerId:s,fieldName:n}=i;if(!s)return;const o=r.get(s.toString())||sGe(s,e);o&&(dGe({relatedInfo:o,fieldName:n,fieldInfo:t}),this.relatedInfos.set(s,o))}};Os.interceptor=new gYe(oze,aze),u([d()],Os.prototype,"_error",void 0),u([d()],Os.prototype,"_featureAbortController",void 0),u([d({readOnly:!0})],Os.prototype,"_effectivePopupTemplate",null),u([d({readOnly:!0})],Os.prototype,"_fieldInfoMap",null),u([d({readOnly:!0})],Os.prototype,"_sourceLayer",null),u([d()],Os.prototype,"abilities",void 0),u([Gt("abilities")],Os.prototype,"castAbilities",null),u([d({readOnly:!0})],Os.prototype,"content",void 0),u([d({readOnly:!0})],Os.prototype,"contentViewModels",void 0),u([d()],Os.prototype,"description",void 0),u([d({type:Boolean})],Os.prototype,"defaultPopupTemplateEnabled",void 0),u([d({readOnly:!0})],Os.prototype,"isTable",null),u([d({readOnly:!0})],Os.prototype,"state",null),u([d({readOnly:!0})],Os.prototype,"formattedAttributes",void 0),u([d({type:Sa,value:null})],Os.prototype,"graphic",null),u([d({readOnly:!0})],Os.prototype,"lastEditInfo",void 0),u([d({readOnly:!0})],Os.prototype,"relatedInfos",void 0),u([d()],Os.prototype,"spatialReference",null),u([d({readOnly:!0})],Os.prototype,"title",void 0),u([d()],Os.prototype,"map",null),u([d({readOnly:!0})],Os.prototype,"waitingForContent",null),u([d()],Os.prototype,"view",void 0),Os=OR=u([P("esri.widgets.FeatureViewModel")],Os);const EZ=Os,sa="esri-feature",tn={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:sa,container:`${sa}__size-container`,title:`${sa}__title`,main:`${sa}__main-container`,btn:`${sa}__button`,icon:`${sa}__icon`,content:`${sa}__content`,contentNode:`${sa}__content-node`,contentElement:`${sa}__content-element`,text:`${sa}__text`,lastEditedInfo:`${sa}__last-edited-info`,fields:`${sa}__fields`,fieldHeader:`${sa}__field-header`,fieldData:`${sa}__field-data`,fieldDataDate:`${sa}__field-data--date`,loadingSpinnerContainer:`${sa}__loading-container`,spinner:`${sa}__loading-spinner`},Tbe=t=>{let e=class extends t{constructor(){super(...arguments),this.renderNodeContent=r=>N_e(r)&&!r.destroyed?Q("div",{class:tn.contentNode,key:r},r.render()):r instanceof HTMLElement?Q("div",{class:tn.contentNode,key:r,bind:r,afterCreate:this._attachToNode}):Eze(r)?Q("div",{class:tn.contentNode,key:r,bind:r.domNode,afterCreate:this._attachToNode}):null}_attachToNode(r){const i=this;r.appendChild(i)}};return e=u([P("esri.widgets.Feature.ContentMixin")],e),e};var Tj;const ase={title:!0,content:!0,lastEditedInfo:!0},lse="relationship-handles";let xo=Tj=class extends Tbe(Ma){constructor(t,e){super(t,e),this._contentWidgets=[],this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.visibleElements={...ase},this.viewModel=new EZ}initialize(){this.addHandles(ne(()=>{var t;return(t=this.viewModel)==null?void 0:t.contentViewModels},()=>this._setupContentWidgets(),kt))}loadDependencies(){return ie(()=>import("./calcite-notice-67ba6b61.js"),["./calcite-notice-67ba6b61.js","./observers-4f67f1fb.js","./loadable-25ad9e4e.js","./t9n-53771394.js","./icon-eb8ea09d.js"],import.meta.url)}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(t){this.viewModel.graphic=t}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(t){this.viewModel.defaultPopupTemplateEnabled=t}get isTable(){return this.viewModel.isTable}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(t){this.viewModel.spatialReference=t}get title(){return this.viewModel.title}castVisibleElements(t){return{...ase,...t}}get map(){return this.viewModel.map}set map(t){this.viewModel.map=t}get view(){return this.viewModel.view}set view(t){this.viewModel.view=t}render(){const{state:t}=this.viewModel,e=Q("div",{class:tn.container,key:"container"},this.renderTitle(),t==="error"?this.renderError():t==="loading"?this.renderLoading():this.renderContentContainer());return Q("div",{class:this.classes(tn.base,tn.esriWidget)},e)}setActiveMedia(t,e){return this.viewModel.setActiveMedia(t,e)}nextMedia(t){return this.viewModel.nextMedia(t)}previousMedia(t){return this.viewModel.previousMedia(t)}renderError(){const{messagesCommon:t,messages:e,visibleElements:r}=this;return Q("calcite-notice",{open:!0,kind:"danger",icon:"exclamation-mark-circle",scale:"s"},r.title?Q("div",{key:"error-title",slot:"title"},t.errorMessage):null,Q("div",{key:"error-message",slot:"message"},e.loadingError))}renderLoading(){return Q("div",{key:"loading-container",class:tn.loadingSpinnerContainer},Q("span",{class:this.classes(tn.iconLoading,tn.spinner)}))}renderContentContainer(){const{visibleElements:t}=this;return t.content?Q("div",{class:tn.main},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:t,title:e}=this;return t.title?Q(kY,{level:this.headingLevel,class:tn.title,innerHTML:e}):null}renderContent(){const t=this.viewModel.content,e="content";if(!t)return null;if(Array.isArray(t))return t.length?Q("div",{class:tn.contentNode,key:`${e}-content-elements`},t.map(this.renderContentElement,this)):null;if(typeof t=="string"){const r=this._contentWidgets[0];return!r||r.destroyed?null:Q("div",{class:tn.contentNode,key:`${e}-content`},r.render())}return this.renderNodeContent(t)}renderContentElement(t,e){var i;const{visibleElements:r}=this;if(typeof r.content!="boolean"&&!((i=r.content)!=null&&i[t.type]))return null;switch(t.type){case"attachments":return this.renderAttachments(e);case"custom":return this.renderCustom(t,e);case"fields":return this.renderFields(e);case"media":return this.renderMedia(e);case"text":return this.renderText(t,e);case"expression":return this.renderExpression(e);case"relationship":return this.renderRelationship(e);default:return null}}renderAttachments(t){const e=this._contentWidgets[t];if(!e||e.destroyed)return null;const{state:r,attachmentInfos:i}=e.viewModel;return r==="loading"||i.length>0?Q("div",{key:this._buildKey("attachments-element",t),class:this.classes(tn.contentElement)},e.render()):null}renderRelationship(t){const e=this._contentWidgets[t];return e&&!e.destroyed&&this.flowItems?Q("div",{key:this._buildKey("relationship-element",t),class:tn.contentElement},e.render()):null}renderExpression(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:Q("div",{key:this._buildKey("expression-element",t),class:tn.contentElement},e.render())}renderCustom(t,e){const{creator:r}=t,i=this._contentWidgets[e];return!i||i.destroyed?null:r?Q("div",{key:this._buildKey("custom-element",e),class:tn.contentElement},i.render()):null}renderFields(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:Q("div",{key:this._buildKey("fields-element",t),class:tn.contentElement},e.render())}renderMedia(t){const e=this._contentWidgets[t];return!e||e.destroyed?null:Q("div",{key:this._buildKey("media-element",t),class:tn.contentElement},e.render())}renderLastEditInfo(){const{visibleElements:t,messages:e}=this,{lastEditInfo:r}=this.viewModel;if(!r||!t.lastEditedInfo)return null;const{date:i,user:s}=r,n=r.type==="edit"?s?e.lastEditedByUser:e.lastEdited:s?e.lastCreatedByUser:e.lastCreated,o=Of(n,{date:i,user:s});return Q("div",{key:"edit-info-element",class:this.classes(tn.lastEditedInfo,tn.contentElement)},o)}renderText(t,e){const r=t.text,i=this._contentWidgets[e];return!i||i.destroyed?null:r?Q("div",{key:this._buildKey("text-element",e),class:this.classes(tn.contentElement,tn.text)},i.render()):null}_buildKey(t,...e){return`${t}__${this.get("viewModel.graphic.uid")||"0"}-${e.join("-")}`}_destroyContentWidget(t){t&&(t.viewModel=null,!t.destroyed&&t.destroy())}_destroyContentWidgets(){this.removeHandles(lse),this._contentWidgets.forEach(t=>this._destroyContentWidget(t)),this._contentWidgets=[]}_addFeatureRelationshipHandles(t){const{flowItems:e,visibleElements:r}=this;this.addHandles([an(()=>t,"select-record",({featureViewModel:i})=>{e&&(i.abilities={relationshipContent:!0},e.push(new Tj({flowItems:e,viewModel:i,visibleElements:r})))}),an(()=>t,"show-all-records",()=>{if(!e)return;const{viewModel:i}=t;i.showAllEnabled=!0;const s=new ise({visibleElements:{title:!1,description:!1},viewModel:i});this._addFeatureRelationshipHandles(s),e.push(s)})],lse)}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:t,visibleElements:e}=this,r=this.get("viewModel.content"),{contentViewModels:i}=this.viewModel;if(Array.isArray(r))r.forEach((s,n)=>{if(s.type==="attachments"&&(this._contentWidgets[n]=new gze({displayType:s.displayType,headingLevel:e.title?t+1:t,viewModel:i[n]})),s.type==="fields"&&(this._contentWidgets[n]=new F_e({viewModel:i[n]})),s.type==="media"&&(this._contentWidgets[n]=new Tve({viewModel:i[n]})),s.type==="text"&&(this._contentWidgets[n]=new cD({viewModel:i[n]})),s.type==="custom"&&(this._contentWidgets[n]=new cD({viewModel:i[n]})),s.type==="expression"&&(this._contentWidgets[n]=new mYe({viewModel:i[n]})),s.type==="relationship"){const o=new ise({viewModel:i[n]});this._addFeatureRelationshipHandles(o),this._contentWidgets[n]=o}},this);else{const s=i[0];s&&!s.destroyed&&(this._contentWidgets[0]=new cD({viewModel:s}))}this.scheduleRender()}};u([d()],xo.prototype,"graphic",null),u([d()],xo.prototype,"defaultPopupTemplateEnabled",null),u([d()],xo.prototype,"flowItems",void 0),u([d()],xo.prototype,"headingLevel",void 0),u([d({readOnly:!0})],xo.prototype,"isTable",null),u([d()],xo.prototype,"label",null),u([d(),rl("esri/widgets/Feature/t9n/Feature")],xo.prototype,"messages",void 0),u([d(),rl("esri/t9n/common")],xo.prototype,"messagesCommon",void 0),u([d(),rl("esri/widgets/support/t9n/uriUtils")],xo.prototype,"messagesURIUtils",void 0),u([d()],xo.prototype,"spatialReference",null),u([d({readOnly:!0})],xo.prototype,"title",null),u([d()],xo.prototype,"visibleElements",void 0),u([Gt("visibleElements")],xo.prototype,"castVisibleElements",null),u([d()],xo.prototype,"map",null),u([d()],xo.prototype,"view",null),u([d({type:EZ})],xo.prototype,"viewModel",void 0),xo=Tj=u([P("esri.widgets.Feature")],xo);const _Ye=xo;var Sbe;const LD=Symbol("anchorHandles");let ib=class extends Fs.EventedAccessor{constructor(e){super(e),this[Sbe]=new Zr,this.location=null,this.screenLocationEnabled=!1,this.view=null,this[LD].add([ra(()=>ao(this.screenLocationEnabled?this.view:null,r=>[r.size,r.type==="3d"?r.camera:r.viewpoint]),()=>this.notifyChange("screenLocation")),ne(()=>this.screenLocation,(r,i)=>{v(r)&&v(i)&&this.emit("view-change")})])}destroy(){this.view=null,this[LD]=Ve(this[LD])}get screenLocation(){var s;const{location:e,view:r,screenLocationEnabled:i}=this;return i&&v(e)&&v(r)&&r.ready?(s=r.toScreen)==null?void 0:s.call(r,e):null}};Sbe=LD,u([d()],ib.prototype,"location",void 0),u([d()],ib.prototype,"screenLocation",null),u([d()],ib.prototype,"screenLocationEnabled",void 0),u([d()],ib.prototype,"view",void 0),ib=u([P("esri.widgets.support.AnchorElementViewModel")],ib);const Ebe=ib,vYe="esri.widgets.CompassViewModel";let DD=class extends Ebe{constructor(e){super(e),this.visible=!1}};u([d()],DD.prototype,"visible",void 0),DD=u([P(vYe)],DD);const Cbe=DD,k8="esri-spinner",z8={base:k8,spinnerStart:`${k8}--start`,spinnerFinish:`${k8}--finish`};let sb=class extends Ma{constructor(e,r){super(e,r),this._animationDelay=500,this._animationPromise=null,this.viewModel=new Cbe}initialize(){this.addHandles(ne(()=>this.visible,e=>this._visibleChange(e)))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}show(e){const{location:r,promise:i}=e??{};r&&(this.viewModel.location=r),this.visible=!0;const s=()=>this.hide();i&&i.catch(()=>{}).then(s)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:r}=this.viewModel,i=!!r,s=e&&i,n=!e&&i,o={[z8.spinnerStart]:s,[z8.spinnerFinish]:n},a=this._getPositionStyles();return Q("div",{class:this.classes(z8.base,o),styles:a})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const r=_w(this._animationDelay);this._animationPromise=r,r.catch(()=>{}).then(()=>{this._animationPromise===r&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:r}=this.viewModel;if(C(r)||C(e))return{};const{padding:i}=r;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};u([d()],sb.prototype,"location",null),u([d()],sb.prototype,"view",null),u([d({type:Cbe})],sb.prototype,"viewModel",void 0),u([d()],sb.prototype,"visible",null),sb=u([P("esri.widgets.Spinner")],sb);const bYe=sb,o6={iconZoom:"esri-icon-zoom-in-magnifying-glass",iconTrash:"esri-icon-trash",iconBrowseClusteredFeatures:"esri-icon-table"},Yb=new qE({id:"zoom-to-feature",title:"{messages.zoom}",className:o6.iconZoom}),cse=new qE({id:"remove-selected-feature",title:"{messages.remove}",className:o6.iconTrash}),B2=new qE({id:"zoom-to-clustered-features",title:"{messages.zoom}",className:o6.iconZoom}),G2=new qE({id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:o6.iconBrowseClusteredFeatures}),wYe="esri.widgets.Popup.PopupViewModel",jF=se.getLogger(wYe),xYe=t=>{const{event:e,view:r}=t,{action:i}=e,s=r&&r.popup;if(!i)return Promise.reject(new j("trigger-action:missing-arguments","Event has no action"));if(!s)return Promise.reject(new j("trigger-action:missing-arguments","view.popup is missing"));const{disabled:n,id:o}=i;if(!o)return Promise.reject(new j("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new j("trigger-action:invalid-action","Action is disabled"));if(o===Yb.id)return SYe(s.viewModel).catch(Lk);if(o===B2.id)return EYe(s.viewModel);if(o===G2.id)return s.featureMenuOpen=!s.featureMenuOpen,s.viewModel.browseClusterEnabled=!s.viewModel.browseClusterEnabled,Promise.resolve();if(s.viewModel.browseClusterEnabled=!1,o===cse.id){s.close();const{selectedFeature:a}=s;if(!a)return Promise.reject(new j(`trigger-action:${cse.id}`,"selectedFeature is required",{selectedFeature:a}));const{sourceLayer:l}=a;return l?l.remove(a):r.graphics.remove(a),Promise.resolve()}return Promise.resolve()};function Abe(t){const{selectedFeature:e,location:r,view:i}=t;return i?i.type==="3d"?e??r??null:t.get("selectedFeature.geometry")||r:null}function Pb(t){var e,r;return!!t&&t.isAggregate&&((r=(e=t.sourceLayer)==null?void 0:e.featureReduction)==null?void 0:r.type)==="cluster"}async function TYe(t,e){if((e==null?void 0:e.type)!=="3d"||!t||t.declaredClass!=="esri.Graphic")return!0;const r=e.getViewForGraphic(t);if(r&&"whenGraphicBounds"in r){let i;try{i=await r.whenGraphicBounds(t,{useViewElevation:!0})}catch{}return!i||!i.boundingBox||i.boundingBox[0]===i.boundingBox[3]&&i.boundingBox[1]===i.boundingBox[4]&&i.boundingBox[2]===i.boundingBox[5]}return!0}async function SYe(t){var h;const{location:e,selectedFeature:r,view:i,zoomFactor:s}=t,n=Abe(t);if(!i||!n){const p=new j("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:i});throw jF.error(p),p}const o=i.scale/s,a=(h=t.selectedFeature)==null?void 0:h.geometry,l=a??e,c=v(l)&&l.type==="point"&&await TYe(r,i);Yb.active=!0,Yb.disabled=!0;try{await t.zoomTo({target:{target:n,scale:c?o:void 0}})}catch{const f=new j("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:r});jF.error(f)}finally{Yb.active=!1,Yb.disabled=!1,t.zoomToLocation=null,c&&(t.location=l)}}async function EYe(t){const{selectedFeature:e,view:r}=t;if((r==null?void 0:r.type)!=="2d"){const o=new j("zoomToCluster:invalid-view","View must be 2d MapView.",{view:r});throw jF.error(o),o}if(!e||!Pb(e)){const o=new j("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw jF.error(o),o}const[i,s]=await CZ(r,e);B2.active=!0,B2.disabled=!0;const{extent:n}=await i.queryExtent(s);await t.zoomTo({target:n}),B2.active=!1,B2.disabled=!1}async function CYe(t){const{view:e,selectedFeature:r}=t;if(!e||!r)return;const[i,s]=await CZ(e,r),{extent:n}=await i.queryExtent(s);t.selectedClusterBoundaryFeature.geometry=n,e.graphics.add(t.selectedClusterBoundaryFeature)}async function AYe(t){var o;const{selectedFeature:e,view:r}=t;if(!r||!e)return;const[i,s]=await CZ(r,e);G2.active=!0,G2.disabled=!0;const{features:n}=await i.queryFeatures(s);G2.active=!1,G2.disabled=!1,(o=r.popup)==null||o.open({features:[e].concat(n),featureMenuOpen:!0})}async function CZ(t,e){const r=await t.whenLayerView(e.sourceLayer),i=r.createQuery(),s=e.getObjectId();return i.aggregateIds=s!=null?[s]:[],[r,i]}function RYe(t){const e=t.features.filter(r=>Pb(r));e.length&&(t.features=e)}function Rbe(t){var e;if(C(t))return null;switch(t.type){case"point":return t;case"extent":return t.center;case"polygon":return t.centroid;case"multipoint":case"polyline":return(e=t.extent)==null?void 0:e.center;default:return null}}const Nt="esri-popup",jC=`${Nt}__header`,jv=`${Nt}--is-docked`,Ae={calciteThemeLight:"calcite-mode-light",calciteThemeDark:"calcite-mode-dark",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:Nt,widget:"esri-widget",main:`${Nt}__main-container`,loadingContainer:`${Nt}__loading-container`,isCollapsible:`${Nt}--is-collapsible`,isCollapsed:`${Nt}--is-collapsed`,shadow:`${Nt}--shadow`,isDocked:jv,isDockedTopLeft:`${jv}-top-left`,isDockedTopCenter:`${jv}-top-center`,isDockedTopRight:`${jv}-top-right`,isDockedBottomLeft:`${jv}-bottom-left`,isDockedBottomCenter:`${jv}-bottom-center`,isDockedBottomRight:`${jv}-bottom-right`,alignTopCenter:`${Nt}--aligned-top-center`,alignBottomCenter:`${Nt}--aligned-bottom-center`,alignTopLeft:`${Nt}--aligned-top-left`,alignBottomLeft:`${Nt}--aligned-bottom-left`,alignTopRight:`${Nt}--aligned-top-right`,alignBottomRight:`${Nt}--aligned-bottom-right`,isFeatureMenuOpen:`${Nt}--feature-menu-open`,isActionsMenuOpen:`${Nt}--actions-menu-open`,hasFeatureUpdated:`${Nt}--feature-updated`,header:jC,headerButtons:`${jC}-buttons`,headerContainer:`${jC}-container`,headerContainerButton:`${jC}-container--button`,headerTitle:`${jC}-title`,content:`${Nt}__content`,contentHasFlows:"esri-content--has-flows",contentFlowItem:"esri-content__flow-item",footer:`${Nt}__footer`,footerHasPagination:`${Nt}__footer--has-pagination`,footerHasActions:`${Nt}__footer--has-actions`,footerHasActionsMenu:`${Nt}__footer--has-actions-menu`,button:`${Nt}__button`,buttonDisabled:`${Nt}__button--disabled`,buttonDock:`${Nt}__button--dock`,icon:`${Nt}__icon`,iconDock:`${Nt}__icon--dock-icon`,inlineActionsContainer:`${Nt}__inline-actions-container`,actionsMenuButton:`${Nt}__actions-menu-button`,actions:`${Nt}__actions`,action:`${Nt}__action`,actionImage:`${Nt}__action-image`,actionText:`${Nt}__action-text`,actionToggle:`${Nt}__action-toggle`,actionToggleOn:`${Nt}__action-toggle--on`,actionExit:`${Nt}__action--exit`,actionSelectFeature:`${Nt}__action--select-feature`,pointer:`${Nt}__pointer`,pointerDirection:`${Nt}__pointer-direction`,navigation:`${Nt}__navigation`,paginationPrevious:`${Nt}__pagination-previous`,paginationNext:`${Nt}__pagination-next`,paginationPreviousIconLTR:`${Nt}__pagination-previous-icon`,paginationPreviousIconRTL:`${Nt}__pagination-previous-icon--rtl`,paginationNextIconLTR:`${Nt}__pagination-next-icon`,paginationNextIconRTL:`${Nt}__pagination-next-icon--rtl`,featureMenu:`${Nt}__feature-menu`,featureMenuList:`${Nt}__feature-menu-list`,featureMenuItem:`${Nt}__feature-menu-item`,featureMenuViewport:`${Nt}__feature-menu-viewport`,featureMenuHeader:`${Nt}__feature-menu-header`,featureMenuNote:`${Nt}__feature-menu-note`,featureMenuSelected:`${Nt}__feature-menu-item--selected`,featureMenuButton:`${Nt}__feature-menu-button`,featureMenuTitle:`${Nt}__feature-menu-title`,featureMenuObserver:`${Nt}__feature-menu-observer`,featureMenuLoader:`${Nt}__feature-menu-loader`,collapseButton:`${Nt}__collapse-button`,collapseIcon:`${Nt}__collapse-icon`};var Uw;(function(t){t[t.size=22]="size",t[t.lineWidth=50]="lineWidth",t[t.maxSize=120]="maxSize",t[t.maxOutlineSize=80]="maxOutlineSize",t[t.tallSymbolWidth=20]="tallSymbolWidth"})(Uw||(Uw={}));function Obe(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function OYe(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function MYe(t,e,r,i,s,n){const o=new Float32Array(6);return o[0]=t,o[1]=e,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o}function PYe(t,e){return new Float32Array(t,e,6)}function Mbe(t,e,r,i){const s=e[i],n=e[i+1];t[i]=r[0]*s+r[2]*n+r[4],t[i+1]=r[1]*s+r[3]*n+r[5]}function IYe(t,e,r,i=0,s=0,n=2){const o=s||e.length/n;for(let a=i;a<o;a++)Mbe(t,e,r,a*n)}Object.freeze(Object.defineProperty({__proto__:null,clone:OYe,create:Obe,createView:PYe,fromValues:MYe,transform:Mbe,transformMany:IYe},Symbol.toStringTag,{value:"Module"}));function $Ye(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function LYe(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function DYe(t,e,r,i,s,n,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t}function Pbe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5];let l=r*n-i*s;return l?(l=1/l,t[0]=n*l,t[1]=-i*l,t[2]=-s*l,t[3]=r*l,t[4]=(s*a-n*o)*l,t[5]=(i*o-r*a)*l,t):null}function NYe(t){return t[0]*t[3]-t[1]*t[2]}function Ibe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1],p=r[2],f=r[3],m=r[4],y=r[5];return t[0]=i*c+n*h,t[1]=s*c+o*h,t[2]=i*p+n*f,t[3]=s*p+o*f,t[4]=i*m+n*y+a,t[5]=s*m+o*y+l,t}function AZ(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=Math.sin(r),h=Math.cos(r);return t[0]=i*h+n*c,t[1]=s*h+o*c,t[2]=i*-c+n*h,t[3]=s*-c+o*h,t[4]=a,t[5]=l,t}function $be(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1];return t[0]=i*c,t[1]=s*c,t[2]=n*h,t[3]=o*h,t[4]=a,t[5]=l,t}function RZ(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1];return t[0]=i,t[1]=s,t[2]=n,t[3]=o,t[4]=i*c+n*h+a,t[5]=s*c+o*h+l,t}function FYe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t[4]=0,t[5]=0,t}function UYe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function OZ(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function VYe(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function kYe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function zYe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t}function Lbe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t}function BYe(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t}function GYe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t}function jYe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function HYe(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=e[0],c=e[1],h=e[2],p=e[3],f=e[4],m=e[5],y=Oa();return Math.abs(r-l)<=y*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=y*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-h)<=y*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=y*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=y*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-m)<=y*Math.max(1,Math.abs(a),Math.abs(m))}const qYe=Ibe,WYe=Lbe;Object.freeze(Object.defineProperty({__proto__:null,add:zYe,copy:$Ye,determinant:NYe,equals:HYe,exactEquals:jYe,frob:kYe,fromRotation:FYe,fromScaling:UYe,fromTranslation:OZ,identity:LYe,invert:Pbe,mul:qYe,multiply:Ibe,multiplyScalar:BYe,multiplyScalarAndAdd:GYe,rotate:AZ,scale:$be,set:DYe,str:VYe,sub:WYe,subtract:Lbe,translate:RZ},Symbol.toStringTag,{value:"Module"}));const use=de("android");de("chrome")||use&&use>=4;F7();function BRt(t){return t=t||globalThis.location.hostname,YYe.some(e=>(t==null?void 0:t.match(e))!=null)}function XYe(t,e){return t&&(e=e||globalThis.location.hostname)?e.match(Dbe)!=null||e.match(Fbe)!=null?t.replace("static.arcgis.com","staticdev.arcgis.com"):e.match(Nbe)!=null||e.match(Ube)!=null?t.replace("static.arcgis.com","staticqa.arcgis.com"):t:t}const Dbe=/^devext.arcgis.com$/,Nbe=/^qaext.arcgis.com$/,Fbe=/^[\w-]*\.mapsdevext.arcgis.com$/,Ube=/^[\w-]*\.mapsqa.arcgis.com$/,YYe=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,Dbe,Nbe,/^jsapps.esri.com$/,Fbe,Ube];Uw.size;Uw.maxSize;Uw.maxOutlineSize;Uw.lineWidth;Uw.tallSymbolWidth;function Vbe(t){return t&&"opacity"in t?t.opacity*Vbe(t.parent):1}async function ZYe(t,e){if(!t)return;const r=t.sourceLayer,i=(v(e)&&e.useSourceLayer?r:t.layer)??r,s=Vbe(i);if(v(t.symbol)&&(!v(e)||e.ignoreGraphicSymbol!==!0)){const b=t.symbol.type==="web-style"?await PBe(t.symbol,{...e,cache:v(e)?e.webStyleCache:null}):t.symbol.clone();return n8(b,null,s),b}const n=(v(e)?e.renderer:null)??(i&&"renderer"in i?i.renderer:null);let o=n&&"getSymbolAsync"in n?await n.getSymbolAsync(t,e):null;if(!o)return;if(o=o.type==="web-style"?await o.fetchSymbol({...e,cache:v(e)?e.webStyleCache:null}):o.clone(),!(n&&"visualVariables"in n&&n.visualVariables&&n.visualVariables.length))return n8(o,null,s),o;if("arcadeRequiredForVisualVariables"in n&&n.arcadeRequiredForVisualVariables&&(C(e)||C(e.arcade))){const b={...e};b.arcade=await dm(),e=b}const a=await ie(()=>Promise.resolve().then(()=>oZ),void 0,import.meta.url),l=[],c=[],h=[],p=[];for(const b of n.visualVariables)switch(b.type){case"color":l.push(b);break;case"opacity":c.push(b);break;case"rotation":p.push(b);break;case"size":b.target||h.push(b)}const f=!!l.length&&l[l.length-1],m=f?a.getColor(f,t,e):null,y=!!c.length&&c[c.length-1];let _=y?a.getOpacity(y,t,e):null;if(s!=null&&(_=_!=null?_*s:s),n8(o,m,_),h.length){const b=a.getAllSizes(h,t,e);await OBe(o,b)}for(const b of p)MBe(o,a.getRotationAngle(b,t,e),b.axis);return o}let cy=class{constructor(e,r){this._owner=r,this._properties={},this._afterDispatchHandle=null;for(const i in e){const s=e[i],n=new gde(s,void 0,void 0,2,2);this._properties[i]={pool:n,acquired:[]}}this._afterDispatchHandle=Rde(()=>this._release())}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const r=this._properties[e];for(const i of r.acquired)MQ(i)||r.pool.release(i);r.pool.destroy(),r.pool=null,r.acquired=null}this._properties=null,this._owner=null}get(e){const r=this._owner._get(e),i=this._properties[e];let s=i.pool.acquire();for(i.acquired.push(s);s===r;)i.acquired.push(s),s=i.pool.acquire();return s}_release(){for(const e in this._properties){const r=this._properties[e];let i=0;for(const s of r.acquired)MQ(s)?r.acquired[i++]=s:r.pool.release(s);r.acquired.length=i}}};const JYe=de("mac")?"Meta":"Ctrl",a6={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let t=48;t<58;t++)a6[t]=String.fromCharCode(t);for(let t=1;t<25;t++)a6[111+t]=`F${t}`;for(let t=65;t<91;t++)a6[t]=[String.fromCharCode(t+32),String.fromCharCode(t)];function KYe(t){if(t.key!==void 0)return Sb(t);const e=a6[t.keyCode];return Array.isArray(e)?t.shiftKey?e[1]:e[0]:e}function QYe(t){switch(t){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}let eZe=class{constructor(e,r=[]){this.eventType=e,this.keyModifiers=r}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const r=e.modifiers;for(const i of this.keyModifiers)if(!r.has(i))return!1;return!0}};const hse=se.getLogger("esri.views.input.InputHandler");let Fo=class{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const r=this._incoming[e];for(const i of r)this._incomingEventMatches.push(i.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager?hse.error("This InputHandler has already been registered with an InputManager"):(e.setEventCallback(r=>this._handleEvent(r)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,r,i){let s;typeof r=="function"?(i=r,s=[]):s=r||[];const n=typeof e=="string"?new eZe(e,s):e,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new tZe(n,i,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&!p.includes(h)&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const r=new rZe(e,{onEmit:(i,s,n,o)=>{var a;(a=this._manager)==null||a.emit(i.eventType,s,n,o)},onRemove:i=>{var s;delete this._outgoing[i.eventType],(s=this._manager)==null||s.updateDependencies()}});return this._outgoing[e]=r,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),r}startCapturingPointer(e){var r;(r=this._manager)==null||r.setPointerCapture(e,!0)}stopCapturingPointer(e){var r;(r=this._manager)==null||r.setPointerCapture(e,!1)}refreshHasPendingInputs(){var e;(e=this._manager)==null||e.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):hse.error("This InputHandler is not registered with an InputManager")}_handleEvent(e){var i;const r=this._incoming[e.type];if(r){for(const s of r)if(s.match.matches(e)&&((i=s.callback)==null||i.call(s,e),e.shouldStopPropagation()))break}}},tZe=class{constructor(e,r,i){this.match=e,this._callback=r,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}},rZe=class{constructor(e,r){this.eventType=e,this._removed=!1,this._handler=r}emit(e,r,i){this._removed||this._handler.onEmit(this,e,r,i)}remove(){this._removed=!0,this._handler.onRemove(this)}},iZe=class extends Fo{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this.registerIncoming("pointer-move",r=>{this._update(r.data)})}_update(e){const r=e.native.pointerType==="touch"?"touch":"mouse",{x:i,y:s}=e;r===this._value&&this._x===i&&this._y===s||(this._value=r,this._x=i,this._y=s,this._onChange(r,i,s))}},sZe=class extends Fo{get multiTouchActive(){return this._multiTouchActive.get()}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=new xF(!1),this._onPointerAdd=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.set(this._activeTouchPointerIds.size>1)}},gf=class extends Te{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=JYe,this._latestPointerType="mouse",this._propertiesPool=new cy({latestPointerLocation:aZe},this),this.latestPointerLocation=null,this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const r of e)this.uninstallHandlers(r);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}get latestPointerType(){return this._latestPointerType}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}installHandlers(e,r,i=j_.INTERNAL){if(this._nameToGroup[e])return void se.getLogger(this.declaredClass).error("There is already an InputHandler group registered under the name `"+e+"`");if(r.length===0)return void se.getLogger(this.declaredClass).error("Can't register a group of zero handlers");const s={name:e,handlers:r.map(n=>({handler:n,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=s;for(let n=s.handlers.length-1;n>=0;n--){const o=s.handlers[n];this._handlers.push(o),o.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(a,l,c,h,p)=>{this._emitInputEvent(o.priorityIndex+1,a,l,c,p,h)},setPointerCapture:(a,l)=>{this._setPointerCapture(s,o,a,l)},setEventCallback:a=>{o.eventCallback=a},setUninstallCallback:a=>{o.uninstallCallback=a},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const r=this._nameToGroup[e];r?(r.handlers.forEach(i=>{var s;i.removed=!0,(s=i.uninstallCallback)==null||s.call(i)}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):se.getLogger(this.declaredClass).error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,r=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const s=this._handlers[i];s.priorityIndex=i,this._handlersPriority.push(s)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const s=this._handlersPriority[i];s.priorityIndex=i;let n=s.handler.hasSideEffects;if(!n){for(const o of s.handler.outgoingEventTypes)if(e.has(o)){n=!0;break}}if(n)for(const o of s.handler.incomingEventMatches){e.add(o.eventType);for(const a of o.keyModifiers)QYe(a)||r.add(a)}s.active=n}this._sourceEvents=e,this._keyModifiers=r,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,r,i){this._latestPointerType=e;const s=this._get("latestPointerLocation");if(C(s)||s.x!==r||s.y!==i){const n=this._propertiesPool.get("latestPointerLocation");n.x=r,n.y=i,this._set("latestPointerLocation",n)}}_onEventReceived(e,r){if(e==="pointer-capture-lost"){const n=r;this._pointerCaptures.delete(n.native.pointerId)}this._updateKeyModifiers(e,r);const i=this.test.timestamp!=null?this.test.timestamp:r.native?r.native.timestamp:void 0,s=r.native?r.native.cancelable:void 0;this._emitInputEventFromSource(e,r,i,s)}_updateKeyModifiers(e,r){if(!r)return;let i=!1;const s=()=>{if(!i){const a=new Set;this._activeKeyModifiers.forEach(l=>{a.add(l)}),this._activeKeyModifiers=a,i=!0}},n=(a,l)=>{l&&!this._activeKeyModifiers.has(a)?(s(),this._activeKeyModifiers.add(a)):!l&&this._activeKeyModifiers.has(a)&&(s(),this._activeKeyModifiers.delete(a))};if(e==="key-down"||e==="key-up"){const a=r.key;this._keyModifiers.has(a)&&n(a,e==="key-down")}const o=r.native;n("Alt",!(!o||!o.altKey)),n("Ctrl",!(!o||!o.ctrlKey)),n("Shift",!(!o||!o.shiftKey)),n("Meta",!(!o||!o.metaKey)),n("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new iZe((e,r,i)=>this._setLatestPointer(e,r,i)),this._multiTouchHandler=new sZe,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],j_.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,j_.INTERNAL)}_setPointerCapture(e,r,i,s){const n=e.name+"-"+r.priorityIndex,o=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,o),s?(o.add(n),o.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):o.has(n)&&(o.delete(n),o.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,r,i,s){this._emitInputEvent(0,e,r,i,s)}_emitInputEvent(e,r,i,s,n,o){const a=s!==void 0?s:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),l=n!==void 0&&n,c={event:new nZe(r,i,a,o||this._activeKeyModifiers,l),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(c):this._doNewPropagation(c)}_doNewPropagation(e){this._currentPropagation={events:new M7,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){var r,i;const e=Fl(this._currentPropagation);for(;e.events.length>0;){const{event:s,priorityIndex:n}=e.events.pop(),o=s.data&&s.data.eventId;if(!(o!=null&&this._stoppedPropagationEventIds.has(o)))for(e.currentHandler=this._handlersPriority[n];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!s.shouldStopPropagation()&&((i=(r=e.currentHandler).eventCallback)==null||i.call(r,s)),s.shouldStopPropagation()){o!=null&&this._stoppedPropagationEventIds.add(o);break}if(s.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:s,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}_pausePropagation(e){const r=new M7;r.push(e);const i=this._currentPropagation;if(i){for(;i.events.length;)r.push(i.events.pop());i.events=r,i.currentHandler=null}}_compareHandlerPriority(e,r){if(e.handler.hasSideEffects!==r.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==r.groupPriority)return e.groupPriority>r.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const s of r.handler.incomingEventMatches){if(i.eventType!==s.eventType)continue;const n=i.keyModifiers.filter(o=>s.keyModifiers.includes(o));if(n.length===i.keyModifiers.length!=(n.length===s.keyModifiers.length))return i.keyModifiers.length>s.keyModifiers.length?-1:1}return e.priorityIndex>r.priorityIndex?-1:1}_sortHandlersPriority(e){const r=[];for(const i of e){let s=0;for(;s<r.length&&this._compareHandlerPriority(i,r[s])>=0;)s++;r.splice(s,0,i)}return r}get debug(){const e=r=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},r(),this._setPointerCapture=i};return{injectEvent:(r,i)=>{e(()=>{this._onEventReceived(r,i)})},disablePointerCapture:e}}};u([d({readOnly:!0})],gf.prototype,"hasPendingInputs",null),u([d({constructOnly:!0})],gf.prototype,"eventSource",void 0),u([d({constructOnly:!0})],gf.prototype,"recognizers",void 0),u([d()],gf.prototype,"_latestPointerType",void 0),u([d()],gf.prototype,"latestPointerType",null),u([d()],gf.prototype,"multiTouchActive",null),u([d({readOnly:!0})],gf.prototype,"latestPointerLocation",void 0),gf=u([P("esri.views.input.InputManager")],gf);let nZe=class{constructor(e,r,i,s,n){this.type=e,this.data=r,this.timestamp=i,this.modifiers=s,this.cancelable=n,this._propagationState=l_.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=l_.STOPPED}shouldStopPropagation(){return(this._propagationState&l_.STOPPED)!=0}async(e){this._propagationState|=l_.PAUSED;const r=(i,s)=>{this._propagationState&=~l_.PAUSED;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw i;return i};return(typeof e=="function"?e():e).then(i=>r(i,!1),i=>r(i,!0))}shouldPausePropagation(e){return!!(this._propagationState&l_.PAUSED)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}};var l_;(function(t){t[t.NONE=0]="NONE",t[t.STOPPED=1]="STOPPED",t[t.PAUSED=2]="PAUSED"})(l_||(l_={}));const j_={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};let oZe=class{};const aZe=oZe;function dse(t){return t&&typeof t.highlight=="function"}function lZe(t){return t&&typeof t.maskOccludee=="function"}function QRt(t,e,r){return C(t)||t>r&&(e===0||t<e)}function eOt(t,e){return v(t)&&t>0||v(e)&&e>0}function tOt(t){const e=t.effectiveScaleRange;return{minScale:(e==null?void 0:e.minScale)??0,maxScale:(e==null?void 0:e.maxScale)??0}}const kbe=t=>{let e=class extends t{constructor(...r){super(...r),this.goToOverride=null,this.view=null}callGoTo(r){const{view:i}=this;return z4(i),this.goToOverride?this.goToOverride(i,r):i.goTo(r.target,r.options)}};return u([d()],e.prototype,"goToOverride",void 0),u([d()],e.prototype,"view",void 0),e=u([P("esri.widgets.support.GoTo")],e),e},PO=ft.ofType({key:"type",defaultKeyValue:"button",base:m5,typeMap:{button:qE,toggle:Jme}}),cZe=()=>[Yb.clone()],uZe=()=>[B2.clone(),G2.clone()];let zr=class extends kbe(Ebe){get isLoadingFeature(){return this.featureViewModels.some(e=>e.waitingForContent)}constructor(e){super(e),this._handles=new Zr,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._highlightSelectedFeaturePromise=null,this._highlightActiveFeaturePromise=null,this._selectedClusterFeature=null,this.featurePage=null,this.actions=new PO,this.activeFeature=null,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featuresPerPage=20,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new Sa({symbol:new Cv({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}initialize(){this._handles.add([ne(()=>[this.autoOpenEnabled,this.view],()=>this._autoOpenEnabledChange()),this.on("view-change",()=>this._autoClose()),ne(()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view],()=>this._highlightSelectedFeature()),ne(()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view],()=>this._highlightActiveFeature()),ne(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.animation)==null?void 0:r.state},e=>this._animationStateChange(e)),ne(()=>this.location,e=>this._locationChange(e)),ne(()=>this.selectedFeature,e=>this._selectedFeatureChange(e)),ne(()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage],()=>this._selectedFeatureIndexChange()),ne(()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels],()=>this._setGraphicOnFeatureViewModels()),ne(()=>this.featureViewModels,()=>this._featureViewModelsChange()),this.on("trigger-action",e=>xYe({event:e,view:this.view})),ra(()=>!this.waitingForResult,()=>this._waitingForResultChange(),ri),ne(()=>{var e,r;return[this.features,(e=this.view)==null?void 0:e.map,(r=this.view)==null?void 0:r.spatialReference]},()=>this._updateFeatureVMs()),ne(()=>{var e;return(e=this.view)==null?void 0:e.scale},()=>this._viewScaleChange()),ra(()=>!this.visible,()=>this.browseClusterEnabled=!1),ne(()=>this.browseClusterEnabled,e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new PO;e.removeAll();const{actions:r,defaultActions:i,defaultPopupTemplateEnabled:s,includeDefaultActions:n,selectedFeature:o}=this,a=n?i.concat(r):r,l=o&&(typeof o.getEffectivePopupTemplate=="function"&&o.getEffectivePopupTemplate(s)||o.popupTemplate),c=l&&l.actions,h=l&&l.overwriteActions?c:c?c.concat(a):a;return h&&h.filter(Boolean).forEach(p=>e.add(p)),e}get defaultActions(){const e=this._get("defaultActions")||new PO;return e.removeAll(),e.addMany(Pb(this.selectedFeature)?uZe():cZe()),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const r=e||[];this._set("features",r);const{pendingPromisesCount:i,promiseCount:s,selectedFeatureIndex:n}=this,o=s&&r.length;o&&i&&n===-1?this.selectedFeatureIndex=0:o&&n!==-1||(this.selectedFeatureIndex=r.length?0:-1)}get location(){return this._get("location")||null}set location(e){var s,n,o;let r=e;const i=(n=(s=this.view)==null?void 0:s.spatialReference)==null?void 0:n.isWebMercator;e&&((o=e==null?void 0:e.spatialReference)!=null&&o.isWGS84)&&i&&(r=jg(e)),this._set("location",r)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach(r=>{this._pendingPromises.add(r);const i=n=>{this._pendingPromises.has(r)&&this._updateFeatures(n),this._updatePendingPromises(r)},s=()=>this._updatePendingPromises(r);r.then(i,s)}),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:r}=this;return r===-1?null:e[r]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:r}=this;e=isNaN(e)||e<-1||!r?-1:(e+r)%r,this.activeFeature=null,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,r=Abe(this);return r&&e?this.callGoTo({target:{target:r,scale:e.scale}}):Promise.reject(new j("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:r,view:e}))}zoomTo(e){return this.callGoTo(e)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(e,r){const{view:i}=this;if(!i||!e)throw new j("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return i.fetchPopupFeatures(e,{event:r&&r.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:r&&r.signal})}open(e){const r={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:i}=r;delete r.fetchFeatures,i&&this._setFetchFeaturesPromises(r.location);const s=["actionsMenuOpen","collapsed","featureMenuOpen"];for(const n of s)delete r[n];this.set(r)}triggerAction(e){const r=this.allActions.getItemAt(e);r&&!r.disabled&&this.emit("trigger-action",{action:r})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){RYe(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:e,selectedFeature:r}=this;(e==null?void 0:e.type)==="2d"?Pb(r)?(await CYe(this),await AYe(this)):se.getLogger(this.declaredClass).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",r):se.getLogger(this.declaredClass).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",r)}_animationStateChange(e){this.zoomToLocation||(Yb.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){var r;const e=(r=this.view)==null?void 0:r.graphics;e&&(e.remove(this.selectedClusterBoundaryFeature),this._selectedClusterFeature&&e.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(Pb(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(e){const{selectedFeature:r,updateLocationEnabled:i}=this;i&&e&&(!r||r.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:r,featurePage:i,featuresPerPage:s,featureViewModels:n}=this;if(i===null)return;const o=((i-1)*s+r)%r,a=o+s;n.slice(o,a).forEach((l,c)=>{l&&!l.graphic&&(l.graphic=e[o+c])})}async _selectedFeatureChange(e){const{location:r,updateLocationEnabled:i,view:s}=this;if(e&&s){if(this.browseClusterEnabled)return this._selectedClusterFeature&&(s.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),Pb(e)?void 0:(e.symbol=await ZYe(e),this._selectedClusterFeature=e,void s.graphics.add(this._selectedClusterFeature));!i&&r||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then(()=>{var o;const n=(o=s.center)==null?void 0:o.clone();n&&(this.location=n)}):this.location=Rbe(e.geometry)}}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then(r=>{const{clientOnlyGraphics:i,promisesPerLayerView:s}=r,n=Promise.resolve(i),o=s.map(a=>a.promise);this.promises=[n,...o]})}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:r,featureViewModels:i}=this;if(Pb(e)||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!r||!r.length)return;const s=i.slice(0),n=[];r.forEach((o,a)=>{var c,h;if(!o)return;let l=null;if(s.some((p,f)=>(p&&p.graphic===o&&(l=p,s.splice(f,1)),!!l)),l)n[a]=l;else{const p=new EZ({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:(c=this.view)==null?void 0:c.spatialReference,graphic:o===e?o:null,map:(h=this.view)==null?void 0:h.map,view:this.view});n[a]=p}}),s.forEach(o=>o&&!o.destroyed&&o.destroy()),this._set("featureViewModels",n)}_getScreenPoint(e){const{view:r}=this;return r&&e&&typeof r.toScreen=="function"?r.toScreen(e):null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:r,autoOpenEnabled:i}=this;if(r.remove(e),i&&this.view){const s=this.view.on("click",n=>{n.pointerType==="mouse"&&n.button!==0||this._fetchFeaturesAndOpen(n)},j_.WIDGET);r.add(s,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,r){this._cancelFetchingFeatures();const i=new AbortController,{signal:s}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const n=this.fetchFeatures(e,{signal:s,event:r});return n.catch(()=>{}).then(()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}),n}_fetchFeaturesAndOpen(e){const{screenPoint:r,mapPoint:i}=e,{view:s}=this;this._fetchFeaturesWithController(r,e).then(n=>{var h;const{clientOnlyGraphics:o,promisesPerLayerView:a,location:l}=n,c=[Promise.resolve(o),...a.map(p=>p.promise)];return(h=s==null?void 0:s.popup)==null||h.open({location:l||i,promises:c}),n})}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(e,r){return await e.when(),e.whenLayerView(r)}_getHighlightLayer(e){const{layer:r,sourceLayer:i}=e;return i&&"layer"in i&&i.layer?i.layer:(i==null?void 0:i.type)==="map-notes"||(i==null?void 0:i.type)==="subtype-group"?i:r}_getHighlightTarget(e,r){const i=r.type==="imagery"?void 0:"objectIdField"in r?r.objectIdField||$0e:null,s=e.attributes;return s&&i&&s[i]||e}async _highlightActiveFeature(){const e="highlight-active-feature";this._handles.remove(e);const{highlightEnabled:r,view:i,activeFeature:s,visible:n}=this;if(!(s&&i&&r&&n))return;const o=this._getHighlightLayer(s);if(!(o&&o instanceof h3))return;const a=this._getLayerView(i,o);this._highlightActiveFeaturePromise=a;const l=await a;if(!(l&&dse(l)&&this._highlightActiveFeaturePromise===a&&this.activeFeature&&this.highlightEnabled))return;const c=l.highlight(this._getHighlightTarget(s,o));this._handles.add(c,e)}async _highlightSelectedFeature(){const e="highlight-selected-feature";this._handles.remove(e);const{selectedFeature:r,highlightEnabled:i,view:s,visible:n}=this;if(!(r&&s&&i&&n))return;const o=this._getHighlightLayer(r);if(!(o&&o instanceof h3))return;const a=this._getLayerView(s,o);this._highlightSelectedFeaturePromise=a;const l=await a;if(!(l&&dse(l)&&this._highlightSelectedFeaturePromise===a&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const c=l.highlight(this._getHighlightTarget(r,o));this._handles.add(c,e)}_updateFeatures(e){const{features:r}=this;if(!e||!e.length)return;if(!r.length)return void(this.features=e);const i=e.filter(s=>!r.includes(s));this.features=r.concat(i)}};u([d()],zr.prototype,"featurePage",void 0),u([d()],zr.prototype,"isLoadingFeature",null),u([d({type:PO})],zr.prototype,"actions",void 0),u([d({readOnly:!0})],zr.prototype,"active",null),u([d()],zr.prototype,"activeFeature",void 0),u([d({readOnly:!0})],zr.prototype,"allActions",null),u([d({type:Boolean})],zr.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],zr.prototype,"autoCloseEnabled",void 0),u([d()],zr.prototype,"autoOpenEnabled",void 0),u([d()],zr.prototype,"browseClusterEnabled",void 0),u([d()],zr.prototype,"content",void 0),u([d({type:PO,readOnly:!0})],zr.prototype,"defaultActions",null),u([d({readOnly:!0})],zr.prototype,"featureCount",null),u([d()],zr.prototype,"features",null),u([d()],zr.prototype,"featuresPerPage",void 0),u([d()],zr.prototype,"featureViewModelAbilities",void 0),u([d({readOnly:!0})],zr.prototype,"featureViewModels",void 0),u([d()],zr.prototype,"highlightEnabled",void 0),u([d()],zr.prototype,"includeDefaultActions",void 0),u([d({type:_t})],zr.prototype,"location",null),u([d({readOnly:!0})],zr.prototype,"pendingPromisesCount",null),u([d({readOnly:!0})],zr.prototype,"selectedClusterBoundaryFeature",void 0),u([d({readOnly:!0})],zr.prototype,"waitingForResult",null),u([d({readOnly:!0})],zr.prototype,"promiseCount",null),u([d()],zr.prototype,"promises",null),u([d({value:null,readOnly:!0})],zr.prototype,"selectedFeature",null),u([d({value:-1})],zr.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],zr.prototype,"selectedFeatureViewModel",null),u([d({readOnly:!0})],zr.prototype,"state",null),u([d()],zr.prototype,"title",void 0),u([d()],zr.prototype,"updateLocationEnabled",void 0),u([d()],zr.prototype,"view",void 0),u([d()],zr.prototype,"visible",void 0),u([d()],zr.prototype,"zoomFactor",void 0),u([d()],zr.prototype,"zoomToLocation",void 0),u([d()],zr.prototype,"centerAtLocation",null),zr=u([P("esri.widgets.Popup.PopupViewModel")],zr);const zbe=zr,pse="selected-index",hZe=0,fse="popup-spinner",mse={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},gse="esri-popup";function zm(t,e){return e===void 0?`${gse}__${t}`:`${gse}__${t}-${e}`}const yse={closeButton:!0,featureNavigation:!0};let Dt=class extends Tbe(Ma){constructor(e,r){super(e,r),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new Zr,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._featureMenuIntersectionObserverNode=null,this._featureMenuViewportNode=null,this._rootFlowItemNode=null,this._featureMenuIntersectionObserverCallback=([i])=>{i!=null&&i.isIntersecting&&this.viewModel.featurePage!=null&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._displaySpinnerThrottled=pS(()=>this._displaySpinner(),hZe),this._exitRelatedRecordsActions=new WeakMap,this._featureSelectionActions=new WeakMap,this._flowItems=new ft,this.alignment="auto",this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureMenuOpen=!1,this.headingLevel=2,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.spinnerEnabled=!0,this.viewModel=new zbe,this.visibleElements={...yse},this._handleOpenRelatedFeature=i=>{this._openRelatedFeature(i)},this._addSelectedFeatureIndexHandle(),this.addHandles([ne(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},()=>this._positionContainer()),ne(()=>{var i;return[(i=this.viewModel)==null?void 0:i.active,this.dockEnabled]},()=>this._toggleScreenLocationEnabled()),ne(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},(i,s)=>{!!i!=!!s&&this.reposition()}),ne(()=>{var i,s,n,o,a,l;return[(s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.padding,(o=(n=this.viewModel)==null?void 0:n.view)==null?void 0:o.size,(a=this.viewModel)==null?void 0:a.active,(l=this.viewModel)==null?void 0:l.location,this.alignment]},()=>this.reposition()),ne(()=>this.spinnerEnabled,i=>this._spinnerEnabledChange(i)),ne(()=>{var i,s;return(s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.size},(i,s)=>this._updateDockEnabledForViewSize(i,s)),ne(()=>{var i;return(i=this.viewModel)==null?void 0:i.view},(i,s)=>this._viewChange(i,s)),ne(()=>{var i,s;return(s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.ready},(i,s)=>this._viewReadyChange(i??!1,s??!1)),ne(()=>{var i,s;return[(i=this.viewModel)==null?void 0:i.waitingForResult,(s=this.viewModel)==null?void 0:s.location]},()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),ne(()=>this.selectedFeatureWidget,()=>this._destroyFlowItemWidgets()),ne(()=>{var i,s,n,o;return[(s=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:s.title,(o=(n=this.selectedFeatureWidget)==null?void 0:n.viewModel)==null?void 0:o.state]},()=>this._setTitleFromFeatureWidget()),ne(()=>{var i,s,n,o;return[(s=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:s.content,(o=(n=this.selectedFeatureWidget)==null?void 0:n.viewModel)==null?void 0:o.state]},()=>this._setContentFromFeatureWidget()),ra(()=>!this.collapsed,()=>{var i,s;((s=(i=this.viewModel)==null?void 0:i.view)==null?void 0:s.widthBreakpoint)==="xsmall"&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()}),an(()=>{var i;return(i=this.viewModel)==null?void 0:i.allActions},"change",()=>this._watchActions()),ne(()=>{var i;return(i=this.viewModel)==null?void 0:i.allActions},()=>this._watchActions(),kt),ne(()=>{var i;return(i=this.viewModel)==null?void 0:i.featureViewModels},()=>this._featureMenuViewportScrollTop()),an(()=>this._flowItems,"change",()=>{this.notifyChange("_activeFlowItemWidget"),this.scheduleRender()}),ne(()=>{var i,s,n,o;return[(s=(i=this._activeFlowItemWidget)==null?void 0:i.viewModel)==null?void 0:s.state,(o=(n=this._activeFlowItemWidget)==null?void 0:n.viewModel)==null?void 0:o.title]},()=>this.scheduleRender())])}loadDependencies(){return Promise.all([ie(()=>import("./calcite-flow-f8369f09.js"),["./calcite-flow-f8369f09.js","./observers-4f67f1fb.js"],import.meta.url),ie(()=>import("./calcite-flow-item-14a03c38.js"),["./calcite-flow-item-14a03c38.js","./interactive-573cbe88.js","./loadable-25ad9e4e.js","./t9n-53771394.js","./observers-4f67f1fb.js","./guid-9426053f.js","./action-b28974a0.js","./icon-eb8ea09d.js","./loader-6480f484.js","./tooltip-8e77a002.js","./debounce-31e0cfcc.js","./scrim-ee9ec6c9.js"],import.meta.url),ie(()=>import("./calcite-action-e945d8a5.js"),["./calcite-action-e945d8a5.js","./action-b28974a0.js","./guid-9426053f.js","./interactive-573cbe88.js","./loadable-25ad9e4e.js","./t9n-53771394.js","./observers-4f67f1fb.js","./icon-eb8ea09d.js","./loader-6480f484.js"],import.meta.url),ie(()=>import("./calcite-tooltip-1a688ed1.js"),["./calcite-tooltip-1a688ed1.js","./tooltip-8e77a002.js","./debounce-31e0cfcc.js","./guid-9426053f.js"],import.meta.url),ie(()=>import("./calcite-icon-30f39d3e.js"),["./calcite-icon-30f39d3e.js","./icon-eb8ea09d.js","./observers-4f67f1fb.js"],import.meta.url)])}destroy(){var e,r;this._destroyFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),(e=this._handles)==null||e.destroy(),this._unobserveFeatureMenuObserver(),(r=this._featureMenuIntersectionObserver)==null||r.disconnect()}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){const{selectedFeatureWidget:e,viewModel:r}=this;if(!e)return!!(r!=null&&r.content);const i=e.viewModel;if(i!=null&&i.waitingForContent||(i==null?void 0:i.state)==="error")return!0;const s=i==null?void 0:i.content;return Array.isArray(s)?!!s.length:!!s}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation!=null}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}get _activeFlowItemWidget(){const{_flowItems:e}=this;return e.getItemAt(e.length-1)||null}get actions(){return this.viewModel.actions}set actions(e){this.viewModel.actions=e}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get autoCloseEnabled(){return this.viewModel.autoCloseEnabled}set autoCloseEnabled(e){this.viewModel.autoCloseEnabled=e}get autoOpenEnabled(){return this.viewModel.autoOpenEnabled}set autoOpenEnabled(e){this.viewModel.autoOpenEnabled=e}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(e){this.viewModel.defaultPopupTemplateEnabled=e}get content(){return this.viewModel.content}set content(e){this.viewModel.content=e}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||mse}set dockOptions(e){var l,c;const r={...mse},i=(c=(l=this.viewModel)==null?void 0:l.view)==null?void 0:c.breakpoints,s={};i&&(s.width=i.xsmall,s.height=i.xsmall);const n={...r,...e},o={...r.breakpoint,...s},{breakpoint:a}=n;typeof a=="object"?n.breakpoint={...o,...a}:a&&(n.breakpoint=o),this._set("dockOptions",n),this._setCurrentDockPosition(),this.reposition()}get featureCount(){return this.viewModel.featureCount}get features(){return this.viewModel.features}set features(e){this.viewModel.features=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(e){this.viewModel.highlightEnabled=e}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get promises(){return this.viewModel.promises}set promises(e){this.viewModel.promises=e}get selectedFeature(){return this.viewModel.selectedFeature}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(e){this.viewModel.selectedFeatureIndex=e}get selectedFeatureWidget(){const{_feature:e,visibleElements:r,headingLevel:i,_flowItems:s}=this,{selectedFeatureViewModel:n}=this.viewModel,o={...r,title:!1};return n?(e?(e.viewModel=n,e.visibleElements=o):this._feature=new _Ye({flowItems:s,headingLevel:i+1,viewModel:n,visibleElements:o}),this._feature):null}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(e){this.viewModel.updateLocationEnabled=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}castVisibleElements(e){return{...yse,...e}}blur(){const{active:e}=this.viewModel;e||se.getLogger(this.declaredClass).warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){return this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,r){return this.viewModel.fetchFeatures(e,r)}focus(){const{active:e}=this.viewModel;e||se.getLogger(this.declaredClass).warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var n,o;this._handles.remove(pse);const r=!!e&&!!e.featureMenuOpen,i=!!e&&!!e.actionsMenuOpen,s={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:i,featureMenuOpen:r};((o=(n=this.viewModel)==null?void 0:n.view)==null?void 0:o.widthBreakpoint)==="xsmall"&&(s.collapsed=!0),this.set(s),this.viewModel.open(e),this._shouldFocus(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){return this.viewModel.triggerAction(e)}render(){var _,b,x,T;const{actionsMenuOpen:e,dockEnabled:r,featureMenuVisible:i,dividedActions:s,currentAlignment:n,currentDockPosition:o}=this,{active:a}=this.viewModel,{menuActions:l}=s,c=a&&l.length>1&&e,h=a&&r,p=a&&!r,f=(b=(_=this.selectedFeature)==null?void 0:_.layer)==null?void 0:b.title,m=(T=(x=this.selectedFeature)==null?void 0:x.layer)==null?void 0:T.id,y={[Ae.alignTopCenter]:n==="top-center",[Ae.alignBottomCenter]:n==="bottom-center",[Ae.alignTopLeft]:n==="top-left",[Ae.alignBottomLeft]:n==="bottom-left",[Ae.alignTopRight]:n==="top-right",[Ae.alignBottomRight]:n==="bottom-right",[Ae.isDocked]:h,[Ae.shadow]:p,[Ae.isDockedTopLeft]:o==="top-left",[Ae.isDockedTopCenter]:o==="top-center",[Ae.isDockedTopRight]:o==="top-right",[Ae.isDockedBottomLeft]:o==="bottom-left",[Ae.isDockedBottomCenter]:o==="bottom-center",[Ae.isDockedBottomRight]:o==="bottom-right",[Ae.isFeatureMenuOpen]:i,[Ae.isActionsMenuOpen]:c};return Q("div",{class:this.classes(Ae.base,y),role:"presentation","data-layer-title":f,"data-layer-id":m,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},a?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return Q("span",{"aria-hidden":"true",class:this.classes(Ae.icon,Ae.iconLoading,Ae.rotating)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?Q("div",{key:zm("loading-container"),role:"presentation",class:Ae.loadingContainer,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=qf(this.container),r={[Ae.iconRightTriangleArrow]:e,[Ae.paginationPreviousIconRTL]:e,[Ae.iconLeftTriangleArrow]:!e,[Ae.paginationPreviousIconLTR]:!e};return Q("span",{"aria-hidden":"true",class:this.classes(Ae.icon,r)})}renderPreviousButton(){const{messages:e}=this;return Q("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(Ae.button,Ae.paginationPrevious),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=qf(this.container),r={[Ae.iconLeftTriangleArrow]:e,[Ae.paginationNextIconRTL]:e,[Ae.iconRightTriangleArrow]:!e,[Ae.paginationNextIconLTR]:!e};return Q("span",{"aria-hidden":"true",class:this.classes(Ae.icon,r)})}renderNextButton(){const{messages:e}=this;return Q("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(Ae.button,Ae.paginationNext),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:r,messagesCommon:i}=this,{featureCount:s,selectedFeatureIndex:n}=this.viewModel;return Q("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(Ae.button,Ae.featureMenuButton),"aria-haspopup":"true","aria-controls":r,"aria-expanded":e.toString(),"aria-label":i.menu,title:i.menu},this._getPageText(s,n))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:[]}renderDockIcon(){const{dockEnabled:e}=this,r=this._wouldDockTo(),i={[Ae.iconUndock]:e,[Ae.iconDock]:!e,[Ae.iconDockToRight]:!e&&(r==="top-right"||r==="bottom-right"),[Ae.iconDockToLeft]:!e&&(r==="top-left"||r==="bottom-left"),[Ae.iconDockToTop]:!e&&r==="top-center",[Ae.iconDockToBottom]:!e&&r==="bottom-center"};return Q("span",{"aria-hidden":"true",class:this.classes(i,Ae.icon)})}renderDockButton(){var n,o,a;const{dockEnabled:e,messages:r}=this,i=(o=(n=this.viewModel)==null?void 0:n.view)==null?void 0:o.widthBreakpoint,s=e?r.undock:r.dock;return i!=="xsmall"&&((a=this.dockOptions)!=null&&a.buttonEnabled)?Q("div",{role:"button","aria-label":s,title:s,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(Ae.button,Ae.buttonDock)},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:r,collapsible:i,contentCollapsed:s,messagesCommon:n}=this,o={[Ae.headerContainerButton]:i},a=Q(kY,{level:this.headingLevel,class:Ae.headerTitle,innerHTML:e??""}),l=i?Q("button",{key:`${e}--collapsible`,id:r,title:s?n.expand:n.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Ae.headerContainer,o),"aria-expanded":s?"false":"true",onclick:this._toggleCollapsed,type:"button"},a,Q("calcite-icon",{class:Ae.collapseIcon,key:"collapse-icon",icon:s?"chevron-down":"chevron-up",scale:"m"})):Q("div",{key:e??"title",id:r,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Ae.headerContainer,o)},a);return e?l:null}renderCloseIcon(){return Q("span",{"aria-hidden":"true",class:this.classes(Ae.icon,Ae.iconClose)})}renderCloseButton(){const{visibleElements:e,messagesCommon:r}=this;return e.closeButton?Q("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:Ae.button,"aria-label":r.close,title:r.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return Q("header",{class:Ae.header},this.renderTitle(),Q("div",{class:Ae.headerButtons},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:r,contentCollapsed:i,_flowItems:s}=this,{content:n}=this.viewModel,o=s.toArray(),a={[Ae.contentHasFlows]:!!o.length};return r&&!i?Q("div",{key:n??"content",enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:this.classes(Ae.content,a)},Q("calcite-flow",{bind:this},Q("calcite-flow-item",{bind:this,"data-node-ref":"_rootFlowItemNode",afterCreate:CF,key:"root-flow-item",onCalciteFlowItemBack:this._handleBackClick},this.renderContent()),o.map(l=>this.renderFlowItem(l))),o.map(l=>this.renderFlowItemTooltips(l))):null}renderFlowItem(e){const{messages:r}=this,i=LF(),s="graphic"in e&&!e.isTable;return Q("calcite-flow-item",{bind:this,class:this.classes({[Ae.calciteThemeDark]:!i,[Ae.calciteThemeLight]:i}),heading:e.title??"",description:this._getFlowItemDescription(e),onCalciteFlowItemBack:this._handleBackClick,key:`flow-item-${e.viewModel.uid}`},Q("calcite-action",{class:Ae.actionExit,icon:"move-up",label:r==null?void 0:r.exitRelatedRecords,text:r==null?void 0:r.exitRelatedRecords,slot:"header-actions-start",bind:this,afterCreate:n=>this._storeExitRelatedRecordsAction(e,n),onclick:this._destroyFlowItemWidgets}),s?Q("calcite-action",{class:Ae.actionSelectFeature,icon:"zoom-to-object",label:r==null?void 0:r.selectFeature,text:r==null?void 0:r.selectFeature,slot:"header-actions-end",bind:this,afterCreate:n=>this._storeFeatureSelectionAction(e,n),onclick:()=>this._handleOpenRelatedFeature(e)}):null,Q("div",{class:this.classes(Ae.contentFlowItem,{[Ae.calciteThemeDark]:i,[Ae.calciteThemeLight]:!i})},e.render()))}renderFlowItemTooltips(e){const{messages:r,_exitRelatedRecordsActions:i,_featureSelectionActions:s}=this,n=LF(),o=s.get(e);return[Q("calcite-tooltip",{class:this.classes({[Ae.calciteThemeDark]:!n,[Ae.calciteThemeLight]:n}),key:`exit-related-records-tooltip-${e.viewModel.uid}`,label:r==null?void 0:r.exitRelatedRecords,overlayPositioning:"fixed",referenceElement:i.get(e),placement:"top"},r==null?void 0:r.exitRelatedRecords),o?Q("calcite-tooltip",{class:this.classes({[Ae.calciteThemeDark]:!n,[Ae.calciteThemeLight]:n}),key:`select-related-record-tooltip-${e.viewModel.uid}`,label:r==null?void 0:r.selectFeature,overlayPositioning:"fixed",referenceElement:o,placement:"top"},r==null?void 0:r.selectFeature):null]}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:r,actionsMenuOpen:i,dividedActions:s,messagesCommon:n}=this,o=i?n.close:n.open,{menuActions:a}=s;return a.length?Q("div",{key:zm("actions-menu-button"),class:this.classes(Ae.button,Ae.actionsMenuButton),role:"button",id:r,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":o,title:o},Q("span",{"aria-hidden":"true",class:Ae.iconActionsMenu})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:r,actionsMenuOpen:i,dividedActions:s}=this,{menuActions:n}=s;return n.length&&i?Q("ul",{id:e,role:"menu","aria-labelledby":r,key:zm("actions"),class:Ae.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},n.toArray().map(o=>this.renderAction({action:o,type:"menu-item"}))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return e.length?e.toArray().map(r=>this.renderAction({action:r,type:"inline"})):[]}renderInlineActionsContainer(){const{inlineActions:e,menuActions:r}=this.dividedActions,i=!!e.length,s=!!r.length;return i||s?Q("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":s.toString(),class:Ae.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?Q("section",{key:zm("navigation"),class:this.classes(Ae.navigation)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:r}=this,{inlineActions:i,menuActions:s}=r,n=!!i.length,o=!!s.length,a={[Ae.footerHasPagination]:e,[Ae.footerHasActions]:n,[Ae.footerHasActionsMenu]:o};return e||n?Q("div",{key:zm("feature-buttons"),class:this.classes(Ae.footer,a)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:r,isLoadingFeature:i}=this.viewModel,s=Of(e.selectedFeatures,{total:r.length});return Q("section",{key:zm("menu"),class:Ae.featureMenu},Q("strong",{class:Ae.featureMenuHeader},s),Q("nav",{bind:this,class:Ae.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:CF},this.renderFeatureMenu(),Q("div",{class:Ae.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),i?Q("div",{class:Ae.featureMenuLoader},this.renderLoadingIcon()):null))}renderPointer(){return this.dockEnabled?null:Q("div",{key:zm("pointer"),class:Ae.pointer,role:"presentation"},Q("div",{class:this.classes(Ae.pointerDirection,Ae.shadow)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:r,currentDockPosition:i,titleId:s,contentId:n,collapsible:o,hasContent:a,contentCollapsed:l,visibleElements:c}=this,{title:h}=this.viewModel,p=r==="bottom-left"||r==="bottom-center"||r==="bottom-right"||i==="top-left"||i==="top-center"||i==="top-right",f=r==="top-left"||r==="top-center"||r==="top-right"||i==="bottom-left"||i==="bottom-center"||i==="bottom-right",m={[Ae.shadow]:e,[Ae.isCollapsible]:o,[Ae.isCollapsed]:l};return Q("div",{class:this.classes(Ae.main,Ae.widget,m),tabIndex:c.closeButton?void 0:-1,role:"dialog","aria-labelledby":h?s:"","aria-describedby":a&&!l?n:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),f?this.renderFooter():null,f?this.renderFeatureMenuContainer():null)}renderContent(){var r;const e=(r=this.viewModel)==null?void 0:r.content;return e?typeof e=="string"?Q("div",{class:tn.contentNode,key:e,innerHTML:e}):this.renderNodeContent(e):null}renderActionText(e){return Q("span",{key:"text",class:Ae.actionText},e)}renderActionIcon(e){const r=this._getActionClass(e),i=this._getActionImage(e),s={[Ae.iconLoading]:e.active,[Ae.rotating]:e.active,[Ae.icon]:!!r,[Ae.actionImage]:!e.active&&!!i};return r&&(s[r]=!e.active),Q("span",{key:"icon","aria-hidden":"true",class:this.classes(Ae.icon,s),styles:this._getIconStyles(i)})}renderAction(e){const{action:r,type:i}=e,s=this._getActionTitle(r),n={[Ae.action]:r.type!=="toggle",[Ae.actionToggle]:r.type==="toggle",[Ae.actionToggleOn]:r.type==="toggle"&&r.value,[Ae.buttonDisabled]:r.disabled},o=[this.renderActionIcon(r),this.renderActionText(s)],a=i==="menu-item"?Q("li",{key:r.uid,role:"menuitem",tabIndex:0,title:s,"aria-label":s,class:this.classes(Ae.button,n),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":r.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},o):Q("div",{key:r.uid,role:"button",tabIndex:0,title:s,"aria-label":s,class:this.classes(Ae.button,n),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":r.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},o);return r.visible?a:null}renderFeatureMenuItem(e,r){const{messages:i,messagesCommon:s}=this,{selectedFeatureIndex:n,selectedFeatureViewModel:o}=this.viewModel,a=e===o,l={[Ae.featureMenuSelected]:a},c=a?Q("span",{key:zm(`feature-menu-selected-feature-${n}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:Ae.iconCheckMark}):null,h=Q("span",{innerHTML:e.title||s.untitled});return Q("li",{role:"menuitem",tabIndex:-1,key:zm(`feature-menu-feature-${n}`),class:this.classes(l,Ae.featureMenuItem),bind:this,"data-feature-index":r,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature,onmouseover:this._setActiveFeature,onmouseleave:this._removeActiveFeature},Q("span",{class:Ae.featureMenuTitle},h,c))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:r}=this.viewModel;return r.length>1?Q("ol",{class:Ae.featureMenuList,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},r.filter(i=>!!i.graphic).map((i,s)=>this.renderFeatureMenuItem(i,s))):null}_storeFeatureSelectionAction(e,r){this._featureSelectionActions.set(e,r),this.scheduleRender()}_storeExitRelatedRecordsAction(e,r){this._exitRelatedRecordsActions.set(e,r),this.scheduleRender()}_getFlowItemDescription(e){return"featureCountDescription"in e?e.featureCountDescription:e.viewModel.description??""}async _openRelatedFeature(e){await e.viewModel.updateGeometry();const r=e.graphic,i=r==null?void 0:r.geometry;if(C(i)||C(r))return;this._destroyFlowItemWidgets(),await this.viewModel.zoomTo({target:i});const s=Rbe(i);this.open({features:[r],location:v(s)?s:void 0})}_destroyFlowItemWidgets(){this._flowItems.removeAll().forEach(e=>{"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e.viewModel=null,e.destroy()})}_handleBackClick(){const e=this._flowItems.pop();e&&(this._exitRelatedRecordsActions.delete(e),this._featureSelectionActions.delete(e),"showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e&&(e.viewModel=null,e.destroy()))}_getActionTitle(e){const{messages:r,selectedFeature:i,messagesCommon:s}=this,{id:n}=e,o=i==null?void 0:i.attributes,a=e.title??"",l=n==="zoom-to-feature"?Of(a,{messages:r}):n==="remove-selected-feature"?Of(a,{messages:s}):n==="zoom-to-clustered-features"||n==="browse-clustered-features"?Of(a,{messages:r}):e.title;return l&&o?Of(l,o):l??""}_getActionClass(e){const{selectedFeature:r}=this,i=r==null?void 0:r.attributes,{className:s,image:n}=e,o=n||s?s:Ae.iconDefaultAction;return o&&i?Of(o,i):o??""}_getActionImage(e){const{selectedFeature:r}=this,i=r==null?void 0:r.attributes,{image:s}=e;return s&&i?Of(s,i):s??""}_createFeatureUpdatedAnimation(){return SVe("enter",Ae.hasFeatureUpdated)}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:r}=this;if(typeof e!="number")return null;const i=Math.round(e);return Math.max(r?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const r="actions";this._handles.remove(r),e&&e.forEach(i=>{this._handles.add(ne(()=>[i.uid,i.active,i.className,i.disabled,i.id,i.title,i.image,i.visible],()=>this.scheduleRender()),r)})}_divideActions(){const{allActions:e}=this.viewModel,r=e.filter(o=>o.visible),i=this._getInlineActionCount(),s=i===null,n=i===0;return{inlineActions:s?r.slice(0):n?new ft:r.slice(0,i),menuActions:s?new ft:n?r.slice(0):r.slice(i)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(){var i,s;const{selectedFeatureWidget:e,messagesCommon:r}=this;e&&(this.viewModel.title=((i=e.viewModel)==null?void 0:i.state)==="error"?r.errorMessage:((s=e.viewModel)==null?void 0:s.title)||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e}_handleFeatureMenuKeyup(e){Sb(e)==="Escape"&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){Sb(e)==="Escape"&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_setActiveFeature(e){const{viewModel:r}=this,i=e.currentTarget["data-feature-index"];r.activeFeature=r.features[i]||null}_removeActiveFeature(){this.viewModel.activeFeature=null}_handleFeatureMenuItemKeyup(e){const r=Sb(e),{_featureMenuNode:i}=this,s=e.currentTarget["data-feature-index"];if(!i)return;const n=i.querySelectorAll("li"),o=n.length;r!=="ArrowUp"?r!=="ArrowDown"?r!=="Home"?r!=="End"||(e.stopPropagation(),n[n.length-1].focus()):(e.stopPropagation(),n[0].focus()):(e.stopPropagation(),n[(s+1+o)%o].focus()):(e.stopPropagation(),n[(s-1+o)%o].focus())}_handleActionMenuItemKeyup(e){const r=Sb(e),{_actionsMenuNode:i}=this,s=e.currentTarget.dataset.actionUid,{menuActions:n}=this.dividedActions,o=n.findIndex(c=>c.uid===s);if(!i)return;const a=i.querySelectorAll("li"),l=a.length;r!=="ArrowUp"?r!=="ArrowDown"?r!=="Home"?r!=="End"||(e.stopPropagation(),a[a.length-1].focus()):(e.stopPropagation(),a[0].focus()):(e.stopPropagation(),a[(o+1+l)%l].focus()):(e.stopPropagation(),a[(o-1+l)%l].focus())}_handleMainKeyup(e){const r=Sb(e);r==="ArrowLeft"&&(e.stopPropagation(),this.previous()),r==="ArrowRight"&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const r=this.get("viewModel.view");this._createSpinner(r)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:r,waitingForResult:i}=this.viewModel;i&&r?e.show({location:r}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}async _shouldFocus(e){e!=null&&e.shouldFocus&&(await f3(()=>{var r;return((r=this.viewModel)==null?void 0:r.active)===!0}),this.focus())}_addSelectedFeatureIndexHandle(){const e=ne(()=>{var r;return(r=this.viewModel)==null?void 0:r.selectedFeatureIndex},(r,i)=>this._selectedFeatureIndexUpdated(r,i));this._handles.add(e,pse)}_selectedFeatureIndexUpdated(e,r){const{featureCount:i}=this;i&&e!==r&&e!==-1&&(this._destroyFlowItemWidgets(),this.actionsMenuOpen=!1,this.featureMenuOpen=!1,this._mainContainerNode&&(this._mainContainerNode.scrollTop=0),this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,r){return e.x>-1&&e.y>-1&&e.x<=r.width&&e.y<=r.height}_isOutsideView(e){const{popupHeight:r,popupWidth:i,screenLocation:s,side:n,view:o}=e;if(isNaN(i)||isNaN(r)||!o||!s)return!1;const a=o.padding;return n==="right"&&s.x+i/2>o.width-a.right||n==="left"&&s.x-i/2<a.left||n==="top"&&s.y-r<a.top||n==="bottom"&&s.y+r>o.height-a.bottom}_calculateAutoAlignment(e){if(e!=="auto")return e;const{_pointerOffsetInPx:r,_containerNode:i,_mainContainerNode:s,viewModel:n}=this,{screenLocation:o,view:a}=n;if(C(o)||!a||!i)return"top-center";if(!this._isScreenLocationWithinView(o,a))return this._get("currentAlignment")||"top-center";function l(E){return parseInt(E.replace(/[^-\d\.]/g,""),10)}const c=s?window.getComputedStyle(s,null):null,h=c?l(c.getPropertyValue("max-height")):0,p=c?l(c.getPropertyValue("height")):0,{height:f,width:m}=i.getBoundingClientRect(),y=m+r,_=Math.max(f,h,p)+r,b=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"right",view:a}),x=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"left",view:a}),T=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"top",view:a}),S=this._isOutsideView({popupHeight:_,popupWidth:y,screenLocation:o,side:"bottom",view:a});return x?T?"bottom-right":"top-right":b?T?"bottom-left":"top-left":T?S?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return typeof e=="function"?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:r}=this;return r||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const r=["left","right"];return qf(this.container)&&r.reverse(),e.replace(/leading/gi,r[0]).replace(/trailing/gi,r[1])}_callDockPosition(e){return typeof e=="function"?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((e=this.dockOptions)==null?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var a;if(e!=="auto")return e;const r=(a=this.viewModel)==null?void 0:a.view,i=qf(this.container)?"top-left":"top-right";if(!r)return i;const s=r.padding||{left:0,right:0,top:0,bottom:0},n=r.width-s.left-s.right,{breakpoints:o}=r;return o&&n<=o.xsmall?"bottom-center":i}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!this._containerNode)return;const{screenLocation:r}=this.viewModel,{width:i}=this._containerNode.getBoundingClientRect(),s=this._calculatePositionStyle(r,i);s&&Object.assign(this._containerNode.style,s)}_calculateFullWidth(e){const{currentAlignment:r,_pointerOffsetInPx:i}=this;return r==="top-left"||r==="bottom-left"||r==="top-right"||r==="bottom-right"?e+i:e}_calculateAlignmentPosition(e,r,i,s){const{currentAlignment:n,_pointerOffsetInPx:o}=this;if(!i)return;const{padding:a}=i,l=s/2,c=i.height-r,h=i.width-e;return n==="bottom-center"?{top:r+o-a.top,left:e-l-a.left}:n==="top-left"?{bottom:c+o-a.bottom,right:h+o-a.right}:n==="bottom-left"?{top:r+o-a.top,right:h+o-a.right}:n==="top-right"?{bottom:c+o-a.bottom,left:e+o-a.left}:n==="bottom-right"?{top:r+o-a.top,left:e+o-a.left}:n==="top-center"?{bottom:c+o-a.bottom,left:e-l-a.left}:void 0}_calculatePositionStyle(e,r){const{dockEnabled:i,view:s}=this;if(!s)return;if(i)return{left:"",top:"",right:"",bottom:""};if(C(e)||!r)return;const n=this._calculateFullWidth(r),o=this._calculateAlignmentPosition(e.x,e.y,s,n);return o?{top:o.top!==void 0?`${o.top}px`:"auto",left:o.left!==void 0?`${o.left}px`:"auto",bottom:o.bottom!==void 0?`${o.bottom}px`:"auto",right:o.right!==void 0?`${o.right}px`:"auto"}:void 0}_viewChange(e,r){e&&r&&(this.close(),this.clear())}_viewReadyChange(e,r){if(e){const i=this.get("viewModel.view");this._wireUpView(i)}else r&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:r}=this;r&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,r,i){const[s,n]=e,[o,a]=r,{width:l=0,height:c=0}=i??{};return s<=l&&o>l||s>l&&o<=l||n<=c&&a>c||n>c&&a<=c}_updateDockEnabledForViewSize(e,r){if(!e||!r)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},s=i.left+i.right,n=i.top+i.bottom,o=[],a=[];o[0]=e[0]-s,o[1]=e[1]-n,a[0]=r[0]-s,a[1]=r[1]-n;const{dockOptions:l}=this,c=l.breakpoint;this._dockingThresholdCrossed(o,a,c)&&this._setDockEnabledForViewSize(l),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const r=e.querySelectorAll("li");r.length&&r[0].focus()}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const r=e.querySelectorAll("li");r.length&&r[0].focus()}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:r}=this;if(!r)return;const i=r.active&&!e;r.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(e){var l,c;const r=e.breakpoint,i=(c=(l=this.viewModel)==null?void 0:l.view)==null?void 0:c.ui;if(!i)return!1;const{width:s,height:n}=i;if(isNaN(s)||isNaN(n)||!r)return!1;const o=r.hasOwnProperty("width")&&s<=(r.width??0),a=r.hasOwnProperty("height")&&n<=(r.height??0);return o||a}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,r){return this.featureNavigationVisible?Of(this.messages.pageText,{index:r+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:r}=this;e&&(r&&r.ui&&r.ui.remove(e,fse),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new bYe({view:e}),e.ui.add(this._spinner,{key:fse,position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const r=e.currentTarget.dataset.actionUid,{allActions:i}=this.viewModel,s=i.findIndex(o=>o.uid===r),n=i.getItemAt(s);n&&n.type==="toggle"&&(n.value=!n.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(s)}_selectFeature(e){const r=e.currentTarget["data-feature-index"];isNaN(r)||(this.viewModel.selectedFeatureIndex=r),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};u([d({readOnly:!0})],Dt.prototype,"actionsMenuId",null),u([d({readOnly:!0})],Dt.prototype,"actionsMenuButtonId",null),u([d({readOnly:!0})],Dt.prototype,"featureMenuId",null),u([d({readOnly:!0})],Dt.prototype,"titleId",null),u([d({readOnly:!0})],Dt.prototype,"contentId",null),u([d({readOnly:!0})],Dt.prototype,"hasContent",null),u([d({readOnly:!0})],Dt.prototype,"featureNavigationVisible",null),u([d({readOnly:!0})],Dt.prototype,"collapsible",null),u([d({readOnly:!0})],Dt.prototype,"featureMenuVisible",null),u([d({readOnly:!0})],Dt.prototype,"contentCollapsed",null),u([d({readOnly:!0})],Dt.prototype,"dividedActions",null),u([d({readOnly:!0,dependsOn:["_flowItems.length"]})],Dt.prototype,"_activeFlowItemWidget",null),u([d()],Dt.prototype,"actions",null),u([d()],Dt.prototype,"actionsMenuOpen",null),u([d()],Dt.prototype,"alignment",void 0),u([d()],Dt.prototype,"autoCloseEnabled",null),u([d()],Dt.prototype,"autoOpenEnabled",null),u([d()],Dt.prototype,"defaultPopupTemplateEnabled",null),u([d()],Dt.prototype,"content",null),u([d()],Dt.prototype,"collapsed",void 0),u([d()],Dt.prototype,"collapseEnabled",void 0),u([d({readOnly:!0})],Dt.prototype,"currentAlignment",null),u([d({readOnly:!0})],Dt.prototype,"currentDockPosition",null),u([d()],Dt.prototype,"dockOptions",null),u([d()],Dt.prototype,"dockEnabled",void 0),u([d({readOnly:!0})],Dt.prototype,"featureCount",null),u([d()],Dt.prototype,"featureMenuOpen",void 0),u([d()],Dt.prototype,"features",null),u([d()],Dt.prototype,"goToOverride",null),u([d()],Dt.prototype,"headingLevel",void 0),u([d()],Dt.prototype,"highlightEnabled",null),u([d()],Dt.prototype,"location",null),u([d()],Dt.prototype,"label",null),u([d()],Dt.prototype,"maxInlineActions",void 0),u([d(),rl("esri/widgets/Popup/t9n/Popup")],Dt.prototype,"messages",void 0),u([d(),rl("esri/t9n/common")],Dt.prototype,"messagesCommon",void 0),u([d()],Dt.prototype,"promises",null),u([d({readOnly:!0})],Dt.prototype,"selectedFeature",null),u([d()],Dt.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],Dt.prototype,"selectedFeatureWidget",null),u([d()],Dt.prototype,"spinnerEnabled",void 0),u([d()],Dt.prototype,"title",null),u([d()],Dt.prototype,"updateLocationEnabled",null),u([d()],Dt.prototype,"view",null),u([d({type:zbe}),vze(["triggerAction","trigger-action"])],Dt.prototype,"viewModel",void 0),u([d()],Dt.prototype,"visible",null),u([d()],Dt.prototype,"visibleElements",void 0),u([Gt("visibleElements")],Dt.prototype,"castVisibleElements",null),u([bh()],Dt.prototype,"_close",null),u([bh()],Dt.prototype,"_toggleDockEnabled",null),u([bh()],Dt.prototype,"_toggleFeatureMenu",null),u([bh()],Dt.prototype,"_toggleActionsMenu",null),u([bh()],Dt.prototype,"_triggerAction",null),u([bh()],Dt.prototype,"_selectFeature",null),u([bh()],Dt.prototype,"_next",null),u([bh()],Dt.prototype,"_previous",null),Dt=u([P("esri.widgets.Popup")],Dt);const _se=Dt,B8=[0,0];function dZe(t){const e=(t.ownerDocument||window.document).defaultView,r=t.getBoundingClientRect();return B8[0]=r.left+((e==null?void 0:e.pageXOffset)??0),B8[1]=r.top+((e==null?void 0:e.pageYOffset)??0),B8}function vse(t){t&&(S0e(t),t.parentNode&&t.parentNode.removeChild(t))}function pZe(t){const e=document.createElement("div");return t.appendChild(e),e}const HC=16,CI=750,fZe=512,mZe=2,gZe=t=>{let e=class extends t{constructor(...r){var i;super(...r),this._freqInfo={freq:HC,time:CI},this._overlayRenderTaskHandle=null,this.height=0,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,r.length!==0&&((i=r[0])==null?void 0:i.popup)!==void 0||(this.popup=new _se({view:this})),this.handles.add([ne(()=>this.cursor,s=>{const{surface:n}=this;n&&n.setAttribute("data-cursor",s)}),ne(()=>this.interacting,s=>{const{surface:n}=this;n&&n.setAttribute("data-interacting",s.toString())})])}initialize(){this.handles.add(ne(()=>this.ui,(r,i)=>this._handleUIChange(r,i))),this._wireUI(this.ui),this.handles.add([this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui=Ve(this.ui),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(r){const i=this._get("container"),s=F5(r);if(s||typeof r!="string"||se.getLogger(this.declaredClass).error("#container",`element with id '${r}' not found`),i===s)return;const n="dom-size";if(this.handles.remove(n),this._stopMeasuring(),i&&(i.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(vse(this.root),this._set("root",null)),this.userContent&&(xte(this.userContent,i),vse(this.userContent),this._set("userContent",null))),!s)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);s.classList.add("esri-view");const o=document.createElement("div");o.className="esri-view-user-storage",xte(s,o),s.appendChild(o),this._set("userContent",o);const a=document.createElement("div");a.className="esri-view-root",s.insertBefore(a,s.firstChild),this._set("root",a);const l=document.createElement("div");l.className="esri-view-surface",l.setAttribute("role","application"),l.tabIndex=0,a.appendChild(l),this._set("surface",l);const c=new Wte;a.appendChild(c.surface),this._set("overlay",c),ne(()=>c.needsRender,h=>{h&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=kS({render:()=>{var p;return(p=this.overlay)==null?void 0:p.render()}}):this._overlayRenderTaskHandle=Vi(this._overlayRenderTaskHandle)}),this.forceDOMReadyCycle(),this.handles.add(ne(()=>this.size,h=>{const[p,f]=h,m="esri-view-surface--inset-outline";p>=document.body.clientWidth||f>=document.body.clientHeight?l.classList.add(m):l.classList.remove(m)},kt),n),this._set("container",s),this._startMeasuring()}get focused(){const r=document.activeElement===this.surface;return document.hasFocus()&&r}set popup(r){const i=this._get("popup");i&&i!==r&&i.destroy(),this._set("popup",r)}get size(){return[this.width,this.height]}blur(){this.surface&&this.surface.blur()}focus(){this.surface&&this.surface.focus()}pageToContainer(r,i,s){const n=this.position;return r-=n?n[0]:0,i-=n?n[1]:0,s?(s[0]=r,s[1]=i):s=[r,i],s}containerToPage(r,i,s){const n=this.position;return r+=n?n[0]:0,i+=n?n[1]:0,s?(s[0]=r,s[1]=i):s=[r,i],s}_handleUIChange(r,i){i&&(this.handles.remove("ui"),i.destroy()),r&&this._wireUI(r),this._set("ui",r)}_wireUI(r){this.handles.remove("ui"),r&&(r.view=this,this.handles.add([ne(()=>this.root,i=>{r.container=i?pZe(i):null},kt),ne(()=>this.popup,(i,s)=>{const n="popup",o="manual";s&&r.remove(s,n),i&&(i.view=r.view,r.add(i,{key:n,position:o}))},kt)],"ui"))}_stopMeasuring(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const r=this._freqInfo;r.freq=HC,r.time=CI,this.handles.add([(()=>{const i=()=>{r.freq=HC,r.time=CI};return window.addEventListener("resize",i),{remove(){window.removeEventListener("resize",i)}}})(),kS({prepare:i=>{const s=this._measure(),n=this._freqInfo;if(n.time+=i.deltaTime,s&&(n.freq=HC,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?HC:Math.min(CI,n.freq*mZe),!s&&n.freq>=fZe&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const r=this.container,i=r?r.clientWidth:0,s=r?r.clientHeight:0;if(i===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return i===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",i),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:i,height:s}),!0)}_position(){const r=this.container,i=this.position,s=r&&dZe(r);return!!s&&(!i||s[0]!==i[0]||s[1]!==i[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d()],e.prototype,"container",null),u([d({readOnly:!0})],e.prototype,"focused",null),u([d({readOnly:!0})],e.prototype,"height",void 0),u([d({type:_se})],e.prototype,"popup",null),u([d({type:Wte})],e.prototype,"overlay",void 0),u([d({readOnly:!0})],e.prototype,"position",void 0),u([d({readOnly:!0})],e.prototype,"resizing",void 0),u([d({readOnly:!0})],e.prototype,"root",void 0),u([d({value:null,readOnly:!0})],e.prototype,"size",null),u([d({readOnly:!0})],e.prototype,"surface",void 0),u([d({readOnly:!0})],e.prototype,"suspended",void 0),u([d()],e.prototype,"ui",void 0),u([d({readOnly:!0})],e.prototype,"userContent",void 0),u([d({readOnly:!0})],e.prototype,"width",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),e=u([P("esri.views.DOMContainer")],e),e},MZ=se.getLogger("esri.layers.support.ElevationSampler");let Bbe=class{queryElevation(e){return Gbe(e.clone(),this)}on(){return wZe}projectIfRequired(e,r){return jbe(e,r)}},yZe=class extends Bbe{get spatialReference(){return this.extent.spatialReference}constructor(e,r,i){super(),this.tile=e,this.noDataValue=i;const s=e.tile.extent;this.extent=o5(s,r.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=s;const n=al(r.spatialReference),o=r.lodAt(e.tile.level).resolution*n;this.demResolution={min:o,max:o}}contains(e){const r=this.projectIfRequired(e,this.spatialReference);return!C(r)&&this.containsAt(r.x,r.y)}containsAt(e,r){return a5(this._aaExtent,e,r)}elevationAt(e,r){if(!this.containsAt(e,r)){const i=this.extent,s=`${i.xmin}, ${i.ymin}, ${i.xmax}, ${i.ymax}`;return MZ.warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler extent (${s})`),this.noDataValue}return It(this.tile.sample(e,r),this.noDataValue)}},oOt=class extends Bbe{get spatialReference(){return this.extent.spatialReference}constructor(e,r,i){let s;super(),typeof r=="number"?(this.noDataValue=r,s=null):(s=r,this.noDataValue=i),this.samplers=s?e.map(o=>new yZe(o,s,this.noDataValue)):e;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=o5(hr(),s.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,r){for(const i of this.samplers)if(i.containsAt(e,r))return i.elevationAt(e,r);return MZ.warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler`),this.noDataValue}};function Gbe(t,e){const r=jbe(t,e.spatialReference);if(!r)return null;switch(t.type){case"point":_Ze(t,r,e);break;case"polyline":vZe(t,r,e);break;case"multipoint":bZe(t,r,e)}return t}function jbe(t,e){if(C(t))return null;const r=t.spatialReference;if(r.equals(e))return t;const i=ex(t,e);return i||MZ.error(`Cannot project geometry spatial reference (wkid:${r.wkid}) to elevation sampler spatial reference (wkid:${e.wkid})`),i}function _Ze(t,e,r){t.z=r.elevationAt(e.x,e.y)}function vZe(t,e,r){Uf.spatialReference=e.spatialReference;const i=t.hasM&&!t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s],o=e.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];Uf.x=c[0],Uf.y=c[1],i&&(l[3]=l[2]),l[2]=r.elevationAt(Uf.x,Uf.y)}}t.hasZ=!0}function bZe(t,e,r){Uf.spatialReference=e.spatialReference;const i=t.hasM&&!t.hasZ;for(let s=0;s<t.points.length;s++){const n=t.points[s],o=e.points[s];Uf.x=o[0],Uf.y=o[1],i&&(n[3]=n[2]),n[2]=r.elevationAt(Uf.x,Uf.y)}t.hasZ=!0}const Uf=new _t,wZe={remove(){}};var Sj;let yf=Sj=class extends fe{constructor(t){super(t),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new Sj({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],yf.prototype,"cols",void 0),u([d({type:Ti,json:{write:!0}})],yf.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],yf.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],yf.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],yf.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],yf.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],yf.prototype,"scale",void 0),yf=Sj=u([P("esri.layers.support.LOD")],yf);const Jd=yf;let xZe=class{constructor(e,r,i,s,n){this.id=e,this.level=r,this.row=i,this.col=s,this.extent=n}};var j0;const bse=new Vr({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let To=j0=class extends fe{static create(t={}){const{resolutionFactor:e=1,scales:r,size:i=256,spatialReference:s=We.WebMercator,numLODs:n=24}=t;if(!va(s)){const p=[];if(r)for(let f=0;f<r.length;f++){const m=r[f];p.push(new Jd({level:f,scale:m,resolution:m}))}else{let f=5e-4;for(let m=n-1;m>=0;m--)p.unshift(new Jd({level:m,scale:f,resolution:f})),f*=2}return new j0({dpi:96,lods:p,origin:new _t(0,0,s),size:[i,i],spatialReference:s})}const o=V_(s),a=t.origin?new _t({x:t.origin.x,y:t.origin.y,spatialReference:s}):new _t(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(al(s)*39.37*l),h=[];if(r)for(let p=0;p<r.length;p++){const f=r[p],m=f*c;h.push(new Jd({level:p,scale:f,resolution:m}))}else{let p=ipe(s)?512/i*5916575275917094e-7:256/i*591657527591555e-6;const f=Math.ceil(n/e);h.push(new Jd({level:0,scale:p,resolution:p*c}));for(let m=1;m<f;m++){const y=p/2**e,_=y*c;h.push(new Jd({level:m,scale:y,resolution:_})),p=y}}return new j0({dpi:l,lods:h,origin:a,size:[i,i],spatialReference:s})}constructor(t){super(t),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:t,origin:e}=this;if(t&&e){const r=V_(t);return t.isWrappable&&!!r&&Math.abs(r.origin[0]-e.x)<=r.dx}return!1}readOrigin(t,e){return _t.fromJSON({spatialReference:e.spatialReference,...t})}set lods(t){let e=0,r=0;const i=[],s=this._levelToLOD={};t&&(e=-1/0,r=1/0,t.forEach(n=>{i.push(n.scale),e=n.scale>e?n.scale:e,r=n.scale<r?n.scale:r,s[n.level]=n})),this._set("scales",i),this._set("minScale",e),this._set("maxScale",r),this._set("lods",t),this._initializeUpsampleLevels()}readSize(t,e){return[e.cols,e.rows]}writeSize(t,e){e.cols=t[0],e.rows=t[1]}zoomToScale(t){const e=this.scales;if(t<=0)return e[0];if(t>=e.length-1)return e[e.length-1];const r=Math.floor(t),i=r+1;return e[r]/(e[r]/e[i])**(t-r)}scaleToZoom(t){const e=this.scales,r=e.length-1;let i=0;for(;i<r;i++){const s=e[i],n=e[i+1];if(s<=t)return i;if(n===t)return i+1;if(s>t&&n<t)return i+Math.log(s/t)/Math.log(s/n)}return i}snapScale(t,e=.95){const r=this.scaleToZoom(t);return r%Math.floor(r)>=e?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))}tileAt(t,e,r,i){const s=this.lodAt(t);if(!s)return null;let n,o;if(typeof e=="number")n=e,o=r;else if(Cn(e.spatialReference,this.spatialReference))n=e.x,o=e.y,i=r;else{const c=ex(e,this.spatialReference);if(C(c))return null;n=c.x,o=c.y,i=r}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return i||(i=new xZe(null,0,0,0,hr())),i.level=t,i.row=Math.floor((this.origin.y-o)/l+.001),i.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(i),i}updateTileInfo(t,e=j0.ExtrapolateOptions.NONE){let r=this.lodAt(t.level);if(!r&&e===j0.ExtrapolateOptions.POWER_OF_TWO){const o=this.lods[this.lods.length-1];o.level<t.level&&(r=o)}if(!r)return;const i=t.level-r.level,s=r.resolution*this.size[0]/2**i,n=r.resolution*this.size[1]/2**i;t.id=`${t.level}/${t.row}/${t.col}`,t.extent||(t.extent=hr()),t.extent[0]=this.origin.x+t.col*s,t.extent[1]=this.origin.y-(t.row+1)*n,t.extent[2]=t.extent[0]+s,t.extent[3]=t.extent[1]+n}upsampleTile(t){const e=this._upsampleLevels[t.level];return!(!e||e.parentLevel===-1)&&(t.level=e.parentLevel,t.row=Math.floor(t.row/e.factor+.001),t.col=Math.floor(t.col/e.factor+.001),this.updateTileInfo(t),!0)}getTileBounds(t,e){const r=this.lodAt(e.level);if(r==null)return null;const{resolution:i}=r,s=i*this.size[0],n=i*this.size[1];return t[0]=this.origin.x+e.col*s,t[1]=this.origin.y-(e.row+1)*n,t[2]=t[0]+s,t[3]=t[1]+n,t}lodAt(t){var e;return((e=this._levelToLOD)==null?void 0:e[t])??null}clone(){return j0.fromJSON(this.write({}))}getOrCreateCompatible(t,e){if(this.size[0]===256&&this.size[1]===256)return t===256?this:null;const r=[],i=this.lods.length;for(let s=0;s<i;s++){const n=this.lods[s],o=n.resolution*e;r.push(new Jd({level:n.level,scale:n.scale,resolution:o}))}return new j0({size:[t,t],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:r})}_initializeUpsampleLevels(){const t=this.lods;this._upsampleLevels=[];let e=null;for(let r=0;r<t.length;r++){const i=t[r];this._upsampleLevels[i.level]={parentLevel:e?e.level:-1,factor:e?e.resolution/i.resolution:0},e=i}}};u([d({type:Number,json:{write:!0}})],To.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],To.prototype,"dpi",void 0),u([d({type:String,json:{read:bse.read,write:bse.write,origins:{"web-scene":{read:!1,write:!1}}}})],To.prototype,"format",void 0),u([d({readOnly:!0})],To.prototype,"isWrappable",null),u([d({type:_t,json:{write:!0}})],To.prototype,"origin",void 0),u([Le("origin")],To.prototype,"readOrigin",null),u([d({type:[Jd],value:null,json:{write:!0}})],To.prototype,"lods",null),u([d({readOnly:!0})],To.prototype,"minScale",void 0),u([d({readOnly:!0})],To.prototype,"maxScale",void 0),u([d({readOnly:!0})],To.prototype,"scales",void 0),u([d({cast:t=>Array.isArray(t)?t:typeof t=="number"?[t,t]:[256,256]})],To.prototype,"size",void 0),u([Le("size",["rows","cols"])],To.prototype,"readSize",null),u([ke("size",{cols:{type:Ti},rows:{type:Ti}})],To.prototype,"writeSize",null),u([d({type:We,json:{write:!0}})],To.prototype,"spatialReference",void 0),To=j0=u([P("esri.layers.support.TileInfo")],To),function(t){var e;(e=t.ExtrapolateOptions||(t.ExtrapolateOptions={}))[e.NONE=0]="NONE",e[e.POWER_OF_TWO=1]="POWER_OF_TWO"}(To||(To={}));const ND=To,TZe=12;let Ec=class Cl{constructor(e){const r=Cl.checkUnsupported(e);if(v(r))throw r;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=Aw(this.spatialReference)||wm(this.spatialReference)||xm(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const s=i.lods.reduce((c,h,p)=>(h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c),{min:1/0,minIndex:0,max:-1/0}),n=i.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,l/=2}clone(){return new Cl(this.toTileInfo())}toTileInfo(){return new ND({dpi:this.dpi,origin:new _t({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,r)=>new Jd({level:r,scale:e.scale,resolution:e.resolution}))})}getExtent(e,r,i,s){const n=this.levels[e],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+i*o,s[2]=this.origin[0]+(i+1)*o,s[3]=this.origin[1]-r*a,s[1]=this.origin[1]-(r+1)*a}convertExtentToRadians(e,r){this._isWebMercator?(r[0]=XQ(e[0]),r[1]=HN(e[1]),r[2]=XQ(e[2]),r[3]=HN(e[3])):this._isGCS&&(r[0]=jt(e[0]),r[1]=jt(e[1]),r[2]=jt(e[2]),r[3]=jt(e[3]))}getExtentGeometry(e,r,i,s=new Hr){return this.getExtent(e,r,i,Up),s.spatialReference=this.spatialReference,s.xmin=Up[0],s.ymin=Up[1],s.xmax=Up[2],s.ymax=Up[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(e==null)return!1;let r=!1;for(;this.levels.length<=e;){const i=this.levels[this.levels.length-1],s=i.resolution/2;this.levels.push({resolution:s,scale:i.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),r=!0}return r}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const r=this.levels[0].scale;return e>=r?0:Math.log(r/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof Cl)){if(Cl.checkUnsupported(e))return!1;e=new Cl(e)}if(!e.spatialReference.equals(this.spatialReference)||e.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[r].resolution;let s=.5*i;return!hS(e.origin[0],this.origin[0],s)||!hS(e.origin[1],this.origin[1],s)?!1:(s=.5*i/2**r/this.pixelSize*TZe,hS(i,e.levels[r].resolution,s))}rootTilesInExtent(e,r=null,i=1/0){const s=new Array,n=this.levels[0].tileSize;if(C(e)||n[0]===0||n[1]===0)return s;Cl.computeRowColExtent(e,n,this.origin,Up);let o=Up[1],a=Up[3],l=Up[0],c=Up[2];const h=c-l,p=a-o;if(h*p>i){const f=Math.floor(Math.sqrt(i));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let m=l;m<c;m++)s.push([0,f,m]);return v(r)&&(r[0]=this.origin[0]+l*n[0],r[1]=this.origin[1]-a*n[1],r[2]=this.origin[0]+c*n[0],r[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(e,r,i,s){const n=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+n-i[0])/r[0])),s[2]=Math.max(0,Math.ceil((e[2]-n-i[0])/r[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+n)/r[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-n)/r[1]))}static isPowerOfTwo(e){const r=e.lods,i=r[0].resolution*2**r[0].level;return!r.some(s=>!mLe(s.resolution,i/2**s.level))}static hasGapInLevels(e){const r=e.lods.map(i=>i.level);r.sort((i,s)=>i-s);for(let i=1;i<r.length;i++)if(r[i]!==r[0]+i)return!0;return!1}static tileSizeSupported(e){const r=e.size[1];return r===e.size[0]&&(r&r-1)==0&&r>=128&&r<=512}static hasOriginPerLODs(e){const r=e.origin;return e.lods.some(i=>i.origin!=null&&(i.origin[0]!==r.x||i.origin[1]!==r.y))}static getMissingTileInfoError(){return new j("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return C(e)?PZ():e.lods.length<1?new j("tilingscheme:generic","Tiling scheme must have at least one level"):Cl.isPowerOfTwo(e)?Cl.hasGapInLevels(e)?new j("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):Cl.tileSizeSupported(e)?Cl.hasOriginPerLODs(e)?new j("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new j("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new j("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,r){const i=e[2]-e[0],s=e[3]-e[1],n=al(r),o=1.2*Math.max(i,s),a=256,l=96,c=.0254,h=new Cl(new ND({size:[a,a],origin:new _t({x:e[0]-.5*(o-i),y:e[3]+.5*(o-s)}),lods:[new Jd({level:0,resolution:o/a,scale:1/(a/l*c/(o*n))})],spatialReference:r}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const r=new Cl(Cl.WebMercatorAuxiliarySphereTileInfo);return r.ensureMaxLod(e),r}static makeGCSWithTileSize(e,r=256,i=16){const s=256/r,n=new Cl(new ND({size:[r,r],origin:new _t({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new Jd({level:0,resolution:.703125*s,scale:295497598570834e-6*s})]}));return n.ensureMaxLod(i),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}};function PZ(){return new j("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}Ec.WebMercatorAuxiliarySphereTileInfo=new ND({size:[256,256],origin:new _t({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:We.WebMercator}),spatialReference:We.WebMercator,lods:[new Jd({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]}),Ec.WebMercatorAuxiliarySphere=Ec.makeWebMercatorAuxiliarySphere(19);const Up=hr(),j2=64,MR=512,SZe=2.5,I3=gLe(lz/10),Hbe=2,qbe=hr();Ec.WebMercatorAuxiliarySphere.getExtent(0,0,0,qbe);const EZe=hr([-180,-90,180,90]),CZe="Cannot extend surface to encompass all layers because it would result in too many root tiles.",AZe="Surface extent is too large for tile resolution at level 0.",RZe=3;let OZe=RZe;function Ej(t){return t<4?3:OZe}let H0=class extends Fs.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=I3}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if(e==null||C(e.extent)||C(e.spatialReference))return null;const r=o5(e.extent,e.spatialReference);return r.zmin=e.visibleElevationBounds.min,r.zmax=e.visibleElevationBounds.max,r}get spatialReference(){var e;return It((e=this.view.basemapTerrain)==null?void 0:e.spatialReference,We.WGS84)}elevationAt(e,r){var i;if(C(this.extent)||!Xa(this.extent,e,r)){const s=v(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return se.getLogger(this.declaredClass).warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler extent (${s})`),this.noDataValue}return It((i=this.view.elevationProvider)==null?void 0:i.getElevation(e,r,0,this.spatialReference,"ground"),this.noDataValue)}queryElevation(e){return Gbe(e.clone(),this)}};u([d({readOnly:!0})],H0.prototype,"demResolution",void 0),u([d({readOnly:!0})],H0.prototype,"extent",null),u([d({readOnly:!0})],H0.prototype,"noDataValue",void 0),u([d()],H0.prototype,"spatialReference",null),u([d({constructOnly:!0})],H0.prototype,"view",void 0),H0=u([P("esri.views.support.GroundViewElevationSampler")],H0);const MZe=H0;let q0=class extends Te{constructor(e){super(e),this._handles=new Zr,this.view=null,this.layerViews=new ft}initialize(){this._handles.add(ra(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.map)==null?void 0:r.ground},e=>e.load())),this._handles.add(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new MZe({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this._handles.remove("updating"),this._handles.add(this.layerViews.map(e=>ne(()=>e.updating,()=>this._updateUpdating(),ri)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],q0.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],q0.prototype,"updating",null),u([d({constructOnly:!0})],q0.prototype,"view",void 0),u([d({type:ft,readOnly:!0})],q0.prototype,"layerViews",void 0),u([d({readOnly:!0})],q0.prototype,"suspended",null),q0=u([P("esri.views.GroundView")],q0);const PZe=q0,IZe=t=>{let e=class extends t{async fetchPopupFeatures(r,i){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(r,i),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,i),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:Dk([l,...h]).then(p=>Array.from(new Set(p.flat()))),promisesPerLayerView:c}}_queryLayerPopupFeatures(r,i,s){return i.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:v(s)?s.event:void 0,signal:v(s)?s.signal:void 0,defaultPopupTemplateEnabled:!!v(s)&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(r,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(r,i){return r&&!!r.getEffectivePopupTemplate(v(i)&&i.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(r,i){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(r,i),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(r,i){const s=await this.popupHitTest(r),n=s.results,o=s.mapPoint,a=n.filter(c=>c.type==="graphic"&&this._isValidPopupGraphic(c.graphic,i)),l=a.length?a[0].mapPoint:null;return{clientGraphics:a.map(c=>c.graphic),queryArea:o,location:o||l}}_getFetchPopupLayerViews(){const r=[];return this.allLayerViews.forEach(i=>{this._isValidPopupLayerView(i)&&r.push(i)}),v(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&r.push(this.graphicsView),r.reverse()}_isValidPopupLayerView(r){return v(r)&&(!("layer"in r)||!r.suspended)&&"fetchPopupFeatures"in r}_graphicsPerFetchPopupLayerView(r,i){const s=[],n=new Map,o=i.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of r){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return e=u([P("esri.views.PopupView")],e),e};let IO=class extends vO{_own(e){e.layer&&"remove"in e.layer&&e.layer!==this.owner&&e.layer.remove(e),e.layer=this.owner}_release(e){e.layer===this.owner&&(e.layer=null)}};u([CW({Type:Sa,ensureType:Ls(Sa)})],IO.prototype,"itemType",void 0),IO=u([P("esri.support.GraphicsCollection")],IO);let W0=class extends Te{constructor(e){super(e),this.view=null,this.baseLayerViews=new ft,this.referenceLayerViews=new ft,this._loadingHandle=ne(()=>{var r,i;return(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.basemap},r=>{r&&r.load().catch(()=>{})},kt)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){var r,i;if(this.view&&this.view.suspended)return!1;const e=(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.basemap;return!!e&&!!e.loaded&&(this.baseLayerViews.some(s=>s.updating)||this.referenceLayerViews.some(s=>s.updating))}};u([d({constructOnly:!0})],W0.prototype,"view",void 0),u([d({readOnly:!0})],W0.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],W0.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],W0.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],W0.prototype,"updating",null),W0=u([P("esri.views.BasemapView")],W0);function $Ze(t){return"tryRecycleWith"in t}let LZe=class{constructor(e,r,i){this.layer=e,this.view=r,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=J_(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,ba(this._controller.signal,()=>{const s=new j("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(s)})}tryRecycle(e){if(!this.done||!this.layerView||!$Ze(this.layerView))return null;const r=this.layer.type,i=this._controller.signal;for(let s=0;s<e.length;s++){const n=e[s];if(n.type!==r)continue;const o=this.layerView.tryRecycleWith(n,{signal:i});if(o){e.splice(s,1),this.layer=n;const a=this.layerView,l=a.view;return this.promise=Promise.race([o.then(()=>(ur(this._controller.signal),n.emit("layerview-destroy",{view:l,layerView:a}),l.emit("layerview-destroy",{view:l,layerView:a}),n.emit("layerview-create",{view:l,layerView:a}),l.emit("layerview-create",{view:l,layerView:a}),a)),new Promise((c,h)=>ba(this._controller.signal,()=>h(qr())))]),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(!e)return;const{layer:r,view:i}=this;r.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:r,layerView:e}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){var s,n,o;if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:r,view:i}=this;this._map=i.map;try{let a,l;if(await r.load({signal:e}),"prefetchResources"in r&&await((s=r.prefetchResources)==null?void 0:s.call(r,{signal:e})),NZe(r))a=await r.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(r))throw new j("layer:view-not-supported","No layerview implementation was found");const p=await this.layerViewImporter.importLayerView(r);ur(e),a="default"in p?new p.default({layer:r,view:i}):new p({layer:r,view:i})}const c=()=>{l=Vi(l),a.destroyed||a.destroy(),a.layer=null,a.parent=null,a.view=null,this.done=!0};l=ba(e,c),ur(e);try{await a.when()}catch(p){throw c(),p}if(!((o=(n=this._map)==null?void 0:n.allLayers)==null?void 0:o.includes(r)))return c(),void this._deferred.reject(new j("view:no-layerview-for-layer","The layer has been removed from the map",{layer:r}));this.layerView=a,r.emit("layerview-create",{view:i,layerView:a}),i.emit("layerview-create",{layer:r,layerView:a}),this.done=!0,this._deferred.resolve(a)}catch(a){r.emit("layerview-create-error",{view:i,error:a}),i.emit("layerview-create-error",{layer:r,error:a}),this.done=!0,this._deferred.reject(new j("layerview:create-error","layerview creation failed",{layer:r,error:a}))}}},ph=class extends Te{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new em,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var i;const r=(i=this.view.map)==null?void 0:i.allLayers;if(r)for(const s of r)this.layerViewImporter.hasLayerViewModule(s)&&this.layerViewImporter.importLayerView(s)},this._reschedule=()=>(C(this._workPromise)&&(this._workPromise=J_(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(VE(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var l,c,h;const r=this.view.map;if(this._map!==r&&(this.clear(),this._map=r),C(this._workPromise))return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const i=new Set,s=[],n=this.view.ready,o=p=>{if(!C(p)){for(const f of p)if(f){i.add(f);const m=this._layerLayerViewInfoMap.get(f);m&&n?m.start():m||this._recyclingInfoMap.has(f)||s.push(f),"layers"in f&&f.layers&&o(f.layers)}}};for(const p of this._rootCollectionNames)o(this.get(p));for(const[p,f]of this._layerLayerViewInfoMap)if(!i.has(p)){this._layerLayerViewInfoMap.delete(f.layer);const m=f.tryRecycle(s);m?(this._recyclingInfoMap.set(f.layer,f),m.then(()=>{this._recyclingInfoMap.delete(f.layer),this._layerLayerViewInfoMap.set(f.layer,f),this._reschedule()}).catch(()=>{this._recyclingInfoMap.delete(f.layer),f.destroy(),this._reschedule()})):f.destroy()}for(const[p,f]of this._recyclingInfoMap)i.has(p)||(this._recyclingInfoMap.delete(f.layer),f.destroy());for(const p of s)this._createLayerView(p);this._refreshCollections();const a=[(l=r==null?void 0:r.ground)==null?void 0:l.layers,(c=r==null?void 0:r.basemap)==null?void 0:c.baseLayers,(h=r==null?void 0:r.basemap)==null?void 0:h.referenceLayers,r==null?void 0:r.layers].filter(p=>!!p);i.forEach(p=>"layers"in p&&a.push(p.layers)),this.addHandles(a.map(p=>this._watchUpdatingTracking.addOnCollectionChange(()=>p,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.own([an(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.map)==null?void 0:r.allLayers},"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),ne(()=>{const e=this.view,r=e==null?void 0:e.map;return[r==null?void 0:r.basemap,r==null?void 0:r.ground,r==null?void 0:r.layers,e==null?void 0:e.ready]},()=>this._reschedule(),qs)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null,v(this._workPromise)&&(this._workPromise.reject(qr()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return v(this._workPromise)||this._watchUpdatingTracking.updating||Yo(this._layerLayerViewInfoMap,e=>!e.done)}get updatingRemaining(){let e=0;for(const r of this._layerLayerViewInfoMap.values())r.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new j("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,r]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(r),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,r,i){if(!e||!r)return void(r&&r.removeAll());let s=0;for(const n of e){const o=this._layerLayerViewInfoMap.get(n);if(!o||!o.layerView)continue;const a=o.layerView;a.layer=n,a.parent=i,r.getItemAt(s)!==a&&r.splice(s,0,a),n.layers&&this._populateLayerViewsOwners(n.layers,a.layerViews,a),s+=1}s<r.length&&r.splice(s,r.length)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const r=new LZe(e,this.view,this.layerViewImporter);r.promise.then(()=>this._refreshCollections(),i=>{i&&(Ks(i)||i.name==="cancelled:layerview-create")||se.getLogger(this.declaredClass).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,r),this.view.ready&&r.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],ph.prototype,"_workPromise",void 0),u([d({readOnly:!0})],ph.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],ph.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],ph.prototype,"_rootCollectionNames",null),u([d()],ph.prototype,"layerViewImporter",void 0),u([d()],ph.prototype,"supportsGround",void 0),u([d({readOnly:!0})],ph.prototype,"updating",null),u([d({readOnly:!0})],ph.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],ph.prototype,"view",void 0),ph=u([P("esri.views.LayerViewManager")],ph);const DZe=ph;function NZe(t){return"createLayerView"in t&&t.createLayerView!=null}let ou=class extends Te{constructor(e){super(e),this.factor=1.5,this.offset=Zh(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],ou.prototype,"factor",void 0),u([d({nonNullable:!0})],ou.prototype,"offset",void 0),u([d()],ou.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],ou.prototype,"size",void 0),u([d()],ou.prototype,"maskUrl",void 0),u([d()],ou.prototype,"maskEnabled",void 0),u([d()],ou.prototype,"overlayUrl",void 0),u([d()],ou.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],ou.prototype,"version",null),u([d({type:Boolean})],ou.prototype,"visible",void 0),ou=u([P("esri.views.Magnifier")],ou);const Wbe=ou;let H2=class extends Te{constructor(e,r){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(r==null?void 0:r.registerTask(yt.TEXTURE_UNLOAD))??mE}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask.remove(),this._textureRequests.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests.clear()}get updating(){return this._frameTask.updating}fromData(e,r,i){const s=this.makeUid(e);let n=this._textureRequests.get(s);if(!n){const o=r();n={referenceCount:0,texture:o,textureAsync:null,abortController:null,onRemove:i},this._stage&&(this._stage.add(o),this._stage.loadImmediate(o)),this._textureRequests.set(s,n)}return n.referenceCount++,{uid:s,texture:n.texture,release:()=>this._release(s)}}_release(e){const r=this._textureRequests.get(e);r?(r.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),r.referenceCount--,r.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const r=this._textureRequests.get(e);!r||r.referenceCount>0||(this._releaseTextureRequest(r),this._textureRequests.delete(e))}_releaseTextureRequest(e){var r;e.onRemove&&e.onRemove(),e.texture?(r=this._stage)==null||r.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,r=null){return v(r)?`${e}.${r}px`:e}};u([d()],H2.prototype,"_frameTask",void 0),u([d()],H2.prototype,"updating",null),H2=u([P("esri.views.3d.support.TextureCollection")],H2);var wse;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"})(wse||(wse={}));const Xbe=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],Ybe={};function Zbe(t){return!!Ybe[t]}function FZe(t){for(const e of t)if(!Zbe(e))return!1;return!0}Xbe.forEach(t=>{Ybe[t]=!0});let UZe=class{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach(({handler:r,priority:i},s)=>{var n;return(n=this.inputManager)==null?void 0:n.installHandlers(s,[r],i)})}disconnect(){this.inputManager&&this._handlers.forEach((e,r)=>{var i;return(i=this.inputManager)==null?void 0:i.uninstallHandlers(r)}),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,r,i,s){const n=Array.isArray(e)?e:e.split(",");if(!FZe(n))return n.some(Zbe)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(r)?a=r:(o=r,a=[]),typeof i=="function"?o=i:s=i,s=s??j_.DEFAULT;const l=this._createUniqueGroupName(),c=new VZe(this.view,n,a,o);this._handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this._handlerCounts.get(h)||0;this._handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this._removeHandler(l,n)}}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,r){if(this._handlers.has(e)){this._handlers.delete(e);for(const i of r){const s=this._handlerCounts.get(i);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",i):s===1?this._handlerCounts.delete(i):this._handlerCounts.set(i,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}},VZe=class extends Fo{constructor(e,r,i,s){super(!0),this._latestDragStart=void 0,this.view=e;for(const n of r)switch(n){case"click":this.registerIncoming("click",i,o=>s(this._wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",i,o=>s(this._wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",i,o=>s(this._wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,o=>s(this._wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",i,o=>s(this._wrapHold(o)));break;case"drag":this.registerIncoming("drag",i,o=>{const a=this._wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",i,o=>s(this._wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",i,o=>s(this._wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",i,o=>s(this._wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",i,o=>s(this._wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",i,o=>s(this._wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,o=>s(this._wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,o=>s(this._wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,o=>s(this._wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,o=>s(this._wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",i,o=>{s(this._wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",i,o=>{s(this._wrapFocus(o))});break;case"blur":this.registerIncoming("blur",i,o=>{s(this._wrapBlur(o))})}}_wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:r=>e.async(r),preventDefault:()=>e.preventDefault()}}_wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:r=>e.async(r),preventDefault:()=>e.preventDefault()}}_wrapClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"click",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:Zh(n,o),mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}_wrapDoubleClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"double-click",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}_wrapImmediateClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-click",pointerId:c,pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}_wrapImmediateDoubleClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-double-click",pointerId:c,pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}_wrapHold(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a}=e.data,{cancelable:l,timestamp:c}=e;return{type:"hold",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this._getMapPoint(n,o),cancelable:l,stopPropagation:()=>e.stopPropagation(),async:h=>e.async(h),preventDefault:()=>e.preventDefault()}}_getMapPoint(e,r){return this.view.toMap(Zh(e,r),{exclude:[]})}_wrapDrag(e){const r=e.data,{x:i,y:s}=r.center,{action:n,pointerType:o,button:a}=r;if(n==="start"&&(this._latestDragStart=r),!this._latestDragStart)return;const l=r.pointer.native,c=r.buttons,{cancelable:h,timestamp:p}=e,f={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return n==="end"&&(this._latestDragStart=void 0),{type:"drag",action:n,x:i,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:r.radius,angle:ol(r.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:m=>e.async(m),preventDefault:()=>e.preventDefault()}}_wrapKeyDown(e){const{key:r,repeat:i,native:s}=e.data,{cancelable:n,timestamp:o}=e;return{type:"key-down",key:r,repeat:i,native:s,timestamp:o,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:a=>e.async(a),preventDefault:()=>e.preventDefault()}}_wrapKeyUp(e){const{key:r,native:i}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-up",key:r,native:i,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),async:o=>e.async(o),preventDefault:()=>e.preventDefault()}}_wrapPointer(e,r){const{x:i,y:s,button:n,buttons:o,native:a,eventId:l}=e.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=e;return{type:r,x:i,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:m=>e.async(m),preventDefault:()=>e.preventDefault()}}_wrapPointerDrag(e){const{x:r,y:i,buttons:s,native:n,eventId:o}=e.data.currentEvent,{button:a}=e.data.startEvent,l=e.data.startEvent.native.pointerId,c=e.data.startEvent.native.pointerType,h=e.data.action,p={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:f,timestamp:m}=e;return{type:"pointer-drag",x:r,y:i,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:m,eventId:o,cancelable:f,stopPropagation:()=>e.stopPropagation(),async:y=>e.async(y),preventDefault:()=>e.preventDefault()}}_wrapMouseWheel(e){const{cancelable:r,data:i,timestamp:s}=e,{x:n,y:o,deltaY:a,native:l}=i;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:r,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}_wrapGamepad(e){const{action:r,state:i,device:s}=e.data,{cancelable:n,timestamp:o}=e,{buttons:a,axes:l}=i;return{type:"gamepad",device:s,timestamp:o,action:r,buttons:a,axes:l,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}};var $3,xse,Tse;(function(t){t[t.USER=0]="USER",t[t.MANAGER=1]="MANAGER"})($3||($3={})),function(t){t[t.None=0]="None",t[t.Unfocused=1]="Unfocused",t[t.Focused=2]="Focused",t[t.Unselected=4]="Unselected",t[t.Selected=8]="Selected",t[t.All=15]="All"}(xse||(xse={})),function(t){t[t.None=0]="None",t[t.Custom1=16]="Custom1",t[t.Custom2=32]="Custom2",t[t.Custom3=64]="Custom3",t[t.Custom4=128]="Custom4",t[t.Custom5=256]="Custom5",t[t.Custom6=512]="Custom6",t[t.Custom7=1024]="Custom7",t[t.Custom8=2048]="Custom8",t[t.Custom9=4096]="Custom9",t[t.Custom10=8192]="Custom10",t[t.Custom11=16384]="Custom11",t[t.Custom12=32768]="Custom12",t[t.All=65520]="All"}(Tse||(Tse={}));function kZe(t){return[t.on("before-add",e=>{const r=e.item;if(r==null||t.includes(r))return se.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void e.preventDefault();r.onAdd()}),t.on("after-remove",e=>{const r=e.item;r.active&&(r.view.activeTool=null),r.destroy()})]}function Cj(t){return t.visible&&t.getEditableFlag!=null&&t.getEditableFlag($3.USER)&&t.getEditableFlag($3.MANAGER)}function _f(t){return Zh(t.x,t.y)}function vOt(t){return cs(t.x,t.y)}function Jbe(t,e){var i;const r=(i=t instanceof HTMLElement?t:t.surface)==null?void 0:i.getBoundingClientRect();return r?Zh(e.clientX-r.left,e.clientY-r.top):Zh(0,0)}function Sse(t,e){return e instanceof Event?Jbe(t,e):_f(e)}function Ese(t){if(t instanceof Event)return!0;if(typeof t=="object"&&"type"in t)switch(t.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}let zZe=class{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(e,r){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":Cse(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),e.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!Ase(e))break;const s=_f(e),n=this._intersect(s,e.pointerType,r.forEachTool);if(C(n))break;const o=n.manipulator,a=n.tool;!(v(o)&&v(a)&&o.interactive)||o.grabbable&&o.grabbableForEvent(e)||!o.grabbing||o.dragging||this._ungrabManipulatorBeforeDragging(o,e,r),v(o)&&v(a)&&o.interactive&&o.grabbable&&o.grabbableForEvent(e)&&!o.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:o,tool:a,start:s,pointerType:e.pointerType}),this._grabbedManipulators.size===1&&C(r.activeTool)&&(this._revertToNullActiveTool=!0,r.setActiveTool(n.tool)),o.grabbing=!0,o.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:s}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,r);break;case"pointer-drag":{if(!Ase(e))break;const s=this._grabbedManipulators.get(e.pointerId),n=ao(s,({manipulator:h})=>h),o=ao(s,({tool:h})=>h);if(C(n)||C(o))break;const a=_f(e);a.x=ye(a.x,0,r.view.width),a.y=ye(a.y,0,r.view.height);const l=s.start,c=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":e.action!=="update"&&this._grabbedManipulators.size!==1||(n.dragging=!0,c?n.events.emit("drag",{action:"update",start:l,screenPoint:a}):n.events.emit("drag",{action:"start",start:l,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:o,manipulator:n,start:l}));break;case"end":n.dragging=!1,c&&n.events.emit("drag",{action:"end",start:l,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,r)}i();break}case"immediate-click":{const s=_f(e),n=this._intersect(s,e.pointerType,r.forEachTool);if(BZe(e)||r.forEachTool(c=>{if((!v(n)||n.tool!==c||c.automaticManipulatorSelection)&&c.manipulators){let h=!1;c.manipulators.forEach(({manipulator:p})=>{p.selected&&(p.selected=!1,h=!0)}),h&&c.onManipulatorSelectionChanged&&c.onManipulatorSelectionChanged()}}),C(n))break;const{manipulator:o,tool:a}=n;if(!o.interactive)break;o.selectable&&a.automaticManipulatorSelection&&(o.selected=!o.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const l=e.native.shiftKey;o.events.emit("immediate-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:i});break}case"click":{const s=_f(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=v(n)?n.manipulator:null;if(C(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const s=_f(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=v(n)?n.manipulator:null;if(C(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i});break}case"immediate-double-click":{const s=_f(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=v(n)?n.manipulator:null;if(C(o)||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i});break}}this._onFocusChange(r.forEachTool)}_ungrabManipulatorBeforeDragging(e,r,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:_f(r)}),this._grabbedManipulators.forEach(({manipulator:s},n)=>{s===e&&this._grabbedManipulators.delete(n)}),this._afterManipulatorUngrab(i.setActiveTool)}_handlePointerEnd(e,r){const i=ao(this._grabbedManipulators.get(e.pointerId),({manipulator:s})=>s);C(i)||i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:_f(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(r.setActiveTool))}_cursorFromMap(e){let r=null;return Yo(e,({manipulator:i})=>!(C(i)||!i.interactive)&&(i.grabbing&&i.grabCursor?(r=i.grabCursor,!0):!!i.cursor&&(r=i.cursor,!0))),r}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const r=new Set,i=new Set;this._grabbedManipulators.forEach(({tool:s})=>{r.add(s)}),this._hoveredManipulators.forEach(({tool:s})=>{i.add(s)}),e(s=>{s.hasGrabbedManipulators=r.has(s),s.hasHoveredManipulators=i.has(s);const n=this._grabbedManipulators.values(),o=K3e(n,({tool:a})=>a===s);s.firstGrabbedManipulator=v(o)?o.manipulator:null})}clearPointers(e,{forEachTool:r,setActiveTool:i},s=!0,n){const o=(a,l)=>a===e&&(C(n)||n===l);this._grabbedManipulators.forEach(({tool:a,manipulator:l,pointerType:c},h)=>{o(a,l)&&(this._grabbedManipulators.delete(h),l.grabbing=!1,l.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:c}))}),this._draggedManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._draggedManipulators.delete(c),l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}),s&&this._hoveredManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._hoveredManipulators.delete(c),l.hovering=!1)}),this._afterManipulatorUngrab(i),this._onFocusChange(r)}_intersect(e,r,i){let s=null;return i(n=>{if(n.manipulators==null||!Cj(n))return!1;const o=n.manipulators.intersect(e,r);return!C(o)&&(s={tool:n,manipulator:o},!0)}),s}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((r,i)=>{this._updateHoveredStateForPointerAtScreenPosition(Zh(r.x,r.y),i,r.pointerType,e)})}handleHoverEvent(e,r){e.type!=="pointer-up"&&e.type!=="immediate-click"&&e.type!=="pointer-move"||!Cse(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(_f(e),e.pointerId,e.pointerType,r)}_updateHoveredStateForPointerAtScreenPosition(e,r,i,s){let n=this._intersect(e,i,s);const o=ao(this._hoveredManipulators.get(r),({manipulator:a})=>a);v(n)&&!n.manipulator.interactive&&(n=null),v(n)&&o===n.manipulator||(v(o)&&(o.hovering=!1),v(n)?(n.manipulator.hovering=!0,this._hoveredManipulators.set(r,n)):this._hoveredManipulators.delete(r),this._onFocusChange(s))}_afterManipulatorUngrab(e){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}};function Cse(t){return t==="mouse"}function Ase(t){return t.pointerType!=="mouse"||t.button===0}function BZe(t){return!!t.native.shiftKey}const Rse="attached",G8="tools";let yg=class extends E3{constructor(e){super(e),this._manipulatorState=new zZe,this.tools=new ft,this.cursor=null,this._forEachTool=r=>{for(const i of this.tools.items)if(r(i))return}}initialize(){this.handles.add([this.view.on(Xbe,e=>{this._handleInputEvent(e)},j_.TOOL),...kZe(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.detach(),this.handles.removeAll()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(v(e)&&!this.view.ready)return void se.getLogger(this.declaredClass).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const r=this.activeTool;this._set("activeTool",e),v(r)&&r.deactivate(),v(e)&&e.activate(),this._removeIncompleteTools(e);for(const i of this.tools){this._updateToolEditableFlag(i);const s=Cj(i);!C(this.activeTool)&&s||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!s)}this._updateCursor()}get updating(){var e;return this.updatingHandles.updating||this.tools.some(r=>r.updating)||(((e=this.textures)==null?void 0:e.updating)??!1)}attach(){var e;this.view.type==="3d"?(this._set("textures",new H2(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([ne(()=>{const{state:r}=this.view;return"camera"in r&&r.camera},()=>this._forEachManipulator(r=>r.onViewChange())),(e=this.view.elevationProvider)==null?void 0:e.on("elevation-change",r=>this._forEachManipulator(i=>i.onElevationChange(r))),yp(()=>this._set("textures",Ve(this.textures)))],Rse)):this.handles.add(ne(()=>this.view.extent,()=>this._forEachManipulator(r=>r.onViewChange())))}detach(){v(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(Rse)}_forEachManipulator(e){this._forEachTool(r=>{r.manipulators&&r.manipulators.forEach(({manipulator:i})=>e(i,r))})}_handleInputEvent(e){let r=!1;const i={...e,stopPropagation:()=>{r=!0,e.stopPropagation()}};v(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(s=>{!r&&s.visible&&s.handleInputEvent(i)}),!r&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),!r&&v(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(G8),this._forEachTool(e=>{if(e instanceof Te){const r=ne(()=>[e.cursor,e.visible,e.editable],()=>{Cj(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()});this.handles.add(r,G8)}e.manipulators&&this.handles.add([e.manipulators.on("after-remove",r=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,r.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})],G8)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){var r;(r=e.setEditableFlag)==null||r.call(e,$3.MANAGER,C(this.activeTool)||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;C(e)&&this._forEachTool(r=>!(!v(r.cursor)||!r.visible)&&(e=r.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(r=>(C(e)||r!==e)&&!r.created&&r.removeIncompleteOnCancel).forEach(r=>{this.tools.remove(r)})}};u([d({constructOnly:!0,nonNullable:!0})],yg.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],yg.prototype,"textures",void 0),u([d({value:null})],yg.prototype,"activeTool",null),u([d({readOnly:!0,type:ft})],yg.prototype,"tools",void 0),u([d({readOnly:!0})],yg.prototype,"cursor",void 0),u([d({readOnly:!0})],yg.prototype,"updating",null),yg=u([P("esri.views.ToolViewManager")],yg);const GZe=yg;let u2=class extends Te{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":jZe.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return this.nativeIndex!=null&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return HZe[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],u2.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],u2.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],u2.prototype,"axisThreshold",null),u2=u([P("esri.views.input.gamepad.GamepadInputDevice")],u2);const jZe=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),HZe={standard:.15,spacemouse:.025,unknown:0},IZ=u2;let PR=class extends Te{constructor(...e){super(...e),this.devices=new ft,this.enabledFocusMode="document"}};u([d({type:ft.ofType(IZ),readOnly:!0})],PR.prototype,"devices",void 0),u([d({type:["document","view","none"]})],PR.prototype,"enabledFocusMode",void 0),PR=u([P("esri.views.input.gamepad.GamepadSettings")],PR);const qZe=PR;let FD=class extends Te{constructor(){super(...arguments),this.gamepad=new qZe}};u([d({readOnly:!0})],FD.prototype,"gamepad",void 0),FD=u([P("esri.views.input.Input")],FD);const WZe=FD;let X0=class extends Te{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],X0.prototype,"enabled",void 0),u([d({type:IZ})],X0.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],X0.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],X0.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],X0.prototype,"velocityFactor",void 0),X0=u([P("esri.views.navigation.gamepad.GamepadSettings")],X0);const Kbe=X0;let nb=class extends Te{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new Kbe,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],nb.prototype,"browserTouchPanEnabled",void 0),u([d({type:Kbe,nonNullable:!0})],nb.prototype,"gamepad",void 0),u([d({type:Boolean})],nb.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],nb.prototype,"mouseWheelZoomEnabled",void 0),nb=u([P("esri.views.navigation.Navigation")],nb);const Qbe=nb;let Aj,j8=null;async function XZe(t){j8||(j8=ie(()=>Promise.resolve().then(()=>Xft),void 0,import.meta.url).then(e=>Aj=e)),await j8,ur(t)}async function ewe(t,e,r,i){if(!t)return null;const s=t.spatialReference;return yX()||rv(s,e)?GE(t,e):Aj?Aj.projectGeometry(t,e,r,i):(await Promise.race([XZe(i),iF(i)]),ewe(t,e,r,i))}let Ji=class extends Te{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=jh(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return v(this.userSpatialReference)?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return C(this.userSpatialReference)||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){var i,s,n,o;const e=(i=this.map)==null?void 0:i.call(this),r=[];return v(this.priorityCollection)&&r.push(this.priorityCollection),r.push({parent:e==null?void 0:e.basemap,layers:(s=e==null?void 0:e.basemap)==null?void 0:s.baseLayers},{layers:e==null?void 0:e.layers},{parent:e==null?void 0:e.ground,layers:(n=e==null?void 0:e.ground)==null?void 0:n.layers},{parent:e==null?void 0:e.basemap,layers:(o=e==null?void 0:e.basemap)==null?void 0:o.referenceLayers}),r}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:r}=this._allLayers;let i=null;for(const n of e){const o=this._getSupportedSpatialReferences(n);if(o.length>0){const a=this._narrowDownSpatialReferenceCandidates(i,o);v(a)&&(i=a)}if(v(i)&&i.length===1)break}if(r&&(C(i)||i.length!==1))return{updating:!0};const s=this._pickSpatialReferenceCandidate(i);return{spatialReference:v(s)?s.spatialReference:null,viewingMode:v(s)?s.viewingMode:null,updating:!1}}get _tileInfoTask(){var i,s,n,o,a,l,c;if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:r}=this._collectLayers([{parent:(s=(i=this.map)==null?void 0:i.call(this))==null?void 0:s.basemap,layers:(a=(o=(n=this.map)==null?void 0:n.call(this))==null?void 0:o.basemap)==null?void 0:a.baseLayers},{layers:(c=(l=this.map)==null?void 0:l.call(this))==null?void 0:c.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const h=e[0].tileInfo;return{tileInfo:h&&h.spatialReference.equals(this.spatialReference)?h:null,updating:!1}}return{updating:r}}get _heightModelInfoTask(){var i,s,n;if(!this.required.heightModelInfo||this.suspended&&((i=this._get("_heightModelInfoTask"))!=null&&i.heightModelInfo))return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:r}=this._allLayers;for(const o of e)if(pNe(o)){const a=cme(o);if(a)return{heightModelInfo:a,vcsWkid:(s=o.spatialReference)==null?void 0:s.vcsWkid,latestVcsWkid:(n=o.spatialReference)==null?void 0:n.latestVcsWkid,updating:!1}}return{updating:r}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,r=e.updating,i=[];for(const s of e.layers){const n="fullExtents"in s&&s.fullExtents||(v(s.fullExtent)?[s.fullExtent]:[]),o=this.requiresExtentInSpatialReference?null:n[0],a=n.find(l=>l.spatialReference.equals(this.spatialReference))??o;if(a)return{candidates:[{extent:a,layer:s}],updating:!1};if(this._getSupportedSpatialReferences(s).length>0)for(const l of n)i.push({extent:l,layer:s})}return{candidates:i,updating:r}}get _extentTask(){const{candidates:e,updating:r}=this._extentCandidatesTask;if(r)return{updating:r};if(C(e)||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),s=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:v(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(v(this._projectExtentTask.task)&&(this._projectExtentTask.task=jh(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:s.clone(),task:EM(async n=>{try{const o=await ewe(i.extent,s,i.layer.portalItem,n);this._projectExtentTask={...this._projectExtentTask,task:null,output:o}}catch{if(Fn(n))return;this._projectExtentTask={...this._projectExtentTask,task:null}}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,r){if(C(e))return r;const i=[],s=(n,o)=>v(n)?v(o)?n===o&&n:n:o;for(const n of e)for(const o of r){if(!n.spatialReference.equals(o.spatialReference))continue;const a=s(n.viewingMode,o.viewingMode);if(a!==!1){i.push({spatialReference:n.spatialReference,viewingMode:a});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const r=this.defaultSpatialReference;return C(e)||e.length<1?v(r)?{spatialReference:r,viewingMode:null}:null:(v(r)&&e.length>1&&e.some(({spatialReference:i})=>i.equals(r))&&(e=e.filter(({spatialReference:i})=>i.equals(r))),e.length>1&&e.some(({viewingMode:i})=>i!==Be.Local)&&(e=e.filter(({viewingMode:i})=>i!==Be.Local)),e[0])}_getSupportedSpatialReferences(e){const r="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(r.length===0)return[];const i=[];for(const s of r){const n=this.getSpatialReferenceSupport({spatialReference:s,layer:e});if(v(n)){const o=v(n.constraints)?n.constraints:[{spatialReference:s,viewingMode:null}];for(const{spatialReference:a,viewingMode:l}of o)(!this.requiresExtentInSpatialReference||C(this.userSpatialReference)||a.equals(this.userSpatialReference))&&i.push({spatialReference:a,viewingMode:l})}}return i}_pickExtentCandidate(e){const r=this.spatialReference;return e.find(({extent:i})=>r.equals(i.spatialReference))||e[0]}_collectLayers(e){var i;if(this._loadMaybe((i=this.map)==null?void 0:i.call(this))!=="loaded")return{layers:[],updating:!0};const r={layers:[],preloading:-1,updating:!1};for(const s of e)if(this._collectCollection(s,r),r.preloading===this.sourcePreloadCount)break;return{layers:r.layers,updating:r.updating}}_collectCollection(e,r){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return r.updating=!0,void++r.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":r.updating=!0,++r.preloading;break;case"loaded":r.updating||r.layers.push(i),"layers"in i&&this._collectCollection({layers:i.layers},r)}if(r.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(()=>{}),"loading"):e.loadStatus:"loaded"}};u([d()],Ji.prototype,"required",void 0),u([d({constructOnly:!0})],Ji.prototype,"map",void 0),u([d({constructOnly:!0})],Ji.prototype,"getSpatialReferenceSupport",void 0),u([d()],Ji.prototype,"defaultSpatialReference",void 0),u([d()],Ji.prototype,"userSpatialReference",void 0),u([d()],Ji.prototype,"sourcePreloadCount",void 0),u([d()],Ji.prototype,"priorityCollection",void 0),u([d()],Ji.prototype,"requiresExtentInSpatialReference",void 0),u([d()],Ji.prototype,"suspended",void 0),u([d({readOnly:!0})],Ji.prototype,"ready",null),u([d({readOnly:!0})],Ji.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],Ji.prototype,"spatialReference",null),u([d({readOnly:!0})],Ji.prototype,"extent",null),u([d({readOnly:!0})],Ji.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Ji.prototype,"vcsWkid",null),u([d({readOnly:!0})],Ji.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],Ji.prototype,"viewingMode",null),u([d({readOnly:!0})],Ji.prototype,"tileInfo",null),u([d({readOnly:!0})],Ji.prototype,"mapCollections",null),u([d({readOnly:!0})],Ji.prototype,"_allLayers",null),u([d({readOnly:!0})],Ji.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],Ji.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],Ji.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],Ji.prototype,"_extentCandidatesTask",null),u([d()],Ji.prototype,"_extentTask",null),u([d()],Ji.prototype,"_projectExtentTask",void 0),Ji=u([P("esri.views.support.DefaultsFromMap")],Ji);var UD;let Vt=UD=class extends ux(Fs.EventedMixin(SM(Te))){constructor(t){super(t),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new u3({getCollections:()=>{var e,r,i;return[(e=this.basemapView)==null?void 0:e.baseLayerViews,(r=this.groundView)==null?void 0:r.layerViews,this.layerViews,(i=this.basemapView)==null?void 0:i.referenceLayerViews]},getChildrenFunction:e=>e.layerViews}),this.groundView=null,this.basemapView=null,this.fatalError=null,this.graphics=new IO,this.analyses=new gE,this.typeSpecificPreconditionsReady=!0,this.layerViews=new ft,this.magnifier=new Wbe,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.timeReference=new xE,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new WZe,this.navigation=new Qbe,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new UZe(this),this.persistableViewModels=new ft,this._isValid=!1,this._readyCycleForced=!1,this._currentSpatialReference=null,this.handles.add(ne(()=>this.preconditionsReady,e=>{var r,i;e?(this._currentSpatialReference=this.spatialReference,UD.views.add(this)):(this._currentSpatialReference=null,UD.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?((r=this.toolViewManager)==null||r.detach(),v(this.analysisViewManager)&&this.analysisViewManager.detach(),(i=this.layerViewManager)==null||i.clear(),this._teardown()):e&&!this.ready&&(this._startup(),v(this.analysisViewManager)&&this.analysisViewManager.attach(),this.toolViewManager.attach())},ri))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,f3(()=>this.ready)))),this.basemapView=new W0({view:this}),this.layerViewManager=new DZe({view:this,layerViewImporter:{importLayerView:t=>this.importLayerView(t),hasLayerViewModule:t=>this.hasLayerViewModule(t)},supportsGround:this.supportsGround}),this.toolViewManager=new GZe({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([ne(()=>this.initialExtentRequired,t=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:t},{sync:!0,initial:!0}),ne(()=>this.ready,t=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=t,this.defaultsFromMap.userSpatialReference=t?this.spatialReference:this._userSpatialReference)},{sync:!0}),ne(()=>this._userSpatialReference,t=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=t)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let t=null;this.handles.add([ne(()=>{var e;return(e=this.defaultsFromMap)==null?void 0:e.ready},e=>{var i;const r=((i=this.map)==null?void 0:i.allLayers.length)>0;if(e&&!this.spatialReference&&r){if(v(t))return;const s=yp(()=>t=jh(t));t=EM(async n=>{try{await _w(this.spatialReferenceWarningDelay,null,n)}catch{return}finally{t=null}se.getLogger(this.declaredClass).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(s,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=Ve(this.graphics),this.analyses=Ve(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),Ve(this.analysisViewManager),this.toolViewManager=Ve(this.toolViewManager),this.layerViewManager=Ve(this.layerViewManager),this.basemapView=Ve(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const t=this.map;this.map=null,t==null||t.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return se.getLogger(this.declaredClass).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){var t;return(t=this.toolViewManager)==null?void 0:t.activeTool}set activeTool(t){this.toolViewManager&&(this.toolViewManager.activeTool=t)}get animation(){return this._get("animation")}set animation(t){this._set("animation",t)}get center(){return null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Ji({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:t=>this.getSpatialReferenceSupport(t),...this._defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(t){this._set("extent",t)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){var t;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||cm.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._currentSpatialReference&&!((t=this.defaultsFromMap)!=null&&t.ready)||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(t){t!==this._get("map")&&(t!=null&&t.destroyed&&(se.getLogger(this.declaredClass).warn("#map","The provided map is already destroyed",{map:t}),t=null),cm.isLoadable(t)&&t.load().catch(()=>{}),this.constructed&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",t))}get spatialReference(){var e,r;let t=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return t&&((r=(e=this.defaultsFromMap)==null?void 0:e.required)!=null&&r.heightModelInfo)&&(t=t.clone(),t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),t}set spatialReference(t){const e=!Cn(t,this._get("spatialReference"));this._set("_userSpatialReference",t),e&&(this._set("spatialReference",t),this._spatialReferenceChanged(t))}_spatialReferenceChanged(t){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get tools(){var t;return(t=this.toolViewManager)==null?void 0:t.tools}get initialExtent(){var t;return(t=this.defaultsFromMap)==null?void 0:t.extent}get cursor(){const t=this.toolViewManager?this.toolViewManager.cursor:null;return v(t)?t:this._cursor||"default"}set cursor(t){this._cursor=t,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(t){return this.layerViewManager.whenLayerView(t)}getDefaultSpatialReference(){var t;return(t=this.defaultsFromMap)==null?void 0:t.spatialReference}getDefaultHeightModelInfo(){var t;return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??((t=this.defaultsFromMap)==null?void 0:t.heightModelInfo)??null}importLayerView(t){throw new j("importLayerView() not implemented")}hasLayerViewModule(t){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(t){return v(this.getSpatialReferenceSupport({spatialReference:t}))}when(t,e){return this.isResolved()&&!this.ready&&se.getLogger(this.declaredClass).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(t,e)}forceReadyCycle(){this.ready&&(ra(()=>this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(t){this.toolViewManager.tools.add(t),this.activeTool=t}tryFatalErrorRecovery(){this.fatalError=null}};Vt.views=new ft,u([d()],Vt.prototype,"_userSpatialReference",void 0),u([d()],Vt.prototype,"activeTool",null),u([d({readOnly:!0})],Vt.prototype,"allLayerViews",void 0),u([d()],Vt.prototype,"groundView",void 0),u([d()],Vt.prototype,"animation",null),u([d()],Vt.prototype,"basemapView",void 0),u([d()],Vt.prototype,"center",null),u([d({readOnly:!0})],Vt.prototype,"_defaultsFromMapSettings",null),u([d()],Vt.prototype,"defaultsFromMap",null),u([d()],Vt.prototype,"fatalError",void 0),u([d({type:Hr})],Vt.prototype,"extent",null),u([d(I7(IO,"graphics"))],Vt.prototype,"graphics",void 0),u([d(I7(gE,"analyses"))],Vt.prototype,"analyses",void 0),u([d({readOnly:!0,type:Tv})],Vt.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Vt.prototype,"interacting",null),u([d({readOnly:!0})],Vt.prototype,"navigating",null),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Vt.prototype,"preconditionsReady",null),u([d({readOnly:!0})],Vt.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:ft,readOnly:!0})],Vt.prototype,"layerViews",void 0),u([d()],Vt.prototype,"resolution",null),u([d({type:Wbe})],Vt.prototype,"magnifier",void 0),u([d({value:null,type:bfe})],Vt.prototype,"map",null),u([d()],Vt.prototype,"padding",void 0),u([d({readOnly:!0})],Vt.prototype,"ready",void 0),u([d({type:We})],Vt.prototype,"spatialReference",null),u([d()],Vt.prototype,"spatialReferenceWarningDelay",void 0),u([d()],Vt.prototype,"stationary",null),u([d({readOnly:!0})],Vt.prototype,"supportsGround",void 0),u([d({type:Sm})],Vt.prototype,"timeExtent",void 0),u([d({type:xE,nonNullable:!0})],Vt.prototype,"timeReference",void 0),u([d()],Vt.prototype,"tools",null),u([d()],Vt.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],Vt.prototype,"type",void 0),u([d({type:Number})],Vt.prototype,"scale",void 0),u([d({readOnly:!0})],Vt.prototype,"updating",void 0),u([d({readOnly:!0})],Vt.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],Vt.prototype,"initialExtent",null),u([d()],Vt.prototype,"cursor",null),u([d({readOnly:!0})],Vt.prototype,"input",void 0),u([d({type:Qbe,nonNullable:!0})],Vt.prototype,"navigation",void 0),u([d()],Vt.prototype,"layerViewManager",void 0),u([d()],Vt.prototype,"analysisViewManager",void 0),u([d()],Vt.prototype,"width",void 0),u([d()],Vt.prototype,"height",void 0),u([d({readOnly:!0})],Vt.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],Vt.prototype,"size",null),u([d({readOnly:!0})],Vt.prototype,"suspended",void 0),u([d({readOnly:!0})],Vt.prototype,"viewEvents",void 0),u([d({readOnly:!0})],Vt.prototype,"persistableViewModels",void 0),u([d()],Vt.prototype,"_isValid",void 0),u([d()],Vt.prototype,"_readyCycleForced",void 0),u([d()],Vt.prototype,"_currentSpatialReference",void 0),Vt=UD=u([P("esri.views.View")],Vt);const YZe=Vt;let Y0=class extends BN{constructor(e){super(e),this.state="running",this.target=null,this._dfd=null}initialize(){this.addResolvingPromise(new Promise((e,r)=>this._dfd={resolve:e,reject:r}))}get done(){return this.state==="finished"||this.state==="stopped"}stop(){var e;this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),(e=this._dfd)==null||e.reject(new j("ViewAnimation stopped")))}finish(){var e;this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),(e=this._dfd)==null||e.resolve())}update(e,r){r||(r=Gu(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",r)}};u([d({readOnly:!0})],Y0.prototype,"done",null),u([d({readOnly:!0,type:String})],Y0.prototype,"state",void 0),u([d()],Y0.prototype,"target",void 0),Y0=u([P("esri.views.ViewAnimation")],Y0),function(t){t.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(Y0||(Y0={}));const TE=Y0,qC=()=>ie(()=>import("./TileLayerView3D-9b01dca1.js"),["./TileLayerView3D-9b01dca1.js","./LayerView3D-97ba5583.js","./TiledLayerView3D-13cd93c8.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./MapServiceLayerViewHelper-49a3be05.js","./floorFilterUtils-080a7cd2.js","./sublayerUtils-c4c3af57.js","./popupUtils-03b6c0d5.js","./drapedUtils-96d32e3e.js"],import.meta.url),Ose=()=>ie(()=>import("./ElevationLayerView3D-78a1ee1b.js"),["./ElevationLayerView3D-78a1ee1b.js","./LayerView3D-97ba5583.js","./TiledLayerView3D-13cd93c8.js","./LayerView-d64df35c.js"],import.meta.url),Mse={"base-dynamic":()=>ie(()=>import("./BaseDynamicLayerView3D-44e2b5b6.js"),["./BaseDynamicLayerView3D-44e2b5b6.js","./DynamicLayerView3D-e357d8af.js","./LayerView3D-97ba5583.js","./projectExtentUtils-3c4cd255.js","./ImageMaterial-484b2f88.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),"base-elevation":Ose,"base-tile":qC,"bing-maps":qC,"building-scene":()=>ie(()=>import("./BuildingSceneLayerView3D-01814941.js"),["./BuildingSceneLayerView3D-01814941.js","./BuildingGroupSublayer-47c8315b.js","./BuildingComponentSublayer-5bc7bbd0.js","./capabilities-a18453f6.js","./I3SIndexInfo-8130b3ee.js","./I3SLayerDefinitions-b73cbd18.js","./I3SUtil-eb079328.js","./I3SBinaryReader-9bc79bf8.js","./popupUtils-03b6c0d5.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./I3SMeshView3D-56e5b5b3.js","./I3SOverrides-8970e82c.js","./I3SNode-3c21486f.js","./RenderTexture-64129134.js","./FeatureLayerView3D-20cf7456.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./SceneModification-61bc04d7.js","./persistable-8541a096.js","./resourceExtension-f0bedfb3.js","./SceneLayerWorker-3c694ac0.js","./I3SQueryFeatureStore-4e0b315c.js","./DefinitionExpressionSceneLayerView-3ff629e1.js"],import.meta.url),csv:()=>ie(()=>import("./CSVLayerView3D-9fea80e5.js"),["./CSVLayerView3D-9fea80e5.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),dimension:()=>ie(()=>import("./DimensionLayerView3D-f828ea78.js"),["./DimensionLayerView3D-f828ea78.js","./LayerView3D-97ba5583.js","./LayerView-d64df35c.js"],import.meta.url),elevation:Ose,feature:()=>ie(()=>import("./FeatureLayerView3D-20cf7456.js"),["./FeatureLayerView3D-20cf7456.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),geojson:()=>ie(()=>import("./GeoJSONLayerView3D-0a8fcaba.js"),["./GeoJSONLayerView3D-0a8fcaba.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),graphics:()=>ie(()=>import("./GraphicsLayerView3D-d813cbb0.js"),["./GraphicsLayerView3D-d813cbb0.js","./LayerView3D-97ba5583.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./GraphicsProcessor-3457cb00.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./projectExtentUtils-3c4cd255.js","./LayerView-d64df35c.js"],import.meta.url),group:()=>ie(()=>import("./GroupLayerView-cf6b8c23.js"),["./GroupLayerView-cf6b8c23.js","./LayerView-d64df35c.js"],import.meta.url),imagery:()=>ie(()=>import("./ImageryLayerView3D-daa370f0.js"),["./ImageryLayerView3D-daa370f0.js","./DynamicLayerView3D-e357d8af.js","./LayerView3D-97ba5583.js","./projectExtentUtils-3c4cd255.js","./ImageMaterial-484b2f88.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./popupUtils-03b6c0d5.js"],import.meta.url),"integrated-mesh":()=>ie(()=>import("./IntegratedMeshLayerView3D-f596c1ee.js"),["./IntegratedMeshLayerView3D-f596c1ee.js","./I3SMeshView3D-56e5b5b3.js","./I3SOverrides-8970e82c.js","./I3SNode-3c21486f.js","./I3SUtil-eb079328.js","./I3SBinaryReader-9bc79bf8.js","./RenderTexture-64129134.js","./FeatureLayerView3D-20cf7456.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./SceneModification-61bc04d7.js","./persistable-8541a096.js","./resourceExtension-f0bedfb3.js","./SceneLayerWorker-3c694ac0.js"],import.meta.url),"line-of-sight":()=>ie(()=>import("./LineOfSightLayerView3D-0f10cdc5.js"),["./LineOfSightLayerView3D-0f10cdc5.js","./LayerView3D-97ba5583.js","./LayerView-d64df35c.js"],import.meta.url),"map-image":()=>ie(()=>import("./MapImageLayerView3D-02ca5a22.js"),["./MapImageLayerView3D-02ca5a22.js","./DynamicLayerView3D-e357d8af.js","./LayerView3D-97ba5583.js","./projectExtentUtils-3c4cd255.js","./ImageMaterial-484b2f88.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./ExportImageParameters-13de9749.js","./floorFilterUtils-080a7cd2.js","./sublayerUtils-c4c3af57.js","./MapServiceLayerViewHelper-49a3be05.js","./popupUtils-03b6c0d5.js","./drapedUtils-96d32e3e.js"],import.meta.url),media:()=>ie(()=>import("./MediaLayerView3D-4bb780ef.js"),["./MediaLayerView3D-4bb780ef.js","./MediaElementView-43b1563e.js","./normalizeUtilsSync-33bef895.js","./LayerView3D-97ba5583.js","./ImageMaterial-484b2f88.js","./LayerView-d64df35c.js"],import.meta.url),"ogc-feature":()=>ie(()=>import("./OGCFeatureLayerView3D-626050b1.js"),["./OGCFeatureLayerView3D-626050b1.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),"open-street-map":qC,"oriented-imagery":()=>ie(()=>import("./FeatureLayerView3D-20cf7456.js"),["./FeatureLayerView3D-20cf7456.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),"point-cloud":()=>ie(()=>import("./PointCloudLayerView3D-8d65700b.js").then(t=>t.P),["./PointCloudLayerView3D-8d65700b.js","./LayerView3D-97ba5583.js","./I3SUtil-eb079328.js","./I3SBinaryReader-9bc79bf8.js","./PointCloudWorkerUtil-ffa21555.js","./PointCloudUniqueValueRenderer-a7b43d4e.js","./PopupSceneLayerView-a978903b.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js"],import.meta.url),voxel:()=>ie(()=>import("./VoxelLayerView3D-dc58bbd9.js"),["./VoxelLayerView3D-dc58bbd9.js","./LayerView3D-97ba5583.js","./PopupSceneLayerView-a978903b.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js"],import.meta.url),route:()=>ie(()=>import("./RouteLayerView3D-15f28867.js"),["./RouteLayerView3D-15f28867.js","./Stop-fd04110c.js","./LayerView3D-97ba5583.js","./GraphicsProcessor-3457cb00.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./projectExtentUtils-3c4cd255.js","./EventedSet-a702b523.js","./LayerView-d64df35c.js"],import.meta.url),scene:t=>t.profile==null||t.profile==="mesh-pyramids"?ie(()=>import("./SceneLayerView3D-26c28710.js"),["./SceneLayerView3D-26c28710.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./floorFilterUtils-080a7cd2.js","./I3SMeshView3D-56e5b5b3.js","./I3SOverrides-8970e82c.js","./I3SNode-3c21486f.js","./I3SUtil-eb079328.js","./I3SBinaryReader-9bc79bf8.js","./RenderTexture-64129134.js","./FeatureLayerView3D-20cf7456.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./SceneModification-61bc04d7.js","./persistable-8541a096.js","./resourceExtension-f0bedfb3.js","./SceneLayerWorker-3c694ac0.js","./SceneLayerView-5ecb594c.js","./DefinitionExpressionSceneLayerView-3ff629e1.js","./I3SQueryFeatureStore-4e0b315c.js","./PopupSceneLayerView-a978903b.js"],import.meta.url):ie(()=>import("./SceneLayerGraphicsView3D-f33ce2c2.js"),["./SceneLayerGraphicsView3D-f33ce2c2.js","./I3SOverrides-8970e82c.js","./I3SNode-3c21486f.js","./I3SUtil-eb079328.js","./I3SBinaryReader-9bc79bf8.js","./RenderTexture-64129134.js","./FeatureLayerView3D-20cf7456.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./SceneLayerView-5ecb594c.js","./DefinitionExpressionSceneLayerView-3ff629e1.js","./PopupSceneLayerView-a978903b.js"],import.meta.url),stream:()=>ie(()=>import("./StreamLayerView3D-859cea4f.js"),["./StreamLayerView3D-859cea4f.js","./StreamFeatureManager-b8c144f8.js","./createConnection-292048b8.js","./EventedSet-a702b523.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./LayerView-d64df35c.js"],import.meta.url),tile:qC,"imagery-tile":()=>ie(()=>import("./ImageryTileLayerView3D-635f7535.js"),["./ImageryTileLayerView3D-635f7535.js","./LayerView3D-97ba5583.js","./TiledLayerView3D-13cd93c8.js","./rasterProjectionHelper-e9780e55.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./drapedUtils-96d32e3e.js"],import.meta.url),"vector-tile":()=>ie(()=>import("./VectorTileLayerView3D-13425e08.js"),["./VectorTileLayerView3D-13425e08.js","./Rect-98da58d6.js","./rasterizingUtils-5811f1b0.js","./StyleRepository-b88ac024.js","./enums-c655c737.js","./colorUtils-c0f43caf.js","./TileClipper-ae6eca9e.js","./TileInfoView-9eeb1a4a.js","./number-b10bd8f5.js","./GeometryUtils-0258f920.js","./LayerView3D-97ba5583.js","./TiledLayerView3D-13cd93c8.js","./LayerView-d64df35c.js"],import.meta.url),wcs:()=>ie(()=>import("./ImageryTileLayerView3D-635f7535.js"),["./ImageryTileLayerView3D-635f7535.js","./LayerView3D-97ba5583.js","./TiledLayerView3D-13cd93c8.js","./rasterProjectionHelper-e9780e55.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./drapedUtils-96d32e3e.js"],import.meta.url),"web-tile":qC,wfs:()=>ie(()=>import("./WFSLayerView3D-c780f1b0.js"),["./WFSLayerView3D-c780f1b0.js","./FeatureLayerViewBase3D-368069d8.js","./FeatureLikeLayerView3D-330eaa34.js","./dehydratedFeatureComparison-a2ea08a8.js","./queryForSymbologySnapping-a2228428.js","./elevationInfoUtils-29abecab.js","./hash-0ddfbf4b.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js","./floorFilterUtils-080a7cd2.js","./QueryEngine-784c28ef.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./FeatureStore-751deec3.js","./BoundsStore-81e0bf78.js","./projectExtentUtils-3c4cd255.js","./LayerView3D-97ba5583.js","./EventedSet-a702b523.js","./popupUtils-03b6c0d5.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),wms:()=>ie(()=>import("./WMSLayerView3D-80d2c6e3.js"),["./WMSLayerView3D-80d2c6e3.js","./DynamicLayerView3D-e357d8af.js","./LayerView3D-97ba5583.js","./projectExtentUtils-3c4cd255.js","./ImageMaterial-484b2f88.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js","./ExportWMSImageParameters-f5c5076b.js"],import.meta.url),wmts:()=>ie(()=>import("./WMTSLayerView3D-3d2a2b4c.js"),["./WMTSLayerView3D-3d2a2b4c.js","./LayerView3D-97ba5583.js","./TiledLayerView3D-13cd93c8.js","./LayerView-d64df35c.js","./RefreshableLayerView-7e544a95.js"],import.meta.url),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};function ZZe(t){const e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",r=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new j(`${r}:view-not-supported`,`${e} is not supported in 3D`)}const Pse={hasLayerViewModule:t=>v(Mse[t.type]),importLayerView:t=>{const e=Mse[t.type];if(C(e))throw ZZe(t);return e(t)}},Ise="analyses-owner-handles";var q2,Ib;(function(t){t[t.PENDING=0]="PENDING",t[t.CREATED=1]="CREATED"})(q2||(q2={})),function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED"}(Ib||(Ib={}));let ob=class extends E3{constructor(e){super(e),this._allAnalysisViews=new ft,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=$se(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(qr("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(qr()),this._attachedToViewResolver=$se()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const r=this._items.get(e);if(C(r)||r.state.list===Ib.REMOVED)throw new j("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return r.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),Ise)}_disconnectOwners(){this.handles.remove(Ise),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const s of e)this._addAnalysis(s);const r=e.on("after-add",s=>this._addAnalysis(s.item)),i=e.on("after-remove",s=>this._removeAnalysis(s.item));return{remove:()=>{r.remove(),i.remove();for(const s of e)this._removeAnalysis(s)}}}_addAnalysis(e){const r=this._items.get(e);if(r==null){const i={state:{view:q2.PENDING,list:Ib.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=EM(s=>this._createAnalysisViewPromise(i,s))}else r.state.list=Ib.ADDED}_removeAnalysis(e){const r=this._items.get(e);r!=null?(r.state.list=Ib.REMOVED,this._scheduleUpdate()):se.getLogger(this.declaredClass).error("Trying to remove analysis which was not added")}_scheduleUpdate(){v(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=VE(()=>this._update()))}_update(){this._scheduledUpdateHandle=Vi(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===Ib.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case q2.PENDING:e.createAnalysisViewTask=jh(e.createAnalysisViewTask);break;case q2.CREATED:v(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=Ve(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,r){const i=e.analysis,s=i.type,n=this._analysisModules[s];if(this._creatingViewCount+=1,C(n.module))try{n.module=await this._loadAnalysisModule(s)}catch(a){throw this._creatingViewCount-=1,a}if(Fn(r))throw this._creatingViewCount-=1,qr("AnalysisView creation aborted");const o=new n.module.default({analysis:i,view:this.view});try{await o.when()}catch(a){throw this._creatingViewCount-=1,a}if(Fn(r))throw this._creatingViewCount-=1,o.destroy(),qr("AnalysisView creation aborted");return e.view=o,e.state.view=q2.CREATED,this._allAnalysisViews.add(o),this._creatingViewCount-=1,o}_loadAnalysisModule(e){switch(e){case"area-measurement":return ie(()=>import("./AreaMeasurementAnalysisView3D-41b3b96a.js").then(r=>r.A),["./AreaMeasurementAnalysisView3D-41b3b96a.js","./analysisThemeUtils-cc6a28f7.js","./Segment-42160f38.js","./LineVisualElement-451dda47.js","./elevationInfoUtils-29abecab.js","./geometryEngine-d22e3270.js","./geometryEngineBase-e1a33b0a.js","./hydrated-739aa8cc.js","./EditGeometryOperations-77692158.js"],import.meta.url);case"dimension":return ie(()=>import("./DimensionAnalysisView3D-851437f1.js").then(r=>r.D),["./DimensionAnalysisView3D-851437f1.js","./LineVisualElement-451dda47.js","./LengthDimension-d6ce4310.js","./Segment-42160f38.js","./elevationInfoUtils-29abecab.js","./analysisViewUtils-edf65efa.js","./ImageMaterial-484b2f88.js","./Factory-03ff2bed.js","./RightAngleQuadVisualElement-aef75657.js","./VisualElementResources-2125ab49.js","./PointVisualElement-4eb90ef4.js","./colorUtils-c0f43caf.js","./EditGeometryOperations-77692158.js","./QueryEngineResult-caf504b9.js","./WhereClause-544968d0.js","./executionError-fb3f283a.js","./utils-4f7e58a0.js","./generateRendererUtils-f3aa3521.js","./json-48e3ea08.js","./dehydratedFeatureComparison-a2ea08a8.js","./RenderTexture-64129134.js"],import.meta.url);case"direct-line-measurement":return ie(()=>import("./DirectLineMeasurementAnalysisView3D-9b3fc09f.js").then(r=>r.D),["./DirectLineMeasurementAnalysisView3D-9b3fc09f.js","./analysisThemeUtils-cc6a28f7.js","./Segment-42160f38.js","./LineVisualElement-451dda47.js","./elevationInfoUtils-29abecab.js","./geometryEngine-d22e3270.js","./geometryEngineBase-e1a33b0a.js","./hydrated-739aa8cc.js","./RightAngleQuadVisualElement-aef75657.js","./VisualElementResources-2125ab49.js"],import.meta.url);case"line-of-sight":return ie(()=>import("./LineOfSightAnalysisView3D-1f64604b.js"),["./LineOfSightAnalysisView3D-1f64604b.js","./LineVisualElement-451dda47.js","./LineOfSightAnalysisTarget-09692435.js","./persistable-8541a096.js","./resourceExtension-f0bedfb3.js","./elevationInfoUtils-29abecab.js","./analysisViewUtils-edf65efa.js","./ImageMaterial-484b2f88.js","./PointVisualElement-4eb90ef4.js","./VisualElementResources-2125ab49.js"],import.meta.url);case"slice":return ie(()=>import("./SliceAnalysisView3D-fa589f0d.js").then(r=>r.S),["./SliceAnalysisView3D-fa589f0d.js","./LineVisualElement-451dda47.js","./persistable-8541a096.js","./resourceExtension-f0bedfb3.js","./BuildingComponentSublayer-5bc7bbd0.js","./capabilities-a18453f6.js","./I3SIndexInfo-8130b3ee.js","./I3SLayerDefinitions-b73cbd18.js","./I3SUtil-eb079328.js","./I3SBinaryReader-9bc79bf8.js","./popupUtils-03b6c0d5.js","./analysisViewUtils-edf65efa.js","./ImageMaterial-484b2f88.js","./Factory-03ff2bed.js"],import.meta.url)}}};function $se(){const t=K_();return t.promise.catch(()=>{}),t}u([d()],ob.prototype,"updating",null),u([d({constructOnly:!0})],ob.prototype,"view",void 0),u([d()],ob.prototype,"_allAnalysisViews",void 0),u([d()],ob.prototype,"_creatingViewCount",void 0),ob=u([P("esri.views.3d.analysis.AnalysisViewManager3D")],ob);const JZe=ob;let _g=class extends Te{constructor(e){super(e),this.collision=new IR,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Be.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Be.Local?this._set("altitude",e):se.getLogger(this.declaredClass).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ye(e,this.altitude.min,this.altitude.max):e}clampTilt(e,r){if(!this.tilt)return r;const i=this.tilt(e);return ye(r,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Be.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(r,i=H8)=>(i.min=Wo.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?$L([[4e3,Wo.max],[1e4,jt(88)],[6e6,jt(88)]]):()=>Wo.max;return(r,i=H8)=>(i.min=Wo.min,i.max=e(r),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?$L([[4e3,Wo.max],[5e4,jt(88)],[6e6,jt(88)],[2e7,Wo.min]]):$L([[3e5,Wo.max],[3e6,jt(88)],[6e6,jt(88)],[2e7,Wo.min]]);return(r,i=H8)=>(i.min=Wo.min,i.max=e(r),i)}};function KZe(t){return{min:-2e5,max:4*t.radius}}u([d()],_g.prototype,"altitude",null),u([d({readOnly:!0})],_g.prototype,"collision",void 0),u([d()],_g.prototype,"distance",void 0),u([d({readOnly:!0})],_g.prototype,"minimumPoiDistance",void 0),u([d()],_g.prototype,"tilt",void 0),u([d({constructOnly:!0})],_g.prototype,"mode",void 0),_g=u([P("esri.views.3d.state.Constraints")],_g);const Lse=KZe(br),Wo={min:jt(.5),max:jt(179.5)},H8={min:0,max:0};let IR=class extends Te{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],IR.prototype,"enabled",void 0),u([d({type:Number})],IR.prototype,"elevationMargin",void 0),IR=u([P("esri.views.3d.state.Constraints.CollisionConstraint")],IR);let W2=class extends Te{constructor(){super(...arguments),this.min=Lse.min,this.max=Lse.max}};u([d({type:Number})],W2.prototype,"min",void 0),u([d({type:Number})],W2.prototype,"max",void 0),W2=u([P("esri.views.3d.constraints.AltitudeConstraint")],W2);let Rg=class extends Te{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,r){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==r&&this._set("far",r))}};u([d({type:Number,value:1e-8})],Rg.prototype,"near",null),u([Gt("near")],Rg.prototype,"castNear",null),u([d({type:Number,value:1e-8})],Rg.prototype,"far",null),u([Gt("far")],Rg.prototype,"castFar",null),u([d({type:["auto","manual"]})],Rg.prototype,"mode",void 0),Rg=u([P("esri.views.3d.constraints.ClipDistanceConstraint")],Rg);const Rj={min:ol(Wo.min),max:ol(Wo.max)};let $b=class extends Te{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ye(e,Rj.min,Rj.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],$b.prototype,"mode",void 0),u([d({type:Number,value:Rj.max})],$b.prototype,"max",null),u([Gt("max")],$b.prototype,"castMax",null),$b=u([P("esri.views.3d.constraints.TiltConstraint")],$b);let Lb=class extends Te{constructor(){super(...arguments),this.tilt=new $b,this.altitude=new W2,this.clipDistance=new Rg}};u([d({type:$b})],Lb.prototype,"tilt",void 0),u([d({type:W2})],Lb.prototype,"altitude",void 0),u([d({type:Rg})],Lb.prototype,"clipDistance",void 0),Lb=u([P("esri.views.3d.constraints.Constraints")],Lb);var h2;let vf=h2=class extends Fs.EventedMixin(Ow){constructor(t){super(t),this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),r=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",r),this._set("date",r)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(t){return new h2(t.cloneConstructProperties())}set defaultDate(t){const e=this._get("date")===this._get("defaultDate");t=new Date(t.getTime()),this._set("defaultDate",t),e&&this._set("date",t)}set date(t){t!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(t.getTime())))}autoUpdate(t,e){const r=h2.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let i=null;v(t)&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(t.getTime())?(i=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(i=this.date&&this.date.getTime(),this._set("date",new Date(t.getTime()))));const s=h2.calculateTimezoneOffset(this.positionTimezoneInfo);if(r!==s&&(q8.target=this,q8.timezoneOffset=s,this.emit("timezone-will-change",q8)),v(t))return!!isNaN(t.getTime())||i!==t.getTime()}clone(){const t=this._get("date")===this._get("defaultDate"),e=new h2({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return t&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(t){const e=this.clone();return t.date!=null&&(e.date=t.date),e.directShadowsEnabled=t.directShadowsEnabled,e.displayUTCOffset=t.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],vf.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],vf.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],vf.prototype,"waterReflectionEnabled",void 0),u([d({type:Date})],vf.prototype,"defaultDate",null),u([d({type:Date})],vf.prototype,"date",null),vf=h2=u([P("esri.views.3d.environment.SunLighting")],vf),function(t){function e({hours:r,minutes:i,seconds:s}){return Math.round(r+i/60+s/3600)}t.calculateTimezoneOffset=e}(vf||(vf={}));const q8={target:null,timezoneOffset:0},Z0=vf;var VD;let d2=VD=class extends Fs.EventedMixin(PM){constructor(t){super(t),this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.cameraTrackingEnabled=!0}clone(){return new VD({...this.cloneConstructProperties(),ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(t){return new VD(t.cloneConstructProperties())}cloneWithWebsceneLighting(t){const e=this.clone();return e.directShadowsEnabled=t.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],d2.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],d2.prototype,"waterReflectionEnabled",void 0),u([d({type:Boolean})],d2.prototype,"cameraTrackingEnabled",void 0),d2=VD=u([P("esri.views.3d.environment.VirtualLighting")],d2);const $R=d2,QZe={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Z0,virtual:$R}};var Oj;let $O=Oj=class extends Te{set quality(t){["low","high"].includes(t)&&this._set("quality",t)}clone(){return new Oj({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],$O.prototype,"quality",null),$O=Oj=u([P("esri.views.3d.environment.SceneViewAtmosphere")],$O);var LR;let p2=LR=class extends tE{constructor(t){super(t),this.atmosphere=new $O,this.lighting=new Z0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(t){const e=t.cloneConstructProperties();return new LR({...e,lighting:e.lighting?e.lighting.type==="virtual"?$R.fromWebsceneLighting(e.lighting):Z0.fromWebsceneLighting(e.lighting):void 0})}castLighting(t){return this._convertLighting(t)}applyLighting(t){this.lighting=this._convertLighting(t)}_convertLighting(t){var e,r;return t?t instanceof Z0||t instanceof $R?t:t instanceof Ow?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(t):new Z0({...t.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):t instanceof PM?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t):new $R({...t.cloneConstructProperties(),...(r=this.lighting)==null?void 0:r.cloneNonPersistentConstructProperties()}):_p(QZe,t):new Z0}clone(){return new LR({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:te(this.background)})}cloneWithWebsceneEnvironment(t){return new LR({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:te(this.background),...t.cloneConstructProperties(),lighting:this._getLighting(t)})}_getLighting(t){switch(t.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(t.lighting):Z0.fromWebsceneLighting(t.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t.lighting):$R.fromWebsceneLighting(t.lighting);default:return t.lighting,Z0.fromWebsceneLighting(t.lighting)}}};u([d({type:$O,json:{read:!1},nonNullable:!0})],p2.prototype,"atmosphere",void 0),u([d({nonNullable:!0})],p2.prototype,"lighting",void 0),u([Gt("lighting")],p2.prototype,"castLighting",null),p2=LR=u([P("esri.views.3d.environment.SceneViewEnvironment")],p2);const f2=p2;var Mn;(function(t){t[t.Simple=0]="Simple",t[t.Realistic=1]="Realistic",t[t.Panoramic=2]="Panoramic",t[t.None=3]="None"})(Mn||(Mn={}));function zn(t,e){return t[0]=e[0],t[1]=e[1],t}function ar(t,e,r){return t[0]=e,t[1]=r,t}function Xd(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function Vf(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function twe(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function rwe(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function eJe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function tJe(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function rJe(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t}function iJe(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t}function sJe(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function Cc(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t}function nJe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t}function Vw(t,e){const r=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(r*r+i*i)}function HF(t,e){const r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i}function $Z(t){const e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}function iwe(t){const e=t[0],r=t[1];return e*e+r*r}function LZ(t,e){return t[0]=-e[0],t[1]=-e[1],t}function oJe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function L3(t,e){const r=e[0],i=e[1];let s=r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s),t}function gn(t,e){return t[0]*e[0]+t[1]*e[1]}function aJe(t,e,r){const i=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=i,t}function m2(t,e,r,i){const s=e[0],n=e[1];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t}function lJe(t,e){e=e||1;const r=2*CM()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t}function Mj(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[2]*s,t[1]=r[1]*i+r[3]*s,t}function ab(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[2]*s+r[4],t[1]=r[1]*i+r[3]*s+r[5],t}function cJe(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[3]*s+r[6],t[1]=r[1]*i+r[4]*s+r[7],t}function uJe(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[4]*s+r[12],t[1]=r[1]*i+r[5]*s+r[13],t}function hJe(t,e,r,i){const s=e[0]-r[0],n=e[1]-r[1],o=Math.sin(i),a=Math.cos(i);return t[0]=s*a-n*o+r[0],t[1]=s*o+n*a+r[1],t}function dJe(t,e){const r=t[0],i=t[1],s=e[0],n=e[1];let o=r*r+i*i;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(r*s+i*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function pJe(t){return"vec2("+t[0]+", "+t[1]+")"}function swe(t,e){return t[0]===e[0]&&t[1]===e[1]}function nwe(t,e){const r=t[0],i=t[1],s=e[0],n=e[1],o=Oa();return Math.abs(r-s)<=o*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-n)<=o*Math.max(1,Math.abs(i),Math.abs(n))}function fJe(t,e,r,i,s){let n=e[0]-r[0],o=e[1]-r[1];const a=(i[0]*n+i[1]*o)*(s-1);return n=i[0]*a,o=i[1]*a,t[0]=e[0]+n,t[1]=e[1]+o,t}const mJe=$Z,gJe=Vf,yJe=twe,_Je=rwe,owe=Vw,vJe=HF,bJe=iwe;Object.freeze(Object.defineProperty({__proto__:null,add:Xd,angle:dJe,ceil:eJe,copy:zn,cross:aJe,dist:owe,distance:Vw,div:_Je,divide:rwe,dot:gn,equals:nwe,exactEquals:swe,floor:tJe,inverse:oJe,len:mJe,length:$Z,lerp:m2,max:iJe,min:rJe,mul:yJe,multiply:twe,negate:LZ,normalize:L3,projectAndScale:fJe,random:lJe,rotate:hJe,round:sJe,scale:Cc,scaleAndAdd:nJe,set:ar,sqrDist:vJe,sqrLen:bJe,squaredDistance:HF,squaredLength:iwe,str:pJe,sub:gJe,subtract:Vf,transformMat2:Mj,transformMat2d:ab,transformMat3:cJe,transformMat4:uJe},Symbol.toStringTag,{value:"Module"}));function DZ(t){return ye((t-1e5)/(1e6-1e5),0,1)}const Pj=1e4,wJe=.085,D3=1e5;let xJe=class{};const pi=xJe;function w(t,...e){let r="";for(let i=0;i<e.length;i++)r+=t[i]+e[i];return r+=t[t.length-1],r}(function(t){function e(i){return Math.round(i).toString()}function r(i){return i.toPrecision(8)}t.int=e,t.float=r})(w||(w={}));var A;(function(t){t.POSITION="position",t.NORMAL="normal",t.UV0="uv0",t.AUXPOS1="auxpos1",t.AUXPOS2="auxpos2",t.COLOR="color",t.SYMBOLCOLOR="symbolColor",t.SIZE="size",t.TANGENT="tangent",t.OFFSET="offset",t.SUBDIVISIONFACTOR="subdivisionFactor",t.COLORFEATUREATTRIBUTE="colorFeatureAttribute",t.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",t.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",t.DISTANCETOSTART="distanceToStart",t.UVMAPSPACE="uvMapSpace",t.BOUNDINGRECT="boundingRect",t.UVREGION="uvRegion",t.NORMALCOMPRESSED="normalCompressed",t.PROFILERIGHT="profileRight",t.PROFILEUP="profileUp",t.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",t.FEATUREVALUE="featureValue",t.MODELORIGINHI="modelOriginHi",t.MODELORIGINLO="modelOriginLo",t.MODEL="model",t.MODELNORMAL="modelNormal",t.INSTANCECOLOR="instanceColor",t.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",t.LOCALTRANSFORM="localTransform",t.GLOBALTRANSFORM="globalTransform",t.BOUNDINGSPHERE="boundingSphere",t.MODELORIGIN="modelOrigin",t.MODELSCALEFACTORS="modelScaleFactors",t.FEATUREATTRIBUTE="featureAttribute",t.STATE="state",t.LODLEVEL="lodLevel",t.POSITION0="position0",t.POSITION1="position1",t.NORMALA="normalA",t.NORMALB="normalB",t.COMPONENTINDEX="componentIndex",t.VARIANTOFFSET="variantOffset",t.VARIANTSTROKE="variantStroke",t.VARIANTEXTENSION="variantExtension",t.U8PADDING="u8padding",t.U16PADDING="u16padding",t.SIDENESS="sideness",t.START="start",t.END="end",t.UP="up",t.EXTRUDE="extrude",t.OBJECTANDLAYERIDCOLOR="objectAndLayerIdColor",t.OBJECTANDLAYERIDCOLOR_INSTANCED="objectAndLayerIdColor_instanced"})(A||(A={}));var Xs;function tm(t,e){switch(e.textureCoordinateType){case Xs.Default:return t.attributes.add(A.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(w`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case Xs.Compressed:return t.attributes.add(A.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(w`vec2 getUV0() {
return uv0 / 16384.0;
}
void forwardTextureCoordinates() {
vuv0 = getUV0();
}`);case Xs.Atlas:return t.attributes.add(A.UV0,"vec2"),t.varyings.add("vuv0","vec2"),t.attributes.add(A.UVREGION,"vec4"),t.varyings.add("vuvRegion","vec4"),void t.vertex.code.add(w`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:e.textureCoordinateType;case Xs.None:return void t.vertex.code.add(w`void forwardTextureCoordinates() {}`);case Xs.COUNT:return}}(function(t){t[t.None=0]="None",t[t.Default=1]="Default",t[t.Atlas=2]="Atlas",t[t.Compressed=3]="Compressed",t[t.COUNT=4]="COUNT"})(Xs||(Xs={}));function jc(t){t.code.add(w`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function ku(t){t.include(jc),t.code.add(w`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}function l6(t){t.fragment.code.add(w`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var di;(function(t){t[t.Pass=0]="Pass",t[t.Draw=1]="Draw"})(di||(di={}));let ws=class{constructor(e,r,i,s,n=null){this.name=e,this.type=r,this.arraySize=n,this.bind={[di.Pass]:null,[di.Draw]:null},v(i)&&v(s)&&(this.bind[i]=s)}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},Wt=class extends ws{constructor(e,r){super(e,"vec3",di.Pass,(i,s,n)=>i.setUniform3fv(e,r(s,n)))}},Pe=class extends ws{constructor(e,r){super(e,"float",di.Pass,(i,s,n)=>i.setUniform1f(e,r(s,n)))}};function by(t){t.uniforms.add(new Wt("mainLightDirection",(e,r)=>r.lighting.mainLight.direction))}function Cm(t){t.uniforms.add(new Wt("mainLightIntensity",(e,r)=>r.lighting.mainLight.intensity))}function TJe(t,e){e.useLegacyTerrainShading?t.uniforms.add(new Pe("lightingFixedFactor",(r,i)=>i.lighting.noonFactor*(1-i.lighting.globalFactor))):t.constants.add("lightingFixedFactor","float",0)}function qF(t,e){const r=t.fragment;by(r),Cm(r),TJe(r,e),r.code.add(w`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, mainLightDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return mainLightIntensity * ((1.0 - shadowing) * dotVal);
}`)}let Ur=class extends ws{constructor(e,r){super(e,"vec2",di.Pass,(i,s,n)=>i.setUniform2fv(e,r(s,n)))}},fr=class extends ws{constructor(e,r){super(e,"vec4",di.Pass,(i,s,n)=>i.setUniform4fv(e,r(s,n)))}},qi=class extends ws{constructor(e,r){super(e,"mat4",di.Pass,(i,s,n)=>i.setUniformMatrix4fv(e,r(s,n)))}};const awe=se.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let lwe=class{constructor(){this._includedModules=new Map}include(e,r){if(this._includedModules.has(e)){const i=this._includedModules.get(e);if(i!==r){awe.error("Trying to include shader module multiple times with different sets of options.");const s=new Set;for(const n of Object.keys(i))i[n]!==e[n]&&s.add(n);for(const n of Object.keys(e))i[n]!==e[n]&&s.add(n);s.forEach(n=>console.error(`  ${n}: current ${i[n]} new ${e[n]}`))}}else this._includedModules.set(e,r),e(this.builder,r)}},Lr=class extends lwe{constructor(){super(...arguments),this.vertex=new Dse,this.fragment=new Dse,this.attributes=new CJe,this.varyings=new AJe,this.extensions=new Ij,this.constants=new cwe}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){const r=this.extensions.generateSource(e),i=this.attributes.generateSource(e),s=this.varyings.generateSource(),n=e==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=e==="vertex"?OJe:RJe,c=this.constants.generateSource().concat(n.constants.generateSource());return`
${r.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${i.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}generateBind(e,r){const i=new Map;this.vertex.uniforms.entries.forEach(o=>{const a=o.bind[e];v(a)&&i.set(o.name,a)}),this.fragment.uniforms.entries.forEach(o=>{const a=o.bind[e];v(a)&&i.set(o.name,a)});const s=Array.from(i.values()),n=s.length;return(o,a,l)=>{for(let c=0;c<n;++c)s[c](r,o,a,l)}}},SJe=class{constructor(){this._entries=new Map}add(e){if(!Array.isArray(e))return this._add(e);for(const r of e)this._add(r)}get(e){return this._entries.get(e)}_add(e){if(C(e))awe.error(`Trying to add null Uniform from ${new Error().stack}.`);else{if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new j(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}}generateSource(){return Array.from(this._entries.values()).map(e=>v(e.arraySize)?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`)}get entries(){return Array.from(this._entries.values())}},EJe=class{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}},Dse=class extends lwe{constructor(){super(...arguments),this.uniforms=new SJe,this.code=new EJe,this.constants=new cwe}get builder(){return this}},CJe=class{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(e){return e==="fragment"?[]:this._entries.map(r=>`attribute ${r[1]} ${r[0]};`)}},AJe=class{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(){return this._entries.map(e=>`varying ${e[1]} ${e[0]};`)}},Ij=class $j{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const r=e==="vertex"?$j.ALLOWLIST_VERTEX:$j.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(i=>r.includes(i)).map(i=>`#extension ${i} : enable`)}};Ij.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],Ij.ALLOWLIST_VERTEX=[];let cwe=class dn{constructor(){this._entries=new Set}add(e,r,i){let s="ERROR_CONSTRUCTOR_STRING";switch(r){case"float":s=dn._numberToFloatStr(i);break;case"int":s=dn._numberToIntStr(i);break;case"bool":s=i.toString();break;case"vec2":s=`vec2(${dn._numberToFloatStr(i[0])},                            ${dn._numberToFloatStr(i[1])})`;break;case"vec3":s=`vec3(${dn._numberToFloatStr(i[0])},                            ${dn._numberToFloatStr(i[1])},                            ${dn._numberToFloatStr(i[2])})`;break;case"vec4":s=`vec4(${dn._numberToFloatStr(i[0])},                            ${dn._numberToFloatStr(i[1])},                            ${dn._numberToFloatStr(i[2])},                            ${dn._numberToFloatStr(i[3])})`;break;case"ivec2":s=`ivec2(${dn._numberToIntStr(i[0])},                             ${dn._numberToIntStr(i[1])})`;break;case"ivec3":s=`ivec3(${dn._numberToIntStr(i[0])},                             ${dn._numberToIntStr(i[1])},                             ${dn._numberToIntStr(i[2])})`;break;case"ivec4":s=`ivec4(${dn._numberToIntStr(i[0])},                             ${dn._numberToIntStr(i[1])},                             ${dn._numberToIntStr(i[2])},                             ${dn._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${r}(${Array.prototype.map.call(i,n=>dn._numberToFloatStr(n)).join(", ")})`}return this._entries.add(`const ${r} ${e} = ${s};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}};const RJe=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif`,OJe=`precision highp float;
precision highp sampler2D;`,NZ="Size",c6="InvSize";function kh(t,e,r=!1,i=0){if(t.hasWebGL2Context){const s=w`vec2(textureSize(${e}, ${w.int(i)}))`;return r?"(1.0 / "+s+")":s}return r?e+c6:e+NZ}function tl(t,e,r,i=null,s=0){if(t.hasWebGL2Context)return w`texelFetch(${e}, ivec2(${r}), ${w.int(s)})`;let n=w`texture2D(${e}, ${r} * `;return n+=i?w`(${i}))`:w`${e+c6})`,n}var ei;(function(t){t[t.None=0]="None",t[t.Size=1]="Size",t[t.InvSize=2]="InvSize"})(ei||(ei={}));let Pt=class extends ws{constructor(e,r){super(e,"sampler2D",di.Pass,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function fp(t,e,r=ei.None){const i=[new Pt(t,e)];if(r&ei.Size){const s=t+NZ;i.push(new Ur(s,(n,o)=>{const a=e(n,o);return v(a)?ar(Nse,a.descriptor.width,a.descriptor.height):Xl}))}if(r&ei.InvSize){const s=t+c6;i.push(new Ur(s,(n,o)=>{const a=e(n,o);return v(a)?ar(Nse,1/a.descriptor.width,1/a.descriptor.height):Xl}))}return i}const Nse=Ke(),LO=$e(parseFloat(5802e-9 .toFixed(6)),parseFloat(13558e-9 .toFixed(6)),parseFloat(331e-7 .toFixed(6))),W8=3,X8=$e(W8*parseFloat(65e-8 .toFixed(6)),W8*parseFloat(1881e-9 .toFixed(6)),W8*parseFloat(85e-9 .toFixed(6))),MJe=3996e-9,PJe=$e(parseFloat(Number(LO[0]+X8[0]).toFixed(6)),parseFloat(Number(LO[1]+X8[1]).toFixed(6)),parseFloat(Number(LO[2]+X8[2]).toFixed(6)));function IJe(t){const e=new Lr;e.attributes.add(A.POSITION,"vec2"),e.include(tm,{textureCoordinateType:Xs.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:r,fragment:i}=e;return r.uniforms.add([new qi("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new qi("inverseViewMatrix",(s,n)=>BE($Je,n.camera.viewMatrix))]),r.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.uniforms.add([new Ur("radii",s=>s.radii),new Wt("cameraPosition",(s,n)=>n.camera.eye),new fr("heightParameters",s=>s.heightParameters),new Pe("innerFadeDistance",s=>s.innerFadeDistance),new Pe("altitudeFade",s=>s.altitudeFade),new Pt("depthTex",s=>s.depthTex),new Pe("hazeStrength",s=>s.hazeStrength)]),i.constants.add("betaRayleigh","vec3",LO),i.constants.add("betaCombined","vec3",PJe),i.constants.add("betaMie","float",MJe),i.constants.add("scaleHeight","float",wJe*D3),by(i),e.include(l6),t.haze&&(i.include(ku),i.uniforms.add(new Ur("nearFar",(s,n)=>n.camera.nearFar))),i.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.code.add(w`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),i.code.add(w`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),i.code.add(w`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${t.haze?w`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${t.haze?w``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${t.haze?"":w`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${t.haze?w`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:w`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${t.haze?w`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:w`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${t.haze?w`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:w`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${t.haze?"":w`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, gl_FragColor);
          }`}
    }
  `),e}const $Je=Ie(),LJe=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:LO,build:IJe},Symbol.toStringTag,{value:"Module"}));let Dr=class{constructor(e,r){this._module=e,this._loadModule=r}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}};var Fi,$t,Ee,gm,Mt,lp,SE,lt,$i,Ds,tt,Ot,wt,ze,Et,Lt,Ya,$r,Tu,Qn,us,Ir;(function(t){t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT"})(Fi||(Fi={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}($t||($t={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA"}(Ee||(Ee={})),function(t){t[t.ADD=32774]="ADD",t[t.SUBTRACT=32778]="SUBTRACT",t[t.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT"}(gm||(gm={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER"}(Mt||(Mt={})),function(t){t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(lp||(lp={})),function(t){t[t.CW=2304]="CW",t[t.CCW=2305]="CCW"}(SE||(SE={})),function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT"}(lt||(lt={})),function(t){t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS"}($i||($i={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP"}(Ds||(Ds={})),function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(tt||(tt={})),function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(Ot||(Ot={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY"}(wt||(wt={})),function(t){t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.RED=6403]="RED",t[t.RG=33319]="RG",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER"}(ze||(ze={})),function(t){t[t.RGBA4=32854]="RGBA4",t[t.R16F=33325]="R16F",t[t.RG16F=33327]="RG16F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.R32F=33326]="R32F",t[t.RG32F=33328]="RG32F",t[t.RGBA32F=34836]="RGBA32F",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB5_A1=32855]="RGB5_A1",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.RGB16F=34843]="RGB16F",t[t.RGB9_E5=35901]="RGB9_E5",t[t.SRGB8=35905]="SRGB8",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.RGB565=36194]="RGB565",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.RGB10_A2=32857]="RGB10_A2",t[t.RGB10_A2UI=36975]="RGB10_A2UI"}(Et||(Et={})),function(t){t[t.FLOAT=5126]="FLOAT",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.INT=5124]="INT",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV"}(Lt||(Lt={})),function(t){t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8"}(Ya||(Ya={})),function(t){t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.STATIC_READ=35045]="STATIC_READ",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.STREAM_COPY=35042]="STREAM_COPY"}($r||($r={})),function(t){t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER"}(Tu||(Tu={})),function(t){t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER"}(Qn||(Qn={})),function(t){t[t.TEXTURE=0]="TEXTURE",t[t.RENDER_BUFFER=1]="RENDER_BUFFER",t[t.CUBEMAP=2]="CUBEMAP"}(us||(us={})),function(t){t[t.NONE=0]="NONE",t[t.DEPTH_RENDER_BUFFER=1]="DEPTH_RENDER_BUFFER",t[t.STENCIL_RENDER_BUFFER=2]="STENCIL_RENDER_BUFFER",t[t.DEPTH_STENCIL_RENDER_BUFFER=3]="DEPTH_STENCIL_RENDER_BUFFER",t[t.DEPTH_STENCIL_TEXTURE=4]="DEPTH_STENCIL_TEXTURE"}(Ir||(Ir={}));const Y8=33984;var Un,pu;(function(t){t[t.Texture=0]="Texture",t[t.BufferObject=1]="BufferObject",t[t.VertexArrayObject=2]="VertexArrayObject",t[t.Shader=3]="Shader",t[t.Program=4]="Program",t[t.FramebufferObject=5]="FramebufferObject",t[t.Renderbuffer=6]="Renderbuffer",t[t.Sync=7]="Sync",t[t.COUNT=8]="COUNT"})(Un||(Un={})),function(t){t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15"}(pu||(pu={}));const Fse=33306;var Ms,Use,Vse,kse,WF,Lj,zse;(function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"})(Ms||(Ms={})),function(t){t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT=5124]="INT",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY"}(Use||(Use={})),function(t){t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS"}(Vse||(Vse={})),function(t){t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED"}(kse||(kse={})),function(t){t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED"}(WF||(WF={})),function(t){t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE"}(Lj||(Lj={})),function(t){t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT"}(zse||(zse={}));let kr=class{constructor(e,r,i){this.release=i,this.initializeConfiguration(e,r),this._configuration=r.snapshot(),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}destroy(){this._program=et(this._program),this._pipeline=this._configuration=null}reload(e){et(this._program),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}get program(){return this._program}get compiled(){return this.program.compiled}get key(){return this._configuration.key}get configuration(){return this._configuration}bindPipelineState(e,r=null,i){e.setPipelineState(this.getPipelineState(r,i))}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}get primitiveType(){return $t.TRIANGLES}getPipelineState(e,r){return this._pipeline}initializeConfiguration(e,r){}};const Ar=new Map([[A.POSITION,0],[A.NORMAL,1],[A.UV0,2],[A.COLOR,3],[A.SIZE,4],[A.TANGENT,4],[A.AUXPOS1,5],[A.SYMBOLCOLOR,5],[A.AUXPOS2,6],[A.FEATUREATTRIBUTE,6],[A.INSTANCEFEATUREATTRIBUTE,6],[A.INSTANCECOLOR,7],[A.OBJECTANDLAYERIDCOLOR,7],[A.OBJECTANDLAYERIDCOLOR_INSTANCED,7],[A.MODEL,8],[A.MODELNORMAL,12],[A.MODELORIGINHI,11],[A.MODELORIGINLO,15]]),DJe=se.getLogger("esri.views.webgl.checkWebGLError");function NJe(t,e){switch(e){case t.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case t.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case t.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case t.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case t.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case t.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const uwe=!!de("enable-feature:webgl-debug");function yu(){return uwe}function Dj(){return uwe}function y_(t){if(yu()){const e=t.getError();if(e){const r=NJe(t,e),i=new Error().stack;DJe.error(new j("webgl-error","WebGL error occured",{message:r,stack:i}))}}}let Nr=class{constructor(e,r,i){this._context=e,this._locations=i,this._textures=new Map,this._freeTextureUnits=new Kt({deallocator:null}),this._glProgram=e.programCache.acquire(r.generate("vertex"),r.generate("fragment"),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=r.generateBind(di.Pass,this),this.bindDraw=r.generateBind(di.Draw,this),this._fragmentUniforms=yu()?r.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get compiled(){return this._glProgram.compiled}setUniform1b(e,r){this._glProgram.setUniform1i(e,r?1:0)}setUniform1i(e,r){this._glProgram.setUniform1i(e,r)}setUniform1f(e,r){this._glProgram.setUniform1f(e,r)}setUniform2fv(e,r){this._glProgram.setUniform2fv(e,r)}setUniform3fv(e,r){this._glProgram.setUniform3fv(e,r)}setUniform4fv(e,r){this._glProgram.setUniform4fv(e,r)}setUniformMatrix3fv(e,r){this._glProgram.setUniformMatrix3fv(e,r)}setUniformMatrix4fv(e,r){this._glProgram.setUniformMatrix4fv(e,r)}setUniform1fv(e,r){this._glProgram.setUniform1fv(e,r)}setUniform1iv(e,r){this._glProgram.setUniform1iv(e,r)}setUniform2iv(e,r){this._glProgram.setUniform3iv(e,r)}setUniform3iv(e,r){this._glProgram.setUniform3iv(e,r)}setUniform4iv(e,r){this._glProgram.setUniform4iv(e,r)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,r){if(C(r)||r.glName==null){const s=this._textures.get(e);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(e)),null}let i=this._textures.get(e);return i==null?(i=this._allocTextureUnit(r),this._textures.set(e,i)):i.texture=r,this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(r,i.unit),i.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((e,r)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(r,e.unit)}),v(this._fragmentUniforms)&&this._fragmentUniforms.forEach(e=>{e.type!=="sampler2D"&&e.type!=="samplerCube"||this._textures.has(e.name)||console.error(`Texture sampler ${e.name} has no bound texture`)})}_allocTextureUnit(e){return{texture:e,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}};var Ei,kw,Ps,Xg,jl,uy,H_,EE,ui,zw,Dg;(function(t){t[t.None=0]="None",t[t.Front=1]="Front",t[t.Back=2]="Back",t[t.COUNT=3]="COUNT"})(Ei||(Ei={})),function(t){t[t.Less=0]="Less",t[t.Lequal=1]="Lequal",t[t.COUNT=2]="COUNT"}(kw||(kw={})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.UPDATE=1]="UPDATE"}(Ps||(Ps={})),function(t){t[t.NOT_LOADED=0]="NOT_LOADED",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED"}(Xg||(Xg={})),function(t){t[t.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",t[t.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(jl||(jl={})),function(t){t[t.Highlight=0]="Highlight",t[t.MaskOccludee=1]="MaskOccludee",t[t.COUNT=2]="COUNT"}(uy||(uy={})),function(t){t[t.STRETCH=1]="STRETCH",t[t.PAD=2]="PAD"}(H_||(H_={})),function(t){t[t.CHANGED=0]="CHANGED",t[t.UNCHANGED=1]="UNCHANGED"}(EE||(EE={})),function(t){t[t.Blend=0]="Blend",t[t.Opaque=1]="Opaque",t[t.Mask=2]="Mask",t[t.MaskBlend=3]="MaskBlend",t[t.COUNT=4]="COUNT"}(ui||(ui={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(zw||(zw={})),function(t){t.DDS_ENCODING="image/vnd-ms.dds",t.KTX2_ENCODING="image/ktx2",t.BASIS_ENCODING="image/x.basis"}(Dg||(Dg={}));function Mp(t,e,r=gm.ADD,i=[0,0,0,0]){return{srcRgb:t,srcAlpha:t,dstRgb:e,dstAlpha:e,opRgb:r,opAlpha:r,color:{r:i[0],g:i[1],b:i[2],a:i[3]}}}function Bn(t,e,r,i,s=gm.ADD,n=gm.ADD,o=[0,0,0,0]){return{srcRgb:t,srcAlpha:e,dstRgb:r,dstAlpha:i,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const FZ={face:lp.BACK,mode:SE.CCW},hwe={face:lp.FRONT,mode:SE.CCW},u6=t=>t===Ei.Back?FZ:t===Ei.Front?hwe:null,Yl={zNear:0,zFar:1},Qt={r:!0,g:!0,b:!0,a:!0};function FJe(t){return HJe.intern(t)}function UJe(t){return qJe.intern(t)}function VJe(t){return WJe.intern(t)}function kJe(t){return XJe.intern(t)}function zJe(t){return YJe.intern(t)}function BJe(t){return ZJe.intern(t)}function GJe(t){return JJe.intern(t)}function jJe(t){return KJe.intern(t)}function zt(t){return QJe.intern(t)}let wy=class{constructor(e,r){this._makeKey=e,this._makeRef=r,this._interns=new Map}intern(e){if(!e)return null;const r=this._makeKey(e),i=this._interns;return i.has(r)||i.set(r,this._makeRef(e)),i.get(r)??null}};function xy(t){return"["+t.join(",")+"]"}const HJe=new wy(dwe,t=>({__tag:"Blending",...t}));function dwe(t){return t?xy([t.srcRgb,t.srcAlpha,t.dstRgb,t.dstAlpha,t.opRgb,t.opAlpha,t.color.r,t.color.g,t.color.b,t.color.a]):null}const qJe=new wy(pwe,t=>({__tag:"Culling",...t}));function pwe(t){return t?xy([t.face,t.mode]):null}const WJe=new wy(fwe,t=>({__tag:"PolygonOffset",...t}));function fwe(t){return t?xy([t.factor,t.units]):null}const XJe=new wy(mwe,t=>({__tag:"DepthTest",...t}));function mwe(t){return t?xy([t.func]):null}const YJe=new wy(gwe,t=>({__tag:"StencilTest",...t}));function gwe(t){return t?xy([t.function.func,t.function.ref,t.function.mask,t.operation.fail,t.operation.zFail,t.operation.zPass]):null}const ZJe=new wy(ywe,t=>({__tag:"DepthWrite",...t}));function ywe(t){return t?xy([t.zNear,t.zFar]):null}const JJe=new wy(_we,t=>({__tag:"ColorWrite",...t}));function _we(t){return t?xy([t.r,t.g,t.b,t.a]):null}const KJe=new wy(vwe,t=>({__tag:"StencilWrite",...t}));function vwe(t){return t?xy([t.mask]):null}const QJe=new wy(eKe,t=>({blending:FJe(t.blending),culling:UJe(t.culling),polygonOffset:VJe(t.polygonOffset),depthTest:kJe(t.depthTest),stencilTest:zJe(t.stencilTest),depthWrite:BJe(t.depthWrite),colorWrite:GJe(t.colorWrite),stencilWrite:jJe(t.stencilWrite)}));function eKe(t){return t?xy([dwe(t.blending),pwe(t.culling),fwe(t.polygonOffset),mwe(t.depthTest),gwe(t.stencilTest),ywe(t.depthWrite),_we(t.colorWrite),vwe(t.stencilWrite)]):null}let tKe=class{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(e,r,i,s){return(i||e!==r)&&(s(e),this._pipelineInvalid=!0),e}},rKe=class extends pi{constructor(){super(...arguments),this.heightParameters=nr(),this.radii=Ke(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1}},Nj=class bwe extends kr{initializeProgram(e){return new Nr(e.rctx,bwe.shader.get().build(this.configuration),Ar)}initializePipeline(){return this.configuration.haze?zt({blending:Bn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Qt}):zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:$i.LEQUAL},colorWrite:Qt})}};Nj.shader=new Dr(LJe,()=>ie(()=>import("./ChapmanAtmosphere.glsl-335a9afe.js"),[],import.meta.url));let Pa=class extends pi{constructor(){super(),this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const e=this._parameterNames,r={key:this.key};for(const i of e)r[i]=this[i];return r}};function k(t={}){return(e,r)=>{if(e._parameterNames=e._parameterNames??[],e._parameterNames.push(r),t.constValue!=null)Object.defineProperty(e,r,{get:()=>t.constValue});else{const i=e._parameterNames.length-1,s=t.count||2,n=Math.ceil(Math.log2(s)),o=e._parameterBits??[0];let a=0;for(;o[a]+n>16;)a++,a>=o.length&&o.push(0);e._parameterBits=o;const l=o[a],c=(1<<n)-1<<l;o[a]+=n,Object.defineProperty(e,r,{get(){return this[i]},set(h){if(this[i]!==h&&(this[i]=h,this._keyDirty=!0,this._parameterBits[a]=this._parameterBits[a]&~c|+h<<l&c,typeof h!="number"&&typeof h!="boolean"))throw new Error("Configuration value for "+r+" must be boolean or number, got "+typeof h)}})}}}let wwe=class extends Pa{constructor(){super(...arguments),this.haze=!1}};u([k()],wwe.prototype,"haze",void 0);let No=class{constructor(e,r,i,s,n,o=!1,a=0){this.name=e,this.count=r,this.type=i,this.offset=s,this.stride=n,this.normalized=o,this.divisor=a}};new No(A.POSITION,3,lt.FLOAT,0,12);new No(A.POSITION,3,lt.FLOAT,0,20),new No(A.UV0,2,lt.FLOAT,12,20);new No(A.POSITION,3,lt.FLOAT,0,32),new No(A.NORMAL,3,lt.FLOAT,12,32),new No(A.UV0,2,lt.FLOAT,24,32);new No(A.POSITION,3,lt.FLOAT,0,16),new No(A.COLOR,4,lt.UNSIGNED_BYTE,12,16);const UZ=[new No(A.POSITION,2,lt.FLOAT,0,8)],lC=[new No(A.POSITION,2,lt.FLOAT,0,16),new No(A.UV0,2,lt.FLOAT,8,16)];function Bse(t){const e=t.gl;switch(e.getError()){case e.NO_ERROR:return null;case e.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case e.INVALID_VALUE:return"An unacceptable value has been specified for an argument";case e.INVALID_OPERATION:return"The specified command is not allowed for the current state";case e.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case e.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case e.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function Ko(t,e){return t.vertexBuffers[e].size/iKe(t.layout[e])}function iKe(t){return t[0].stride}function VZ(t,e,r,i,s=0){const n=t.gl,o=t.capabilities.instancing;t.bindBuffer(r);for(const a of i){const l=e.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`);const c=s*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function kZ(t,e,r,i){const s=t.gl,n=t.capabilities.instancing;t.bindBuffer(r);for(const o of i){const a=e.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}t.unbindBuffer(Mt.ARRAY_BUFFER)}function xwe(t){switch(t){case ze.ALPHA:case ze.LUMINANCE:case ze.RED:case ze.RED_INTEGER:case Et.R8:case Et.R8I:case Et.R8UI:case Et.R8_SNORM:case Ya.STENCIL_INDEX8:return 1;case ze.LUMINANCE_ALPHA:case ze.RG:case ze.RG_INTEGER:case Et.RGBA4:case Et.R16F:case Et.R16I:case Et.R16UI:case Et.RG8:case Et.RG8I:case Et.RG8UI:case Et.RG8_SNORM:case Et.RGB565:case Et.RGB5_A1:case Ya.DEPTH_COMPONENT16:return 2;case ze.DEPTH_COMPONENT:case ze.RGB:case ze.RGB_INTEGER:case Et.RGB8:case Et.RGB8I:case Et.RGB8UI:case Et.RGB8_SNORM:case Et.SRGB8:case Ya.DEPTH_COMPONENT24:return 3;case ze.DEPTH_STENCIL:case ze.RGBA:case ze.RGBA_INTEGER:case Et.RGBA8:case Et.R32F:case Et.R11F_G11F_B10F:case Et.RG16F:case Et.R32I:case Et.R32UI:case Et.RG16I:case Et.RG16UI:case Et.RGBA8I:case Et.RGBA8UI:case Et.RGBA8_SNORM:case Et.SRGB8_ALPHA8:case Et.RGB9_E5:case Et.RGB10_A2UI:case Et.RGB10_A2:case Ya.DEPTH_STENCIL:case Ya.DEPTH_COMPONENT32F:case Ya.DEPTH24_STENCIL8:return 4;case Ya.DEPTH32F_STENCIL8:return 5;case Et.RGB16F:case Et.RGB16I:case Et.RGB16UI:return 6;case Et.RG32F:case Et.RG32I:case Et.RG32UI:case Et.RGBA16F:case Et.RGBA16I:case Et.RGBA16UI:return 8;case Et.RGB32F:case Et.RGB32I:case Et.RGB32UI:return 12;case Et.RGBA32F:case Et.RGBA32I:case Et.RGBA32UI:return 16;case Ms.COMPRESSED_RGB_S3TC_DXT1_EXT:case Ms.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case Ms.COMPRESSED_RGBA_S3TC_DXT3_EXT:case Ms.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case Ms.COMPRESSED_R11_EAC:case Ms.COMPRESSED_SIGNED_R11_EAC:case Ms.COMPRESSED_RGB8_ETC2:case Ms.COMPRESSED_SRGB8_ETC2:case Ms.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case Ms.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case Ms.COMPRESSED_RG11_EAC:case Ms.COMPRESSED_SIGNED_RG11_EAC:case Ms.COMPRESSED_RGBA8_ETC2_EAC:case Ms.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}function Bw(t){if(C(t))return 0;if("descriptor"in t)return t.glName?Bw(t.descriptor):0;const e=t.internalFormat||"pixelFormat"in t&&t.pixelFormat;if(!e)return 0;const r="hasMipmap"in t&&t.hasMipmap?1.3:1,i=t.width*t.height;return xwe(e)*i*r}const Hv=se.getLogger("esri.views.webgl.VertexArrayObject");let ed=class{constructor(e,r,i,s,n=null){this._context=e,this._locations=r,this._layout=i,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,e.instanceCounter.increment(Un.VertexArrayObject,this)}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce((e,r)=>e+this._buffers[r].size,v(this._indexBuffer)?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(e=!0){var r,i,s;if(!this._context)return void((this._glName||e&&Object.getOwnPropertyNames(this._buffers).length>0)&&Hv.warn("Leaked WebGL VAO"));if(this._glName){const n=(i=(r=this._context)==null?void 0:r.capabilities)==null?void 0:i.vao;n?(n.deleteVertexArray(this._glName),this._glName=null):Hv.warn("Leaked WebGL VAO")}if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),e){for(const n in this._buffers)(s=this._buffers[n])==null||s.dispose(),delete this._buffers[n];this._indexBuffer=et(this._indexBuffer)}this._context.instanceCounter.decrement(Un.VertexArrayObject,this),this._context=yw(this._context)}initialize(){if(this._initialized)return;const e=this._context.capabilities.vao;if(e){const r=e.createVertexArray();e.bindVertexArray(r),this._bindLayout(),e.bindVertexArray(null),this._glName=r}this._initialized=!0}bind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:e,_layout:r,_indexBuffer:i}=this;e||Hv.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in e){const o=e[n];o||Hv.error("Vertex buffer is uninitialized!");const a=r[n];a||Hv.error("Vertex element descriptor is empty!"),VZ(this._context,this._locations,o,a)}v(i)&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i.glName):this._context.bindBuffer(i))}unbind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:e,_layout:r}=this;e||Hv.error("Vertex buffer dictionary is empty!");for(const i in e){const s=e[i];s||Hv.error("Vertex buffer is uninitialized!");const n=r[i];kZ(this._context,this._locations,s,n)}v(this._indexBuffer)&&this._context.unbindBuffer(this._indexBuffer.bufferType)}},Pp=class extends ed{};var bt;function sKe(t,e,r={}){const i=Twe(t);for(;i.length>1;){const s=XF(e,i.shift(),r);if(v(s))return s}return nKe(e,i.shift(),r)}function Twe(t){const e=de("esri-force-webgl");if(e===bt.WEBGL1||e===bt.WEBGL2)return[e];switch(t){case"2d":return de("mac")&&de("chrome")?[bt.WEBGL1,bt.WEBGL2]:[bt.WEBGL2,bt.WEBGL1];case"3d":return[bt.WEBGL2,bt.WEBGL1]}}function nKe(t,e,r={}){if(!window.WebGLRenderingContext)return Gse(t,oKe),null;const i=XF(t,e,r);return C(i)&&Gse(t,aKe),i}function XF(t,e,r={}){const i=e===bt.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let s=null;for(const n of i){try{s=t.getContext(n,r)}catch{}if(s)break}return s}function Gse(t,e){const r=t.parentNode;r&&(r.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>")}(function(t){t[t.WEBGL1=1]="WEBGL1",t[t.WEBGL2=2]="WEBGL2"})(bt||(bt={}));const oKe='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',aKe=`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`,Vp=se.getLogger("esri.views.webgl.BufferObject");let jr=class g2{static createIndex(e,r,i){return new g2(e,Mt.ELEMENT_ARRAY_BUFFER,r,i)}static createVertex(e,r,i){return new g2(e,Mt.ARRAY_BUFFER,r,i)}static createUniform(e,r,i){if(e.type!==bt.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new g2(e,Mt.UNIFORM_BUFFER,r,i)}static createPixelPack(e,r=$r.STREAM_READ,i){if(e.type!==bt.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const s=new g2(e,Mt.PIXEL_PACK_BUFFER,r);return i&&s.setSize(i),s}static createPixelUnpack(e,r=$r.STREAM_DRAW,i){if(e.type!==bt.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new g2(e,Mt.PIXEL_UNPACK_BUFFER,r,i)}constructor(e,r,i,s){this._context=e,this.bufferType=r,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(Un.BufferObject,this),this._glName=this._context.gl.createBuffer(),y_(this._context.gl),s&&this.setData(s)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return this.bufferType===Mt.ELEMENT_ARRAY_BUFFER?this._indexType===lt.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===Mt.ELEMENT_ARRAY_BUFFER||this.bufferType===Mt.ARRAY_BUFFER}dispose(){var e;(e=this._context)!=null&&e.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(Un.BufferObject,this),this._context=yw(this._context)):this._glName&&Vp.warn("Leaked WebGL buffer object")}setSize(e,r=null){if(e<=0&&Vp.error("Buffer size needs to be positive!"),this.bufferType===Mt.ELEMENT_ARRAY_BUFFER&&v(r))switch(this._indexType=r,r){case lt.UNSIGNED_SHORT:e*=2;break;case lt.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let r=e.byteLength;this.bufferType===Mt.ELEMENT_ARRAY_BUFFER&&(eW(e)&&(r/=2,this._indexType=lt.UNSIGNED_SHORT),tW(e)&&(r/=4,this._indexType=lt.UNSIGNED_INT)),this._setBufferData(r,e)}_setBufferData(e,r=null){this._size=e;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;v(r)?s.bufferData(this.bufferType,r,this.usage):s.bufferData(this.bufferType,e,this.usage),y_(s),this._isVAOAware&&this._context.bindVAO(i)}setSubData(e,r,i,s){if(!e)return;(r<0||r*e.BYTES_PER_ELEMENT>=this.byteSize)&&Vp.error("offset is out of range!"),i>=s&&Vp.error("end must be bigger than start!"),(r+(s-i))*e.BYTES_PER_ELEMENT>this.byteSize&&Vp.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl;if(this._context.type===bt.WEBGL2)o.bufferSubData(this.bufferType,r*e.BYTES_PER_ELEMENT,e,i,s-i);else{const a=i===0&&s===e.length?e:e.subarray(i,s);o.bufferSubData(this.bufferType,r*e.BYTES_PER_ELEMENT,a)}y_(o),this._isVAOAware&&this._context.bindVAO(n)}getSubData(e,r=0,i,s){if(this._context.type!==bt.WEBGL2)return void Vp.error("Get buffer subdata is supported in WebGL2 only!");if(i<0||s<0)return void Vp.error("Problem getting subdata: offset and length were less than zero!");const n=lKe(e)?e.BYTES_PER_ELEMENT:1;if(n*((i??0)+(s??0))>e.byteLength)return void Vp.error("Problem getting subdata: offset and length exceeded destination size!");r+n*(s??0)>this.byteSize&&Vp.warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this._context.bindBuffer(this,Mt.COPY_READ_BUFFER),o.getBufferSubData(Mt.COPY_READ_BUFFER,r,e,i,s),this._context.unbindBuffer(Mt.COPY_READ_BUFFER)}async getSubDataAsync(e,r=0,i,s){this._context.type===bt.WEBGL2?(await this._context.clientWaitAsync(),this.getSubData(e,r,i,s)):Vp.error("Get buffer subdata is supported in WebGL2 only!")}};function lKe(t){return QOe(t)}const Z8={target:wt.TEXTURE_2D,samplingMode:tt.LINEAR,wrapMode:Ot.REPEAT,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,isImmutable:!1},jse=4;let ct=class{constructor(e,r,i=null){this._context=e,this.type="texture",this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,e.instanceCounter.increment(Un.Texture,this),this._descriptor={...Z8,...r};for(const s in Z8)this._descriptor[s]===void 0&&(this._descriptor[s]=Z8[s]);if(e.type!==bt.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),qv(this._descriptor.target)))throw new Error("3D and array textures are not supported in WebGL1");this._descriptor.target===wt.TEXTURE_CUBE_MAP?this._setDataCubeMap(i):this.setData(i)}get glName(){return this._glName}get descriptor(){return this._descriptor}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._context.gl&&this._glName&&(this._context.unbindTexture(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(Un.Texture,this))}release(){this.dispose()}resize(e,r){const i=this._descriptor;if(i.width!==e||i.height!==r){if(this._wasImmutablyAllocated)throw new Error("Immutable textures can't be resized!");i.width=e,i.height=r,this._descriptor.target===wt.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}_setDataCubeMap(e=null){for(let r=wt.TEXTURE_CUBE_MAP_POSITIVE_X;r<=wt.TEXTURE_CUBE_MAP_NEGATIVE_Z;r++)this._setData(e,r)}setData(e){this._setData(e)}_setData(e,r){if(!this._context||!this._context.gl)return;const i=this._context.gl;this._glName||(this._glName=i.createTexture()),e===void 0&&(e=null);const s=this._descriptor,n=r??s.target,o=qv(n);e===null&&(s.width=s.width||jse,s.height=s.height||jse,o&&(s.depth=s.depth??1));const a=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),ct._validateTexture(this._context,s),this._configurePixelStorage(),y_(i);const l=s.pixelFormat;let c=s.internalFormat??this._deriveInternalFormat(l,s.dataType);if(J8(e)){let h=e.width,p=e.height;const f=1;e instanceof HTMLVideoElement&&(h=e.videoWidth,p=e.videoHeight),s.width&&s.height,o&&s.depth,s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,c,s.hasMipmap,h,p,f),this._texImage(n,0,c,h,p,f,e),y_(i),s.hasMipmap&&this.generateMipmap(),s.width===void 0&&(s.width=h),s.height===void 0&&(s.height=p),o&&s.depth===void 0&&(s.depth=f)}else{const{width:h,height:p,depth:f}=s;if(h==null||p==null)throw new Error("Width and height must be specified!");if(o&&f==null)throw new Error("Depth must be specified!");if(s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,c,s.hasMipmap,h,p,f),i.DEPTH24_STENCIL8&&c===i.DEPTH_STENCIL&&(c=i.DEPTH24_STENCIL8),kD(e)){const m=e.levels,y=Hse(n,h,p,f),_=Math.min(y-1,m.length-1);v(this._context.gl2)?i.texParameteri(s.target,this._context.gl2.TEXTURE_MAX_LEVEL,_):s.hasMipmap=s.hasMipmap&&y===m.length;const b=c;if(!uKe(b))throw new Error("Attempting to use compressed data with an umcompressed format!");this._forEachMipmapLevel((x,T,S,E)=>{const O=m[Math.min(x,m.length-1)];this._compressedTexImage(n,x,b,T,S,E,O)},_)}else v(e)?(this._texImage(n,0,c,h,p,f,e),y_(i),s.hasMipmap&&this.generateMipmap()):this._forEachMipmapLevel((m,y,_,b)=>{this._texImage(n,m,c,y,_,b,null),y_(i)})}ct._applySamplingMode(i,this._descriptor),ct._applyWrapMode(i,this._descriptor),ct._applyAnisotropicFilteringParameters(this._context,this._descriptor),y_(i),this._context.bindTexture(a,ct.TEXTURE_UNIT_FOR_UPDATES)}updateData(e,r,i,s,n,o,a=0){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const l=this._context.gl,c=this._descriptor,{pixelFormat:h,dataType:p,target:f,isImmutable:m}=c,y=c.internalFormat??this._deriveInternalFormat(h,p);if(m&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");const _=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES,!0);if((r<0||i<0||s>c.width||n>c.height||r+s>c.width||i+n>c.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),a){if(C(this._context.gl2))return void console.error("Webgl2 must be enabled to use dataRowOffset!");l.pixelStorei(this._context.gl2.UNPACK_SKIP_ROWS,a)}if(J8(o)?v(this._context.gl2)?this._context.gl2.texSubImage2D(f,e,r,i,s,n,h,p,o):l.texSubImage2D(f,e,r,i,h,p,o):kD(o)?l.compressedTexSubImage2D(f,e,r,i,s,n,y,o.levels[e]):l.texSubImage2D(f,e,r,i,s,n,h,p,o),a){if(C(this._context.gl2))return void console.error("Webgl2 must be enabled to use dataRowOffset!");l.pixelStorei(this._context.gl2.UNPACK_SKIP_ROWS,0)}this._context.bindTexture(_,ct.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(e,r,i,s,n,o,a,l){l||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const c=this._context.gl2;if(C(c))throw new Error("3D textures are not supported in WebGL1");const h=this._descriptor,{pixelFormat:p,dataType:f,isImmutable:m,target:y}=h,_=h.internalFormat??this._deriveInternalFormat(p,f);if(m&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");qv(y)||console.warn("Attempting to set 3D texture data on a non-3D texture");const b=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES);if(this._context.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),(r<0||i<0||s<0||n>h.width||o>h.height||a>h.depth||r+n>h.width||i+o>h.height||s+a>h.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),kD(l))l=l.levels[e],c.compressedTexSubImage3D(y,e,r,i,s,n,o,a,_,l);else{const x=l;c.texSubImage3D(y,e,r,i,s,n,o,a,p,f,x)}this._context.bindTexture(b,ct.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const e=this._descriptor;if(!e.hasMipmap){if(this._wasImmutablyAllocated)throw new Error("Cannot add mipmaps to immutable texture after allocation");e.hasMipmap=!0,this._samplingModeDirty=!0,ct._validateTexture(this._context,e)}e.samplingMode===tt.LINEAR?(this._samplingModeDirty=!0,e.samplingMode=tt.LINEAR_MIPMAP_NEAREST):e.samplingMode===tt.NEAREST&&(this._samplingModeDirty=!0,e.samplingMode=tt.NEAREST_MIPMAP_NEAREST);const r=this._context.bindTexture(this,ct.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),this._context.gl.generateMipmap(e.target),this._context.bindTexture(r,ct.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,ct._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const e=this._context.gl,r=this._descriptor;this._samplingModeDirty&&(ct._applySamplingMode(e,r),this._samplingModeDirty=!1),this._wrapModeDirty&&(ct._applyWrapMode(e,r),this._wrapModeDirty=!1)}_deriveInternalFormat(e,r){if(this._context.type===bt.WEBGL1)return e;switch(r){case Lt.FLOAT:switch(e){case ze.RGBA:return Et.RGBA32F;case ze.RGB:return Et.RGB32F;default:throw new Error("Unable to derive format")}case Lt.UNSIGNED_BYTE:switch(e){case ze.RGBA:return Et.RGBA8;case ze.RGB:return Et.RGB8}default:return e}}_configurePixelStorage(){const e=this._context.gl,{unpackAlignment:r,flipped:i,preMultiplyAlpha:s}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,r),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_texStorage(e,r,i,s,n,o){const a=this._context.gl2;if(C(a))throw new Error("Immutable textures are not supported in WebGL1");if(!cKe(r))throw new Error("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=i?Hse(e,s,n,o):1;if(qv(e)){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");a.texStorage3D(e,l,r,s,n,o)}else a.texStorage2D(e,l,r,s,n);this._wasImmutablyAllocated=!0}_texImage(e,r,i,s,n,o,a){const l=this._context.gl;let c=null;const h=this._context.type===bt.WEBGL2,p=qv(e),{isImmutable:f,pixelFormat:m,dataType:y}=this._descriptor;if(h&&(c=l),h||!J8(a))if(f){if(v(a)){const _=a;if(p){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.texSubImage3D(e,r,0,0,0,s,n,o,m,y,_)}else l.texSubImage2D(e,r,0,0,s,n,m,y,_)}}else{const _=a;if(p){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.texImage3D(e,r,i,s,n,o,0,m,y,_)}else l.texImage2D(e,r,i,s,n,0,m,y,_)}else l.texImage2D(e,0,i,m,y,a)}_compressedTexImage(e,r,i,s,n,o,a){const l=this._context.gl;let c=null;const h=qv(e),p=this._descriptor.isImmutable;if(h){if(this._context.type!==bt.WEBGL2)throw new Error("3D textures are not supported in WebGL1");c=l}if(p){if(v(a))if(h){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.compressedTexSubImage3D(e,r,0,0,0,s,n,o,i,a)}else l.compressedTexSubImage2D(e,r,0,0,s,n,i,a)}else if(h){if(o==null)throw new Error("Missing depth dimension for 3D texture upload");c.compressedTexImage3D(e,r,i,s,n,o,0,a)}else l.compressedTexImage2D(e,r,i,s,n,0,a)}_forEachMipmapLevel(e,r=1/0){let{width:i,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=a===wt.TEXTURE_3D;if(i==null||s==null||l&&n==null)throw new Error("Missing texture dimensions for mipmap calculation");for(let c=0;e(c,i,s,n),o&&(i!==1||s!==1||l&&n!==1)&&!(c>=r);++c)i=Math.max(1,i>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}static _validateTexture(e,r){(r.width!=null&&r.width<0||r.height!=null&&r.height<0||r.depth!=null&&r.depth<0)&&console.error("Negative dimension parameters are not allowed!");const i=e.type===bt.WEBGL2,s=r.width!=null&&vp(r.width)&&r.height!=null&&vp(r.height);i||!r.isImmutable&&!qv(r.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),i||s||(typeof r.wrapMode=="number"?r.wrapMode!==Ot.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):r.wrapMode.s===Ot.CLAMP_TO_EDGE&&r.wrapMode.t===Ot.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),r.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))}static _applySamplingMode(e,r){let i=r.samplingMode,s=r.samplingMode;i===tt.LINEAR_MIPMAP_NEAREST||i===tt.LINEAR_MIPMAP_LINEAR?(i=tt.LINEAR,r.hasMipmap||(s=tt.LINEAR)):i!==tt.NEAREST_MIPMAP_NEAREST&&i!==tt.NEAREST_MIPMAP_LINEAR||(i=tt.NEAREST,r.hasMipmap||(s=tt.NEAREST)),e.texParameteri(r.target,e.TEXTURE_MAG_FILTER,i),e.texParameteri(r.target,e.TEXTURE_MIN_FILTER,s)}static _applyWrapMode(e,r){typeof r.wrapMode=="number"?(e.texParameteri(r.target,e.TEXTURE_WRAP_S,r.wrapMode),e.texParameteri(r.target,e.TEXTURE_WRAP_T,r.wrapMode)):(e.texParameteri(r.target,e.TEXTURE_WRAP_S,r.wrapMode.s),e.texParameteri(r.target,e.TEXTURE_WRAP_T,r.wrapMode.t))}static _applyAnisotropicFilteringParameters(e,r){const i=e.capabilities.textureFilterAnisotropic;i&&e.gl.texParameterf(r.target,i.TEXTURE_MAX_ANISOTROPY,r.maxAnisotropy??1)}};function cKe(t){return t in Et}function uKe(t){return t in Ms}function kD(t){return v(t)&&"type"in t&&t.type==="compressed"}function hKe(t){return v(t)&&"byteLength"in t}function J8(t){return v(t)&&!kD(t)&&!hKe(t)}function qv(t){return t===wt.TEXTURE_3D||t===wt.TEXTURE_2D_ARRAY}function Hse(t,e,r,i=1){let s=Math.max(e,r);return t===wt.TEXTURE_3D&&(s=Math.max(s,i)),Math.round(Math.log(s)/Math.LN2)+1}ct.TEXTURE_UNIT_FOR_UPDATES=0;function Ia(t,e=UZ,r=Ar,i=-1,s=1){let n=null;return e===lC?n=new Float32Array([i,i,0,0,s,i,1,0,i,s,0,1,s,s,1,1]):n=new Float32Array([i,i,s,i,i,s,s,s]),new Pp(t,r,{geometry:e},{geometry:jr.createVertex(t,$r.STATIC_DRAW,n)})}function dKe(t,e=UZ,r=Ar){const i=new Float32Array([-1,-1,3,-1,-1,3]);return new Pp(t,r,{geometry:e},{geometry:jr.createVertex(t,$r.STATIC_DRAW,i)})}const Swe=4;function Ewe(t,e=Swe){return new ct(t,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:e,height:e})}function pKe(t,e,r=Swe){const i=new Uint8Array(r*r*4);for(let s=0;s<i.length;s+=4)i[s+0]=255*e[0],i[s+1]=255*e[1],i[s+2]=255*e[2],i[s+3]=255*e[3];return new ct(t,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:r,height:r},i)}function Cwe(t){return new ct(t,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}let K8=class{constructor(e,r){this._view=e,this.type=Mn.Realistic,this._handles=new Zr,this._passParameters=new rKe,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=br.radius,this._fadeHaze=0,this._updateRadius(br.radius);const i=r.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([ne(()=>this._view.basemapTerrain.rootTileElevationBounds,()=>this._updateRootTileElevationBounds()),ne(()=>this._view.basemapTerrain.visibleElevationBounds,()=>this._updateVisibleElevationBounds())]);const s=new wwe;s.haze=!1,this._atmosphereTechnique=r.techniqueRepository.acquire(Nj,s),s.haze=!0,this._atmosphereHazeTechnique=r.techniqueRepository.acquire(Nj,s),this._vao=Ia(i,lC)}destroy(){this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._vao.dispose(),this._handles.destroy()}render(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}renderHaze(e,r){this._fadeHaze=r,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}_render(e,r,i){if(C(i))return;this._update(e.bindParameters.camera),this._passParameters.depthTex=i;const s=e.rctx.bindTechnique(r,this._passParameters,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached(()=>this._renderCommon(s,e))}_renderCommon(e,r){C(this._vao)||(r.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.rctx.drawArrays($t.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=br.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(br.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,ar(this._passParameters.radii,e,e+D3),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-Pj)*Pj)}_update(e){if(C(e))return;const r=ga(e.eye),i=Math.sqrt(r),s=r-this._passParameters.radii[1]*this._passParameters.radii[1],n=ye((i-this._passParameters.radii[0])/D3,0,1);ti(this._passParameters.heightParameters,i,r,s,n),this._passParameters.altitudeFade=DZ(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=Ft(Ft(.6,1,WS(9500,10500,i-br.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}};function Awe(t){t.extensions.add("GL_EXT_shader_texture_lod"),t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(w`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function zZ(t,e){switch(t.include(tm,e),t.fragment.code.add(w`
  struct TextureLookupParameter {
    vec2 uv;
    ${e.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),e.textureCoordinateType){case Xs.Default:case Xs.Compressed:return void t.fragment.code.add(w`vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {
return texture2D(texture, params.uv);
}`);case Xs.Atlas:return t.include(Awe),void t.fragment.code.add(w`vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {
return textureAtlasLookup(texture, params.size, params.uv, vuvRegion);
}`);default:e.textureCoordinateType;case Xs.None:case Xs.COUNT:return}}let Lu=class extends ws{constructor(e,r){super(e,"vec3",di.Draw,(i,s,n,o)=>i.setUniform3fv(e,r(s,n,o)))}},N3=class extends ws{constructor(e,r){super(e,"vec2",di.Draw,(i,s,n,o)=>i.setUniform2fv(e,r(s,n,o)))}},KM=class extends ws{constructor(e,r){super(e,"sampler2D",di.Draw,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function q_(t,e,r=ei.None){const i=[new KM(t,e)];if(r&ei.Size){const s=t+NZ;i.push(new N3(s,(n,o)=>{const a=e(n,o);return v(a)?ar(qse,a.descriptor.width,a.descriptor.height):Xl}))}if(r&ei.InvSize){const s=t+c6;i.push(new N3(s,(n,o)=>{const a=e(n,o);return v(a)?ar(qse,1/a.descriptor.width,1/a.descriptor.height):Xl}))}return i}const qse=Ke();let Mv=class{constructor(e){this._material=e.material,this._techniqueRepository=e.techniqueRep,this._output=e.output}dispose(){this._techniqueRepository.release(this._technique)}get technique(){return this._technique}get _stippleTextureRepository(){return this._techniqueRepository.constructionContext.stippleTextureRepository}ensureTechnique(e,r){return this._technique=this._techniqueRepository.releaseAndAcquire(e,this._material.getConfiguration(this._output,r),this._technique),this._technique}ensureResources(e){return Xg.LOADED}},BZ=class extends Mv{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._acquire(e.textureId,r=>this._texture=r),this._acquire(e.normalTextureId,r=>this._textureNormal=r),this._acquire(e.emissiveTextureId,r=>this._textureEmissive=r),this._acquire(e.occlusionTextureId,r=>this._textureOcclusion=r),this._acquire(e.metallicRoughnessTextureId,r=>this._textureMetallicRoughness=r)}dispose(){this._texture=ji(this._texture),this._textureNormal=ji(this._textureNormal),this._textureEmissive=ji(this._textureEmissive),this._textureOcclusion=ji(this._textureOcclusion),this._textureMetallicRoughness=ji(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return this._numLoading===0?Xg.LOADED:Xg.LOADING}get textureBindParameters(){return new Rwe(v(this._texture)?this._texture.glTexture:null,v(this._textureNormal)?this._textureNormal.glTexture:null,v(this._textureEmissive)?this._textureEmissive.glTexture:null,v(this._textureOcclusion)?this._textureOcclusion.glTexture:null,v(this._textureMetallicRoughness)?this._textureMetallicRoughness.glTexture:null)}updateTexture(e){(C(this._texture)||e!==this._texture.id)&&(this._texture=ji(this._texture),this._textureId=e,this._acquire(this._textureId,r=>this._texture=r))}_acquire(e,r){if(C(e))return void r(null);const i=this._textureRepository.acquire(e);if(Gu(i))return++this._numLoading,void i.then(s=>{if(this._disposed)return ji(s),void r(null);r(s)}).finally(()=>--this._numLoading);r(i)}},Rwe=class extends pi{constructor(e=null,r=null,i=null,s=null,n=null){super(),this.texture=e,this.textureNormal=r,this.textureEmissive=i,this.textureOcclusion=s,this.textureMetallicRoughness=n}};const g3t=Xr(0,.6,.2);var dt;(function(t){t[t.Disabled=0]="Disabled",t[t.Normal=1]="Normal",t[t.Schematic=2]="Schematic",t[t.Water=3]="Water",t[t.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",t[t.Terrain=5]="Terrain",t[t.TerrainWithWater=6]="TerrainWithWater",t[t.COUNT=7]="COUNT"})(dt||(dt={}));function GZ(t,e){const r=t.fragment,i=e.hasMetallicRoughnessTexture||e.hasEmissionTexture||e.hasOcclusionTexture;if(e.pbrMode===dt.Normal&&i&&t.include(zZ,e),e.pbrMode!==dt.Schematic)if(e.pbrMode!==dt.Disabled){if(e.pbrMode===dt.Normal){r.code.add(w`vec3 mrr;
vec3 emission;
float occlusion;`);const s=e.supportsTextureAtlas?e.hasWebGL2Context?ei.None:ei.Size:ei.None,n=e.pbrTextureBindType;e.hasMetallicRoughnessTexture&&(r.uniforms.add(n===di.Pass?fp("texMetallicRoughness",o=>o.textureMetallicRoughness,s):q_("texMetallicRoughness",o=>o.textureMetallicRoughness,s)),r.code.add(w`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),e.hasEmissionTexture&&(r.uniforms.add(n===di.Pass?fp("texEmission",o=>o.textureEmissive,s):q_("texEmission",o=>o.textureEmissive,s)),r.code.add(w`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),e.hasOcclusionTexture?(r.uniforms.add(n===di.Pass?fp("texOcclusion",o=>o.textureOcclusion,s):q_("texOcclusion",o=>o.textureOcclusion,s)),r.code.add(w`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):r.code.add(w`float getBakedOcclusion() { return 1.0; }`),r.uniforms.add(n===di.Pass?[new Wt("emissionFactor",o=>o.emissiveFactor),new Wt("mrrFactors",o=>o.mrrFactors)]:[new Lu("emissionFactor",o=>o.emissiveFactor),new Lu("mrrFactors",o=>o.mrrFactors)]),r.code.add(w`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${i?w`vtc.uv = vuv0;`:""}
      ${e.hasMetallicRoughnessTextureTransform?w`vtc.uv = metallicRoughnessUV;`:""}
      ${e.hasMetallicRoughnessTexture?e.supportsTextureAtlas?w`
                vtc.size = ${kh(e,"texMetallicRoughness")};
                applyMetallnessAndRoughness(vtc);`:w`applyMetallnessAndRoughness(vtc);`:""}
      ${e.hasEmissiveTextureTransform?w`vtc.uv = emissiveUV;`:""}
      ${e.hasEmissionTexture?e.supportsTextureAtlas?w`
                vtc.size = ${kh(e,"texEmission")};
                applyEmission(vtc);`:w`applyEmission(vtc);`:""}
      ${e.hasOcclusionTextureTransform?w`vtc.uv = occlusionUV;`:""}
      ${e.hasOcclusionTexture?e.supportsTextureAtlas?w`
                vtc.size = ${kh(e,"texOcclusion")};
                applyOcclusion(vtc);`:w`applyOcclusion(vtc);`:""}
    }
  `)}}else r.code.add(w`float getBakedOcclusion() { return 1.0; }`);else r.code.add(w`vec3 mrr = vec3(0.0, 0.6, 0.2);
vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function jZ(t,e){const r=t.fragment,i=e.lightingSphericalHarmonicsOrder!==void 0?e.lightingSphericalHarmonicsOrder:2;i===0?(r.uniforms.add(new Wt("lightingAmbientSH0",(s,n)=>ce(Wse,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0]))),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):i===1?(r.uniforms.add([new fr("lightingAmbientSH_R",(s,n)=>ti(Bm,n.lighting.sh.r[0],n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3])),new fr("lightingAmbientSH_G",(s,n)=>ti(Bm,n.lighting.sh.g[0],n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3])),new fr("lightingAmbientSH_B",(s,n)=>ti(Bm,n.lighting.sh.b[0],n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3]))]),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):i===2&&(r.uniforms.add([new Wt("lightingAmbientSH0",(s,n)=>ce(Wse,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0])),new fr("lightingAmbientSH_R1",(s,n)=>ti(Bm,n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3],n.lighting.sh.r[4])),new fr("lightingAmbientSH_G1",(s,n)=>ti(Bm,n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3],n.lighting.sh.g[4])),new fr("lightingAmbientSH_B1",(s,n)=>ti(Bm,n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3],n.lighting.sh.b[4])),new fr("lightingAmbientSH_R2",(s,n)=>ti(Bm,n.lighting.sh.r[5],n.lighting.sh.r[6],n.lighting.sh.r[7],n.lighting.sh.r[8])),new fr("lightingAmbientSH_G2",(s,n)=>ti(Bm,n.lighting.sh.g[5],n.lighting.sh.g[6],n.lighting.sh.g[7],n.lighting.sh.g[8])),new fr("lightingAmbientSH_B2",(s,n)=>ti(Bm,n.lighting.sh.b[5],n.lighting.sh.b[6],n.lighting.sh.b[7],n.lighting.sh.b[8]))]),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),e.pbrMode!==dt.Normal&&e.pbrMode!==dt.Schematic||r.code.add(w`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}const Wse=M(),Bm=nr();function QM(t){t.vertex.code.add(w`const float PI = 3.141592653589793;`),t.fragment.code.add(w`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}var Is,Gw;function fKe(t){return v(t)&&v(t.cubeMap)}function HZ(t){return v(t)&&!t.running}(function(t){t[t.RENDERING=0]="RENDERING",t[t.FINISHED_RENDERING=1]="FINISHED_RENDERING",t[t.FADING_TEXTURE_CHANNELS=2]="FADING_TEXTURE_CHANNELS",t[t.SWITCH_CHANNELS=3]="SWITCH_CHANNELS",t[t.FINISHED=4]="FINISHED"})(Is||(Is={})),function(t){t[t.RG=0]="RG",t[t.BA=1]="BA"}(Gw||(Gw={}));let mKe=class{constructor(){this.readChannels=Gw.RG,this.renderingStage=Is.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=M(),this.isCameraPositionFinal=!0,this.parallax=new Xse,this.parallaxNew=new Xse,this.crossFade={enabled:!1,factor:1,distanceThresholdFactor:.3},this.fadeInOut={stage:Pn.FINISHED,factor:1,distanceThresholdFactor:.6},this.fadeIn={stage:wc.FINISHED,factor:1,distanceThresholdFactor:2},this.fadeInOutHeight={stage:uv.FINISHED,factor:-1}}get isFading(){return this.fadeInOut.stage===Pn.FADE_OUT||this.fadeInOut.stage===Pn.FADE_IN||this.fadeIn.stage===wc.FADE_IN||this.fadeInOutHeight.stage!==uv.FINISHED||this.renderingStage===Is.FADING_TEXTURE_CHANNELS}};var wc,Pn,uv;(function(t){t[t.FINISHED=0]="FINISHED",t[t.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",t[t.FADE_IN=2]="FADE_IN"})(wc||(wc={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.FADE_OUT=1]="FADE_OUT",t[t.SWITCH=2]="SWITCH",t[t.FADE_IN=3]="FADE_IN"}(Pn||(Pn={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.HEIGHT_FADE=1]="HEIGHT_FADE"}(uv||(uv={}));let Xse=class{constructor(){this.anchorPointClouds=M(),this.cloudsHeight=1e5,this.radiusCurvatureCorrectionFactor=0,this.transform=Ie()}},Yg=class extends ws{constructor(e,r){super(e,"bool",di.Pass,(i,s,n)=>i.setUniform1b(e,r(s,n)))}},gKe=class extends ws{constructor(e,r){super(e,"samplerCube",di.Pass,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function Owe(t){const e=t.fragment;e.uniforms.add([new qi("rotationMatrixClouds",(r,i)=>i.cloudsFade.parallax.transform),new qi("rotationMatrixCloudsCrossFade",(r,i)=>i.cloudsFade.parallaxNew.transform),new Wt("anchorPosition",(r,i)=>i.cloudsFade.parallax.anchorPointClouds),new Wt("anchorPositionCrossFade",(r,i)=>i.cloudsFade.parallaxNew.anchorPointClouds),new Pe("cloudsHeight",(r,i)=>i.cloudsFade.parallax.cloudsHeight),new Pe("radiusCurvatureCorrectionFactor",(r,i)=>i.cloudsFade.parallax.radiusCurvatureCorrectionFactor),new Pe("totalFadeInOut",(r,i)=>i.cloudsFade.fadeInOut.stage===Pn.FINISHED?i.cloudsFade.fadeInOutHeight.factor+1-i.cloudsFade.fadeIn.factor:i.cloudsFade.fadeInOutHeight.factor+1-i.cloudsFade.fadeInOut.factor),new Pe("crossFadeAnchorFactor",(r,i)=>ye(i.cloudsFade.crossFade.factor,0,1)),new gKe("cubeMap",(r,i)=>v(i.cloudsFade.data)&&v(i.cloudsFade.data.cubeMap)?i.cloudsFade.data.cubeMap.colorTexture:null),new Yg("crossFade",(r,i)=>i.cloudsFade.crossFade.enabled),new Yg("readChannelsRG",(r,i)=>i.cloudsFade.readChannels===Gw.RG),new Yg("fadeTextureChannels",(r,i)=>i.cloudsFade.renderingStage===Is.FADING_TEXTURE_CHANNELS)]),e.constants.add("planetRadius","float",br.radius),e.code.add(w`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.code.add(w`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.code.add(w`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),by(e),Cm(e),e.code.add(w`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.code.add(w`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),e.code.add(w`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),e.code.add(w`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),e.code.add(w`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function Am(t){t.code.add(w`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function yKe(){const t=new Lr;t.attributes.add(A.POSITION,"vec2"),t.varyings.add("worldRay","vec3");const{vertex:e,fragment:r}=t;return e.uniforms.add([new qi("inverseProjectionMatrix",(i,s)=>s.camera.inverseProjectionMatrix),new qi("inverseViewMatrix",(i,s)=>BE(_Ke,s.camera.viewMatrix))]),e.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),r.include(Am),r.include(jc),t.include(jZ,{pbrMode:dt.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(QM),t.include(l6),t.include(qF,{useLegacyTerrainShading:!1}),t.include(Owe,{instancedDoublePrecision:!1,useLegacyTerrainShading:!1}),r.uniforms.add([new Wt("cameraPosition",(i,s)=>s.camera.eye)]),r.code.add(w`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),t}const _Ke=Ie(),vKe=Object.freeze(Object.defineProperty({__proto__:null,build:yKe},Symbol.toStringTag,{value:"Module"}));let Mwe=class Pwe extends kr{constructor(e){super(e,new Pa,()=>this.destroy())}initializeProgram(e){return new Nr(e.rctx,Pwe.shader.get().build(),Ar)}initializePipeline(){return zt({blending:Bn(Ee.ONE,Ee.ZERO,Ee.SRC_ALPHA,Ee.ONE),depthTest:{func:$i.LEQUAL},colorWrite:Qt})}};Mwe.shader=new Dr(vKe,()=>ie(()=>import("./CloudsComposition.glsl-5b6cf47a.js"),[],import.meta.url));let lb=class extends Te{constructor(e){super(e),this._technique=new Mwe(e),this._vao=Ia(e.rctx)}destroy(){this._technique=ji(this._technique),this._vao=et(this._vao)}render(e){const r=e.bindParameters.cloudsFade;if(C(this._vao)||C(r.data))return;if(!this._technique.compiled)return void this.requestRender();const i=e.rctx.bindTechnique(this._technique,bKe,e.bindParameters);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays($t.TRIANGLE_STRIP,0,4)}};u([d({constructOnly:!0})],lb.prototype,"rctx",void 0),u([d({constructOnly:!0})],lb.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],lb.prototype,"planetRadius",void 0),u([d({constructOnly:!0})],lb.prototype,"requestRender",void 0),lb=u([P("esri.views.3d.environment.CloudsComposition")],lb);const bKe=new pi;var Bl;(function(t){t[t.SIXTEEN=0]="SIXTEEN",t[t.HUNDRED=1]="HUNDRED",t[t.TWOHUNDRED=2]="TWOHUNDRED",t[t.COUNT=3]="COUNT"})(Bl||(Bl={}));let zD=class extends Pa{constructor(){super(...arguments),this.steps=Bl.SIXTEEN,this.writeTextureChannels=Gw.RG}};u([k({count:Bl.COUNT})],zD.prototype,"steps",void 0),u([k({constValue:de("esri-mobile")?1024:2048})],zD.prototype,"cubeMapSize",void 0),u([k()],zD.prototype,"writeTextureChannels",void 0);let DR=class{constructor(e,r,i,s,n,o,a,l,c=.5){this.coverage=e,this.density=r,this.absorption=i,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingSteps=l,this.median=c}};const Yse=new DR([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Bl.SIXTEEN),ha={sunny:Yse,cloudy:new DR([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Bl.TWOHUNDRED,.6),rainy:new DR([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Bl.TWOHUNDRED,.4),snowy:new DR([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Bl.HUNDRED,.65),foggy:new DR([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Bl.SIXTEEN),default:Yse},Eh=de("esri-mobile")?64:128,wKe=Eh/128,zd=Math.ceil(Math.sqrt(Eh)),Kd=(Eh+2)*zd,xKe=1e5,Q8=128,TKe=Kd/1560;function sd(t,e=!0){t.attributes.add(A.POSITION,"vec2"),e&&t.varyings.add("uv","vec2"),t.vertex.code.add(w`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e?w`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}let F3=class extends ws{constructor(e,r){super(e,"mat3",di.Draw,(i,s,n)=>i.setUniformMatrix3fv(e,r(s,n)))}},Iwe=class extends pi{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=ha.default.raymarchingSteps,this.weatherTile=Ke()}},$we=class extends pi{constructor(){super(...arguments),this.viewMatrix=rs()}};function SKe(t){const e=new Lr;e.include(sd,!1);const r=e.fragment;return r.uniforms.add([new Pe("cloudRadius",i=>i.cloudRadius),new Pe("power",i=>Ft(35,120,i.absorption)),new Pe("sigmaE",i=>1+i.absorption),new Pe("density",i=>Ft(0,.3,i.density)),new Pe("cloudSize",i=>Ft(0,.02,Math.max(.01,1-i.cloudSize))),new Pe("detailSize",i=>Ft(0,.2,Math.max(.01,1-i.detailSize))),new Pe("smoothness",i=>Ft(0,.5,1-i.smoothness)),new Pe("cloudHeight",i=>Ft(0,1500,i.cloudHeight)),new Pe("coverage",i=>i.coverage),new F3("view",i=>i.viewMatrix),new Pt("cloudShapeTexture",i=>v(i.noiseTexture)?i.noiseTexture.textureAtlas:null),new Ur("cloudVariables",i=>ar(EKe,i.coverage,i.absorption))]),r.constants.add("halfCubeMapSize","float",.5*t.cubeMapSize),r.code.add(w`
    const int STEPS = ${t.steps===Bl.SIXTEEN?w`16`:t.steps===Bl.HUNDRED?w`100`:w`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),r.code.add(w`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${w.float(Kd)};
      const float dataWidth = ${w.float(Kd)};
      const float tileRows = ${w.float(zd)};
      const vec3 atlasDimensions = vec3(${w.float(Eh)}, ${w.float(Eh)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${w.float(wKe)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Non-power-of-two textures can't be tiled using WebGL1
      // Get fractional part of uv to tile
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = fract((${w.float(TKe)} * p) / ${w.float(Kd)} + 0.5);

      return texture2D(cloudShapeTexture, uv).a;
    }
    `),r.code.add(w`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),r.code.add(w`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),r.code.add(`
    float multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      float luminance = 0.0;

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),r.code.add(w`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),r.code.add(w`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),r.code.add(w`void main() {
if (coverage ==  0.0) {
gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
gl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
gl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),e}const EKe=Ke(),CKe=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:$we,CloudsPassParameters:Iwe,build:SKe},Symbol.toStringTag,{value:"Module"}));let Lwe=class Dwe extends kr{constructor(e,r){super(e,r,()=>this.destroy())}initializeProgram(e){return new Nr(e.rctx,Dwe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Mp(Ee.CONSTANT_COLOR,Ee.ONE_MINUS_CONSTANT_COLOR,gm.ADD,this.configuration.writeTextureChannels===Gw.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:$i.LEQUAL},colorWrite:Qt})}};Lwe.shader=new Dr(CKe,()=>ie(()=>import("./Clouds.glsl-0f4c67ca.js"),[],import.meta.url));var Au;(function(t){t[t.Full=0]="Full",t[t.WeatherMap=1]="WeatherMap",t[t.COUNT=2]="COUNT"})(Au||(Au={}));let Fj=class extends Pa{constructor(){super(...arguments),this.mode=Au.Full}};u([k({count:Au.COUNT})],Fj.prototype,"mode",void 0);let Nwe=class extends pi{constructor(){super(...arguments),this.weatherTile=Fr(0,0)}};function AKe(t){const e=new Lr;return e.include(sd,!1),e.fragment.code.add(w`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),t.mode===Au.Full&&e.fragment.code.add(w`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${w.float(zd)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${w.float(8)});

      float worley0 = worley(p, ${w.float(2)} * 2.0);
      float worley1 = worley(p, ${w.float(2)} * 8.0);
      float worley2 = worley(p, ${w.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${w.float(2)});
      float worley1 = worley(p, ${w.float(2)} * 2.0);
      float worley2 = worley(p, ${w.float(2)} * 4.0);
      float worley3 = worley(p, ${w.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.uniforms.add(new Ur("weatherTile",r=>r.weatherTile)),e.fragment.code.add(w`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${w.float(Q8)});

      // Get global coordinates of p
      p += weatherTile * ${w.float(Q8)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${w.float(xKe)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.fragment.code.add(w`void main() {`),t.mode===Au.Full&&e.fragment.code.add(w`
        float padWidth = 1.0;
        float paddedSize = ${w.float(Eh)} + 2.0 * padWidth;
        float tileCount = ${w.float(zd)} * ${w.float(zd)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${w.float(Eh)};
          }

          if (startPadY) {
            pixel.y += ${w.float(Eh)};
          }

          if (endPadX) {
            pixel.x -= ${w.float(Eh)};
          }

          if (endPadY) {
            pixel.y -= ${w.float(Eh)};
          }

          uv = vec2(pixel.xy / ${w.float(Eh)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${w.float(Eh)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${w.float(zd)} * ${w.float(zd)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${w.float(zd)} * ${w.float(zd)});
        p = p_;
        p.z /= (${w.float(zd)} * ${w.float(zd)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),e.fragment.code.add(w`
      vec2 mapUV = ${w.float(Q8)} * (gl_FragCoord.xy / ${w.float(Kd)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${t.mode===Au.Full?w`gl_FragColor.ba = vec2(0.0, map);`:w`gl_FragColor = vec4(map);`};
    }
  `),e}const RKe=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:Nwe,build:AKe},Symbol.toStringTag,{value:"Module"}));let Uj=class Fwe extends kr{initializeProgram(e){return new Nr(e.rctx,Fwe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:this.configuration.mode===Au.Full?Mp(Ee.ONE,Ee.ZERO):Bn(Ee.ZERO,Ee.ONE,Ee.ONE,Ee.ZERO),depthTest:{func:$i.ALWAYS},colorWrite:Qt})}};Uj.shader=new Dr(RKe,()=>ie(()=>import("./NoiseTextureAtlas.glsl-32a65c96.js"),[],import.meta.url));let y2=class{constructor(e,r){this._context=e,this._desc=r,this.type="renderbuffer",this._context.instanceCounter.increment(Un.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=r;if(a){if(this._context.type!==bt.WEBGL2)throw new Error("Multisampled renderbuffers are not supported in WebGL1!");i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,o,s,n)}else i.renderbufferStorage(i.RENDERBUFFER,o,s,n)}get descriptor(){return this._desc}get samples(){const e=this._desc.samples,r=this._context.parameters.maxSamples;return e?Math.min(e,r):r}resize(e,r){const i=this._desc;if(i.width===e&&i.height===r)return;i.width=e,i.height=r;const s=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):s.renderbufferStorage(s.RENDERBUFFER,i.internalFormat,i.width,i.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(Un.Renderbuffer,this),this._context=yw(this._context))}},Ns=class _2{constructor(e,r,i=null,s=null){if(this._context=e,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._depthStencilTexture=null,this._initialized=!1,this._desc={...r},e.instanceCounter.increment(Un.FramebufferObject,this),v(i)){Array.isArray(i)||(i=[i]);for(let n=0;n<i.length;++n){const o=i[n],a=pu.COLOR_ATTACHMENT0+n;let l;Jse(o)?(vg(o)?(l=o.descriptor,this._colorAttachments.set(a,o)):(l=o,this._colorAttachments.set(a,new ct(this._context,l))),AI(l,this._desc)):(Zse(o)?(l=o.descriptor,this._colorAttachments.set(a,o)):(l=o,this._colorAttachments.set(a,new y2(this._context,l))),e9(l,this._desc)),this._validateColorAttachmentPoint(a)}}if(v(s)){let n,o;if(Jse(s))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),vg(s)?(o=s.descriptor,this._depthStencilTexture=s):(o=s,this._depthStencilTexture=new ct(this._context,o)),AI(o,this._desc);else{Zse(s)?(o=s.descriptor,n=s):(o=s,n=new y2(this._context,o));const a=this._desc.depthStencilTarget??Ir.DEPTH_STENCIL_RENDER_BUFFER;a===Ir.STENCIL_RENDER_BUFFER?this._stencilAttachment=n:a===Ir.DEPTH_RENDER_BUFFER||a===Ir.DEPTH_STENCIL_RENDER_BUFFER?this._depthAttachment=n:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),this._desc.depthStencilTarget=a,e9(o,this._desc)}}}dispose(){if(!this._desc)return;const e=this._context.getBoundFramebufferObject();this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(e),this._context.instanceCounter.decrement(Un.FramebufferObject,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const e=this._colorAttachments.get(pu.COLOR_ATTACHMENT0);return e&&vg(e)?e:null}get colorAttachment(){return this._colorAttachments.get(pu.COLOR_ATTACHMENT0)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width??0}get height(){return this._desc.height??0}get gpuMemoryUsage(){return[...this._colorAttachments].reduce((e,[r,i])=>e+Bw(i),0)+Bw(this.depthStencilAttachment)}getColorTexture(e){const r=this._colorAttachments.get(e);return r&&vg(r)?r:null}attachColorTexture(e,r=pu.COLOR_ATTACHMENT0){e&&(this._validateColorAttachmentPoint(r),AI(e.descriptor,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,r)),this._colorAttachments.set(r,e))}detachColorTexture(e=pu.COLOR_ATTACHMENT0){const r=this._colorAttachments.get(e);if(vg(r)){const i=r;return this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e)),this._colorAttachments.delete(e),i}}setColorTextureTarget(e,r=pu.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(r);vg(i)&&this._framebufferTexture2D(i.glName,r,e)}attachDepthStencilTexture(e){if(C(e))return;const r=e.descriptor;r.pixelFormat!==ze.DEPTH_STENCIL&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),r.dataType!==Lt.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),AI(r,this._desc),this._desc.depthStencilTarget&&this._desc.depthStencilTarget!==Ir.DEPTH_STENCIL_TEXTURE&&(this._desc.depthStencilTarget=Ir.DEPTH_STENCIL_TEXTURE),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,Fse)),this._depthStencilTexture=e}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,Fse)),this._depthStencilTexture=null,e}attachDepthStencilBuffer(e){if(C(e))return;const r=e.descriptor;if(r.internalFormat!==Ya.DEPTH_STENCIL&&r.internalFormat!==Ya.DEPTH_COMPONENT16&&console.error("Depth/Stencil buffer must have correct internalFormat"),e9(r,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=r.internalFormat===Ya.DEPTH_STENCIL?Ir.DEPTH_STENCIL_RENDER_BUFFER:Ir.DEPTH_RENDER_BUFFER,this._initialized){this._context.bindFramebuffer(this);const i=this._context.gl,s=this._desc.depthStencilTarget===Ir.DEPTH_RENDER_BUFFER?i.DEPTH_ATTACHMENT:i.DEPTH_STENCIL_ATTACHMENT;i.framebufferRenderbuffer(Qn.FRAMEBUFFER,s,i.RENDERBUFFER,e.glName)}this._depthAttachment=e}detachDepthStencilBuffer(){const e=this._context.gl,r=this._depthAttachment;if(r&&this._initialized){this._context.bindFramebuffer(this);const i=this._desc.depthStencilTarget===Ir.DEPTH_RENDER_BUFFER?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(Qn.FRAMEBUFFER,i,e.RENDERBUFFER,null)}return this._depthAttachment=null,r}detachAll(){this._colorAttachments.forEach((e,r)=>this._detachColorAttachment(r)),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(e,r,i,s,n,o,a){(e<0||r<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(i<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=this._desc,c=a.descriptor;a.descriptor.target!==wt.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),((l==null?void 0:l.width)==null||(l==null?void 0:l.height)==null||(c==null?void 0:c.width)==null||(c==null?void 0:c.height)==null||e+i>l.width||r+s>l.height||n+i>c.width||o+s>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,p=h.bindTexture(a,ct.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(ct.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(this),h.gl.copyTexSubImage2D(wt.TEXTURE_2D,0,n,o,e,r,i,s),h.bindTexture(p,ct.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,r,i,s,n,o,a){(i<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,r,i,s,n,o,a)}async readPixelsAsync(e,r,i,s,n,o,a){if(this._context.type!==bt.WEBGL2)return yu()&&console.warn("Attempting to read pixels using pixel buffer object without WebGL2"),void this.readPixels(e,r,i,s,n,o,a);const l=this._context.gl,c=jr.createPixelPack(this._context,$r.STREAM_READ,a.byteLength);this._context.bindBuffer(c),this._context.bindFramebuffer(this),l.readPixels(e,r,i,s,n,o,0),this._context.unbindBuffer(Mt.PIXEL_PACK_BUFFER),await c.getSubDataAsync(a),c.dispose()}resize(e,r){const i=this._desc;if(i.width!==e||i.height!==r){if(i.width=e,i.height=r,!this._initialized)return this._colorAttachments.forEach(s=>{s&&s.resize(e,r)}),void(this._depthStencilTexture&&this._depthStencilTexture.resize(e,r));this._colorAttachments.forEach(s=>{s&&s.resize(e,r)}),this._depthStencilTexture!=null?this._depthStencilTexture.resize(e,r):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(e,r),this._stencilAttachment&&this._stencilAttachment.resize(e,r)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(e=Qn.FRAMEBUFFER){const r=this._context.gl;if(this._initialized)return void r.bindFramebuffer(e,this.glName);this._glName&&r.deleteFramebuffer(this._glName);const i=this._context,s=r.createFramebuffer(),n=this._desc,o=n.colorTarget??us.RENDER_BUFFER,a=n.width??1,l=n.height??1;if(r.bindFramebuffer(e,s),this._colorAttachments.size===0)if(o===us.TEXTURE||o===us.CUBEMAP)this._colorAttachments.set(pu.COLOR_ATTACHMENT0,OKe(i,n,this.descriptor.colorTarget===us.CUBEMAP?wt.TEXTURE_CUBE_MAP:wt.TEXTURE_2D));else{const h=new y2(i,{internalFormat:Et.RGBA4,width:a,height:l});this._colorAttachments.set(pu.COLOR_ATTACHMENT0,h)}this._colorAttachments.forEach((h,p)=>{h&&(vg(h)?this._framebufferTexture2D(h.glName,p,Kse(h),e):r.framebufferRenderbuffer(e,p,r.RENDERBUFFER,h.glName))});const c=n.depthStencilTarget??Ir.NONE;switch(c){case Ir.DEPTH_RENDER_BUFFER:case Ir.DEPTH_STENCIL_RENDER_BUFFER:{this._depthAttachment||(this._depthAttachment=new y2(i,{internalFormat:n.depthStencilTarget===Ir.DEPTH_RENDER_BUFFER?Ya.DEPTH_COMPONENT16:Ya.DEPTH_STENCIL,width:a,height:l}));const h=c===Ir.DEPTH_RENDER_BUFFER?r.DEPTH_ATTACHMENT:r.DEPTH_STENCIL_ATTACHMENT;r.framebufferRenderbuffer(e,h,r.RENDERBUFFER,this._depthAttachment.glName);break}case Ir.STENCIL_RENDER_BUFFER:this._stencilAttachment||(this._stencilAttachment=new y2(i,{internalFormat:Ya.STENCIL_INDEX8,width:a,height:l})),r.framebufferRenderbuffer(e,r.STENCIL_ATTACHMENT,r.RENDERBUFFER,this._stencilAttachment.glName);break;case Ir.DEPTH_STENCIL_TEXTURE:if(!this._depthStencilTexture){i.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");const h={target:wt.TEXTURE_2D,pixelFormat:ze.DEPTH_STENCIL,dataType:Lt.UNSIGNED_INT_24_8,samplingMode:tt.NEAREST,wrapMode:Ot.CLAMP_TO_EDGE,width:a,height:l};this._depthStencilTexture=new ct(i,h)}this._framebufferTexture2D(this._depthStencilTexture.glName,r.DEPTH_STENCIL_ATTACHMENT,Kse(this._depthStencilTexture),e)}yu()&&r.checkFramebufferStatus(e)!==r.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=s,this._initialized=!0}_framebufferTexture2D(e,r=pu.COLOR_ATTACHMENT0,i=wt.TEXTURE_2D,s=Qn.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(s,r,i,e,n)}_detachColorAttachment(e){yu()&&console.warn("Detaching an FBO attachment can be a slow due to invalidating framebuffer completeness!");const r=this._context.gl,i=this._colorAttachments.get(e);return vg(i)?this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e)):this._initialized&&(this._context.bindFramebuffer(this),r.framebufferRenderbuffer(Qn.FRAMEBUFFER,e,r.RENDERBUFFER,null)),this._colorAttachments.delete(e),i}_disposeColorAttachments(){this._colorAttachments.forEach((e,r)=>{this._detachColorAttachment(r),e.dispose()}),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const r=this._desc.depthStencilTarget===Ir.DEPTH_RENDER_BUFFER?e.DEPTH_ATTACHMENT:e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(Qn.FRAMEBUFFER,r,e.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),e.framebufferRenderbuffer(Qn.FRAMEBUFFER,e.STENCIL_ATTACHMENT,e.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateColorAttachmentPoint(e){if(_2._MAX_COLOR_ATTACHMENTS===-1){const i=this._context.capabilities.drawBuffers;if(i){const s=this._context.gl;_2._MAX_COLOR_ATTACHMENTS=s.getParameter(i.MAX_COLOR_ATTACHMENTS)}else _2._MAX_COLOR_ATTACHMENTS=1}const r=e-pu.COLOR_ATTACHMENT0;r+1>_2._MAX_COLOR_ATTACHMENTS&&se.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${r+1}. Implementation supports up to ${_2._MAX_COLOR_ATTACHMENTS} color attachments`)}};function vg(t){return t!=null&&"type"in t&&t.type==="texture"}function Zse(t){return t!=null&&"type"in t&&t.type==="renderbuffer"}function Jse(t){return vg(t)||t!=null&&"pixelFormat"in t}function OKe(t,e,r){return new ct(t,{target:r,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,wrapMode:Ot.CLAMP_TO_EDGE,width:e.width,height:e.height})}function AI(t,e){t.target!==wt.TEXTURE_2D&&t.target!==wt.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),e.width!==void 0&&e.width>=0&&e.height!==void 0&&e.height>=0?e.width===t.width&&e.height===t.height||console.error("Color attachment texture must match the framebuffer's!"):(e.width=t.width,e.height=t.height)}function e9(t,e){e.width!==void 0&&e.width>=0&&e.height!==void 0&&e.height>=0?e.width===t.width&&e.height===t.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(e.width=t.width,e.height=t.height)}function Kse(t){return t.descriptor.target===wt.TEXTURE_CUBE_MAP?wt.TEXTURE_CUBE_MAP_POSITIVE_X:wt.TEXTURE_2D}Ns._MAX_COLOR_ATTACHMENTS=-1;let NR=class extends Te{constructor(e){super(e),this._needsRender=!0,this._passParameters=new Nwe,this._frameBuffer=new Ns(e.context.renderContext.rctx,{colorTarget:us.TEXTURE,width:Kd,height:Kd},{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,hasMipmap:!1,width:Kd,height:Kd}),this._vao=Ia(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return v(this._texture)?v(this._weatherMapTechnique)&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(Au.WeatherMap)):v(this._fullTechnique)&&this._fullTechnique.compiled&&(this._texture=this._render(Au.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(zn(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=ji(this._fullTechniqueCached),this._weatherMapTechniqueCached=ji(this._weatherMapTechniqueCached),this._frameBuffer=et(this._frameBuffer),this._vao=et(this._vao)}get _fullTechnique(){if(C(this._fullTechniqueCached)){const e=new Fj;e.mode=Au.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(Uj,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(C(this._weatherMapTechniqueCached)){const e=new Fj;e.mode=Au.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(Uj,e)}return this._weatherMapTechniqueCached}_render(e){if(C(this._vao)||C(this._frameBuffer))return null;const r=e===Au.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,s=i.getViewport();i.setViewport(0,0,Kd,Kd),i.bindFramebuffer(this._frameBuffer);const n=i.bindTechnique(r,this._passParameters,null);return i.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._frameBuffer.colorTexture}};u([d({constructOnly:!0})],NR.prototype,"context",void 0),u([d({readOnly:!0})],NR.prototype,"_techniqueRepository",null),NR=u([P("esri.views.3d.environment.NoiseTextureAtlas")],NR);function Uwe(t){t.include(ku),t.uniforms.add([new Pt("geometryDepthTexture",(e,r)=>r.multipassGeometry.linearDepthTexture),new Ur("nearFar",(e,r)=>r.camera.nearFar)]),t.code.add(w`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}let MKe=class{constructor(){this.enabled=!1}};function zu(t,e){e.hasMultipassTerrain&&(t.fragment.include(ku),t.fragment.uniforms.add(new Pt("terrainDepthTexture",(r,i)=>i.multipassTerrain.linearDepthTexture)),t.fragment.uniforms.add(new Ur("nearFar",(r,i)=>i.camera.nearFar)),t.fragment.uniforms.add(new Ur("inverseViewport",(r,i)=>i.inverseViewport)),t.fragment.code.add(w`
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){
      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${e.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `))}let PKe=class{constructor(){this.enabled=!1,this.cullAboveGround=!1}};function IKe(t,e){const r=t.fragment;r.include(ku),r.uniforms.add(new Ur("nearFar",(i,s)=>s.camera.nearFar)),r.uniforms.add(new Pt("depthMap",(i,s)=>s.linearDepthTexture)),r.uniforms.add(new qi("proj",(i,s)=>s.ssr.camera.projectionMatrix)),r.uniforms.add(new Pe("invResolutionHeight",(i,s)=>1/s.ssr.camera.height)),r.uniforms.add(new qi("reprojectionMatrix",(i,s)=>s.ssr.reprojectionMatrix)),r.code.add(w`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${e.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}let $Ke=class{constructor(){this.enabled=!1,this.fadeFactor=1,this.reprojectionMatrix=Ie()}};function LKe(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function DKe(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function NKe(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function FKe(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}var Vj;let At=Vj=class extends Te{constructor(t={}){super(t),this._center=M(),this._up=M(),this._viewUp=M(),this._viewForward=M(),this._viewRight=M(),this._ray=no(),this._viewport=qt(0,0,1,1),this._padding=qt(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Fr(1,1e3),this._viewDirty=!0,this._viewMatrix=Ie(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Ie(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Ie(),this._frustumDirty=!0,this._frustum=w3(),this._fullViewport=nr(),this._pixelRatio=1,this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return ge(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){kn(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=kE(nr(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&QW(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[cr.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[cr.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[cr.RIGHT]+this._padding[cr.LEFT]}set fullWidth(t){this.width=t-(this._padding[cr.RIGHT]+this._padding[cr.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[cr.TOP]+this._padding[cr.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[cr.TOP]+this._padding[cr.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[cr.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[cr.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){uS(this._padding,t)||(this._viewport[0]+=t[cr.LEFT]-this._padding[cr.LEFT],this._viewport[1]+=t[cr.BOTTOM]-this._padding[cr.BOTTOM],this._viewport[2]-=t[cr.RIGHT]+t[cr.LEFT]-(this._padding[cr.RIGHT]+this._padding[cr.LEFT]),this._viewport[3]-=t[cr.TOP]+t[cr.BOTTOM]-(this._padding[cr.TOP]+this._padding[cr.BOTTOM]),rp(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(ys(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this._aspect,s=Rfe(Ie(),-i*(1+2*this._padding[cr.LEFT]/t),i*(1+2*this._padding[cr.RIGHT]/t),-r*(1+2*this._padding[cr.BOTTOM]/e),r*(1+2*this._padding[cr.TOP]/e),this.near,this.far),n=this._get("projectionMatrix");return n&&dX(n,s)?n:s}get inverseProjectionMatrix(){return Lo(Ie(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||Ie()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return NKe(this._fov,this.width,this.height)}set fovX(t){this._fov=LKe(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return FKe(this._fov,this.width,this.height)}set fovY(t){this._fov=DKe(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Si(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Lo(this._viewInverseTransposeMatrix,this.viewMatrix),kc(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}copyFrom(t){le(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,rp(this._viewport,t.viewport),this.notifyChange("_viewport"),rp(this._padding,t.padding),this.notifyChange("_padding"),zn(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(kn(this._viewMatrix,t.viewMatrix),le(this._viewRight,t.viewRight),le(this._viewUp,t.viewUp),le(this._viewForward,t.viewForward)),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(hF(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(kn(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),rp(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new Vj().copyFrom(this)}equals(t){return Qa(this.eye,t.eye)&&Qa(this.center,t.center)&&Qa(this.up,t.up)&&uS(this._viewport,t.viewport)&&uS(this._padding,t.padding)&&swe(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(Math.abs(t.fov-this._fov)>=.001||YN(t.padding,this._padding)>=.5||YN(this.screenViewport,t.screenViewport)>=.5)return!1;so(na,t.eye,t.center),so(t9,this.eye,this.center);const e=_e(na,t9),r=az(na),i=az(t9),s=5e-4;return e*e>=(1-1e-10)*r*i&&YW(t.eye,this.eye)<Math.max(r,i)*s*s}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(gO(this.viewForward,ge(na,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=cs()){return t[0]=(this.padding[cr.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[cr.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t[0]=this.padding[cr.LEFT]+this.width*e,t[1]=this.padding[cr.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e){t!==lr&&le(lr,t),lr[3]=1,Ru(lr,lr,this.projectionMatrix);const r=Math.abs(lr[3]);ae(lr,lr,1/r);const i=this.fullViewport;e[0]=Ft(0,i[0]+i[2],.5+.5*lr[0]),e[1]=Ft(0,i[1]+i[3],.5+.5*lr[1]),e[2]=.5*(lr[2]+1),e[3]=r}unapplyProjection(t,e){const r=this.fullViewport;lr[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],lr[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],lr[2]=(2*t[2]-1)*t[3],lr[3]=t[3],this.inverseProjectionMatrix!=null&&(Ru(lr,lr,this.inverseProjectionMatrix),e[0]=lr[0],e[1]=lr[1],e[2]=lr[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,r9),this.renderToScreen(r9,e),e}projectToRenderScreen(t,e){if(lr[0]=t[0],lr[1]=t[1],lr[2]=t[2],lr[3]=1,Ru(lr,lr,this.viewProjectionMatrix),lr[3]===0)return null;ae(lr,lr,1/Math.abs(lr[3]));const r=this.fullViewport;return"x"in e?(e.x=Ft(0,r[0]+r[2],.5+.5*lr[0]),e.y=Ft(0,r[1]+r[3],.5+.5*lr[1])):(e[0]=Ft(0,r[0]+r[2],.5+.5*lr[0]),e[1]=Ft(0,r[1]+r[3],.5+.5*lr[1]),e.length>2&&(e[2]=.5*(lr[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,r9),e)}unprojectFromRenderScreen(t,e){if(ys(RI,this.projectionMatrix,this.viewMatrix),!Lo(RI,RI))return null;const r=this.fullViewport;return lr[0]=2*(t[0]-r[0])/r[2]-1,lr[1]=2*(t[1]-r[1])/r[3]-1,lr[2]=2*t[2]-1,lr[3]=1,Ru(lr,lr,RI),lr[3]===0?null:(e[0]=lr[0]/lr[3],e[1]=lr[1]/lr[3],e[2]=lr[2]/lr[3],e)}constrainWindowSize(t,e,r,i){const s=t*this.pixelRatio,n=e*this.pixelRatio,o=Math.max(s-r/2,0),a=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(s-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0);return[o,a,r-l- -Math.min(this.fullWidth-s-r/2,0),i-c- -Math.min(n-i/2,0)]}computeUp(t){t===Be.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const r=t[0]*this.pixelRatio,i=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=i,e}renderToScreen(t,e){const r=t[0]/this.pixelRatio,i=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=i}_computeUpGlobal(){ge(na,this.center,this.eye);const t=Me(this.center);t<1?(ce(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(_e(na,this.center))>.9999*Me(na)*t||(pt(this._up,na,this.center),pt(this._up,this._up,na),ve(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){my(na,this.eye,this.center),Math.abs(na[2])<=.9999&&(ae(na,na,na[2]),ce(this._up,-na[0],-na[1],1-na[2]),ve(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,r=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?Qa(t,e)||(le(e,t),this._markViewDirty(),r.length&&this.notifyChange(r)):se.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Tye(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(s5(this._viewMatrix,this.eye,this.center,this.up),ce(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ce(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ce(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};u([d()],At.prototype,"_center",void 0),u([d()],At.prototype,"_up",void 0),u([d()],At.prototype,"_viewport",void 0),u([d()],At.prototype,"_padding",void 0),u([d()],At.prototype,"_fov",void 0),u([d()],At.prototype,"_nearFar",void 0),u([d()],At.prototype,"_pixelRatio",void 0),u([d()],At.prototype,"pixelRatio",null),u([d()],At.prototype,"eye",null),u([d()],At.prototype,"center",null),u([d()],At.prototype,"up",null),u([d({readOnly:!0})],At.prototype,"nearFar",null),u([d()],At.prototype,"near",null),u([d()],At.prototype,"far",null),u([d()],At.prototype,"viewport",null),u([d({readOnly:!0})],At.prototype,"screenViewport",null),u([d()],At.prototype,"x",null),u([d()],At.prototype,"y",null),u([d()],At.prototype,"width",null),u([d()],At.prototype,"height",null),u([d()],At.prototype,"fullWidth",null),u([d()],At.prototype,"fullHeight",null),u([d({readOnly:!0})],At.prototype,"_aspect",null),u([d()],At.prototype,"padding",null),u([d({readOnly:!0})],At.prototype,"projectionMatrix",null),u([d({readOnly:!0})],At.prototype,"inverseProjectionMatrix",null),u([d()],At.prototype,"fov",null),u([d()],At.prototype,"fovX",null),u([d()],At.prototype,"fovY",null),At=Vj=u([P("esri.views.3d.webgl-engine.lib.Camera")],At);const lr=nr(),RI=Ie(),na=M(),t9=M(),r9=Zo();var cr;(function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"})(cr||(cr={}));var Se;(function(t){t[t.INTEGRATED_MESH=0]="INTEGRATED_MESH",t[t.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",t[t.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",t[t.TRANSPARENT_MATERIAL=3]="TRANSPARENT_MATERIAL",t[t.TRANSPARENT_TERRAIN=4]="TRANSPARENT_TERRAIN",t[t.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=5]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",t[t.OCCLUDED_TERRAIN=6]="OCCLUDED_TERRAIN",t[t.OCCLUDER_MATERIAL=7]="OCCLUDER_MATERIAL",t[t.TRANSPARENT_OCCLUDER_MATERIAL=8]="TRANSPARENT_OCCLUDER_MATERIAL",t[t.OCCLUSION_PIXELS=9]="OCCLUSION_PIXELS",t[t.POSTPROCESSING_ENVIRONMENT_OPAQUE=10]="POSTPROCESSING_ENVIRONMENT_OPAQUE",t[t.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=11]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",t[t.LASERLINES=12]="LASERLINES",t[t.LASERLINES_CONTRAST_CONTROL=13]="LASERLINES_CONTRAST_CONTROL",t[t.HUD_MATERIAL=14]="HUD_MATERIAL",t[t.LABEL_MATERIAL=15]="LABEL_MATERIAL",t[t.LINE_CALLOUTS=16]="LINE_CALLOUTS",t[t.LINE_CALLOUTS_HUD_DEPTH=17]="LINE_CALLOUTS_HUD_DEPTH",t[t.DRAPED_MATERIAL=18]="DRAPED_MATERIAL",t[t.DRAPED_WATER=19]="DRAPED_WATER",t[t.VOXEL=20]="VOXEL",t[t.MAX_SLOTS=21]="MAX_SLOTS"})(Se||(Se={}));var Tt;(function(t){t[t.Color=0]="Color",t[t.Alpha=1]="Alpha",t[t.FrontFace=2]="FrontFace",t[t.NONE=3]="NONE",t[t.COUNT=4]="COUNT"})(Tt||(Tt={}));let qZ=class{constructor(e=M()){this.intensity=e}},Vwe=class{constructor(e=M(),r=$e(.57735,.57735,.57735)){this.intensity=e,this.direction=r}},YF=class{constructor(e=M(),r=$e(.57735,.57735,.57735),i=!0,s=1,n=1){this.intensity=e,this.direction=r,this.castShadows=i,this.specularStrength=s,this.environmentStrength=n}},kwe=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function UKe(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e[i];return r}function i9(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e;return r}function bS(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]+e[i];return r}function zwe(t){return(t+1)*(t+1)}function VKe(t){return ye(Math.floor(Math.sqrt(t)-1),0,2)}function Bwe(t,e,r){const i=t[0],s=t[1],n=t[2],o=r||[];return o.length=zwe(e),e>=0&&(o[0]=.28209479177),e>=1&&(o[1]=.4886025119*i,o[2]=.4886025119*n,o[3]=.4886025119*s),e>=2&&(o[4]=1.09254843059*i*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*i*n,o[8]=.54627421529*(i*i-s*s)),o}function kKe(t,e){const r=zwe(t),i=e||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let s=0;s<r;s++)i.r[s]=i.g[s]=i.b[s]=0;return i}function zKe(t,e){const r=VKe(e.r.length);for(const i of t)xa(kj,i.direction),Bwe(kj,r,Ng),UKe(Ng,BD),i9(Ng,i.intensity[0],Mx),bS(e.r,Mx),i9(Ng,i.intensity[1],Mx),bS(e.g,Mx),i9(Ng,i.intensity[2],Mx),bS(e.b,Mx);return e}function BKe(t,e){Bwe(kj,0,Ng);for(const r of t)e.r[0]+=Ng[0]*BD[0]*r.intensity[0]*4*Math.PI,e.g[0]+=Ng[0]*BD[0]*r.intensity[1]*4*Math.PI,e.b[0]+=Ng[0]*BD[0]*r.intensity[2]*4*Math.PI;return e}function GKe(t,e,r,i){kKe(e,i),ce(r.intensity,0,0,0);let s=!1;const n=jKe,o=HKe,a=qKe;n.length=0,o.length=0,a.length=0;for(const l of t)l instanceof YF&&!s?(le(r.direction,l.direction),le(r.intensity,l.intensity),r.specularStrength=l.specularStrength,r.environmentStrength=l.environmentStrength,r.castShadows=l.castShadows,s=!0):l instanceof YF||l instanceof Vwe?n.push(l):l instanceof qZ?o.push(l):l instanceof kwe&&a.push(l);zKe(n,i),BKe(o,i);for(const l of a)bS(i.r,l.r),bS(i.g,l.g),bS(i.b,l.b)}const jKe=[],HKe=[],qKe=[],Ng=[0],Mx=[0],kj=M(),BD=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];let Qse=class{constructor(){this.color=M(),this.intensity=1}},WKe=class{constructor(){this.direction=M(),this.ambient=new Qse,this.diffuse=new Qse}};const Gwe=.4;let s9=class{constructor(){this._shOrder=2,this._legacy=new WKe,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new kwe,this._mainLight=new YF(M(),$e(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){GKe(e,this._shOrder,this._mainLight,this._sphericalHarmonics),le(this._legacy.direction,this._mainLight.direction);const r=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*r,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*r,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*r,ae(this._legacy.diffuse.color,this._mainLight.intensity,r),le(OI,this._legacy.diffuse.color),ae(OI,OI,Gwe*this.globalFactor),me(this._legacy.ambient.color,this._legacy.ambient.color,OI)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),this._mainLight.direction=gs(e.mainLight.direction),this._mainLight.intensity=gs(e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,r,i){if(Qs(this._mainLight.intensity,e.mainLight.intensity,r.mainLight.intensity,i),this._mainLight.environmentStrength=Ft(e.mainLight.environmentStrength,r.mainLight.environmentStrength,i),this._mainLight.specularStrength=Ft(e.mainLight.specularStrength,r.mainLight.specularStrength,i),le(this._mainLight.direction,r.mainLight.direction),this._mainLight.castShadows=r.mainLight.castShadows,this.globalFactor=Ft(e.globalFactor,r.globalFactor,i),this.noonFactor=Ft(e.noonFactor,r.noonFactor,i),e.sh.r.length===r.sh.r.length)for(let s=0;s<r.sh.r.length;s++)this._sphericalHarmonics.r[s]=Ft(e.sh.r[s],r.sh.r[s],i),this._sphericalHarmonics.g[s]=Ft(e.sh.g[s],r.sh.g[s],i),this._sphericalHarmonics.b[s]=Ft(e.sh.b[s],r.sh.b[s],i);else for(let s=0;s<r.sh.r.length;s++)this._sphericalHarmonics.r[s]=r.sh.r[s],this._sphericalHarmonics.g[s]=r.sh.g[s],this._sphericalHarmonics.b[s]=r.sh.b[s]}};const OI=M();let h6=class{constructor(e,r,i){this.shadowMap=e,this.ssaoHelper=r,this.slicePlane=i,this.slot=Se.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=Tt.NONE,this._camera=new At,this._inverseViewport=Ke(),this.oldLighting=new s9,this.newLighting=new s9,this._fadedLighting=new s9,this._lighting=this.newLighting,this.ssr=new $Ke,this.multipassTerrain=new PKe,this.multipassGeometry=new MKe,this.overlays=[],this.cloudsFade=new mKe}get camera(){return this._camera}set camera(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:r,newLighting:i}=this;e>=1?this._lighting=i:(this._fadedLighting.lerpLighting(r,i,e),this._lighting=this._fadedLighting)}},Al=class extends Te{constructor(e){super(e),this._handles=new Zr,this._techniques=new Array,this._techniqueConfiguration=new zD,this._bindParameters=new h6(null,null,null),this._passParameters=new Iwe,this._drawParameters=new $we,this._weatherTile=Ke(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=Ft(ha.default.coverage[0],ha.default.coverage[1],.5),this.density=Ft(ha.default.density[0],ha.default.density[1],.5),this.absorption=Ft(ha.default.absorption[0],ha.default.absorption[1],.5),this.cloudSize=Ft(ha.default.cloudSize[0],ha.default.cloudSize[1],.5),this.detailSize=Ft(ha.default.detailSize[0],ha.default.detailSize[1],.5),this.smoothness=Ft(ha.default.smoothness[0],ha.default.smoothness[1],.5),this.cloudHeight=Ft(ha.default.cloudHeight[0],ha.default.cloudHeight[1],.5),this.raymarchingSteps=ha.default.raymarchingSteps,this._viewMatrix=Ie(),this._dirty=!1,this.running=!1}_getTechnique(e){const r=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=r===Gw.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=r,this._techniqueConfiguration.steps=e,this._techniques[i]=new Lwe({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,r=this.view.camera.position.longitude;if(e==null||r==null)return;ar(this._weatherTile,(e+90)/180,(r+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let s=0,n=0;if(v(this.view.environment)&&this.view.environment.lighting.type!=="virtual"&&v(this.view.environment.lighting.date)){const o=new Date(this.view.environment.lighting.date);o.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),s=31*o.getUTCMonth()+o.getUTCDate(),n=o.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+s)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+n%100)%(4*this._weatherTileCount),nwe(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){this._vao=Ia(this.context.renderContext.rctx);const e=Yr(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(yt.CLOUDS_GENERATOR,this),ne(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),kt)])}destroy(){this._handles.destroy(),this._techniques.forEach(e=>ji(e)),this._frameBufferCube=et(this._frameBufferCube),this._techniques.length=0,this._vao=et(this._vao),this._passParameters.noiseTexture=Ve(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case Bl.SIXTEEN:return 1;case Bl.HUNDRED:return 4;case Bl.COUNT:case Bl.TWOHUNDRED:return 8}}_ensureNoiseTexture(){if(v(this._passParameters.noiseTexture))this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new NR({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return v(this._passParameters.noiseTexture.textureAtlas)}_ensureFrameBufferCube(e){if(C(this._frameBufferCube)){const r={target:wt.TEXTURE_CUBE_MAP,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,hasMipmap:!1,width:e,height:e};this._frameBufferCube=new Ns(this.context.renderContext.rctx,{colorTarget:us.CUBEMAP,width:e,height:e},r)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=et(this._frameBufferCube)}applyPreset(e,r){const i=e.median,s=n=>{const o=Ft(n[0],n[1],i);return r<.5?Ft(n[0],o,2*r):Ft(o,n[1],2*(r-.5))};this.coverage=s(e.coverage),this.density=s(e.density),this.absorption=s(e.absorption),this.cloudSize=s(e.cloudSize),this.detailSize=s(e.detailSize),this.smoothness=s(e.smoothness),this.cloudHeight=s(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){if(C(this._vao))return this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Is.FINISHED_RENDERING,void e.madeProgress();this._faceIndex===0&&this._tileIndex===0&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),zn(this._passParameters.weatherTile,this._weatherTile));const r=this._getTechnique(this._passParameters.raymarchingSteps);if(!r.compiled||!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return ea.YIELD;this._faceIndex===0&&this._tileIndex===0&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Is.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=this.context.renderContext.rctx,s=i.bindTechnique(r,this._passParameters,this._bindParameters);i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const n=i.getViewport(),o=r.configuration.cubeMapSize,a=o/this._tilesPerFace,l=this._tileIndex*a;i.setViewport(0,l,o,a);const c=this._ensureFrameBufferCube(o);i.bindFramebuffer(c);const h=XKe[this._faceIndex],p=YKe[this._faceIndex];Mfe(this._viewMatrix,ZKe,h,p),Jh(this._drawParameters.viewMatrix,this._viewMatrix);const f=wt.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return c.setColorTextureTarget(f),s.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.gl.flush(),i.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Is.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),ea.YIELD}};u([d({constructOnly:!0})],Al.prototype,"context",void 0),u([d({constructOnly:!0})],Al.prototype,"view",void 0),u([d({constructOnly:!0})],Al.prototype,"requestRender",void 0),u([d()],Al.prototype,"coverage",void 0),u([d()],Al.prototype,"density",void 0),u([d()],Al.prototype,"absorption",void 0),u([d()],Al.prototype,"cloudSize",void 0),u([d()],Al.prototype,"detailSize",void 0),u([d()],Al.prototype,"smoothness",void 0),u([d()],Al.prototype,"cloudHeight",void 0),u([d()],Al.prototype,"raymarchingSteps",void 0),u([d()],Al.prototype,"running",void 0),Al=u([P("esri.views.3d.environment.CloudsGenerator")],Al);const XKe=[Xr(1,0,0),Xr(-1,0,0),Xr(0,1,0),Xr(0,-1,0),Xr(0,0,1)],YKe=[Xr(0,1,0),Xr(0,1,0),Xr(0,0,-1),Xr(0,0,1),Xr(0,1,0)],ZKe=bY();let WZ=class extends pi{constructor(){super(...arguments),this.fogColor=M(),this.hazeColor=M(),this.fogStrength=4e-6,this.hazeStrength=4e-6,this.atmosphereC=1,this.fogAmount=0,this.hazeAmount=0}};function JKe(t){const e=new Lr;e.attributes.add(A.POSITION,"vec2"),e.include(tm,{textureCoordinateType:Xs.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:r,fragment:i}=e;return r.uniforms.add([new qi("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new qi("inverseViewMatrix",(s,n)=>BE(KKe,n.camera.viewMatrix))]),r.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.uniforms.add(new Pe("atmosphereC",s=>s.atmosphereC)),i.uniforms.add(new Wt("cameraPosition",(s,n)=>n.camera.eye)),i.uniforms.add(new Ur("nearFar",(s,n)=>n.camera.nearFar)),i.uniforms.add(new Pt("depthTex",s=>s.depthTexture)),i.uniforms.add(new Pe("fogStrength",s=>t.haze?s.hazeStrength:s.fogStrength)),i.uniforms.add(new Pe("fogAmount",s=>t.haze?s.hazeAmount:s.fogAmount)),i.uniforms.add(new Wt("fogColor",s=>t.haze?s.hazeColor:s.fogColor)),e.include(l6),i.include(ku),i.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.code.add(w`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),i.code.add(w`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${t.haze?w`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),e}const KKe=Ie(),jwe=Object.freeze(Object.defineProperty({__proto__:null,FogHazePassParameters:WZ,build:JKe},Symbol.toStringTag,{value:"Module"}));let Hwe=class qwe extends kr{initializeProgram(e){return new Nr(e.rctx,qwe.shader.get().build(this.configuration),Ar)}initializePipeline(){return this.configuration.haze?zt({blending:Bn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Qt}):zt({blending:Bn(Ee.SRC_ALPHA,Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE),colorWrite:Qt})}};Hwe.shader=new Dr(jwe,()=>ie(()=>import("./FogHaze.glsl-0e6b71bf.js"),[],import.meta.url));let XZ=class extends Pa{constructor(){super(...arguments),this.haze=!1}};u([k()],XZ.prototype,"haze",void 0);const QKe=.95,eQe=1;let FR=class extends Te{constructor(e){super(e),this._passParameters=new WZ;const r=e.context.renderContext.rctx;this._vao=Ia(r,lC),this._technique=e.context.techniqueRepository.acquire(Hwe,new XZ);const i=Yr(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+D3}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,r){if(this._update(e,r),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const n=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderFog(n,e)})}_renderFog(e,r){const i=r.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays($t.TRIANGLE_STRIP,0,4)}_update(e,r){const i=e.bindParameters.camera;ve(ene,i.eye);const s=Math.max(0,_e(ene,e.bindParameters.lighting.mainLight.direction)),n=r.color;ae(tne,n,.1),Qs(this._passParameters.fogColor,tne,n,s);const o=Me(i.eye),a=o*o;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-WS(QKe*Sh,eQe*Sh,Math.abs(o-this._planetRadius)))*r.amount,this._passParameters.fogStrength=r.strength}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],FR.prototype,"context",void 0),u([d({constructOnly:!0})],FR.prototype,"view",void 0),FR=u([P("esri.views.3d.environment.Fog")],FR);let tQe=class{constructor(){this.color=M(),this.strength=0,this.amount=0}};const ene=M(),tne=M();let io=class extends Pa{constructor(){super(...arguments),this.hasWebGL2Context=!1}};u([k({constValue:!0})],io.prototype,"hasSliceHighlight",void 0),u([k({constValue:!1})],io.prototype,"hasSliceInVertexProgram",void 0),u([k({constValue:!1})],io.prototype,"instancedDoublePrecision",void 0),u([k({constValue:!1})],io.prototype,"useLegacyTerrainShading",void 0),u([k({constValue:!1})],io.prototype,"hasModelTransformation",void 0),u([k({constValue:di.Pass})],io.prototype,"pbrTextureBindType",void 0),u([k()],io.prototype,"hasWebGL2Context",void 0);var ym;(function(t){t[t.Cone=0]="Cone",t[t.Cylinder=1]="Cylinder",t[t.Underground=2]="Underground",t[t.COUNT=3]="COUNT"})(ym||(ym={}));let YZ=class extends io{constructor(){super(...arguments),this.geometry=ym.Cone}};u([k({count:ym.COUNT})],YZ.prototype,"geometry",void 0);var V;(function(t){t[t.Color=0]="Color",t[t.Depth=1]="Depth",t[t.Normal=2]="Normal",t[t.Shadow=3]="Shadow",t[t.ShadowHighlight=4]="ShadowHighlight",t[t.ShadowExcludeHighlight=5]="ShadowExcludeHighlight",t[t.Highlight=6]="Highlight",t[t.Alpha=7]="Alpha",t[t.ObjectAndLayerIdColor=8]="ObjectAndLayerIdColor",t[t.COUNT=9]="COUNT"})(V||(V={}));function eP(t){t.attributes.add(A.POSITION,"vec3"),t.vertex.code.add(w`vec3 positionModel() { return position; }`)}function ZF({code:t},e){e.doublePrecisionRequiresObfuscation?t.add(w`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):t.add(w`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}let Rm=class extends ws{constructor(e,r){super(e,"mat3",di.Pass,(i,s,n)=>i.setUniformMatrix3fv(e,r(s,n)))}};function wS(t,e){t.include(eP);const r=t.vertex;r.include(ZF,e),t.varyings.add("vPositionWorldCameraRelative","vec3"),t.varyings.add("vPosition_view","vec3"),r.uniforms.add([new Wt("transformWorldFromViewTH",i=>i.transformWorldFromViewTH),new Wt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL),new Rm("transformViewFromCameraRelativeRS",i=>i.transformViewFromCameraRelativeRS),new qi("transformProjFromView",i=>i.transformProjFromView),new F3("transformWorldFromModelRS",i=>i.transformWorldFromModelRS),new Lu("transformWorldFromModelTH",i=>i.transformWorldFromModelTH),new Lu("transformWorldFromModelTL",i=>i.transformWorldFromModelTL)]),r.code.add(w`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),r.code.add(w`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${e.spherical?w`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:w`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),t.fragment.uniforms.add(new Wt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL)),r.code.add(w`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),t.fragment.code.add(w`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}let Wwe=class extends pi{constructor(){super(...arguments),this.transformWorldFromViewTH=M(),this.transformWorldFromViewTL=M(),this.transformViewFromCameraRelativeRS=rs(),this.transformProjFromView=Ie()}},Xwe=class extends pi{constructor(){super(...arguments),this.transformWorldFromModelRS=rs(),this.transformWorldFromModelTH=Gi(),this.transformWorldFromModelTL=Gi()}};function hv(t){t.varyings.add("linearDepth","float")}function jw(t){t.vertex.uniforms.add(new Ur("nearFar",(e,r)=>r.camera.nearFar))}function d6(t){t.vertex.code.add(w`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function cC(t,e){const{vertex:r}=t;switch(e.output){case V.Color:if(e.receiveShadows)return hv(t),void r.code.add(w`void forwardLinearDepth() { linearDepth = gl_Position.w; }`);break;case V.Depth:case V.Shadow:case V.ShadowHighlight:case V.ShadowExcludeHighlight:return t.include(wS,e),hv(t),jw(t),d6(t),void r.code.add(w`void forwardLinearDepth() {
linearDepth = calculateLinearDepth(nearFar, vPosition_view.z);
}`)}r.code.add(w`void forwardLinearDepth() {}`)}function Gl(t,e){if(d6(t),e.hasModelTransformation)return t.vertex.code.add(w`vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * (model * vec4(pos, 1.0));
depth = calculateLinearDepth(nearFar, eye.z);
return proj * eye;
}`),void t.vertex.code.add(w`vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {
return proj * (view * (model * vec4(pos, 1.0)));
}`);t.vertex.code.add(w`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),t.vertex.code.add(w`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}let ZZ=class extends pi{constructor(){super(...arguments),this.texV=Ke(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new Ywe}},Ywe=class{constructor(){this.center=M(),this.v1=M(),this.v2=M()}};function rQe(t){const e=new Lr,{vertex:r,fragment:i}=e;if(by(r),t.geometry===ym.Underground)e.attributes.add(A.POSITION,"vec2"),e.varyings.add("color","vec4"),r.uniforms.add([new Wt("cameraPosition",(s,n)=>n.camera.eye),new Pe("undergroundFadeAlpha",s=>s.undergroundFadeAlpha)]),r.code.add(w`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),i.code.add(w`void main() {
gl_FragColor = color;
}`);else{e.include(Gl,t),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const s=t.geometry===ym.Cylinder;r.uniforms.add([new qi("proj",(a,l)=>l.camera.projectionMatrix),new qi("view",(a,l)=>l.camera.viewMatrix)]),s||(e.varyings.add("innerFactor","float"),r.uniforms.add(new Wt("silCircleCenter",a=>a.silhouette.center)),r.uniforms.add(new Wt("silCircleV1",a=>a.silhouette.v1)),r.uniforms.add(new Wt("silCircleV2",a=>a.silhouette.v2)),r.uniforms.add(new Ur("texV",a=>a.texV)),r.uniforms.add(new Pe("innerScale",a=>a.innerScale)));const n=6.2831853,o=1/128;r.code.add(w`
		void main(void) {
      ${s?w`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:w`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${w.float(n*o)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${w.float(o)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),i.uniforms.add(new Pt("tex",a=>a.texture)),s||i.uniforms.add(new Pe("altitudeFade",a=>a.altitudeFade)),i.code.add(w`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${s?w`gl_FragColor = atmosphereColor;`:w`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const iQe=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:Ywe,SimpleAtmospherePassParameters:ZZ,build:rQe},Symbol.toStringTag,{value:"Module"}));let JF=class Zwe extends kr{initializeProgram(e){return new Nr(e.rctx,Zwe.shader.get().build(this.configuration),Ar)}initializePipeline(){return this.configuration.geometry===ym.Cylinder?zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),culling:FZ,depthTest:{func:$i.LEQUAL},colorWrite:Qt}):zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:$i.LEQUAL},colorWrite:Qt})}};JF.shader=new Dr(iQe,()=>ie(()=>import("./SimpleAtmosphere.glsl-aff64ec3.js"),[],import.meta.url));const Jwe=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);function Hc(t,e=0){const r=t.stride;return t.fieldNames.filter(i=>{const s=t.fields.get(i).optional;return!(s&&s.glPadding)}).map(i=>{const s=t.fields.get(i),n=s.constructor.ElementCount,o=sQe(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return new No(i,n,o,a,r,l,e)})}function sQe(t){const e=nQe[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const nQe={u8:lt.UNSIGNED_BYTE,u16:lt.UNSIGNED_SHORT,u32:lt.UNSIGNED_INT,i8:lt.BYTE,i16:lt.SHORT,i32:lt.INT,f32:lt.FLOAT};let JZ=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<9;s++)r[s]=this.typedBuffer[i++];return r}setMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[i++]=r[s]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}};JZ.ElementCount=9;let KZ=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<16;s++)r[s]=this.typedBuffer[i++];return r}setMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[i++]=r[s]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}};KZ.ElementCount=16;let Ty=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.stride=s,this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride)}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}get(e){return this.typedBuffer[e*this.typedBufferStride]}set(e,r){this.typedBuffer[e*this.typedBufferStride]=r}get buffer(){return this.typedBuffer.buffer}};Ty.ElementCount=1;let Sy=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,ar(r,this.typedBuffer[e],this.typedBuffer[e+1])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e]=r[1]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};Sy.ElementCount=2;let Ey=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,ce(r,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e++]=r[1],this.typedBuffer[e]=r[2]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i,s){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e]=s}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};Ey.ElementCount=3;let Cy=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.start=i,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,ti(r,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e++]=r[1],this.typedBuffer[e++]=r[2],this.typedBuffer[e]=r[3]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i,s,n){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e++]=s,this.typedBuffer[e]=n}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};Cy.ElementCount=4;let QZ=class Kwe extends Ty{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}static fromTypedArray(e,r){return new Kwe(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};QZ.ElementType="f32";let Ay=class zj extends Sy{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(zj,e,r)}static fromTypedArray(e,r){return new zj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Ay.ElementType="f32";let Ii=class Bj extends Ey{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(Bj,e,r)}static fromTypedArray(e,r){return new Bj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Ii.ElementType="f32";let zc=class Gj extends Cy{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(Gj,e,r)}static fromTypedArray(e,r){return new Gj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};zc.ElementType="f32";let dv=class jj extends JZ{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(jj,e,r)}static fromTypedArray(e,r){return new jj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};dv.ElementType="f32";let eJ=class Hj extends JZ{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(Hj,e,r)}static fromTypedArray(e,r){return new Hj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};eJ.ElementType="f64";let tJ=class qj extends KZ{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(qj,e,r)}static fromTypedArray(e,r){return new qj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};tJ.ElementType="f32";let U3=class Wj extends KZ{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(Wj,e,r)}static fromTypedArray(e,r){return new Wj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};U3.ElementType="f64";let rJ=class Xj extends Ty{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(Xj,e,r)}static fromTypedArray(e,r){return new Xj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};rJ.ElementType="f64";let iJ=class Yj extends Sy{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(Yj,e,r)}static fromTypedArray(e,r){return new Yj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};iJ.ElementType="f64";let Ca=class Zj extends Ey{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(Zj,e,r)}static fromTypedArray(e,r){return new Zj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Ca.ElementType="f64";let p6=class Jj extends Cy{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(Jj,e,r)}static fromTypedArray(e,r){return new Jj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};p6.ElementType="f64";let CE=class Kj extends Ty{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(Kj,e,r)}static fromTypedArray(e,r){return new Kj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};CE.ElementType="u8";let f6=class Qj extends Sy{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(Qj,e,r)}static fromTypedArray(e,r){return new Qj(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};f6.ElementType="u8";let V3=class eH extends Ey{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(eH,e,r)}static fromTypedArray(e,r){return new eH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};V3.ElementType="u8";let Aa=class tH extends Cy{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(tH,e,r)}static fromTypedArray(e,r){return new tH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Aa.ElementType="u8";let m6=class rH extends Ty{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(rH,e,r)}static fromTypedArray(e,r){return new rH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};m6.ElementType="u16";let sJ=class iH extends Sy{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(iH,e,r)}static fromTypedArray(e,r){return new iH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};sJ.ElementType="u16";let g6=class sH extends Ey{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(sH,e,r)}static fromTypedArray(e,r){return new sH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};g6.ElementType="u16";let tP=class nH extends Cy{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(nH,e,r)}static fromTypedArray(e,r){return new nH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};tP.ElementType="u16";let y6=class oH extends Ty{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(oH,e,r)}static fromTypedArray(e,r){return new oH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};y6.ElementType="u32";let nJ=class aH extends Sy{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(aH,e,r)}static fromTypedArray(e,r){return new aH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};nJ.ElementType="u32";let Qwe=class lH extends Ey{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(lH,e,r)}static fromTypedArray(e,r){return new lH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Qwe.ElementType="u32";let exe=class cH extends Cy{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(cH,e,r)}static fromTypedArray(e,r){return new cH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};exe.ElementType="u32";let oJ=class uH extends Ty{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(uH,e,r)}static fromTypedArray(e,r){return new uH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};oJ.ElementType="i8";let _6=class hH extends Sy{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(hH,e,r)}static fromTypedArray(e,r){return new hH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};_6.ElementType="i8";let txe=class dH extends Ey{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(dH,e,r)}static fromTypedArray(e,r){return new dH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};txe.ElementType="i8";let rxe=class pH extends Cy{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(pH,e,r)}static fromTypedArray(e,r){return new pH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};rxe.ElementType="i8";let ixe=class fH extends Ty{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(fH,e,r)}static fromTypedArray(e,r){return new fH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};ixe.ElementType="i16";let v6=class mH extends Sy{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(mH,e,r)}static fromTypedArray(e,r){return new mH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};v6.ElementType="i16";let sxe=class gH extends Ey{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(gH,e,r)}static fromTypedArray(e,r){return new gH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};sxe.ElementType="i16";let nxe=class yH extends Cy{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(yH,e,r)}static fromTypedArray(e,r){return new yH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};nxe.ElementType="i16";let oxe=class _H extends Ty{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(_H,e,r)}static fromTypedArray(e,r){return new _H(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};oxe.ElementType="i32";let axe=class vH extends Sy{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(vH,e,r)}static fromTypedArray(e,r){return new vH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};axe.ElementType="i32";let lxe=class bH extends Ey{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(bH,e,r)}static fromTypedArray(e,r){return new bH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};lxe.ElementType="i32";let cxe=class wH extends Cy{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(wH,e,r)}static fromTypedArray(e,r){return new wH(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};cxe.ElementType="i32";function uxe(t){switch(t){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8}}function oQe(t){switch(t){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f32":case"f64":return!0}}function aQe(t){switch(t){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f32":case"f64":return!1}}function lQe(t){switch(t){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f32":return 3402823e32;case"f64":return 179769e303}}let rne=class hxe{constructor(e,r){this.layout=e,this.buffer=typeof r=="number"?new ArrayBuffer(r*e.stride):r;for(const i of e.fieldNames){const s=e.fields.get(i);this[i]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,r){const i=this[e];return i&&i.elementCount===r.ElementCount&&i.elementType===r.ElementType?i:null}slice(e,r){return new hxe(this.layout,this.buffer.slice(e*this.stride,r*this.stride))}copyFrom(e,r,i,s){const n=this.stride;if(n%4==0){const o=new Uint32Array(e.buffer,r*n,s*n/4);new Uint32Array(this.buffer,i*n,s*n/4).set(o)}else{const o=new Uint8Array(e.buffer,r*n,s*n);new Uint8Array(this.buffer,i*n,s*n).set(o)}}},cQe=class dxe{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(e,r){return this._appendField(e,Ay,r),this}vec2f64(e,r){return this._appendField(e,iJ,r),this}vec3f(e,r){return this._appendField(e,Ii,r),this}vec3f64(e,r){return this._appendField(e,Ca,r),this}vec4f(e,r){return this._appendField(e,zc,r),this}vec4f64(e,r){return this._appendField(e,p6,r),this}mat3f(e,r){return this._appendField(e,dv,r),this}mat3f64(e,r){return this._appendField(e,eJ,r),this}mat4f(e,r){return this._appendField(e,tJ,r),this}mat4f64(e,r){return this._appendField(e,U3,r),this}vec4u8(e,r){return this._appendField(e,Aa,r),this}f32(e,r){return this._appendField(e,QZ,r),this}f64(e,r){return this._appendField(e,rJ,r),this}u8(e,r){return this._appendField(e,CE,r),this}u16(e,r){return this._appendField(e,m6,r),this}i8(e,r){return this._appendField(e,oJ,r),this}vec2i8(e,r){return this._appendField(e,_6,r),this}vec2i16(e,r){return this._appendField(e,v6,r),this}vec2u8(e,r){return this._appendField(e,f6,r),this}vec4u16(e,r){return this._appendField(e,tP,r),this}u32(e,r){return this._appendField(e,y6,r),this}_appendField(e,r,i){const s=r.ElementCount*uxe(r.ElementType),n=this.stride;this.fields.set(e,{size:s,constructor:r,offset:n,optional:i}),this.stride+=s,this.fieldNames.push(e)}alignTo(e){return this.stride=Math.floor((this.stride+e-1)/e)*e,this}hasField(e){return this.fieldNames.includes(e)}createBuffer(e){return new rne(this,e)}createView(e){return new rne(this,e)}clone(){const e=new dxe;return e.stride=this.stride,e.fields=new Map,this.fields.forEach((r,i)=>e.fields.set(i,r)),e.fieldNames=this.fieldNames.slice(),e.BufferType=this.BufferType,e}};function is(){return new cQe}let Ye=class{constructor(e,r,i=!1,s=r){this.data=e,this.size=r,this.exclusive=i,this.stride=s}};var xH;(function(t){function e(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function r(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function i(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}t.length=e,t.normalize=r,t.scale=i,t.add=s,t.subtract=n})(xH||(xH={}));var $s;(function(t){t[t.Layer=0]="Layer",t[t.Object=1]="Object",t[t.Mesh=2]="Mesh",t[t.Line=3]="Line",t[t.Point=4]="Point",t[t.Material=5]="Material",t[t.Texture=6]="Texture",t[t.COUNT=7]="COUNT"})($s||($s={}));function Bc(t,e=!1){return t<=nm?e?new Array(t).fill(0):new Array(t):new Float64Array(t)}function uQe(t){return length<=nm?Array.from(t):new Float64Array(t)}function zh(t,e,r){return Array.isArray(t)?t.slice(e,e+r):t.subarray(e,e+r)}function Ys(t,e=!1){return t<=nm?e?new Array(t).fill(0):new Array(t):new Float32Array(t)}function ine(t){return length<=nm?Array.from(t):new Float32Array(t)}function sne(t,e,r){return Array.isArray(t)?t.slice(e,e+r):t.subarray(e,e+r)}function hQe(t){if(t.length<nm)return Array.from(t);if(Array.isArray(t))return Float64Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return Uint16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}const Fa=nr();let dQe=class{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}};function gt(t,e){if(!t){e=e||"Assertion";const r=new Error(e).stack;throw new dQe(`${e} at ${r}`)}}function Px(t,e){t||(e=e||"",console.warn("Verify failed: "+e+`
`+new Error("verify").stack))}function nne(t,e,r,i){let s,n=(r[0]-t[0])/e[0],o=(i[0]-t[0])/e[0];n>o&&(s=n,n=o,o=s);let a=(r[1]-t[1])/e[1],l=(i[1]-t[1])/e[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(r[2]-t[2])/e[2],h=(i[2]-t[2])/e[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function MI(t,e,r,i,s,n=Ke()){const o=(i[s]-r[s])*(e[0]-t[0])-(i[0]-r[0])*(e[s]-t[s]),a=(i[0]-r[0])*(t[s]-r[s])-(i[s]-r[s])*(t[0]-r[0]);if(o===0)return!1;const l=a/o;return n[0]=t[0]+l*(e[0]-t[0]),n[1]=t[s]+l*(e[s]-t[s]),!0}function one(t,e,r,i,s){Fa[0]=t[0],Fa[1]=t[1],Fa[2]=t[2],Fa[3]=1,Ru(Fa,Fa,e),s.length>2&&(s[2]=-Fa[2]),Ru(Fa,Fa,r),gt(Fa[3]!==0),s[0]=Fa[0]/Fa[3],s[1]=Fa[1]/Fa[3],s[2]=Fa[2]/Fa[3],s[0]=(.5*s[0]+.5)*i[2]+i[0],s[1]=(.5*s[1]+.5)*i[3]+i[1]}function pQe(t,e){return Math.log(t)/Math.log(e)}function fQe(t,e,r,i){t[12]=e,t[13]=r,t[14]=i}function pxe(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[15]===1}let fxe=class mxe{constructor(e,r,i,s){this.primitiveIndices=e,this._numIndexPerPrimitive=r,this.indices=i,this.position=s,this._children=void 0,gt(e.length>=1),gt(i.length%this._numIndexPerPrimitive==0),gt(i.length>=e.length*this._numIndexPerPrimitive),gt(s.size===3||s.size===4);const{data:n,size:o}=s,a=e.length;let l=o*i[this._numIndexPerPrimitive*e[0]];Wv.clear(),Wv.push(l);const c=$e(n[l],n[l+1],n[l+2]),h=gs(c);for(let m=0;m<a;++m){const y=this._numIndexPerPrimitive*e[m];for(let _=0;_<this._numIndexPerPrimitive;++_){l=o*i[y+_],Wv.push(l);let b=n[l];c[0]=Math.min(b,c[0]),h[0]=Math.max(b,h[0]),b=n[l+1],c[1]=Math.min(b,c[1]),h[1]=Math.max(b,h[1]),b=n[l+2],c[2]=Math.min(b,c[2]),h[2]=Math.max(b,h[2])}}this.bbMin=c,this.bbMax=h;const p=Qs(M(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(h[0]-c[0],h[1]-c[1]),h[2]-c[2]);let f=this.radius*this.radius;for(let m=0;m<Wv.length;++m){l=Wv.getItemAt(m);const y=n[l]-p[0],_=n[l+1]-p[1],b=n[l+2]-p[2],x=y*y+_*_+b*b;if(x<=f)continue;const T=Math.sqrt(x),S=.5*(T-this.radius);this.radius=this.radius+S,f=this.radius*this.radius;const E=S/T;p[0]+=y*E,p[1]+=_*E,p[2]+=b*E}this.center=p,Wv.clear()}getChildren(){if(this._children||Vn(this.bbMin,this.bbMax)<=1)return this._children;const e=Qs(M(),this.bbMin,this.bbMax,.5),r=this.primitiveIndices.length,i=new Uint8Array(r),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<r;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],m=n[f],y=n[f+1],_=n[f+2];for(let b=1;b<this._numIndexPerPrimitive;++b){f=o*this.indices[p+b];const x=n[f],T=n[f+1],S=n[f+2];x<m&&(m=x),T<y&&(y=T),S<_&&(_=S)}m<e[0]&&(h|=1),y<e[1]&&(h|=2),_<e[2]&&(h|=4),i[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<r;++c){const h=i[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array;for(let c=0;c<8;++c)l[c]!==void 0&&this._children.push(new mxe(l[c],this._numIndexPerPrimitive,this.indices,this.position));return this._children}static prune(){Wv.prune()}};const Wv=new Kt({deallocator:null});let rP=class{constructor(){this.id=$c()}unload(){}};function mQe(t){return t?{p0:gs(t.p0),p1:gs(t.p1),p2:gs(t.p2)}:{p0:M(),p1:M(),p2:M()}}function ane(t,e,r){const i=e[0]-t[0],s=e[1]-t[1],n=r[0]-t[0],o=r[1]-t[1];return .5*Math.abs(i*o-s*n)}function gQe(t,e,r){return ge(n9,e,t),ge(lne,r,t),Me(pt(n9,n9,lne))/2}new yy(Rp);new yy(()=>mQe());const n9=M(),lne=M();function yQe(t,e,r){if(!t||!e)return!1;const{size:i,data:s}=t;ce(r,0,0,0),ce(wh,0,0,0);let n=0,o=0;for(let a=0;a<e.length-2;a+=3){const l=e[a+0]*i,c=e[a+1]*i,h=e[a+2]*i;ce(to,s[l+0],s[l+1],s[l+2]),ce(Fg,s[c+0],s[c+1],s[c+2]),ce(PI,s[h+0],s[h+1],s[h+2]);const p=gQe(to,Fg,PI);p?(me(to,to,Fg),me(to,to,PI),ae(to,to,1/3*p),me(r,r,to),n+=p):(me(wh,wh,to),me(wh,wh,Fg),me(wh,wh,PI),o+=3)}return(o!==0||n!==0)&&(n!==0?(ae(r,r,1/n),!0):o!==0&&(ae(r,wh,1/o),!0))}function _Qe(t,e,r){if(!t||!e)return!1;const{size:i,data:s}=t;ce(r,0,0,0);let n=-1,o=0;for(let a=0;a<e.length;a++){const l=e[a]*i;n!==l&&(r[0]+=s[l+0],r[1]+=s[l+1],r[2]+=s[l+2],o++),n=l}return o>1&&ae(r,r,1/o),o>0}function vQe(t,e,r,i){if(!t)return!1;ce(i,0,0,0),ce(wh,0,0,0);let s=0,n=0;const{size:o,data:a}=t,l=e?e.length-1:a.length/o-1,c=l+(r?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,m=(e?e[p]:p)*o,y=(e?e[f]:f)*o;to[0]=a[m],to[1]=a[m+1],to[2]=a[m+2],Fg[0]=a[y],Fg[1]=a[y+1],Fg[2]=a[y+2],ae(to,me(to,to,Fg),.5);const _=AM(to,Fg);_>0?(me(i,i,ae(to,to,_)),s+=_):s===0&&(me(wh,wh,to),n++)}return s!==0?(ae(i,i,1/s),!0):n!==0&&(ae(i,wh,1/n),!0)}const to=M(),Fg=M(),PI=M(),wh=M();function xS(t){if(Array.isArray(t)){if(t.length<nm)return t;for(const e of t)if(e>=65536)return new Uint32Array(t);return new Uint16Array(t)}if(t.length<nm)return Array.from(t);if(t.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return t;for(const e of t)if(e>=65536)return t;return new Uint16Array(t)}function gxe(t){const e=3*t;return e<=nm?new Array(e):e<=65536?new Uint16Array(e):new Uint32Array(e)}let c_=(()=>{const t=new Uint32Array(131072);for(let e=0;e<t.length;++e)t[e]=e;return t})();const yxe=[0],TS=(()=>{const t=new Uint16Array(65536);for(let e=0;e<t.length;++e)t[e]=e;return t})();function AE(t){if(t===1)return yxe;if(t<nm)return Array.from(new Uint16Array(TS.buffer,0,t));if(t<TS.length)return new Uint16Array(TS.buffer,0,t);if(t>c_.length){const e=Math.max(2*c_.length,t);c_=new Uint32Array(e);for(let r=0;r<c_.length;r++)c_[r]=r}return new Uint32Array(c_.buffer,0,t)}function cMt(t){if(t===1)return yxe;if(t<nm)return Array.from(new Uint16Array(TS.buffer,0,t));if(t<TS.length)return new Uint16Array(TS.slice(0,t));if(t>c_.length){const e=new Uint32Array(t);for(let r=0;r<e.length;r++)e[r]=r;return e}return new Uint32Array(c_.slice(0,t))}let KF=class{constructor(e){this.channel=e,this.id=$c()}};function TH(t,e,r){for(let i=0;i<r;++i)e[2*i]=t[i],e[2*i+1]=t[i]-e[2*i]}function bQe(t,e){const r=t.length;for(let i=0;i<r;++i)X2[0]=t[i],e[i]=X2[0];return e}function wQe(t,e){const r=t.length;for(let i=0;i<r;++i)X2[0]=t[i],X2[1]=t[i]-X2[0],e[i]=X2[1];return e}const X2=new Float32Array(2);function SH(t,e){return C(t)&&(t=[]),t.push(e),t}function EH(t,e){if(C(t))return null;const r=t.filter(i=>i!==e);return r.length===0?null:r}function xQe(t,e,r,i,s){II[0]=t.get(e,0),II[1]=t.get(e,1),II[2]=t.get(e,2),TH(II,Xv,3),r.set(s,0,Xv[0]),i.set(s,0,Xv[1]),r.set(s,1,Xv[2]),i.set(s,1,Xv[3]),r.set(s,2,Xv[4]),i.set(s,2,Xv[5])}const II=M(),Xv=new Float32Array(6);let ln=class _xe extends rP{constructor(e,r,i=[],s=null,n=$s.Mesh,o=null,a=-1){super(),this.material=e,this.mapPositions=s,this.type=n,this.objectAndLayerIdColor=o,this.edgeIndicesLength=a,this.visible=!0,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[l,c]of r)c&&this._vertexAttributes.set(l,{...c});if(i==null||i.length===0){const l=TQe(this._vertexAttributes),c=AE(l);this.edgeIndicesLength=this.edgeIndicesLength<0?l:this.edgeIndicesLength;for(const h of this._vertexAttributes.keys())this._indices.set(h,c)}else for(const[l,c]of i)c&&(this._indices.set(l,xS(c)),l===A.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(l).length:this.edgeIndicesLength))}instantiate(e={}){const r=new _xe(e.material||this.material,[],void 0,this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._vertexAttributes.forEach((i,s)=>{i.exclusive=!1,r._vertexAttributes.set(s,i)}),this._indices.forEach((i,s)=>r._indices.set(s,i)),r._boundingInfo=this._boundingInfo,r.transformation=e.transformation||this.transformation,r}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(e){let r=this._vertexAttributes.get(e);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:hQe(r.data)},this._vertexAttributes.set(e,r)),r}get indices(){return this._indices}get indexCount(){const e=this._indices.values().next().value;return e?e.length:0}get faceCount(){return this.indexCount/3}get boundingInfo(){return C(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===$s.Mesh?this._computeAttachmentOriginTriangles(e):this.type===$s.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(v(this._transformation)&&Xe(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const r=this.indices.get(A.POSITION),i=this.vertexAttributes.get(A.POSITION);return yQe(i,r,e)}_computeAttachmentOriginLines(e){const r=this.vertexAttributes.get(A.POSITION),i=this.indices.get(A.POSITION);return vQe(r,i,i&&SQe(this.material.parameters,r,i),e)}_computeAttachmentOriginPoints(e){const r=this.indices.get(A.POSITION),i=this.vertexAttributes.get(A.POSITION);return _Qe(i,r,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.indices.get(A.POSITION),r=this.vertexAttributes.get(A.POSITION);if(!e||e.length===0||!r)return null;const i=this.type===$s.Mesh?3:1;gt(e.length%i==0,"Indexing error: "+e.length+" not divisible by "+i);const s=AE(e.length/i);return new fxe(s,i,e,r)}get transformation(){return It(this._transformation,Uu)}set transformation(e){this._transformation=e&&e!==Uu?uE(e):null}get shaderTransformation(){return v(this._shaderTransformer)?this._shaderTransformer(this.transformation):this.transformation}get shaderTransformer(){return this._shaderTransformer}set shaderTransformer(e){this._shaderTransformer=e}get hasVolatileTransformation(){return v(this._shaderTransformer)}addHighlight(){const e=new KF(uy.Highlight);return this.highlights=SH(this.highlights,e),e}removeHighlight(e){this.highlights=EH(this.highlights,e)}};function TQe(t){const e=t.values().next().value;return e==null?0:e.data.length/e.size}function SQe(t,e,r){return!(!("isClosed"in t)||!t.isClosed)&&(r?r.length>2:e.data.length>6)}const Ix=xH,o9=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],EQe=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],CQe=[0,0,1,0,1,1,0,1],AQe=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],vxe=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)vxe[6*t+e]=t;const cb=new Array(36);for(let t=0;t<6;t++)cb[6*t+0]=0,cb[6*t+1]=1,cb[6*t+2]=2,cb[6*t+3]=2,cb[6*t+4]=3,cb[6*t+5]=0;function RQe(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(24);for(let i=0;i<8;i++)r[3*i]=o9[i][0]*e[0],r[3*i+1]=o9[i][1]*e[1],r[3*i+2]=o9[i][2]*e[2];return new ln(t,[[A.POSITION,new Ye(r,3,!0)],[A.NORMAL,new Ye(EQe,3)],[A.UV0,new Ye(CQe,2)]],[[A.POSITION,AQe],[A.NORMAL,vxe],[A.UV0,cb]])}const a9=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],OQe=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],MQe=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],PQe=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function IQe(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(18);for(let i=0;i<6;i++)r[3*i]=a9[i][0]*e[0],r[3*i+1]=a9[i][1]*e[1],r[3*i+2]=a9[i][2]*e[2];return new ln(t,[[A.POSITION,new Ye(r,3,!0)],[A.NORMAL,new Ye(OQe,3)]],[[A.POSITION,MQe],[A.NORMAL,PQe]])}const GD=Xr(-.5,0,-.5),jD=Xr(.5,0,-.5),HD=Xr(0,0,.5),qD=Xr(0,.5,0),$x=Gi(),Lx=Gi(),SS=Gi(),ES=Gi(),CS=Gi();ge($x,GD,qD),ge(Lx,GD,jD),pt(SS,$x,Lx),ve(SS,SS),ge($x,jD,qD),ge(Lx,jD,HD),pt(ES,$x,Lx),ve(ES,ES),ge($x,HD,qD),ge(Lx,HD,GD),pt(CS,$x,Lx),ve(CS,CS);const l9=[GD,jD,HD,qD],$Qe=[0,-1,0,SS[0],SS[1],SS[2],ES[0],ES[1],ES[2],CS[0],CS[1],CS[2]],LQe=[0,1,2,3,1,0,3,2,1,3,0,2],DQe=[0,0,0,1,1,1,2,2,2,3,3,3];function NQe(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(12);for(let i=0;i<4;i++)r[3*i]=l9[i][0]*e[0],r[3*i+1]=l9[i][1]*e[1],r[3*i+2]=l9[i][2]*e[2];return new ln(t,[[A.POSITION,new Ye(r,3,!0)],[A.NORMAL,new Ye($Qe,3)]],[[A.POSITION,LQe],[A.NORMAL,DQe]])}function hMt(t,e,r,i,s={uv:!0}){const n=-Math.PI,o=2*Math.PI,a=-Math.PI/2,l=Math.PI,c=Math.max(3,Math.floor(r)),h=Math.max(2,Math.floor(i)),p=(c+1)*(h+1),f=Ys(3*p),m=Ys(3*p),y=Ys(2*p),_=[];let b=0;for(let E=0;E<=h;E++){const O=[],R=E/h,L=a+R*l,I=Math.cos(L);for(let U=0;U<=c;U++){const z=U/c,B=n+z*o,G=Math.cos(B)*I,K=Math.sin(L),re=-Math.sin(B)*I;f[3*b]=G*e,f[3*b+1]=K*e,f[3*b+2]=re*e,m[3*b]=G,m[3*b+1]=K,m[3*b+2]=re,y[2*b]=z,y[2*b+1]=R,O.push(b),++b}_.push(O)}const x=new Array;for(let E=0;E<h;E++)for(let O=0;O<c;O++){const R=_[E][O],L=_[E][O+1],I=_[E+1][O+1],U=_[E+1][O];E===0?(x.push(R),x.push(I),x.push(U)):E===h-1?(x.push(R),x.push(L),x.push(I)):(x.push(R),x.push(L),x.push(I),x.push(I),x.push(U),x.push(R))}const T=[[A.POSITION,x],[A.NORMAL,x]],S=[[A.POSITION,new Ye(f,3,!0)],[A.NORMAL,new Ye(m,3,!0)]];return s.uv&&(S.push([A.UV0,new Ye(y,2,!0)]),T.push([A.UV0,x])),s.offset&&(T[0][0]=A.OFFSET,S[0][0]=A.OFFSET,T.push([A.POSITION,new Array(x.length).fill(0)]),S.push([A.POSITION,new Ye(Float64Array.from(s.offset),3,!0)])),new ln(t,S,T)}function FQe(t,e,r,i){const{vertexAttributes:s,indices:n}=bxe(e,r,i);return new ln(t,s,n)}function bxe(t,e,r){const i=t;let s,n;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const h=i*(1+Math.sqrt(5))/2;s=[-i,h,0,i,h,0,-i,-h,0,i,-h,0,0,-i,h,0,i,h,0,-i,-h,0,i,-h,h,0,-i,h,0,i,-h,0,-i,-h,0,i],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let h=0;h<s.length;h+=3)Ix.scale(s,h,t/Ix.length(s,h));let o={};function a(h,p){h>p&&([h,p]=[p,h]);const f=h.toString()+"."+p.toString();if(o[f])return o[f];let m=s.length;return s.length+=3,Ix.add(s,3*h,s,3*p,s,m),Ix.scale(s,m,t/Ix.length(s,m)),m/=3,o[f]=m,m}for(let h=0;h<e;h++){const p=n.length,f=new Array(4*p);for(let m=0;m<p;m+=3){const y=n[m],_=n[m+1],b=n[m+2],x=a(y,_),T=a(_,b),S=a(b,y),E=4*m;f[E]=y,f[E+1]=x,f[E+2]=S,f[E+3]=_,f[E+4]=T,f[E+5]=x,f[E+6]=b,f[E+7]=S,f[E+8]=T,f[E+9]=x,f[E+10]=T,f[E+11]=S}n=f,o={}}const l=ine(s);for(let h=0;h<l.length;h+=3)Ix.normalize(l,h);const c=[[A.POSITION,n],[A.NORMAL,n]];return{vertexAttributes:[[A.POSITION,new Ye(ine(s),3,!0)],[A.NORMAL,new Ye(l,3,!0)]],indices:c}}function CH(t,e,r,i,s,n,o,a,l=null){const c=r?[r[0],r[1],r[2]]:[0,0,0],h=e?[e[0],e[1],e[2]]:[0,0,1];o=o||[0,0];const p=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],f=v(s)&&s.length===2?s:[1,1],m=[[A.POSITION,new Ye(c,3,!0)],[A.NORMAL,new Ye(h,3,!0)],[A.UV0,new Ye(o,o.length)],[A.COLOR,new Ye(p,4,!0)],[A.SIZE,new Ye(f,2)]];if(n!=null){const y=[n[0],n[1],n[2],n[3]];m.push([A.AUXPOS1,new Ye(y,4)])}if(a!=null){const y=[a[0],a[1],a[2],a[3]];m.push([A.AUXPOS2,new Ye(y,4)])}return new ln(t,m,null,null,$s.Point,l)}const UQe=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function dMt(t,e=UQe){const r=new Array(12);for(let h=0;h<4;h++)for(let p=0;p<3;p++)r[3*h+p]=e[h][p];const i=[0,1,2,2,3,0],s=[0,0,1],n=[0,0,0,0,0,0],o=[0,0,1,0,1,1,0,1],a=[255,255,255,255],l=[[A.POSITION,i],[A.NORMAL,n],[A.UV0,i],[A.COLOR,n]],c=[[A.POSITION,new Ye(r,3,!0)],[A.NORMAL,new Ye(s,3,!0)],[A.UV0,new Ye(o,2,!0)],[A.COLOR,new Ye(a,4,!0)]];return new ln(t,c,l)}function cne(t,e,r,i,s,n=!0,o=!0){let a=0;const l=r,c=e;let h=Xr(0,a,0),p=Xr(0,a+c,0),f=Xr(0,-1,0),m=Xr(0,1,0);s&&(a=c,p=Xr(0,0,0),h=Xr(0,a,0),f=Xr(0,1,0),m=Xr(0,-1,0));const y=[p,h],_=[f,m],b=i+2,x=Math.sqrt(c*c+l*l);if(s)for(let I=i-1;I>=0;I--){const U=I*(2*Math.PI/i),z=Xr(Math.cos(U)*l,a,Math.sin(U)*l);y.push(z);const B=Xr(c*Math.cos(U)/x,-l/x,c*Math.sin(U)/x);_.push(B)}else for(let I=0;I<i;I++){const U=I*(2*Math.PI/i),z=Xr(Math.cos(U)*l,a,Math.sin(U)*l);y.push(z);const B=Xr(c*Math.cos(U)/x,l/x,c*Math.sin(U)/x);_.push(B)}const T=new Array,S=new Array;if(n){for(let I=3;I<y.length;I++)T.push(1),T.push(I-1),T.push(I),S.push(0),S.push(0),S.push(0);T.push(y.length-1),T.push(2),T.push(1),S.push(0),S.push(0),S.push(0)}if(o){for(let I=3;I<y.length;I++)T.push(I),T.push(I-1),T.push(0),S.push(I),S.push(I-1),S.push(1);T.push(0),T.push(2),T.push(y.length-1),S.push(1),S.push(2),S.push(_.length-1)}const E=Ys(3*b);for(let I=0;I<b;I++)E[3*I]=y[I][0],E[3*I+1]=y[I][1],E[3*I+2]=y[I][2];const O=Ys(3*b);for(let I=0;I<b;I++)O[3*I]=_[I][0],O[3*I+1]=_[I][1],O[3*I+2]=_[I][2];const R=[[A.POSITION,T],[A.NORMAL,S]],L=[[A.POSITION,new Ye(E,3,!0)],[A.NORMAL,new Ye(O,3,!0)]];return new ln(t,L,R)}function VQe(t,e,r,i,s,n,o){const a=s?mF(s):Xr(1,0,0),l=n?mF(n):Xr(0,0,0);o=o??!0;const c=Gi();ve(c,a);const h=Gi();ae(h,c,Math.abs(e));const p=Gi();ae(p,h,-.5),me(p,p,l);const f=Xr(0,1,0);Math.abs(1-_e(c,f))<.2&&ce(f,0,0,1);const m=Gi();pt(m,c,f),ve(m,m),pt(f,m,c);const y=2*i+(o?2:0),_=i+(o?2:0),b=Ys(3*y),x=Ys(3*_),T=Ys(2*y),S=new Array(3*i*(o?4:2)),E=new Array(3*i*(o?4:2));o&&(b[3*(y-2)+0]=p[0],b[3*(y-2)+1]=p[1],b[3*(y-2)+2]=p[2],T[2*(y-2)]=0,T[2*(y-2)+1]=0,b[3*(y-1)+0]=b[3*(y-2)+0]+h[0],b[3*(y-1)+1]=b[3*(y-2)+1]+h[1],b[3*(y-1)+2]=b[3*(y-2)+2]+h[2],T[2*(y-1)]=1,T[2*(y-1)+1]=1,x[3*(_-2)+0]=-c[0],x[3*(_-2)+1]=-c[1],x[3*(_-2)+2]=-c[2],x[3*(_-1)+0]=c[0],x[3*(_-1)+1]=c[1],x[3*(_-1)+2]=c[2]);const O=(B,G,K)=>{S[B]=G,E[B]=K};let R=0;const L=Gi(),I=Gi();for(let B=0;B<i;B++){const G=B*(2*Math.PI/i);ae(L,f,Math.sin(G)),ae(I,m,Math.cos(G)),me(L,L,I),x[3*B+0]=L[0],x[3*B+1]=L[1],x[3*B+2]=L[2],ae(L,L,r),me(L,L,p),b[3*B+0]=L[0],b[3*B+1]=L[1],b[3*B+2]=L[2],T[2*B+0]=B/i,T[2*B+1]=0,b[3*(B+i)+0]=b[3*B+0]+h[0],b[3*(B+i)+1]=b[3*B+1]+h[1],b[3*(B+i)+2]=b[3*B+2]+h[2],T[2*(B+i)+0]=B/i,T[2*B+1]=1;const K=(B+1)%i;O(R++,B,B),O(R++,B+i,B),O(R++,K,K),O(R++,K,K),O(R++,B+i,B),O(R++,K+i,K)}if(o){for(let B=0;B<i;B++){const G=(B+1)%i;O(R++,y-2,_-2),O(R++,B,_-2),O(R++,G,_-2)}for(let B=0;B<i;B++){const G=(B+1)%i;O(R++,B+i,_-1),O(R++,y-1,_-1),O(R++,G+i,_-1)}}const U=[[A.POSITION,S],[A.NORMAL,E],[A.UV0,S]],z=[[A.POSITION,new Ye(b,3,!0)],[A.NORMAL,new Ye(x,3,!0)],[A.UV0,new Ye(T,2,!0)]];return new ln(t,z,U)}function pMt(t,e,r,i,s,n,o=Xr(0,0,0)){const a=e.length,l=Ys(r.length*a*3+(6*i.length||0)),c=Ys(r.length*a*3+(i?6:0)),h=new Array,p=new Array;let f=0,m=0;const y=Gi(),_=Gi(),b=Gi(),x=Gi(),T=Gi(),S=Gi(),E=Gi(),O=M(),R=Gi(),L=Gi(),I=Gi(),U=Gi(),z=Gi(),B=Br();ce(R,0,1,0),ge(_,r[1],r[0]),ve(_,_),n?(me(O,r[0],o),ve(b,O)):ce(b,0,0,1),QF(_,b,R,R,T,b,une),le(x,b),le(U,T);for(let F=0;F<i.length;F++)ae(S,T,i[F][0]),ae(O,b,i[F][2]),me(S,S,O),me(S,S,r[0]),l[f++]=S[0],l[f++]=S[1],l[f++]=S[2];c[m++]=-_[0],c[m++]=-_[1],c[m++]=-_[2];for(let F=0;F<s.length;F++)h.push(s[F][0]>0?s[F][0]:-s[F][0]-1+i.length),h.push(s[F][1]>0?s[F][1]:-s[F][1]-1+i.length),h.push(s[F][2]>0?s[F][2]:-s[F][2]-1+i.length),p.push(0),p.push(0),p.push(0);let G=i.length;const K=i.length-1;for(let F=0;F<r.length;F++){let H=!1;F>0&&(le(y,_),F<r.length-1?(ge(_,r[F+1],r[F]),ve(_,_)):H=!0,me(L,y,_),ve(L,L),me(I,r[F-1],x),UM(r[F],L,B),ax(B,Vu(I,y),O)?(ge(O,O,r[F]),ve(b,O),pt(T,L,b),ve(T,T)):QF(L,x,U,R,T,b,une),le(x,b),le(U,T)),n&&(me(O,r[F],o),ve(z,O));for(let X=0;X<a;X++)if(ae(S,T,e[X][0]),ae(O,b,e[X][1]),me(S,S,O),ve(E,S),c[m++]=E[0],c[m++]=E[1],c[m++]=E[2],me(S,S,r[F]),l[f++]=S[0],l[f++]=S[1],l[f++]=S[2],!H){const J=(X+1)%a;h.push(G+X),h.push(G+a+X),h.push(G+J),h.push(G+J),h.push(G+a+X),h.push(G+a+J);for(let W=0;W<6;W++){const ue=h.length-6;p.push(h[ue+W]-K)}}G+=a}const re=r[r.length-1];for(let F=0;F<i.length;F++)ae(S,T,i[F][0]),ae(O,b,i[F][1]),me(S,S,O),me(S,S,re),l[f++]=S[0],l[f++]=S[1],l[f++]=S[2];const ee=m/3;c[m++]=_[0],c[m++]=_[1],c[m++]=_[2];const q=G-a;for(let F=0;F<s.length;F++)h.push(s[F][0]>=0?G+s[F][0]:-s[F][0]-1+q),h.push(s[F][2]>=0?G+s[F][2]:-s[F][2]-1+q),h.push(s[F][1]>=0?G+s[F][1]:-s[F][1]-1+q),p.push(ee),p.push(ee),p.push(ee);const $=[[A.POSITION,h],[A.NORMAL,p]],N=[[A.POSITION,new Ye(l,3,!0)],[A.NORMAL,new Ye(c,3,!0)]];return new ln(t,N,$)}function fMt(t,e,r,i){gt(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),gt(e[0].length===3,"createPolylineGeometry(): malformed vertex"),gt(r==null||r.length===e.length,"createPolylineGeometry: need same number of points and normals"),gt(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");const s=Bc(3*e.length),n=new Array(2*(e.length-1));let o=0,a=0;for(let h=0;h<e.length;h++){for(let p=0;p<3;p++)s[o++]=e[h][p];h>0&&(n[a++]=h-1,n[a++]=h)}const l=[],c=[];if(l.push([A.POSITION,n]),c.push([A.POSITION,new Ye(s,3,!0)]),r){const h=Ys(3*r.length);let p=0;for(let f=0;f<e.length;f++)for(let m=0;m<3;m++)h[p++]=r[f][m];l.push([A.NORMAL,n]),c.push([A.NORMAL,new Ye(h,3,!0)])}return i&&(c.push([A.COLOR,new Ye(i,4)]),l.push([A.COLOR,AE(i.length/4)])),new ln(t,c,l,null,$s.Line)}function kQe(t,e=t){const r=t.vertexAttributes,i=r.get(A.POSITION).data,s=r.get(A.NORMAL).data;if(s){const n=e.getMutableAttribute(A.NORMAL).data;for(let o=0;o<s.length;o+=3){const a=s[o+1];n[o+1]=-s[o+2],n[o+2]=a}}if(i){const n=e.getMutableAttribute(A.POSITION).data;for(let o=0;o<i.length;o+=3){const a=i[o+1];n[o+1]=-i[o+2],n[o+2]=a}}}function c9(t,e,r,i,s){return!(Math.abs(_e(e,t))>s)&&(pt(r,t,e),ve(r,r),pt(i,r,t),ve(i,i),!0)}function QF(t,e,r,i,s,n,o){return c9(t,e,s,n,o)||c9(t,r,s,n,o)||c9(t,i,s,n,o)}const une=.99619469809;let zQe=class{constructor(e,r){this.type=Mn.Panoramic,this._configuration=new YZ,this._passParameters=new ZZ,this._configuration.geometry=ym.Cylinder,this._technique=r.techniqueRepository.acquire(JF,this._configuration);const i=r.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=Ko(this._vao,"geometry"),this._passParameters.texture=new ct(i,{pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0,width:1,height:512},Jwe)}destroy(){this._passParameters.texture=et(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const r=e.rctx,i=r.bindTechnique(this._technique,this._passParameters,e.bindParameters);BQe(hne,e.bindParameters.camera.viewMatrix),i.setUniformMatrix4fv("view",hne),r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays($t.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const r=bxe(1,2,!1),i=r.indices[0][1],s=r.vertexAttributes[0][1];for(let l=0;l<i.length;l+=3){const c=i[l];i[l]=i[l+2],i[l+2]=c}const n=s.data,o=dne.createBuffer(i.length),a=o.position;for(let l=0;l<i.length;++l){const c=3*i[l];a.set(l,0,n[c]),a.set(l,1,n[c+1]),a.set(l,2,n[c+2])}return new Pp(e,Ar,{geometry:Hc(dne)},{geometry:jr.createVertex(e,$r.STATIC_DRAW,o.buffer)})}};function BQe(t,e){kn(t,e),t[12]=0,t[13]=0,t[14]=0,t[15]=1}const hne=Ie(),dne=is().vec3f(A.POSITION);var hy;(function(t){t[t.Rain=0]="Rain",t[t.Snow=1]="Snow",t[t.COUNT=2]="COUNT"})(hy||(hy={}));let AH=class extends Pa{constructor(){super(...arguments),this.type=hy.Rain}};u([k({count:hy.COUNT})],AH.prototype,"type",void 0);function GQe(t){const e=new Lr;return e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new Wt("cameraPosition",(r,i)=>i.camera.eye)),e.vertex.uniforms.add(new Wt("offset",(r,i)=>jQe(r,i))),e.vertex.uniforms.add(new Pe("width",r=>r.width)),e.vertex.uniforms.add(new qi("proj",(r,i)=>i.camera.projectionMatrix)),e.vertex.uniforms.add(new qi("view",(r,i)=>i.camera.viewMatrix)),e.vertex.uniforms.add(new Pe("time",r=>r.time)),e.varyings.add("vUv","vec2"),e.vertex.code.add(w`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${t.type===hy.Rain?w`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:w`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),e.fragment.uniforms.add([new Pe("opacity",r=>r.opacity),new Wt("particleColor",(r,i)=>HQe(i,t))]),e.fragment.code.add(w`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${t.type===hy.Rain?w`d = 0.35 * smoothstep(0.5, 0.0, d);`:w`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),e}function jQe(t,e){const r=e.camera.eye,i=.5*t.width,s=1/t.width,n=zpe(RH,ce(RH,(r[0]+i)*s,(r[1]+i)*s,(r[2]+i)*s));return so(n,r,ae(n,n,t.width))}function HQe(t,e){const r=e.type===hy.Rain?WQe:qQe,i=ae(RH,r,XQe),s=t.camera.eye;ve(pne,s);const n=Math.max(0,_e(pne,t.lighting.mainLight.direction));return Qs(i,i,r,n)}const RH=M(),pne=M(),qQe=$e(1,1,1),WQe=$e(.85,.85,.85),XQe=.7,YQe=Object.freeze(Object.defineProperty({__proto__:null,build:GQe},Symbol.toStringTag,{value:"Module"}));let ZQe=class extends pi{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}},OH=class wxe extends kr{initializeProgram(e){return new Nr(e.rctx,wxe.shader.get().build(this.configuration),WD)}initializePipeline(){return zt({blending:Bn(Ee.ONE,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:$i.LEQUAL},colorWrite:Qt})}};OH.shader=new Dr(YQe,()=>ie(()=>import("./Precipitation.glsl-665c03a8.js"),[],import.meta.url));const WD=new Map([[A.POSITION,0],[A.INSTANCEFEATUREATTRIBUTE,1]]);let xxe=class{constructor(){this.enabled=!0,this._time=0}get time(){return this._time}advance({deltaTime:e,fixedTime:r}){return v(r)?this._time!==r&&(this._time=r,!0):(this._time=this._time+e,e!==0)}},JQe=class{constructor(e,r){this.deltaTime=e,this.fixedTime=r}},ub=class extends Te{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new ZQe,this._animation=new xxe,this._updatingTracking=new em,this._passParameters.time=0,this._passParameters.radius=Yr(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=ji(this._snowTechniqueCached),this._rainTechniqueCached=ji(this._rainTechniqueCached),this._vao=et(this._vao),this._instanceIdBuffer=et(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(C(this._rainTechniqueCached)){const e=new AH;e.type=hy.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(OH,e)}return this._rainTechniqueCached}get _snowTechnique(){if(C(this._snowTechniqueCached)){const e=new AH;e.type=hy.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(OH,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,r,i){var l;const s=i==="rainy"?this._rainTechnique:this._snowTechnique;if(!s.compiled)return void this.context.requestRender();const n=e.rctx;if(this._ensureResources(n),C(s)||C(this._vao)||C(this._instanceIdBuffer)||(v(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0))return;const o=.35;r=r<.5?Ft(0,o,2*r):Ft(o,1,2*(r-.5)),this._passParameters.time=(i==="rainy"?this._rainSpeed:this._snowSpeed)*bW(this._animation.time)%1e5;const a=n.bindTechnique(s,this._passParameters,e.bindParameters);n.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),VZ(n,WD,this._instanceIdBuffer,fne,0),(l=n.capabilities.instancing)==null||l.drawArraysInstanced($t.TRIANGLES,0,3,this._numParticles*r),kZ(n,WD,this._instanceIdBuffer,fne)}_ensureResources(e){C(this._vao)&&(this._vao=this._createVertexArrayObject(e)),C(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const r=[];for(let i=0;i<this._numParticles;i++)r.push(i);return jr.createVertex(e,$r.STATIC_DRAW,new Float32Array(r))}_createVertexArrayObject(e){const r=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Pp(e,WD,{geometry:Hc(KQe)},{geometry:jr.createVertex(e,$r.STATIC_DRAW,r)})}};u([d({constructOnly:!0})],ub.prototype,"context",void 0),u([d({constructOnly:!0})],ub.prototype,"view",void 0),u([d({readOnly:!0})],ub.prototype,"updating",null),u([d()],ub.prototype,"_updatingTracking",void 0),ub=u([P("esri.views.3d.environment.Precipitation")],ub);const KQe=is().vec3f(A.POSITION),fne=Hc(is().f32(A.INSTANCEFEATUREATTRIBUTE),1),QQe=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),$I=128,mne=-Pj,gne=0,u9=50,eet=()=>1-511/512,tet=$L([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let ret=class{constructor(e,r){this.view=e,this.type=Mn.Simple,this._passParameters=new ZZ,this._vaoCount=0,this._texV1=1,this._isMars=wm(e.spatialReference);const i=Yr(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+mne)/this._planetRadius,this._middleRimFactor=(this._planetRadius+gne)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=gne/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=r.techniqueRepository;const s=r.renderContext.rctx;this._cameraChangeHandle=ne(()=>{var a;return(a=this.view.state)==null?void 0:a.camera},()=>r.requestRender(),qs),this._vao=this._createRibbon(s),this._vaoCount=Ko(this._vao,"geometry"),this._fadeVao=Ia(s),this._fadeVaoCount=Ko(this._fadeVao,"geometry");const n=this._isMars?QQe:Jwe;this._passParameters.texture=new ct(s,{pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0,width:1,height:512},n);const o=new YZ;o.geometry=ym.Cone,this._coneTechnique=this._techniqueRepository.acquire(JF,o),o.geometry=ym.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(JF,o)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=et(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const r=e.bindParameters.camera;this._update(r);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._vao),i.drawArrays($t.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._fadeVao),i.drawArrays($t.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const r=M(),i=this._planetRadius,s=Me(e.eye),n=s-i;if(n<0){const m=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=m}else this._passParameters.undergroundFadeAlpha=0;const o=Math.max(u9,n),a=i+mne;this._passParameters.innerScale=iet(i+o,i,a)-1,this._passParameters.altitudeFade=DZ(n),ae(r,e.eye,(i+u9)/s),yne(r,e.center,e.up,i,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,r,e.up,this._passParameters.silhouette),c=eet(),h=tet(n);let p=this._texV0+c*this._texVScale,f=this._texV0+l*h*this._texVScale;if(n>u9){yne(e.eye,e.center,e.up,i,this._passParameters.silhouette);const m=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),y=ye((m-1.5)/(l-1.5),0,1);p=this._texV0+y*c*this._texVScale,f=this._texV0+Ft(this._texV1,l*h,y)*this._texVScale}ar(this._passParameters.texV,p,f)}_createRibbon(e){const r=Ys(3+3*$I*3),i=new Uint32Array(3*$I*5);r[0]=0,r[1]=0,r[2]=-1;for(let o=0;o<$I;o++){const a=9*o+3;r[a+0]=o,r[a+1]=this._innerRimFactor,r[a+2]=-1,r[a+3]=o,r[a+4]=this._middleRimFactor,r[a+5]=0,r[a+6]=o,r[a+7]=this._outerRimFactor,r[a+8]=1;const l=3*o+1,c=o===$I-1?1:l+3,h=15*o;i[h+0]=l,i[h+1]=l+1,i[h+2]=c+1,i[h+3]=c+1,i[h+4]=c,i[h+5]=l,i[h+6]=l+1,i[h+7]=l+2,i[h+8]=c+2,i[h+9]=c+2,i[h+10]=c+1,i[h+11]=l+1,i[h+12]=l,i[h+13]=c,i[h+14]=0}const s=_ne.createBuffer(i.length),n=s.position;for(let o=0;o<i.length;++o){const a=3*i[o];n.set(o,0,r[a]),n.set(o,1,r[a+1]),n.set(o,2,r[a+2])}return new Pp(e,Ar,{geometry:Hc(_ne)},{geometry:jr.createVertex(e,$r.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(e,r,i,s){return me(Dx,s.center,s.v2),ae(LI,Dx,this._outerRimFactor),s5(h9,r,Dx,i),one(Dx,h9,e.projectionMatrix,e.viewport,Dx),one(LI,h9,e.projectionMatrix,e.viewport,LI),Si(Dx,LI)/e.height}};function yne(t,e,r,i,s){const n=Me(t),o=i*Math.sqrt(n*n-i*i)/n,a=Math.sqrt(i*i-o*o),l=s.v1,c=s.v2;return ae(s.center,t,a/n),pt(l,t,e),ga(l)<1&&pt(l,t,r),ae(l,l,o/Me(l)),pt(c,l,t),ae(c,c,o/Me(c)),o}const h9=Ie(),Dx=M(),LI=M();function iet(t,e,r){return t*t/(Math.sqrt(t*t-e*e)*Math.sqrt(t*t-r*r)+e*r)}const _ne=is().vec3f(A.POSITION);let Txe=class Sxe extends kr{initializeProgram(e){return new Nr(e.rctx,Sxe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Bn(Ee.ONE,Ee.ZERO,Ee.ONE_MINUS_SRC_COLOR,Ee.ONE),colorWrite:Qt})}};Txe.shader=new Dr(jwe,()=>ie(()=>import("./FogHaze.glsl-0e6b71bf.js"),[],import.meta.url));const set=.7,net=1;let UR=class extends Te{constructor(e){super(e),this._passParameters=new WZ;const r=e.context.renderContext.rctx;this._vao=Ia(r,lC);const i=Yr(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+D3;const s=new XZ;s.haze=!0,this._hazeTechnique=e.context.techniqueRepository.acquire(Txe,s)}destroy(){this._hazeTechnique.release(),this._vao.dispose()}set strength(e){this._passParameters.hazeStrength=e}get strength(){return this._passParameters.hazeStrength}render(e,r){if(this.view.basemapTerrain.baseOpacity===0||(this._update(e,r),this._passParameters.hazeAmount<=0))return;const i=this._hazeTechnique;if(!i.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const n=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderSimpleHaze(n,e)})}_renderSimpleHaze(e,r){const i=r.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays($t.TRIANGLE_STRIP,0,4)}_update(e,r){const i=e.bindParameters.camera;ve(vne,i.eye);const s=Math.max(0,_e(vne,e.bindParameters.lighting.mainLight.direction)),n=aet;ae(bne,n,0),Qs(this._passParameters.hazeColor,bne,n,s);const o=Me(i.eye),a=o*o;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.hazeAmount=(1-WS(set*Sh,net*Sh,Math.abs(o-this._planetRadius)))*r.amount,this._passParameters.fogStrength=r.strength}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],UR.prototype,"context",void 0),u([d({constructOnly:!0})],UR.prototype,"view",void 0),UR=u([P("esri.views.3d.environment.SimpleHaze")],UR);let oet=class{constructor(){this.strength=0,this.amount=0}};const aet=$e(.24,.44,.8),vne=M(),bne=M();function aJ(t){const e=w`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,r=w`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;t.vertex.code.add(e),t.vertex.code.add(r),t.fragment.code.add(e),t.fragment.code.add(r)}function cet(){const t=new Lr;return t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.COLOR,"vec4"),t.attributes.add(A.SIZE,"float"),t.varyings.add("vcolor","vec4"),t.varyings.add("vsize","float"),t.vertex.uniforms.add([new qi("transform",(e,r)=>uet(e,r)),new fr("viewport",(e,r)=>r.camera.fullViewport),new Pe("pixelRatio",(e,r)=>r.camera.pixelRatio)]),t.include(aJ),t.vertex.code.add(w`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),t.fragment.code.add(w`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),t}function uet(t,e){return kn(Zy,e.camera.projectionMatrix),Zy[10]=24e-8-1,Zy[11]=-1,Zy[14]=(24e-8-2)*e.camera.near,ys(Zy,Zy,e.camera.viewMatrix),ys(Zy,Zy,t.modelMatrix)}const Zy=Ie(),het=Object.freeze(Object.defineProperty({__proto__:null,build:cet},Symbol.toStringTag,{value:"Module"}));let det=class extends pi{constructor(){super(...arguments),this.modelMatrix=Ie()}},Exe=class Cxe extends kr{constructor(e){super(e,new Pa,()=>this.destroy())}initializeProgram(e){return new Nr(e.rctx,Cxe.shader.get().build(),Ar)}initializePipeline(){return zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:$i.LEQUAL},colorWrite:Qt})}};Exe.shader=new Dr(het,()=>ie(()=>import("./Stars.glsl-21b4e5df.js"),[],import.meta.url));let J0=class extends Te{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return v(this._loadDataTask)&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new det,this._updatingTracking=new em}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=jh(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=ji(this._technique),this._vao=et(this._vao)}render(e){const{rctx:r}=e;if(this._ensureResources(r),C(this._technique)||C(this._vao))return;if(!this._technique.compiled)return void this.requestRender();const i=r.bindTechnique(this._technique,this._renderParameter,e.bindParameters);r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays($t.POINTS,0,this._numPoints)}_ensureResources(e){if(v(this._technique)||C(Nx))return;this._technique=new Exe({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Nx.byteLength/wne;const r=new Float32Array(Nx,0,2*this._numPoints),i=new Uint8Array(Nx,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,r,i,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type!=="virtual"?this.view.environment.lighting.date:null,s=>this._update(s),kt)}_computeDayDuration(e){const r=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+r-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const r=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),s=kn(this._renderParameter.modelMatrix,met);KS(s,s,-i*Math.PI),ys(s,fet,s),KS(s,s,-r*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,r,i,s){const n=xne.createBuffer(s),o=n.position,a=n.color,l=n.size;for(let c=0;c<s;c++){const h=r[2*c+0],p=r[2*c+1];o.set(c,0,-Math.cos(h)*Math.sin(p)),o.set(c,1,-Math.sin(h)*Math.sin(p)),o.set(c,2,-Math.cos(p));const f=this._unpackUint8Attributes(i[c]),m=this._hexToRGB(pet[f[1]]);a.set(c,0,255*m[0]),a.set(c,1,255*m[1]),a.set(c,2,255*m[2]),a.set(c,3,255),l.set(c,f[0])}return new Pp(e,Ar,{geometry:Hc(xne)},{geometry:jr.createVertex(e,$r.STATIC_DRAW,n.buffer)})}_createLoadDataTask(){if(v(Nx))return null;const e=EM(async r=>{const{data:i}=await s$e("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:r});this._verifyStarData(i),Nx=i});return e.promise.catch(r=>{Ks(r)||se.getLogger(this.declaredClass).error(r)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new j("stars:no-data-received","Failed to create stars because star catalogue is missing");const r=e.byteLength/wne;if(r%1!=0||r>5e4||r<5e3)throw new j("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],J0.prototype,"view",void 0),u([d({constructOnly:!0})],J0.prototype,"requestRender",void 0),u([d({readOnly:!0})],J0.prototype,"updating",null),u([d()],J0.prototype,"_loadDataTask",void 0),u([d()],J0.prototype,"_updatingTracking",void 0),J0=u([P("esri.views.3d.environment.Stars")],J0);const pet=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],fet=tY(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),met=tY(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),wne=9,xne=is().vec3f(A.POSITION).vec4u8(A.COLOR).f32(A.SIZE);let Nx=null;function iP(t=yet){return[t[0],t[1],t[2],t[3]]}function CMt(t,e,r=iP()){return le(r,t),r[3]=e,r}function Tne(t,e,r=iP()){return pt(r,t,e),ve(r,r),r[3]=-jpe(t,e),r}function AMt(t,e,r=iP()){return fF(DI,t,Sne(t)),fF(Ene,e,Sne(e)),yY(DI,Ene,DI),get(r,ol(gY(r,DI)))}function RMt(t){return t}function Sne(t){return jt(t[3])}function get(t,e){return t[3]=e,t}const yet=[0,0,1,0],DI=id(),Ene=id();iP();function _et(t,e,r){const i=t.parallax.anchorPointClouds;t.fadeIn.stage===wc.FINISHED&&(t.fadeIn.factor=0,le(i,kf),t.fadeIn.stage=wc.CHANGE_ANCHOR,t.crossFade.enabled=!1,t.fadeInOut.stage=Pn.FINISHED),t.fadeIn.stage===wc.CHANGE_ANCHOR&&t.isCameraPositionFinal&&(HZ(t.data)&&t.renderingStage!==Is.RENDERING||t.renderingStage===Is.FADING_TEXTURE_CHANNELS)&&(le(i,kf),t.fadeIn.stage=wc.FADE_IN,t.startTime=e,t.renderingStage===Is.FADING_TEXTURE_CHANNELS&&(t.renderingStage=Is.SWITCH_CHANNELS)),t.fadeIn.factor<1&&t.fadeIn.stage===wc.FADE_IN?t.fadeIn.factor=r?ye((e-t.startTime)/(Axe*r),0,1):1:t.fadeIn.factor>=1&&t.fadeIn.stage===wc.FADE_IN&&(t.fadeIn.stage=wc.FINISHED,t.fadeIn.factor=1)}function vet(t,e,r){const{fadeInOut:i,crossFade:s}=t;i.stage===Pn.FINISHED&&(t.startTime=e,i.factor=1,i.stage=Pn.FADE_OUT),i.factor>0&&i.stage===Pn.FADE_OUT?i.factor=r?1-ye((e-t.startTime)/(Eet*r),0,1):0:(i.factor<=0&&i.stage===Pn.FADE_OUT&&(i.factor=0,le(t.parallax.anchorPointClouds,kf)),i.factor<=0&&i.stage===Pn.FADE_OUT&&t.isCameraPositionFinal&&(i.factor=0,i.stage=Pn.SWITCH,t.crossFade.enabled=!1,s.factor=1),i.stage===Pn.SWITCH&&(HZ(t.data)&&t.renderingStage!==Is.RENDERING||t.renderingStage===Is.FADING_TEXTURE_CHANNELS)&&(t.startTime=e,i.factor=0,i.stage=Pn.FADE_IN,le(t.parallax.anchorPointClouds,kf),t.crossFade.enabled=!1,s.factor=1,t.renderingStage===Is.FADING_TEXTURE_CHANNELS&&(t.renderingStage=Is.SWITCH_CHANNELS)),i.factor<1&&i.stage===Pn.FADE_IN?i.factor=r?ye((e-t.startTime)/(Axe*r),0,1):1:i.factor>=1&&i.stage===Pn.FADE_IN&&(i.stage=Pn.FINISHED,i.factor=1))}function bet(t,e,r,i){const{crossFade:s}=t,n=t.parallax.anchorPointClouds;t.crossFade.enabled&&!i||(le(t.parallaxNew.anchorPointClouds,kf),t.startTime=e,s.factor=0,t.crossFade.enabled=!0),s.factor<1&&t.crossFade.enabled?s.factor=r?ye((e-t.startTime)/(Cet*r),0,1):1:s.factor>=1&&t.crossFade.enabled&&(t.crossFade.enabled=!1,s.factor=1,le(n,t.parallaxNew.anchorPointClouds),t.renderingStage===Is.FADING_TEXTURE_CHANNELS&&(t.renderingStage=Is.SWITCH_CHANNELS))}function Cne(t,e,r,i){const s=t.fadeInOutHeight,n=s.stage===uv.FINISHED?r:t.startTimeHeightFade;if(i!==0){const o=(r-n)/(Aet*i);s.factor+=e?-o:o}else s.factor=e?0:1;t.startTimeHeightFade=r,s.factor=ye(s.factor,0,1),s.stage=uv.HEIGHT_FADE}function wet(t,e,r,i,s){t.renderingStage===Is.FINISHED_RENDERING&&(t.renderingStage=Is.FADING_TEXTURE_CHANNELS);const n=Me(e.eye);t.fadeInOutHeight.factor<0&&(t.fadeInOutHeight.factor=n-br.radius>Sh?1:0),t.isCameraPositionFinal=Q_(t.cameraPositionLastFrame,e.eye),ve(kf,e.eye),ae(kf,kf,br.radius);const o=t.parallax;o.anchorPointClouds[0]===0&&o.anchorPointClouds[1]===0&&o.anchorPointClouds[2]===0&&le(o.anchorPointClouds,kf);const a=Me(ge(Tet,o.anchorPointClouds,kf));let l=!0;a>t.fadeIn.distanceThresholdFactor*o.cloudsHeight||t.fadeIn.stage!==wc.FINISHED?_et(t,i,s):a>t.fadeInOut.distanceThresholdFactor*o.cloudsHeight||t.fadeInOut.stage!==Pn.FINISHED?vet(t,i,s):a>t.crossFade.distanceThresholdFactor*o.cloudsHeight||t.crossFade.enabled||t.renderingStage===Is.FADING_TEXTURE_CHANNELS?bet(t,i,s,(r!==Tr.IDLE||!HZ(t.data))&&t.renderingStage!==Is.FADING_TEXTURE_CHANNELS):l=!1;const c=n-br.radius;if((c>1.7*Sh||c<-Sh)&&t.fadeInOutHeight.factor<1?t.fadeInOutHeight.factor=1:(c>Sh||c<-.35*Sh)&&t.fadeInOutHeight.factor<1?Cne(t,!1,i,s):c<Sh&&c>-.35*Sh&&t.fadeInOutHeight.factor>0?Cne(t,!0,i,s):t.fadeInOutHeight.stage=uv.FINISHED,t.renderingStage===Is.SWITCH_CHANNELS&&(t.readChannels=1-t.readChannels,t.renderingStage=Is.FINISHED),o.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(n*n-br.radius*br.radius,0))/n,Tne(Ane,o.anchorPointClouds,Fx),Mc(o.transform,Uu,Fx[3],Fx),l){const{parallaxNew:h}=t;Tne(Ane,h.anchorPointClouds,Fx),Mc(h.transform,Uu,Fx[3],Fx)}le(t.cameraPositionLastFrame,e.eye)}function xet(t){return t.crossFade.enabled||t.fadeInOut.stage!==Pn.FINISHED||t.fadeIn.stage!==wc.FINISHED||t.fadeInOutHeight.stage!==uv.FINISHED||t.renderingStage!==Is.FINISHED}const Ane=$e(0,0,1),Fx=iP(),kf=M(),Tet=M(),Axe=1,Eet=.5,Cet=1.3,Aet=1;let uC=class{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(e,r){var i;return(i=this._outer.get(e))==null?void 0:i.get(r)}set(e,r,i){const s=this._outer.get(e);s?s.set(r,i):this._outer.set(e,new Map([[r,i]]))}delete(e,r){const i=this._outer.get(e);i&&(i.delete(r),i.size===0&&this._outer.delete(e))}forEach(e){this._outer.forEach((r,i)=>e(r,i))}};var Gs;function Rne(t=de("enable-feature:high-quality-idle")){const e=new uC;return t&&(e.set(Tr.INTERACTING,Gs.Antialiasing,!0),e.set(Tr.IDLE,Gs.Antialiasing,!0),e.set(Tr.INTERACTING,Gs.HighQualityTransparency,!0),e.set(Tr.IDLE,Gs.HighQualityTransparency,!0),e.set(Tr.INTERACTING,Gs.RealisticAtmosphere,!0),e.set(Tr.IDLE,Gs.RealisticAtmosphere,!0),e.set(Tr.IDLE,Gs.SSAO,!0),e.set(Tr.IDLE,Gs.WaterReflection,!0),e.set(Tr.IDLE,Gs.PhysicalPixelRendering,!0)),e.set(Tr.ANIMATING,Gs.ShadowMapUpdate,!0),e.set(Tr.INTERACTING,Gs.ShadowMapUpdate,!0),e.set(Tr.IDLE,Gs.ShadowMapUpdate,!0),e.set(Tr.IDLE,Gs.HighQualityVoxel,!0),e}(function(t){t[t.Antialiasing=0]="Antialiasing",t[t.HighQualityTransparency=1]="HighQualityTransparency",t[t.HighQualityVoxel=2]="HighQualityVoxel",t[t.RealisticAtmosphere=3]="RealisticAtmosphere",t[t.SSAO=4]="SSAO",t[t.WaterReflection=5]="WaterReflection",t[t.ShadowMapUpdate=6]="ShadowMapUpdate",t[t.PhysicalPixelRendering=7]="PhysicalPixelRendering"})(Gs||(Gs={}));var AS;(function(t){t[t.Immediate=0]="Immediate",t[t.Faded=1]="Faded"})(AS||(AS={}));var VR;const Ret=[Se.POSTPROCESSING_ENVIRONMENT_OPAQUE,Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let Xn=VR=class extends Te{constructor(t){super(t),this._context=null,this._atmosphere=null,this._hqAtmosphere=null,this._oldWeatherParameters=new d9,this._newWeatherParameters=new d9,this._fadedWeatherParameters=new d9,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(Ret,this)}destroy(){var t;this.removeHandles(),((t=this.view)==null?void 0:t._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return v(this._hqAtmosphere)&&this.view._stage.renderer.isFeatureEnabled(Gs.RealisticAtmosphere)?this._hqAtmosphere:this._atmosphere}get _atmosphereType(){return v(this.atmosphere)?this.atmosphere.type:Mn.None}get canRender(){var t;return!!((t=this.view.basemapTerrain)!=null&&t.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._atmosphereType===Mn.Realistic}updateAnimation(t){return!!v(this._precipitation)&&this._precipitation.update(t)}get updating(){return v(this._stars)&&this._stars.updating||v(this._clouds)&&this._clouds.running}get weatherVisible(){return Me(this.view.state.camera.eye)-Yr(this.view.spatialReference).radius<=Sh}get _stars(){var i;const t=this.view,e=((i=t.environment)==null?void 0:i.starsEnabled)??!1,r=this._get("_stars");return!e||C(this._context)?(Ve(r),null):v(r)?r:new J0({view:t,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const t=this._get("_precipitation");if(!this._precipitationEnabled||C(this._context))return Ve(t),null;const e=this.view,r=this._context;return v(t)&&t.context===r?t:(Ve(t),new ub({context:r,view:e}))}get _clouds(){const t=this._get("_clouds");if(!this.weatherEnabled||C(this._context))return Ve(t),null;if(v(t))return t;const e=this.view,r=this._context;return Ve(t),new Al({context:r,view:e,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const t=this._get("_cloudsComposition");if(!this.weatherEnabled||C(this._context))return Ve(t),null;const e=this.view.state.viewingMode,r=this._context.renderContext.rctx,i=Yr(this.view.spatialReference).radius;return v(t)&&t.viewingMode===e&&t.planetRadius===i?t:(Ve(t),new lb({rctx:r,viewingMode:e,planetRadius:i,requestRender:()=>this._setNeedsRender()}))}get _fog(){const t=this._get("_fog");if(!this.weatherEnabled||C(this._context))return Ve(t),null;if(v(t))return t;const e=this.view,r=this._context;return new FR({context:r,view:e})}get _simpleHaze(){const t=this._get("_simpleHaze");if(!this.weatherEnabled||C(this._context))return Ve(t),null;if(v(t))return t;const e=this.view,r=this._context;return new UR({context:r,view:e})}get weatherEnabled(){var t,e;return!!((e=(t=this.view)==null?void 0:t.environmentManager)!=null&&e.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(t=null){this._context=t;const e=()=>this._setNeedsRender();this.addHandles([ra(()=>{var r;return(r=this.view)==null?void 0:r.basemapTerrain},()=>this._updateBasemapTerrain(),qs),ne(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),r=>this._updateAtmosphere(r),qs),ne(()=>this._stars,e),ne(()=>this._precipitation,e),ne(()=>this._clouds,()=>this._updateWeather(),kt),ne(()=>this._fog,()=>this._updateFogHaze(),kt),ne(()=>this._simpleHaze,()=>this._updateFogHaze(),kt),ne(()=>this.view.state.mode,()=>{this._setNeedsRender()},ri),ne(()=>this._atmosphereType,()=>this._updateBasemapTerrain(),qs),ne(()=>this._weatherUpdateParameters,()=>{this._updateWeather(),this._updateFogHaze()},qs)])}uninitializeRenderContext(){this._context=null,this._atmosphere=Ve(this._atmosphere),this._hqAtmosphere=Ve(this._hqAtmosphere),this._set("_stars",Ve(this._stars)),this._set("_precipitation",Ve(this._precipitation)),this._set("_clouds",Ve(this._clouds)),this._set("_cloudsComposition",Ve(this._cloudsComposition)),this._set("_fog",Ve(this._fog)),this._set("_simpleHaze",Ve(this._simpleHaze))}prepareRender(t){t.bindParameters.cloudsFade.data=fKe(this._clouds)?this._clouds:null,this.view.viewingMode!=="local"&&(wet(t.bindParameters.cloudsFade,t.bindParameters.camera,this.view.state.mode,t.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(t.bindParameters),t.bindParameters.cloudsFade.renderingStage===Is.FINISHED&&v(this._clouds)&&this._clouds.coverage===0&&this._clouds.running===!1&&(this._clouds.destroyFrameBufferCube(),t.bindParameters.cloudsFade.data=null))}render(t){if(t.output===V.Color)switch(t.bindParameters.slot){case Se.POSTPROCESSING_ENVIRONMENT_OPAQUE:v(this._stars)&&this._stars.render(t),v(this.atmosphere)&&(this.atmosphere.render(t),v(this._cloudsComposition)&&v(t.bindParameters.cloudsFade.data)&&(this.weatherVisible&&v(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(t)),xet(t.bindParameters.cloudsFade)&&v(this._context)&&this._context.requestRender());break;case Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(v(this.atmosphere)&&(this.atmosphere.renderHaze(t,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._atmosphereType!==Mn.Realistic&&v(this._simpleHaze)&&this._simpleHaze.render(t,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&v(this._fog)&&this._fog.render(t,this._weatherParameters.fog),v(this._precipitation))){const e=this.view.environment.weather;e.type!=="rainy"&&e.type!=="snowy"||this._precipitation.render(t,e.precipitation,e.type)}}}updateLightSources(t,e,r,i){if(v(this._context)){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=e,s.bindParameters.newLighting.globalFactor=r,s.bindParameters.newLighting.set(t),i===AS.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const t=this.weatherEnabled?this.view.environment.weather:null;return C(t)?null:t.type==="rainy"||t.type==="snowy"?{type:t.type,weatherAdjustment:t.cloudCover,effect:t.precipitation}:{type:t.type,weatherAdjustment:t.type==="foggy"?t.fogStrength:t.cloudCover}}_updateWeatherFading(t){if(!t.weatherFading)return;const e=t.cloudsFade;return e.fadeIn.stage===wc.FADE_IN?(t.fadeLighting(e.fadeIn.factor),void this._fadeWeather(e.fadeIn.factor)):e.fadeInOut.stage===Pn.FADE_IN?(t.fadeLighting(e.fadeInOut.factor),void this._fadeWeather(e.fadeInOut.factor)):e.crossFade.enabled?(t.fadeLighting(e.crossFade.factor),void this._fadeWeather(e.crossFade.factor)):(t.fadeLighting(0),void this._fadeWeather(0))}_fadeWeather(t){const{_newWeatherParameters:e,_oldWeatherParameters:r}=this;t>=1?this._weatherParameters=e:(this._fadedWeatherParameters.lerp(r,e,t),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const t=this._weatherUpdateParameters;C(t)||C(this._clouds)||(this._clouds.applyPreset(ha[t.type],t.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){v(this._context)&&this._context.requestRender()}_updateFogHaze(){const t=this._weatherUpdateParameters;if(C(this._fog)||C(this._simpleHaze)||C(t)||C(this._context))return;const e=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),t.type){case"foggy":this._newWeatherParameters.fog.strength=Ft(3e-5,.005,t.weatherAdjustment**3),le(this._newWeatherParameters.fog.color,One),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===Mn.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=Ft(4e-6,2e-4,(t.effect??0)**3),le(this._newWeatherParameters.fog.color,Oet),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=Ft(4e-6,2e-4,(t.effect??0)**3),le(this._newWeatherParameters.fog.color,One),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===Mn.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}e.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(t){const e=this._selectAtmosphereType(t);if(v(this._atmosphere)?this._atmosphere.type===e:e===Mn.None)return;this._atmosphere=Ve(this._atmosphere),this._hqAtmosphere=Ve(this._hqAtmosphere);const r=this._getAtmosphereClass(e);r&&v(this._context)&&(this._atmosphere=new r(this.view,this._context),e===Mn.Simple&&(this._hqAtmosphere=new K8(this.view,this._context))),this._setNeedsRender(),this._updateBasemapTerrain()}_getAtmosphereClass(t){switch(t){case Mn.Realistic:return K8;case Mn.Panoramic:return zQe;case Mn.Simple:return ret;default:case Mn.None:return null}}_selectAtmosphereType(t){const{enabled:e,quality:r,viewingMode:i}=t;return!e||xm(this.view.spatialReference)?Mn.None:i===Be.Local?Mn.Panoramic:v(this._context)&&r==="high"&&K8.isSupported(this._context)&&BS(this.view.spatialReference)?Mn.Realistic:Mn.Simple}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=this._atmosphereType===Mn.Simple)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),stubGetAtmosphereClass:t=>{Mne=VR.prototype._getAtmosphereClass,VR.prototype._getAtmosphereClass=t},restoreGetAtmosphereClass:()=>{VR.prototype._getAtmosphereClass=Mne}}}};u([d({constructOnly:!0})],Xn.prototype,"view",void 0),u([d({readOnly:!0})],Xn.prototype,"atmosphere",null),u([d({readOnly:!0})],Xn.prototype,"_atmosphereType",null),u([d({type:Boolean,readOnly:!0})],Xn.prototype,"updating",null),u([d({readOnly:!0})],Xn.prototype,"weatherVisible",null),u([d()],Xn.prototype,"_context",void 0),u([d()],Xn.prototype,"_atmosphere",void 0),u([d()],Xn.prototype,"_hqAtmosphere",void 0),u([d({readOnly:!0})],Xn.prototype,"_stars",null),u([d({readOnly:!0})],Xn.prototype,"_precipitation",null),u([d({readOnly:!0})],Xn.prototype,"_clouds",null),u([d({readOnly:!0})],Xn.prototype,"_cloudsComposition",null),u([d({readOnly:!0})],Xn.prototype,"_fog",null),u([d({readOnly:!0})],Xn.prototype,"_simpleHaze",null),u([d({readOnly:!0})],Xn.prototype,"weatherEnabled",null),u([d({readOnly:!0})],Xn.prototype,"_precipitationEnabled",null),u([d({readOnly:!0})],Xn.prototype,"_weatherUpdateParameters",null),Xn=VR=u([P("esri.views.3d.environment.EnvironmentRenderer")],Xn);let d9=class{constructor(){this.fog=new tQe,this.haze=new oet}copyFrom(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,le(this.fog.color,e.fog.color)}lerp(e,r,i){this.fog.amount=Ft(e.fog.amount,r.fog.amount,i),this.haze.amount=Ft(e.haze.amount,r.haze.amount,i),this.fog.strength=Ft(e.fog.strength,r.fog.strength,i),this.haze.strength=Ft(e.haze.strength,r.haze.strength,i),Qs(this.fog.color,e.fog.color,r.fog.color,i)}};const Oet=$e(.5,.5,.5),One=$e(1.5,1.5,1.5);let Mne;var Pne,Ine,$ne,MH={},Met={get exports(){return MH},set exports(t){MH=t}};Pne=Met,Ine=function(){var t=Math.PI,e=Math.sin,r=Math.cos,i=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=t/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f($){return $.valueOf()/l-.5+c}function m($){return new Date(($+.5-c)*l)}function y($){return f($)-h}var _=23.4397*a;function b($,N){return n(e($)*r(_)-i(N)*e(_),r($))}function x($,N){return s(e(N)*r(_)+r(N)*e(_)*e($))}function T($,N,F){return n(e($),r($)*e(N)-i(F)*r(N))}function S($,N,F){return s(e(N)*e(F)+r(N)*r(F)*r($))}function E($,N){return a*(280.16+360.9856235*$)-N}function O($){return a*(357.5291+.98560028*$)}function R($){return a*(1.9148*e($)+.02*e(2*$)+3e-4*e(3*$))}function L($,N){return $+N+102.9372*a+t}function I($,N){var F=O($),H=L(F,R(F));return N||(N={dec:0,ra:0}),N.dec=x(H,0),N.ra=b(H,0),N}var U={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function($,N,F,H){var X=a*-F,J=a*N,W=y($),ue=I(W,p),pe=E(W,X)-ue.ra;return H||(H={azimuth:0,altitude:0}),H.azimuth=T(pe,J,ue.dec),H.altitude=S(pe,J,ue.dec),H}},z=[[-.83,"sunrise","sunset"]];U.addTime=function($,N,F){z.push([$,N,F])};var B=9e-4;function G($,N){return Math.round($-B-N/(2*t))}function K($,N,F){return B+($+N)/(2*t)+F}function re($,N,F){return h+$+.0053*e(N)-.0069*e(2*F)}function ee($,N,F){return o((e($)-e(N)*e(F))/(r(N)*r(F)))}function q($){var N=a*(134.963+13.064993*$),F=a*(93.272+13.22935*$),H=a*(218.316+13.176396*$)+6.289*a*e(N),X=5.128*a*e(F),J=385001-20905*r(N);return{ra:b(H,X),dec:x(H,X),dist:J}}return U.getTimes=function($,N,F){var H=a*-F,X=a*N,J=G(y($),H),W=K(0,H,J),ue=O(W),pe=R(ue),we=L(ue,pe),Ce=x(we,0),je=re(W,ue,we);function De(er){return re(K(ee(er,X,Ce),H,J),ue,we)}function xe(er){var Yt=(e(er)-e(X)*e(Ce))/(r(X)*r(Ce));return Yt<-1?U.PolarException.MIDNIGHT_SUN:Yt>1?U.PolarException.POLAR_NIGHT:U.PolarException.NORMAL}var Ne,Ue,xt,Qe,Ut,Xt={solarNoon:m(je),nadir:m(je-.5),polarException:U.PolarException.NORMAL};for(Ne=0,Ue=z.length;Ne<Ue;Ne+=1)Ut=je-((Qe=De((xt=z[Ne])[0]*a))-je),Xt[xt[1]]=m(Ut),Xt[xt[2]]=m(Qe);return Xt.polarException=xe(z[0][0]*a),Xt},U.getMoonPosition=function($,N,F){var H=a*-F,X=a*N,J=y($),W=q(J),ue=E(J,H)-W.ra,pe=S(ue,X,W.dec);return pe+=.017*a/i(pe+10.26*a/(pe+5.1*a)),{azimuth:T(ue,X,W.dec),altitude:pe,distance:W.dist}},U.getMoonFraction=function($){var N=y($),F=I(N),H=q(N),X=149598e3,J=o(e(F.dec)*e(H.dec)+r(F.dec)*r(H.dec)*r(F.ra-H.ra)),W=n(X*e(J),H.dist-X*r(J));return(1+r(W))/2},U},($ne=Ine())!==void 0&&(Pne.exports=$ne);const Hw=MH,Lf={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function Pet(t,e,r,i,s,n){ce(n.ambient.color,1,1,1),n.ambient.intensity=Lf.global.ambient,ce(n.direct.color,1,1,1),n.direct.intensity=Lf.global.direct;const o=e[2],a=ye((Math.abs(o)-Lf.local.altitude)/(Lf.global.altitude-Lf.local.altitude),0,1);let l;if(n.globalFactor=a,v(t)&&(l=Hw.getTimes(t,e[1],e[0])),a<1){let c;if(v(t))c=Uet(t,l,i);else{const h=Mxe(i);c={direct:{intensity:Lf.local.directAtNoon*h.direct,color:$e(1,1,1)},ambient:{intensity:Lf.local.ambientAtNoon*h.ambient,color:$e(1,1,1)},timeOfDay:"early afternoon"}}Qs(n.ambient.color,c.ambient.color,n.ambient.color,a),n.ambient.intensity=Ft(c.ambient.intensity,n.ambient.intensity,a),Qs(n.direct.color,c.direct.color,n.direct.color,a),n.direct.intensity=Ft(c.direct.intensity,n.direct.intensity,a),n.specularStrength=i==="rainy"||i==="snowy"||i==="foggy"?0:1,n.environmentStrength=i==="rainy"?.7:i==="snowy"||i==="foggy"?.75:1}n.noonFactor=v(t)?Fet(t,l):1,v(t)?Iet(t,e,r,n.direct.directionToLightSource):Rxe(s,r,n.direct.directionToLightSource)}function Rxe(t,e,r){e===Be.Global?ve(p9,t.eye):ce(p9,0,0,1),ae(f9,t.viewForward,-1);const i=IL(f9,p9),s=Math.max(i-2*m9,0),n=.85*s/(s+1),o=Math.max(m9,i-m9-n);Fu(Dne,-o,t.viewRight),Xe(r,f9,Dne),me(r,r,ae(Vet,t.viewRight,ket)),ve(r,r)}function Iet(t,e,r,i){const s=Net,n=Wh(Det);if(r===Be.Global)Hw.getPosition(t,0,0,s),ce(i,0,0,-1),JS(n,n,-s.azimuth),r5(n,n,-s.altitude),Xe(i,i,n);else{const o=Lf.planarDirection,a=o.globalAngles,l=e[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=ye(c,0,1),c<1?(Hw.getPosition(t,e[1],e[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),ce(i,0,-1,0),KS(n,n,-s.azimuth),JS(n,n,-s.altitude),Xe(i,i,n)}}function $et(t,e){if(e===Be.Global)return!0;const r=Lf.planarDirection;return Math.abs(t)<r.localAltitude}const Let=$e(.5773502691896258,-.5773502691896258,.5773502691896258);let Oxe=class{constructor(){this.ambient={color:$e(1,1,1),intensity:.55},this.direct={color:$e(1,1,1),intensity:.55,directionToLightSource:gs(Let)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}};const Det=Ie(),Net={azimuth:0,altitude:0};function Fet(t,e){const r=t.valueOf();let i,s;e.polarException===Hw.PolarException.MIDNIGHT_SUN?(i=r-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,s=i+432e6):e.polarException===Hw.PolarException.POLAR_NIGHT?(i=r-2,s=r-1):(i=e.sunrise.valueOf(),s=e.sunset.valueOf());const n=i+(s-i)/2;return 1-ye(Math.abs(r-n)/432e5,0,1)}function Mxe(t){switch(t){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function Lne(t,e){const r=(t[0]+t[1]+t[2])/3;for(let i=0;i<3;i++)t[i]=t[i]+(r-t[i])*e;return t}function Uet(t,e,r){const i=t.valueOf();let s,n;e.polarException===Hw.PolarException.MIDNIGHT_SUN?(s=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=s+432e6):e.polarException===Hw.PolarException.POLAR_NIGHT?(s=i-2,n=i-1):(s=e.sunrise.valueOf(),n=e.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,m=s+p/2,y=n-p/2,_=n+p/2,b=Lf.local,x=[.01,b.ambientAtNight],T=[.8,.8,1],S=[.01,.01,.01],E=[b.directAtTwilight,b.ambientAtTwilight],O=[1,.6,.5],R=[.8,.8,1],L=[.9*b.directAtNoon,b.ambientAtNoon],I=[1,.98,.98],U=[.98,.98,1],z=[b.directAtNoon,b.ambientAtNoon],B=[1,1,1],G=[1,1,1],K=L,re=I,ee=U,q=E,$=O,N=R;let F,H,X=[0,0],J=[0,0,0],W=[0,0,0];i<f||i>_?(X=x,J=S,W=T,H="night"):i<m?(F=m-f,X=zo(i-f,F,x,E),J=zo(i-f,F,S,O),W=zo(i-f,F,T,R),H="sun rising"):i<c?(F=c-m,X=zo(i-m,F,E,L),J=zo(i-m,F,O,I),W=zo(i-m,F,R,U),H="early morning"):i<a?(F=a-c,X=zo(i-c,F,L,z),J=zo(i-c,F,I,B),W=zo(i-c,F,U,G),H="late morning"):i<h?(F=h-a,X=zo(i-a,F,z,K),J=zo(i-a,F,B,re),W=zo(i-a,F,G,ee),H="early afternoon"):i<y?(F=y-h,X=zo(i-h,F,K,q),J=zo(i-h,F,re,$),W=zo(i-h,F,ee,N),H="late afternoon"):i<_&&(F=_-y,X=zo(i-y,F,q,x),J=zo(i-y,F,$,S),W=zo(i-y,F,N,T),H="sun setting");let ue=0;switch(r){case"rainy":case"foggy":case"snowy":ue=.5}ue>0&&(J=Lne(J,ue),W=Lne(W,ue));const pe=$e(J[0],J[1],J[2]),we=$e(W[0],W[1],W[2]),Ce=Mxe(r);return{direct:{intensity:X[0]*Ce.direct,color:pe},ambient:{intensity:X[1]*Ce.ambient,color:we},timeOfDay:H}}function zo(t,e,r,i){const s=[];for(let n=0;n<r.length;n++)s[n]=(i[n]-r[n])*t/e+r[n];return s}const Dne=Ie(),p9=M(),f9=M(),Vet=M(),m9=.25,ket=.2;let Dd=class extends Fs.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new Zr,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new YF,this._ambientLight=new qZ,this._moonLight=new Vwe,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!((e=this._renderer)!=null&&e.updating))}get weatherEnabled(){var e,r,i;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((i=(r=this._view)==null?void 0:r.state)==null?void 0:i.viewingMode)===Be.Global&&BS(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Xn({view:e});const r=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this._viewHandles.add([ne(()=>e.environment.lighting,s=>this._updateLightingHandler(s),ri),ne(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,s=>this._lightingDateHandler(s),ri),ne(()=>e.stationary,()=>this._interactingStationaryHandler()),ne(()=>e.environment.lighting.directShadowsEnabled,r,ri),ne(()=>e.environment.lighting.ambientOcclusionEnabled,r,ri),ne(()=>e.environment.lighting.waterReflectionEnabled,r,ri),ne(()=>{var s;return(s=e.environment.background)==null?void 0:s.color},r,ri),ne(()=>e.spatialReference,()=>this._resetReferencePosition(!0),ri),ne(()=>e.environment.weather.type,()=>this._updateLighting(null,AS.Faded),ri),ne(()=>this.weatherEnabled,()=>this._updateLighting(null,AS.Faded),ri),ne(()=>e.viewingMode,()=>this._resetReferencePosition(!0),qs),ne(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),qs),ne(()=>e.state.camera,i,qs),ne(()=>this.disableQueries,i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=Ve(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const r=this._view.environment.lighting;(r==null?void 0:r.type)!=="virtual"&&(r.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const r=this._view.environment.lighting;if((r==null?void 0:r.type)!=="virtual"){if(e){if(!r.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!Aw(i)){const s=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(s))return void this._requestReferencePositionUpdate(s)}if(this._preupdateTracking(e),v(this._referencePosWGS84Comparable)){const s=lte(this._referencePosWGS84Comparable,Nne);v(s)&&(r.autoUpdate(null,s),this._trackingEnabled&&(r.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const r=this._view;if(!r.ready)return;const i=r.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,r){const i=BS(this._view.spatialReference);if(i&&!Aw(this._view.spatialReference))return this._view.environment.lighting.type==="virtual"&&this._updateLighting(),!1;const s=e.position;return C(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=M()),i?BDe(s,this._referencePosWGS84Comparable):ce(this._referencePosWGS84Comparable,s.longitude??0,s.latitude??0,s.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,r)||this._updateLighting(r),!0}_cameraHandlerServerSide(e){const r=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(r))&&this._requestReferencePositionUpdate(r,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(r.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,r=AS.Immediate){const i=this._view;e=e||(i.environment.lighting.type==="virtual"?null:i.environment.lighting.date);const s=this._referencePosWGS84Comparable,n=v(s)?zet:Bet,o=this.weatherVisible?i.environment.weather.type:"disabled";v(s)?Pet(e,s,i.state.viewingMode,o,i.state.camera,n):i.environment.lighting.type==="virtual"&&Rxe(i.state.camera,i.state.viewingMode,n.direct.directionToLightSource);const a=this._mainLight,l=n.direct;ae(a.intensity,l.color,l.intensity*Math.PI),le(a.direction,l.directionToLightSource),a.specularStrength=n.specularStrength,a.environmentStrength=n.environmentStrength;const c=this._ambientLight;ae(c.intensity,n.ambient.color,n.ambient.intensity);const h=this._moonLight;Qs(h.intensity,jet,Het,n.globalFactor);const p=(1-.5*n.globalFactor)*(1-.4*n.noonFactor*(1-n.globalFactor));ae(h.intensity,h.intensity,p),le(h.direction,l.directionToLightSource),this._renderer.updateLightSources([a,c,h],n.noonFactor,n.globalFactor,r),this._updateRenderParameters()}_autoUpdateTimezone(e,r=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||C(e))return!1;const i=Get;i.setTime((r||this._view.environment.lighting.date).getTime());const s=lte(e,Nne);if(C(s))return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===s.hours&&n.minutes===s.minutes&&n.seconds===s.seconds)return!1}else n=s;const o=i.getUTCHours()-(s.hours-n.hours),a=i.getUTCMinutes()-(s.minutes-n.minutes),l=i.getUTCSeconds()-(s.seconds-n.seconds);return i.setUTCHours(o),i.setUTCMinutes(a),i.setUTCSeconds(l),!r&&this._view.environment.lighting.autoUpdate(i,s)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const r=xu(this._referencePosWGS84Comparable,!0,n=>$et(n[2],this._view.state.viewingMode)),i=this._view.environment.background,s=i instanceof Sme?{type:"color",color:rY(Ze.toUnitRGBA(i.color))}:{type:"color",color:qt(0,0,0,1)};e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,background:s,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,r=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!r,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=_w(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const n=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(n)}}).catch(n=>{n.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),s=this._referencePosUpdateTimer=_w(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===s&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const r=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(r[0])&&!isNaN(r[1])){const i=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=r[0],this._referencePosWGS84Comparable[1]=r[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[r[0],r[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let r=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(r*=this._view.mapCoordsHelper.unitInMeters),r>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(r){e._referencePointUpdateInterval=r},set referencePointUpdateDistThreshold(r){e._referencePointUpdateDistThreshold=r},set referencePosUpdateTimer(r){e._referencePosUpdateTimer=r},set referencePointUpdateDelay(r){e._referencePointUpdateDelay=r},set disableWeather(r){e._disableWeather=r}}}};u([d({type:Boolean,readOnly:!0})],Dd.prototype,"updating",null),u([d()],Dd.prototype,"disableQueries",void 0),u([d()],Dd.prototype,"_disableWeather",void 0),u([d()],Dd.prototype,"weatherEnabled",null),u([d()],Dd.prototype,"weatherVisible",null),u([d()],Dd.prototype,"referencePositionWGS84Comparable",null),u([d()],Dd.prototype,"_renderer",void 0),u([d()],Dd.prototype,"_referencePosWGS84Comparable",void 0),Dd=u([P("esri.views.3d.environment.SceneViewEnvironmentManager")],Dd);const zet=new Oxe,Bet=new Oxe,Get=new Date,Nne={hours:0,minutes:0,seconds:0},jet=$e(.22,.22,.33),Het=$e(.22,.22,.22);var Ui;(function(t){t[t.NONE=0]="NONE",t[t.TILT=1]="TILT",t[t.ALTITUDE=2]="ALTITUDE",t[t.DISTANCE=4]="DISTANCE",t[t.COLLISION=8]="COLLISION",t[t.ALL=15]="ALL",t[t.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(Ui||(Ui={}));var or;(function(t){t[t.NONE=0]="NONE",t[t.ZOOM=1]="ZOOM",t[t.TUMBLE=2]="TUMBLE",t[t.LOOK_AROUND=3]="LOOK_AROUND",t[t.PAN=4]="PAN",t[t.ASCEND=5]="ASCEND"})(or||(or={}));var ho;(function(t){t[t.TUMBLE=0]="TUMBLE",t[t.LOOK_AROUND=1]="LOOK_AROUND"})(ho||(ho={}));function k3(t,e){return(t&e)!=0}function e4(t,e,r,i,s,n){t!==0&&(r?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):i!=null?(n.min-=Math.max(0,(e-n.min)*(1-i)),n.max+=Math.max(0,(e-n.max)*(1-i))):s&&(n.min-=Math.max(0,e-n.min-s),n.max+=Math.max(0,e-n.max-s)))}const pv={selection:Ui.NONE,interactionType:or.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ho.TUMBLE};function Pxe(t,e,r,i){return e=e||t.viewForward,le(i,e),ae(i,i,Math.sign(_e(e,r))),i}function qet(t,e,r,i){return Jet(t,e,r,Yet(i,e,r,!0))}function Wet(t,e,r,i){const s=_e(r,ge(t,i,e));return me(t,e,ae(t,r,s))}const Xet={dir:M(),len:0,clip:Ke()};function Yet(t,e,r,i){const s=Xet;return t?(r&&i&&(s.len=Si(e,r)),le(s.dir,t)):i?(s.len=Si(e,r),ge(s.dir,r,e),ae(s.dir,s.dir,1/s.len)):(ge(s.dir,r,e),ve(s.dir,s.dir)),s}function Zet(t,e,r){const i=_e(t,r.dir),s=-wi(t,e);if(s<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return s>0;if((s<0||i<0)&&!(s<0&&i<0))return!0;const n=s/i;return i>0?n<r.clip[1]&&(r.clip[1]=n):n>r.clip[0]&&(r.clip[0]=n),r.clip[0]<=r.clip[1]}function Jet(t,e,r,i){i.clip[0]=0,i.clip[1]=r?i.len:Number.MAX_VALUE;for(let s=0;s<t.length;s++)if(!Zet(t[s],e,i))return!1;return!0}function Ket(t,e,r=pv){const i=lJ(t,e,r);if(i===0)return!1;const s=t.renderCoordsHelper,n=s.getAltitude(e.eye)+i,o=Pxe(e,r.interactionDirection,ttt(t,e,Math.sign(i),ntt),stt),a=le(ott,e.viewForward),l=s.intersectInfiniteManifold(Vu(e.eye,o),n,g9);return e.eye=v(l)?l:s.setAltitude(g9,n,e.eye),e.center=Wet(g9,e.eye,a,e.center),!0}function lJ(t,e,r=pv){if(!Qet(t,r)||!t.state.constraints.altitude)return 0;const i=rtt(t.state.constraints.altitude,itt);ett(t,r,i);const s=t.renderCoordsHelper.getAltitude(e.eye),n=ye(s,i.min,i.max)-s;return Math.abs(n)<=1e-6?0:n}function Qet(t,e){const r=t.state.constraints.altitude;return!(!t.state.isGlobal||!r)&&(e.interactionType!==or.TUMBLE||!k3(e.selection,Ui.TILT))}function ett(t,e,r){const i=e.interactionType;if(i===or.NONE)return;const{min:s,max:n}=r,{interactionStartCamera:o,interactionFactor:a}=e;if(!o)return;const l=i===or.TUMBLE||i===or.ZOOM,c=lJ(t,o),h=c===0?0:t.renderCoordsHelper.getAltitude(o.eye);r.min=s,r.max=n,e4(c,h,l,a,.05*h,r)}function ttt(t,e,r,i){return t.renderCoordsHelper.worldUpAtPosition(e.eye,i),ae(i,i,r),i}function rtt(t,e){return e.min=t.min,e.max=t.max,e}const itt={min:0,max:0},stt=M(),ntt=M(),ott=M(),g9=M();function cJ(t,e,r=pv){if(!t.state.isLocal)return 0;const i=t.state.constraints.distance;if(!t.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;NI.min=0,NI.max=i,ltt(t,r,NI);const s=uJ(t,e),n=NI.max-s;return n>=-1e-6?0:n}function att(t,e,r=pv){const i=cJ(t,e,r);if(i===0)return!1;const s=t.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=uJ(t,e)+i,o=le(utt,e.eye),a=Pxe(e,r.interactionDirection,ctt(e,s.renderLocation,ptt),dtt);if(!Rv(hye(s.renderLocation,n),Vu(e.eye,a),FI))return!1;e.eye=FI;const l=ge(htt,e.eye,o);e.center=me(FI,e.center,l);const c=t.renderCoordsHelper.getAltitude(e.center),h=t.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,FI);return v(h)&&(e.center=h),!0}function ltt(t,e,r){const i=e.interactionType;if(i===or.NONE)return;const{min:s,max:n}=r,{interactionStartCamera:o,interactionFactor:a}=e;if(!o)return;const l=i===or.ZOOM||i===or.PAN,c=cJ(t,o),h=c===0?0:uJ(t,o);r.min=s,r.max=n,e4(c,h,l,a,.05*h,r)}function uJ(t,e){const r=t.pointsOfInterest.surfaceOrigin;return r.renderLocation?Si(e.eye,r.renderLocation):0}function ctt(t,e,r){return my(r,t.eye,e)}const NI={min:0,max:0},utt=M(),htt=M(),dtt=M(),ptt=M(),FI=M();function hC(t,e,r=Fh.EYE){const i=t.state.constraints;if(!i.collision.enabled)return!1;const s=L5(t,e.eye),n=t.renderCoordsHelper.getAltitude(e.eye),o=s+i.collision.elevationMargin;if(n>=o)return!1;const a=Me(e.eye);if(ge(UI,e.center,e.eye),e.eye=t.renderCoordsHelper.setAltitude(ftt,o,e.eye),r===Fh.EYE_AND_CENTER)e.center=me(UI,e.eye,UI);else if(r===Fh.EYE_AND_CENTER_SCALE){const l=(a-n+o)/a;e.center=ae(UI,e.center,l)}return!0}var Fh;(function(t){t[t.EYE=0]="EYE",t[t.EYE_AND_CENTER=1]="EYE_AND_CENTER",t[t.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(Fh||(Fh={}));const UI=M(),ftt=M();function fv(t,e,r){t.worldUpAtPosition(e,Fne),ge(y9,r,e);const i=Me(y9);return i===0?0:An(_e(y9,Fne)/i)}const Fne=M(),y9=M();function Ixe(t,e,r=pv,i=!0){WC.eyeCenterDistance=0,WC.requiresTwoSteps=!1;const s=hJ(t,e,r,void 0,WC);if(s===0)return!1;switch(Fu(VI,-s,e.viewRight),r.tiltMode){case ho.LOOK_AROUND:Xe(Jy,e.viewForward,VI),ae(Jy,Jy,WC.eyeCenterDistance),e.center=me(__,e.eye,Jy);break;case ho.TUMBLE:ge(Jy,e.center,e.eye),Xe(Jy,Jy,VI),e.eye=ge(__,e.center,Jy);break;default:r.tiltMode}return e.up=Xe(__,e.up,VI),!WC.requiresTwoSteps||!i||Ixe(t,e,r,!1)}function hJ(t,e,r=pv,i=pv,s){if(!t.state.constraints.tilt)return 0;const n=e.distance,o=t.state.constraints.tilt(n,Stt);return Ttt(t,r,o),i.interactionType===or.TUMBLE&&k3(i.selection,Ui.ALTITUDE)&&$xe(t,i.interactionStartCamera,o),r.tiltMode===ho.LOOK_AROUND||i.tiltMode===ho.LOOK_AROUND?gtt(t,e,o,s):mtt(t,e,o)}function mtt(t,e,r){const i=fv(t.renderCoordsHelper,e.center,e.eye),s=i-ye(i,r.min,r.max);return z3(s)?s:0}function gtt(t,e,r,i){switch(i&&(i.requiresTwoSteps=!1),t.viewingMode){case"global":return _tt(t,e,r,i);case"local":return ytt(t,e,r,i)}}function ytt(t,e,r,i){const s=fv(t.renderCoordsHelper,e.center,e.eye),n=ye(s,r.min,r.max),o=s-n;if(!z3(o))return 0;if(i){const a=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=t.renderCoordsHelper.getAltitude(e.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?i.eyeCenterDistance=l/c:i.eyeCenterDistance=e.distance}return o}function _tt(t,e,r,i){const s=vtt(t,e,Ett),n=ye(s.tiltAtCenter,r.min,r.max);if(!z3(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=btt(s),a=wtt(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),i&&o<Math.PI/2&&(i.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=xtt(s,o)),i&&(i.eyeCenterDistance=PH(s,o)),a}function vtt(t,e,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=i+Yr(t.spatialReference).radius,n=t.renderCoordsHelper.intersectManifold(e.ray,i,__);return r.eyeCenterDistance=e.distance,r.centerIsOnSurface=!1,v(n)?(r.eyeCenterDistance=Si(e.eye,n),r.tiltAtCenter=fv(t.renderCoordsHelper,n,e.eye),r.centerIsOnSurface=!0):t.state.isLocal?r.tiltAtCenter=fv(t.renderCoordsHelper,e.center,e.eye):(JE(E5(C5,s),e.ray,__),r.eyeCenterDistance=Si(e.eye,__),r.tiltAtCenter=An(-_e(e.viewForward,ve(__,__)))),r.radius=s,r.eyeRadius=Me(e.eye),r.constraints=t.state.constraints,r}function z3(t){return Math.abs(t)>1e-9}function btt(t){const{constraints:e,eyeCenterDistance:r,tiltAtCenter:i}=t;let s=i,n=e.clampTilt(r,i);const o=PH(t,n);if(e.clampTilt(o,i)===n)return n;let a=0;for(;a<10&&z3(n-s);){const l=(s+n)/2,c=PH(t,l);z3(e.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function PH(t,e){if(!t.centerIsOnSurface)return t.eyeCenterDistance;const r=Math.PI-ye(e,0,Math.PI),i=Hh(t.radius/t.eyeRadius*Math.sin(r)),s=Math.PI-r-i,n=Math.sin(s)/Math.sin(r);if(t.eyeRadius<t.radius&&n>1){const o=Math.PI-i,a=Math.PI-r-o;return Math.sin(a)/Math.sin(r)*t.eyeRadius}return n*t.eyeRadius}function wtt(t,e){const r=Hh(t.radius/t.eyeRadius*Math.sin(t.tiltAtCenter)),i=Hh(t.radius/t.eyeRadius*Math.sin(e));return t.eyeRadius>t.radius?r-i:i-r}function xtt(t,e){return t.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function Ttt(t,e,r){if(e.interactionType===or.NONE)return;const{interactionStartCamera:i,interactionFactor:s}=e;if(!i)return;const{min:n,max:o}=r,a=hJ(t,i,pv,e),l=a===0?0:fv(t.renderCoordsHelper,i.center,i.eye);r.min=n,r.max=o,e.interactionType===or.TUMBLE?(k3(e.selection,Ui.ALTITUDE)&&$xe(t,i,r),e4(a,l,!0,s,Une,r)):e4(a,l,!1,s,Une,r)}function $xe(t,e,r){const i=t.state.constraints;if(t.state.isLocal||!i.altitude||!e)return;const s=ga(e.center),n=Math.sqrt(s),o=e.distance,a=Yr(t.spatialReference).radius,l=i.altitude.min+a,c=i.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);r.min=Math.max(r.min,Math.min(Math.PI-An(p),r.max)),r.max=Math.min(r.max,Math.PI-An(h))}const Jy=M(),VI=Ie(),__=M(),Une=jt(5),Stt={min:0,max:0},Ett={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},WC={eyeCenterDistance:0,requiresTwoSteps:!1};function Ctt(t){return t}const b6=t=>t*t,dJ=t=>1-b6(1-t),Att=t=>t<.5?b6(2*t)/2:(dJ(2*(t-.5))+1)/2,pJ=t=>t*t*t,Lxe=t=>1-pJ(1-t),Dxe=t=>t<.5?pJ(2*t)/2:(Lxe(2*(t-.5))+1)/2,fJ=t=>t*t*t*t,Nxe=t=>1-fJ(1-t),Rtt=t=>t<.5?fJ(2*t)/2:(Nxe(2*(t-.5))+1)/2,mJ=t=>t*t*t*t*t,Fxe=t=>1-mJ(1-t),Ott=t=>t<.5?mJ(2*t)/2:(Fxe(2*(t-.5))+1)/2,gJ=t=>1-Math.cos(t*Math.PI/2),Uxe=t=>1-gJ(1-t),Mtt=t=>t<.5?gJ(2*t)/2:(Uxe(2*(t-.5))+1)/2,yJ=t=>2**(10*(t-1)),sP=t=>1-yJ(1-t),Ptt=t=>t<.5?yJ(2*t)/2:(sP(2*(t-.5))+1)/2,_J=t=>-(Math.sqrt(1-t*t)-1),Vxe=t=>1-_J(1-t),Itt=t=>t<.5?_J(2*t)/2:(Vxe(2*(t-.5))+1)/2;function nd(t){const e=2*(t-Math.sqrt((t-1)*t)),r=e/2/t;return i=>i<r?t*i*i:e*i-e+1}function od(t,e){return(r,i)=>r<e?e*t(r/e,i):1-t((1-r)/(1-e),i)*(1-e)}const $tt=od(nd(1),1),Ltt=od(nd(1),0),kxe=od(nd(1),.5),Dtt=od(nd(2),1),Ntt=od(nd(2),0),Ftt=od(nd(2),.5),Utt=od(nd(3),1),Vtt=od(nd(3),0),ktt=od(nd(3),.5),ztt=od(nd(4),1),Btt=od(nd(4),0),Gtt=od(nd(4),.5),jtt={linear:Ctt,"in-quad":b6,"out-quad":dJ,"in-out-quad":Att,"in-coast-quad":$tt,"out-coast-quad":Ltt,"in-out-coast-quad":kxe,"in-cubic":pJ,"out-cubic":Lxe,"in-out-cubic":Dxe,"in-coast-cubic":Dtt,"out-coast-cubic":Ntt,"in-out-coast-cubic":Ftt,"in-quart":fJ,"out-quart":Nxe,"in-out-quart":Rtt,"in-coast-quart":Utt,"out-coast-quart":Vtt,"in-out-coast-quart":ktt,"in-quint":mJ,"out-quint":Fxe,"in-out-quint":Ott,"in-coast-quint":ztt,"out-coast-quint":Btt,"in-out-coast-quint":Gtt,"in-sine":gJ,"out-sine":Uxe,"in-out-sine":Mtt,"in-expo":yJ,"out-expo":sP,"in-out-expo":Ptt,"in-circ":_J,"out-circ":Vxe,"in-out-circ":Itt};function Ws(t,e,r=Xtt,i=e){i!==e&&i.copyFrom(e),i.computeUp(t.state.viewingMode);let s=!1;for(let a=0;a<Ytt;a++){let l=0;for(const c of Wtt)if(k3(r.selection,c.type)){const h=Math.abs(c.error(t,i,r));c.apply(t,i,r)&&(s=!0,l+=h)}if(l===0)break}const n=k3(r.selection,Ui.COLLISION),o=Htt(r.interactionType,t);return n&&hC(t,i,o)&&(s=!0),s&&i.computeUp(t.state.viewingMode),s}function Htt(t,e){switch(t){case or.PAN:return Fh.EYE_AND_CENTER;case or.ASCEND:return e.state.isGlobal?Fh.EYE_AND_CENTER_SCALE:Fh.EYE_AND_CENTER;default:return Fh.EYE}}function Qd(t){const e=Math.min(1,t/150);return Dxe(e)}function qtt(t,e,r){return hJ(t,e,r)*e.distance}const Wtt=[{type:Ui.TILT,error:qtt,apply:Ixe},{type:Ui.ALTITUDE,error:lJ,apply:Ket},{type:Ui.DISTANCE,error:cJ,apply:att}],Xtt={selection:Ui.ALL,interactionType:or.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ho.TUMBLE},Ytt=5,Xc=M(),Jl=M(),Ky=M(),oa=M(),Yv=M(),Ztt=M(),Yc={upward:$e(0,0,1),forward:$e(0,1,0),sideway:$e(1,0,0)},Vne=rs();let kne=class{constructor(e=Be.Global){this.viewingMode=e,this.center=M(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=gs(Yc.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,r){if(r||(r={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Be.Global){const n=(Me(this.center)+Me(e.center))/2;r.pan=IL(this.center,e.center)*n}else r.pan=Si(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const s=Math.abs(e.pitch-this.pitch);return r.rotate=Math.max(i,s),r.sourceZoom=this.distance,r.targetZoom=e.distance,r}interpolate(e,r,i){this.viewingMode===Be.Global?s4e(e.center,r.center,i.pan,this.center):Qs(this.center,e.center,r.center,i.pan),this.distance=isFinite(r.distance)?Ft(e.distance,r.distance,i.zoom):e.distance,this.pitch=Ft(e.pitch,r.pitch,i.rotate);let s=e.yaw;const n=r.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=Ft(s,n,i.rotate)}copyFrom(e){le(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,le(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const r=this._lookAtOrientation(e.center,Vne);le(this.center,e.center),ge(oa,e.center,e.eye),Oc(oa,oa,r),Oc(Yv,e.up,r),this.distance=Me(oa),this.distance!==0&&(oa[0]/=this.distance,oa[1]/=this.distance,oa[2]/=this.distance),this.pitch=this._eyeUpToPitch(oa),this.yaw=this._eyeUpToYaw(oa,Yv),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const r=this._lookAtOrientation(this.center,Vne);Kh(r,r),this._axisAngleVec3(Yc.sideway,this.pitch-Math.PI/2,Yc.forward,oa),this._axisAngleVec3(Yc.upward,this.yaw,oa),this._axisAngleVec3(Yc.sideway,this.pitch-Math.PI/2,Yc.upward,Yv),this._axisAngleVec3(Yc.upward,this.yaw,Yv),ae(oa,oa,this.distance),Oc(oa,oa,r),Oc(Yv,Yv,r),e.center=this.center,e.eye=ge(oa,this.center,oa),e.up=Yv}_axisAngleVec3(e,r,i,s=i){const n=Math.cos(r),o=Math.sin(r);return ae(Xc,i,n),pt(Jl,e,i),ae(Jl,Jl,o),ae(Ky,e,(1-n)*_e(e,i)),me(s,me(s,Xc,Jl),Ky)}_lookAtOrientation(e,r=rs()){return this._upAtLookAt(e,Ky),pt(Xc,this.lookAtDirection,Ky),ve(Xc,Xc),Xc[0]===0&&Xc[1]===0&&Xc[2]===0&&le(Xc,Yc.sideway),pt(Jl,Ky,Xc),ve(Jl,Jl),r[0]=Xc[0],r[1]=Jl[0],r[2]=Ky[0],r[3]=Xc[1],r[4]=Jl[1],r[5]=Ky[1],r[6]=Xc[2],r[7]=Jl[2],r[8]=Ky[2],r}_upAtLookAt(e,r){return this.viewingMode===Be.Local?le(r,Yc.upward):ve(r,e)}_eyeUpToPitch(e){return Math.PI-IL(Yc.upward,e)}_eyeUpToYaw(e,r){const i=Ztt;return Math.abs(r[2])<.5?(le(i,r),e[2]>0&&ae(i,i,-1)):le(i,e),pt(Jl,i,Yc.upward),ve(Jl,Jl),IL(Yc.sideway,Jl,Yc.upward)}};const t4={desiredScreenFlow:2,minDuration:500,maxDuration:8e3};let Jtt=class zxe{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:t4.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new zxe(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,r,i){this.source!==e&&this.source.copyFrom(e),this.target!==r&&this.target.copyFrom(r),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow!=null?i.desiredScreenFlow:t4.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const r=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/r}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}},Ktt=class{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,r)=>e+r.time,0)}interpolateComponentsAt(e,r){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){if(r=this.segmentInterpolateComponentsAt(a,a.time===0?0:e/a.time,r),n.hasPan&&!isNaN(r.pan)&&isFinite(n.compared.pan)?r.pan=(i+l.compared.pan*r.pan)/n.compared.pan:r.pan=1,n.hasRotate&&!isNaN(r.rotate)&&isFinite(n.compared.rotate)?r.rotate=(s+l.compared.rotate*r.rotate)/n.compared.rotate:r.rotate=1,n.hasZoom&&!isNaN(r.zoom)&&isFinite(l.compared.targetZoom)){const c=r.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;r.zoom=(c-h)/(p-h)}else r.zoom=1;return r}e-=a.time,i+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(e,r,i){return e.interpolateComponentsAt(r,i)}},_9=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,r=e.compared,i=r.sourceZoom,s=r.targetZoom;this._zoomSign=i>s?1:-1,this._panPixelsAtSource=r.pan*e.source.pixelsPerPanAtZoom(i);const n=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=r.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;i&&(s&&(o=(r/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/r)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(i&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(i&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:i?this.zoomTime:s?this.panTime:0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,r=e*this._panPixelsAtSource;return Math.log(r*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const r=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(r*(r/i)**-e-r)/(i-r)}return e}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const r=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(r*e*this._time)-1))/(r*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,r){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),s=this._interpolateComponentsPan(e),n=this._interpolateComponentsRotate(e);return r?(r.zoom=i,r.pan=s,r.rotate=n):r={zoom:i,pan:s,rotate:n},r}};function Qtt(t,e,r){const i=e-t.compared.sourceZoom,s=t.halfWindowPanAtZoom(i);return-t.halfWindowSize*(r.ascensionFactor*Math.LN2*t.compared.pan+s)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*s)}function ert(t,e,r){const i=1/e,s=Math.log(t.compared.sourceZoom*i),n=1/t.desiredPixelFlow,o=1/Math.LN2,a=e-t.compared.sourceZoom,l=1/a,c=(r.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(a))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*i*n*o*l*c-t.halfWindowSize*s*n*o*l+t.halfWindowSize*s*n*o*c/(a*a)}function trt(t,e,r){const i=e-t.compared.sourceZoom,s=1/i,n=1/e,o=Math.log(t.compared.sourceZoom*n),a=(r.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(i))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(i*i)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function rrt(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function irt(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function srt(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function nrt(t,e,r){return-t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}function ort(t,e,r){return t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}function art(t,e,r){return-2*t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}function lrt(t,e,r){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-r.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function crt(t,e,r){const i=Math.log(e/t.compared.targetZoom),s=1/t.desiredPixelFlow,n=1/Math.LN2,o=-e+t.compared.targetZoom,a=1/o,l=(-t.halfWindowPanAtZoom(e)-r.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*i*s*n*a+t.halfWindowSize*i*s*n*l/(o*o)+t.halfWindowSize*s*n*a*l/e}function urt(t,e,r){const i=e-t.compared.targetZoom,s=1/i,n=1/e,o=Math.log(e/t.compared.targetZoom),a=(t.halfWindowPanAtZoom(e)+r.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(i*i)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function hrt(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function drt(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function prt(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function frt(t){const e=Math.LN2*t.compared.pan,r=t.compared.sourceZoom-t.compared.targetZoom,i=t.halfWindowPanAtZoom(r),s=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*i);return t.compared.sourceZoom<=t.compared.targetZoom?s*(e-i):s*(e+i)}function mrt(t,e){let r=grt(t,e);const i={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},s=i.ascensionFactor===0,n=i.descensionFactor===0,o=s?rrt:Qtt,a=s?irt:ert,l=s?srt:trt,c=n?hrt:lrt,h=n?drt:crt,p=n?prt:urt,f=E=>o(t,E,i)+nrt(t,E,i)+c(t,E,i),m=E=>a(t,E,i)+ort(t,E,i)+h(t,E,i),y=E=>l(t,E,i)+art(t,E,i)+p(t,E,i);let _=f(r);const b=frt(t);let x;const T=e.maximumIterations||20,S=e.maximumDistance!=null?e.maximumDistance:1/0;for(x=0;x<T;x++){const O=(m(r)+1e-6)/y(r);if(isNaN(O)||r>=S&&O<0){if(!isFinite(S))return null;r=S,_=f(r);break}if(r-=O,r<t.compared.sourceZoom||r<t.compared.targetZoom)return null;const R=f(r);if(Math.abs(R-_)/_<=.005)break;_=R}return _>b*(1-.3)||r<t.compared.sourceZoom||r<t.compared.targetZoom?null:r}function grt(t,e){const r=Math.max(t.compared.sourceZoom,t.compared.targetZoom),i=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return i<r?e.maximumDistance!=null?r+(e.maximumDistance-r)/2:1.5*r:e.maximumDistance?Math.min(e.maximumDistance,i):i}let yrt=class extends Ktt{constructor(e,r){super(),this._preallocSegments=[new _9,new _9,new _9],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,r)}update(e,r){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;r&&r.apex&&(i=mrt(e,r.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i==null?this._updateWithoutApex():this._updateWithApex(i,r==null?void 0:r.apex)}segmentInterpolateComponentsAt(e,r,i){return i=e.interpolateComponentsAt(r,i),e===this._ascensionSegment?i.zoom=dJ(i.zoom):e===this._descensionSegment&&(i.zoom=b6(i.zoom)),i}_updateWithApex(e,r){const[i,s,n]=this._preallocSegments,o=(r==null?void 0:r.ascensionFactor)??.5,a=Math.min(1-o,(r==null?void 0:r.ascensionFactor)!=null&&r.descensionFactor!=null?r.descensionFactor:.5),l=1-o-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*o,i.definition.compared.rotate=this.definition.compared.rotate*o,i.update(),this._ascensionSegment=i,this.segments.push(i),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=e,s.definition.compared.targetZoom=e,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const _rt={zoom:0,pan:0,rotate:0};let vrt=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=0,this.definition=new Jtt(e),this.path=new yrt}update(e,r,i){this.definition.update(e,r,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(vde(isFinite(this.path.time)?this.path.time:0),i),this._easing=i.easing?i.easing:this._time>=1e3?kxe:sP}cameraAt(e,r){r=r||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,_rt);return r.interpolate(this.definition.source,this.definition.target,i),r}_normalizedEasing(e){const r=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-r)/(i-r)}_applyTimeSettings(e,r){const i=r.speedFactor!=null?r.speedFactor:1;r.duration!=null?e=r.duration:r.speedFactor!=null&&(e=e/i);const s=r.minDuration!=null?r.minDuration:t4.minDuration/i,n=r.maxDuration!=null?r.maxDuration:t4.maxDuration/i;return Math.min(Math.max(s,e),n)}};const brt=M();let wrt=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=0,this._animation=new vrt(()=>new kne(e)),this._current=new kne(e)}update(e,r,i){const s=this._animation.definition.source,n=this._animation.definition.target,o=ge(brt,r.center,e.center),a=Me(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),le(s.lookAtDirection,o),le(n.lookAtDirection,o),s.copyFromRenderCamera(e),n.copyFromRenderCamera(r),this._current.copyFrom(s),this._animation.update(s,n,i),this.currentTime=0,e.almostEquals(r)&&(this.currentTime=this._animation.time)}cameraAt(e,r){return this._animation.cameraAt(e,this._current),r=r||new At,this._current.copyToRenderCamera(r),r}step(e,r){return this.finished||(this.currentTime=this.currentTime+vde(e),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}};var ls;(function(t){t.Ready="ready",t.Rejected="rejected",t.Running="running",t.Stopped="stopped",t.Finished="finished"})(ls||(ls={}));let Ig=class extends Te{constructor(e){super(e),this.state=ls.Ready}get active(){return this.state===ls.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ls.Stopped,!0)}finishController(){this.state=ls.Finished}get steppingFinished(){return!1}};u([d({constructOnly:!0})],Ig.prototype,"view",void 0),u([d({readOnly:!0})],Ig.prototype,"active",null),u([d()],Ig.prototype,"state",void 0),u([d({readOnly:!0})],Ig.prototype,"isInteractive",null),Ig=u([P("esri.views.3d.state.controllers.CameraController")],Ig);let B3=class extends Ig{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(qr()),this._asyncResult=null),this.state===ls.Finished||this.state===ls.Stopped?(z4(e),this.state===ls.Finished?e.resolve():e.reject(qr())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ls.Running,v(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!v(this.viewAnimation)||this.state!==ls.Ready&&this.state!==ls.Running||(this.viewAnimation.state===TE.State.FINISHED?this.finish():this.viewAnimation.state===TE.State.STOPPED&&(this.state=ls.Stopped))}onControllerEnd(){v(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===ls.Finished?this.viewAnimation.finish():this.state===ls.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ls.Finished?this._asyncResult.resolve():this._asyncResult.reject(qr()))}finish(){this.finishController()}};B3=u([P("esri.views.3d.state.controllers.AnimationController")],B3);let Bg=class extends B3{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new wrt(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new TE}get isInteractive(){return this.mode==="interaction"}begin(e,r){this._hasTarget=!0;const i=this.animationSettings(r);kI.copyFrom(this.view.state.camera);const s=Qh(this.view.state.viewingMode);this.intersectionHelper.intersectRay(kI.ray,s,zne)&&(kI.center=zne),this.animation.update(kI,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,r){this._hasTarget&&this.animation.step(e,r)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?jtt[e.easing]:e.easing}}};u([d({constructOnly:!0})],Bg.prototype,"mode",void 0),u([d({readOnly:!0})],Bg.prototype,"isInteractive",null),Bg=u([P("esri.views.3d.state.controllers.PointToPointAnimationController")],Bg);const kI=new At,zne=M();function w6(t=Trt){return[t[0],t[1],t[2],t[3]]}function G3(t,e){return xrt(t[0],t[1],t[2],e,iY.get())}function xrt(t,e,r,i,s=w6()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function vJ(t,e,r){return pt(r,t,e),ve(r,r),r[3]=nY(t,e),r}const Trt=[0,0,1,0];function Bxe(t,e,r){return Srt(t,t.screenToRender(e,He.get()),r)}function Srt(t,e,r){const i=zn(He.get(),e);if(i[2]=0,!t.unprojectFromRenderScreen(i,r.origin))return null;const s=zn(He.get(),e);s[2]=1;const n=t.unprojectFromRenderScreen(s,He.get());return C(n)?null:(ge(r.direction,n,r.origin),r)}function dC(t,e,r){return bJ(t,t.screenToRender(e,He.get()),r)}function bJ(t,e,r){le(r.origin,t.eye);const i=ce(He.get(),e[0],e[1],1),s=t.unprojectFromRenderScreen(i,He.get());return C(s)?null:(ge(r.direction,s,r.origin),r)}function wJ(t,e,r,i){const s=dC(e,r,Ert);return Rv(t,s,i)}const Ert=no();var RE;(function(t){t[t.Ellipsoid=0]="Ellipsoid",t[t.Silhouette=1]="Silhouette"})(RE||(RE={}));const Gxe=30,r4=[1,3e8],x6=80,jxe=8,Hxe=200,qxe=1508e5,Wxe=5,Xxe=50,Crt=5,Art=10,v9=90,px={exclude:new Set([f_])};function hw(t,e,r){return r[0]=e[0]/(t.fullWidth/t.pixelRatio),r[1]=e[1]/(t.fullHeight/t.pixelRatio),r}function IH(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function mv(t,e,r){const i=Fu(sY.get(),r[3],r);C(i)||Ife(i,Uu)||(ge(ci,t.eye,e),Xe(ci,ci,i),t.eye=me(ci,ci,e),ge(ci,t.center,e),Xe(ci,ci,i),t.center=me(ci,ci,e),t.up=Xe(ci,t.up,i))}function Rrt(t,e,r,i){return ax(t,Bxe(e,r,SJ),i)}function $H(t,e,r,i){return ax(t,dC(e,r,SJ),i)}function xJ(t,e,r,i){const s=He.get();let n=1-r;ge(s,e,t.eye);const o=Me(s);let a=o*(1-n);n>=0&&a<i&&(a=i,n=-(a-o)/o),Math.abs(o-a)<1e-6||(ae(s,s,n),t.eye=me(ci,t.eye,s),t.center=Qs(ci,t.center,e,n))}function Yxe(t,e,r){e.getScreenCenter(Bne),wJ(t,e,Bne,ci)&&(e.center=ci);const i=e.distance,s=i*r;if(Math.abs(i-s)<1e-6)return;const n=ae(He.get(),e.viewForward,s);e.eye=ge(ci,e.center,n)}const Bne=cs();function b9(t,e){ce(e,0,0,0);for(const r of t)me(e,e,r);ae(e,e,1/t.length)}function XD(t,e,r,i){return Math.sin(t/Me(e))*(r+i.radius)}function Gne(t,e,r,i){return XD(Math.PI/2,e,r,i)+(t-Math.PI/2)}var oo;(function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"})(oo||(oo={}));const jne={Elevation:3e4,Angle:jt(16)},zI={Pole:.95,Angle:jt(18),Tilt:45},Zxe=jt(80);function Jxe(t,e,r,i,s,n){const o=M(),a=cn();let l=!0,c=!0;return t.intersectScreen(r,o,n)?a[3]=Me(o):(c=!1,e.aboveGround&&s!==RE.Ellipsoid?a[3]=Math.max(Me(e.center),.9*i.radius):a[3]=Me(e.eye)-e.relativeElevation,s===RE.Silhouette?j3(a,e,r,o):l=wJ(a,e,r,o)),{sphere:a,scenePickPoint:l?o:null,hasGeometryIntersection:c}}function T6(t,e,r){return Me(t.eye)-r.radius>jne.Elevation?oo.Horizontal:(dC(t,e,Kne),-Math.sign(t.relativeElevation)*(.5*Math.PI+nY(t.eye,Kne.direction))<jne.Angle?oo.Vertical:oo.Horizontal)}function Kxe(t,e,r){ge(w9,r,e),t.eye=ge(ci,t.eye,w9),t.center=ge(ci,t.center,w9)}const w9=M();function j3(t,e,r,i){const s=dC(e,r,SJ);return!C(s)&&(JE(t,s,BI),Rv(t,s,i)?!(Vn(BI,s.origin)<Vn(i,s.origin))||(le(i,BI),!1):(ge(Ux,e.eye,e.center),ve(Ux,Ux),vye(Ux,-_e(ve(Ux,Ux),BI),Hne),ax(Hne,s,i),!1))}const BI=M(),Ux=M(),Hne=Br();function Qxe(t,e,r,i,s,n){let o=0;if(pt(n4,t,e),ge(qI,t,e),Me(t)<=s||!i.aboveGround){pt(r,qI,i.eye);const a=_e(t,e)/(Me(t)*Me(e));if(a<.9999)o=An(a);else{const c=Me(pt(M(),t,e))/(Me(t)*Me(e));o=Hh(c)}const l=Math.cos(ye(tv.normalize(jt(n)),0,Zxe));o=-o-Math.max(0,Me(e)-s)/(l*s)}else ge(qne,i.eye,i.center),pt(r,qI,qne),o=-Me(qI)/s;return ve(r,r),ae(r,r,Me(n4)),o}const qne=M();function Wne(t,e,r,i){let s,n;const o=Math.cos(ye(tv.normalize(jt(i)),0,Zxe));return s=e>r?-(e-r)/(o*r):e<-r?Math.PI-(e+r)/(o*r):An(e/r),n=t>r?-(t-r)/(o*r):t<-r?Math.PI-(t+r)/(o*r):An(t/r),(n-s)*r}function Ort(t,e,r,i,s,n,o,a,l,c){const h=Wne(t[2],e[2],n[3],a),p=l?Wne(t[0],e[0],n[3],180):e[0]-t[0],f=Math.sin(o)*p-Math.cos(o)*h,m=Math.cos(o)*p+Math.sin(o)*h;ve(ci,s);const y=l?f/Math.sqrt(Math.abs(n[3]**2-_e(r,ci)**2)):f/n[3],_=m/Math.sqrt(Math.abs(n[3]**2-_e(r,i)**2));ar(c,y,_)}function eTe(t,e,r,i,s,n,o,a,l,c){pt(n4,t,e),$7(n.up,n.eye,GI,jI,HI),$7([0,0,1],n.eye,Zg,W_,sTe),le(r,W_),le(i,Zg),ve(r,r),ae(r,r,Me(n4)),Fte(t,ve(jI,jI),ve(HI,HI),ve(GI,GI),Xne),Fte(e,jI,HI,GI,Yne),Ort(Xne,Yne,t,Zg,W_,o,a,l,c,s)}function Mrt(t,e,r,i,s,n,o){Fu(i4,s,i),Fu(s4,o,n),ys(Y2,i4,s4),ge(e,t,r),Xe(e,e,Y2),me(e,e,r)}function tTe(t,e,r,i,s,n){Fu(i4,i,r),Fu(s4,n,s),ys(Y2,i4,s4),ge(ci,t.eye,e),Xe(ci,ci,Y2),t.eye=me(ci,ci,e),ge(ci,t.center,e),Xe(ci,ci,Y2),t.center=me(ci,ci,e),ge(ci,t.up,e),Xe(ci,ci,Y2),t.up=me(ci,ci,e)}function TJ(t,e,r,i,s,n){return(Math.abs(i)>Math.PI-zI.Angle||Math.abs(i)<zI.Angle)&&(Math.abs(t[2])<r*zI.Pole||Math.abs(e)>r)&&n.aboveGround&&s<zI.Tilt}function rTe(t,e,r,i,s,n){if(n)vJ(r,i,Zne),mv(e,t,Zne);else{const o=Qxe(r,i,Jne,e,t[3],s);mv(e,t,G3(Jne,o))}}function iTe(t,e,r,i,s,n,o){const a=o?20:1,l=1e-12;let c,h;le(Zv,i),WI.copyFrom(e);for(let p=0;p<a&&Vn(r,Zv)>l&&(c=Vn(r,Zv),eTe(r,Zv,W_,Zg,XC,WI,t,s,n,o),tTe(WI,t,Zg,XC[1],W_,XC[0]),Mrt(Zv,Zv,t,Zg,XC[1],W_,XC[0]),h=Vn(r,Zv),h<c||p===0);p++)e.copyFrom(WI)}function Prt(t,e,r,i,s,n,o){TJ(r,_e(e.up,r),t[3],-tv.normalize(jt(s)),n,e)?iTe(t,e,r,i,-tv.normalize(jt(s)),n,o):rTe(t,e,r,i,n,o)}function Irt(t,e,r,i,s,n){const{eye:o}=t;$7([0,0,1],o,Zg,W_,sTe);const a=e.translation[0]*r.pan,l=s.mode==="zoom"?0:e.translation[1]*r.pan,c=Math.max(Math.sqrt(Math.abs(1-_e(t.center,Zg)**2/Me(t.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(Mc(i.pan.matrix,i.pan.matrix,h,Zg),i.pan.enabled=!0,s.mode){case"pan":Mc(i.pan.matrix,i.pan.matrix,p,W_),i.pan.enabled=!0;break;case"zoom":i.zoom=-e.translation[1]*r.zoom}}function $rt(t,e,r,i,s){const{eye:n,viewRight:o}=t,a=pt(He.get(),o,n),l=e.translation[0]*r.pan;switch(l!==0&&(Mc(i.pan.matrix,i.pan.matrix,-l,a),i.pan.enabled=!0),s.mode){case"pan":{const c=e.translation[1]*r.pan;c!==0&&(Mc(i.pan.matrix,i.pan.matrix,c,o),i.pan.enabled=!0);break}case"zoom":i.zoom=-e.translation[1]*r.zoom}}function Lrt(t,e,r,i,s,n,o,a,l){TJ(t.center,_e(t.up,t.center),Me(t.center),-tv.normalize(jt(n)),o,e)?Irt(e,r,i,a,l,-tv.normalize(jt(s))):$rt(e,r,i,a,l)}const Zg=M(),W_=M(),sTe=M(),GI=M(),jI=M(),HI=M(),Xne=M(),Yne=M(),XC=Ke(),Zne=w6(),i4=Ie(),s4=Ie(),Y2=Ie(),Zv=M(),ci=M(),qI=M(),WI=new At,n4=M(),Jne=M(),SJ={origin:M(),direction:M()},Kne={origin:M(),direction:M()},Qne=.6,x9=4,Drt=60;let o4=class extends Bg{constructor(){super(...arguments),this._zoomLocation=M(),this._tmpCamera=new At,this._tmpViewDir=M(),this._tmpRayDir={origin:M(),direction:M()},this._targetOnSphere=M(),this._tmpCenter=M(),this._constraintOptions={selection:Ui.ALL_EXCEPT_COLLISION,interactionType:or.ZOOM,interactionFactor:null,interactionStartCamera:new At,interactionDirection:null,tiltMode:ho.TUMBLE},this._sphere=cn()}initialize(){this._intersector=Qh(this.view.state.viewingMode)}zoomStep(e,r){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s));let n=!1,o=!1;this.intersectionHelper.intersectScreen(r,this._zoomLocation,this.view.map.ground.opacity===0?px:{})&&(n=e>0,o=!0),this._tmpCamera.copyFrom(i.camera),n?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,r,o),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:sP}}_updateCamera(e,r,i,s,n){const o=Yr(this.view.spatialReference),a=T6(e,s,o),l=Math.abs(this.view.camera.position.z);ve(YI,e.eye),ae(YI,YI,-1),dC(e,s,this._tmpRayDir),ve(this._tmpRayDir.direction,this._tmpRayDir.direction);const c=ye(Math.min(jxe,1/Math.abs(_e(YI,this._tmpRayDir.direction)))*l,Hxe,qxe);if(a===oo.Horizontal){let h=Qne**r;this._sphere[3]=Me(i),ge(this._tmpViewDir,e.center,e.eye);const p=Math.min(Me(this._tmpViewDir),c);let f=p*h;if(h<=1&&f<x9&&(f=x9,h=f/p),Math.abs(p-f)<1e-6)return;const m=Me(e.center);if(this._sphere[3]!==m){const y=this._sphere[3]+h*(m-this._sphere[3]);e.center=ae(XI,e.center,y/m)}ae(this._tmpViewDir,this._tmpViewDir,-h),e.eye=me(XI,e.center,this._tmpViewDir),Ws(this.view,e,this._constraintOptions),Vn(i,e.center)>1e-12&&wJ(this._sphere,e,s,this._targetOnSphere)&&Prt(this._sphere,e,i,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=Qne**Math.abs(r);const p=r>0?1:-1;ge(this._tmpViewDir,i,e.eye);const f=Me(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,s[0],s[1],this.view.state.camera,Drt);let y=v(m)?m:c;y=n&&r>0?Math.min(y,f):y,ae(this._tmpRayDir.direction,this._tmpRayDir.direction,y),me(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let _=y*h;const b=Math.max(x9,1.01*e.nearFar[0]);if(r>0&&_<b&&(_=b,h=_/y),Math.abs(y-_)<1e-6)return;ae(this._tmpRayDir.direction,this._tmpRayDir.direction,p*(1-h)),e.eye=me(XI,e.eye,this._tmpRayDir.direction),e.center=me(XI,e.center,this._tmpRayDir.direction)}hC(this.view,e)}};o4=u([P("esri.views.3d.state.controllers.global.ZoomStepController")],o4);const XI=M(),YI=M(),Nrt=.6,Frt=4,Urt=60;let a4=class extends Bg{constructor(){super(...arguments),this._zoomLocation=M(),this._tmpCamera=new At,this._tmpRayDir=M(),this._tmpCenter=M(),this._constraintOptions={selection:Ui.ALL,interactionType:or.ZOOM,interactionFactor:null,interactionStartCamera:new At,interactionDirection:null,tiltMode:ho.TUMBLE}}zoomStep(e,r){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s)),this._tmpCamera.copyFrom(i.camera);const n=Qh(this.view.state.viewingMode);let o=!1;e>0?(o=this.intersectionHelper.intersectScreenFreePointFallback(r,this._zoomLocation,this.view.map.ground.opacity===0?px:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:le(this._zoomLocation,this._tmpCamera.center);const a=Nrt**e;let l=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,r[0],r[1],this.view.state.camera,Urt);ge(ZI,this._tmpCamera.eye,this._zoomLocation),ve(ZI,ZI);const c=ye(Math.min(jxe,1/Math.abs(_e(Vrt,ZI)))*Math.abs(this.view.camera.position.z),Hxe,qxe);if(l=v(l)?l:c,l){const h=M();ge(h,this._zoomLocation,this._tmpCamera.eye),(l<Me(h)||!o)&&(ve(h,h),me(this._zoomLocation,this._tmpCamera.eye,ae(h,h,l)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:sP}}_updateCamera(e,r,i){ge(this._tmpRayDir,i,e.eye);const s=Me(this._tmpRayDir);let n=s*r;const o=r<=1,a=Math.max(Frt,1.01*e.nearFar[0]);n!==0&&(o&&n<a&&(n=a,r=n/s),Math.abs(s-n)<1e-6||(ae(this._tmpRayDir,this._tmpRayDir,r),e.eye=ge(eoe,i,this._tmpRayDir),e.center=Qs(eoe,e.center,i,1-r),Ws(this.view,e,this._constraintOptions)))}};a4=u([P("esri.views.3d.state.controllers.local.ZoomStepController")],a4);const eoe=M(),Vrt=$e(0,0,1),ZI=M();function krt(t,e){switch(e){case"primary":return t.pointerType==="touch"||t.button===0;case"secondary":return t.pointerType!=="touch"&&t.button===2;case"tertiary":return t.pointerType!=="touch"&&t.button===1}}function EJ(t,e){if(t.pointerType==="touch")return!1;switch(e){case"primary":return t.button===0;case"secondary":return t.button===2;case"tertiary":return t.button===1}}let zrt=class extends Fo{constructor(e,r){super(!0),this._view=e,this.registerIncoming("double-click",r,i=>this._handleDoubleClick(i))}_handleDoubleClick(e){const r=e.data;if(krt(r,"primary")){const i=this._view.state.isGlobal?new o4({view:this._view,mode:"animation"}):new a4({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),cs(r.x,r.y)),e.stopPropagation()}}};function Brt(t,e,r){return t===Be.Global?new jrt(r):new Grt(e,r)}let Grt=class{constructor(e,r){this._elevationProvider=e,this._referenceEllipsoid=Yr(r),this._unitInMeters=al(r,this._referenceEllipsoid.metersPerDegree)}compute(e,r,i,s,n){var S;n||(n={near:0,far:0});let o=e[2]*this._unitInMeters;const a=o,l=o-s,c=(S=this._elevationProvider)==null?void 0:S.visibleElevationBounds;c&&(o=l>=0?a-this._unitInMeters*c.min:this._unitInMeters*c.max-a);const h={x:(i=v(i)?i:new Hr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},p=Math.max(h.x,h.y,h.z);ge(Jv,r,e),Vx[0]=Jv[0]>0?i.xmax:i.xmin,Vx[1]=Jv[1]>0?i.ymax:i.ymin,Vx[2]=Jv[2]>0?p/2:-p/2,ge(Vx,Vx,e),ve(Jv,Jv);const f=1.1*_e(Vx,Jv)*this._unitInMeters,m=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),y=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),_=y*Wrt*this._unitInMeters,b=y*Xrt*this._unitInMeters,x=ye((o-b)/(_-b),0,1)**3,T=Math.min(Ft(m,f,x),m)*Math.max(Math.log(Math.abs(l)),1);return nTe(Math.min(T,Math.max(34064e4,p))/this._unitInMeters,Hrt,this._unitInMeters,n)}},jrt=class{constructor(e){this._referenceEllipsoid=Yr(e)}compute(e,r,i,s,n){n||(n={near:0,far:0});const o=Me(e),a=o-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,s),c=Math.abs(a-s),h=Math.max(c,Math.abs(a)),p=Math.sqrt(h*(h+2*l)),f=o+this._referenceEllipsoid.radius;return nTe(1.2*Ft(p,f,DZ(h)),ye(2e4-(Math.log(h)-7.983)/9.011*19e3,1e3,2e4),1,n)}};function nTe(t,e,r,i){const s=qrt/r;return t/e>s?(i.far=t,i.near=i.far/e):(i.near=s,i.far=i.near*e),i}const Hrt=2e4,qrt=2,Wrt=.001,Xrt=1e-4,Vx=M(),Jv=M();let YD=class extends Te{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const r=this.view.state.camera;v(e.spatialReference)&&Jye(this.view,r,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>hC(this.view,e,Fh.EYE_AND_CENTER))}};u([d({constructOnly:!0})],YD.prototype,"view",void 0),YD=u([P("esri.views.3d.state.ElevationCollisionConstraint")],YD);let kR=class extends Te{constructor(e){super(e),this.nearFarHeuristic=Brt(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([ne(()=>{var e,r,i,s;return[(r=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:r.near,(s=(i=this.view.constraints)==null?void 0:i.clipDistance)==null?void 0:s.far]},()=>this._clipDistanceNearFarChanged()),ne(()=>{var e,r;return(r=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:r.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),ne(()=>this.view.renderDataExtent,()=>this._updateNearFar(),ri),ne(()=>{var e,r,i,s;return[(r=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:r.min,(s=(i=this.view.constraints)==null?void 0:i.altitude)==null?void 0:s.max]},()=>this._updateAltitude(),ri),ne(()=>{var e,r;return(r=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:r.max},()=>this._updateTiltMax(),ri),ne(()=>{var e,r;return(r=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:r.mode},()=>this._updateTilt(),ri),ne(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),ri),ne(()=>{var e,r,i,s,n,o;return[(i=(r=(e=this.view.map)==null?void 0:e.ground)==null?void 0:r.navigationConstraint)==null?void 0:i.type,(o=(n=(s=this.view.state)==null?void 0:s.constraints)==null?void 0:n.collision)==null?void 0:o.enabled]},()=>this._updateCollision(),ri)]),this.view.state.isLocal&&this.addHandles(ne(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),kt)),this._updateNearFar(),this.view.state.viewingMode!==Be.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new YD({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var r;const e=(r=this.view.constraints)==null?void 0:r.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(i=>this._updateCameraNearFarManual(i,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const r=this.view.constraints&&this.view.constraints.clipDistance;(r?r.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,r):this._updateCameraNearFarAuto(e,r)}_updateCameraNearFarAuto(e,r){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,L5(this.view,e.eye),e),r&&r.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,r){r&&(e.near=r.near,e.far=r.far)}_updateCollision(){var s,n,o;const e=(o=(n=(s=this.view.map)==null?void 0:s.ground)==null?void 0:n.navigationConstraint)==null?void 0:o.type,r=!e||e==="stay-above",i=this.view.state.constraints.collision;if(r!==i.enabled){i.enabled=r,r&&this._reapplyConstraints(Ui.COLLISION);const a=this.view.constraints&&this.view.constraints.tilt;a&&a.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Be.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const r=this.view.state.constraints;r.tilt=r.createConstantMaxTilt(jt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const r=this.view.state.constraints;if(r.tilt){const i=r.tilt(this.view.state.camera.distance).max;e.autoUpdate(ol(i))}}_updateLocalSurfaceDistance(e){if(C(e))return;let r=Math.max(e.width,e.height);if(r<=0)return;e.zmax!=null&&e.zmin!=null&&(r=Math.max(r,e.zmax-e.zmin));const i=this.view.state,s=3*r/Math.atan(i.camera.fov/2);s!==i.constraints.distance&&(i.constraints.distance=s)}_reapplyConstraints(e=Ui.ALL){this.view.state.updateCamera(r=>Ws(this.view,r,{selection:e,interactionType:or.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:ho.TUMBLE}))}};u([d({constructOnly:!0})],kR.prototype,"view",void 0),u([d({readOnly:!0})],kR.prototype,"surfaceCollisionConstraint",void 0),kR=u([P("esri.views.3d.state.ConstraintsManager")],kR);let v_=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}constructor(e){this.renderCoordsHelper=e,this.frustum=w3(),this._points=xye(),this.lines=new Array(12),this._origin=M(),this._direction=M(),this._altitude=null;for(let r=0;r<12;r++)this.lines[r]={origin:null,direction:M(),endpoint:null}}update(e){Tye(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),le(this._origin,e.eye),le(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let r=0;r<this._points.length;r++)le(this._points[r],e[r]);Sye(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return I_(this.frustum,e)}intersectsRay(e){return m6e(this.frustum,e)}intersectsLineSegment(e,r){return g6e(this.frustum,e,r)}intersectsPoint(e){return Eye(this.frustum,e)}_updateLines(){const e=this._points;for(let r=0;r<4;r++){const i=r+4;T9(this.lines[r],e[r],e[i]),T9(this.lines[r+4],e[r],r===3?e[0]:e[r+1]),T9(this.lines[r+8],e[i],r===3?e[4]:e[i+1])}}};function T9(t,e,r){t.origin=e,t.endpoint=r,my(t.direction,e,r)}v_.planePointIndices=y6e,v_.nearFarLineIndices=[[nt.NEAR_BOTTOM_LEFT,nt.FAR_BOTTOM_LEFT],[nt.NEAR_BOTTOM_RIGHT,nt.FAR_BOTTOM_RIGHT],[nt.NEAR_TOP_RIGHT,nt.FAR_TOP_RIGHT],[nt.NEAR_TOP_LEFT,nt.FAR_TOP_LEFT]];let DO=class extends Ig{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e),this._handles=new Zr}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ls.Running,this._handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this._handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){v(e.spatialReference)&&!Jye(this.view,this.desiredCamera,e.extent,e.spatialReference)||this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),hC(this.view,e,Fh.EYE_AND_CENTER)||this.constraintEnabled||(this.state=ls.Stopped)})}};u([d({constructOnly:!0})],DO.prototype,"desiredCamera",null),DO=u([P("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],DO);let Yrt=class{constructor(e,r,i){this.target=e,this.options=r,this.view=i,this.state="pending",this._animationController=null,this._promise=new Promise((s,n)=>{this._resolveCallback=s,this._rejectCallback=n;const o=new AbortController;v(this.options.signal)&&ba(this.options.signal,()=>{this.abort()}),this._abortController=o,this.waitForReady()})}then(e,r){return this._promise.then(e,r)}catch(e){return this._promise.catch(e)}resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&v(this._animationController)&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(qr())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await f3(()=>this.view.ready,this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,h8e(this.view,this.target,this._abortController.signal).then(e=>{if(this.state==="finished")return;const r=e?this._getCameraFromViewpoint(e):null;if(!C(r))if(this.options.animate){if(C(this._animationController))return;this.startAnimation(r,this._animationController)}else this.view.stateManager.setStateCamera(r.camera,{applyConstraints:!r.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},e=>{this.reject(e)}))}_getCameraFromViewpoint(e){var n;const r=!!(this.target instanceof Vc&&this.target.camera||this.target instanceof qh),i=e.camera;if(C(i))return null;if(!this.view.stateManager.isCompatible(i)){const o=i.position,a=o&&o.spatialReference,l=a?a.wkid:"none",c=(n=this.view.spatialReference)==null?void 0:n.wkid;return this.reject(new j("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${c})`,{camera:i})),null}const s=Cg(this.view,i);return C(s)?(this.reject(new j("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:r}}startAnimation(e,r){this.state="wait-for-animation-finish";const i=r.viewAnimation;if(C(i))return void this.reject(new j("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!r.active||C(r.viewAnimation)||r.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==r)return this.abort();let s;e.isFullySpecified?(s=new DO({view:this.view,desiredCamera:e.camera}),hC(this.view,e.camera,Fh.EYE_AND_CENTER)):Ws(this.view,e.camera),r.begin(e.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof Bg&&v(a.viewAnimation)&&a.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):v(r.viewAnimation)&&r.viewAnimation.target===e.viewpoint&&r.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(!C(this.view.state))switch(r.state){case ls.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case ls.Ready:case ls.Rejected:case ls.Running:case ls.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};i.when(n,a=>o(a)),r.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let e=null,r=null;const i=this.view.state.cameraController;return i instanceof Bg&&(i.updateStateFromViewAnimation(),i.active&&(e=i,r=e.viewAnimation)),e!=null||(e=new Bg({view:this.view,mode:"animation"}),r=e.viewAnimation,this.view.state.switchCameraController(e))?e:(v(r)&&r.stop(),this.reject(new j("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}},pn=class extends Te{get camera(){const e=this._get("camera");if(!this.ready)return e;const r=fE(this.view,this.view.state.camera,S9);return r&&e&&r.equals(e)?e:r.clone()}set camera(e){var r,i;this._updatePropertyBeforeReady("camera",e)||((r=this.view.elevationProvider)==null||r.enableElevationCache(!0),this.setStateCamera(Cg(this.view,e),{applyConstraints:!1})||se.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),(i=this.view.elevationProvider)==null||i.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const r=fE(this.view,this.view.state.contentCamera,S9);return r&&e&&r.equals(e)?e:r.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const r=Cg(this.view,e);C(r)?this.view.state.contentCamera=null:(this._updateElevation(r),this.view.state.contentCamera=r)}installContentCameraReset(e){if(this.removeHandles(E9),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const r=this.zoom,i=this.view.state.camera.distance**2,s=Ul(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([ne(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(E9),this.test.contentCameraResetState.clear())}),ne(()=>this.zoom,o=>{o!==void 0&&r!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(o-r)/2),Math.abs(o-r)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),ne(()=>this.view.state.camera,o=>{const a=Vn(s,o.center);this.test.contentCameraResetState.set("camera.center",a/i),a>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],E9),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var r;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():se.getLogger(this.declaredClass).error("#center=","Invalid center",e):se.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((r=this.view.spatialReference)==null?void 0:r.wkid)+")",e):se.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,r=r8e(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return v(r)?r:this._get("extent")}set extent(e){var r;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||se.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):se.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((r=this.view.spatialReference)==null?void 0:r.wkid)+")",e):se.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return $w(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||se.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,r=e.padding,i=e.pixelRatio,s=this._get("padding"),n=Math.round(r[cr.TOP]/i),o=Math.round(r[cr.RIGHT]/i),a=Math.round(r[cr.BOTTOM]/i),l=Math.round(r[cr.LEFT]/i);return s!=null&&s.top===n&&s.right===o&&s.bottom===a&&s.left===l?s:{top:n,right:o,bottom:a,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,JI),this.view.state.updateCamera(r=>r.padding=JI))}_paddingToArray(e,r,i){e?ti(i,e.top||0,e.right||0,e.bottom||0,e.left||0):ti(i,0,0,0,0);for(let s=0;s<4;s++)i[s]=Math.round(i[s]*r)}get screenCenter(){const e=this.padding;return Zh((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?u8e(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var r;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||se.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{const i=v(e.camera)?e.camera.position:e.targetGeometry,s=v(i)&&i.spatialReference;se.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(s?s.wkid:"none")+", view: "+((r=this.view.spatialReference)==null?void 0:r.wkid)+")",e)}else se.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?a8e(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||se.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}get _pixelRatio(){var e;return v(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRendering?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,(e=this.view)==null?void 0:e.qualitySettings.maximumPixelRatio)}get _rasterPixelRatio(){return v(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,r;return((r=(e=this.view)==null?void 0:e._stage)==null?void 0:r.renderer.isFeatureEnabled(Gs.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var r,i;const e=(i=(r=this.view)==null?void 0:r._stage)==null?void 0:i.renderer;return e&&(e.isFeatureEnabled(Gs.PhysicalPixelRendering,Tr.IDLE)||e.isFeatureEnabled(Gs.PhysicalPixelRendering,Tr.INTERACTING)||e.isFeatureEnabled(Gs.PhysicalPixelRendering,Tr.ANIMATING))}constructor(e){super(e),this._propertiesPool=new cy({frustum:v_},this),this._cameraSetByUser=!1,this._gotoOperation=null,this.constraintsManager=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._cameraChangeTime=0,this._updatingIgnoreRenderState=!1,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:r=>this._devicePixelRatioOverride=r,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},set updatingIgnoreRenderState(r){this.viewStateManager._updatingIgnoreRenderState=r},get updatingIgnoreRenderState(){return this.viewStateManager._updatingIgnoreRenderState||v(this.renderState)}}}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([an(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),ne(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,r)=>this._cameraChangedHandler(e,r),ri)]),ra(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([kS({prepare:()=>this._prepareFrame()}),ne(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(KI)}),an(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=Ve(this._propertiesPool)}init(){this.constraintsManager=new kR({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const r of e)this.set(r.name,r.value);if(!this._cameraSetByUser){const r=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;r&&this.isCompatible(r)?this._setInitialView(r):this.view.state.viewingMode===Be.Local&&this.addHandles(ra(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(KI),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),KI)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(KI),this.constraintsManager=Ve(this.constraintsManager))}async goTo(e,r){const i={animate:!0,...r};return v(this._gotoOperation)&&this._gotoOperation.abort(i.animate),this._gotoOperation=new Yrt(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation}debugSetCameraOnContent(){this.setStateCamera(cx(this.view),{applyConstraints:!1})}step(e){const r=this.view.state,i=r==null?void 0:r.cameraController;i&&(r.updateCamera(s=>i.stepController(e,s)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){v(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,r=[];for(const{propertyName:i,overrides:s}of Jrt){const n=e.has(i),o=this._isOverridden(i);!n&&o&&r.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||o)&&s.forEach(a=>e.add(a))}return r}_setInitialView(e){if(C(e)||this._cameraSetByUser)return;if(e instanceof qh)return void this.setStateCamera(Cg(this.view,e),{applyConstraints:!1});if(e instanceof Vc){if(e.targetGeometry instanceof Hr){const n=yO(this.view,e.targetGeometry,0,.5,Jo.LOCKED);return void(v(n)&&this.setStateCamera(Cg(this.view,n),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},s=this._viewpointToCamera(e);return void this.setStateCamera(s,i)}const r=yO(this.view,e,0,.5,Jo.LOCKED);v(r)&&this.setStateCamera(Cg(this.view,r),{applyConstraints:!0})}_updatePropertyBeforeReady(e,r){return!this.ready&&(this._override(e,r),r&&Zrt.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!C(e)&&(e instanceof Vc?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof qh?this.isCompatible(e.position):e.spatialReference&&k_(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=Krt){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,r,i=Qy){const{heading:s,tilt:n}=this._getPreservingHeadingTilt(),o=x3(this.view,s,n,e,r,Jo.ADJUST);return C(o)?null:(i.copyFrom(this.view.state.camera),i.eye=o.eye,i.center=o.center,i.up=o.up,i)}_centerToCamera(e){const r=this.view.pointsOfInterest.centerOnContent;r.runTask();const i=r.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:r,tilt:i}=this._getPreservingHeadingTilt(),s=yO(this.view,e,r,i,Jo.ADJUST,S9);return s?Cg(this.view,s):null}_scaleToCamera(e){if(e==null)return null;const r=this.view.pointsOfInterest.centerOnContent;r.runTask();const i=r.renderLocation,s=r.location.latitude;if(s==null)return null;const n=TY(this.view,e,s);return this._centerPointAtDistanceToCamera(i,n)}_zoomToCamera(e){return this._scaleToCamera(g0e(this.view,e))}_viewpointToCamera(e){return Cg(this.view,EY(this.view,e))}setStateCamera(e,r){return!(C(e)||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,r.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{r.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),r.applyConstraints&&Ws(this.view,i)}),r.applyConstraints||(this.view.state.cameraController=new DO({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:r}=this.view;if(!e||!r)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._pixelRatio,s=Math.round(e.clientWidth*i),n=Math.round(e.clientHeight*i);if(s!==0&&n!==0&&(r.width===s&&r.height===n||(r.width=s,r.height=n),this.view.state)){const o=this.view.state.camera;o.fullWidth===s&&o.fullHeight===n&&o.pixelRatio===i||(Qy.copyFrom(o),Qy.pixelRatio!==i&&(this._paddingToArray(this.padding,i,JI),Qy.padding=JI),Qy.fullWidth=s,Qy.fullHeight=n,Qy.pixelRatio=i,this.view.state.camera=Qy),this._updateViewState()}}_updateElevation(e){var n;const r=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=((n=this.view.renderCoordsHelper)==null?void 0:n.getAltitude(e.eye))??0,s=r?L5(this.view,e.eye):0;e.relativeElevation=i-s}_updateViewState(){v(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Tr.ANIMATING:this.view.interacting?this.view.state.mode=Tr.INTERACTING:(this.view.state.mode===Tr.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=Qrt?this.view.state.mode=Tr.INTERACTING:this.view.state.mode=Tr.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio,this.view.state.contentPixelRatio=Math.min(this._pixelRatio,this.view.qualitySettings.maximumPixelRatio)}_cameraChangedHandler(e,r){e&&r&&e.almostEquals(r)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};u([d({type:qh,dependsOn:["view.state.camera","ready"]})],pn.prototype,"camera",null),u([d({type:qh,dependsOn:["view.state.contentCamera","ready"]})],pn.prototype,"contentCamera",null),u([d({type:_t})],pn.prototype,"center",null),u([d({type:Hr})],pn.prototype,"extent",null),u([d({readOnly:!0})],pn.prototype,"frustum",null),u([d({readOnly:!0})],pn.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],pn.prototype,"ready",void 0),u([d({type:Number})],pn.prototype,"scale",null),u([d()],pn.prototype,"padding",null),u([d({readOnly:!0})],pn.prototype,"screenCenter",null),u([d({constructOnly:!0})],pn.prototype,"view",void 0),u([d({type:Vc})],pn.prototype,"viewpoint",null),u([d({type:Number})],pn.prototype,"zoom",null),u([d({readOnly:!0})],pn.prototype,"_pixelRatio",null),u([d({readOnly:!0})],pn.prototype,"_rasterPixelRatio",null),u([d({readOnly:!0})],pn.prototype,"_usePhysicalPixelRendering",null),u([d({readOnly:!0})],pn.prototype,"_usePhysicalPixelRenderingAny",null),u([d()],pn.prototype,"_windowDevicePixelRatio",void 0),u([d()],pn.prototype,"_devicePixelRatioOverride",void 0),pn=u([P("esri.views.3d.state.ViewStateManager")],pn);const Zrt=["camera","viewpoint","extent","scale","center","zoom"],Jrt=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Krt={heading:0,tilt:0},S9=new qh,Qy=new At,JI=nr(),KI="pending-initial-view",E9="content-camera-reset",Qrt=300,toe=100;let Wf=class extends Ig{constructor(){super(...arguments),this.startCamera=new At,this.currentCamera=new At,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<toe}stepController(e,r){r.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(r)}onControllerStart(e){this.state=ls.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),toe),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};u([d({readOnly:!0})],Wf.prototype,"isInteractive",null),u([d()],Wf.prototype,"_lastInteraction",void 0),Wf=u([P("esri.views.3d.state.controllers.InteractiveController")],Wf);var vc;(function(t){t[t.CENTER=0]="CENTER",t[t.EYE=1]="EYE"})(vc||(vc={}));let NO=class extends Wf{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=vc.CENTER,this._rotScale=0,this._lastPoint=Ke(),this._tmpWorldUp=M(),this._tmpViewDir=M(),this._tmpRotCurPoint=Ke(),this._tmpTransf=Ie(),this._tmpAxis=M(),this._tmpPivotPoint=M(),this._pivotPos=M(),this._constraintOptions={selection:Ui.ALL,interactionType:or.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ho.TUMBLE}}initialize(){this._rotScale=this.pivot===vc.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case vc.EYE:le(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=or.LOOK_AROUND,this._constraintOptions.tiltMode=ho.LOOK_AROUND,this._constraintOptions.selection=Ui.NONE;break;case vc.CENTER:{const r=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?px:{});r||le(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,r),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=or.TUMBLE,this._constraintOptions.tiltMode=ho.TUMBLE,this._constraintOptions.selection=Ui.ALL&~Ui.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,hw(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,r){const i=this.startCamera,s=M();ge(s,this._pivotPos,i.eye);const n=Me(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,roe);let a=Math.max(Math.min(Crt,1/Math.abs(_e(roe,i.viewForward)))*o,Art);r&&(a=Math.min(n,a));const l=Yr(this.view.spatialReference),c=cs(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),h=T6(this.startCamera,c,l);let p=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*v9,v9),f=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],i,v9);(v(p)||v(f))&&(p=It(p,f),f=C(f)||h===oo.Horizontal?p:f,a=p>f?f:p,a=r?Math.min(a,n):a),ve(s,s),le(this._pivotPos,me(this._tmpPivotPoint,i.eye,ae(this._tmpPivotPoint,s,a)))}update(e){if(this.active){switch(this.pivot){case vc.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case vc.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Ws(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,r,i,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),hw(e,r,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,o=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;ge(this._tmpViewDir,i,s);const a=Me(this._tmpViewDir),l=An(_e(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===vc.EYE){n*=-.5;const c=.5*Math.PI-l,h=.5*Math.PI*.99;n=c-Math.max(-h,Math.min(h,c+n))}return n=ye(n+l,Wo.min,Wo.max)-l,pt(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===vc.CENTER&&(o=-o),Fu(this._tmpTransf,o,this._tmpWorldUp),Mc(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),Xe(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Xe(C9,e.up,this._tmpTransf),me(C9,s,this._tmpViewDir),zn(this._lastPoint,this._tmpRotCurPoint),C9}};u([d()],NO.prototype,"pivot",void 0),NO=u([P("esri.views.3d.state.controllers.RotateController")],NO);const C9=M(),roe=M();let A9=class extends Fo{constructor(e,r,i,s){super(!0),this._view=e,this.pointerAction=r,this._pivot=i,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(e){const r=e.data;if(r.pointers.size>1||!EJ(e.data,this.pointerAction))return;const i=cs(r.center.x,r.center.y);switch(r.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new NO({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},LH=class extends Wf{constructor(){super(...arguments),this._pickPoint=M(),this._tmpP0=Ke(),this._panAxisAngle=w6(),this._tmpRayDir=M(),this._tmpRayDirPick=M(),this._targetOnSphere=M(),this._navMode=oo.Horizontal,this._tmpRay={origin:M(),direction:M()},this.dragBeginPoint=cs(),this._normalizedAnchorPoint=Ke(),this._constraintOptions={selection:Ui.ALL_EXCEPT_COLLISION,interactionType:or.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ho.TUMBLE},this._sphere=cn(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;zn(this.dragBeginPoint,e),hw(this.startCamera,e,this._normalizedAnchorPoint);const r=Yr(this.view.spatialReference),i=Jxe(this._intersectionHelper,this.startCamera,e,r,RE.Ellipsoid,this.view.map.ground.opacity===0?px:{});if(this._navMode=T6(this.startCamera,e,r),this._navMode===oo.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=It(i.scenePickPoint,this._pickPoint),this._sphere=i.sphere;else{let s;dC(this.startCamera,e,this._tmpRay),ve(this._tmpRay.direction,this._tmpRay.direction),v(i.scenePickPoint)&&(ge(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),s=Me(this._tmpRayDirPick));const n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,ioe);let o=ye(Math.min(Gxe,1/Math.abs(_e(ioe,this._tmpRay.direction)))*n,r4[0],r4[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,x6);o=v(a)?a:o,o=s!=null?Math.min(o,s):o,this._hasPickPoint=!0,ae(this._tmpRay.direction,this._tmpRay.direction,o),me(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===oo.Horizontal){ge(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const r=Me(this._tmpRayDir);hw(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=r*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(r-s)<1e-6)return;if(this._hasPickPoint&&s<r){const o=1-(1-s/r)*(1-this._sphere[3]/Me(this.currentCamera.center));this.currentCamera.center=ae(QI,this.currentCamera.center,o)}ae(this._tmpRayDir,this._tmpRayDir,-s/r),this.currentCamera.eye=me(QI,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=Qd(Vw(this.dragBeginPoint,e)),Ws(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(j3(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),vJ(this._pickPoint,this._targetOnSphere,this._panAxisAngle),mv(this.currentCamera,this._sphere,this._panAxisAngle))}else{const r=Me(this._tmpRay.direction);hw(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=r*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(r-s)<1e-6)return;ae(this._tmpRayDir,this._tmpRay.direction,1-s/r),this.currentCamera.eye=me(QI,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=me(QI,this.currentCamera.center,this._tmpRayDir)}hC(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};LH=u([P("esri.views.3d.state.controllers.global.ZoomController")],LH);const QI=M(),ioe=M();let DH=class extends Wf{constructor(){super(...arguments),this._tmpP=M(),this._tmpDir=M(),this._tmpN=M(),this._tmpP0=Ke(),this._tmpPoi=M(),this._tmpRayDir=M(),this.dragBeginPoint=cs(),this._normalizedAnchorPoint=Ke(),this._constraintOptions={selection:Ui.ALL,interactionType:or.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:M(),tiltMode:ho.TUMBLE},this._plane=Br()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;zn(this.dragBeginPoint,e),hw(this.startCamera,e,this._normalizedAnchorPoint);const r=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?px:{});ge(this._tmpDir,this._tmpP,this.startCamera.eye);const i=Me(this._tmpDir);ve(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z);let n=ye(Math.min(Gxe,1/Math.abs(_e(eit,this._tmpDir)))*s,r4[0],r4[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,x6);n=v(o)?o:n,n=r?Math.min(n,i):n,ae(this._tmpDir,this._tmpDir,n),me(this._tmpP,this.startCamera.eye,this._tmpDir),ge(this._tmpN,this.startCamera.eye,this.startCamera.center),ve(this._tmpN,this._tmpN),this._tmpN[1]<0&&xa(this._tmpN,this._tmpN),UM(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;Rrt(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||le(this._tmpPoi,this.currentCamera.center),hw(this.currentCamera,e,this._tmpP0);let r=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);zn(this._normalizedAnchorPoint,this._tmpP0),ge(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=Me(this._tmpRayDir);let s=i*(1-r);this._constraintOptions.interactionDirection&&(le(this._constraintOptions.interactionDirection,this._tmpRayDir),ae(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(r)/i));const n=this.view.state.constraints.minimumPoiDistance;r>=0&&s<n&&(s=n,r=-(s-i)/i),Math.abs(i-s)<1e-6||(ae(this._tmpRayDir,this._tmpRayDir,r),this.currentCamera.eye=me(Kv,this.currentCamera.eye,this._tmpRayDir),Qs(Kv,this.currentCamera.center,this._tmpPoi,r),this._tmpPoi[2]>this.startCamera.center[2]?Kv[2]=Math.max(this.startCamera.center[2],Kv[2]):Kv[2]=Math.min(this.startCamera.center[2],Kv[2]),this.currentCamera.center=Kv,this._constraintOptions.interactionFactor=Qd(Vw(this.dragBeginPoint,e)),Ws(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};DH=u([P("esri.views.3d.state.controllers.local.ZoomController")],DH);const Kv=M(),eit=$e(0,0,1);let tit=class extends Fo{constructor(e,r,i){super(!0),this._view=e,this.pointerAction=r,this.registerIncoming("drag",i,s=>this._handleDrag(s))}_handleDrag(e){const r=e.data;if(r.pointers.size>1||!EJ(e.data,this.pointerAction))return;const i=cs(r.center.x,r.center.y);switch(r.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new LH({view:this._view}):this._cameraController=new DH({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};function pd(t){let e=t*t;return t<0&&(e*=-1),e}function soe(t,e,r){const i=r,s=t.state,n=t.device,o=e.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(i.translation[0]=pd(s.axes[0]),i.translation[1]=pd(s.axes[1]),i.translation[2]=pd(s.buttons[7])-pd(s.buttons[6]),i.heading=pd(s.axes[2]),i.tilt=pd(s.axes[3])):n.deviceType==="spacemouse"&&(i.translation[0]=1.2*pd(s.axes[0]),i.translation[1]=1.2*pd(s.axes[1]),i.translation[2]=2*-pd(s.axes[2]),i.heading=1.2*pd(s.axes[5]),i.tilt=1.2*pd(s.axes[3])),i.tilt*=o,ae(i.translation,i.translation,a),i}function noe(t,e){const r=e;return r.translation[0]=t[1]-t[0],r.translation[1]=t[3]-t[2],r.translation[2]=t[4]-t[5],r.heading=t[7]-t[6],r.tilt=t[8]-t[9],r.zoom=t[10]-t[11],r}function R9(t){return t.translation[0]===0&&t.translation[1]===0&&t.translation[2]===0&&t.heading===0&&t.tilt===0&&t.zoom===0}let Zb=class extends Wf{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new At,this._headingStart=0,this._constraintOptions={selection:Ui.ALL,interactionType:or.NONE,interactionStartCamera:new At,interactionFactor:0,interactionDirection:null,tiltMode:ho.LOOK_AROUND}}handleEventGamepad(e){const r=soe(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||R9(r))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,noe(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const r=noe(this._keysButtonState,this._transformation);R9(r)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const r=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(r-this._filteredSurfaceElevation)*e}stepController(e,r){var i;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(r),this._updateCameraCenter(),(i=this._constraintOptions.interactionStartCamera)==null||i.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Qv),this._applyDisabledMovementTypes(Qv),this._applyPan(Qv.pan),this._applyRotate(Qv.rotate),this._applyZoom(Qv.zoom),this._applyAscend(Qv.ascend),this._constraintOptions.interactionType=or.NONE,this._constraintOptions.selection=Ui.COLLISION,Ws(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,r)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const r=this.currentCamera;ge(fl,r.center,r.eye),Xe(fl,fl,e.matrix),r.center=me(fl,fl,r.eye),r.up=Xe(fl,r.up,e.matrix),this._constraintOptions.interactionType=or.LOOK_AROUND,this._constraintOptions.selection=Ui.ALL_EXCEPT_COLLISION,Ws(this.view,r,this._constraintOptions)}_applyPan(e,r=this.currentCamera){e.enabled&&(r.eye=Xe(fl,r.eye,e.matrix),r.center=Xe(fl,r.center,e.matrix),this.view.state.isGlobal&&(r.up=Xe(fl,r.up,e.matrix)),this._constraintOptions.interactionType=or.PAN,this._constraintOptions.selection=Ui.ALL,Ws(this.view,r,this._constraintOptions))}_applyZoom(e){if(!e)return;const r=this.currentCamera.viewForward;this.currentCamera.eye=me(fl,this.currentCamera.eye,ae(He.get(),r,e)),le(YC,r),xa(YC,YC),this._constraintOptions.interactionDirection=YC,this._constraintOptions.interactionType=or.ZOOM,this._constraintOptions.selection=Ui.ALL_EXCEPT_COLLISION,Ws(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const r=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,He.get());if(this._constraintOptions.interactionDirection=le(YC,r),this.view.state.isGlobal){const i=Me(this.currentCamera.eye),s=(i+e)/i;this.currentCamera.eye=ae(fl,this.currentCamera.eye,s),this.currentCamera.center=ae(fl,this.currentCamera.center,s)}else{const i=ae(He.get(),r,e);this.currentCamera.eye=me(fl,this.currentCamera.eye,i),this.currentCamera.center=me(fl,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=or.ASCEND,this._constraintOptions.selection=Ui.COLLISION,Ws(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Ui.ALL_EXCEPT_COLLISION,Ws(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,r,i){lit(i);const s=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(s,r,i):this._calculateControlTransformationGlobal(s,r,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=r.intersectManifoldClosestSilhouette(i,e,fl)}_calculateControlTransformationLocal(e,r,i){const{viewRight:s,viewForward:n}=r,o=this._transformation,a=this.view.navigation.gamepad,l=ce(He.get(),n[0],n[1],0);ve(l,l);const c=o.translation[0]*e.pan;if(c!==0){const _=ae(He.get(),s,c);ql(i.pan.matrix,i.pan.matrix,_),i.pan.enabled=!0}switch(a.mode){case"pan":{const _=-o.translation[1]*e.pan;if(_!==0){const b=ae(He.get(),l,_);ql(i.pan.matrix,i.pan.matrix,b),i.pan.enabled=!0}i.zoom=o.zoom*e.zoom;break}case"zoom":i.zoom=(-o.translation[1]+o.zoom)*e.zoom;break;default:a.mode}const h=o.translation[2]*e.ascend;i.ascend=h;const p=-o.heading*e.rotate;p!==0&&(Mc(i.rotate.matrix,i.rotate.matrix,p,this.view.renderCoordsHelper.worldUpAtPosition(r.eye,He.get())),i.rotate.enabled=!0);const f=o.tilt*e.rotate,m=fv(this.view.renderCoordsHelper,r.center,r.eye),y=ye(m+f,Wo.min,Wo.max)-m;y&&(Mc(i.rotate.matrix,i.rotate.matrix,y,s),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,r,i){const{eye:s,viewRight:n}=r,o=this._transformation,a=this.view.navigation.gamepad,l=pt(He.get(),n,s);ve(l,l),xa(l,l),Lrt(this.startCamera,r,o,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Qv.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=o.translation[2]*e.ascend;i.ascend=h;const p=-o.heading*e.rotate;p!==0&&(Mc(i.rotate.matrix,i.rotate.matrix,p,this._tmpCamera.eye),i.rotate.enabled=!0);const f=o.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(f,r.ray,c);m!==0&&(Mc(i.rotate.matrix,i.rotate.matrix,m,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=o.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,r,i){const s=Yr(this.view.spatialReference),n=XD(Wo.min,r.origin,i,s);let o=0,a=0;const l=He.get();if(this.view.renderCoordsHelper.intersectManifold(r,i,l)){const c=fv(this.view.renderCoordsHelper,l,r.origin);o=XD(c,r.origin,i,s),a=XD(Wo.max,r.origin,i,s)}else{JE(E5(C5,i+s.radius),r,l);const c=An(-_e(r.direction,ve(l,l)));o=Gne(c,r.origin,i,s),a=Gne(Wo.max,r.origin,i,s)}return ye(o+e,n,a)-o}_getPointAbsoluteSurfaceElevation(e,r,i){const{renderCoordsHelper:s}=this.view,n=s.getAltitude(e),o=r+Math.abs(n-r);return s.setAltitude(i,o,e),o}_clampedDistanceToSurface(e,r){const{renderCoordsHelper:i}=this.view,{camera:s}=this.view.state,{direction:n}=JUe(this.view,r,0,oTe,ait),o=i.intersectManifoldClosestSilhouette(Vu(r,n),e,He.get()),a=Si(r,o),l=i.intersectManifoldClosestSilhouette(Vu(r,my(He.get(),r,s.center)),e,He.get()),c=Si(r,l);return Math.min(a,c)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:r,state:i}=this.view,{camera:s,isGlobal:n}=i,o=r.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,He.get());if(n){const a=ge(He.get(),e,o),l=Me(a);ae(a,a,1/l);const c=ve(He.get(),e),h=An(_e(c,a));return l*Math.sin(Math.min(iit,h))}{const a=le(He.get(),e);return r.setAltitude(a,this._filteredSurfaceElevation),Si(o,a)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:sit}_computeVelocities(e){const r=this._filteredSurfaceElevation,i=r+Yr(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,o=He.get(),a=this._getPointAbsoluteSurfaceElevation(s.eye,r,o),l=this._clampedDistanceToSurface(r,o),c=s.width/2,h=ooe*s.width,p=ooe*s.width,f=l*Math.tan(.5*s.fovX)/c,m=f/i,y=f/this._computeHeadingRotateRadius(o),_=a-r;return{pan:(n?m:f)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/c)*_-_),zoom:2**(h*e/c)*l-l,rotate:ye(y*p,nit,oit)*e}}_applyDisabledMovementTypes(e){!v(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Wh(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Wh(e.rotate.matrix))}static activatesFor(e,r){const i=soe(r,e.navigation.gamepad,rit);return!(r.action==="end"||R9(i))}};u([d({constructOnly:!0})],Zb.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],Zb.prototype,"disableMovements",void 0),Zb=u([P("esri.views.3d.state.controllers.GamepadKeyboardController")],Zb);const rit={translation:[0,0,0],heading:0,tilt:0,zoom:0},oTe=80,iit=jt(oTe),ooe=.75,sit=5,nit=jt(30),oit=jt(80),Qv={zoom:0,ascend:0,pan:{enabled:!1,matrix:Ie()},rotate:{enabled:!1,matrix:Ie()}},fl=M(),YC=M(),ait=xY();function lit(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,Wh(t.pan.matrix),t.rotate.enabled=!1,Wh(t.rotate.matrix)}let cit=class extends Fo{constructor(e){super(!0),this._view=e,this._watchHandles=new Zr,this._handle=this.registerIncoming("gamepad",r=>this._handleEventGamepad(r)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([ne(()=>this._view.navigation.gamepad.enabled,r=>{r?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},kt),ne(()=>this._view.navigation.gamepad.device,r=>{this._cameraControllerGamepad&&r&&this._cameraControllerGamepad.gamepadDevice!==r&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const r=this._view.navigation.gamepad.device;if(r&&e.data.device!==r)return;const i=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(i||Zb.activatesFor(this._view,e.data)){if(!i){const s=new Zb({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(s)&&(this._cameraControllerGamepad=s)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var pc;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.FORWARD=2]="FORWARD",t[t.BACKWARD=3]="BACKWARD",t[t.UP=4]="UP",t[t.DOWN=5]="DOWN",t[t.HEADINGLEFT=6]="HEADINGLEFT",t[t.HEADINGRIGHT=7]="HEADINGRIGHT",t[t.TILTUP=8]="TILTUP",t[t.TILTDOWN=9]="TILTDOWN",t[t.ZOOMIN=10]="ZOOMIN",t[t.ZOOMOUT=11]="ZOOMOUT"})(pc||(pc={}));let uit=class extends Fo{constructor(e,r){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Be.Local},this._keyToNumber={[r.left]:pc.LEFT,[r.right]:pc.RIGHT,[r.forward]:pc.FORWARD,[r.backward]:pc.BACKWARD,[r.up]:pc.UP,[r.down]:pc.DOWN,[r.headingLeft]:pc.HEADINGLEFT,[r.headingRight]:pc.HEADINGRIGHT,[r.tiltUp]:pc.TILTUP,[r.tiltDown]:pc.TILTDOWN,[r.zoomIn]:pc.ZOOMIN,[r.zoomOut]:pc.ZOOMOUT},this.registerIncoming("key-down",null,i=>this._handleKeyDown(i)),this.registerIncoming("key-up",null,i=>this._handleKeyUp(i)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToNumber[e.data.key];r!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Zb({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(r),e.stopPropagation()))}_handleBlur(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToNumber[e.data.key];r!=null&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(r),e.stopPropagation())}},hit=class extends Fo{constructor(e,r){super(!0),this._view=e,this.registerIncoming("mouse-wheel",r,i=>this._handleMouseWheel(i))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const r=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new o4({view:this._view,mode:"interaction"}):new a4({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*r.deltaY,cs(r.x,r.y)),e.preventDefault(),e.stopPropagation()}},l4=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},qw=class extends B3{constructor(){super(...arguments),this._beginCamera=new At,this._elapsedTimeSec=0,this.constraintOptions={selection:Ui.ALL,interactionType:or.PAN,interactionFactor:0,interactionStartCamera:new At,interactionDirection:null,tiltMode:ho.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new TE}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,super.onControllerStart(e)}stepController(e,r){r.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,r),Ws(this.view,r,this.constraintOptions)}};qw=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],qw);let FO=class extends qw{constructor(e){super(e),this.interactionType=or.PAN,this._tmpPan=M()}momentumStep(e,r){const i=this.momentum.value(e);ae(this._tmpPan,this.momentum.direction,i),r.eye=ge(aoe,r.eye,this._tmpPan),r.center=ge(aoe,r.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};u([d({constructOnly:!0})],FO.prototype,"momentum",void 0),FO=u([P("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],FO);const aoe=M(),dit=M(),e$=M();let ZD=class extends qw{constructor(e){super(e),this.interactionType=or.PAN}momentumStep(e,r){const i=this.momentum.value1(e),s=this.momentum.value2(e);le(e$,r.eye),ve(e$,e$),pt(this.momentum.axis2,e$,this.momentum.axis1),tTe(r,dit,this.momentum.axis1,i,this.momentum.axis2,s)}};u([d({constructOnly:!0})],ZD.prototype,"momentum",void 0),ZD=u([P("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],ZD);let Db=class extends qw{set center(e){this._set("center",gs(e))}set axis(e){this._set("axis",gs(e))}constructor(e){super(e),this.interactionType=or.TUMBLE}momentumStep(e,r){const i=this.momentum.value(e);mv(r,this.center,G3(this.axis,i))}};u([d({constructOnly:!0})],Db.prototype,"momentum",void 0),u([d({constructOnly:!0})],Db.prototype,"center",null),u([d({constructOnly:!0})],Db.prototype,"axis",null),Db=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],Db);let Z2=class extends qw{set zoomCenter(e){this._set("zoomCenter",gs(e))}constructor(e){super(e),this.interactionType=or.ZOOM,this.constraintOptions.interactionDirection=M()}momentumStep(e,r){const{interactionDirection:i}=this.constraintOptions;if(!i)return;le(i,r.eye);const s=this.momentum.valueDelta(0,e);xJ(r,this.zoomCenter,s,this.view.state.constraints.minimumPoiDistance),my(i,r.eye,i)}};u([d({constructOnly:!0})],Z2.prototype,"momentum",void 0),u([d({constructOnly:!0})],Z2.prototype,"zoomCenter",null),Z2=u([P("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],Z2);let hb=class extends qw{set screenCenter(e){this._set("screenCenter",cs(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",gs(e))}constructor(e){super(e),this.interactionType=or.ZOOM,this.radius=0,this._tmpSceneCenter=M(),this._tmpZoomAxisAngle=w6(),this._sphere=cn()}initialize(){this._sphere[3]=this.radius}momentumStep(e,r){const i=this.momentum.valueDelta(0,e);Yxe(this._sphere,r,i),this.constraintOptions.interactionType=or.ZOOM,Ws(this.view,r,this.constraintOptions),j3(this._sphere,r,this.screenCenter,this._tmpSceneCenter),vJ(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),mv(r,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=or.PAN}};u([d({constructOnly:!0})],hb.prototype,"momentum",void 0),u([d({constructOnly:!0})],hb.prototype,"screenCenter",null),u([d({constructOnly:!0})],hb.prototype,"sceneCenter",null),u([d({constructOnly:!0})],hb.prototype,"radius",void 0),hb=u([P("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],hb);let ep=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const r=this.computeDelta(e);this._updateDelta(r)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return this.lastValue!==void 0}hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return this.lastValue===void 0?NaN:e-this.lastValue}_updateDelta(e){this.filteredDelta!==void 0?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},S6=class{constructor(e,r,i){this._initialVelocity=e,this._stopVelocity=r,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,r){const i=this.value(e);return this.value(e+r)-i}valueFromInitialVelocity(e,r){r=Math.min(r,this.duration);const i=1-this.friction;return e*(i**r-1)/Math.log(i)}},pit=class extends S6{constructor(e,r,i,s,n){super(e,r,i),this._sceneVelocity=s,this.direction=n}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}},aTe=class{constructor(e=300,r=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this.enabled=!0,this._time=new ep(.6),this._screen=[new ep(.4),new ep(.4)],this._scene=[new ep(.6),new ep(.6),new ep(.6)],this._tmpDirection=M()}add(e,r,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(r[0]),this._scene[1].update(r[1]),this._scene[2].update(r[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,r=this._screen[1].filteredDelta,i=e==null||r==null?0:Math.sqrt(e*e+r*r),s=this._time.filteredDelta,n=s==null||i==null?0:i/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,r,i){ce(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const s=Me(this._tmpDirection);s>0&&ae(this._tmpDirection,this._tmpDirection,1/s);const n=this._time.filteredDelta;return new pit(e,r,i,n==null?0:s/n,this._tmpDirection)}},loe=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const coe=1e-5;let fit=class extends S6{constructor(e,r,i,s,n,o=0,a){super(e,r,i),this._angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},mit=class{constructor(e=300,r=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this.enabled=!0,this._tmpAxis1=M(),this._tmpAxis2=M(),this._tmpAngles=Ke(),this._time=new ep(.3),this._screen=[new ep(.4),new ep(.4)],this._angle1=new loe(.6),this._angle2=new loe(.6),this._axis1=M(),this._axis2=M(),this._lastScene=M()}addMomentumDirectRotation(e,r,i,s,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let a=Qxe(this._lastScene,r,this._tmpAxis2,s,n,o);this._angle2.update(0),ga(this._tmpAxis2)<coe?a=0:ve(this._axis1,this._tmpAxis2),this._angle1.update(a),le(this._lastScene,r)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,r,i,s,n,o,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;eTe(this._lastScene,r,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,n,o,a,!1),ga(this._tmpAxis2)<coe?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),ve(this._axis1,this._tmpAxis1),ve(this._axis2,this._tmpAxis2)),le(this._lastScene,r)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,r=this._screen[1].filteredDelta,i=e==null||r==null?null:Math.sqrt(e*e+r*r),s=this._time.filteredDelta,n=i==null||s==null?0:i/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,r,i){const s=this._time.filteredDelta,n=this._angle1.filteredValue,o=this._angle2.filteredValue,a=s==null||o==null?0:o/s;return new fit(e,r,i,s==null||n==null?0:n/s,this._axis1,a,this._axis2)}},lTe=class{constructor(e=2.5,r=.01,i=.95,s=12){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this._maxVelocity=s,this.enabled=!0,this.value=new ep(.8),this.time=new ep(.3)}add(e,r){if(this.enabled&&r!=null){if(this.time.hasLastValue()){if(this.time.computeDelta(r)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(r),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=ye(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,r,i){return new S6(e,r,i)}},cTe=class extends lTe{constructor(e=3,r=.01,i=.95,s=12){super(e,r,i,s)}add(e,r){const i=this.value.lastValue;if(i!=null){let s=e-i;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;e=i+s}super.add(e,r)}},git=class extends S6{constructor(e,r,i){super(e,r,i)}value(e){const r=super.value(e);return Math.exp(r)}valueDelta(e,r){const i=super.value(e),s=super.value(e+r)-i;return Math.exp(s)}},uTe=class extends lTe{constructor(e=2.5,r=.01,i=.95,s=12){super(e,r,i,s)}add(e,r){super.add(Math.log(e),r)}createMomentum(e,r,i){return new git(e,r,i)}},NH=class extends Wf{constructor(){super(...arguments),this._smoothRotation=new l4(.05),this._rotationAxis=M(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Br(),this._beginRadius=0,this._smoothScaling=new l4(.05),this._zoomCenterScreen=cs(),this._zoomMomentumEstimator=new uTe,this._rotationMomentumEstimator=new cTe,this._panSphericalMomentumEstimator=new mit,this._panPlanarMomentumEstimator=new aTe,this._adjustedSphere=cn(),this._tmp3d=M(),this._tmpScreenPointArray=cs(),this._beginScreenPoint=cs(),this._beginScenePoint=M(),this._screenPickPoint=cs(),this._scenePickPoint=M(),this._mode=oo.Horizontal,this._sphere=cn(),this._pointerCount=0,this._tmpInteractionDirection=M(),this._constraintOptions={selection:Ui.ALL,interactionType:or.NONE,interactionFactor:0,interactionStartCamera:new At,interactionDirection:null,tiltMode:ho.TUMBLE}}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){var n;if(!this.active)return;const r=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=r,this._rotationMomentumEstimator.enabled=r,this._panPlanarMomentumEstimator.enabled=r,this._panSphericalMomentumEstimator.enabled=r,this._beginHeading=-tv.normalize(jt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),Ff(e.center,this._screenPickPoint),zn(this._beginScreenPoint,this._screenPickPoint);const i=Yr(this.view.spatialReference),s=Jxe(this._intersectionHelper,this.startCamera,this._screenPickPoint,i,RE.Silhouette,this.view.map.ground.opacity===0?px:{});C(s.scenePickPoint)||(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,le(this._beginScenePoint,this._scenePickPoint),this._mode=T6(this.startCamera,this._screenPickPoint,i),this._mode===oo.Vertical&&this._preparePlanarPanMode(e,s.hasGeometryIntersection),(n=this._constraintOptions.interactionStartCamera)==null||n.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const r=e.pointers.size>1;this._mode===oo.Horizontal?(r&&this._zoomSpherical(e),this._panningSpherical(e),r&&this._rotateSpherical(e)):(r&&this._zoomPlanar(e),this._panningPlanar(e),r&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const r=this._zoomMomentumEstimator.evaluateMomentum();if(r)return this._mode===oo.Horizontal?new hb({view:this.view,momentum:r,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new Z2({view:this.view,momentum:r,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Db({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._mode===oo.Horizontal){const s=this._panSphericalMomentumEstimator.evaluateMomentum();if(s)return new ZD({view:this.view,momentum:s})}else{const s=this._panPlanarMomentumEstimator.evaluateMomentum();if(s)return new FO({view:this.view,momentum:s})}return null}_preparePlanarPanMode(e,r){const i=xa(this._tmp3d,this.startCamera.viewForward);UM(this._scenePickPoint,i,this._panningPlane);const s=cs(this._screenPickPoint[0],0),n=M(),o=Me(this.startCamera.eye);this._adjustedSphere[3]=o<this._sphere[3]?o-100:this._sphere[3],j3(this._adjustedSphere,this.startCamera,s,n);const a=Zo();this.startCamera.projectToRenderScreen(n,a);const l=M(),c=M(),h=M();ge(l,this._scenePickPoint,this.currentCamera.eye);const p=Me(l);ve(l,l);const f=Wxe*Math.max(Math.abs(this.view.camera.position.z),Xxe),m=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,x6);let y=v(m)?m:f;y=r?Math.min(y,p):y,le(h,me(c,this.currentCamera.eye,ae(c,l,y))),this._panningPlane[3]=-_e(this._panningPlane,h),this.startCamera.center=me(c,this.startCamera.eye,ae(c,this.startCamera.viewForward,y));const _=Ff(e.center,this._tmpScreenPointArray);$H(this._panningPlane,this.startCamera,_,this._beginScenePoint)}_zoomSpherical(e){const r=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(r),Yxe(this._sphere,this.currentCamera,this._smoothScaling.value),Ff(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=or.ZOOM,this._constraintOptions.interactionFactor=Qd(e.radius-this._beginRadius),Ws(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const r=Ff(e.center,this._tmpScreenPointArray);j3(this._sphere,this.currentCamera,r,this._tmp3d),TJ(this._beginScenePoint,_e(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(iTe(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(r,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(rTe(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(r,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=or.PAN,this._constraintOptions.interactionFactor=Qd(Vw(this._screenPickPoint,r)),Ws(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){ve(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||xa(this._rotationAxis,this._rotationAxis);const r=this._smoothRotation.value,i=r+IH(e.angle-r),s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),mv(this.currentCamera,this._sphere,G3(this._rotationAxis,n)),this._constraintOptions.interactionType=or.TUMBLE,this._constraintOptions.interactionFactor=Qd(e.radius*i),Ws(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const r=Ff(e.center,this._tmpScreenPointArray);$H(this._panningPlane,this.currentCamera,r,this._tmp3d)&&(Kxe(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(r,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=or.PAN,this._constraintOptions.interactionFactor=Qd(Vw(this._beginScreenPoint,r)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Ws(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const r=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(r),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),xJ(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=or.ZOOM,this._constraintOptions.interactionFactor=Qd(e.radius-this._beginRadius),Ws(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){le(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||xa(this._rotationAxis,this._rotationAxis);const r=this._smoothRotation.value;let i=e.angle-r;i=IH(i);const s=r+i,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(s);const o=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*e.timestamp),mv(this.currentCamera,this._sphere,G3(this._rotationAxis,o)),this._constraintOptions.interactionType=or.TUMBLE,this._constraintOptions.interactionFactor=Qd(e.radius*o),Ws(this.view,this.currentCamera,this._constraintOptions)}};NH=u([P("esri.views.3d.state.controllers.global.PinchAndPanController")],NH);const uoe=$e(0,0,1),yit={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI};let FH=class extends Wf{constructor(){super(...arguments),this._rotationValueSmooth=new l4(.05),this._scalingValueSmooth=new l4(.05),this._planeHorizontal=Br(),this._planeVertical=Br(),this._rotationMomentumEstimator=new cTe,this._panMomentumEstimator=new aTe(300,12,.9),this._zoomMomentumEstimator=new uTe,this._beginRadius=0,this._beginCenter=M(),this._beginAngle=0,this._tmpPoints=[],this._panMode=oo.Horizontal,this._beginCenterScreen=cs(),this._tmpCentroid3d=M(),this._tmpCentroid2d=cs(),this._tmp2d=cs(),this._pointerCount=0,this._constraintOptions={selection:Ui.ALL,interactionType:or.NONE,interactionFactor:0,interactionStartCamera:new At,interactionDirection:null,tiltMode:ho.TUMBLE}}begin(e){var y;if(!this.active)return;const r=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=r,this._rotationMomentumEstimator.enabled=r,this._panMomentumEstimator.enabled=r,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Ff(e.center,this._beginCenterScreen),vye(uoe,0,this._planeHorizontal);const i=M(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.map.ground.opacity===0?px:{}),n=M();xa(n,this.startCamera.viewForward);const o=M();le(o,uoe);const a=_e(n,o),l=Hh(a<0?-a:a);this._panMode=l>=yit.ANGLE_THRESHOLD?oo.Horizontal:oo.Vertical;const c=Math.min(Wxe,1/Math.abs(_e(o,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),Xxe);h7(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||d7(this._planeHorizontal,this._planeHorizontal);const h=M(),p=M(),f=M();ge(h,i,this.currentCamera.eye);const m=Me(h);if(ve(h,h),this._panMode===oo.Vertical){ae(o,o,a),ge(this._planeVertical,n,o),ve(this._planeVertical,this._planeVertical),h7(this._planeVertical,this._planeVertical,i);const _=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,x6);let b=v(_)?_:c;b=s?Math.min(b,m):b,le(f,me(p,this.currentCamera.eye,ae(p,h,b))),this._planeVertical[3]=-_e(this._planeVertical,f),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),b9(this._tmpPoints,this._beginCenter)}else{const _=s?m:c;le(f,me(p,this.currentCamera.eye,ae(p,h,_))),this._planeHorizontal[3]=-_e(this._planeHorizontal,f),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),b9(this._tmpPoints,this._beginCenter)}(y=this._constraintOptions.interactionStartCamera)==null||y.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const r=e.pointers.size>1,i=this._panMode===oo.Horizontal?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(r){const n=this._beginRadius/e.radius,o=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=o,this._scalingValueSmooth.update(n),xJ(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=or.ZOOM,this._constraintOptions.interactionFactor=Qd(Math.abs(e.radius-this._beginRadius)),Ws(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),b9(this._tmpPoints,this._tmpCentroid3d),Ff(e.center,this._tmpCentroid2d),Kxe(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=or.PAN,this._constraintOptions.interactionFactor=Qd(Vw(this._beginCenterScreen,this._tmpCentroid2d)),Ws(this.view,this.currentCamera,this._constraintOptions),r){const n=this._planeHorizontal,o=s,a=this._rotationValueSmooth.value,l=a+IH(e.angle-a),c=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=c,this._rotationValueSmooth.update(l);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp),mv(this.currentCamera,o,G3(n,h)),this._constraintOptions.interactionType=or.TUMBLE,this._constraintOptions.interactionFactor=Qd(Math.abs(e.radius*h)),Ws(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const r=this._zoomMomentumEstimator.evaluateMomentum();if(r)return new Z2({view:this.view,momentum:r,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Db({view:this.view,momentum:i,center:this._beginCenter,axis:this._planeHorizontal});const s=this._panMomentumEstimator.evaluateMomentum();return s?new FO({view:this.view,momentum:s}):null}_computePlanePoints(e,r,i,s){s.length=e.size;const n=this._tmp2d;let o=0;return e.forEach(a=>{n[0]=a.x,n[1]=a.y,s[o]===void 0&&(s[o]=M()),$H(r,i,n,s[o]),o+=1}),s}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};FH=u([P("esri.views.3d.state.controllers.local.PinchAndPanController")],FH);let hoe=class extends Fo{constructor(e,r,i){super(!0),this._view=e,this.pointerAction=r,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,s=>this._handleDrag(s))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!EJ(e.data,this.pointerAction))return;const r=e.timestamp-this._lastEndTimestamp,i=40,s=this._momentum&&this._momentum.active&&r<i;switch(e.data.action){case"start":case"update":if(s)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,r){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);r&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new NH({view:this._view}):new FH({view:this._view})}},_it=class extends Fo{constructor(e,r){super(!0),this.view=e,this.registerIncoming("pointer-down",r,()=>this.view.state.stopActiveCameraController())}},hTe=class extends Fo{constructor(e,r){super(!0),this.key=e,this.registerIncoming("key-down",r,i=>this._handleKeyDown(i))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},vit=class extends hTe{constructor(e,r,i){super(r,i),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},bit=class extends hTe{constructor(e,r,i){super(r,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},wit=class extends Fo{constructor(e,r=!1){super(!0),this._view=e,this._invert=r,this.registerIncoming("vertical-two-finger-drag",i=>this._handleTwoFinger(i))}_handleTwoFinger(e){var s,n,o;const r=this._invert?-1:1,i=cs(0,e.data.delta*r);switch(e.data.action){case"begin":(s=this._cameraController)==null||s.end(),this._cameraController=new NO({view:this._view,pivot:vc.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":(n=this._cameraController)==null||n.update(i);break;case"end":(o=this._cameraController)==null||o.end(),this._cameraController=null}}};function doe(t){const e=t.native;return e?{buttons:e.buttons.map(r=>r.pressed?r.value?r.value:1:0),axes:e.axes.map(r=>Sit(r,t.axisThreshold))}:{buttons:[],axes:[]}}function xit(t,e){if(t.axes.length!==e.axes.length||t.buttons.length!==e.buttons.length)return!1;for(let r=0;r<t.axes.length;r++)if(t.axes[r]!==e.axes[r])return!1;for(let r=0;r<t.buttons.length;r++)if(t.buttons[r]!==e.buttons[r])return!1;return!0}function Tit(t){for(let e=0;e<t.axes.length;e++)if(t.axes[e]!==0)return!1;for(let e=0;e<t.buttons.length;e++)if(t.buttons[e]!==0)return!1;return!0}function Sit(t,e){const r=Math.abs(t);return r<e?0:Math.sign(t)*(r-e)/(1-e)}let Eit=class{constructor(e,r){this._element=e,this._input=r,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this._inputDevices[a];l&&(this._emitGamepadEvent(o,doe(l),!1),this._inputDevices.splice(a,1),this._latestUpdate.splice(a,1),this._input.gamepad.devices.remove(l),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=i&&s,this.supported&&(this._forEachGamepad(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const r=new IZ(e);r.deviceType!=="unknown"&&(this._inputDevices[e.index]=r,this._input.gamepad.devices.add(r)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this._frameTask==null&&(this._frameTask=kS({update:()=>this._readGamepadState()}))}_stopPolling(){this._frameTask!=null&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),r=this._element.contains(document.activeElement),i=this._input.gamepad.enabledFocusMode==="document"&&!e||this._input.gamepad.enabledFocusMode==="view"&&!r;this._forEachGamepad(s=>{const n=this._inputDevices[s.index];if(!n)return;const o=this._latestUpdate[s.index],a=doe(n),l=i||Tit(a);o&&(o.timestamp===s.timestamp||!o.active&&l||xit(o.state,a))||this._emitGamepadEvent(s,a,!l)})}_forEachGamepad(e){const r=window.navigator.getGamepads();for(let i=0;i<r.length;i++){const s=r[i];this._validate(s)&&e(s)}}_emitGamepadEvent(e,r,i){const s=this._latestUpdate[e.index],n=s&&s.active;if(!n&&!i)return;const o=!n&&i?"start":n&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:r,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:r,action:o})}_validate(e){if(!e||!e.connected)return!1;for(let r=0;r<e.axes.length;r++)if(isNaN(e.axes[r]))return!1;return!0}};const poe=de("edge"),Cit=de("chrome"),Ait=de("ff"),Rit=de("safari"),foe="esri-view-surface",kx={touchNone:`${foe}--touch-none`,touchPan:`${foe}--touch-pan`};let dTe=class pTe{constructor(e,r){this._input=r,this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new Eit(e,this._input),this._gamepadSource.onEvent=i=>this._callback("gamepad",i)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(e=>{this._releasePointerCaptureSafe(e)}),this._gamepadSource=Ve(this._gamepadSource),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const r in this._active)if(!e||!e.has(r)){const i=this._active[r];this._element.removeEventListener(O9[r],i),delete this._active[r]}e&&e.forEach(r=>{if(!this._active[r]&&O9[r]){const i=(this._eventHandlers[r]||this._handleDefault).bind(this,r);this._element.addEventListener(O9[r],i),this._active[r]=i}}),this._gamepadSource.hasEventListeners=(e==null?void 0:e.has("gamepad"))??!1}setPointerCapture(e,r){r?(this._element.setPointerCapture(e.pointerId),this._activePointerCaptures.add(e.pointerId)):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?kx.touchNone:kx.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?kx.touchPan:kx.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(kx.touchNone),this._element.classList.remove(kx.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch{}}_updateNormalizedPointerLikeEvent(e,r){const i=Jbe(this._element,e);return pTe.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),r.x=i.x,r.y=i.y,r}_handleKey(e,r){const i=KYe(r);i&&e==="key-up"&&this._keyDownState.delete(i);const s={native:r,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&e==="key-down"&&this._keyDownState.add(s.key),this._callback(e,s)}_handlePointer(e,r){const i=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,r){const i=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});r.preventDefault(),this._callback(e,i)}_handleMouseWheel(e,r){let i=r.deltaY;switch(r.deltaMode){case 0:poe&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}poe?i*=.7:Cit||Rit?i*=.6:Ait&&(i*=1.375);const s=100,n=Math.abs(i);n>s&&(i=i/n*200/(1+Math.exp(-.02*(n-s))));const o=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,deltaY:i});this._callback(e,o)}_handlePointerCaptureLost(e,r){this._activePointerCaptures.delete(r.pointerId),this._handleDefault(e,r)}_handleDefault(e,r){const i={native:r};r.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){e.key==="Alt"&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}};dTe.test={disableSubpixelCoordinates:!1};const O9={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};let Oit=class extends Fo{constructor(){super(!0),this.registerIncoming("context-menu",e=>{e.data.native.preventDefault()})}};function fTe(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function Mit(t,e){const r=e.x-t.x,i=e.y-t.y;return Math.sqrt(r*r+i*i)}function Pit(t,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:Zh()},t.length===0)return e;if(t.length===1)return e.center.x=t[0].x,e.center.y=t[0].y,e;if(t.length===2){const[S,E]=t,[O,R]=[E.x-S.x,E.y-S.y];return e.radius=Math.sqrt(O*O+R*R)/2,e.center.x=(S.x+E.x)/2,e.center.y=(S.y+E.y)/2,e}let r=0,i=0;for(let S=0;S<t.length;S++)r+=t[S].x,i+=t[S].y;r/=t.length,i/=t.length;const s=t.map(S=>S.x-r),n=t.map(S=>S.y-i);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let S=0;S<s.length;S++){const E=s[S],O=n[S],R=E*E,L=O*O;o+=R,a+=L,l+=E*O,c+=R*E,h+=L*O,p+=E*L,f+=O*R}const m=.5*(c+p),y=.5*(h+f),_=o*a-l*l,b=(m*a-y*l)/_,x=(o*y-l*m)/_,T=Zh(b+r,x+i);return{radius:Math.sqrt(b*b+x*x+(o+a)/t.length),center:T}}function UO(t){const{native:e}=t,{pointerId:r,button:i,pointerType:s}=e;return s==="mouse"?`${r}:${i}`:`${s}`}let Iit=class extends Fo{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,r,i,s){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:r.buttons,timestamp:s,pointers:$it(this._activePointerMap),pointer:r,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const r=e.native.pointerId,i=t$(this._activePointerMap).angle,s={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(r,s);const n=JD(s,mTe(this._activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(i)}_updatePointer(e){if(e&&e.x==null&&e.y==null)return;const r=e.native.pointerId,i=this._activePointerMap.get(r);i?i.event=e:this._addPointer(e)}_removePointer(e){const r=t$(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(r)}_updatePointerAngles(e){const r=t$(this._activePointerMap);this._activePointerMap.forEach(i=>{i.initialAngle=JD(i,r)-e,i.lastAngle=JD(i,r)-e})}_emitEvent(e,r,i){const s=t$(this._activePointerMap);this._drag.emit(this._createPayload(e,r,s,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const r=e.data.native.pointerId,i=e.timestamp;this._activePointerMap.get(r)&&(this._activePointerMap.size===1?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(r)):(this._removePointer(r),this._emitEvent("removed",e.data,e.timestamp)))}_handlePointerDrag(e){const r=e.data,i=r.currentEvent,s=e.timestamp;switch(r.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,s)):(this._addPointer(i),this._emitEvent("added",i,s),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,s))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&this._pointerType==="touch"&&this._activePointerMap.size===1}};function mTe(t){const e=[];return t.forEach(r=>{e.push(Zh(r.event.x,r.event.y))}),Pit(e)}function t$(t){const e=mTe(t);let r=0;return t.forEach(i=>{let s=JD(i,e),n=s-i.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=i.lastAngle+n,i.lastAngle=s;const o=s-i.initialAngle;r+=o}),r/=t.size||1,{angle:r,radius:e.radius,center:e.center}}function $it(t){const e=new Map;return t.forEach((r,i)=>e.set(i,r.event)),e}function JD(t,e){const r=t.event,i=r.x-e.center.x,s=r.y-e.center.y;return Math.atan2(s,i)}var moe;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right",t[t.Back=3]="Back",t[t.Forward=4]="Forward",t[t.Undefined=-1]="Undefined"})(moe||(moe={}));const N_={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};let Lit=class extends Fo{constructor(e=N_.maximumDoubleClickDelay,r=N_.maximumDoubleClickDistance,i=N_.maximumDoubleTouchDelay,s=N_.maximumDoubleTouchDistance,n=j4){super(!1),this._maximumDoubleClickDelay=e,this._maximumDoubleClickDistance=r,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this))}onUninstall(){this._pointerState.forEach(e=>e.doubleClickTimer=Vi(e.doubleClickTimer))}get hasPendingInputs(){return Yo(this._pointerState,e=>e.doubleClickTimer!=null)}_clearDoubleClickTimer(e,r){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=Vi(i.doubleClickTimer),r&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const r=this._pointerState.get(e);r.pointerDownCount===1&&this._click.emit(r.event.data,void 0,r.event.modifiers),r.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_getPointerId(e){const{pointerId:r,pointerType:i,button:s}=e.native;return i==="mouse"?`${r}:${s}`:`${i}`}_handleImmediateClick(e){const r=e.data,{pointerType:i}=r.native,s=this._getPointerId(r);if(!this._pointerState.has(s))return void this._startClick(e);const n=this._pointerState.get(s),{data:o,modifiers:a}=n.event,l=i==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;fTe(o,r)>l?(this._clearDoubleClickTimer(s,!0),this._startClick(e)):(this._clearDoubleClickTimer(s,!1),n.pointerDownCount===2&&this._doubleClick.emit(o,void 0,a))}_handlePointerDown(e){const r=UO(e.data),i=this._pointerState.get(r);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:r}=e,{native:{pointerType:i}}=r,s=UO(r),n=i==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,o=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(s),n),a=1;this._pointerState.set(s,{event:e,doubleClickTimer:o,pointerDownCount:a}),this.refreshHasPendingInputs()}},Dit=class extends Fo{constructor(e=N_.maximumDoubleClickDelay,r=N_.maximumDoubleClickDistance,i=N_.maximumDoubleTouchDelay,s=N_.maximumDoubleTouchDistance,n=j4){super(!1),this._maximumDoubleClickDelay=e,this._maximumDoubleClickDistance=r,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const r=e.data,i=UO(r);if(!this._pointerState.has(i)){const s={downButton:r.native.button,immediateDoubleClick:null};this._pointerState.set(i,s),this.startCapturingPointer(r.native)}}_handlePointerUp(e){const r=e.data,i=UO(r),s=this._pointerState.get(i);if(s&&s.downButton===r.native.button){const n=s.immediateDoubleClick;if(n){n.timeoutHandle.remove();const o=e.data.native.pointerType==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;fTe(n,e.data)>o?this._startImmediateDoubleClick(e,s):(this._immediateDoubleClick.emit(e.data,void 0,n.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(e,s)}}_startImmediateDoubleClick(e,r){const i=e.data.native.pointerType==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay;r.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),i)}}_removeState(e){const r=UO(e);this._pointerState.delete(r),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}};const ZC={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};let Nit=class extends Fo{constructor(e=ZC.maximumClickDelay,r=ZC.movementUntilMouseDrag,i=ZC.movementUntilPenDrag,s=ZC.movementUntilTouchDrag,n=ZC.holdDelay,o=j4){super(!1),this._maximumClickDelay=e,this._movementUntilMouseDrag=r,this._movementUntilPenDrag=i,this._movementUntilTouchDrag=s,this._holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout=Vi(e.holdTimeout)}),super.onUninstall()}_handlePointerDown(e){const r=e.data,i=r.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(i);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,e.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this._holdDelay));const n={startEvent:r,previousEvent:r,startTimestamp:e.timestamp,isDragging:!1,downButton:r.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(i,n),this.startCapturingPointer(r.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_createPointerDragData(e,r,i){return{action:e,startEvent:r.startEvent,previousEvent:r.previousEvent,currentEvent:i}}_handlePointerMove(e){const r=e.data,i=r.native.pointerId,s=this._pointerState.get(i);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,r),void 0,s.modifiers):Mit(r,s.startEvent)>this._getDragThreshold(r.native.pointerType)&&this._startDragging(e),s.previousEvent=r)}_getDragThreshold(e){switch(e){case"touch":return this._movementUntilTouchDrag;case"pen":return this._movementUntilPenDrag;default:return this._movementUntilMouseDrag}}_startDragging(e){const r=e.data,i=r.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=e.modifiers,s.isDragging=!0,i===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,r)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),e.timestamp))})}_handlePointerLoss(e,r){const i=e.data,s=i.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,r==="pointer-up"?i:n.previousEvent),void 0,n.modifiers):r==="pointer-up"&&n.downButton===i.native.button&&e.timestamp-n.startTimestamp<=this._maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(s),this.stopCapturingPointer(i.native),this._pointerState.size===0&&this._moveHandle.pause())}},Fit=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const r=e.data,i=r.pointers.size;switch(r.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){var r,i;this._startEvent=e,(i=(r=this._callbacks).condition)!=null&&i.call(r,this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){var r,i;(i=(r=this._callbacks).condition)!=null&&i.call(r,this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){var r,i;(i=(r=this._callbacks).condition)!=null&&i.call(r,this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},Uit=class extends Fo{constructor(e=20,r=40){super(!1),this._threshold=e,this._maxDelta=r,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new Fit({start:(i,s)=>this._observeStart(i,s),update:(i,s,n)=>this._observeUpdate(i,s,n),end:(i,s)=>this._observeEnd(s)}),this.registerIncoming("drag",i=>this._dragEventSeparator.handle(i))}get failed(){return this._state==="failed"}_observeStart(e,r){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:r.data.button,buttons:r.data.buttons,pointerType:r.data.pointerType,timestamp:r.data.timestamp,pointers:r.data.pointers,pointer:r.data.pointer,angle:r.data.angle,radius:r.data.radius,center:r.data.center}),r.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,r,i){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:r.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void r.stopPropagation()):void(this._checkMovementWithinLimits(r.data,i.data)?this._checkVerticalThresholdReached(r.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=r.data.center,this._artificalDrag.emit({action:"end",button:r.data.button,buttons:r.data.buttons,pointerType:r.data.pointerType,timestamp:r.data.timestamp,pointers:r.data.pointers,pointer:r.data.pointer,angle:r.data.angle,radius:r.data.radius,center:r.data.center}),this._vertical.emit({delta:r.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),r.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,r){let i=-1/0,s=1/0,n=-1/0,o=1/0;for(const{x:_,y:b}of r.pointers.values())i=Math.max(i,_),s=Math.min(s,_),n=Math.max(n,b),o=Math.min(o,b);let a=-1/0,l=1/0,c=-1/0,h=1/0;for(const{x:_,y:b}of e.pointers.values())a=Math.max(a,_),l=Math.min(l,_),c=Math.max(c,b),h=Math.min(h,b);const p=i-s,f=n-o,m=a-l,y=c-h;return Math.abs(e.center.x-r.center.x)<this._threshold&&Math.abs(m-p)<=this._maxDelta&&Math.abs(y-f)<=this._maxDelta}_checkVerticalThresholdReached(e,r){let i=Math.abs(e.center.y-r.center.y);return e.pointers.forEach((s,n)=>{const o=r.pointers.get(n);i=Math.min(i,Math.abs(s.y-o.y))}),i>=this._threshold}},Nd=class extends Te{constructor(){super(...arguments),this._handles=new Zr}destroy(){this._handles=Ve(this._handles),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get hasPendingInputs(){var e;return!!((e=this._inputManager)!=null&&e.hasPendingInputs)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=Ve(this._inputManager)}connect(){const e=this.view;this._source=new dTe(this.view.surface,e.input);const r=[new Dit,new Nit,new Lit,new Iit(this.view.navigation),new Uit],i=new gf({eventSource:this._source,recognizers:r});this._inputManager=i,i.installHandlers("prevent-context-menu",[new Oit],j_.INTERNAL),this._modeDragPan=new hoe(e,"primary"),this._modeDragRotate=new A9(e,"secondary",vc.CENTER),this._modeDragZoom=new tit(e,"tertiary");const s={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new _it(e),new zrt(e),new cit(e),new uit(e,s.pan),new hit(e),new bit(e,s.resetTilt),new vit(e,s.resetHeading),new A9(e,"primary",vc.EYE,[s.lookAround]),new A9(e,"secondary",vc.CENTER,[s.lookAround]),new hoe(e,"tertiary",[s.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new wit(e)],j_.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this._handles.add(ne(()=>{var n;return(n=this.view.navigation)==null?void 0:n.browserTouchPanEnabled},n=>{this._source.browserTouchPanningEnabled=!n},kt))}_updateMode(){var s;const e=this.mode,r=this.primaryDragAction,i=(s=UH.get(e))==null?void 0:s.get(r);i&&(this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],Nd.prototype,"view",void 0),u([d({value:"pan"})],Nd.prototype,"primaryDragAction",null),u([d({value:"default"})],Nd.prototype,"mode",null),u([d({readOnly:!0})],Nd.prototype,"hasPendingInputs",null),u([d()],Nd.prototype,"latestPointerType",null),u([d()],Nd.prototype,"latestPointerLocation",null),u([d()],Nd.prototype,"multiTouchActive",null),u([d()],Nd.prototype,"_inputManager",void 0),Nd=u([P("esri.views.3d.input.SceneInputManager")],Nd);const UH=new Map,M9=new Map,P9=new Map;M9.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),M9.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),P9.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),P9.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),UH.set("default",M9),UH.set("pro",P9);const Vit=Nd;let _u,RS,VH=!1,kH=!1,zH=!1,BH=!1,VO=null;function kit(t,e){if(!kH||!RS)return;gTe();const r=RS;let i=0;for(let s=0;s<t.accBinsNumX;s++)for(let n=0;n<t.accBinsNumY;n++){const o=t.accBins[s][t.accBinsNumY-1-n];i+=o.length;const a=s*t.accBinsSizeX,l=(s+1)*t.accBinsSizeX,c=n*t.accBinsSizeY,h=(n+1)*t.accBinsSizeY;r.fillText(o.length.toFixed(),a+5,c+15),yTe(a,l,c,h,"blue")}r.fillText("total totalShownLabels: "+i,70,40),r.fillText("total visible labels: "+e.size,70,50),r.fillText("total numTests: "+t.accNumTests,70,30)}function zit(t){zH=Wr.DECONFLICTOR_SHOW_VISIBLE,BH=Wr.DECONFLICTOR_SHOW_INVISIBLE,VH=zH||BH,kH=Wr.DECONFLICTOR_SHOW_GRID,VO=null,VH||kH?VO=()=>Bit(t):_u&&(_u.parentElement.removeChild(_u),_u=null)}function gTe(){VO&&(VO(),VO=null)}function Bit(t){_u==null&&(_u=document.createElement("canvas"),_u.setAttribute("id","canvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(_u));const{state:e}=t,{camera:r,pixelRatio:i}=e,{width:s,height:n}=r,o=s*i,a=n*i;_u.setAttribute("width",`${o}px`),_u.setAttribute("height",`${a}px`),_u.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),RS=_u.getContext("2d"),RS.clearRect(0,0,s,n),RS.font="12px Arial"}function yTe(t,e,r,i,s){gTe();const n=_u.height,o=RS;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(t,n-r),o.lineTo(e,n-r),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-r),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.closePath()}function Git(t,e){VH&&(e&&zH||!e&&BH)&&yTe(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red")}var Oo,Ac;(function(t){t[t.GRAPHIC=0]="GRAPHIC",t[t.LABEL=1]="LABEL",t[t._COUNT=2]="_COUNT"})(Oo||(Oo={})),function(t){t[t.USER_SETTING=0]="USER_SETTING",t[t.SCALE_RANGE=1]="SCALE_RANGE",t[t.FILTER=2]="FILTER",t[t.DECONFLICTION=3]="DECONFLICTION",t[t._COUNT=4]="_COUNT"}(Ac||(Ac={}));function _Te(t,e){return new xTe(t,STe,e)}function jit(t,e){const{curvatureDependent:r,scaleStart:i,scaleFallOffRange:s}=STe;return new xTe(t,{curvatureDependent:{min:{curvature:r.min.curvature,tiltAngle:r.min.tiltAngle,scaleFallOffFactor:I9.curvatureDependent.min.scaleFallOffFactor},max:{curvature:r.max.curvature,tiltAngle:r.max.tiltAngle,scaleFallOffFactor:I9.curvatureDependent.max.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:s,minPixelSize:I9.minPixelSize},e)}function Hit(t){return Math.abs(t*t*t)}function vTe(t,e,r){const i=r.parameters,s=r.paddingPixelsOverride;return JC.scale=Math.min(i.divisor/(e-i.offset),1),JC.factor=Hit(t),JC.minPixelSize=i.minPixelSize,JC.paddingPixels=s,JC}function bTe(t,e){return t===0?e.minPixelSize:e.minPixelSize*(1+2*e.paddingPixels/t)}function CJ(t,e){return Math.max(Ft(t*e.scale,t,e.factor),bTe(t,e))}function qit(t,e,r){const i=vTe(t,e,r);return i.minPixelSize=0,i.paddingPixels=0,CJ(1,i)}function goe(t,e,r,i){i.scale=qit(t,e,r),i.factor=0,i.minPixelSize=r.parameters.minPixelSize,i.paddingPixels=r.paddingPixelsOverride}function wTe(t,e,r=[0,0]){const i=Math.min(Math.max(e.scale,bTe(t[1],e)/Math.max(1e-5,t[1])),1);return r[0]=t[0]*i,r[1]=t[1]*i,r}function Wit(t,e,r,i){return CJ(t,vTe(e,r,i))}let xTe=class TTe{get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}constructor(e,r,i,s=Xit(),n){this._viewingMode=e,this._description=r,this._ellipsoidRadius=i,this.parameters=s,this._paddingPixelsOverride=n,this._viewingMode===Be.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),!0)}overridePadding(e){return e!==this.paddingPixelsOverride?new TTe(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,r,i){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this._description,{fovY:a,distance:l}=e,c=this._calculateCurvatureDependentParameters(e,r),h=this._coverageCompensation(e,r,c),{tiltAngle:p,scaleFallOffFactor:f}=c,m=Math.sin(p)*l,y=.5*Math.PI-p-a*(.5-s*h),_=m/Math.cos(y),b=y+a*n*h,x=(_-f*(m/Math.cos(b)))/(1-f);return i.camera.fovY=e.fovY,i.camera.distance=e.distance,i.offset=x,i.divisor=_-x,i.minPixelSize=o,i}_calculateCurvatureDependentParametersLocal(e,r,i=yoe){return i.tiltAngle=this._description.curvatureDependent.min.tiltAngle,i.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,i}_calculateCurvatureDependentParametersGlobal(e,r,i=yoe){const s=this._description.curvatureDependent,n=1+e.distance/r,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=ye((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return i.tiltAngle=Ft(h.tiltAngle,p.tiltAngle,c),i.scaleFallOffFactor=Ft(h.scaleFallOffFactor,p.scaleFallOffFactor,c),i}_surfaceCoverageCompensationLocal(e,r,i){return(e.fovY-i.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,r,i){const s=r*r,n=i.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=e,l=a*a+s-2*Math.cos(n)*a*r,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(r/(c/Math.sin(n)))+.5*o)/o}};const STe={curvatureDependent:{min:{curvature:jt(10),tiltAngle:jt(12),scaleFallOffFactor:.5},max:{curvature:jt(70),tiltAngle:jt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},I9={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function Xit(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const JC={scale:0,factor:0,minPixelSize:0,paddingPixels:0},yoe={tiltAngle:0,scaleFallOffFactor:0};function Yit(t){return t instanceof Float32Array&&t.length>=16}function Zit(t){return Array.isArray(t)&&t.length>=16}function Jit(t){return Yit(t)||Zit(t)}function AJ(t){t.vertex.code.add(w`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),t.vertex.code.add(w`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),t.vertex.code.add(w`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),t.vertex.code.add(w`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),t.vertex.code.add(w`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),t.vertex.code.add(w`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),t.vertex.code.add(w`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function Kit(t){t.uniforms.add(new fr("screenSizePerspective",e=>ETe(e.screenSizePerspective)))}function E6(t){t.uniforms.add(new fr("screenSizePerspectiveAlignment",e=>ETe(e.screenSizePerspectiveAlignment||e.screenSizePerspective)))}function ETe(t){return ti(Qit,t.parameters.divisor,t.parameters.offset,t.parameters.minPixelSize,t.paddingPixelsOverride)}const Qit=nr();let CTe=class extends ws{constructor(e,r){super(e,"mat4",di.Draw,(i,s,n)=>i.setUniformMatrix4fv(e,r(s,n)))}};function Cp(t,e){e.instancedDoublePrecision?t.constants.add("cameraPosition","vec3",wa):t.uniforms.add(new Lu("cameraPosition",(r,i)=>ce(ATe,i.camera.viewInverseTransposeMatrix[3]-r.origin[0],i.camera.viewInverseTransposeMatrix[7]-r.origin[1],i.camera.viewInverseTransposeMatrix[11]-r.origin[2])))}function Nc(t,e){if(!e.instancedDoublePrecision)return void t.uniforms.add([new qi("proj",(i,s)=>s.camera.projectionMatrix),new CTe("view",(i,s)=>ql(_oe,s.camera.viewMatrix,i.origin)),new Lu("localOrigin",i=>i.origin)]);const r=i=>ce(ATe,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]);t.uniforms.add([new qi("proj",(i,s)=>s.camera.projectionMatrix),new qi("view",(i,s)=>ql(_oe,s.camera.viewMatrix,r(s))),new Wt("localOrigin",(i,s)=>r(s))])}const _oe=zM(),ATe=M();function OE(t){t.uniforms.add(new qi("viewNormal",(e,r)=>r.camera.viewInverseTransposeMatrix))}function RTe(t,e){const r=t.vertex;e.hasVerticalOffset?(OTe(r),e.hasScreenSizePerspective&&(t.include(AJ),E6(r),Cp(t.vertex,e)),r.code.add(w`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${e.spherical?w`vec3 worldNormal = normalize(worldPos + localOrigin);`:w`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${e.hasScreenSizePerspective?w`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:w`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):r.code.add(w`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const est=nr();function OTe(t){t.uniforms.add(new fr("verticalOffset",(e,r)=>{const{minWorldLength:i,maxWorldLength:s,screenLength:n}=e.verticalOffset,o=Math.tan(.5*r.camera.fovY)/(.5*r.camera.fullViewport[3]),a=r.camera.pixelRatio||1;return ti(est,n*a,o,i,s)}))}var fu;(function(t){t[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT"})(fu||(fu={}));var zl;function MTe(t,e){t.include(AJ),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.NORMAL,"vec3"),t.attributes.add(A.AUXPOS1,"vec4");const r=t.vertex;Nc(r,e),Cp(r,e),r.uniforms.add([new fr("viewport",(i,s)=>s.camera.fullViewport),new Pe("polygonOffset",i=>i.shaderPolygonOffset),new Pe("cameraGroundRelative",(i,s)=>s.camera.aboveGround?1:-1),new Pe("renderTransparentlyOccludedHUD",(i,s)=>s.renderTransparentlyOccludedHUD===fu.Occluded?1:s.renderTransparentlyOccludedHUD===fu.NotOccluded?0:.75),new Pt("hudVisibilityTexture",(i,s)=>s.hudVisibilityTexture)]),e.hasVerticalOffset&&OTe(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add(w`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.code.add(w`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),e.isDraped&&!e.hasVerticalOffset||OE(r),e.isDraped||(r.uniforms.add(new Pe("perDistancePixelRatio",(i,s)=>Math.tan(s.camera.fovY/2)/(s.camera.fullViewport[2]/2))),r.code.add(w`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`)),e.screenCenterOffsetUnitsEnabled===zl.Screen&&r.uniforms.add(new Pe("pixelRatio",(i,s)=>s.camera.pixelRatio)),e.hasScreenSizePerspective&&E6(r),r.code.add(w`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${e.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${e.hasScreenSizePerspective&&(e.hasVerticalOffset||e.screenCenterOffsetUnitsEnabled===zl.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${e.hasVerticalOffset?e.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${e.hasVerticalOffset?w`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${e.screenCenterOffsetUnitsEnabled!==zl.Screen?w`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${e.screenCenterOffsetUnitsEnabled===zl.Screen?e.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${e.screenCenterOffsetUnitsEnabled===zl.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),r.code.add(w`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}(function(t){t[t.World=0]="World",t[t.Screen=1]="Screen",t[t.COUNT=2]="COUNT"})(zl||(zl={}));const r$=Rn();function PTe(t,e,r,i,s,n){if(t.visible)if(t.boundingInfo){gt(t.type===$s.Mesh);const o=e.tolerance;ITe(t.boundingInfo,r,i,o,s,n)}else{const o=t.indices.get(A.POSITION),a=t.vertexAttributes.get(A.POSITION);nP(r,i,0,o.length/3,o,a,void 0,s,n)}}const tst=M();function ITe(t,e,r,i,s,n){if(C(t))return;const o=LTe(e,r,tst);if(lge(r$,t.bbMin),cge(r$,t.bbMax),v(s)&&s.applyToAabb(r$),OJ(r$,e,o,i)){const{primitiveIndices:a,indices:l,position:c}=t,h=a?a.length:l.length/3;if(h>nst){const p=t.getChildren();if(p!==void 0){for(const f of p)ITe(f,e,r,i,s,n);return}}nP(e,r,0,h,l,c,a,s,n)}}const $Te=M();function nP(t,e,r,i,s,n,o,a,l){if(o)return rst(t,e,r,i,s,n,o,a,l);const{data:c,stride:h}=n,p=t[0],f=t[1],m=t[2],y=e[0]-p,_=e[1]-f,b=e[2]-m;for(let x=r,T=3*r;x<i;++x){let S=h*s[T++],E=c[S++],O=c[S++],R=c[S];S=h*s[T++];let L=c[S++],I=c[S++],U=c[S];S=h*s[T++];let z=c[S++],B=c[S++],G=c[S];v(a)&&([E,O,R]=a.applyToVertex(E,O,R,x),[L,I,U]=a.applyToVertex(L,I,U,x),[z,B,G]=a.applyToVertex(z,B,G,x));const K=L-E,re=I-O,ee=U-R,q=z-E,$=B-O,N=G-R,F=_*N-$*b,H=b*q-N*y,X=y*$-q*_,J=K*F+re*H+ee*X;if(Math.abs(J)<=Number.EPSILON)continue;const W=p-E,ue=f-O,pe=m-R,we=W*F+ue*H+pe*X;if(J>0){if(we<0||we>J)continue}else if(we>0||we<J)continue;const Ce=ue*ee-re*pe,je=pe*K-ee*W,De=W*re-K*ue,xe=y*Ce+_*je+b*De;if(J>0){if(xe<0||we+xe>J)continue}else if(xe>0||we+xe<J)continue;const Ne=(q*Ce+$*je+N*De)/J;Ne>=0&&l(Ne,RJ(K,re,ee,q,$,N,$Te),x,!1)}}function rst(t,e,r,i,s,n,o,a,l){const{data:c,stride:h}=n,p=t[0],f=t[1],m=t[2],y=e[0]-p,_=e[1]-f,b=e[2]-m;for(let x=r;x<i;++x){const T=o[x];let S=3*T,E=h*s[S++],O=c[E++],R=c[E++],L=c[E];E=h*s[S++];let I=c[E++],U=c[E++],z=c[E];E=h*s[S];let B=c[E++],G=c[E++],K=c[E];v(a)&&([O,R,L]=a.applyToVertex(O,R,L,x),[I,U,z]=a.applyToVertex(I,U,z,x),[B,G,K]=a.applyToVertex(B,G,K,x));const re=I-O,ee=U-R,q=z-L,$=B-O,N=G-R,F=K-L,H=_*F-N*b,X=b*$-F*y,J=y*N-$*_,W=re*H+ee*X+q*J;if(Math.abs(W)<=Number.EPSILON)continue;const ue=p-O,pe=f-R,we=m-L,Ce=ue*H+pe*X+we*J;if(W>0){if(Ce<0||Ce>W)continue}else if(Ce>0||Ce<W)continue;const je=pe*q-ee*we,De=we*re-q*ue,xe=ue*ee-re*pe,Ne=y*je+_*De+b*xe;if(W>0){if(Ne<0||Ce+Ne>W)continue}else if(Ne>0||Ce+Ne<W)continue;const Ue=($*je+N*De+F*xe)/W;Ue>=0&&l(Ue,RJ(re,ee,q,$,N,F,$Te),T,!1)}}const voe=M(),boe=M();function RJ(t,e,r,i,s,n,o){return ce(voe,t,e,r),ce(boe,i,s,n),pt(o,voe,boe),ve(o,o),o}function LTe(t,e,r){return ce(r,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function OJ(t,e,r,i){return MJ(t,e,r,i,1/0)}function MJ(t,e,r,i,s){const n=(t[0]-i-e[0])*r[0],o=(t[3]+i-e[0])*r[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(t[1]-i-e[1])*r[1],h=(t[4]+i-e[1])*r[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(t[2]-i-e[2])*r[2],f=(t[5]+i-e[2])*r[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function DTe(t,e,r,i,s){let n=(r.screenLength||0)*t.pixelRatio;v(s)&&(n=Wit(n,i,e,s));const o=n*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return ye(o*e,r.minWorldLength||0,r.maxWorldLength!=null?r.maxWorldLength:1/0)}function NTe(t,e){const r=e?NTe(e):{};for(const i in t){let s=t[i];s&&s.forEach&&(s=sst(s)),s==null&&i in r||(r[i]=s)}return r}function ist(t,e){let r=!1;for(const i in e){const s=e[i];s!==void 0&&(Array.isArray(s)?t[i]===null?(t[i]=s.slice(),r=!0):Kq(t[i],s)&&(r=!0):t[i]!==s&&(r=!0,t[i]=s))}return r}function sst(t){const e=[];return t.forEach(r=>e.push(r)),e}const FTe={multiply:1,ignore:2,replace:3,tint:4},nst=1e3;let Pv=class extends rP{constructor(e,r){super(),this.type=$s.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=Ar,this._pp0=$e(0,0,1),this._pp1=$e(0,0,0),this._parameters=NTe(e,r),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e,r=!0){ist(this._parameters,e)&&(this.validateParameters(this._parameters),r&&this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleForOutput(e.output)&&(this.renderOccluded&e.renderOccludedMask)!=0}isVisibleForOutput(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){v(this.repository)&&this.repository.materialChanged(this)}intersectDraped(e,r,i,s,n,o){return this._pp0[0]=this._pp1[0]=s[0],this._pp0[1]=this._pp1[1]=s[1],this.intersect(e,r,i,this._pp0,this._pp1,n)}},UTe=class extends JQe{constructor(e,r,i){super(r,i),this.camera=e}};var as;(function(t){t[t.Occlude=1]="Occlude",t[t.Transparent=2]="Transparent",t[t.OccludeAndTransparent=4]="OccludeAndTransparent",t[t.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",t[t.Opaque=16]="Opaque"})(as||(as={}));let pC=class extends pi{constructor(){super(...arguments),this.renderOccluded=as.Occlude}},VTe=class{constructor(){this.factor=new woe,this.factorAlignment=new woe}},woe=class{constructor(){this.scale=0,this.factor=0,this.minPixelSize=0,this.paddingPixels=0}};function ZPt(t,e,r,i,s=1){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s===1)for(let l=0;l<a;++l)n[i]=e[t[l]],i+=o;else for(let l=0;l<a;++l){const c=e[t[l]];for(let h=0;h<s;h++)n[i]=c,i+=o}}function ost(t,e,r,i){const s=r.typedBuffer,n=r.typedBufferStride,o=t.length;i*=n;for(let a=0;a<o;++a){const l=2*t[a];s[i]=e[l],s[i+1]=e[l+1],i+=n}}function kTe(t,e,r,i,s){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*t[l];n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],i+=o}else for(let l=0;l<a;++l){const c=3*t[l];for(let h=0;h<s;++h)n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],i+=o}}function ME(t,e,r,i,s=1){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s===1)for(let l=0;l<a;++l){const c=4*t[l];n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],n[i+3]=e[c+3],i+=o}else for(let l=0;l<a;++l){const c=4*t[l];for(let h=0;h<s;++h)n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],n[i+3]=e[c+3],i+=o}}function xoe(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride;e*=s;for(let n=0;n<r;++n)i[e]=0,i[e+1]=0,i[e+2]=0,i[e+3]=0,e+=s}function C6(t,e,r,i,s,n=1){if(!r)return void kTe(t,e,i,s,n);const o=i.typedBuffer,a=i.typedBufferStride,l=t.length,c=r[0],h=r[1],p=r[2],f=r[4],m=r[5],y=r[6],_=r[8],b=r[9],x=r[10],T=r[12],S=r[13],E=r[14];s*=a;let O=0,R=0,L=0;const I=n5(r)?U=>{O=e[U]+T,R=e[U+1]+S,L=e[U+2]+E}:U=>{const z=e[U],B=e[U+1],G=e[U+2];O=c*z+f*B+_*G+T,R=h*z+m*B+b*G+S,L=p*z+y*B+x*G+E};if(n===1)for(let U=0;U<l;++U)I(3*t[U]),o[s]=O,o[s+1]=R,o[s+2]=L,s+=a;else for(let U=0;U<l;++U){I(3*t[U]);for(let z=0;z<n;++z)o[s]=O,o[s+1]=R,o[s+2]=L,s+=a}}function PJ(t,e,r,i,s,n=1){if(!r)return void kTe(t,e,i,s,n);const o=r,a=i.typedBuffer,l=i.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],m=o[4],y=o[5],_=o[6],b=o[8],x=o[9],T=o[10],S=!pX(o),E=1e-6,O=1-E;s*=l;let R=0,L=0,I=0;const U=n5(o)?z=>{R=e[z],L=e[z+1],I=e[z+2]}:z=>{const B=e[z],G=e[z+1],K=e[z+2];R=h*B+m*G+b*K,L=p*B+y*G+x*K,I=f*B+_*G+T*K};if(n===1)if(S)for(let z=0;z<c;++z){U(3*t[z]);const B=R*R+L*L+I*I;if(B<O&&B>E){const G=1/Math.sqrt(B);a[s]=R*G,a[s+1]=L*G,a[s+2]=I*G}else a[s]=R,a[s+1]=L,a[s+2]=I;s+=l}else for(let z=0;z<c;++z)U(3*t[z]),a[s]=R,a[s+1]=L,a[s+2]=I,s+=l;else for(let z=0;z<c;++z){if(U(3*t[z]),S){const B=R*R+L*L+I*I;if(B<O&&B>E){const G=1/Math.sqrt(B);R*=G,L*=G,I*=G}}for(let B=0;B<n;++B)a[s]=R,a[s+1]=L,a[s+2]=I,s+=l}}function ast(t,e,r,i,s,n=1){if(!r)return void ME(t,e,i,s,n);const o=r,a=i.typedBuffer,l=i.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],m=o[4],y=o[5],_=o[6],b=o[8],x=o[9],T=o[10],S=!pX(o),E=1e-6,O=1-E;if(s*=l,n===1)for(let R=0;R<c;++R){const L=4*t[R],I=e[L],U=e[L+1],z=e[L+2],B=e[L+3];let G=h*I+m*U+b*z,K=p*I+y*U+x*z,re=f*I+_*U+T*z;if(S){const ee=G*G+K*K+re*re;if(ee<O&&ee>E){const q=1/Math.sqrt(ee);G*=q,K*=q,re*=q}}a[s]=G,a[s+1]=K,a[s+2]=re,a[s+3]=B,s+=l}else for(let R=0;R<c;++R){const L=4*t[R],I=e[L],U=e[L+1],z=e[L+2],B=e[L+3];let G=h*I+m*U+b*z,K=p*I+y*U+x*z,re=f*I+_*U+T*z;if(S){const ee=G*G+K*K+re*re;if(ee<O&&ee>E){const q=1/Math.sqrt(ee);G*=q,K*=q,re*=q}}for(let ee=0;ee<n;++ee)a[s]=G,a[s+1]=K,a[s+2]=re,a[s+3]=B,s+=l}}function IJ(t,e,r,i,s,n=1){const o=i.typedBuffer,a=i.typedBufferStride,l=t.length;if(s*=a,r!==e.length||r!==4)if(n!==1)if(r!==4)for(let c=0;c<l;++c){const h=3*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}else for(let c=0;c<l;++c){const h=4*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}else{if(r===4){for(let c=0;c<l;++c){const h=4*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}return}for(let c=0;c<l;++c){const h=3*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}}else{o[s]=e[0],o[s+1]=e[1],o[s+2]=e[2],o[s+3]=e[3];const c=new Uint32Array(i.typedBuffer.buffer,i.start),h=a/4,p=c[s/=4];s+=h;const f=l*n;for(let m=1;m<f;++m)c[s]=p,s+=h}}function zTe(t,e,r,i,s=1){const n=e.typedBuffer,o=e.typedBufferStride;if(i*=o,s===1)for(let a=0;a<r;++a)n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3],i+=o;else for(let a=0;a<r;++a)for(let l=0;l<s;++l)n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3],i+=o}function BTe(t,e,r,i,s,n){for(const o of e.fieldNames){const a=t.vertexAttributes.get(o),l=t.indices.get(o);if(a&&l)switch(o){case A.POSITION:{gt(a.size===3);const c=s.getField(o,Ii);gt(!!c,`No buffer view for ${o}`),c&&C6(l,a.data,r,c,n);break}case A.NORMAL:{gt(a.size===3);const c=s.getField(o,Ii);gt(!!c,`No buffer view for ${o}`),c&&PJ(l,a.data,i,c,n);break}case A.UV0:{gt(a.size===2);const c=s.getField(o,Ay);gt(!!c,`No buffer view for ${o}`),c&&ost(l,a.data,c,n);break}case A.COLOR:case A.SYMBOLCOLOR:{gt(a.size===3||a.size===4);const c=s.getField(o,Aa);gt(!!c,`No buffer view for ${o}`),c&&IJ(l,a.data,a.size,c,n);break}case A.TANGENT:{gt(a.size===4);const c=s.getField(o,zc);gt(!!c,`No buffer view for ${o}`),c&&ast(l,a.data,i,c,n);break}case A.PROFILERIGHT:case A.PROFILEUP:case A.PROFILEVERTEXANDNORMAL:case A.FEATUREVALUE:{gt(a.size===4);const c=s.getField(o,zc);gt(!!c,`No buffer view for ${o}`),c&&ME(l,a.data,c,n)}}else if(o===A.OBJECTANDLAYERIDCOLOR&&v(t.objectAndLayerIdColor)){const c=t.indices.get(A.POSITION);if(gt(!!c,`No buffer view for ${o}`),c){const h=c.length,p=s.getField(o,Aa);zTe(t.objectAndLayerIdColor,p,h,n)}}}}function H3(t,e,r=0){const i=ye(t,0,ust);for(let s=0;s<4;s++)e[r+s]=Math.floor(256*hst(i*lst[s]))}function $J(t,e=0){let r=0;for(let i=0;i<4;i++)r+=t[e+i]*cst[i];return r}const lst=[1,256,65536,16777216],cst=[1/256,1/65536,1/16777216,1/4294967296],ust=$J(new Uint8ClampedArray([255,255,255,255]));function hst(t){return t-Math.floor(t)}async function dy(t,e){const{data:r}=await Pi(t,{responseType:"image",...e});return r}let LJ=class extends pi{constructor(){super(...arguments),this.color=qt(1,1,1,1)}};function dst(){const t=new Lr;return t.include(sd),t.fragment.uniforms.add([new Pt("tex",e=>e.texture),new fr("uColor",e=>e.color)]),t.fragment.code.add(w`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),t}const pst=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:LJ,build:dst},Symbol.toStringTag,{value:"Module"}));function fst(){if(C($9)){const t=e=>Kr(`esri/libs/basisu/${e}`);$9=ie(()=>import("./basis_transcoder-e0466ff6.js"),["./basis_transcoder-e0466ff6.js","./_commonjsHelpers-2f3e7994.js"],import.meta.url).then(e=>e.b).then(({default:e})=>e({locateFile:t}).then(r=>(r.initializeBasis(),delete r.then,r)))}return $9}let $9;var Nb;(function(t){t[t.ETC1_RGB=0]="ETC1_RGB",t[t.ETC2_RGBA=1]="ETC2_RGBA",t[t.BC1_RGB=2]="BC1_RGB",t[t.BC3_RGBA=3]="BC3_RGBA",t[t.BC4_R=4]="BC4_R",t[t.BC5_RG=5]="BC5_RG",t[t.BC7_M6_RGB=6]="BC7_M6_RGB",t[t.BC7_M5_RGBA=7]="BC7_M5_RGBA",t[t.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",t[t.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",t[t.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",t[t.ATC_RGB=11]="ATC_RGB",t[t.ATC_RGBA=12]="ATC_RGBA",t[t.FXT1_RGB=17]="FXT1_RGB",t[t.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",t[t.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",t[t.ETC2_EAC_R11=20]="ETC2_EAC_R11",t[t.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",t[t.RGBA32=13]="RGBA32",t[t.RGB565=14]="RGB565",t[t.BGR565=15]="BGR565",t[t.RGBA4444=16]="RGBA4444"})(Nb||(Nb={}));let mp=null,i$=null;async function GTe(){return C(i$)&&(i$=fst(),mp=await i$),i$}function mst(t,e){if(C(mp))return t.byteLength;const r=new mp.BasisFile(new Uint8Array(t)),i=HTe(r)?jTe(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),e):0;return r.close(),r.delete(),i}function gst(t,e){if(C(mp))return t.byteLength;const r=new mp.KTX2File(new Uint8Array(t)),i=qTe(r)?jTe(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),e):0;return r.close(),r.delete(),i}function jTe(t,e,r,i,s){const n=xwe(e?Ms.COMPRESSED_RGBA8_ETC2_EAC:Ms.COMPRESSED_RGB8_ETC2),o=s&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(r*i*n*o)}function HTe(t){return t.getNumImages()>=1&&!t.isUASTC()}function qTe(t){return t.getFaces()>=1&&t.isETC1S()}async function yst(t,e,r){C(mp)&&(mp=await GTe());const i=new mp.BasisFile(new Uint8Array(r));if(!HTe(i))return null;i.startTranscoding();const s=WTe(t,e,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),(n,o)=>i.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>i.transcodeImage(a,0,n,o,0,0));return i.close(),i.delete(),s}async function _st(t,e,r){C(mp)&&(mp=await GTe());const i=new mp.KTX2File(new Uint8Array(r));if(!qTe(i))return null;i.startTranscoding();const s=WTe(t,e,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),(n,o)=>i.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>i.transcodeImage(a,n,0,0,o,0,-1,-1));return i.close(),i.delete(),s}function WTe(t,e,r,i,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=t.capabilities,[h,p]=l?i?[Nb.ETC2_RGBA,Ms.COMPRESSED_RGBA8_ETC2_EAC]:[Nb.ETC1_RGB,Ms.COMPRESSED_RGB8_ETC2]:c?i?[Nb.BC3_RGBA,Ms.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[Nb.BC1_RGB,Ms.COMPRESSED_RGB_S3TC_DXT1_EXT]:[Nb.RGBA32,ze.RGBA],f=e.hasMipmap?r:Math.min(1,r),m=[];for(let x=0;x<f;x++)m.push(new Uint8Array(o(x,h))),a(x,h,m[x]);const y=m.length>1,_=y?tt.LINEAR_MIPMAP_LINEAR:tt.LINEAR,b={...e,samplingMode:_,hasMipmap:y,internalFormat:p,width:s,height:n};return new ct(t,b,{type:"compressed",levels:m})}const KC=se.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),vst=542327876,bst=131072,wst=4;function DJ(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function xst(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const Tst=DJ("DXT1"),Sst=DJ("DXT3"),Est=DJ("DXT5"),Cst=31,Ast=0,Rst=1,Ost=2,Mst=3,Pst=4,Ist=7,$st=20,Lst=21;function Dst(t,e,r){const{textureData:i,internalFormat:s,width:n,height:o}=Fl(Nst(r,e.hasMipmap??!1));return e.samplingMode=i.levels.length>1?tt.LINEAR_MIPMAP_LINEAR:tt.LINEAR,e.hasMipmap=i.levels.length>1,e.internalFormat=s,e.width=n,e.height=o,new ct(t,e,i)}function Nst(t,e){const r=new Int32Array(t,0,Cst);if(r[Ast]!==vst)return KC.error("Invalid magic number in DDS header"),null;if(!(r[$st]&wst))return KC.error("Unsupported format, must contain a FourCC code"),null;const i=r[Lst];let s,n;switch(i){case Tst:s=8,n=Ms.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Sst:s=16,n=Ms.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Est:s=16,n=Ms.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return KC.error("Unsupported FourCC code:",xst(i)),null}let o=1,a=r[Pst],l=r[Mst];!(3&a)&&!(3&l)||(KC.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;r[Ost]&bst&&e!==!1&&(o=Math.max(1,r[Ist])),o===1||vp(a)&&vp(l)||(KC.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let m=r[Rst]+4;const y=[];for(let _=0;_<o;++_)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(t,m,f),y.push(p),m+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:y},internalFormat:n,width:c,height:h}}let fx=class KD extends rP{constructor(e,r){super(),this._data=e,this.type=$s.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new Fs,this._passParameters=new LJ,this.params=r||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:Ot.REPEAT,t:Ot.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||H_.STRETCH,this.estimatedTexMemRequired=KD._estimateTexMemRequired(this._data,this.params),this._startPreload()}_startPreload(){const e=this._data;C(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!(FS(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const r=!e.paused;if(e.src=e.src,r&&e.autoplay){const i=()=>{e.removeEventListener("canplay",i),e.play()};e.addEventListener("canplay",i)}}}_startPreloadImageElement(e){bm(e.src)||FS(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,r){if(C(e))return 0;if(_C(e)||Tb(e))return r.encoding===Dg.KTX2_ENCODING?gst(e,!!r.mipmap):r.encoding===Dg.BASIS_ENCODING?mst(e,!!r.mipmap):e.byteLength;const{width:i,height:s}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?KD._getDataDimensions(e):r;return(r.mipmap?4/3:1)*i*s*(r.components||4)||0}dispose(){this._data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){return{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?tt.LINEAR_MIPMAP_LINEAR:tt.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?e.parameters.maxMaxAnisotropy:1)}}get glTexture(){return this._glTexture}load(e,r){if(v(this._glTexture))return this._glTexture;if(v(this._loadingPromise))return this._loadingPromise;const i=this._data;return C(i)?(this._glTexture=new ct(e,this._createDescriptor(e),null),this._glTexture):typeof i=="string"?this._loadFromURL(e,r,i):i instanceof Image?this._loadFromImageElement(e,r,i):i instanceof HTMLVideoElement?this._loadFromVideoElement(e,r,i):i instanceof ImageData||i instanceof HTMLCanvasElement?this._loadFromImage(e,i,r):(_C(i)||Tb(i))&&this.params.encoding===Dg.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,i)):(_C(i)||Tb(i))&&this.params.encoding===Dg.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,i)):(_C(i)||Tb(i))&&this.params.encoding===Dg.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,i)):Tb(i)?this._loadFromPixelData(e,i):_C(i)?this._loadFromPixelData(e,new Uint8Array(i)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(e,r,i){if(!(this._data instanceof HTMLVideoElement)||C(this._glTexture)||this._data.readyState<kO.HAVE_CURRENT_DATA||i===this._data.currentTime)return i;if(v(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:n,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this._data),this._drawStretchedTexture(e,r,s,n,o,this._glTexture)}else{const{videoWidth:s,videoHeight:n}=this._data,{width:o,height:a}=this._glTexture.descriptor;s!==o||n!==a?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(n,a),this._data):this._glTexture.setData(this._data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this._data.currentTime}_loadFromDDSData(e,r){return this._glTexture=Dst(e,this._createDescriptor(e),r),this._glTexture}_loadFromKTX2(e,r){return this._loadAsync(()=>_st(e,this._createDescriptor(e),r).then(i=>(this._glTexture=i,i)))}_loadFromBasis(e,r){return this._loadAsync(()=>yst(e,this._createDescriptor(e),r).then(i=>(this._glTexture=i,i)))}_loadFromPixelData(e,r){gt(this.params.width>0&&this.params.height>0);const i=this._createDescriptor(e);return i.pixelFormat=this.params.components===1?ze.LUMINANCE:this.params.components===3?ze.RGB:ze.RGBA,i.width=this.params.width,i.height=this.params.height,this._glTexture=new ct(e,i,r),this._glTexture}_loadFromURL(e,r,i){return this._loadAsync(async s=>{const n=await dy(i,{signal:s});return ur(s),this._loadFromImage(e,n,r)})}_loadFromImageElement(e,r,i){return i.complete?this._loadFromImage(e,i,r):this._loadAsync(async s=>{const n=await _pe(i,i.src,!1,s);return ur(s),this._loadFromImage(e,n,r)})}_loadFromVideoElement(e,r,i){return i.readyState>=kO.HAVE_CURRENT_DATA?this._loadFromImage(e,i,r):this._loadFromVideoElementAsync(e,r,i)}_loadFromVideoElementAsync(e,r,i){return this._loadAsync(s=>new Promise((n,o)=>{const a=()=>{i.removeEventListener("loadeddata",l),i.removeEventListener("error",c),Vi(h)},l=()=>{i.readyState>=kO.HAVE_CURRENT_DATA&&(a(),n(this._loadFromImage(e,i,r)))},c=p=>{a(),o(p||new j("Failed to load video"))};i.addEventListener("loadeddata",l),i.addEventListener("error",c);const h=ba(s,()=>c(qr()))}))}_loadFromImage(e,r,i){const s=KD._getDataDimensions(r);this.params.width=s.width,this.params.height=s.height;const n=this._createDescriptor(e);return n.pixelFormat=this.params.components===3?ze.RGB:ze.RGBA,!this._requiresPowerOfTwo(e,n)||vp(s.width)&&vp(s.height)?(n.width=s.width,n.height=s.height,this._glTexture=new ct(e,n,r),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,r,s,n,i),this._glTexture)}_loadAsync(e){const r=new AbortController;this._loadingController=r;const i=e(r.signal);this._loadingPromise=i;const s=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null)};return i.then(s,s),i}_requiresPowerOfTwo(e,r){const i=Ot.CLAMP_TO_EDGE,s=typeof r.wrapMode=="number"?r.wrapMode===i:r.wrapMode.s===i&&r.wrapMode.t===i;return e.type===bt.WEBGL1&&(r.hasMipmap||!s)}_makePowerOfTwoTexture(e,r,i,s,n){const{width:o,height:a}=i,l=qS(o),c=qS(a);let h;switch(s.width=l,s.height=c,this.params.powerOfTwoResizeMode){case H_.PAD:s.textureCoordinateScaleFactor=[o/l,a/c],h=new ct(e,s),h.updateData(0,0,0,o,a,r);break;case H_.STRETCH:case null:case void 0:h=this._stretchToPowerOfTwo(e,r,s,n());break;default:this.params.powerOfTwoResizeMode}return s.hasMipmap&&h.generateMipmap(),h}_stretchToPowerOfTwo(e,r,i,s){const n=new ct(e,i),o=new Ns(e,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},n),a=new ct(e,{target:wt.TEXTURE_2D,pixelFormat:i.pixelFormat,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!!i.flipped,maxAnisotropy:8,preMultiplyAlpha:i.preMultiplyAlpha},r),l=Ia(e),c=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,s,o,l,a,n),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:a,framebuffer:o}:(l.dispose(!0),a.dispose(),o.detachColorTexture(),o.dispose()),e.bindFramebuffer(c),n}_drawStretchedTexture(e,r,i,s,n,o){this._passParameters.texture=n,e.bindFramebuffer(i);const a=e.getViewport();e.setViewport(0,0,o.descriptor.width,o.descriptor.height),e.bindTechnique(r,this._passParameters,null),e.bindVAO(s),e.drawArrays($t.TRIANGLE_STRIP,0,Ko(s,"geometry")),e.bindFramebuffer(null),e.setViewport(a.x,a.y,a.width,a.height),this._passParameters.texture=null}unload(){if(v(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:r,sourceTexture:i}=this._powerOfTwoStretchInfo;r.dispose(!0),i.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(v(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),v(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};var kO;(function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(kO||(kO={}));const q3=128,NJ=.5;function XTe(t,e=q3,r=e*NJ,i=0){const s=Fst(t,e,r,i);return new fx(s,{mipmap:!1,wrap:{s:Ot.CLAMP_TO_EDGE,t:Ot.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0})}function Fst(t,e=q3,r=e*NJ,i=0){switch(t){case"circle":default:return Ust(e,r);case"square":return Vst(e,r);case"cross":return zst(e,r,i);case"x":return Bst(e,r,i);case"kite":return kst(e,r);case"triangle":return Gst(e,r);case"arrow":return jst(e,r)}}function Ust(t,e){const r=t/2-.5;return oP(t,JTe(r,r,e/2))}function Vst(t,e){return YTe(t,e,!1)}function kst(t,e){return YTe(t,e,!0)}function zst(t,e,r=0){return ZTe(t,e,!1,r)}function Bst(t,e,r=0){return ZTe(t,e,!0,r)}function Gst(t,e){return oP(t,KTe(t/2,e,e/2))}function jst(t,e){const r=e,i=e/2,s=t/2,n=.8*r,o=JTe(s,(t-e)/2-n,Math.sqrt(n*n+i*i)),a=KTe(s,r,i);return oP(t,(l,c)=>Math.max(a(l,c),-o(l,c)))}function YTe(t,e,r){return r&&(e/=Math.SQRT2),oP(t,(i,s)=>{let n=i-.5*t+.25,o=.5*t-s-.75;if(r){const a=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=a}return Math.max(Math.abs(n),Math.abs(o))-.5*e})}function ZTe(t,e,r,i=0){e-=i,r&&(e*=Math.SQRT2);const s=.5*e;return oP(t,(n,o)=>{let a,l=n-.5*t,c=.5*t-o-1;if(r){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),a=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,a-=i/2,a})}function JTe(t,e,r){return(i,s)=>{const n=i-t,o=s-e;return Math.sqrt(n*n+o*o)-r}}function KTe(t,e,r){const i=Math.sqrt(e*e+r*r);return(s,n)=>{const o=Math.abs(s-t)-r,a=n-t+e/2+.75,l=(e*o+r*a)/i,c=-a;return Math.max(l,c)}}function oP(t,e){const r=new Uint8Array(4*t*t);for(let i=0;i<t;i++)for(let s=0;s<t;s++){const n=s+t*i;let o=e(s,i);o=o/t+.5,H3(o,r,4*n)}return r}let KPt=class extends pi{constructor(e){super(),this.slicePlaneLocalOrigin=e}};function Hst(t,e){QTe(t,e,[new Wt("slicePlaneOrigin",(r,i)=>i2e(e,r,i)),new Wt("slicePlaneBasis1",(r,i)=>{var s;return c4(e,r,i,(s=i.slicePlane)==null?void 0:s.basis1)}),new Wt("slicePlaneBasis2",(r,i)=>{var s;return c4(e,r,i,(s=i.slicePlane)==null?void 0:s.basis2)})])}function Zs(t,e){QTe(t,e,[new Lu("slicePlaneOrigin",(r,i)=>i2e(e,r,i)),new Lu("slicePlaneBasis1",(r,i)=>{var s;return c4(e,r,i,(s=i.slicePlane)==null?void 0:s.basis1)}),new Lu("slicePlaneBasis2",(r,i)=>{var s;return c4(e,r,i,(s=i.slicePlane)==null?void 0:s.basis2)})])}function QTe(t,e,r){if(!e.hasSlicePlane){const o=w`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;return e.hasSliceInVertexProgram&&t.vertex.code.add(o),void t.fragment.code.add(o)}t.extensions.add("GL_OES_standard_derivatives"),e.hasSliceInVertexProgram&&t.vertex.uniforms.add(r),t.fragment.uniforms.add(r);const i=w`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,s=w`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,n=e.hasSliceHighlight?w`
        ${s}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `:w`#define highlightSlice(_color_, _pos_) (_color_)`;e.hasSliceInVertexProgram&&t.vertex.code.add(i),t.fragment.code.add(i),t.fragment.code.add(n)}function e2e(t,e,r){return t.instancedDoublePrecision?ce(qst,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):e.slicePlaneLocalOrigin}function t2e(t,e){return v(t)?ge(u4,e.origin,t):e.origin}function r2e(t,e,r){return t.hasSliceTranslatedView?v(e)?ql(Wst,r.camera.viewMatrix,e):r.camera.viewMatrix:null}function i2e(t,e,r){if(C(r.slicePlane))return wa;const i=e2e(t,e,r),s=t2e(i,r.slicePlane),n=r2e(t,i,r);return v(n)?Xe(u4,s,n):s}function c4(t,e,r,i){if(C(i)||C(r.slicePlane))return wa;const s=e2e(t,e,r),n=t2e(s,r.slicePlane),o=r2e(t,s,r);return v(o)?(me(QC,i,n),Xe(u4,n,o),Xe(QC,QC,o),ge(QC,QC,u4)):i}const qst=M(),u4=M(),QC=M(),Wst=Ie();function A6(t,e){const r=e.output===V.ObjectAndLayerIdColor,i=e.objectAndLayerIdColorInstanced;r&&(t.varyings.add("objectAndLayerIdColorVarying","vec4"),i?t.attributes.add(A.OBJECTANDLAYERIDCOLOR_INSTANCED,"vec4"):t.attributes.add(A.OBJECTANDLAYERIDCOLOR,"vec4")),t.vertex.code.add(w`
     void forwardObjectAndLayerIdColor() {
      ${r?i?w`objectAndLayerIdColorVarying = objectAndLayerIdColor_instanced * 0.003921568627451;`:w`objectAndLayerIdColorVarying = objectAndLayerIdColor * 0.003921568627451;`:w``} }`),t.fragment.code.add(w`
      void outputObjectAndLayerIdColor() {
        ${r?w`gl_FragColor = objectAndLayerIdColorVarying;`:w``} }`)}function Xst(t,e){const{vertex:r,fragment:i}=t;e.hasMultipassGeometry&&r.include(Uwe),e.hasMultipassTerrain&&t.varyings.add("depth","float"),r.code.add(w`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.hasMultipassGeometry?w`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${e.hasMultipassTerrain?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.hasMultipassTerrain&&i.include(ku),e.hasMultipassTerrain&&i.uniforms.add([...fp("terrainDepthTexture",(s,n)=>n.multipassTerrain.linearDepthTexture,e.hasWebGL2Context?ei.None:ei.InvSize),new Ur("nearFar",(s,n)=>n.camera.nearFar)]),i.include(jc),i.code.add(w`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${e.hasMultipassTerrain?w`
          vec2 uv = gl_FragCoord.xy;

          // Read the rgba data from the texture linear depth
          vec4 terrainDepthData = ${tl(e,"terrainDepthTexture","uv")};

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          // If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          // Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}const Yst=qt(1,1,0,1),s2e=qt(1,0,1,1);function Ry(t,e){t.fragment.uniforms.add(fp("depthTex",(r,i)=>i.highlightDepthTexture,e.hasWebGL2Context?ei.None:ei.InvSize)),t.fragment.constants.add("occludedHighlightFlag","vec4",Yst).add("unoccludedHighlightFlag","vec4",s2e),t.fragment.code.add(w`
    void outputHighlight() {
      vec3 fragCoord = gl_FragCoord.xyz;

      float sceneDepth = ${tl(e,"depthTex","fragCoord.xy")}.x;
      if (fragCoord.z > sceneDepth + 5e-7) {
        gl_FragColor = occludedHighlightFlag;
      }
      else {
        gl_FragColor = unoccludedHighlightFlag;
      }
    }
  `)}let R6=class extends ws{constructor(e,r,i){super(e,"vec4",di.Pass,(s,n,o)=>s.setUniform4fv(e,r(n,o)),i)}},ya=class extends ws{constructor(e,r,i){super(e,"float",di.Pass,(s,n,o)=>s.setUniform1fv(e,r(n,o)),i)}},FJ=class extends pC{constructor(){super(...arguments),this.vvSizeEnabled=!1,this.vvSizeMinSize=$e(1,1,1),this.vvSizeMaxSize=$e(100,100,100),this.vvSizeOffset=$e(0,0,0),this.vvSizeFactor=$e(1,1,1),this.vvSizeValue=$e(1,1,1),this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.vvOpacityEnabled=!1,this.vvOpacityValues=[0,0,0,0,0,0,0,0],this.vvOpacityOpacities=[1,1,1,1,1,1,1,1],this.vvSymbolAnchor=[0,0,0],this.vvSymbolRotationMatrix=rs()}};const gp=8;function OS(t,e){e.hasVvInstancing&&(e.vvSize||e.vvColor)&&t.attributes.add(A.INSTANCEFEATUREATTRIBUTE,"vec4");const r=t.vertex;e.vvSize?(r.uniforms.add(new Wt("vvSizeMinSize",i=>i.vvSizeMinSize)),r.uniforms.add(new Wt("vvSizeMaxSize",i=>i.vvSizeMaxSize)),r.uniforms.add(new Wt("vvSizeOffset",i=>i.vvSizeOffset)),r.uniforms.add(new Wt("vvSizeFactor",i=>i.vvSizeFactor)),r.uniforms.add(new Rm("vvSymbolRotationMatrix",i=>i.vvSymbolRotationMatrix)),r.uniforms.add(new Wt("vvSymbolAnchor",i=>i.vvSymbolAnchor)),r.code.add(w`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),r.code.add(w`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${e.hasVvInstancing?w`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):r.code.add(w`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vvColor?(r.constants.add("vvColorNumber","int",gp),e.hasVvInstancing&&r.uniforms.add([new ya("vvColorValues",i=>i.vvColorValues,gp),new R6("vvColorColors",i=>i.vvColorColors,gp)]),r.code.add(w`
      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${e.hasVvInstancing?w`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):r.code.add(w`vec4 vvColor() { return vec4(1.0); }`)}const h4=.1,Qo=.001;function Zst(t){const e=new Lr,r=t.signedDistanceFieldEnabled;if(e.include(aJ),e.include(MTe,t),e.include(Zs,t),t.occlusionPass)return e.include(Xst,t),e;const{vertex:i,fragment:s}=e;e.include(AJ),s.include(jc),s.include(Am),e.include(OS,t),e.include(A6,t),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),t.binaryHighlightOcclusionEnabled&&e.varyings.add("voccluded","float"),i.uniforms.add([new fr("viewport",(c,h)=>h.camera.fullViewport),new Ur("screenOffset",(c,h)=>ar(n2e,2*c.screenOffset[0]*h.camera.pixelRatio,2*c.screenOffset[1]*h.camera.pixelRatio)),new Ur("anchorPosition",c=>d4(c)),new fr("materialColor",c=>c.color),new Pe("pixelRatio",(c,h)=>h.camera.pixelRatio)]),r&&(i.uniforms.add(new fr("outlineColor",c=>c.outlineColor)),s.uniforms.add([new fr("outlineColor",c=>Toe(c)?c.outlineColor:Kf),new Pe("outlineSize",c=>Toe(c)?c.outlineSize:0)])),t.hasScreenSizePerspective&&(Kit(i),E6(i)),(t.debugDrawLabelBorder||t.binaryHighlightOcclusionEnabled)&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.COLOR,"vec4"),e.attributes.add(A.SIZE,"vec2"),e.attributes.add(A.AUXPOS2,"vec4"),i.code.add(w`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${t.hasScreenSizePerspective?w`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:w`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${t.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${t.occlusionTestEnabled||t.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${t.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const n=w`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,o=t.pixelSnappingEnabled?r?w`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:w`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:w`posProj += quadOffset;`;t.vvColor&&i.uniforms.add([new R6("vvColorColors",c=>c.vvColorColors,gp),new ya("vvColorValues",c=>c.vvColorValues,gp)]),i.uniforms.add(new Ur("textureCoordinateScaleFactor",c=>v(c.texture)&&v(c.texture.descriptor.textureCoordinateScaleFactor)?c.texture.descriptor.textureCoordinateScaleFactor:aye)),i.code.add(w`
    ${t.occlusionTestEnabled?"if (visible) {":""}
    ${n}
    ${t.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${t.output===V.ObjectAndLayerIdColor?w`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${w.float(Qo)};
    ${r?`alphaDiscard = alphaDiscard && outlineColor.a < ${w.float(Qo)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${o}
      gl_Position = posProj;
    }

    vtc = uv * textureCoordinateScaleFactor;

    ${t.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${t.occlusionTestEnabled?w`} else { vtc = vec2(0.0);
      ${t.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),s.uniforms.add(new Pt("tex",c=>c.texture));const a=t.debugDrawLabelBorder?w`(isBorder > 0.0 ? 0.0 : ${w.float(h4)})`:w.float(h4),l=w`
    ${t.debugDrawLabelBorder?w`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${r?w`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${w.float(q3)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${a} ||
          fillPixelColor.a + outlinePixelColor.a < ${w.float(Qo)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${a}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:w`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${a}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${t.debugDrawLabelBorder?w`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return t.output===V.Alpha&&s.code.add(w`
      void main() {
        ${l}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),t.output===V.ObjectAndLayerIdColor&&s.code.add(w`
      void main() {
        ${l}
        outputObjectAndLayerIdColor();
      }
      `),t.output===V.Color&&s.code.add(w`
    void main() {
      ${l}
      ${t.transparencyPassType===Tt.FrontFace?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),t.output===V.Highlight&&(e.include(Ry,t),s.code.add(w`
    void main() {
      ${l}
      ${t.binaryHighlightOcclusionEnabled?w`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),e}function Toe(t){return t.outlineColor[3]>0&&t.outlineSize>0}function d4(t,e=n2e){return t.textureIsSignedDistanceField?Jst(t.anchorPosition,t.distanceFieldBoundingBox,e):zn(e,t.anchorPosition),e}function Jst(t,e,r){v(e)?ar(r,t[0]*(e[2]-e[0])+e[0],t[1]*(e[3]-e[1])+e[1]):ar(r,0,0)}const n2e=Ke(),Kst=Object.freeze(Object.defineProperty({__proto__:null,build:Zst,calculateAnchorPosForRendering:d4},Symbol.toStringTag,{value:"Module"})),Du=Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),Qst=Mp(Ee.ONE,Ee.ONE),o2e=Mp(Ee.ZERO,Ee.ONE_MINUS_SRC_ALPHA);function Oy(t){return t===Tt.FrontFace?null:t===Tt.Alpha?o2e:Qst}function O6(t){return t===Tt.FrontFace?Yl:null}const M6=5e5,P6={factor:-1,units:-2};function I6(t){return t?P6:null}function Iv(t,e=$i.LESS){return t===Tt.NONE||t===Tt.FrontFace?e:$i.LEQUAL}let a2e=class l2e extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2,r.spherical=e.viewingMode===Be.Global}initializeProgram(e){return new Nr(e.rctx,l2e.shader.get().build(this.configuration),Ar)}_setPipelineState(e){const r=this.configuration,i=e===Tt.NONE,s=e===Tt.FrontFace,n=this.configuration.hasPolygonOffset?ent:null,o=(i||s)&&r.output!==V.Highlight&&(r.depthEnabled||r.occlusionPass)?Yl:null;return zt({blending:r.output===V.Color||r.output===V.Alpha||r.output===V.Highlight?i?tnt:Oy(e):null,depthTest:{func:$i.LEQUAL},depthWrite:o,colorWrite:Qt,polygonOffset:n})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.occlusionPass?$t.POINTS:$t.TRIANGLES}};a2e.shader=new Dr(Kst,()=>ie(()=>import("./HUDMaterial.glsl-bb0640b3.js"),[],import.meta.url));const ent={factor:0,units:-4},tnt=Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA);let zs=class extends io{constructor(){super(...arguments),this.output=V.Color,this.screenCenterOffsetUnitsEnabled=zl.World,this.transparencyPassType=Tt.NONE,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusionEnabled=!0,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.hasMultipassGeometry=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};u([k({count:V.COUNT})],zs.prototype,"output",void 0),u([k({count:zl.COUNT})],zs.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([k({count:Tt.COUNT})],zs.prototype,"transparencyPassType",void 0),u([k()],zs.prototype,"spherical",void 0),u([k()],zs.prototype,"occlusionTestEnabled",void 0),u([k()],zs.prototype,"signedDistanceFieldEnabled",void 0),u([k()],zs.prototype,"vvSize",void 0),u([k()],zs.prototype,"vvColor",void 0),u([k()],zs.prototype,"hasVerticalOffset",void 0),u([k()],zs.prototype,"hasScreenSizePerspective",void 0),u([k()],zs.prototype,"debugDrawLabelBorder",void 0),u([k()],zs.prototype,"binaryHighlightOcclusionEnabled",void 0),u([k()],zs.prototype,"hasSlicePlane",void 0),u([k()],zs.prototype,"hasPolygonOffset",void 0),u([k()],zs.prototype,"depthEnabled",void 0),u([k()],zs.prototype,"pixelSnappingEnabled",void 0),u([k()],zs.prototype,"isDraped",void 0),u([k()],zs.prototype,"hasMultipassGeometry",void 0),u([k()],zs.prototype,"hasMultipassTerrain",void 0),u([k()],zs.prototype,"cullAboveGround",void 0),u([k()],zs.prototype,"occlusionPass",void 0),u([k()],zs.prototype,"objectAndLayerIdColorInstanced",void 0),u([k({constValue:!0})],zs.prototype,"hasSliceInVertexProgram",void 0),u([k({constValue:!1})],zs.prototype,"hasVvInstancing",void 0);let PE=class extends Pv{constructor(e){super(e,new hnt),this._configuration=new zs}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?zl.Screen:zl.World,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.isDraped=this.parameters.isDraped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.vvSize=!!this.parameters.vvSizeEnabled,this._configuration.vvColor=!!this.parameters.vvColorEnabled,this._configuration.occlusionPass=r.slot===Se.OCCLUSION_PIXELS&&this.parameters.occlusionTest&&(e===V.Color||e===V.Alpha),e===V.Color&&(this._configuration.debugDrawLabelBorder=!!Wr.LABELS_SHOW_BORDER),e===V.Highlight&&(this._configuration.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!i.options.hud||!e.visible)return;const a=this.parameters;let l=1,c=1;if(Jh(D9,r),v(e.shaderTransformer)){const T=e.shaderTransformer(Coe);l=T[0],c=T[5],snt(D9)}const h=e.vertexAttributes.get(A.POSITION),p=e.vertexAttributes.get(A.SIZE),f=e.vertexAttributes.get(A.NORMAL),m=e.vertexAttributes.get(A.AUXPOS1);gt(h.size>=3);const y=i.point,_=i.camera,b=d4(a);l*=_.pixelRatio,c*=_.pixelRatio;const x=this.parameters.centerOffsetUnits==="screen";for(let T=0;T<h.data.length/h.size;T++){const S=T*h.size;ce(aa,h.data[S],h.data[S+1],h.data[S+2]),Xe(aa,aa,r);const E=T*p.size;e0[0]=p.data[E]*l,e0[1]=p.data[E+1]*c,Xe(aa,aa,_.viewMatrix);const O=T*m.size;if(ce(Zc,m.data[O+0],m.data[O+1],m.data[O+2]),!x&&(aa[0]+=Zc[0],aa[1]+=Zc[1],Zc[2]!==0)){const L=Zc[2];ve(Zc,aa),ge(aa,aa,ae(Zc,Zc,L))}const R=T*f.size;if(ce(eA,f.data[R],f.data[R+1],f.data[R+2]),this._normalAndViewAngle(eA,D9,_,N9),this._applyVerticalOffsetTransformationView(aa,N9,_,L9),_.applyProjection(aa,Ua),Ua[0]>-1){Ua[0]=Math.floor(Ua[0]),Ua[1]=Math.floor(Ua[1]),x&&(Zc[0]||Zc[1])&&(Ua[0]+=Zc[0],Zc[1]!==0&&(Ua[1]+=CJ(Zc[1],L9.factorAlignment)),_.unapplyProjection(Ua,aa)),Ua[0]+=this.parameters.screenOffset[0],Ua[1]+=this.parameters.screenOffset[1],wTe(e0,L9.factor,e0);const L=lnt*_.pixelRatio;let I=0;if(a.textureIsSignedDistanceField&&(I=a.outlineSize*_.pixelRatio/2),y&&Soe(y,Ua[0],Ua[1],e0,L,I,a,b)){const U=i.ray;if(Xe(Eoe,aa,Lo(ant,_.viewMatrix)),Ua[0]=y[0],Ua[1]=y[1],_.unprojectFromRenderScreen(Ua,aa)){const z=M();le(z,U.direction);const B=1/Me(z);ae(z,z,B),o(Si(U.origin,aa)*B,z,-1,!0,1,Eoe)}}}}}intersectDraped(e,r,i,s,n,o){const a=e.vertexAttributes.get(A.POSITION),l=e.vertexAttributes.get(A.SIZE),c=this.parameters,h=d4(c);let p=1,f=1;if(v(e.shaderTransformer)){const y=e.shaderTransformer(Coe);p=y[0],f=y[5]}p*=e.screenToWorldRatio,f*=e.screenToWorldRatio;const m=cnt*e.screenToWorldRatio;for(let y=0;y<a.data.length/a.size;y++){const _=y*a.size,b=a.data[_],x=a.data[_+1],T=y*l.size;e0[0]=l.data[T]*p,e0[1]=l.data[T+1]*f;let S=0;c.textureIsSignedDistanceField&&(S=c.outlineSize*e.screenToWorldRatio/2),Soe(s,b,x,e0,m,S,c,h)&&n(o.dist,o.normal,-1,!1)}}createBufferWriter(){return new pnt(this)}_normalAndViewAngle(e,r,i,s){return Jit(r)&&(r=Jh(ont,r)),Oc(s.normal,e,r),Xe(s.normal,s.normal,i.viewInverseTransposeMatrix),s.cosAngle=_e(c2e,unt),s}_updateScaleInfo(e,r,i){const s=this.parameters;v(s.screenSizePerspective)?goe(i,r,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),v(s.screenSizePerspectiveAlignment)?goe(i,r,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,r,i,s,n,o,a){const l=this._normalAndViewAngle(r,i,n,N9);return this._applyVerticalGroundOffsetView(e,l,n,a),this._applyVerticalOffsetTransformationView(a,l,n,o),this._applyPolygonOffsetView(a,l,s[3],n,a),this._applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(e,r,i,s,n){return this._applyCenterOffsetNDC(e,r,i,s),v(n)&&le(n,s),this._applyPolygonOffsetNDC(s,r,i,s),s}_applyPolygonOffsetView(e,r,i,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(i);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return le(n,e);const c=ye(Math.abs(r.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return ae(n,e,l>0?h:1/h),n}_applyVerticalGroundOffsetView(e,r,i,s){const n=Me(e),o=i.aboveGround?1:-1,a=.5*i.computeRenderPixelSizeAtDist(n),l=ae(aa,r.normal,o*a);return me(s,e,l),s}_applyVerticalOffsetTransformationView(e,r,i,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Me(e);this._updateScaleInfo(s,c,r.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const o=Me(e),a=It(n.screenSizePerspectiveAlignment,n.screenSizePerspective),l=DTe(i,o,n.verticalOffset,r.cosAngle,a);return this._updateScaleInfo(s,o,r.cosAngle),ae(r.normal,r.normal,l),me(e,e,r.normal)}_applyCenterOffsetView(e,r,i){const s=this.parameters.centerOffsetUnits!=="screen";return i!==e&&le(i,e),s&&(i[0]+=r[0],i[1]+=r[1],r[2]&&(ve(eA,i),me(i,i,ae(eA,eA,r[2])))),i}_applyCenterOffsetNDC(e,r,i,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==e&&le(s,e),n||(s[0]+=r[0]/i.fullWidth*2,s[1]+=r[1]/i.fullHeight*2),s}_applyPolygonOffsetNDC(e,r,i,s){const n=this.parameters.shaderPolygonOffset;if(e!==s&&le(s,e),n){const o=i.aboveGround?1:-1,a=o*Math.sign(r[3]);s[2]-=(a||o)*n}return s}requiresSlot(e,r){if(r===V.Color||r===V.Alpha||r===V.Highlight||r===V.ObjectAndLayerIdColor){if(e===Se.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:i,occlusionTest:s}=this.parameters;return e===(i?Se.LABEL_MATERIAL:Se.HUD_MATERIAL)||s&&e===Se.OCCLUSION_PIXELS}return!1}createGLMaterial(e){return new rnt(e)}calculateRelativeScreenBounds(e,r,i=hr()){return int(this.parameters,e,r,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}},rnt=class extends BZ{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(a2e,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}};function int(t,e,r,i=nnt){return zn(i,t.anchorPosition),i[0]*=-e[0],i[1]*=-e[1],i[0]+=t.screenOffset[0]*r,i[1]+=t.screenOffset[1]*r,i}function snt(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=1/Math.sqrt(e*e+r*r+i*i),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return t[0]=e*h,t[1]=r*h,t[2]=i*h,t[3]=s*p,t[4]=n*p,t[5]=o*p,t[6]=a*f,t[7]=l*f,t[8]=c*f,t}function Soe(t,e,r,i,s,n,o,a){let l=e-s-(a[0]>0?i[0]*a[0]:0),c=l+i[0]+2*s,h=r-s-(a[1]>0?i[1]*a[1]:0),p=h+i[1]+2*s;const f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&v(f)&&(l+=i[0]*f[0],h+=i[1]*f[1],c-=i[0]*(1-f[2]),p-=i[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n),t[0]>l&&t[0]<c&&t[1]>h&&t[1]<p}const L9=new VTe,nnt=Ke(),aa=M(),eA=M(),Ua=nr(),c2e=M(),Eoe=M(),D9=rs(),ont=rs(),ant=Ie(),Zc=M(),N9={normal:c2e,cosAngle:0},Coe=Ie(),lnt=1,cnt=2,e0=[0,0],unt=$e(0,0,1);let hnt=class extends Rwe{constructor(){super(...arguments),this.renderOccluded=as.Occlude,this.color=qt(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=Fr(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.outlineColor=qt(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.binaryHighlightOcclusion=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.isDraped=!1}};const u2e=is().vec3f(A.POSITION).vec3f(A.NORMAL).vec2f(A.UV0).vec4u8(A.COLOR).vec2f(A.SIZE).vec4f(A.AUXPOS1).vec4f(A.AUXPOS2),dnt=u2e.clone().vec4u8(A.OBJECTANDLAYERIDCOLOR);let pnt=class{constructor(e){this._material=e,this.vertexBufferLayout=de("enable-feature:objectAndLayerId-rendering")?dnt:u2e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(A.POSITION).length}write(e,r,i,s,n){C6(i.indices.get(A.POSITION),i.vertexAttributes.get(A.POSITION).data,e,s.position,n,6),PJ(i.indices.get(A.NORMAL),i.vertexAttributes.get(A.NORMAL).data,r,s.normal,n,6);const o=i.vertexAttributes.get(A.UV0).data;let a,l,c,h;if(o==null||o.length<4){const x=this._material.parameters;a=0,l=0,c=x.texCoordScale[0],h=x.texCoordScale[1]}else a=o[0],l=o[1],c=o[2],h=o[3];c=Math.min(1.99999,c+1),h=Math.min(1.99999,h+1);let p=i.indices.get(A.POSITION).length,f=n;const m=s.uv0;for(let x=0;x<p;++x)m.set(f,0,a),m.set(f,1,l),f+=1,m.set(f,0,c),m.set(f,1,l),f+=1,m.set(f,0,c),m.set(f,1,h),f+=1,m.set(f,0,c),m.set(f,1,h),f+=1,m.set(f,0,a),m.set(f,1,h),f+=1,m.set(f,0,a),m.set(f,1,l),f+=1;IJ(i.indices.get(A.COLOR),i.vertexAttributes.get(A.COLOR).data,4,s.color,n,6);const y=i.indices.get(A.SIZE),_=i.vertexAttributes.get(A.SIZE).data;p=y.length;const b=s.size;f=n;for(let x=0;x<p;++x){const T=_[2*y[x]],S=_[2*y[x]+1];for(let E=0;E<6;++E)b.set(f,0,T),b.set(f,1,S),f+=1}if(i.indices.get(A.AUXPOS1)&&i.vertexAttributes.get(A.AUXPOS1)?ME(i.indices.get(A.AUXPOS1),i.vertexAttributes.get(A.AUXPOS1).data,s.auxpos1,n,6):xoe(s.auxpos1,n,6*p),i.indices.get(A.AUXPOS2)&&i.vertexAttributes.get(A.AUXPOS2)?ME(i.indices.get(A.AUXPOS2),i.vertexAttributes.get(A.AUXPOS2).data,s.auxpos2,n,6):xoe(s.auxpos2,n,6*p),v(i.objectAndLayerIdColor)&&i.indices.get(A.POSITION)){const x=i.indices.get(A.POSITION).length,T=s.getField(A.OBJECTANDLAYERIDCOLOR,Aa);zTe(i.objectAndLayerIdColor,T,x,n,6)}}};const kp=M(),zx=nr(),tA=nr(),F9=M(),fnt=Ie(),mnt=cn(),U9=no(),gnt=M(),ynt=hr();class _nt{constructor(){this.aabr=hr(),this.distance=0,this.culled=!1,this.visible=!1}}class vnt{constructor(e,r){this.graphics3DGraphic=e,this.slicePlaneEnabled=r,this.info={}}}var mc;(function(t){t[t.Idle=0]="Idle",t[t.Process=1]="Process",t[t.Sort=2]="Sort",t[t.Deconflict=3]="Deconflict",t[t.NumStates=4]="NumStates"})(mc||(mc={}));class h2e{constructor(){this.camera=new At,this.slicePlane=_y(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),lx(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let J2=class extends Te{get dirty(){return this._dirty}get state(){return this._state}constructor(t){super(t),this._dirty=!1,this._runningViewState=new h2e,this._state=mc.Idle,this._active=new Map,this._visible=new Map,this._iterators=new Tnt,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==mc.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const t=this._state/mc.NumStates;return this._dirty?.5*t:t}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(t){switch(this._state){case mc.Idle:this._startUpdate(),t.madeProgress();case mc.Process:if(this._state=mc.Process,!this._processActiveGraphics(t))return;case mc.Sort:if(this._state=mc.Sort,!this._sortVisibleGraphics(t))return;case mc.Deconflict:if(this._state=mc.Deconflict,!this._deconflictVisibleGraphics(t))return;default:kit(this,this._visible),this._state=mc.Idle,this.notifyChange("updating")}}modifyGraphics(t,e){e?t.forEach(r=>this.addToActiveGraphics(r)):t.forEach(r=>this.removeFromActiveGraphics(r)),this.setDirty()}layerSupportsDeconfliction(t){if(C(t)||t.type!=="object3d")return!1;const e=t.stageObject;if((e?e.geometries.length:0)!==1)return!1;const r=e==null?void 0:e.geometries[0];return(r==null?void 0:r.material)instanceof PE}_startUpdate(){zit(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:e}=this._runningViewState.camera;this._initBins(t,e),this._resetIterators()}addToActiveGraphics(t){t.info[this.visibilityGroup]=new _nt,this._active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){this._visible.delete(t.graphics3DGraphic.graphic.uid),bnt(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this._active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(t){const e=this._ensureActiveGraphicsIterator(),r=BE(fnt,this._runningViewState.camera.projectionMatrix),i=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?mnt:null;let s=0;for(v(i)&&(Xe(i,wa,this._runningViewState.camera.viewMatrix),i[3]=Yr(this.view.spatialReference).radius,s=mye(i,wa));!t.done;){t.madeProgress();const n=e.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this._collectGraphics3DGraphics(o,r,i,s),a.culled?this._visible.delete(o.graphics3DGraphic.graphic.uid):this._visible.set(o.graphics3DGraphic.graphic.uid,o))}return!1}_sortVisibleGraphics(t){const e=this._ensureSortGraphicsIterator();for(;!t.done;){const r=e.next();if(t.madeProgress(),r.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(t){const e=this._ensureVisibleGraphicsIterator(),r=this.visibilityGroup===Oo.LABEL;for(;!t.done;){t.madeProgress();const i=e.next();if(i.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=i.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=(!r||o.isVisible())&&!this._isConflicted(s);a&&this._addToBins(s),n.visible=a,this._setGraphicVisibility(s,a),Git(n,a)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=Aoe(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=Aoe(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=wnt(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(t,e,r,i){const s=t.graphics3DGraphic;if(s.destroyed)return;const n=t.info[this.visibilityGroup];if(!s.isVisible(Oo.GRAPHIC,Ac.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(s);Xh(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometries[0].material;if(C(a)){if(a=Cnt,this._getProjectionInfo(l,e,a),a.isOutsideScreen||this._isCulledBySlice(t,kp)||v(r)&&this._isCulledByHorizon(a,r,i))return void(n.culled=!0);!Wr.TESTS_DISABLE_OPTIMIZATIONS&&n.visible&&(a.distance*=.7)}this._expandBoundingRect(n,l,c,a)}C(a)?n.culled=!0:(n.distance=a.distance,n.culled=!1)}_getProjectionInfo(t,e,r){const i=this._runningViewState.camera,s=t.stageObject,n=s.geometries[0],o=n.material,a=s.boundingVolumeWorldSpace.bounds;Xe(kp,a,i.viewMatrix);const l=n.vertexAttributes,c=l.get(A.NORMAL).data,h=l.get(A.AUXPOS1).data;o.applyShaderOffsetsView(kp,c,s.transformation,h,i,r.scaleInfo,kp),ti(zx,kp[0],kp[1],kp[2],1),Ru(tA,zx,i.projectionMatrix),ae(r.positionNDC,tA,1/tA[3]),o.applyShaderOffsetsNDC(r.positionNDC,h,i,r.positionNDC,F9),r.distanceWithoutPolygonOffset=i.depthNDCToWorld(F9[2]),r.distance=F9[2]===r.positionNDC[2]?r.distanceWithoutPolygonOffset:i.depthNDCToWorld(r.positionNDC[2]),ti(tA,r.positionNDC[0],r.positionNDC[1],r.positionNDC[2],1),Ru(zx,tA,e),kE(zx,zx,1/zx[3]),ce(r.positionView,kp[0],kp[1],kp[2])}_isCulledByHorizon(t,e,r){return le(U9.direction,t.positionView),ce(U9.origin,0,0,0),!!Rv(e,U9,gnt)&&t.distanceWithoutPolygonOffset>r}_isCulledBySlice(t,e){return t.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&dY(this._runningViewState.slicePlane,e)}_expandBoundingRect(t,e,r,{positionNDC:i,scaleInfo:s}){const n=this._runningViewState.camera,o=e.getScreenSize(Snt);wTe(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=rF(r.calculateRelativeScreenBounds(o,s.factorAlignment.scale,ynt),Ft(0,n.fullWidth,.5+.5*i[0]),Ft(0,n.fullHeight,.5+.5*i[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(Cu(a),wp(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}z_(t.aabr,a,t.aabr)}_isConflicted(t){const e=t.graphics3DGraphic.graphic.uid,r=t.info[this.visibilityGroup];for(let i=Math.floor(r.aabr[0]/this._accBinsSizeX);i<=Math.floor(r.aabr[2]/this._accBinsSizeX);i++)if(!(i<0||i>=this._accBinsNumX))for(let s=Math.floor(r.aabr[1]/this._accBinsSizeY);s<=Math.floor(r.aabr[3]/this._accBinsSizeY);s++){if(s<0||s>=this._accBinsNumY)continue;const n=this._accBins[i][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,l5(l.aabr,r.aabr)))return!0}}return!1}_initBins(t,e){if(this._accBins==null){this._accBins=[];for(let r=0;r<this._accBinsNumX;r++){this._accBins.push([]);const i=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)i.push(new Kt)}}else for(let r=0;r<this._accBinsNumX;r++)for(let i=0;i<this._accBinsNumY;i++)this._accBins[r][i].clear();this._accBinsSizeX=t/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(t){const e=t.info[this.visibilityGroup],r=Math.floor(e.aabr[0]/this._accBinsSizeX),i=Math.floor(e.aabr[2]/this._accBinsSizeX),s=Math.floor(e.aabr[1]/this._accBinsSizeY),n=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let o=r;o<=i;o++)if(!(o<0||o>=this._accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this._accBinsNumY||this._accBins[o][a].push(t)}_setGraphicVisibility(t,e){const r=t.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(Ac.DECONFLICTION,e,this.visibilityGroup),this.visibilityGroup===Oo.LABEL&&this.view.labeler.setLabelGraphicVisibility(r,e))}};function bnt(t,e){const r=t.graphics3DGraphic;r.destroyed||r.clearVisibilityFlag(Ac.DECONFLICTION,e)}function*Aoe(t){if(Map.prototype.entries){const e=t.entries();for(let r=e.next();!r.done;r=e.next())yield r.value[1]}else yield*t.values()}function*wnt(t,e,r){e.clear(),t.forEach((s,n)=>{const o=e.pushNew();o.id=n,o.visible=s.graphics3DGraphic.hasVisibilityFlag(Ac.DECONFLICTION,r),o.prio=s.info?s.info[r].distance:Number.MAX_VALUE}),yield;const i=e.iterableSort((s,n)=>s.visible!==n.visible?s.visible?-1:1:s.prio!==n.prio?s.prio-n.prio:s.id-n.id);for(let s=i.next();!s.done;s=i.next())yield;e.forAll(s=>{const n=t.get(s.id);n&&(t.delete(s.id),t.set(s.id,n))}),e.clear()}u([d({constructOnly:!0})],J2.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],J2.prototype,"updating",null),J2=u([P("esri.views.3d.layers.graphics.Deconflictor")],J2);class xnt{}class Tnt{constructor(e=null,r=null,i=null){this.active=e,this.visible=r,this.sort=i,this.sortArray=new Kt({allocator:s=>s||new xnt})}}const Snt=Ke();class Ent{constructor(){this.positionView=M(),this.positionNDC=M(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new VTe}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const Cnt=new Ent,Ant=2e3;let QD=class extends J2{constructor(e){super(e),this.visibilityGroup=Oo.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return ea.YIELD;const r=performance.now();if(e.state!==Tr.IDLE&&r-this._lastDeconfliction<Ant)return ea.YIELD;super.runTask(e),this.state===mc.Idle&&(this._lastDeconfliction=r)}enabledChanged(e,r){this.modifyGraphics(r,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};u([d({constructOnly:!0})],QD.prototype,"parent",void 0),QD=u([P("esri.views.3d.layers.graphics.LabelDeconflictor")],QD);let GH=class extends J2{constructor(){super(...arguments),this._handles=new Zr,this._contexts=new Map,this._viewState=new h2e,this.visibilityGroup=Oo.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([ne(()=>{var e,r;return(r=(e=this.view)==null?void 0:e.state)==null?void 0:r.camera},()=>{this._updateViewState(),this.setDirty()}),ne(()=>{var e,r,i;return(i=(r=(e=this.view)==null?void 0:e.map)==null?void 0:r.ground)==null?void 0:i.opacity},(e,r)=>{e!==1&&r!==1||this.setDirty()}),ne(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},kt)]),this._frameTask=this.view.resourceController.scheduler.registerTask(yt.GRAPHICS_DECONFLICTOR,this),this._labels=new QD({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,r){const i=!(this._graphicSupportsDeconfliction(r)&&V9(e));r.setVisibilityFlag(Ac.DECONFLICTION,i,Oo.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;v(e)&&Vye(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=v(e)}_slicePlaneChanged(){Yo(this._contexts,(e,r)=>r.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){const r=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,r,i),removeGraphic:i=>this._removeGraphic(r,i),labelingInfoChange:()=>this._labels.enabledChanged(e,r),featureReductionChange:()=>this.enabledChanged(e,r),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,r),clear:()=>r.forEach(i=>this._removeGraphic(r,i.graphics3DGraphic))}}removeGraphicsOwner(e){const r=this._contexts.get(e);r&&(r.forEach(i=>this._removeGraphic(r,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,r,i){const s=i.graphic.uid,n=new vnt(i,e.symbolCreationContext.slicePlaneEnabled);r.set(s,n),V9(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n)}_removeGraphic(e,r){const i=r.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty())}enabledChanged(e,r){const i=V9(e);i||Rnt(e),this.modifyGraphics(r,i)}_slicePlaneEnabledChanged(e,r){const i=e.symbolCreationContext.slicePlaneEnabled;r.forEach(s=>s.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const r=e.layers;if(!r||!r.length)return!1;for(const i of r)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const r=this._contexts.get(e);if(r)return r;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function V9(t){const e=t.layer;return!(!e||!e.featureReduction||e.featureReduction.type!=="selection")}function Rnt(t){const e=t.graphics3DGraphics;e&&e.forEach(r=>r.clearVisibilityFlag(Ac.DECONFLICTION))}GH=u([P("esri.views.3d.layers.graphics.GraphicsDeconflictor")],GH);const UJ=(t,e,r)=>[e,r],IE=(t,e,r)=>[e,r,t[2]],VJ=(t,e,r)=>[e,r,t[2],t[3]];function uIt(t){return t?{originPosition:t.originPosition==="upper-left"?"upperLeft":t.originPosition==="lower-left"?"lowerLeft":t.originPosition,scale:t.tolerance?[t.tolerance,t.tolerance]:[1,1],translate:v(t.extent)?[t.extent.xmin,t.extent.ymax]:[0,0]}:null}function Ont({scale:t,translate:e},r){return Math.round((r-e[0])/t[0])}function Mnt({scale:t,translate:e},r){return Math.round((e[1]-r)/t[1])}function d2e({scale:t,translate:e},r){return r*t[0]+e[0]}function p2e({scale:t,translate:e},r){return e[1]-r*t[1]}function f2e(t,e,r){const i=new Array(r.length);if(!r.length)return i;const[s,n]=t.scale;let o=d2e(t,r[0][0]),a=p2e(t,r[0][1]);i[0]=e(r[0],o,a);for(let l=1;l<r.length;l++){const c=r[l];o+=c[0]*s,a-=c[1]*n,i[l]=e(c,o,a)}return i}function m2e(t,e,r){const i=new Array(r.length);for(let s=0;s<r.length;s++)i[s]=f2e(t,e,r[s]);return i}function Pnt(t,e,r,i){return f2e(t,r?i?VJ:IE:i?IE:UJ,e)}function Int(t,e,r,i){return m2e(t,r?i?VJ:IE:i?IE:UJ,e)}function $nt(t,e,r,i){return m2e(t,r?i?VJ:IE:i?IE:UJ,e)}function hIt(t,e,r,i,s){return e.x=Ont(t,r.x),e.y=Mnt(t,r.y),e!==r&&(i&&(e.z=r.z),s&&(e.m=r.m)),e}function g2e(t,e,r,i,s){return v(r)&&(e.points=Pnt(t,r.points,i,s)),e}function y2e(t,e,r,i,s){return C(r)||(e.x=d2e(t,r.x),e.y=p2e(t,r.y),e!==r&&(i&&(e.z=r.z),s&&(e.m=r.m))),e}function _2e(t,e,r,i,s){return v(r)&&(e.rings=$nt(t,r.rings,i,s)),e}function v2e(t,e,r,i,s){return v(r)&&(e.paths=Int(t,r.paths,i,s)),e}let dIt=class{constructor(e,r,i){this.uid=e,this.geometry=r,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}};function fIt(t){return v(t.geometry)}let mIt=class{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}};function yIt(t){var n;const e=yfe.fromJSON(t.geometryType),r=We.fromJSON(t.spatialReference),i=t.transform,s=t.features.map(o=>{const a=Lnt(o,e,r,t.objectIdFieldName),l=a.geometry;if(v(l)&&i)switch(l.type){case"point":a.geometry=y2e(i,l,l,l.hasZ,l.hasM);break;case"multipoint":a.geometry=g2e(i,l,l,!!l.hasZ,!!l.hasM);break;case"polygon":a.geometry=_2e(i,l,l,!!l.hasZ,!!l.hasM);break;case"polyline":a.geometry=v2e(i,l,l,!!l.hasZ,!!l.hasM);break;case"extent":case"mesh":a.geometry=l}return a});return{geometryType:e,features:s,spatialReference:r,fields:((n=t.fields)==null?void 0:n.map(o=>W5.fromJSON(o)))??[],objectIdFieldName:t.objectIdFieldName,globalIdFieldName:t.globalIdFieldName,geohashFieldName:t.geohashFieldName,geometryProperties:t.geometryProperties,hasZ:t.hasZ,hasM:t.hasM,exceededTransferLimit:t.exceededTransferLimit,transform:null}}function Lnt(t,e,r,i){return{uid:$c(),objectId:i&&t.attributes?t.attributes[i]:null,attributes:t.attributes,geometry:Dnt(t.geometry,e,r),visible:!0}}function Dnt(t,e,r){if(C(t))return null;switch(e){case"point":{const i=t;return{x:i.x,y:i.y,z:i.z,m:i.m,hasZ:i.z!=null,hasM:i.m!=null,type:"point",spatialReference:r}}case"polyline":{const i=t;return{paths:i.paths,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polyline",spatialReference:r}}case"polygon":{const i=t;return{rings:i.rings,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polygon",spatialReference:r}}case"multipoint":{const i=t;return{points:i.points,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"multipoint",spatialReference:r}}}}function My(t,e,r,i){return{x:t,y:e,z:r,hasZ:r!=null,hasM:!1,spatialReference:i,type:"point"}}function Nnt(t){if(C(t))return 0;let e=32;switch(t.type){case"point":e+=42;break;case"polyline":case"polygon":{let r=0;const i=2+(t.hasZ?1:0)+(t.hasM?1:0),s=t.type==="polyline"?t.paths:t.rings;for(const n of s)r+=n.length;e+=8*r*i+64,e+=128*r,e+=34,e+=32*(s.length+1);break}case"multipoint":{const r=2+(t.hasZ?1:0)+(t.hasM?1:0),i=t.points.length;e+=8*i*r+64,e+=128*i,e+=34,e+=32;break}case"extent":e+=98,t.hasM&&(e+=32),t.hasZ&&(e+=32);break;case"mesh":e+=bP(t.vertexAttributes.position),e+=bP(t.vertexAttributes.normal),e+=bP(t.vertexAttributes.uv),e+=bP(t.vertexAttributes.tangent)}return e}function _It(t){let e=32;return e+=Yge(t.attributes),e+=3,e+=8+Nnt(t.geometry),e}function Fnt(t){if(C(t))return 0;switch(t.type){case"point":return 1;case"polyline":{let e=0;for(const r of t.paths)e+=r.length;return e}case"polygon":{let e=0;for(const r of t.rings)e+=r.length;return e}case"multipoint":return t.points.length;case"extent":return 2;case"mesh":{const e=t.vertexAttributes&&t.vertexAttributes.position;return e?e.length/3:0}default:return}}function vIt(t){if(C(t))return!1;switch(t.type){case"extent":case"point":return!0;case"polyline":for(const e of t.paths)if(e.length>0)return!0;return!1;case"polygon":for(const e of t.rings)if(e.length>0)return!0;return!1;case"multipoint":return t.points.length>0;case"mesh":return!t.loaded||t.vertexAttributes.position.length>0}}function bIt(t,e){switch(Mi(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[3]=t.x,e[1]=e[4]=t.y,t.hasZ&&(e[2]=e[5]=t.z);break;case"polyline":for(let r=0;r<t.paths.length;r++)DU(e,t.paths[r],!!t.hasZ);break;case"polygon":for(let r=0;r<t.rings.length;r++)DU(e,t.rings[r],!!t.hasZ);break;case"multipoint":DU(e,t.points,!!t.hasZ);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[3]=t.xmax,e[4]=t.ymax,t.zmin!=null&&(e[2]=t.zmin),t.zmax!=null&&(e[5]=t.zmax)}}function Unt(t,e){switch(Xh(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[2]=t.x,e[1]=e[3]=t.y;break;case"polyline":for(let r=0;r<t.paths.length;r++)CU(e,t.paths[r]);break;case"polygon":for(let r=0;r<t.rings.length;r++)CU(e,t.rings[r]);break;case"multipoint":CU(e,t.points);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax}}function wIt(t,e){return t.objectId!=null?t.objectId:t.attributes&&e?t.attributes[e]:null}function b2e(t){return"declaredClass"in t}function Roe(t){return"declaredClass"in t}function Vnt(t){return"declaredClass"in t}function knt(t,e){return t?Vnt(t)?t:new Sa({layer:e,sourceLayer:e,visible:t.visible,symbol:te(t.symbol),attributes:te(t.attributes),geometry:w2e(t.geometry)}):null}function w2e(t){return C(t)?null:b2e(t)?t:um(znt(t))}function znt(t){const{wkid:e,wkt:r,latestWkid:i}=t.spatialReference,s={wkid:e,wkt:r,latestWkid:i};switch(t.type){case"point":{const{x:n,y:o,z:a,m:l}=t;return{x:n,y:o,z:a,m:l,spatialReference:s}}case"polygon":{const{rings:n,hasZ:o,hasM:a}=t;return{rings:Ooe(n),hasZ:o,hasM:a,spatialReference:s}}case"polyline":{const{paths:n,hasZ:o,hasM:a}=t;return{paths:Ooe(n),hasZ:o,hasM:a,spatialReference:s}}case"extent":{const{xmin:n,xmax:o,ymin:a,ymax:l,zmin:c,zmax:h,mmin:p,mmax:f,hasZ:m,hasM:y}=t;return{xmin:n,xmax:o,ymin:a,ymax:l,zmin:c,zmax:h,mmin:p,mmax:f,hasZ:m,hasM:y,spatialReference:s}}case"multipoint":{const{points:n,hasZ:o,hasM:a}=t;return{points:T2e(n)?x2e(n):n,hasZ:o,hasM:a,spatialReference:s}}default:return}}function Ooe(t){return Bnt(t)?t.map(e=>x2e(e)):t}function x2e(t){return t.map(e=>Array.from(e))}function Bnt(t){for(const e of t)if(e.length!==0)return T2e(e);return!1}function T2e(t){return t.length>0&&(rW(t[0])||iW(t[0]))}function Gnt(t,e){if(!t)return null;let r;if(Roe(t)){if(e==null)return t.clone();if(Roe(e))return e.copy(t)}return e!=null?(r=e,r.x=t.x,r.y=t.y,r.spatialReference=t.spatialReference,t.hasZ?(r.z=t.z,r.hasZ=t.hasZ):(r.z=void 0,r.hasZ=!1),t.hasM?(r.m=t.m,r.hasM=!0):(r.m=void 0,r.hasM=!1)):(r=My(t.x,t.y,t.z,t.spatialReference),t.hasM&&(r.m=t.m,r.hasM=!0)),r}function xIt(t){const{wkid:e,wkt:r,latestWkid:i}=t,s={wkid:e,wkt:r,latestWkid:i};return We.fromJSON(s)}const k9=se.getLogger("esri.layers.support.labelFormatUtils"),z9={type:"simple",evaluate:()=>null},jnt={getAttribute:(t,e)=>t.field(e)};async function S2e(t,e,r){if(!t||!t.symbol||!e)return z9;const i=t.where,s=i6(t),n=i?await ie(()=>import("./WhereClause-544968d0.js").then(a=>a.W),["./WhereClause-544968d0.js","./executionError-fb3f283a.js"],import.meta.url):null;let o;if(s.type==="arcade"){const a=await uFe(s.expression,r,e);if(C(a))return z9;o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):l});if(c!=null)return c.toString()}catch{k9.error(new j("arcade-expression-error","Encountered an error when evaluating label expression for feature",{feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>wZ(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replace(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=e.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":E2e(p,h)})};if(i){let a;try{a=n.WhereClause.create(i,e)}catch(c){return k9.error(new j("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:i,error:c})),z9}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:jnt;try{if(a.testFeature(c,h))return l(c)}catch(p){k9.error(new j("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:i,feature:c,error:p}))}return null}}return o}function E2e(t,e){if(t==null)return"";const r=e.domain;if(r){if(r.type==="codedValue"||r.type==="coded-value"){const s=t;for(const n of r.codedValues)if(n.code===s)return n.name}else if(r.type==="range"){const s=+t,n="range"in r?r.range[0]:r.minValue,o="range"in r?r.range[1]:r.maxValue;if(n<=s&&s<=o)return r.name}}let i=t;return e.type==="date"||e.type==="esriFieldTypeDate"?i=pm(i,d5("short-date")):h5(e)&&(i=fm(+i)),i||""}const TIt=Object.freeze(Object.defineProperty({__proto__:null,createLabelFunction:S2e,formatField:E2e},Symbol.toStringTag,{value:"Module"}));let C2e=class{constructor(e=null,r="center",i="center",s=null,n=[0,0,0],o=0,a=[0,0,0,1],l=[0,0],c="world",h=0,p=0){this.verticalOffset=e,this.horizontalPlacement=r,this.verticalPlacement=i,this.text=s,this.translation=n,this.elevationOffset=o,this.centerOffset=a,this.screenOffset=l,this.centerOffsetUnits=c,this.displayWidth=h,this.displayHeight=p}};function kJ(t,e){if(t.type==="point")return t0(t,e,!1);if(b2e(t))switch(t.type){case"extent":return t0(t.center,e,!1);case"polygon":return t0(t.centroid,e,!1);case"polyline":return t0(Moe(t),e,!0);case"mesh":return t0(t.origin,e,!1)}else switch(t.type){case"extent":return t0(Hnt(t),e,!0);case"polygon":return t0(qnt(t),e,!0);case"polyline":return t0(Moe(t),e,!0)}}function Moe(t){const e=t.paths[0];if(!e||e.length===0)return null;const r=tfe(e,efe(e)/2);return My(r[0],r[1],r[2],t.spatialReference)}function Hnt(t){return My(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),t.zmin!=null&&t.zmax!=null&&isFinite(t.zmin)&&isFinite(t.zmax)?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function qnt(t){const e=t.rings[0];if(!e||e.length===0)return null;const r=rX(t.rings,!!t.hasZ);return My(r[0],r[1],r[2],t.spatialReference)}function t0(t,e,r){const i=r?t:Gnt(t);return e&&t?UDe(t,i,e)?i:null:i}function EIt(t,e,r,i=0){if(t){e||(e=hr());const s=t;let n=.5*s.width*(r-1),o=.5*s.height*(r-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),ti(e,s.xmin-n-i,s.ymin-o-i,s.xmax+n+i,s.ymax+o+i),e}return null}function A2e(t,e){for(let r=0;r<t.geometries.length;++r){const i=t.geometries[r].getMutableAttribute(A.AUXPOS1);i&&i.data[3]!==e&&(i.data[3]=e,t.geometryVertexAttrsUpdated(t.geometries[r]))}}function zO(t,e){const r=FM(Lh);return v(t)&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),v(e)?r[3]=e:v(t)&&t.length>3&&(r[3]=t[3]),r}function CIt(t,e,r,i,s,n=[0,0,0,0]){for(let o=0;o<3;++o)v(t)&&t[o]!=null?n[o]=t[o]:v(r)&&r[o]!=null?n[o]=r[o]:n[o]=s[o];return v(e)?n[3]=e:v(i)?n[3]=i:n[3]=s[3],n}function Poe(t=Gf,e,r,i=1){const s=new Array(3);if(C(e)||C(r))s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=t[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=r[a];l==="symbol-value"||p?c=f!==0?e[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=i;return Ul(s)}function Wnt(t){return t.isPrimitive!=null}function $6(t){return p4(Wnt(t)?[t.width,t.depth,t.height]:t)?null:"Symbol sizes may not be negative values"}function p4(t){if(Array.isArray(t)){for(const e of t)if(!p4(e))return!1;return!0}return t==null||t>=0}function Xnt(t,e,r,i=Ie()){const s=t||0,n=e||0,o=r||0;return s!==0&&KS(i,i,-s/180*Math.PI),n!==0&&JS(i,i,n/180*Math.PI),o!==0&&r5(i,i,o/180*Math.PI),i}function zJ(t,e,r){if(r.minDemResolution!=null)return r.minDemResolution;const i=al(e),s=rx(t)*i,n=ix(t)*i,o=Ev(t)*(e.isGeographic?1:i);return s===0&&n===0&&o===0?r.minDemResolutionForPoints:.01*Math.max(s,n,o)}function R2e(t,e,r,i,s,n,o,a,l,c,h){const p=rot[h.mode];let f,m,y=0;if(vs(t,e,r,i,l.spatialReference,s,a))return p.requiresAlignment(h)?(y=p.applyElevationAlignmentBuffer(i,s,n,o,a,l,c,h),f=n,m=o):(f=i,m=s),vs(f,l.spatialReference,m,n,c.spatialReference,o,a)?y:void 0}function fC(t,e,r,i,s){const n=(yF(t)?t.z:l0e(t)?t.array[t.offset+2]:t[2])||0;switch(r.mode){case"on-the-ground":{const o=It(Hf(e,t,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=It(Hf(e,t,"ground"),0),a=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=It(Hf(e,t,"scene"),0),a=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=r.geometryZWithOffset(n,i),a=It(Hf(e,t,"ground"),0);return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return void(s.z=0)}}function Ynt(t,e,r,i){return fC(t,e,r,i,K2),K2.z}function aP(t,e,r){return e==null||r==null?t.definedChanged:e==="on-the-ground"&&r==="on-the-ground"?t.staysOnTheGround:e===r||e!=="on-the-ground"&&r!=="on-the-ground"?_s.UPDATE:t.onTheGroundChanged}function td(t){return t==="relative-to-ground"||t==="relative-to-scene"}function gv(t){return t!=="absolute-height"}function Znt(t,e,r,i,s){fC(e,r,s,i,K2),A2e(t,K2.verticalDistanceToGround);const n=K2.sampledElevation,o=kn(iot,t.transformation);return s$[0]=e.x,s$[1]=e.y,s$[2]=K2.z,xp(e.spatialReference,s$,o,i.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function Jnt(t,e,r,i,s,n){let o=0;const a=n.spatialReference;e*=3,i*=3;for(let l=0;l<s;++l){const c=t[e+0],h=t[e+1],p=t[e+2],f=It(n.getElevation(c,h,p,a,"ground"),0);o+=f,r[i+0]=c,r[i+1]=h,r[i+2]=f,e+=3,i+=3}return o/s}function Knt(t,e,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,i*=3;for(let f=0;f<s;++f){const m=t[e+0],y=t[e+1],_=t[e+2],b=It(n.getElevation(m,y,_,p,"ground"),0);l+=b,r[i+0]=m,r[i+1]=y,r[i+2]=h==null?_+b+c:b+c,e+=3,i+=3}return l/s}function Qnt(t,e,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,i*=3;for(let f=0;f<s;++f){const m=t[e+0],y=t[e+1],_=t[e+2],b=It(n.getElevation(m,y,_,p,"scene"),0);l+=b,r[i+0]=m,r[i+1]=y,r[i+2]=h==null?_+b+c:b+c,e+=3,i+=3}return l/s}function eot(t){const e=t.meterUnitOffset,r=t.featureExpressionInfoContext;return e!==0||r!=null}function tot(t,e,r,i,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;e*=3,i*=3;for(let h=0;h<s;++h){const p=t[e+0],f=t[e+1],m=t[e+2];r[i+0]=p,r[i+1]=f,r[i+2]=c==null?m+l:l,e+=3,i+=3}return 0}let lP=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};var _s;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(_s||(_s={}));const rot={"absolute-height":{applyElevationAlignmentBuffer:tot,requiresAlignment:eot},"on-the-ground":{applyElevationAlignmentBuffer:Jnt,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Knt,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:Qnt,requiresAlignment:()=>!0}},iot=Ie(),K2=new lP,s$=M();function BJ(t){return v(t.mapPositions)}function O2e(t,e,r,i,s){const n=t.stageObject,o=n.geometries;let a=0;for(const l of o){if(!BJ(l))continue;const{update:c,averageGeometrySampledElevation:h}=P2e(l,e,r,i,s);a+=h,c&&n.geometryVertexAttrsUpdated(l)}return a/o.length}function W3(t,e,r,i,s){var p;const n=t.stageObject,o=e.centerPointInElevationSR;let a=0;(p=n.metadata)!=null&&p.usesVerticalDistanceToGround?(i(o,kl),A2e(n,kl.verticalDistanceToGround),a=kl.sampledElevation):(i(o,kl),e.mode!=="absolute-height"&&(a=kl.sampledElevation));const l=kn(sot,n.transformation),c=ce(M2e,l[12],l[13],l[14]);Wr.TESTS_DISABLE_OPTIMIZATIONS?(Vl[0]=o.x,Vl[1]=o.y,Vl[2]=kl.z,xp(o.spatialReference,Vl,l,s.spatialReference)&&(n.transformation=l)):s.setAltitudeOfTransformation(kl.z,l);const h=GJ/s.unitInMeters;return(Math.abs(l[12]-c[0])>=h||Math.abs(l[13]-c[1])>=h||Math.abs(l[14]-c[2])>=h)&&(n.transformation=l),a}const sot=Ie();function not(t,e,r,i,s){const n=t.graphics3DSymbolLayer.lodRenderer;if(C(n))return 0;const o=e.centerPointInElevationSR;i(o,kl);const a=e.mode!=="absolute-height"?kl.sampledElevation:0,l=n.instanceData,c=t.instanceIndex,h=aot;l.getGlobalTransform(c,h);const p=ce(M2e,h[12],h[13],h[14]);Wr.TESTS_DISABLE_OPTIMIZATIONS?(Vl[0]=o.x,Vl[1]=o.y,Vl[2]=kl.z,xp(o.spatialReference,Vl,h,s.spatialReference)&&l.setGlobalTransform(c,h)):s.setAltitudeOfTransformation(kl.z,h);const f=GJ/s.unitInMeters;return(Wr.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-p[0])>=f||Math.abs(h[13]-p[1])>=f||Math.abs(h[14]-p[2])>=f)&&l.setGlobalTransform(c,h),a}function oot(t,e,r,i,s){const n=t.stageObject,o=n.geometries;if(o.length===0)return 0;let a=0,l=null,c=0,h=!1;for(const p of o){if(!BJ(p))continue;const f=p.vertexAttributes.get(A.POSITION);if(f!==l){const{update:m,averageGeometrySampledElevation:y}=P2e(p,e,r,i,s);c=y,l=f,h=m}h&&n.geometryVertexAttrsUpdated(p),a+=c}return a/o.length}const GJ=.01,Vl=M(),Xu=M(),Bx=M(),aot=Ie(),M2e=M(),kl=new lP;function P2e(t,e,r,i,s){let n=!1;const o=t.shaderTransformation,a=e.requiresSampledElevationInfo;Xu[0]=o[12],Xu[1]=o[13],Xu[2]=o[14],t.invalidateBoundingInfo();const l=t.getMutableAttribute(A.POSITION),c=l.data,h=l.size,p=c.length/h,f=new a0e(t.mapPositions,r);let m=0,y=0;for(let _=0;_<p;_++){if(Bx[0]=c[m],Bx[1]=c[m+1],Bx[2]=c[m+2],i(f,kl),a&&(y+=kl.sampledElevation),Wr.TESTS_DISABLE_OPTIMIZATIONS)c[m]=f.array[f.offset],c[m+1]=f.array[f.offset+1],c[m+2]=kl.z,vs(c,r,m,c,s.spatialReference,m,1),c[m]-=Xu[0],c[m+1]-=Xu[1],c[m+2]-=Xu[2],n=!0;else{Vl[0]=c[m]+Xu[0],Vl[1]=c[m+1]+Xu[1],Vl[2]=c[m+2]+Xu[2],s.setAltitude(Vl,kl.z),c[m]=Vl[0]-Xu[0],c[m+1]=Vl[1]-Xu[1],c[m+2]=Vl[2]-Xu[2];const b=GJ/s.unitInMeters;(Math.abs(Bx[0]-c[m])>=b||Math.abs(Bx[1]-c[m+1])>=b||Math.abs(Bx[2]-c[m+2])>=b)&&(n=!0)}m+=h,f.offset+=3}return y/=p,{update:n,averageGeometrySampledElevation:y}}const lot=se.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function cot(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function RIt(t){const e=t&&t.expression;if(typeof e=="string"){const r=L2e(e);if(r!=null)return{cachedResult:r}}return null}async function OIt(t,e,r,i){const s=t&&t.expression;if(typeof s!="string")return null;const n=L2e(s);if(n!=null)return{cachedResult:n};const o=await dm();ur(r);const a=o.arcadeUtils,l=a.createSyntaxTree(s);return a.dependsOnView(l)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:a.createFunction(l),context:a.createExecContext(null,{sr:e}),modules:o}}}function I2e(t,e,r){return t.arcadeUtils.createFeature(e.attributes,e.geometry,r)}function jJ(t,e){if(t!=null&&!$2e(t)){if(!e||!t.arcade)return void lot.errorOncePerTick("Arcade support required but not provided");const r=e;r._geometry&&(r._geometry=w2e(r._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function uot(t){if(t!=null){if($2e(t))return t.cachedResult;const e=t.arcade;let r=e==null?void 0:e.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof r!="number"&&(t.cachedResult=0,r=0),r}return 0}function MIt(t,e=!1){let r=t&&t.featureExpressionInfo;const i=r&&r.expression;return e||i==="0"||(r=null),r??null}const hot={cachedResult:0};function $2e(t){return t.cachedResult!=null}function L2e(t){return t==="0"?0:null}let Ip=class D2e{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=BFe(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,r){const i=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?i:e+i}calculateOffsetRenderUnits(e){let r=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return i!=null&&(r+=uot(i)*this._metersPerElevationInfoUnit),r/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=zFe(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=It(e.offset,0)}updateFeatureExpressionInfoContext(e,r,i){if(C(e))return void(this._featureExpressionInfoContext=null);const s=e&&e.arcade;s&&v(r)&&v(i)?(this._featureExpressionInfoContext=cot(e),jJ(this._featureExpressionInfoContext,I2e(s.modules,r,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const r=new D2e;return v(e)&&r.setFromElevationInfo(e),r}},dot=class{constructor(e,r,i){this.graphic=e,this.renderingInfo=r,this.layer=i}};var ir;(function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OPAQUE=2]="OPAQUE"})(ir||(ir={}));let pot=class{constructor(e,r,i){this.baseMaterial=e,this.edgeMaterials=r,this.properties=i}},Om=class{get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}constructor(e,r,i,s,n,o,a,l=null){this.graphics3DSymbolLayer=e,this.stageObject=r,this._uniqueGeometries=i,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e,r){this._stageLayer=r,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject)}destroy(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const r=this._stage.renderer.ensureEdgeView();r.hasObject(this.stageObject)&&r.removeObject(this.stageObject),this.stageObject.dispose(),v(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,r){if(C(this._edgeState))return;const i=Ioe(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==i&&(n.objectTransparency=i,s=!0);s&&this._resetEdgeObject(r),this._stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,r){C(this._edgeState)||(this._stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!r),this._edgeState.properties.hasSlicePlane=e)}setVisibility(e){if(this._stage!=null&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),v(this._edgeState))){const r=this._stage.renderer.ensureEdgeView();r.hasObject(this.stageObject)?r.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(r,!1)}}get visible(){return this._visible}alignWithElevation(e,r,i,s){if(this.elevationAligner==null)return;v(i)&&jJ(this.elevationContext.featureExpressionInfoContext,i);const n=(o,a)=>fC(o,e,this.elevationContext,r,a);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,r),this._resetEdgeObject(s)}alignWithAbsoluteElevation(e,r,i){const s=(n,o)=>{o.sampledElevation=e,o.verticalDistanceToGround=0,o.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,r),this._resetEdgeObject(i)}getCenterObjectSpace(e=M()){return le(e,this.stageObject.boundingVolumeObjectSpace.bounds)}getBoundingBoxObjectSpace(e=Rn()){const r=this.stageObject.boundingVolumeObjectSpace;return lge(e,r.min),cge(e,r.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const r=this.stageObject.transformation;e.render.origin[0]+=r[12],e.render.origin[1]+=r[13],e.render.origin[2]+=r[14],e.render.num++}else for(const r of this.stageObject.geometries)r.computeAttachmentOrigin(Gm)&&(Xe(Gm,Gm,this.stageObject.transformation),me(e.render.origin,e.render.origin,Gm),e.render.num++)}async getProjectedBoundingBox(e,r,i,s,n){const o=this.getBoundingBoxObjectSpace(n),a=fot,l=GX(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];r0[0]=o[p[0]],r0[1]=o[p[1]],r0[2]=o[p[2]],Xe(r0,r0,this.stageObject.transformation),e1[3*h+0]=r0[0],e1[3*h+1]=r0[1],e1[3*h+2]=r0[2]}if(!e(e1,0,l))return null;Mi(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],e1[h+p]),o[p+3]=Math.max(o[p+3],e1[h+p]);c&&i.push({location:e1.slice(h,h+3),screenSpaceBoundingRect:c})}if(r&&r.service&&this.elevationContext.mode!=="absolute-height"){np(o,Gm);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(r.useViewElevation)p=It(r.service.getElevation(Gm[0],Gm[1],h),0);else try{const f=zJ(o,r.service.spatialReference,r);p=It(await r.service.queryElevation(Gm[0],Gm[1],s,f,h),0)}catch{}age(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(e,r){e===uy.Highlight&&r.addObject(this.stageObject,this.stageObject.highlight()),e===uy.MaskOccludee&&r.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}_resetEdgeObject(e){if(C(this._edgeState))return;const r=this._stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(r,e):r.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,r){const i=this._edgeState;if(C(i))return;const s=Ioe(i.baseMaterial);for(const n of i.edgeMaterials)n.objectTransparency=s;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!r).then(()=>{var n;return(n=this._stageLayer)==null?void 0:n.sync()})}};function Ioe(t){return t.isVisible()?t.parameters.transparent?ir.TRANSPARENT:ir.OPAQUE:ir.INVISIBLE}const e1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r0=M(),Gm=M(),fot=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];let N2e=class{constructor(e,r=null){this.labelText=r,this.elevationOffset=It(e,0)}};var Sn;(function(t){t[t.Recreate_Symbol=0]="Recreate_Symbol",t[t.Recreate_Graphics=1]="Recreate_Graphics",t[t.Fast_Update=2]="Fast_Update"})(Sn||(Sn={}));let HJ=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=wu.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,r){return this._loadStatus===wu.LOADED?(e&&e(),It(this._loader,Promise.resolve())):this._loadStatus===wu.FAILED?(r&&r(this._loadError),It(this._loader,Promise.resolve())):(C(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=wu.LOADED},i=>{throw this._loadError=i,this._abortController=null,this._loadStatus=wu.FAILED,!Ks(i)&&this.logger&&i.message&&this.logger.warn(i.message),i})),this._loader.then(e,r).catch(()=>{}),this._loader)}abortLoad(){v(this._abortController)?this._abortController=jh(this._abortController):this._loadStatus===wu.LOADING&&(this._loadStatus=wu.FAILED),this._loader=null}};var wu;(function(t){t[t.LOADING=0]="LOADING",t[t.LOADED=1]="LOADED",t[t.FAILED=2]="FAILED"})(wu||(wu={}));const F2e=3,jH=3,U2e=10;let V2e=class{constructor(e,r=null){this.geometry=e,this.textures=r}};function n$(t){const e=[];return t.levels.forEach(r=>r.components.forEach(i=>e.push(i.geometry.material))),gM(e)}function $oe(t){const e=new Array;return t.levels.forEach(r=>{r.components.forEach(i=>{v(i.textures)&&e.push(...i.textures)})}),gM(e)}function k2e(t){const e=t.components.map(r=>r.geometry);return gM(e)}function Loe(t){const e=[];return t.levels.forEach(r=>{r.components.forEach(i=>{e.push(i.geometry)})}),gM(e)}function mot(t){switch(t){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function z2e(t,e){const r=(i,s,n=!1)=>({levels:i.map(o=>{const a=s(o.tesselation);return n&&kQe(a),{components:[new V2e(a)],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(t){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],i=>FQe(e,.5,i,!0));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>RQe(e,1));case"cone":return r(B9,i=>cne(e,1,.5,i,!1),!0);case"inverted-cone":return r(B9,i=>cne(e,1,.5,i,!0),!0);case"cylinder":return r(B9,i=>VQe(e,1,.5,i,[0,0,1],[0,0,.5]));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>NQe(e,1),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>IQe(e,1),!0);default:return}}const B9=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function got(t){return t.type==="fill"}function yot(t){return t.type==="extrude"}function _ot(t){return t&&t.enabled&&(yot(t)||got(t))&&v(t.edges)}function vot(t){return t&&t.enabled&&t.edges||null}function B2e(t,e){return bot(vot(t),e)}function bot(t,e){if(C(t))return null;const r=v(t.color)?rY(Ze.toUnitRGBA(t.color)):qt(0,0,0,0),i=$o(t.size),s=$o(t.extensionLength);switch(t.type){case"solid":return wot({color:r,size:i,extensionLength:s,...e});case"sketch":return xot({color:r,size:i,extensionLength:s,...e});default:return}}function wot(t){return{...Tot,...t,type:"solid"}}function xot(t){return{...Sot,...t,type:"sketch"}}const Tot={color:qt(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:ir.OPAQUE,hasSlicePlane:!1},Sot={color:qt(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:ir.OPAQUE,hasSlicePlane:!1},qJ={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function FIt(t){return t.type==="web-style"?qJ:WJ(t.symbolLayers.toArray().map(e=>G2e(t,e)))}function WJ(t){let e=0,r=0,i=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of t)C(a)||(e+=a.primitivesPerFeature,r+=a.primitivesPerCoordinate,i+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.resourceBytes+=a.memory.resourceBytes,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:e,primitivesPerCoordinate:r,drawCallsPerFeature:i,estimated:s,memory:o,numComplexities:n}}function UIt(t){const e=WJ(t);return e.numComplexities>0&&(e.primitivesPerFeature/=e.numComplexities,e.primitivesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.bytesPerCoordinate/=e.numComplexities,e.memory.resourceBytes/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities,e.memory.draped.bytesPerCoordinate/=e.numComplexities),e}const Doe={};function G2e(t,e){const r=j2e(t,e),i=_ot(e)?2:0;switch(e.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:i,estimated:!1,memory:r};case"fill":return t.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:i,estimated:!1,memory:r}:v(e.outline)&&e.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:r}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:r};case"object":return e.resource&&e.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:r}:{...Eot(e.resource&&e.resource.primitive||gge),memory:r};case"path":{let s=0,n=0;switch(e.profile){case"circle":s=U2e;break;case"quad":s=4;break;default:return void(e.profile,void 0)}switch(e.join??"simple"){case"round":n=F2e;break;case"miter":case"bevel":n=1;break;default:return}const o=2*s,a=s*n*2;let l=-2*a-o;switch(e.cap){case"none":break;case"butt":case"square":l+=2*(s-1);break;case"round":l+=2*(s*(jH-1)*2+s);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:a+o,drawCallsPerFeature:0,estimated:!1,memory:r}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:r};default:return}}function j2e(t,e){const r=t.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?ml.EXTRUDE_EDGES:ml.EXTRUDE;case"fill":return v(e.outline)&&e.outline.size>0?ml.FILL_OUTLINE:ml.FILL;case"water":return ml.FILL;case"line":return e.join==="round"?ml.LINE_ROUND:ml.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return ml.PATH_ROUND_CIRCLE;case"quad":return ml.PATH_ROUND_QUAD;default:return void(e.profile,void 0)}case"miter":case"bevel":switch(e.profile){case"circle":return ml.PATH_MITER_CIRCLE;case"quad":return ml.PATH_MITER_QUAD;default:return void(e.profile,void 0)}default:return}case"object":return r?ml.OBJECT_POINT:ml.OBJECT_POLYGON;case"icon":case"text":return r?ml.ICON_POINT:ml.ICON_POLYGON;default:return}}function Eot(t){let e=Doe[t];if(e)return e;const r=z2e(t,null);return e={primitivesPerFeature:k2e(r.levels[0]).reduce((i,s)=>i+s.indices.get(A.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},Doe[t]=e,e}const ml={ICON_POINT:{bytesPerFeature:3293.7707557538765,bytesPerFeatureLabel:1020.2764,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:2213.51585392203,bytesPerFeatureLabel:1008.84664,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:4745.397589234022,bytesPerFeatureLabel:1006.5440666666666,bytesPerCoordinate:3.8971910718981526,resourceBytes:0,draped:{bytesPerFeature:3711.9299672493826,bytesPerFeatureLabel:991.1003999999999,bytesPerCoordinate:3.916858016273668}},OBJECT_POINT:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855,resourceBytes:0,draped:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855}},LINE_MITER:{bytesPerFeature:5757.019675077085,bytesPerFeatureLabel:998.6150266666667,bytesPerCoordinate:24.456810187064043,resourceBytes:0,draped:{bytesPerFeature:4101.480288021862,bytesPerFeatureLabel:1007.7540599999999,bytesPerCoordinate:18.25629912730874}},LINE_ROUND:{bytesPerFeature:5770.95297166408,bytesPerFeatureLabel:1017.77396,bytesPerCoordinate:24.60919037084966,resourceBytes:0,draped:{bytesPerFeature:4089.5796612121826,bytesPerFeatureLabel:987.8320266666666,bytesPerCoordinate:18.43599029126731}},PATH_MITER_CIRCLE:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863,resourceBytes:0,draped:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863}},PATH_ROUND_CIRCLE:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177,resourceBytes:0,draped:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177}},PATH_MITER_QUAD:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994,resourceBytes:0,draped:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994}},PATH_ROUND_QUAD:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293,resourceBytes:0,draped:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293}},FILL:{bytesPerFeature:6141.501452970723,bytesPerFeatureLabel:1008.2056066666665,bytesPerCoordinate:9.669541106191478,resourceBytes:0,draped:{bytesPerFeature:4615.812654782311,bytesPerFeatureLabel:1004.2114200000001,bytesPerCoordinate:7.378043214430644}},FILL_OUTLINE:{bytesPerFeature:9038.575581319641,bytesPerFeatureLabel:1017.9996066666668,bytesPerCoordinate:14.96569682175086,resourceBytes:0,draped:{bytesPerFeature:6369.386021594582,bytesPerFeatureLabel:1008.9863733333334,bytesPerCoordinate:10.25287774000214}},EXTRUDE:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849,resourceBytes:0,draped:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849}},EXTRUDE_EDGES:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031,resourceBytes:0,draped:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031}}},Gx=se.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let Mm=class extends HJ{constructor(e,r,i,s){super(i.schedule),this.symbol=e,this.symbolLayer=r,this._context=i,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=Gx,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Ip,this.complexity=this.computeComplexity(),this._ignoreDrivers=s.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=Noe(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(e){if(this._ignoreDrivers)return!1;const r=this._drivenProperties,i=Noe(e);return i.color!==r.color||i.opacity!==r.opacity||i.opacityAlwaysOpaque!==r.opacityAlwaysOpaque||i.size!==r.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,r,i,s){const n=e.projectionSuccess,o="polygons"in e?e.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!this._logGeometryValidationWarnings(r,i,s)&&o&&o.length===0&&i==="rings"&&r.length>0&&r[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (failed to project geometry to view spatial reference)`,l&&Gx.warnOncePerTick(l)}_logGeometryValidationWarnings(e,r,i){const s=`${i} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(Gx.warnOncePerTick(`${s} (no ${r} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(Gx.warnOncePerTick(`${s} (${r} should be defined as a 2D array)`),!0)}_validateGeometry(e,r=null,i=null){if(v(r)&&!r.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if(e.type==="point"){const s=e;if(!isFinite(s.x)||!isFinite(s.y))return Gx.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Cot}_defaultElevationInfoZ(){return Aot}_updateElevationContext(){v(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,r=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||r.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,r){const i=e.geometry,s=this.getDefaultElevationInfo(i);r.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,r.mode=this.getGeometryElevationMode(i,s),r.offsetMeters=It(this._elevationContext.meterUnitOffset,It(s.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&r.mode==="on-the-ground";n&&(r.mode="relative-to-ground",r.offsetMeters=0);const o=n?hot:this._elevationContext.featureExpressionInfoContext;return r.updateFeatureExpressionInfoContext(o,e,this._context.layer),r}prepareSymbolLayerPatch(e){}updateGeometry(e,r){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,r=Foe){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(v(e)?i*=e.a:r.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,r=Foe){const i=this._getCombinedOpacity(e,r);if(this._drivenProperties.color)return zO(null,i);const s=v(e)?Ze.toUnitRGB(e):Gf;return zO(s,i)}_getVertexOpacityAndColor(e,r=null){const i=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,n=zO(i,s);return v(r)&&(n[0]*=r,n[1]*=r,n[2]*=r,n[3]*=r),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return G2e(this.symbol,this.symbolLayer)}globalPropertyChanged(e,r,i){switch(e){case"opacity":return this.layerOpacityChanged(r,i),!0;case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(r,i,s)!==_s.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(r,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,r,i){let s=_s.UPDATE;return e.forEach(n=>{const o=r(n);if(v(o)){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=i(o.elevationContext.mode)}else s=_s.RECREATE}),s}applyRendererDiff(e,r){return Sn.Recreate_Symbol}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const r=this._fastUpdates.visualVariables,i=r.size?Jg(r.size.field,e):0,s=r.color?Jg(r.color.field,e):0,n=r.opacity?Jg(r.opacity.field,e):0;return qt(i,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&Gx.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>{var r,i,s,n,o,a,l,c,h,p,f,m;return{size:((s=(i=(r=this._fastUpdates)==null?void 0:r.visualVariables)==null?void 0:i.size)==null?void 0:s.field)??null,color:((a=(o=(n=this._fastUpdates)==null?void 0:n.visualVariables)==null?void 0:o.color)==null?void 0:a.field)??null,opacity:((h=(c=(l=this._fastUpdates)==null?void 0:l.visualVariables)==null?void 0:c.opacity)==null?void 0:h.field)??null,rotation:((m=(f=(p=this._fastUpdates)==null?void 0:p.visualVariables)==null?void 0:f.rotation)==null?void 0:m.field)??null}};return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function Jg(t,e){const r=t!=null?e.attributes[t]:0;return r!=null&&isFinite(r)?r:0}function Noe(t){const e={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return t&&"visualVariables"in t&&t.visualVariables&&t.visualVariables.forEach(r=>{switch(r.type){case"color":if(e.color=!0,r.stops)for(let i=0;i<r.stops.length;i++){const s=r.stops[i].color;s&&(e.opacity=!0,s.a<1&&(e.opacityAlwaysOpaque=!1))}break;case"opacity":e.opacity=!0,e.opacityAlwaysOpaque=!1;break;case"size":e.size=!0}}),e}const Cot={mode:"on-the-ground",offset:0,unit:"meters"},Aot={mode:"absolute-height",offset:0,unit:"meters"},Foe={hasIntrinsicColor:!1};let Py=class extends rP{get geometries(){return this._geometries}get transformation(){return this._transformation}set transformation(e){kn(this._transformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}constructor(e={}){super(),this.type=$s.Object,this._geometries=new Array,this._transformation=Ie(),this._bvObjectSpace=new Uoe,this._bvWorldSpace=new Uoe,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=e.castShadow==null||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new H2e);const r=e.geometries;v(r)&&(this._geometries=Array.from(r))}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){gt(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._hasVolatileTransformation=this._hasVolatileTransformation||e.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const r=this._geometries.splice(e,1)[0];r&&(this._emit("objectGeometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("objectGeometryUpdated",{object:this,geometry:e}),this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new KF(uy.MaskOccludee);for(const r of this._geometries)r.occludees=SH(r.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const r of this._geometries)r.occludees=EH(r.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new KF(uy.Highlight);for(const r of this._geometries)r.highlights=SH(r.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const r of this._geometries)r.highlights=EH(r.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,r){return ys(r,this.transformation,e.transformation)}_getCombinedShaderTransformation(e){return ys(Ie(),this.transformation,e.shaderTransformation)}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(const s of this._geometries){const n=s.boundingInfo;v(n)&&(Voe(n,this._bvObjectSpace,s.shaderTransformation),Voe(n,this._bvWorldSpace,this._getCombinedShaderTransformation(s)))}Qs(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Qs(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=M(),r=M(),i=Mw(this.transformation);for(const s of this._geometries){const n=s.boundingInfo;if(C(n))continue;const o=s.shaderTransformation,a=Mw(o);Xe(e,n.center,o);const l=Si(e,this._bvObjectSpace.bounds),c=n.radius*a;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),Xe(r,e,this.transformation);const h=Si(r,this._bvWorldSpace.bounds),p=c*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+p)}this._bvDirty=!1}_invalidateBoundingVolume(){this._bvDirty=!0,v(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,r){v(this._parentLayer)&&this._parentLayer.events.emit(e,r)}get test(){const e=this;return{hasGeometry:r=>e._geometries.includes(r),getGeometryIndex:r=>e._geometries.indexOf(r)}}},H2e=class{constructor(){this.min=$e(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=$e(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},Uoe=class extends H2e{constructor(){super(...arguments),this.bounds=cn()}init(){ce(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ce(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),dye(this.bounds)}};function Voe(t,e,r){const i=t.bbMin,s=t.bbMax;if(n5(r)){const n=ce(Rot,r[12],r[13],r[14]);me(Jc,i,n),me(fd,s,n);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Jc[o]),e.max[o]=Math.max(e.max[o],fd[o])}else if(Xe(Jc,i,r),Qa(i,s))for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],Jc[n]),e.max[n]=Math.max(e.max[n],Jc[n]);else{Xe(fd,s,r);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],Jc[n],fd[n]),e.max[n]=Math.max(e.max[n],Jc[n],fd[n]);for(let n=0;n<3;++n){le(Jc,i),le(fd,s),Jc[n]=s[n],fd[n]=i[n],Xe(Jc,Jc,r),Xe(fd,fd,r);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Jc[o],fd[o]),e.max[o]=Math.max(e.max[o],Jc[o],fd[o])}}}const Rot=M(),Jc=M(),fd=M();function XJ(t,e,r,i,s,n){const o=t.clippingExtent;if(ta(e,F_,t.elevationProvider.spatialReference),v(o)&&!zX(o,F_))return null;ta(e,F_,t.renderCoordsHelper.spatialReference);const a=t.localOriginFactory.getOrigin(F_),l=new Py({castShadow:!1,metadata:{layerUid:t.layer.uid,graphicUid:s,usesVerticalDistanceToGround:!0}});return r.shaderTransformer=n,r.localOrigin=a,l.addGeometry(r),{object:l,sampledElevation:Znt(l,e,t.elevationProvider,t.renderCoordsHelper,i)}}function X3(t,e,r){const i=t.elevationContext,s=r.spatialReference;ta(e,F_,s),i.centerPointInElevationSR=My(F_[0],F_[1],e.hasZ?F_[2]:0,v(s)?s:null)}function Y3(t){switch(t.type){case"point":return t;case"polygon":case"extent":return kJ(t);case"polyline":{const e=t.paths[0];if(!e||e.length===0)return null;const r=tfe(e,efe(e)/2);return My(r[0],r[1],r[2],t.spatialReference)}case"mesh":return t.origin}return null}const F_=M();function YJ(){return new Float32Array(2)}function Oot(t){const e=new Float32Array(2);return e[0]=t[0],e[1]=t[1],e}function Rh(t,e){const r=new Float32Array(2);return r[0]=t,r[1]=e,r}function Mot(t,e){return new Float32Array(t,e,2)}function q2e(){return YJ()}function W2e(){return Rh(1,1)}function X2e(){return Rh(1,0)}function Y2e(){return Rh(0,1)}const Z2e=q2e(),J2e=W2e(),Pot=X2e(),Iot=Y2e();Object.freeze(Object.defineProperty({__proto__:null,ONES:J2e,UNIT_X:Pot,UNIT_Y:Iot,ZEROS:Z2e,clone:Oot,create:YJ,createView:Mot,fromValues:Rh,ones:W2e,unitX:X2e,unitY:Y2e,zeros:q2e},Symbol.toStringTag,{value:"Module"}));function $ot(t){const e=new Lr;e.include(aJ),e.include(MTe,t),e.include(Zs,t),e.attributes.add(A.UV0,"vec2");const{vertex:r,fragment:i}=e;return r.uniforms.add([new fr("viewport",(s,n)=>n.camera.fullViewport),new Pe("lineSize",(s,n)=>Math.ceil(s.size)*n.camera.pixelRatio),new Ur("pixelToNDC",(s,n)=>ar(zoe,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new Pe("borderSize",(s,n)=>v(s.borderColor)?n.camera.pixelRatio:0),new Ur("screenOffset",(s,n)=>ar(zoe,s.screenOffset[0]*n.camera.pixelRatio,s.screenOffset[1]*n.camera.pixelRatio))]),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),t.hasMultipassGeometry&&e.varyings.add("depth","float"),t.hasScreenSizePerspective&&E6(r),r.code.add(w`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${t.occlusionTestEnabled?w`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${t.hasScreenSizePerspective?w`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:w`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${t.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${t.depthHudEnabled?t.depthHudAlignStartEnabled?w`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:w`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${t.hasScreenSizePerspective?w`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:w`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),i.uniforms.add([new fr("uColor",s=>koe(s.color)),new fr("borderColor",s=>koe(s.borderColor))]),t.hasMultipassGeometry&&(i.include(Uwe,t),i.uniforms.add(new Ur("inverseViewport",(s,n)=>n.inverseViewport))),i.code.add(w`
    void main() {
      ${t.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${t.depthHudEnabled?w`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:w`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),e}function koe(t){return v(t)?t:Kf}const zoe=Ke(),Lot=Object.freeze(Object.defineProperty({__proto__:null,build:$ot},Symbol.toStringTag,{value:"Module"}));let K2e=class Q2e extends kr{initializeConfiguration(e,r){r.spherical=e.viewingMode===Be.Global}initializeProgram(e){return new Nr(e.rctx,Q2e.shader.get().build(this.configuration),Ar)}setPipelineState(e){const r=e?$i.ALWAYS:$i.LESS;return this.configuration.depthHudEnabled?zt({depthTest:{func:r},depthWrite:Yl}):zt({blending:Bn(Ee.ONE,Ee.SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),depthTest:{func:r},colorWrite:Qt})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}};K2e.shader=new Dr(Lot,()=>ie(()=>import("./LineCallout.glsl-3a2a7438.js"),[],import.meta.url));let fh=class extends io{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=zl.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1}};u([k({count:zl.COUNT})],fh.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([k()],fh.prototype,"spherical",void 0),u([k()],fh.prototype,"occlusionTestEnabled",void 0),u([k()],fh.prototype,"hasVerticalOffset",void 0),u([k()],fh.prototype,"hasScreenSizePerspective",void 0),u([k()],fh.prototype,"depthHudEnabled",void 0),u([k()],fh.prototype,"depthHudAlignStartEnabled",void 0),u([k()],fh.prototype,"hasSlicePlane",void 0),u([k()],fh.prototype,"hasMultipassGeometry",void 0),u([k({constValue:!0})],fh.prototype,"hasSliceInVertexProgram",void 0),u([k({constValue:!1})],fh.prototype,"isDraped",void 0);let o$=class HH extends Pv{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new eSe),this._configuration=new fh,this._uniqueMaterialIdentifier=HH.uniqueMaterialIdentifier(this.parameters)}getPassParameters(){return this.parameters}getConfiguration(e,r){const i=(r==null?void 0:r.slot)!==Se.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=v(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=v(this.parameters.screenSizePerspective),this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?zl.Screen:zl.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration}intersect(){}requiresSlot(e,r){if(r===V.Color)switch(e){case Se.LINE_CALLOUTS:case Se.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(e){return new Dot(e)}createBufferWriter(){return new Fot}validateParameters(e){const r=HH.uniqueMaterialIdentifier(e);r!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=r)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}},Dot=class extends Mv{beginSlot(e){return this.ensureTechnique(K2e,e)}},eSe=class extends pC{constructor(){super(...arguments),this.screenOffset=Xl,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}};const Not=is().vec3f(A.POSITION).vec3f(A.NORMAL).vec2f(A.UV0).vec4f(A.AUXPOS1),Boe=[Rh(0,0),Rh(1,0),Rh(0,1),Rh(1,0),Rh(1,1),Rh(0,1)];let Fot=class{constructor(){this.vertexBufferLayout=Not}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(A.POSITION).length}write(e,r,i,s,n){C6(i.indices.get(A.POSITION),i.vertexAttributes.get(A.POSITION).data,e,s.position,n,6),PJ(i.indices.get(A.NORMAL),i.vertexAttributes.get(A.NORMAL).data,r,s.normal,n,6),ME(i.indices.get(A.AUXPOS1),i.vertexAttributes.get(A.AUXPOS1).data,s.auxpos1,n,6);for(let o=0;o<Boe.length;++o)s.uv0.setVec(n+o,Boe[o])}},tSe=class rSe extends Mm{constructor(e,r){super(e,null,r,kot),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new o$(this._materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(e){const r=this._materialParameters;return r.screenOffset=e.screenOffset||Xl,r.centerOffsetUnits=e.centerOffsetUnits||"world",r}get _materialParameters(){const e=new eSe,r=this.symbol,i=r.callout;if(e.color=v(i.color)?Ze.toUnitRGBA(i.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=$o(i.size||0),r.verticalOffset){const{screenLength:o,minWorldLength:a,maxWorldLength:l}=r.verticalOffset;e.verticalOffset={screenLength:$o(o),minWorldLength:a||0,maxWorldLength:v(l)?l:1/0}}e.borderColor=v(i.border)&&v(i.border.color)?Ze.toUnitRGBA(i.border.color):null;const s=r.symbolLayers.getItemAt(0).type==="object",n=r.type==="label-3d";return e.occlusionTest=!s,e.shaderPolygonOffset=s?0:void 0,e.depthHUDAlignStart=n,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return Vot}createGraphics3DGraphic(e){const r=e.renderingInfo,i=e.graphic,s=this.setGraphicElevationContext(i,new Ip,r.elevationOffset||0),n=r.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o||n.type==="point-3d"&&n.symbolLayers.every(l=>l.type==="text"&&!xge(l)))return null;const a=kJ(i.geometry);return C(a)?null:this._createAs3DShape(a,s,r,i.uid)}layerOpacityChanged(){v(this._material)&&this._material.setParameters(this._materialParameters)}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=aP(rSe.elevationModeChangeTypes,i,s);return n!==_s.UPDATE||e.forEach(o=>{const a=r(o);v(a)&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return C(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}setGraphicElevationContext(e,r,i=0){const s=super.setGraphicElevationContext(e,r);return s.addOffsetRenderUnits(i),s}updateGraphicElevationContext(e,r){this.setGraphicElevationContext(e,r.elevationContext,v(r.metadata)?r.metadata.elevationOffset:0),r.needsElevationUpdates=td(r.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:qJ.memory}}_createVertexData(e){const{translation:r,centerOffset:i}=e,s=new Ye(r?[r[0],r[1],r[2]]:[0,0,0],3,!0),n=new Ye(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],4,!0);return[[A.POSITION,s],[A.NORMAL,new Ye([0,0,1],3,!0)],[A.AUXPOS1,n]]}_getOrCreateMaterial(e){const r=this._perInstanceMaterialParameters(e),i=o$.uniqueMaterialIdentifier(r);if(v(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(v(e.materialCollection)){let s=e.materialCollection.get(i);return C(s)&&(s=new o$(r),e.materialCollection.add(i,s)),{material:s,isUnique:!1}}return{material:new o$(r),isUnique:!0}}_createAs3DShape(e,r,i,s){const n=this._context.layer.uid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:n}),a=this._getOrCreateMaterial(i),l=new ln(a.material,this._createVertexData(i),Uot,null,$s.Point,o),c=XJ(this._context,e,l,r,s);if(C(c))return null;const h=new Om(this,c.object,[l],a.isUnique?[a.material]:null,null,W3,r);return h.metadata=new N2e(i.elevationOffset),h.alignedSampledElevation=c.sampledElevation,h.needsElevationUpdates=td(r.mode),X3(h,e,this._context.elevationProvider),h}};tSe.elevationModeChangeTypes={definedChanged:_s.UPDATE,staysOnTheGround:_s.UPDATE,onTheGroundChanged:_s.RECREATE};const G9=[0],Uot=[[A.POSITION,G9],[A.NORMAL,G9],[A.AUXPOS1,G9]],Vot={mode:"relative-to-ground",offset:0},kot={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let zot=class{constructor(e,r,i=M(),s=nr(),n=Ke(),o="world",a=0,l=null){this.renderer=e,this.symbol=r,this.translation=i,this.centerOffset=s,this.screenOffset=n,this.centerOffsetUnits=o,this.elevationOffset=a,this.materialCollection=l}},Bot=class extends dot{};const Goe=se.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function Got(t,e){if(!XX(t))return Goe.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${t.type}' does not support callouts`),null;if(!t.callout)return null;const r=jot[t.callout.type];return r?new r(t,e):(Goe.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${t.callout.type}`),null)}const jot={line:tSe},joe=new Po(Array,t=>g5(t,uge),null,10,5),Hot=hr();let qot=class{get labelLayers(){return this._labelLayers}get extent(){return this._extent}constructor(e,r,i,s,n){this.graphic=e,this.graphics3DSymbol=r,this.layers=i,this._labelLayers=new Array,this._auxiliaryLayers=new Array,this._visibilityFlags=Wot(Oo._COUNT,Ac._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++r.referenced,this._featureExpressionFeature=n?I2e(n,e,s):null;for(const o of i)v(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}initialize(e,r){this._layer=r,this._stage=e,this._forEachSymbolLayerGraphic(i=>{i.initialize(e,r),i.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this.layers=null,this._auxiliaryLayers=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers.length=0}addLabelGraphic(e,r,i){this._labelLayers.push(e),e.initialize(r,i),e.setVisibility(this.isVisible(Oo.LABEL))}addAuxiliaryGraphic(e){this._auxiliaryLayers.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(r=>{r.type==="draped"&&(e=!0)}),e}isVisible(e=Oo.GRAPHIC,r){for(let i=0;i<=e;i++){const s=this._visibilityFlags[i];for(let n=0;n<s.length;++n)if(s[n]===!1&&n!==r)return!1}return!0}hasVisibilityFlag(e,r){return this._visibilityFlags[r][e]!=null}setVisibilityFlag(e,r,i){const s=this.isVisible(i);this._visibilityFlags[i][e]=r;const n=this.isVisible(i);if(s===n)return!1;if(i===Oo.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(n));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(Oo.LABEL);this._forEachLabelGraphic(a=>a.setVisibility(o))}return!0}clearVisibilityFlag(e,r=Oo.GRAPHIC){return this.setVisibilityFlag(e,void 0,r)}computeExtent(e){if(!this._extent){const r=this.graphic.geometry;if(C(r))return!1;this._extent=hr(),Unt(r,this._extent);const i=r.spatialReference;if(!Cn(i,e)&&!c5(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,r){return v(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===r||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,r),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=r),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,r,i){let s=e.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=bp.fromExtent(s.type==="mesh"?s.extent:s)),W7e(s,r,i)}get usedMemory(){let e=Yge(this.graphic.attributes);return this._forEachSymbolLayerGraphic(r=>{const i=r.graphics3DSymbolLayer.complexity;if(C(i))return;const s=r.type==="draped"?i.memory.draped:i.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=Fnt(this.graphic.geometry)*s.bytesPerCoordinate)}),e}computeAttachmentOrigin(){const e={render:{origin:M(),num:0},draped:{origin:Ke(),num:0}};for(const r of this.layers)C(r)||r.computeAttachmentOrigin(e);return e.render.num>1&&ae(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&Cc(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,r,i,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Mi(n.boundingBox):n.boundingBox=Mi(),n.requiresDrapedElevation=!1,await Z4(this.layers,async o=>{if(C(o))return;const a=o.type==="draped"?r:e,l=joe.acquire(),c=await o.getProjectedBoundingBox(a,i,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&oE(n.boundingBox,l),joe.release(l)}),L4e(n.boundingBox)||Sz(BX(n.boundingBox,Hot))?n:null}needsElevationUpdates(){for(const e of this.layers)if(v(e)&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;for(const e of this._labelLayers)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,r,i){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(e,r,this._featureExpressionFeature,i)})}alignWithAbsoluteElevation(e,r,i){this._forEachRenderedGraphic(s=>{s.type==="object3d"&&s.alignWithAbsoluteElevation(e,r,i)})}addObjectStateSet(e,r){this._forEachSymbolLayerGraphic(i=>i.addObjectState(e,r))}removeObjectState(e){this._forEachSymbolLayerGraphic(r=>r.removeObjectState(e))}_forEachGraphicList(e,r){e.forEach(i=>i&&r(i))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._forEachGraphicList(this._auxiliaryLayers,e)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}};function Wot(t,e){const r=new Array(t);for(let i=0;i<r.length;i++)r[i]=new Array(e);return r}var Hoe,qoe,Woe,yv={},Xot={get exports(){return yv},set exports(t){yv=t}};Hoe=Xot,qoe=function(){function t($,N,F){F=F||2;var H,X,J,W,ue,pe,we,Ce=N&&N.length,je=Ce?N[0]*F:$.length,De=e($,0,je,F,!0),xe=[];if(!De||De.next===De.prev)return xe;if(Ce&&(De=l($,N,De,F)),$.length>80*F){H=J=$[0],X=W=$[1];for(var Ne=F;Ne<je;Ne+=F)(ue=$[Ne])<H&&(H=ue),(pe=$[Ne+1])<X&&(X=pe),ue>J&&(J=ue),pe>W&&(W=pe);we=(we=Math.max(J-H,W-X))!==0?1/we:0}return i(De,xe,F,H,X,we),xe}function e($,N,F,H,X){var J,W;if(X===q($,N,F,H)>0)for(J=N;J<F;J+=H)W=K(J,$[J],$[J+1],W);else for(J=F-H;J>=N;J-=H)W=K(J,$[J],$[J+1],W);if(W&&O(W,W.next)){var ue=W.next;re(W),W=ue}return W}function r($,N){if(!$)return $;N||(N=$);var F,H=$;do if(F=!1,H.steiner||!O(H,H.next)&&E(H.prev,H,H.next)!==0)H=H.next;else{var X=H.prev;if(re(H),(H=N=X)===H.next)break;F=!0}while(F||H!==N);return N}function i($,N,F,H,X,J,W){if($){!W&&J&&y($,H,X,J);for(var ue,pe,we=$;$.prev!==$.next;)if(ue=$.prev,pe=$.next,J?n($,H,X,J):s($))N.push(ue.i/F),N.push($.i/F),N.push(pe.i/F),re($),$=pe.next,we=pe.next;else if(($=pe)===we){W?W===1?i($=o(r($),N,F),N,F,H,X,J,2):W===2&&a($,N,F,H,X,J):i(r($),N,F,H,X,J,1);break}}}function s($){var N=$.prev,F=$,H=$.next;if(E(N,F,H)>=0)return!1;for(var X=$.next.next;X!==$.prev;){if(T(N.x,N.y,F.x,F.y,H.x,H.y,X.x,X.y)&&E(X.prev,X,X.next)>=0)return!1;X=X.next}return!0}function n($,N,F,H){var X=$.prev,J=$,W=$.next;if(E(X,J,W)>=0)return!1;for(var ue=X.x<J.x?X.x<W.x?X.x:W.x:J.x<W.x?J.x:W.x,pe=X.y<J.y?X.y<W.y?X.y:W.y:J.y<W.y?J.y:W.y,we=X.x>J.x?X.x>W.x?X.x:W.x:J.x>W.x?J.x:W.x,Ce=X.y>J.y?X.y>W.y?X.y:W.y:J.y>W.y?J.y:W.y,je=b(ue,pe,N,F,H),De=b(we,Ce,N,F,H),xe=$.prevZ,Ne=$.nextZ;xe&&xe.z>=je&&Ne&&Ne.z<=De;){if(xe!==$.prev&&xe!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,xe.x,xe.y)&&E(xe.prev,xe,xe.next)>=0||(xe=xe.prevZ,Ne!==$.prev&&Ne!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,Ne.x,Ne.y)&&E(Ne.prev,Ne,Ne.next)>=0))return!1;Ne=Ne.nextZ}for(;xe&&xe.z>=je;){if(xe!==$.prev&&xe!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,xe.x,xe.y)&&E(xe.prev,xe,xe.next)>=0)return!1;xe=xe.prevZ}for(;Ne&&Ne.z<=De;){if(Ne!==$.prev&&Ne!==$.next&&T(X.x,X.y,J.x,J.y,W.x,W.y,Ne.x,Ne.y)&&E(Ne.prev,Ne,Ne.next)>=0)return!1;Ne=Ne.nextZ}return!0}function o($,N,F){var H=$;do{var X=H.prev,J=H.next.next;!O(X,J)&&R(X,H,H.next,J)&&z(X,J)&&z(J,X)&&(N.push(X.i/F),N.push(H.i/F),N.push(J.i/F),re(H),re(H.next),H=$=J),H=H.next}while(H!==$);return r(H)}function a($,N,F,H,X,J){var W=$;do{for(var ue=W.next.next;ue!==W.prev;){if(W.i!==ue.i&&S(W,ue)){var pe=G(W,ue);return W=r(W,W.next),pe=r(pe,pe.next),i(W,N,F,H,X,J),void i(pe,N,F,H,X,J)}ue=ue.next}W=W.next}while(W!==$)}function l($,N,F,H){var X,J,W,ue=[];for(X=0,J=N.length;X<J;X++)(W=e($,N[X]*H,X<J-1?N[X+1]*H:$.length,H,!1))===W.next&&(W.steiner=!0),ue.push(x(W));for(ue.sort(c),X=0;X<ue.length;X++)F=r(F=p(ue[X],F),F.next);return F}function c($,N){return $.x-N.x}function h($){if($.next.prev===$)return $;let N=$;for(;;){const F=N.next;if(F.prev===N||F===N||F===$)break;N=F}return N}function p($,N){var F=f($,N);if(!F)return N;var H=G(F,$),X=r(F,F.next);let J=h(H);return r(J,J.next),X=h(X),h(N===F?X:N)}function f($,N){var F,H=N,X=$.x,J=$.y,W=-1/0;do{if(J<=H.y&&J>=H.next.y&&H.next.y!==H.y){var ue=H.x+(J-H.y)*(H.next.x-H.x)/(H.next.y-H.y);if(ue<=X&&ue>W){if(W=ue,ue===X){if(J===H.y)return H;if(J===H.next.y)return H.next}F=H.x<H.next.x?H:H.next}}H=H.next}while(H!==N);if(!F)return null;if(X===W)return F;var pe,we=F,Ce=F.x,je=F.y,De=1/0;H=F;do X>=H.x&&H.x>=Ce&&X!==H.x&&T(J<je?X:W,J,Ce,je,J<je?W:X,J,H.x,H.y)&&(pe=Math.abs(J-H.y)/(X-H.x),z(H,$)&&(pe<De||pe===De&&(H.x>F.x||H.x===F.x&&m(F,H)))&&(F=H,De=pe)),H=H.next;while(H!==we);return F}function m($,N){return E($.prev,$,N.prev)<0&&E(N.next,$,$.next)<0}function y($,N,F,H){var X=$;do X.z===null&&(X.z=b(X.x,X.y,N,F,H)),X.prevZ=X.prev,X.nextZ=X.next,X=X.next;while(X!==$);X.prevZ.nextZ=null,X.prevZ=null,_(X)}function _($){var N,F,H,X,J,W,ue,pe,we=1;do{for(F=$,$=null,J=null,W=0;F;){for(W++,H=F,ue=0,N=0;N<we&&(ue++,H=H.nextZ);N++);for(pe=we;ue>0||pe>0&&H;)ue!==0&&(pe===0||!H||F.z<=H.z)?(X=F,F=F.nextZ,ue--):(X=H,H=H.nextZ,pe--),J?J.nextZ=X:$=X,X.prevZ=J,J=X;F=H}J.nextZ=null,we*=2}while(W>1);return $}function b($,N,F,H,X){return($=1431655765&(($=858993459&(($=252645135&(($=16711935&(($=32767*($-F)*X)|$<<8))|$<<4))|$<<2))|$<<1))|(N=1431655765&((N=858993459&((N=252645135&((N=16711935&((N=32767*(N-H)*X)|N<<8))|N<<4))|N<<2))|N<<1))<<1}function x($){var N=$,F=$;do(N.x<F.x||N.x===F.x&&N.y<F.y)&&(F=N),N=N.next;while(N!==$);return F}function T($,N,F,H,X,J,W,ue){return(X-W)*(N-ue)-($-W)*(J-ue)>=0&&($-W)*(H-ue)-(F-W)*(N-ue)>=0&&(F-W)*(J-ue)-(X-W)*(H-ue)>=0}function S($,N){return $.next.i!==N.i&&$.prev.i!==N.i&&!U($,N)&&(z($,N)&&z(N,$)&&B($,N)&&(E($.prev,$,N.prev)||E($,N.prev,N))||O($,N)&&E($.prev,$,$.next)>0&&E(N.prev,N,N.next)>0)}function E($,N,F){return(N.y-$.y)*(F.x-N.x)-(N.x-$.x)*(F.y-N.y)}function O($,N){return $.x===N.x&&$.y===N.y}function R($,N,F,H){var X=I(E($,N,F)),J=I(E($,N,H)),W=I(E(F,H,$)),ue=I(E(F,H,N));return X!==J&&W!==ue||!(X!==0||!L($,F,N))||!(J!==0||!L($,H,N))||!(W!==0||!L(F,$,H))||!(ue!==0||!L(F,N,H))}function L($,N,F){return N.x<=Math.max($.x,F.x)&&N.x>=Math.min($.x,F.x)&&N.y<=Math.max($.y,F.y)&&N.y>=Math.min($.y,F.y)}function I($){return $>0?1:$<0?-1:0}function U($,N){var F=$;do{if(F.i!==$.i&&F.next.i!==$.i&&F.i!==N.i&&F.next.i!==N.i&&R(F,F.next,$,N))return!0;F=F.next}while(F!==$);return!1}function z($,N){return E($.prev,$,$.next)<0?E($,N,$.next)>=0&&E($,$.prev,N)>=0:E($,N,$.prev)<0||E($,$.next,N)<0}function B($,N){var F=$,H=!1,X=($.x+N.x)/2,J=($.y+N.y)/2;do F.y>J!=F.next.y>J&&F.next.y!==F.y&&X<(F.next.x-F.x)*(J-F.y)/(F.next.y-F.y)+F.x&&(H=!H),F=F.next;while(F!==$);return H}function G($,N){var F=new ee($.i,$.x,$.y),H=new ee(N.i,N.x,N.y),X=$.next,J=N.prev;return $.next=N,N.prev=$,F.next=X,X.prev=F,H.next=F,F.prev=H,J.next=H,H.prev=J,H}function K($,N,F,H){var X=new ee($,N,F);return H?(X.next=H.next,X.prev=H,H.next.prev=X,H.next=X):(X.prev=X,X.next=X),X}function re($){$.next.prev=$.prev,$.prev.next=$.next,$.prevZ&&($.prevZ.nextZ=$.nextZ),$.nextZ&&($.nextZ.prevZ=$.prevZ)}function ee($,N,F){this.i=$,this.x=N,this.y=F,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function q($,N,F,H){for(var X=0,J=N,W=F-H;J<F;J+=H)X+=($[W]-$[J])*($[J+1]+$[W+1]),W=J;return X}return t.deviation=function($,N,F,H){var X=N&&N.length,J=X?N[0]*F:$.length,W=Math.abs(q($,0,J,F));if(X)for(var ue=0,pe=N.length;ue<pe;ue++){var we=N[ue]*F,Ce=ue<pe-1?N[ue+1]*F:$.length;W-=Math.abs(q($,we,Ce,F))}var je=0;for(ue=0;ue<H.length;ue+=3){var De=H[ue]*F,xe=H[ue+1]*F,Ne=H[ue+2]*F;je+=Math.abs(($[De]-$[Ne])*($[xe+1]-$[De+1])-($[De]-$[xe])*($[Ne+1]-$[De+1]))}return W===0&&je===0?0:Math.abs((je-W)/W)},t.flatten=function($){for(var N=$[0][0].length,F={vertices:[],holes:[],dimensions:N},H=0,X=0;X<$.length;X++){for(var J=0;J<$[X].length;J++)for(var W=0;W<N;W++)F.vertices.push($[X][J][W]);X>0&&(H+=$[X-1].length,F.holes.push(H))}return F},t},(Woe=qoe())!==void 0&&(Hoe.exports=Woe);const L6=se.getLogger("esri.views.3d.support.buffer.math");function cP(t,e,r){if(t.count!==e.count)return void L6.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[4],l=r[5],c=r[6],h=r[8],p=r[9],f=r[10],m=r[12],y=r[13],_=r[14],b=t.typedBuffer,x=t.typedBufferStride,T=e.typedBuffer,S=e.typedBufferStride;for(let E=0;E<i;E++){const O=E*x,R=E*S,L=T[R],I=T[R+1],U=T[R+2];b[O]=s*L+a*I+h*U+m,b[O+1]=n*L+l*I+p*U+y,b[O+2]=o*L+c*I+f*U+_}}function _v(t,e,r){if(t.count!==e.count)return void L6.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=t.typedBuffer,y=t.typedBufferStride,_=e.typedBuffer,b=e.typedBufferStride;for(let x=0;x<i;x++){const T=x*y,S=x*b,E=_[S],O=_[S+1],R=_[S+2];m[T]=s*E+a*O+h*R,m[T+1]=n*E+l*O+p*R,m[T+2]=o*E+c*O+f*R}}function qH(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=r*o[h],s[c+1]=r*o[h+1],s[c+2]=r*o[h+2]}}function ZJ(t,e){const r=Math.min(t.count,e.count),i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride;for(let a=0;a<r;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const y=1/Math.sqrt(m);i[l]=y*h,i[l+1]=y*p,i[l+2]=y*f}}}function Yot(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=o[h]>>r,s[c+1]=o[h+1]>>r,s[c+2]=o[h+2]>>r}}Object.freeze(Object.defineProperty({__proto__:null,normalize:ZJ,scale:qH,shiftRight:Yot,transformMat3:_v,transformMat4:cP},Symbol.toStringTag,{value:"Module"}));function Zot(t,e,r){return{objectId:t,target:e,distance:r,type:"vertex"}}function Xoe(t,e,r,i,s,n=!1){return{objectId:t,target:e,distance:r,type:"edge",start:i,end:s,draped:n}}function D6(t,e){if(!t||t.symbol)return null;const r=e&&e.renderer;return t&&v(r)&&r.getObservationRenderer?r.getObservationRenderer(t):r}function Jot(t,e){if(v(t.symbol))return t.symbol;const r=D6(t,e);return v(r)&&r.type!=="dot-density"?r.getSymbol(t,e):null}function ZIt(t,e){const r=D6(t,e),i=Jot(t,e);if(C(i))return null;const s={renderer:r,symbol:i};if(C(r)||!("visualVariables"in r)||!r.visualVariables)return s;const n=sZ(r,t,e)??[],o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function Kot(t,e){if(v(t.symbol))return t.symbol;const r=D6(t,e);return v(r)?r.getSymbolAsync(t,e):null}async function JIt(t,e){const r=D6(t,e),i=await Kot(t,e);if(!i)return null;const s={renderer:r,symbol:i};if(!r||!("visualVariables"in r)||!r.visualVariables)return s;const n=sZ(r,t,e)??[],o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=Ze.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function Qot(t,e=0){const r=t[e];return typeof r=="number"&&isFinite(r)?r:null}function eat(t){for(let e=0;e<3;e++){const r=t[e];if(typeof r=="number")return isFinite(r)?r:0}return 0}function Yoe(t){const e=[[A.POSITION,t.indices]],r=[[A.POSITION,new Ye(t.attributeData.position,3,!0)]];return v(t.attributeData.color)&&(r.push([A.COLOR,new Ye(t.attributeData.color,4,!0)]),e.push([A.COLOR,new Array(t.indices.length).fill(0)])),v(t.attributeData.uvMapSpace)&&(r.push([A.UVMAPSPACE,new Ye(t.attributeData.uvMapSpace,4,!0)]),e.push([A.UVMAPSPACE,t.indices])),v(t.attributeData.boundingRect)&&(r.push([A.BOUNDINGRECT,new Ye(t.attributeData.boundingRect,9,!0)]),e.push([A.BOUNDINGRECT,t.indices])),new ln(t.material,r,e,t.mapPositions,$s.Mesh,t.attributeData.objectAndLayerIdColor)}function Zoe(t){const e=[[A.POSITION,t.indices],[A.UV0,t.indices]],r=[[A.POSITION,new Ye(t.attributeData.position,3,!0)],[A.UV0,new Ye(t.attributeData.uv0,2,!0)]];return new ln(t.material,r,e,t.mapPositions)}function Z3(t){switch(t.type){case"extent":if(t instanceof Hr)return bp.fromExtent(t);break;case"polygon":return t}return null}let N6=class{constructor(e,r,i){this.renderData=e,this.layerUid=r,this.graphicUid=i,this.outGeometries=new Array}};function WH(t,e,r){const i=Array.isArray(t),s=i?t.length/e:t.byteLength/(4*e),n=i?t:new Uint32Array(t,0,s*e),o=(r==null?void 0:r.minReduction)??0,a=(r==null?void 0:r.originalIndices)||null,l=a?a.length:0,c=(r==null?void 0:r.componentOffsets)||null;let h=0;if(c)for(let R=0;R<c.length-1;R++){const L=c[R+1]-c[R];L>h&&(h=L)}else h=s;const p=Math.floor(1.1*h)+1;(zp==null||zp.length<2*p)&&(zp=new Uint32Array(qS(2*p)));for(let R=0;R<2*p;R++)zp[R]=0;let f=0;const m=!!c&&!!a,y=m?l:s;let _=gxe(s/3);const b=new Uint32Array(l),x=1.96;let T=o!==0?Math.ceil(4*x*x/(o*o)*o*(1-o)):y,S=1,E=c?c[1]:y;for(let R=0;R<y;R++){if(R===T){const G=1-f/R;if(G+x*Math.sqrt(G*(1-G)/R)<o)return null;T*=2}if(R===E){for(let G=0;G<2*p;G++)zp[G]=0;if(a)for(let G=c[S-1];G<c[S];G++)b[G]=_[a[G]];E=c[++S]}const L=m?a[R]:R,I=L*e,U=iat(n,I,e);let z=U%p,B=f;for(;zp[2*z+1]!==0;){if(zp[2*z]===U){const G=zp[2*z+1]-1;if(tat(n,I,G*e,e)){B=_[G];break}}z++,z>=p&&(z-=p)}B===f&&(zp[2*z]=U,zp[2*z+1]=L+1,f++),_[L]=B}if(o!==0&&1-f/s<o)return null;if(m){for(let R=c[S-1];R<b.length;R++)b[R]=_[a[R]];_=xS(b)}const O=i?new Array(f):new Uint32Array(f*e);f=0;for(let R=0;R<y;R++)_[R]===f&&(rat(n,(m?a[R]:R)*e,O,f*e,e),f++);if(a&&!m){const R=new Uint32Array(l);for(let L=0;L<R.length;L++)R[L]=_[a[L]];_=xS(R)}return{buffer:Array.isArray(O)?O:O.buffer,indices:_,uniqueCount:f}}function tat(t,e,r,i){for(let s=0;s<i;s++)if(t[e+s]!==t[r+s])return!1;return!0}function rat(t,e,r,i,s){for(let n=0;n<s;n++)r[i+n]=t[e+n]}function iat(t,e,r){let i=0;for(let s=0;s<r;s++)i=t[e+s]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let zp=null;function QIt(t){const e=uP(t.rings,t.hasZ,_m.CCW_IS_HOLE),r=new Array;let i=0,s=0;for(const a of e.polygons){const l=a.count,c=a.index,h=zh(e.position,3*c,3*l),p=a.holeIndices.map(m=>m-c),f=new Uint32Array(yv(h,p,3));r.push({position:h,faces:f}),i+=h.length,s+=f.length}const n=sat(r,i,s),o=Array.isArray(n.position)?WH(n.position,3,{originalIndices:n.faces}):WH(n.position.buffer,6,{originalIndices:n.faces});return n.position=new Float64Array(o.buffer),n.faces=o.indices,n}function sat(t,e,r){if(t.length===1)return t[0];const i=Bc(e),s=new Uint32Array(r);let n=0,o=0,a=0;for(const l of t){for(let c=0;c<l.position.length;c++)i[n++]=l.position[c];for(let c=0;c<l.faces.length;c++)s[o++]=l.faces[c]+a;a=n/3}return{position:i,faces:s}}function uP(t,e,r){const i=t.length,s=new Array(i),n=new Array(i),o=new Array(i);let a=0,l=0,c=0,h=0;for(let m=0;m<i;++m)h+=t[m].length;const p=Bc(3*h);let f=0;for(let m=i-1;m>=0;m--){const y=t[m],_=r===_m.CCW_IS_HOLE&&nat(y);if(_&&i!==1)s[a++]=y;else{let b=y.length;for(let T=0;T<a;++T)b+=s[T].length;const x={index:f,pathLengths:new Array(a+1),count:b,holeIndices:new Array(a)};x.pathLengths[0]=y.length,y.length>0&&(o[c++]={index:f,count:y.length}),f=_?a$(y,y.length-1,-1,p,f,y.length,e):a$(y,0,1,p,f,y.length,e);for(let T=0;T<a;++T){const S=s[T];x.holeIndices[T]=f,x.pathLengths[T+1]=S.length,S.length>0&&(o[c++]={index:f,count:S.length}),f=a$(S,0,1,p,f,S.length,e)}a=0,x.count>0&&(n[l++]=x)}}for(let m=0;m<a;++m){const y=s[m];y.length>0&&(o[c++]={index:f,count:y.length}),f=a$(y,0,1,p,f,y.length,e)}return n.length=l,o.length=c,{position:p,polygons:n,outlines:o}}function a$(t,e,r,i,s,n,o){s*=3;for(let a=0;a<n;++a){const l=t[e];i[s++]=l[0],i[s++]=l[1],i[s++]=o?l[2]:0,e+=r}return s/3}function nat(t){return!rfe(t,!1,!1)}var _m;(function(t){t[t.NONE=0]="NONE",t[t.CCW_IS_HOLE=1]="CCW_IS_HOLE"})(_m||(_m={}));var BO,f4,XH;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(BO||(BO={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(f4||(f4={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(XH||(XH={}));var es,Oh,Rt,GO,ms,bn,pa;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(es||(es={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Oh||(Oh={})),function(t){t[t.NORTH=0]="NORTH",t[t.NORTH_EAST=1]="NORTH_EAST",t[t.EAST=2]="EAST",t[t.SOUTH_EAST=3]="SOUTH_EAST",t[t.SOUTH=4]="SOUTH",t[t.SOUTH_WEST=5]="SOUTH_WEST",t[t.WEST=6]="WEST",t[t.NORTH_WEST=7]="NORTH_WEST"}(Rt||(Rt={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(GO||(GO={})),function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.Water=3]="Water",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(ms||(ms={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}(bn||(bn={})),function(t){t[t.INSIDE=0]="INSIDE",t[t.INTERSECTS=1]="INTERSECTS",t[t.OUTSIDE=2]="OUTSIDE"}(pa||(pa={}));let oat=class{constructor(e,r){this.vec3=e,this.id=r}};function jO(t,e,r,i){return new oat($e(t,e,r),i)}var Nl;(function(t){t[t.None=0]="None",t[t.ColorAndWater=1]="ColorAndWater",t[t.Highlight=2]="Highlight",t[t.Occluded=3]="Occluded",t[t.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"})(Nl||(Nl={}));let Joe=class{get extent(){return this._extent}constructor(e,r){this.index=e,this.renderTargets=r,this._extent=hr(),this.resolution=0,this.renderLocalOrigin=jO(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new aat,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(r.renderTargets.length).fill(!1)}getValidTexture(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}get _needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const r=e===Nl.ColorAndWater?this.renderTargets.getTarget(ms.Color):e===Nl.Highlight?this.renderTargets.getTarget(ms.Highlight):e===Nl.ObjectAndLayerIdColor?this.renderTargets.getTarget(ms.ObjectAndLayerIdColor):this.renderTargets.getTarget(ms.Occluded);return r?r.getTexture():null}getColorTextureNoRasterImage(){return this._needsColorWithoutRasterImage?this.getValidTexture(ms.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(ms.Color):null}getNormalTexture(e){const r=e===Nl.ColorAndWater?this.renderTargets.getTarget(ms.Water):null;return r?r.getTexture():null}draw(e,r){const i=this.computeRenderTargetValidityBitfield();for(const s of this.renderTargets.renderTargets)s.type!==ms.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[s.type]=e.drawTarget(this,s,r):this.validTargets[s.type]=!1;return i^this.computeRenderTargetValidityBitfield()?EE.CHANGED:EE.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[ms.Color]|+e[ms.ColorNoRasterImage]<<1|+e[ms.Highlight]<<2|+e[ms.Water]<<3|+e[ms.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const r=.001*e.range;if(this._extent[0]-r<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];rF(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];rF(this._extent,-e.range,0,i)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,oy(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===es.INNER?0:this.resolution,0,this.resolution,this.resolution)}},aat=class{constructor(){this.extents=[hr(),hr(),hr()],this.numViews=0}},iSe=class{constructor(e,r){this._size=YJ(),this._fbo=null,this._fbo=new Ns(e,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR_MIPMAP_LINEAR,hasMipmap:r,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=et(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(e,r){this._size[0]=e,this._size[1]=r,this._fbo.resize(this._size[0],this._size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){const e=this._fbo.colorTexture;e.descriptor.hasMipmap&&e.generateMipmap()}disposeRenderTargetMemory(){var e;(e=this._fbo)==null||e.resize(0,0)}get gpuMemoryUsage(){var e;return((e=this._fbo)==null?void 0:e.gpuMemoryUsage)??0}},jx=class{constructor(e,r,i,s=!0){this.output=r,this.type=i,this.valid=!1,this.lastUsed=1/0,this.fbo=new iSe(e,s)}},lat=class{constructor(e){this.renderTargets=[new jx(e,V.Color,ms.Color),new jx(e,V.Color,ms.ColorNoRasterImage),new jx(e,V.Highlight,ms.Highlight,!1),new jx(e,V.Normal,ms.Water),new jx(e,V.Color,ms.Occluded)],de("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new jx(e,V.ObjectAndLayerIdColor,ms.ObjectAndLayerIdColor))}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,r,i){if(e)r.lastUsed=i;else if(i-r.lastUsed>cat)r.fbo.disposeRenderTargetMemory(),r.lastUsed=1/0;else if(r.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((e,r)=>e+r.fbo.gpuMemoryUsage,0)}};const cat=1e3;let sSe=class{constructor(e){this._context=e,this._perConstructorInstances=new uC,this._frameCounter=0,this._keepAliveFrameCount=Koe}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,r=hat){const i=r.key;let s=this._perConstructorInstances.get(e,i);if(C(s)){const n=new e(this._context,r,()=>this.release(n));s=new uat(n),this._perConstructorInstances.set(e,i,s)}return++s.refCount,s.technique}releaseAndAcquire(e,r,i){if(v(i)){if(r.key===i.key)return i;this.release(i)}return this.acquire(e,r)}release(e){if(C(e)||this._perConstructorInstances.empty)return;const r=this._perConstructorInstances.get(e.constructor,e.key);C(r)||(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Koe&&this._perConstructorInstances.forEach((e,r)=>{e.forEach((i,s)=>{i.refCount===0&&i.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(i.technique.destroy(),this._perConstructorInstances.delete(r,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((r,i)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>l.technique.reload(this._context)))};e.push(s(r,i))}),await Promise.all(e)}},uat=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}};const Koe=-1,hat=new Pa;let nSe=class{constructor(e,r,i,s){this._textureRepository=e,this._techniqueRepository=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new uC}dispose(){this._textureRepository.destroy()}acquire(e,r,i){if(this._ownMaterial(e),!e.requiresSlot(r,i))return null;let s=this._id2glMaterialRef.get(i,e.id);if(C(s)){const n=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});s=new dat(n),this._id2glMaterialRef.set(i,e.id,s)}return s.ref(),s.glMaterial}release(e,r){const i=this._id2glMaterialRef.get(r,e.id);v(i)&&(i.unref(),i.referenced||(et(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){v(e.repository)&&e.repository!==this&&se.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},dat=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,gt(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const pat={orderedRepackingEnabled:!1},fat={rootOrigin:null},mat=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","objectGeometryUpdated"];let YH=class ZH{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,r){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Jn,this._objectCount=0,r&&(r.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=r.maximumObjectsPerNode),r.maximumDepth!==void 0&&(this._maximumDepth=r.maximumDepth))}destroy(){this._degenerateObjects.clear(),Jn.clearPool(),JH[0]=null,t1.prune(),db.prune()}add(e,r=e.length){this._objectCount+=r,this._grow(e,r);const i=Jn.acquire();for(let s=0;s<r;s++){const n=e[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(i.init(this._root),this._add(n,i))}Jn.release(i)}remove(e,r=null){this._objectCount-=e.length;const i=Jn.acquire();for(const s of e){const n=v(r)?r:dE(this._objectToBoundingSphere(s),bat);zR(n[3])?(i.init(this._root),this._remove(s,n,i)):this._degenerateObjects.delete(s)}Jn.release(i),this._shrink()}update(e,r){if(!zR(r[3])&&this._isDegenerate(e))return;const i=vat(e);this.remove(i,r),this.add(i)}forEachAlongRay(e,r,i){const s=Vu(e,r);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&i(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&i(a)}),!0})}forEachAlongRayWithVerticalOffset(e,r,i,s){const n=Vu(e,r);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&i(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&i(l)}),!0})}forEach(e){this._forEachNode(this._root,r=>{const i=r.node;return i.terminals.forAll(e),i.residents!==null&&i.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,r,i,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=j9(e,r),h=p=>{if(--n,!s(p))return;const f=this._objectToBoundingSphere(p);if(!I_(i,f))return;const m=u_(e,r,f),y=m-f[3],_=m+f[3];y<o&&(o=y,a=_,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!I_(i,p.bounds)||(ae(Yu,c,p.halfSize),me(Yu,Yu,p.bounds),u_(e,r,Yu)>a))return!1;const f=p.node;return f.terminals.forAll(m=>h(m)),f.residents!==null&&f.residents.forAll(m=>h(m)),!0},e,r),l}forEachInDepthRange(e,r,i,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:_=>{i===ZH.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,_.near),c=Math.min(c,_.far)):(l=Math.max(l,-_.far),c=Math.min(c,-_.near))}};h.setRange(s);const p=u_(r,i,e),f=j9(r,i),m=j9(r,-i),y=_=>{if(!a(_))return;const b=this._objectToBoundingSphere(_),x=b,T=u_(r,i,x)-p,S=T-b[3],E=T+b[3];S>c||E<l||!I_(o,b)||n(_,h)};this._forEachNodeDepthOrdered(this._root,_=>{if(!I_(o,_.bounds)||(ae(Yu,f,_.halfSize),me(Yu,Yu,_.bounds),u_(r,i,Yu)-p>c)||(ae(Yu,m,_.halfSize),me(Yu,Yu,_.bounds),u_(r,i,Yu)-p<l))return!1;const b=_.node;return b.terminals.forAll(x=>y(x)),b.residents!==null&&b.residents.forAll(x=>y(x)),!0},r,i)}forEachNode(e){this._forEachNode(this._root,r=>e(r.node,r.bounds,r.halfSize))}forEachNeighbor(e,r){const i=Hg(r),s=r,n=l=>{const c=this._objectToBoundingSphere(l),h=Hg(c),p=i+h;return!(Vn(c,s)-p*p<=0)||e(l)};let o=!0;const a=l=>{o&&(o=n(l))};this._forEachNode(this._root,l=>{const c=Hg(l.bounds),h=i+c;if(Vn(l.bounds,s)-h*h>0)return!1;const p=l.node;return p.terminals.forAll(a),o&&p.residents!==null&&p.residents.forAll(a),o}),o&&this.forEachDegenerateObject(a)}_intersectsNode(e,r){return l$(r.bounds,2*-r.halfSize,vu),l$(r.bounds,2*r.halfSize,bu),nne(e.origin,e.direction,vu,bu)}_intersectsNodeWithOffset(e,r,i){return l$(r.bounds,2*-r.halfSize,vu),l$(r.bounds,2*r.halfSize,bu),i.applyToMinMax(vu,bu),nne(e.origin,e.direction,vu,bu)}_intersectsObject(e,r){const i=this._objectToBoundingSphere(r);return!(i[3]>0)||c7(i,e)}_intersectsObjectWithOffset(e,r,i){const s=this._objectToBoundingSphere(r);return!(s[3]>0)||c7(i.applyToBoundingSphere(s),e)}_forEachNode(e,r){let i=Jn.acquire().init(e);const s=[i];for(;s.length!==0;){if(i=s.pop(),r(i)&&!i.isLeaf())for(let n=0;n<i.node.children.length;n++)i.node.children[n]&&s.push(Jn.acquire().init(i).advance(n));Jn.release(i)}}_forEachNodeDepthOrdered(e,r,i,s=ZH.DepthOrder.FRONT_TO_BACK){let n=Jn.acquire().init(e);const o=[n];for(_at(i,s,tae);o.length!==0;){if(n=o.pop(),r(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=tae[a];n.node.children[l]&&o.push(Jn.acquire().init(n).advance(l))}Jn.release(n)}}_remove(e,r,i){t1.clear();const s=i.advanceTo(r,(n,o)=>{t1.push(n.node),t1.push(o)})?i.node.terminals:i.node.residents;if(s.removeUnordered(e),s.length===0)for(let n=t1.length-2;n>=0;n-=2){const o=t1.data[n],a=t1.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(e){if(e.terminals.length!==0)return!1;if(e.residents!==null)return e.residents.length===0;for(let r=0;r<e.children.length;r++)if(e.children[r])return!1;return!0}_purge(e,r){return r>=0&&(e.children[r]=null),!!this._nodeIsEmpty(e)&&(e.residents===null&&(e.residents=new Kt({shrink:!0})),!0)}_add(e,r){r.advanceTo(this._objectToBoundingSphere(e))?r.node.terminals.push(e):(r.node.residents.push(e),r.node.residents.length>this._maximumObjectsPerNode&&r.depth<this._maximumDepth&&this._split(r))}_split(e){const r=e.node.residents;e.node.residents=null;for(let i=0;i<r.length;i++){const s=Jn.acquire().init(e);this._add(r.getItemAt(i),s),Jn.release(s)}}_grow(e,r){if(r!==0&&(Qoe(e,r,i=>this._objectToBoundingSphere(i),jm),zR(jm[3])&&!this._fitsInsideTree(jm)))if(this._nodeIsEmpty(this._root.node))dE(jm,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const i=this._rootBoundsForRootAsSubNode(jm);this._placingRootViolatesMaxDepth(i)?this._rebuildTree(jm,i):this._growRootAsSubNode(i),Jn.release(i)}}_rebuildTree(e,r){le(q9,r.bounds),q9[3]=r.halfSize,Qoe([e,q9],2,s=>s,W9);const i=Jn.acquire().init(this._root);this._root.initFrom(null,W9,W9[3]),this._root.increaseHalfSize(1.25),this._forEachNode(i,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),Jn.release(i)}_placingRootViolatesMaxDepth(e){const r=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,s=>(i=Math.max(i,s.depth),i+r<=this._maximumDepth)),i+r>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const r=e[3],i=e;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let l=0;l<3;l++){const c=n[l]-o-(i[l]-r),h=i[l]+r-(n[l]+o),p=Math.max(0,Math.ceil(c/(2*o))),f=Math.max(0,Math.ceil(h/(2*o)))+1,m=2**Math.ceil(Math.log(p+f)*Math.LOG2E);s=Math.max(s,m),c$[l].min=p,c$[l].max=f}for(let l=0;l<3;l++){let c=c$[l].min,h=c$[l].max;const p=(s-(c+h))/2;c+=Math.ceil(p),h+=Math.floor(p);const f=n[l]-o-c*o*2;H9[l]=f+(h+c)*o}const a=s*o;return H9[3]=a*aSe,Jn.acquire().initFrom(null,H9,a,0)}_growRootAsSubNode(e){const r=this._root.node;le(jm,this._root.bounds),jm[3]=this._root.halfSize,this._root.init(e),e.advanceTo(jm,null,!0),e.node.children=r.children,e.node.residents=r.residents,e.node.terminals=r.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const r=this._root.node.children;let i=0,s=0;for(;s<r.length&&e==null;)i=s++,e=r[i];for(;s<r.length;)if(r[s++])return-1;return i}_isDegenerate(e){return!zR(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const r=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=r[0]-i&&e[0]<=r[0]+i&&e[1]>=r[1]-i&&e[1]<=r[1]+i&&e[2]>=r[2]-i&&e[2]<=r[2]+i}},Jn=class v2{constructor(){this.bounds=cn(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,r,i,s=this.depth){return this.node=v(e)?e:v2.createEmptyNode(),v(r)&&dE(r,this.bounds),this.halfSize=i,this.depth=s,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*aSe}advance(e){let r=this.node.children[e];r||(r=v2.createEmptyNode(),this.node.children[e]=r),this.node=r,this.halfSize/=2,this.depth++;const i=oSe[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,r,i=!1){for(;;){if(this.isTerminalFor(e))return r&&r(this,-1),!0;if(this.isLeaf()){if(!i)return r&&r(this,-1),!1;this.node.residents=null}const s=this._childIndex(e);r&&r(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const r=this.bounds;return(r[0]<e[0]?1:0)+(r[1]<e[1]?2:0)+(r[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new Kt({shrink:!0}),residents:new Kt({shrink:!0})}}static acquire(){return v2._pool.acquire()}static release(e){v2._pool.release(e)}static clearPool(){v2._pool.prune()}};function gat(t,e){t[0]=Math.min(t[0],e[0]-e[3]),t[1]=Math.min(t[1],e[1]-e[3]),t[2]=Math.min(t[2],e[2]-e[3])}function yat(t,e){t[0]=Math.max(t[0],e[0]+e[3]),t[1]=Math.max(t[1],e[1]+e[3]),t[2]=Math.max(t[2],e[2]+e[3])}function l$(t,e,r){r[0]=t[0]+e,r[1]=t[1]+e,r[2]=t[2]+e}function Qoe(t,e,r,i){if(e===1){const s=r(t[0]);dE(s,i)}else{vu[0]=1/0,vu[1]=1/0,vu[2]=1/0,bu[0]=-1/0,bu[1]=-1/0,bu[2]=-1/0;for(let s=0;s<e;s++){const n=r(t[s]);zR(n[3])&&(gat(vu,n),yat(bu,n))}Qs(i,vu,bu,.5),i[3]=Math.max(bu[0]-vu[0],bu[1]-vu[1],bu[2]-vu[2])/2}}function _at(t,e,r){if(!db.length)for(let i=0;i<8;++i)db.push({index:0,distance:0});for(let i=0;i<8;++i){const s=oSe[i];db.data[i].index=i,db.data[i].distance=u_(t,e,s)}db.sort((i,s)=>i.distance-s.distance);for(let i=0;i<8;++i)r[i]=db.data[i].index}function j9(t,e){let r,i=1/0;for(let s=0;s<8;++s){const n=u_(t,e,eae[s]);n<i&&(i=n,r=eae[s])}return r}function u_(t,e,r){return e*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2])}function zR(t){return!isNaN(t)&&t!==-1/0&&t!==1/0&&t>0}Jn._pool=new Po(Jn),function(t){var e;(e=t.DepthOrder||(t.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(YH||(YH={}));const oSe=[$e(-1,-1,-1),$e(1,-1,-1),$e(-1,1,-1),$e(1,1,-1),$e(-1,-1,1),$e(1,-1,1),$e(-1,1,1),$e(1,1,1)],eae=[$e(-1,-1,-1),$e(-1,-1,1),$e(-1,1,-1),$e(-1,1,1),$e(1,-1,-1),$e(1,-1,1),$e(1,1,-1),$e(1,1,1)],aSe=Math.sqrt(3),JH=[null];function vat(t){return JH[0]=t,JH}const H9=cn(),Yu=M(),vu=M(),bu=M(),t1=new Kt,bat=cn(),jm=cn(),q9=cn(),W9=cn(),c$=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],db=new Kt,tae=[0,0,0,0,0,0,0,0],cp=YH;var X_;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(X_||(X_={}));let lSe=class extends rP{get objects(){return this._objects}constructor(e,r=""){super(),this.apiLayerUid=r,this.type=$s.Layer,this.events=new Fs,this.sliceable=!1,this._objects=new Kt,this._objectsAdded=new Kt,this._stageHandles=new Zr,this.apiLayerUid=r,this.visible=(e==null?void 0:e.visible)??!0,this.pickable=(e==null?void 0:e.pickable)??!0,this.updatePolicy=(e==null?void 0:e.updatePolicy)??X_.ASYNC,this._disableOctree=(e==null?void 0:e.disableOctree)??!1}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const r of mat)this._stageHandles.add(this.events.on(r,i=>e.handleEvent(r,i)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),v(this._octree)&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),v(this._octree)&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const r of e)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),v(this._octree)&&this._objectsAdded.pushArray(e)}removeMany(e){const r=new Array;if(this._objects.removeUnorderedMany(e,e.length,r),r.length!==0){for(const i of r)i.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),v(this._octree)){for(let i=0;i<r.length;)this._objectsAdded.removeUnordered(r[i])?(r[i]=r[r.length-1],r.length-=1):++i;this._octree.remove(r)}}}sync(){v(this._stage)&&this.updatePolicy!==X_.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,r){v(this._octree)&&!this._objectsAdded.includes(e)&&this._octree.update(e,r)}getSpatialQueryAccelerator(){return C(this._octree)&&this._objects.length>50&&!this._disableOctree?(this._octree=new cp(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):v(this._octree)&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=Ve(this._octree),this._objectsAdded.clear()}};function m4(t){return v(t)&&t.type===$s.Layer}var Bh,Ww;(function(t){t[t.Draped=0]="Draped",t[t.Screen=1]="Screen",t[t.World=2]="World",t[t.COUNT=3]="COUNT"})(Bh||(Bh={})),function(t){t[t.Center=0]="Center",t[t.Tip=1]="Tip",t[t.COUNT=2]="COUNT"}(Ww||(Ww={}));let So=class extends io{constructor(){super(...arguments),this.output=V.Color,this.transparencyPassType=Tt.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=Bh.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=Ww.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([k({count:V.COUNT})],So.prototype,"output",void 0),u([k({count:Tt.COUNT})],So.prototype,"transparencyPassType",void 0),u([k()],So.prototype,"occluder",void 0),u([k()],So.prototype,"hasSlicePlane",void 0),u([k()],So.prototype,"writeDepth",void 0),u([k({count:Bh.COUNT})],So.prototype,"space",void 0),u([k()],So.prototype,"hideOnShortSegments",void 0),u([k()],So.prototype,"hasCap",void 0),u([k({count:Ww.COUNT})],So.prototype,"anchor",void 0),u([k()],So.prototype,"hasTip",void 0),u([k()],So.prototype,"vvSize",void 0),u([k()],So.prototype,"vvColor",void 0),u([k()],So.prototype,"vvOpacity",void 0),u([k()],So.prototype,"hasOccludees",void 0),u([k()],So.prototype,"hasMultipassTerrain",void 0),u([k()],So.prototype,"cullAboveGround",void 0),u([k({constValue:!0})],So.prototype,"hasVvInstancing",void 0),u([k({constValue:!0})],So.prototype,"hasSliceTranslatedView",void 0);const rae=8;function cSe(t,e){const r=t.vertex;r.uniforms.add(new Pe("intrinsicWidth",i=>i.width)),e.vvSize?(t.attributes.add(A.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new Wt("vvSizeMinSize",i=>i.vvSizeMinSize)),r.uniforms.add(new Wt("vvSizeMaxSize",i=>i.vvSizeMaxSize)),r.uniforms.add(new Wt("vvSizeOffset",i=>i.vvSizeOffset)),r.uniforms.add(new Wt("vvSizeFactor",i=>i.vvSizeFactor)),r.code.add(w`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add(A.SIZE,"float"),r.code.add(w`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(t.attributes.add(A.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add([new ya("vvOpacityValues",i=>i.vvOpacityValues,rae),new ya("vvOpacityOpacities",i=>i.vvOpacityOpacities,rae)]),r.code.add(w`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(w`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(t.attributes.add(A.COLORFEATUREATTRIBUTE,"float"),r.constants.add("vvColorNumber","int",gp),r.uniforms.add(new ya("vvColorValues",i=>i.vvColorValues,gp)),r.uniforms.add(new R6("vvColorColors",i=>i.vvColorColors,gp)),r.code.add(w`vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(t.attributes.add(A.COLOR,"vec4"),r.code.add(w`vec4 getColor(){
return applyOpacity(color);
}`))}function py(t,e){switch(t.fragment.include(jc),e.output){case V.Shadow:case V.ShadowHighlight:case V.ShadowExcludeHighlight:t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(w`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 20.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`);break;case V.Depth:t.fragment.code.add(w`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}}let uSe=class{constructor(e){this._rctx=e,this._cache=new Map}destroy(){this._cache.forEach(e=>et(e.stippleTexture)),this._cache.clear()}_acquire(e){if(C(e))return null;const r=this._patternId(e),i=this._cache.get(r);if(i)return i.refCount++,i;const{encodedData:s,paddedPixels:n}=xat(e),o=new wat(new ct(this._rctx,{width:n,height:1,internalFormat:ze.RGBA,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE},s));return this._cache.set(r,o),o}release(e){if(C(e))return;const r=this._patternId(e),i=this._cache.get(r);i&&(i.refCount--,i.refCount===0&&(v(i.stippleTexture)&&i.stippleTexture.dispose(),this._cache.delete(r)))}swap(e,r){const i=this._acquire(r);return this.release(e),i}_patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}},wat=class extends pi{constructor(e){super(),this.stippleTexture=e,this.refCount=1}};function xat(t){const e=JJ(t),r=1/t.pixelRatio,i=hSe(t),s=dSe(t),n=(Math.floor(.5*(s-1))+.5)*r,o=[];let a=1;for(const m of e){for(let y=0;y<m;y++){const _=a*(Math.min(y,m-1-y)+.5)*r/n*.5+.5;o.push(_)}a=-a}const l=Math.round(e[0]/2),c=[...o.slice(l),...o.slice(0,l)],h=i+pSe,p=new Uint8Array(4*h);let f=4;for(const m of c)H3(m,p,f),f+=4;return p.copyWithin(0,f-4,f),p.copyWithin(f,4,8),{encodedData:p,paddedPixels:h}}function JJ(t){return t.pattern.map(e=>Math.round(e*t.pixelRatio))}function hSe(t){if(C(t))return 1;const e=JJ(t);return Math.floor(e.reduce((r,i)=>r+i))}function dSe(t){return JJ(t).reduce((e,r)=>Math.max(e,r))}const pSe=2;function Tat(t){return C(t)?Kf:t.length===4?t:ti(Sat,t[0],t[1],t[2],1)}const Sat=nr();function fSe(t,e){t.constants.add("stippleAlphaColorDiscard","float",.001),t.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?Eat(t,e):Cat(t)}function Eat(t,e){const r=!(e.draped&&e.stipplePreferContinuous),{vertex:i,fragment:s}=t;s.include(jc),e.draped||(Cp(i,e),i.uniforms.add(new Pe("worldToScreenPerDistanceRatio",(o,a)=>1/a.camera.perScreenPixelRatio)),i.code.add(w`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),t.varyings.add("vStippleDistance","float"),e.stippleRequiresClamp&&t.varyings.add("vStippleDistanceLimits","vec2"),e.stippleRequiresStretchMeasure&&t.varyings.add("vStipplePatternStretch","float"),i.code.add(w`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${Rat};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),i.code.add(w`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),i.code.add(w`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),i.uniforms.add(new Pe("pixelRatio",(o,a)=>a.camera.pixelRatio)),i.code.add(w`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${e.stippleRequiresStretchMeasure?w`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),s.constants.add("stippleTexturePadding","float",pSe);const n=e.hasWebGL2Context?ei.None:ei.Size;s.uniforms.add(fp("stipplePatternTexture",o=>o.stippleTexture,n)),s.uniforms.add([new Pe("stipplePatternSDFNormalizer",o=>Aat(o.stipplePattern)),new Pe("stipplePatternPixelSizeInv",o=>1/KJ(o))]),s.code.add(w`
    float padStippleTexture(float u) {
      float paddedTextureSize = ${kh(e,"stipplePatternTexture")}.x;
      float unpaddedTextureSize = paddedTextureSize - stippleTexturePadding;

      return (u * unpaddedTextureSize + stippleTexturePadding * 0.5) / paddedTextureSize;
    }
  `),s.code.add(w`
    float getStippleSDF(out bool isClamped) {
      ${e.stippleRequiresClamp?w`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:w`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${e.stippleScaleWithLineWidth?w`u *= vLineSizeInv;`:""}
      u = padStippleTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${e.stippleRequiresStretchMeasure?w`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:w`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${e.stippleScaleWithLineWidth?w`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:w`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),e.stippleOffColorEnabled?(s.uniforms.add(new fr("stippleOffColor",o=>Tat(o.stippleOffColor))),s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function Cat(t){t.fragment.code.add(w`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function Aat(t){return v(t)?(Math.floor(.5*(dSe(t)-1))+.5)/t.pixelRatio:1}function KJ(t){const e=t.stipplePattern;return v(e)?hSe(t.stipplePattern)/e.pixelRatio:1}const Rat=w.float(.4),J3=64,QJ=J3/2,mSe=QJ/5,Oat=J3/mSe,Mat=.25;function Pat(t,e){return t.fromData(`${e}-marker`,()=>XTe(e,J3,QJ,mSe))}function gSe(t,e){const r=t.vertex;t.constants.add("markerSizePerLineWidth","float",Oat),r.uniforms.add(new Pe("pixelRatio",(i,s)=>s.camera.pixelRatio)),C(r.uniforms.get("markerScale"))&&r.constants.add("markerScale","float",1),r.code.add(w`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),e.space===Bh.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new Pe("perRenderPixelRatio",(i,s)=>s.camera.perRenderPixelRatio)),r.code.add(w`float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}
bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}`))}var Gh;(function(t){t[t.BUTT=0]="BUTT",t[t.SQUARE=1]="SQUARE",t[t.ROUND=2]="ROUND",t[t.COUNT=3]="COUNT"})(Gh||(Gh={}));let Ki=class extends io{constructor(){super(...arguments),this.output=V.Color,this.capType=Gh.BUTT,this.transparencyPassType=Tt.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};u([k({count:V.COUNT})],Ki.prototype,"output",void 0),u([k({count:Gh.COUNT})],Ki.prototype,"capType",void 0),u([k({count:Tt.COUNT})],Ki.prototype,"transparencyPassType",void 0),u([k()],Ki.prototype,"occluder",void 0),u([k()],Ki.prototype,"hasSlicePlane",void 0),u([k()],Ki.prototype,"hasPolygonOffset",void 0),u([k()],Ki.prototype,"writeDepth",void 0),u([k()],Ki.prototype,"draped",void 0),u([k()],Ki.prototype,"stippleEnabled",void 0),u([k()],Ki.prototype,"stippleOffColorEnabled",void 0),u([k()],Ki.prototype,"stippleScaleWithLineWidth",void 0),u([k()],Ki.prototype,"stipplePreferContinuous",void 0),u([k()],Ki.prototype,"roundJoins",void 0),u([k()],Ki.prototype,"applyMarkerOffset",void 0),u([k()],Ki.prototype,"vvSize",void 0),u([k()],Ki.prototype,"vvColor",void 0),u([k()],Ki.prototype,"vvOpacity",void 0),u([k()],Ki.prototype,"falloffEnabled",void 0),u([k()],Ki.prototype,"innerColorEnabled",void 0),u([k()],Ki.prototype,"hasOccludees",void 0),u([k()],Ki.prototype,"hasMultipassTerrain",void 0),u([k()],Ki.prototype,"cullAboveGround",void 0),u([k()],Ki.prototype,"wireframe",void 0),u([k({constValue:!0})],Ki.prototype,"stippleRequiresClamp",void 0),u([k({constValue:!0})],Ki.prototype,"stippleRequiresStretchMeasure",void 0),u([k({constValue:!0})],Ki.prototype,"hasVvInstancing",void 0),u([k({constValue:!0})],Ki.prototype,"hasSliceTranslatedView",void 0),u([k()],Ki.prototype,"objectAndLayerIdColorInstanced",void 0);const g4=1;function Iat(t){const e=new Lr,{vertex:r,fragment:i}=e,s=t.hasMultipassTerrain&&(t.output===V.Color||t.output===V.Alpha);e.include(QM),e.include(cSe,t),e.include(fSe,t);const n=t.applyMarkerOffset&&!t.draped;n&&(r.uniforms.add(new Pe("markerScale",m=>m.markerScale)),e.include(gSe,{space:Bh.World})),t.output===V.Depth&&e.include(py,t),e.include(A6,t),Nc(r,t),r.uniforms.add([new qi("inverseProjectionMatrix",(m,y)=>y.camera.inverseProjectionMatrix),new Ur("nearFar",(m,y)=>y.camera.nearFar),new Pe("miterLimit",m=>m.join!=="miter"?0:m.miterLimit),new fr("viewport",(m,y)=>y.camera.fullViewport)]),r.constants.add("LARGE_HALF_FLOAT","float",65500),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.SUBDIVISIONFACTOR,"float"),e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.AUXPOS1,"vec3"),e.attributes.add(A.AUXPOS2,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),hv(e),s&&e.varyings.add("depth","float");const o=t.capType===Gh.ROUND,a=t.stippleEnabled&&t.stippleScaleWithLineWidth||o;a&&e.varyings.add("vLineWidth","float");const l=t.stippleEnabled&&t.stippleScaleWithLineWidth;l&&e.varyings.add("vLineSizeInv","float");const c=t.innerColorEnabled||o;c&&e.varyings.add("vLineDistance","float");const h=t.stippleEnabled&&o,p=t.falloffEnabled||h;p&&e.varyings.add("vLineDistanceNorm","float"),o&&(e.varyings.add("vSegmentSDF","float"),e.varyings.add("vReverseSegmentSDF","float")),r.code.add(w`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),d6(e),r.code.add(w`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${s?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),r.uniforms.add(new Pe("pixelRatio",(m,y)=>y.camera.pixelRatio)),r.code.add(w`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${a?w`vLineWidth = lineWidth;`:""}
      ${l?w`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);
  `),n&&r.code.add(w`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),r.code.add(w`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(t.stippleEnabled||o)&&r.code.add(w`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${o?w`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.code.add(w`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),t.roundJoins?r.code.add(w`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${t.stippleEnabled?w`min(1.0, subdivisionFactor * ${w.float((g4+2)/(g4+1))})`:w`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):r.code.add(w`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const f=t.capType!==Gh.BUTT;return r.code.add(w`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${f?w`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.code.add(w`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${p||c?w`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${c?w`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${p?w`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),o&&r.code.add(w`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),t.stippleEnabled&&(t.draped?r.uniforms.add(new Pe("worldToScreenRatio",(m,y)=>1/y.screenToPCSRatio)):r.code.add(w`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(w`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),t.draped?r.code.add(w`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.code.add(w`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Pe("stipplePatternPixelSize",m=>KJ(m))),r.code.add(w`
      float patternLength = ${t.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),r.code.add(w`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${t.wireframe&&!t.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),s&&e.include(zu,t),e.include(Zs,t),i.include(Am),i.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${s?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),t.wireframe?i.code.add(w`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(o&&i.code.add(w`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${w.float(Qo)}) {
        discard;
      }
    `),h?i.code.add(w`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${w.float(Qo)}, stippleCoverage);
      `):i.code.add(w`float stippleAlpha = getStippleAlpha();`),i.uniforms.add(new fr("intrinsicColor",m=>m.color)),t.output!==V.ObjectAndLayerIdColor&&i.code.add(w`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),i.code.add(w`vec4 color = intrinsicColor * vColor;`),t.innerColorEnabled&&(i.uniforms.add(new fr("innerColor",m=>It(m.innerColor,m.color))),i.uniforms.add(new Pe("innerWidth",(m,y)=>m.innerWidth*y.camera.pixelRatio)),i.code.add(w`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),i.code.add(w`vec4 finalColor = blendStipple(color, stippleAlpha);`),t.falloffEnabled&&(i.uniforms.add(new Pe("falloff",m=>m.falloff)),i.code.add(w`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),i.code.add(w`
    ${t.output===V.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(Qo)}) {
      discard;
    }

    ${t.output===V.Alpha?w`gl_FragColor = vec4(finalColor.a);`:""}
    ${t.output===V.Color?w`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===V.Color&&t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${t.output===V.Highlight?w`gl_FragColor = vec4(1.0);`:""}
    ${t.output===V.Depth?w`outputDepth(linearDepth);`:""}
    ${t.output===V.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const $at=Object.freeze(Object.defineProperty({__proto__:null,RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS:g4,build:Iat},Symbol.toStringTag,{value:"Module"})),eK={func:$i.LESS},y4={func:$i.ALWAYS},vm={mask:255},ySe={mask:0},Lat=t=>({function:{func:$i.NOTEQUAL,ref:t,mask:t},operation:{fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.KEEP}}),Dat=t=>({function:{func:$i.ALWAYS,ref:t,mask:t},operation:{fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.REPLACE}}),$v={function:{func:$i.ALWAYS,ref:jl.OutlineVisualElementMask,mask:jl.OutlineVisualElementMask},operation:{fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.ZERO}},vv={function:{func:$i.ALWAYS,ref:jl.OutlineVisualElementMask,mask:jl.OutlineVisualElementMask},operation:{fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.REPLACE}},_Se={function:{func:$i.EQUAL,ref:jl.OutlineVisualElementMask,mask:jl.OutlineVisualElementMask},operation:{fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.KEEP}},vSe={function:{func:$i.NOTEQUAL,ref:jl.OutlineVisualElementMask,mask:jl.OutlineVisualElementMask},operation:{fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.KEEP}},bSe=new Map([[A.POSITION,0],[A.SUBDIVISIONFACTOR,1],[A.UV0,2],[A.AUXPOS1,3],[A.AUXPOS2,4],[A.COLOR,5],[A.COLORFEATUREATTRIBUTE,5],[A.SIZE,6],[A.SIZEFEATUREATTRIBUTE,6],[A.OPACITYFEATUREATTRIBUTE,7],[A.OBJECTANDLAYERIDCOLOR,8]]);let wSe=class xSe extends kr{initializeProgram(e){return new Nr(e.rctx,xSe.shader.get().build(this.configuration),bSe)}_makePipelineState(e,r){const i=this.configuration,s=e===Tt.NONE,n=e===Tt.FrontFace;return zt({blending:i.output===V.Color||i.output===V.Alpha?s?Du:Oy(e):null,depthTest:{func:Iv(e)},depthWrite:s?i.writeDepth?Yl:null:O6(e),colorWrite:Qt,stencilWrite:i.hasOccludees?vm:null,stencilTest:i.hasOccludees?r?vv:$v:null,polygonOffset:s||n?i.hasPolygonOffset?iae:null:P6})}initializePipeline(){const e=this.configuration;if(e.occluder){const r=e.hasPolygonOffset?iae:null;this._occluderPipelineTransparent=zt({blending:Du,polygonOffset:r,depthTest:y4,depthWrite:null,colorWrite:Qt,stencilWrite:null,stencilTest:vSe}),this._occluderPipelineOpaque=zt({blending:Du,polygonOffset:r,depthTest:y4,depthWrite:null,colorWrite:Qt,stencilWrite:ySe,stencilTest:_Se}),this._occluderPipelineMaskWrite=zt({blending:null,polygonOffset:r,depthTest:eK,depthWrite:null,colorWrite:null,stencilWrite:vm,stencilTest:vv})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?$t.LINES:$t.TRIANGLE_STRIP}getPipelineState(e,r){return r?this._occludeePipelineState:this.configuration.occluder?e===Se.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===Se.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,r)}};wSe.shader=new Dr($at,()=>ie(()=>import("./RibbonLine.glsl-3a5d52ed.js"),[],import.meta.url));const iae={factor:0,units:-4};var fc;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(fc||(fc={}));let Q2=class extends Pv{constructor(e){super(e,new Fat),this._configuration=new Ki,this._vertexAttributeLocations=bSe,this._layout=this.createLayout()}isClosed(e,r){return SSe(this.parameters,e,r)}getConfiguration(e,r){this._configuration.output=e,this._configuration.draped=r.slot===Se.DRAPED_MATERIAL;const i=v(this.parameters.stipplePattern)&&e!==V.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&v(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=i&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!v(this.parameters.markerParameters)&&Vat(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&v(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===as.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,r,i,s,n,o){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get(A.POSITION).data,l=e.vertexAttributes.get(A.SIZE);let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const _=e.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0];c*=ye(this.parameters.vvSizeOffset[0]+_*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else l&&(c*=l.data[0]);const h=s[0],p=s[1],f=(c/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,y=0;for(let _=0;_<a.length-5;_+=3){const b=a[_],x=a[_+1],T=h-b,S=p-x,E=a[_+3]-b,O=a[_+4]-x,R=ye((E*T+O*S)/(E*E+O*O),0,1),L=E*R-T,I=O*R-S,U=L*L+I*I;U<m&&(m=U,y=_/3)}m<f*f&&n(o.dist,o.normal,y,!1)}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!e.visible)return;if(!pxe(r))return void se.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const a=e.vertexAttributes,l=a.get(A.POSITION).data;let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const T=a.get(A.SIZEFEATUREATTRIBUTE).data[0];c*=ye(this.parameters.vvSizeOffset[0]+T*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a.has(A.SIZE)&&(c*=a.get(A.SIZE).data[0]);const h=i.camera,p=kat;zn(p,i.point);const f=c*h.pixelRatio/2+4*h.pixelRatio;ce(rA[0],p[0]-f,p[1]+f,0),ce(rA[1],p[0]+f,p[1]+f,0),ce(rA[2],p[0]+f,p[1]-f,0),ce(rA[3],p[0]-f,p[1]-f,0);for(let T=0;T<4;T++)if(!h.unprojectFromRenderScreen(rA[T],Hm[T]))return;fa(h.eye,Hm[0],Hm[1],Y9),fa(h.eye,Hm[1],Hm[2],Z9),fa(h.eye,Hm[2],Hm[3],J9),fa(h.eye,Hm[3],Hm[0],K9);let m=Number.MAX_VALUE,y=0;const _=TSe(this.parameters,a,e.indices)?l.length-2:l.length-5;for(let T=0;T<_;T+=3){gl[0]=l[T]+r[12],gl[1]=l[T+1]+r[13],gl[2]=l[T+2]+r[14];const S=(T+3)%l.length;if(yl[0]=l[S]+r[12],yl[1]=l[S+1]+r[13],yl[2]=l[S+2]+r[14],wi(Y9,gl)<0&&wi(Y9,yl)<0||wi(Z9,gl)<0&&wi(Z9,yl)<0||wi(J9,gl)<0&&wi(J9,yl)<0||wi(K9,gl)<0&&wi(K9,yl)<0)continue;if(h.projectToRenderScreen(gl,i1),h.projectToRenderScreen(yl,s1),i1[2]<0&&s1[2]>0){ge(Bp,gl,yl);const O=h.frustum,R=-wi(O[bi.NEAR],gl)/_e(Bp,O[bi.NEAR]);ae(Bp,Bp,R),me(gl,gl,Bp),h.projectToRenderScreen(gl,i1)}else if(i1[2]>0&&s1[2]<0){ge(Bp,yl,gl);const O=h.frustum,R=-wi(O[bi.NEAR],yl)/_e(Bp,O[bi.NEAR]);ae(Bp,Bp,R),me(yl,yl,Bp),h.projectToRenderScreen(yl,s1)}else if(i1[2]<0&&s1[2]<0)continue;i1[2]=0,s1[2]=0;const E=lY(aw(i1,s1,oae),p);E<m&&(m=E,le(sae,gl),le(nae,yl),y=T/3)}const b=i.rayBegin,x=i.rayEnd;if(m<f*f){let T=Number.MAX_VALUE;if(Oye(aw(sae,nae,oae),aw(b,x,zat),r1)){ge(r1,r1,b);const S=Me(r1);ae(r1,r1,1/S),T=S/Si(b,x)}o(T,r1,y,!1)}}createLayout(){const e=is().vec3f(A.POSITION).f32(A.SUBDIVISIONFACTOR).vec2f(A.UV0).vec3f(A.AUXPOS1).vec3f(A.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(A.SIZEFEATUREATTRIBUTE):e.f32(A.SIZE),this.parameters.vvColorEnabled?e.f32(A.COLORFEATUREATTRIBUTE):e.vec4f(A.COLOR),this.parameters.vvOpacityEnabled&&e.f32(A.OPACITYFEATUREATTRIBUTE),de("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(A.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Uat(this._layout,this.parameters)}requiresSlot(e,r){return r===V.Color||r===V.Alpha||r===V.Highlight||r===V.Depth||r===V.ObjectAndLayerIdColor?e===Se.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===as.OccludeAndTransparentStencil?e===Se.OPAQUE_MATERIAL||e===Se.OCCLUDER_MATERIAL||e===Se.TRANSPARENT_OCCLUDER_MATERIAL:r===V.Color||r===V.Alpha?e===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===Se.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new Nat(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),v(e.markerParameters)&&(e.markerScale=e.markerParameters.width/e.width)}},Nat=class extends Mv{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==V.Color&&this._output!==V.Alpha||this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,r)),this._stipplePattern=r),this.ensureTechnique(wSe,e)}},Fat=class extends FJ{constructor(){super(...arguments),this.width=0,this.color=Lh,this.join="miter",this.cap=Gh.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},Uat=class{constructor(e,r){this._parameters=r,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const i=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=g4+i}}_isClosed(e){return TSe(this._parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const i=e.indices.get(A.POSITION).length/2+1,s=this._isClosed(e);let n=s?2:2*2;return n+=((s?i:i-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n}write(e,r,i,s,n){var ee;const o=Bat,a=Gat,l=jat,c=i.vertexAttributes.get(A.POSITION).data,h=i.indices&&i.indices.get(A.POSITION),p=(ee=i.vertexAttributes.get(A.DISTANCETOSTART))==null?void 0:ee.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,m=0;this._parameters.vvSizeEnabled?m=i.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.SIZE)&&(f=i.vertexAttributes.get(A.SIZE).data[0]);let y=[1,1,1,1],_=0;this._parameters.vvColorEnabled?_=i.vertexAttributes.get(A.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.COLOR)&&(y=i.vertexAttributes.get(A.COLOR).data);const b=de("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let x=0;this._parameters.vvOpacityEnabled&&(x=i.vertexAttributes.get(A.OPACITYFEATUREATTRIBUTE).data[0]);const T=c.length/3,S=new Float32Array(s.buffer),E=de("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,O=this.vertexBufferLayout.stride/4;let R=n*O;const L=R;let I=0;const U=p?(q,$,N)=>I=p[N]:(q,$,N)=>I+=Si(q,$),z=de("enable-feature:objectAndLayerId-rendering"),B=(q,$,N,F,H,X,J)=>{if(S[R++]=$[0],S[R++]=$[1],S[R++]=$[2],S[R++]=F,S[R++]=J,S[R++]=H,S[R++]=q[0],S[R++]=q[1],S[R++]=q[2],S[R++]=N[0],S[R++]=N[1],S[R++]=N[2],this._parameters.vvSizeEnabled?S[R++]=m:S[R++]=f,this._parameters.vvColorEnabled)S[R++]=_;else{const W=Math.min(4*X,y.length-4);S[R++]=y[W],S[R++]=y[W+1],S[R++]=y[W+2],S[R++]=y[W+3]}this._parameters.vvOpacityEnabled&&(S[R++]=x),z&&(v(b)&&(E[4*R]=b[0],E[4*R+1]=b[1],E[4*R+2]=b[2],E[4*R+3]=b[3]),R++)};R+=O,ce(a,c[0],c[1],c[2]),e&&Xe(a,a,e);const G=this._isClosed(i);if(G){const q=c.length-3;ce(o,c[q],c[q+1],c[q+2]),e&&Xe(o,o,e)}else ce(l,c[3],c[4],c[5]),e&&Xe(l,l,e),B(a,a,l,1,fc.LEFT_CAP_START,0,0),B(a,a,l,1,fc.RIGHT_CAP_START,0,0),le(o,a),le(a,l);const K=G?0:1,re=G?T:T-1;for(let q=K;q<re;q++){const $=(q+1)%T*3;ce(l,c[$],c[$+1],c[$+2]),e&&Xe(l,l,e),U(o,a,q),B(o,a,l,0,fc.LEFT_JOIN_END,q,I),B(o,a,l,0,fc.RIGHT_JOIN_END,q,I);const N=this.numJoinSubdivisions;for(let F=0;F<N;++F){const H=(F+1)/(N+1);B(o,a,l,H,fc.LEFT_JOIN_END,q,I),B(o,a,l,H,fc.RIGHT_JOIN_END,q,I)}B(o,a,l,1,fc.LEFT_JOIN_START,q,I),B(o,a,l,1,fc.RIGHT_JOIN_START,q,I),le(o,a),le(a,l)}G?(ce(l,c[3],c[4],c[5]),e&&Xe(l,l,e),I=U(o,a,re),B(o,a,l,0,fc.LEFT_JOIN_END,K,I),B(o,a,l,0,fc.RIGHT_JOIN_END,K,I)):(I=U(o,a,re),B(o,a,a,0,fc.LEFT_CAP_END,re,I),B(o,a,a,0,fc.RIGHT_CAP_END,re,I)),X9(S,L+O,S,L,O),R=X9(S,R-O,S,R,O),this._parameters.wireframe&&this._addWireframeVertices(s,L,R,O)}_addWireframeVertices(e,r,i,s){const n=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT,i-r);let a=0;const l=c=>a=X9(o,c,n,a,s);for(let c=0;c<o.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}};function X9(t,e,r,i,s){for(let n=0;n<s;n++)r[i++]=t[e++];return i}function TSe(t,e,r){return SSe(t,e.get(A.POSITION).data,r?r.get(A.POSITION):null)}function SSe(t,e,r){return!!t.isClosed&&(r?r.length>2:e.length>6)}function Vat(t){return t.anchor===Ww.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}const gl=M(),yl=M(),Bp=M(),r1=M(),kat=M(),i1=Zo(),s1=Zo(),sae=M(),nae=M(),oae=Rp(),zat=Rp(),Bat=M(),Gat=M(),jat=M(),rA=[Zo(),Zo(),Zo(),Zo()],Hm=[M(),M(),M(),M()],Y9=Br(),Z9=Br(),J9=Br(),K9=Br();let tK=class{constructor(e){this._originSR=e,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+$c()}getOrigin(e){const r=this._origins.get(this._rootOriginId);if(r==null){const h=fat.rootOrigin;if(v(h))return this._origins.set(this._rootOriginId,jO(h[0],h[1],h[2],this._rootOriginId)),this.getOrigin(e);const p=jO(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,p),p}const i=this._gridSize,s=Math.round(e[0]/i),n=Math.round(e[1]/i),o=Math.round(e[2]/i),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*i;if(ge(fo,e,r.vec3),fo[0]=Math.abs(fo[0]),fo[1]=Math.abs(fo[1]),fo[2]=Math.abs(fo[2]),fo[0]<c&&fo[1]<c&&fo[2]<c){if(l){const h=Math.max(...fo);if(ge(fo,e,l.vec3),fo[0]=Math.abs(fo[0]),fo[1]=Math.abs(fo[1]),fo[2]=Math.abs(fo[2]),Math.max(...fo)<h)return l}return r}return l||(l=jO(s*i,n*i,o*i,a),this._origins.set(a,l)),l}_drawOriginBox(e,r=qt(1,1,0,1)){const i=window.view,s=i._stage,n=r.toString();if(!this._objects.has(n)){this._material=new Q2({width:2,color:r}),s.add(this._material);const m=new lSe({pickable:!1}),y=new Py({castShadow:!1});s.add(y),m.add(y),s.add(m),this._objects.set(n,y)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Array,p=.5*this._gridSize;for(let m=0;m<l;m++)c[3*m+0]=e[0]+(1&a[m]?p:-p),c[3*m+1]=e[1]+(2&a[m]?p:-p),c[3*m+2]=e[2]+(4&a[m]?p:-p),m>0&&h.push(m-1,m);vs(c,this._originSR,0,c,i.renderSpatialReference,0,l);const f=new ln(this._material,[[A.POSITION,new Ye(c,3,!0)]],[[A.POSITION,h]],null,$s.Line);s.add(f),o.addGeometry(f)}get test(){const e=this;return{set gridSize(r){e._gridSize=r}}}};const fo=M();let ESe=class{constructor(e,r,i,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new At,this.output=V.Color,this.renderOccludedMask=aae,this.bindParameters=new h6(r,i,v(s)?s.plane:null)}resetRenderOccludedMask(){this.renderOccludedMask=aae}},Hat=class extends ESe{constructor(e,r,i,s,n){super(e,i,s,n),this.offscreenRenderingHelper=r,this.sliceHelper=n,this.time=0}};const aae=as.Occlude|as.OccludeAndTransparent|as.OccludeAndTransparentStencil;let BR=class extends At{constructor(){super(...arguments),this._projectionMatrix=Ie()}get projectionMatrix(){return this._projectionMatrix}};u([d()],BR.prototype,"_projectionMatrix",void 0),u([d({readOnly:!0})],BR.prototype,"projectionMatrix",null),BR=u([P("esri.views.3d.webgl-engine.lib.CascadeCamera")],BR);var $E;(function(t){t[t.Highlight=0]="Highlight",t[t.Default=1]="Default"})($E||($E={}));let u$=class{constructor(){this.camera=new BR,this.lightMat=Ie()}},rK=class{get depthTexture(){return this._depthTexture}get textureSize(){return this._textureSize}get numCascades(){return this._numCascades}get cascadeDistances(){return ti(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,r){this._rctx=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._projectionView=Ie(),this._projectionViewInverse=Ie(),this._modelViewLight=Ie(),this._splitSchemeLambda=0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=nr(),this._cascades=[new u$,new u$,new u$,new u$],this._lastOrigin=null,this._maxTextureSize=Math.min(de("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(e){this._maxNumCascades=ye(Math.floor(e),1,4)}get maxCascades(){return this._maxNumCascades}set enabled(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get ready(){return this._enabled&&v(this._depthTexture)}getSnapshot(e){return this.enabled?this._snapshots[e]:null}get cascades(){for(let e=0;e<this._numCascades;++e)eV[e]=this._cascades[e];return eV.length=this._numCascades,eV}start(e,r,i){gt(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();const{near:s,far:n}=this._clampNearFar(i);this._computeCascadeDistances(n,s),this._setupMatrices(e,r);const{viewMatrix:o,projectionMatrix:a}=e;for(let l=0;l<this._numCascades;++l)this._constructCascade(l,a,o,r);this._lastOrigin=null,this.clear()}finish(e){gt(this.enabled),this._rctx.bindFramebuffer(e)}getShadowMapMatrices(e){if(!this._lastOrigin||!Qa(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||M(),le(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){ql(pae,this._cascades[r].lightMat,e);for(let i=0;i<16;++i)fae[16*r+i]=pae[i]}}return fae}takeCascadeSnapshotTo(e,r){gt(this.enabled);const i=this._ensureSnapshot(r);this._bindFbo();const s=this._rctx,n=s.bindTexture(i,ct.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(wt.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),s.bindTexture(n,ct.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Fi.COLOR_BUFFER_BIT|Fi.DEPTH_BUFFER_BIT)}_computeTextureSize(e,r){const i=.5*Math.log(e*e+r*r)*Math.LOG2E,s=.35,n=2**Math.round(i+s);return Math.min(this._maxTextureSize,2*n)}_ensureDepthTexture(){if(v(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const e={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new ct(this._rctx,e),this._fbo=new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}_ensureSnapshot(e){let r=this._snapshots[e];if(v(r)&&r.descriptor.width===this._textureSize)return r;this._discardSnapshot(e);const i={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return r=new ct(this._rctx,i),this._snapshots[e]=r,r}_discardDepthTexture(){this._fbo=et(this._fbo),this._depthTexture=et(this._depthTexture)}_discardSnapshot(e){this._snapshots[e]=et(this._snapshots[e])}_discardAllSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)}_constructCascade(e,r,i,s){const n=this._cascades[e],o=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],l=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),c=(r[10]*a+r[14])/Math.abs(r[11]*a+r[15]);gt(l<c);for(let m=0;m<8;++m){ti(lae,m%4==0||m%4==3?-1:1,m%4==0||m%4==1?-1:1,m<4?l:c,1);const y=xh[m];Ru(y,lae,this._projectionViewInverse),y[0]/=y[3],y[1]/=y[3],y[2]/=y[3]}xa(Q9,xh[0]),n.camera.viewMatrix=ql(qat,this._modelViewLight,Q9);for(let m=0;m<8;++m)Xe(xh[m],xh[m],n.camera.viewMatrix);let h=xh[0][2],p=xh[0][2];for(let m=1;m<8;++m)h=Math.min(h,xh[m][2]),p=Math.max(p,xh[m][2]);h-=200,p+=200,n.camera.near=-p,n.camera.far=-h,Zat(i,s,h,p,n.camera),ys(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const f=this._textureSize/2;n.camera.viewport=[e%2==0?0:f,Math.floor(e/2)===0?0:f,f,f]}_setupMatrices(e,r){ys(this._projectionView,e.projectionMatrix,e.viewMatrix),Lo(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===Be.Global?e.eye:ce(Q9,0,0,1);s5(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_clampNearFar(e){let{near:r,far:i}=e;return r<2&&(r=2),i<2&&(i=2),r>=i&&(r=2,i=4),{near:r,far:i}}_computeCascadeDistances(e,r){this._numCascades=Math.min(1+Math.floor(pQe(e/r,4)),this._maxNumCascades);const i=(e-r)/this._numCascades,s=(e/r)**(1/this._numCascades);let n=r,o=r;for(let a=0;a<this._numCascades+1;++a)this._cascadeDistances[a]=Ft(n,o,this._splitSchemeLambda),n*=s,o+=i}get gpuMemoryUsage(){var e;return this._snapshots.reduce((r,i)=>r+Bw(i),((e=this._fbo)==null?void 0:e.gpuMemoryUsage)??0)}get test(){const e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(r){e._splitSchemeLambda=r},get splitSchemeLambda(){return e._splitSchemeLambda}}}};const qat=Ie(),lae=nr(),xh=[];for(let t=0;t<8;++t)xh.push(nr());const cae=Ke(),uae=Ke(),Wat=Ke(),hae=Ke(),dae=Ke(),Q9=M(),eV=[],pae=Ie(),fae=new Float32Array(64),Kc=Ke(),Hx=Ke(),n1=[Ke(),Ke(),Ke(),Ke()],On=Ke(),tV=Ke(),i0=Ke(),iA=Ke(),qx=Ke(),Wx=Ke(),h$=Ke();function Xat(t,e,r,i,s,n,o,a){ar(Kc,0,0);for(let O=0;O<4;++O)Xd(Kc,Kc,t[O]);Cc(Kc,Kc,.25),ar(Hx,0,0);for(let O=4;O<8;++O)Xd(Hx,Hx,t[O]);Cc(Hx,Hx,.25),m2(n1[0],t[4],t[5],.5),m2(n1[1],t[5],t[6],.5),m2(n1[2],t[6],t[7],.5),m2(n1[3],t[7],t[4],.5);let l=0,c=HF(n1[0],Kc);for(let O=1;O<4;++O){const R=HF(n1[O],Kc);R<c&&(c=R,l=O)}Vf(On,n1[l],t[l+4]);const h=On[0];let p,f;On[0]=-On[1],On[1]=h,Vf(tV,Hx,Kc),gn(tV,On)<0&&LZ(On,On),m2(On,On,tV,r),L3(On,On),p=f=gn(Vf(i0,t[0],Kc),On);for(let O=1;O<8;++O){const R=gn(Vf(i0,t[O],Kc),On);R<p?p=R:R>f&&(f=R)}zn(i,Kc),Cc(i0,On,p-e),Xd(i,i,i0);let m=-1,y=1,_=0,b=0;for(let O=0;O<8;++O){Vf(iA,t[O],i),L3(iA,iA);const R=On[0]*iA[1]-On[1]*iA[0];R>0?R>m&&(m=R,_=O):R<y&&(y=R,b=O)}Px(m>0,"leftArea"),Px(y<0,"rightArea"),Cc(qx,On,p),Xd(qx,qx,Kc),Cc(Wx,On,f),Xd(Wx,Wx,Kc),h$[0]=-On[1],h$[1]=On[0];const x=MI(i,t[b],Wx,Xd(i0,Wx,h$),1,s),T=MI(i,t[_],Wx,i0,1,n),S=MI(i,t[_],qx,Xd(i0,qx,h$),1,o),E=MI(i,t[b],qx,i0,1,a);Px(x,"rayRay"),Px(T,"rayRay"),Px(S,"rayRay"),Px(E,"rayRay")}function Er(t,e){return 3*e+t}const mae=Ke();function Kl(t,e){return ar(mae,t[e],t[e+3]),mae}const _l=Ke(),st=rs();function Yat(t,e,r,i,s){Vf(_l,r,i),Cc(_l,_l,.5),st[0]=_l[0],st[1]=_l[1],st[2]=0,st[3]=_l[1],st[4]=-_l[0],st[5]=0,st[6]=_l[0]*_l[0]+_l[1]*_l[1],st[7]=_l[0]*_l[1]-_l[1]*_l[0],st[8]=1,st[Er(0,2)]=-gn(Kl(st,0),t),st[Er(1,2)]=-gn(Kl(st,1),t);let n=gn(Kl(st,0),r)+st[Er(0,2)],o=gn(Kl(st,1),r)+st[Er(1,2)],a=gn(Kl(st,0),i)+st[Er(0,2)],l=gn(Kl(st,1),i)+st[Er(1,2)];n=-(n+a)/(o+l),st[Er(0,0)]+=st[Er(1,0)]*n,st[Er(0,1)]+=st[Er(1,1)]*n,st[Er(0,2)]+=st[Er(1,2)]*n,n=1/(gn(Kl(st,0),r)+st[Er(0,2)]),o=1/(gn(Kl(st,1),r)+st[Er(1,2)]),st[Er(0,0)]*=n,st[Er(0,1)]*=n,st[Er(0,2)]*=n,st[Er(1,0)]*=o,st[Er(1,1)]*=o,st[Er(1,2)]*=o,st[Er(2,0)]=st[Er(1,0)],st[Er(2,1)]=st[Er(1,1)],st[Er(2,2)]=st[Er(1,2)],st[Er(1,2)]+=1,n=gn(Kl(st,1),e)+st[Er(1,2)],o=gn(Kl(st,2),e)+st[Er(2,2)],a=gn(Kl(st,1),r)+st[Er(1,2)],l=gn(Kl(st,2),r)+st[Er(2,2)],n=-.5*(n/o+a/l),st[Er(1,0)]+=st[Er(2,0)]*n,st[Er(1,1)]+=st[Er(2,1)]*n,st[Er(1,2)]+=st[Er(2,2)]*n,n=gn(Kl(st,1),e)+st[Er(1,2)],o=gn(Kl(st,2),e)+st[Er(2,2)],a=-o/n,st[Er(1,0)]*=a,st[Er(1,1)]*=a,st[Er(1,2)]*=a,s[0]=st[0],s[1]=st[1],s[2]=0,s[3]=st[2],s[4]=st[3],s[5]=st[4],s[6]=0,s[7]=st[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=st[6],s[13]=st[7],s[14]=0,s[15]=st[8]}function Zat(t,e,r,i,s){const n=1/xh[0][3],o=1/xh[4][3];gt(n<o);let a=n+Math.sqrt(n*o);const l=Math.sin(An(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));a/=l,Xat(xh,a,l,cae,uae,Wat,hae,dae),Yat(cae,uae,hae,dae,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function Jat(t){return Op(t)&&t.intersector===ts.TERRAIN&&!!t.target}let Kat=class extends O5{constructor(e,r,i){super(e,r),this.triangleNr=i}};function CSe(t){return Op(t)&&t.intersector===ts.OVERLAY&&!!t.target}let KH=class{constructor(){this.adds=new Kt,this.removes=new Kt,this.updates=new Kt({allocator:e=>e||new Qat,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},Qat=class{},elt=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var os,Ln;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(os||(os={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(Ln||(Ln={}));function ASe(t){const e=new Map,r=i=>{let s=e.get(i);return s||(s=new elt,e.set(i,s)),s};return t.removes.forAll(i=>{rV(i)&&r(i.material).removes.push(i)}),t.adds.forAll(i=>{rV(i)&&r(i.material).adds.push(i)}),t.updates.forAll(i=>{rV(i.renderGeometry)&&r(i.renderGeometry.material).updates.push(i)}),e}function rV(t){return t.geometry.indexCount>=1}let tlt=class{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createProgram()}_createProgram(){const e=`
    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,r=`
    void main(void) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`;return this._rctx.programCache.acquire(e,r,new Map([]))}_createIndexbuffer(){return jr.createIndex(this._rctx,$r.STATIC_DRAW,new Uint32Array([0]))}resetIndicesType(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,Mt.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements($t.POINTS,1,lt.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}},RSe=class{constructor(e,r){this._material=e,this._repository=r,this._map=new Map}destroy(){this._map.forEach((e,r)=>{v(e)&&this._repository.release(this._material,r)})}load(e,r,i){if(!this._material.requiresSlot(r,i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,r,i));const s=this._map.get(i);if(v(s)){if(s.ensureResources(e)===Xg.LOADED)return s;this._repository.requestRender()}return null}};function rlt(t){const e=w`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;t.vertex.code.add(e)}function hP(t,e){switch(e.normalType){case si.CompressedAttribute:t.include(rlt),t.attributes.add(A.NORMALCOMPRESSED,"vec2"),t.vertex.code.add(w`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`);break;case si.Attribute:t.attributes.add(A.NORMAL,"vec3"),t.vertex.code.add(w`vec3 normalModel() {
return normal;
}`);break;case si.ScreenDerivative:t.extensions.add("GL_OES_standard_derivatives"),t.fragment.code.add(w`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`);break;default:e.normalType;case si.COUNT:case si.Ground:}}var si;(function(t){t[t.Attribute=0]="Attribute",t[t.CompressedAttribute=1]="CompressedAttribute",t[t.Ground=2]="Ground",t[t.ScreenDerivative=3]="ScreenDerivative",t[t.COUNT=4]="COUNT"})(si||(si={}));function F6(t,e){switch(e.normalType){case si.Attribute:case si.CompressedAttribute:t.include(hP,e),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("vNormalView","vec3"),t.vertex.uniforms.add([new F3("transformNormalGlobalFromModel",r=>r.transformNormalGlobalFromModel),new Rm("transformNormalViewFromGlobal",r=>r.transformNormalViewFromGlobal)]),t.vertex.code.add(w`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`);break;case si.Ground:t.include(wS,e),t.varyings.add("vNormalWorld","vec3"),t.vertex.code.add(w`
        void forwardNormal() {
          vNormalWorld = ${e.spherical?w`normalize(vPositionWorldCameraRelative);`:w`vec3(0.0, 0.0, 1.0);`}
        }
        `);break;case si.ScreenDerivative:t.vertex.code.add(w`void forwardNormal() {}`);break;default:e.normalType;case si.COUNT:}}let OSe=class extends Wwe{constructor(){super(...arguments),this.transformNormalViewFromGlobal=rs()}},MSe=class extends Xwe{constructor(){super(...arguments),this.transformNormalGlobalFromModel=rs(),this.toMapSpace=nr()}},QH=class extends MSe{constructor(e=M()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}},mC=class{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(A.POSITION).length}write(e,r,i,s,n){BTe(i,this.vertexBufferLayout,e,r,s,n)}};const ilt=is().vec3f(A.POSITION),slt=is().vec3f(A.POSITION).vec2f(A.UV0),PSe=is().vec3f(A.POSITION).vec4u8(A.COLOR);is().vec3f(A.POSITION).vec4u8(A.OBJECTANDLAYERIDCOLOR);is().vec3f(A.POSITION).vec2f(A.UV0).vec4u8(A.OBJECTANDLAYERIDCOLOR);const nlt=is().vec3f(A.POSITION).vec4u8(A.COLOR).vec4u8(A.OBJECTANDLAYERIDCOLOR);let iK=class extends Pv{intersect(e,r,i,s,n,o){return PTe(e,i,s,n,void 0,o)}};function olt(t){t.fragment.code.add(w`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function alt(t){t.fragment.code.add(w`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function gae(t){t.fragment.uniforms.add(new Pt("texWaveNormal",e=>e.waveNormal)),t.fragment.uniforms.add(new Pt("texWavePerturbation",e=>e.wavePertubation)),t.fragment.uniforms.add([new fr("waveParams",e=>ti(llt,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)),new Ur("waveDirection",e=>ar(clt,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity))]),t.include(olt),t.fragment.code.add(w`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const llt=nr(),clt=Ke();function K3(t,e){e.spherical?t.vertex.code.add(w`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(w`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(w`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(w`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}let dP=class extends ws{constructor(e,r){super(e,"int",di.Pass,(i,s,n)=>i.setUniform1i(e,r(s,n)))}},ult=class extends ws{constructor(e,r,i){super(e,"mat4",di.Draw,(s,n,o)=>s.setUniformMatrix4fv(e,r(n,o)),i)}},hlt=class extends ws{constructor(e,r,i){super(e,"mat4",di.Pass,(s,n,o)=>s.setUniformMatrix4fv(e,r(n,o)),i)}},ISe=class extends pi{constructor(){super(...arguments),this.origin=M()}};function U6(t,e){e.receiveShadows&&(t.fragment.uniforms.add(new hlt("shadowMapMatrix",(r,i)=>i.shadowMap.getShadowMapMatrices(r.origin),4)),$Se(t,e))}function Xw(t,e){e.receiveShadows&&(t.fragment.uniforms.add(new ult("shadowMapMatrix",(r,i)=>i.shadowMap.getShadowMapMatrices(r.origin),4)),$Se(t,e))}function $Se(t,e){const r=t.fragment;r.include(jc),r.uniforms.add([...fp("shadowMapTex",(i,s)=>s.shadowMap.depthTexture,e.hasWebGL2Context?ei.None:ei.Size),new dP("numCascades",(i,s)=>s.shadowMap.numCascades),new fr("cascadeDistances",(i,s)=>s.shadowMap.cascadeDistances)]),r.code.add(w`
    int chooseCascade(float depth, out mat4 mat) {
      vec4 distance = cascadeDistances;

      // choose correct cascade
      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;

      mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];

      return i;
    }

    vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
      vec4 lv = mat * vec4(_vpos, 1.0);
      lv.xy /= lv.w;
      return 0.5 * lv.xyz + vec3(0.5);
    }

    vec2 cascadeCoordinates(int i, vec3 lvpos) {
      return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
    }

    float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
      return rgba2float(texture2D(_depthTex, uv));
    }

    float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
      return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
    }

    float filterShadow(vec2 uv, vec3 lvpos, float textureSize, sampler2D _depthTex) {
      float halfPixelSize = 0.5 / textureSize;

      // filter, offset by half pixels
      vec2 st = fract((vec2(halfPixelSize) + uv) * textureSize);

      float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
      float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
      float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
      float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);

      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
    }

    float readShadowMap(const in vec3 _vpos, float _linearDepth) {
      mat4 mat;
      int i = chooseCascade(_linearDepth, mat);

      if (i >= numCascades) { return 0.0; }

      vec3 lvpos = lightSpacePosition(_vpos, mat);

      // vertex completely outside? -> no shadow
      if (lvpos.z >= 1.0) { return 0.0; }
      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }

      // calc coord in cascade texture
      vec2 uv = cascadeCoordinates(i, lvpos);

      vec2 textureSize = ${kh(e,"shadowMapTex")};

      return filterShadow(uv, lvpos, textureSize.x, shadowMapTex);
    }
  `)}function dlt(t){const e=t.fragment.code;e.add(w`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.add(w`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.add(w`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function sK(t,e){const r=t.fragment.code;t.include(QM),e.pbrMode!==dt.Normal&&e.pbrMode!==dt.Schematic&&e.pbrMode!==dt.Terrain&&e.pbrMode!==dt.TerrainWithWater||(r.add(w`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),r.add(w`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`)),e.pbrMode!==dt.Normal&&e.pbrMode!==dt.Schematic||(t.include(dlt),r.add(w`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),r.add(w`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),r.add(w`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),r.add(w`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function plt(t,e){const r=t.fragment.code;t.include(QM),r.add(w`
  struct PBRShadingWater
  {
      float NdotL;   // cos angle between normal and light direction
      float NdotV;   // cos angle between normal and view direction
      float NdotH;   // cos angle between normal and half vector
      float VdotH;   // cos angle between view direction and half vector
      float LdotH;   // cos angle between light direction and half vector
      float VdotN;   // cos angle between view direction and normal vector
  };

  float dtrExponent = ${e.useCustomDTRExponentForWater?"2.2":"2.0"};
  `),r.add(w`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),r.add(w`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),r.add(w`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),r.add(w`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)}function LSe(t,e){t.include(plt,e),t.include(l6),t.include(alt),e.hasCloudsReflections&&t.include(Owe,e),e.hasScreenSpaceReflections&&t.include(IKe,e);const r=t.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(w`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add([new Pe("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Pe("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)]),r.code.add(w`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),e.hasCloudsReflections&&r.code.add(w`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),e.hasScreenSpaceReflections?(r.uniforms.add([new qi("view",(i,s)=>s.ssr.camera.viewMatrix),new Pt("lastFrameColorTexture",(i,s)=>s.ssr.lastFrameColorTexture),new Pe("fadeFactor",(i,s)=>s.ssr.fadeFactor)]),r.code.add(w`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactor;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(w`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),e.hasCloudsReflections?e.hasScreenSpaceReflections?r.code.add(w`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor;
}`)}function flt(t){const e=new Lr,{vertex:r,fragment:i}=e;Nc(r,t),e.include(Gl,t),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2");const s=new fr("waterColor",n=>n.color);if(t.output===V.Color&&t.isDraped)return e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
        void main(void) {
          if (waterColor.a < ${w.float(Qo)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(s),i.code.add(w`void main() {
gl_FragColor = waterColor;
}`),e;switch(t.output!==V.Color&&t.output!==V.Alpha||(e.include(K3,t),e.include(cC,t),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(Qo)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${t.output===V.Color?"forwardLinearDepth();":""}
      }
    `)),e.include(zu,t),t.output){case V.Alpha:e.include(Zs,t),i.uniforms.add(s),i.code.add(w`
        void main() {
          discardBySlice(vpos);
          ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `);break;case V.Color:e.include(qF,t),e.include(jZ,{pbrMode:dt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(gae),e.include(Zs,t),e.include(Xw,t),e.include(LSe,t),i.uniforms.add([s,new Pe("timeElapsed",n=>n.timeElapsed),r.uniforms.get("view"),r.uniforms.get("localOrigin")]),Cp(i,t),i.include(Am),by(i),Cm(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${t.receiveShadows?w`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `);break;case V.Normal:e.include(K3,t),e.include(gae,t),e.include(Zs,t),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),r.uniforms.add(s),r.code.add(w`
        void main(void) {
          if (waterColor.a < ${w.float(Qo)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(new Pe("timeElapsed",n=>n.timeElapsed)),i.code.add(w`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case V.Highlight:e.include(Ry,t),e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(Qo)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(Zs,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const mlt=Object.freeze(Object.defineProperty({__proto__:null,build:flt},Symbol.toStringTag,{value:"Module"}));let DSe=class NSe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Nr(e.rctx,NSe.shader.get().build(this.configuration),Ar)}_setPipelineState(e){const r=this.configuration,i=e===Tt.NONE,s=e===Tt.FrontFace;return zt({blending:r.output!==V.Normal&&r.output!==V.Highlight&&r.transparent?i?Du:Oy(e):null,depthTest:{func:Iv(e)},depthWrite:i?r.writeDepth?Yl:null:O6(e),colorWrite:Qt,polygonOffset:i||s?null:I6(r.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};DSe.shader=new Dr(mlt,()=>ie(()=>import("./WaterSurface.glsl-b678341d.js"),[],import.meta.url));let Eo=class extends io{constructor(){super(...arguments),this.output=V.Color,this.transparencyPassType=Tt.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([k({count:V.COUNT})],Eo.prototype,"output",void 0),u([k({count:Tt.COUNT})],Eo.prototype,"transparencyPassType",void 0),u([k()],Eo.prototype,"spherical",void 0),u([k()],Eo.prototype,"receiveShadows",void 0),u([k()],Eo.prototype,"hasSlicePlane",void 0),u([k()],Eo.prototype,"transparent",void 0),u([k()],Eo.prototype,"enableOffset",void 0),u([k()],Eo.prototype,"writeDepth",void 0),u([k()],Eo.prototype,"hasScreenSpaceReflections",void 0),u([k()],Eo.prototype,"doublePrecisionRequiresObfuscation",void 0),u([k()],Eo.prototype,"hasCloudsReflections",void 0),u([k()],Eo.prototype,"isDraped",void 0),u([k()],Eo.prototype,"hasMultipassTerrain",void 0),u([k()],Eo.prototype,"cullAboveGround",void 0),u([k({constValue:dt.Water})],Eo.prototype,"pbrMode",void 0),u([k({constValue:!0})],Eo.prototype,"useCustomDTRExponentForWater",void 0),u([k({constValue:!0})],Eo.prototype,"highStepCount",void 0),u([k({constValue:!1})],Eo.prototype,"useFillLights",void 0);let glt=class extends Mv{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}_updateCloudsReflectionState(e){const r=v(e.cloudsFade.data);r!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:r})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===V.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(DSe,e)}},FSe=class extends iK{constructor(e){super(e,new USe),this._configuration=new Eo,this.animation=new xxe}getConfiguration(e,r){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<M6,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}update(e){const r=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*r<ylt;const i=this.animation.advance(e);return this.setParameters({timeElapsed:bW(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&i}requiresSlot(e,r){switch(r){case V.Normal:return e===Se.DRAPED_WATER;case V.Color:if(this.parameters.isDraped)return e===Se.DRAPED_MATERIAL;break;case V.Alpha:break;case V.Highlight:return e===Se.OPAQUE_MATERIAL||e===Se.DRAPED_MATERIAL;default:return!1}let i=Se.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i}createGLMaterial(e){return new glt(e)}createBufferWriter(){return new mC(slt)}},USe=class extends pC{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=Fr(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=qt(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1}};const ylt=35e3;let nK=class{constructor(e=0,r=0){this.from=e,this.to=r}get numElements(){return this.to-this.from}};function yae(t){const e=new Map;t.forAll(i=>e.set(i.from,i));let r=!0;for(;r;)r=!1,t.forEach(i=>{const s=e.get(i.to);s&&(i.to=s.to,e.delete(s.from),t.removeUnordered(s),r=!0)})}let _ae=class extends nK{constructor(e,r,i){super(r,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return v(this.geometry.highlights)&&this.isVisible}get hasOccludees(){return v(this.geometry.occludees)}},_lt=class{constructor(){this.first=0,this.count=0}},vlt=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Kt({allocator:e=>e||new nK,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=d$(),this.drawCommandsHighlight=d$(),this.drawCommandsOccludees=d$(),this.drawCommandsShadowHighlightRest=d$()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,r){this.deleteInstance(e),this._instances.set(e,r),this._numElements+=r.numElements}deleteInstance(e){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,this._instances.delete(e))}updateInstance(e,r,i){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=r,s.to=i,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const i=this.drawCommandsDefault.pushNew(),s=this.holes.front();return v(this.vao)&&this.holes.length===1&&s.to===Math.floor(this.vao.size/e)?(i.first=0,void(i.count=s.from)):(i.first=1/0,i.count=0,this._instances.forEach(n=>{i.first=Math.min(i.first,n.from),i.count=Math.max(i.count,n.to)}),void(i.count-=i.first))}const r=Array.from(this._instances.values()).sort((i,s)=>i.from===s.from?i.to-s.to:i.from-s.from);for(const i of r)i.isVisible&&(vae(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i),vae(i.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,i))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function blt(t){return v(t.vao)}function d$(){return new Kt({allocator:t=>t||new _lt,deallocator:t=>t})}function vae(t,e){const r=t.back();if(r==null){const i=t.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(wlt(r,e)){const i=e.from-r.first+e.numElements;r.count=i}else{const i=t.pushNew();i.first=e.from,i.count=e.numElements}}function wlt(t,e){return t.first+t.count>=e.from}let xlt=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(r=>r.instances.has(e))}};const Tlt=uD+1;let Slt=class{constructor(e,r,i){this._rctx=e,this._locations=r,this._layout=i,this._cache=e.newCache(`VaoCache ${$c()}`,Elt)}dispose(){this._cache.destroy()}newVao(e){const r=e.toString(),i=this._cache.pop(r);if(v(i)){const n=i.pop();return i.length>0&&this._cache.put(r,i,e*i.length,Tlt),n}const s=new Pp(this._rctx,this._locations,{geometry:this._layout},{geometry:jr.createVertex(this._rctx,$r.STATIC_DRAW)});return s.vertexBuffers.geometry.setSize(e),s}deleteVao(e){if(C(e))return null;const r=e.size,i=r.toString(),s=this._cache.pop(i);return v(s)?(s.push(e),this._cache.put(i,s,r*s.length,-1)):this._cache.put(i,[e],r,-1),null}};function Elt(t,e){if(e===Pg.ALL)return void t.forEach(s=>s.dispose());const r=t.pop(),i=t.length*r.size;return r.dispose(),i}let VSe=class{constructor(e,r,i){this._rctx=e,this._materialRepository=r,this.material=i,this._dataByOrigin=new Map,this._appleAmdDriverHelper=null,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new RSe(this.material,this._materialRepository),this._bufferWriter=i.createBufferWriter(),this._vaoCache=new Slt(e,i.vertexAttributeLocations,Hc(this._bufferWriter.vertexBufferLayout)),this._rctx.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper=new tlt(this._rctx))}dispose(){var e;this._glMaterials.destroy(),this._dataByOrigin.forEach(r=>r.dispose()),this._dataByOrigin.clear(),this._vaoCache.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof FSe}get rendersOccluded(){return!this.isEmpty&&this.material.renderOccluded!==as.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach(r=>e+=r.buffers.reduce((i,s)=>i+s.instances.size,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(r=>r.buffers.forEach(i=>i.instances.forEach(s=>e(s.geometry))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){var s;const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4;for(const n of e){const o=n.renderGeometry,a=(s=this._dataByOrigin.get(o.localOrigin.id))==null?void 0:s.findBuffer(o.id);if(C(a))return;const l=a.instances.get(o.id);if(n.updateType&(Ln.GEOMETRY|Ln.TRANSFORMATION)){const c=g$(r.elementCount(l.geometry.geometry)*i),h=r.vertexBufferLayout.createView(c.buffer);this._writeGeometry(o,h,0),a.vao.vertexBuffers.geometry.setSubData(c,l.from*i,0,l.numElements*i)}n.updateType&(Ln.HIGHLIGHT|Ln.OCCLUDEE|Ln.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,r){var s;const i=new uC;for(const n of e){const o=n.localOrigin;if(C(o))continue;let a=i.get(o.id,null);C(a)&&(a=new bae(o.vec3),i.set(o.id,null,a)),a.changes.push(n)}for(const n of r){const o=n.localOrigin;if(C(o))continue;const a=(s=this._dataByOrigin.get(o.id))==null?void 0:s.findBuffer(n.id);if(C(a))continue;let l=i.get(o.id,a);C(l)&&(l=new bae(o.vec3),i.set(o.id,a,l)),l.changes.push(n)}return i}_addAndRemoveGeometries(e,r){const{_bufferWriter:i,_dataByOrigin:s}=this,n=i.vertexBufferLayout.stride/4,o=this._computeDeltas(e,r);o.forEach((a,l)=>{const c=a.get(null),h=v(c)?c.changes:[];o.delete(l,null);let p=s.get(l);if(a.forEach((f,m)=>{if(o.delete(l,m),C(m))return void gt(!1,"No VAO for removed geometries");if(m.instances.size===f.changes.length)return this._vaoCache.deleteVao(m.vao),r3(p.buffers,m),void(p.buffers.length===0&&h.length===0&&s.delete(l));const y=m.numElements,_=m.vao.size/4,b=h.reduce((E,O)=>E+i.elementCount(O.geometry),0),x=f.changes.reduce((E,O)=>E+i.elementCount(O.geometry),0),T=Math.min((y+b-x)*n,m$),S=T>_;T>_4&&T<_/2?(f.changes.forEach(({id:E})=>m.deleteInstance(E)),m.instances.forEach(({geometry:E})=>h.push(E)),this._vaoCache.deleteVao(m.vao),r3(p.buffers,m)):S?this._applyAndRebuild(m,h,f):this._applyRemoves(m,f)}),h.length>0)for(C(p)&&(p=new xlt(c.origin),s.set(l,p)),p.buffers.forEach(f=>this._applyAdds(f,h));h.length>0;)p.buffers.push(this._applyAndRebuild(new vlt,h,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(r=>{r.drawCommandsDirty&&(r.hasHiddenInstances=!1,r.hasHighlights=!1,r.hasOccludees=!1,Yo(r.instances,i=>(r.updateDrawState(i),r.hasHiddenInstances&&r.hasHighlights&&r.hasOccludees)),r.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||r.hasHighlights,this._hasOccludees=this._hasOccludees||r.hasOccludees})})}_applyAndRebuild(e,r,i){if(v(i))for(const y of i.changes)e.deleteInstance(y.id);const s=this._bufferWriter,n=s.vertexBufferLayout.stride,o=n/4,a=Math.floor(m$/o);let l=e.numElements;for(;r.length>0;){const y=r.pop(),_=s.elementCount(y.geometry);if(l+_>a&&l>0){r.push(y);break}l+=_;const b=new _ae(y,0,0);gt(e.instances.get(y.id)==null),e.addInstance(y.id,b)}const c=l*o,h=g$(c),p=s.vertexBufferLayout.createView(h.buffer);let f=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach((y,_)=>{this._writeGeometry(y.geometry,p,f);const b=f;f+=s.elementCount(y.geometry.geometry),e.updateInstance(_,b,f),e.updateDrawState(y)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(xae(c)),e.vao.vertexBuffers.geometry.setSubData(h,0,0,f*o),e.holes.clear();const m=e.holes.pushNew();return m.from=f,m.to=Math.floor(e.vao.size/n),e.updateDrawCommands(n),e}_applyRemoves(e,r){if(r.changes.length===0)return;for(const a of r.changes){const l=a.id,c=e.instances.get(l);if(!c)continue;e.deleteInstance(l);const h=Gp.back();if(h){if(h.to===c.from){h.to=c.to;continue}if(h.from===c.to){h.from=c.from;continue}}const p=Gp.pushNew();p.from=c.from,p.to=c.to}yae(Gp);const i=this._bufferWriter.vertexBufferLayout.stride/4,s=Gp.reduce((a,l)=>Math.max(a,l.numElements),0)*i,n=g$(s);n.fill(0,0,s);const o=e.vao.vertexBuffers.geometry;Gp.forAll(a=>o.setSubData(n,a.from*i,0,a.numElements*i)),e.holes.pushArray(Gp.data,Gp.length),Gp.forAll((a,l)=>Gp.data[l]=null),Gp.clear(),e.drawCommandsDirty=!0}_applyAdds(e,r){if(r.length===0)return;if(!blt(e))return void this._applyAndRebuild(e,r,null);const i=this._bufferWriter,s=i.vertexBufferLayout.stride/4,n=e.numElements,o=r.reduce((x,T)=>x+i.elementCount(T.geometry),0),a=Math.min((n+o)*s,m$),l=4*a;if(e.vao.size<xae(m$-_4)&&l>e.vao.size)return void this._applyAndRebuild(e,r,null);yae(e.holes);const c=new Array;for(const x of r){const T=i.elementCount(x.geometry),S=Clt(e.holes,T);c.push(S)}const h=e.vao.vertexBuffers.geometry;let p=0,f=0,m=0;const y=g$(a),_=i.vertexBufferLayout.createView(y.buffer);r.forEach((x,T)=>{const S=c[T];if(C(S))return;if(m!==S){const R=m-f;R>0&&h.setSubData(y,f*s,0,R*s),f=S,p=0}const E=i.elementCount(x.geometry);this._writeGeometry(x,_,p),p+=E,m=S+E;const O=new _ae(x,S,S+E);gt(e.instances.get(x.id)==null),e.addInstance(x.id,O),e.drawCommandsDirty=!0});const b=m-f;b>0&&h.setSubData(y,f*s,0,b*s),s3e(r,(x,T)=>C(c[T]))}_writeGeometry(e,r,i){const s=e.localOrigin.vec3;fQe(wae,-s[0],-s[1],-s[2]);const n=ys(Alt,wae,e.transformation);Lo(p$,n),kc(p$,p$),this._bufferWriter.write(n,p$,e.geometry,r,i)}updateAnimation(e){return this.material.update(e)}requiresSlot(e,r){return this.material.requiresSlot(e,r)}render(e,r){var c;if(!this.requiresSlot(r.slot,e))return!1;const i=e===V.Highlight||e===V.ShadowHighlight;if(i&&!this._hasHighlights)return!1;const s=e===V.ShadowExcludeHighlight,n=!(i||s),o=this._rctx;let a;const l=()=>{if(v(a))return a;const h=this._glMaterials.load(o,r.slot,e);return C(h)?null:(a=h.beginSlot(r),C(a)?null:(o.bindTechnique(a,this.material.parameters,r),a))};(c=this._appleAmdDriverHelper)==null||c.resetIndicesType();for(const h of this._dataByOrigin.values())for(const p of h.buffers){if(i&&!p.hasHighlights)continue;const f=(i?p.drawCommandsHighlight:s&&p.needsMultipleCommands()?p.drawCommandsShadowHighlightRest:p.drawCommandsDefault)||null,m=n&&p.drawCommandsOccludees||null;if(f!=null&&f.length||m!=null&&m.length){const y=l();if(C(y))return!1;y.program.bindDraw(new QH(h.origin),r,this.material.parameters),y.ensureAttributeLocations(p.vao),o.bindVAO(p.vao),f!=null&&f.length&&(y.bindPipelineState(o,r.slot,!1),f.forAll(_=>o.drawArrays(y.primitiveType,_.first,_.count))),m!=null&&m.length&&(y.bindPipelineState(o,r.slot,!0),m.forAll(_=>o.drawArrays(y.primitiveType,_.first,_.count)))}}return v(a)}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}},bae=class{constructor(e){this.origin=e,this.changes=new Array}};function Clt(t,e){let r;if(!t.some(s=>!(s.numElements<e)&&(r=s,!0)))return null;const i=r.from;return r.from+=e,r.from>=r.to&&t.removeUnordered(r),i}const wae=Ie(),Alt=Ie(),p$=Ie(),Gp=new Kt({allocator:t=>t||new nK,deallocator:null}),_4=65536,f$=4*_4,kSe=16777216,m$=kSe/4;let iV=new Float32Array(_4);function g$(t){return iV.length<t&&(iV=new Float32Array(t)),iV}function xae(t){const e=4*t;return e<f$?f$:Math.max(Math.min(Math.ceil(1.5*e/f$)*f$,kSe),e)}let uu=class extends Te{constructor(e){super(e),this._pending=new Rlt,this._changes=new KH,this._materialRenderers=new Map,this._sortedMaterialRenderers=new Kt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Yo(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=ASe(this._changes);let r=!1,i=!1,s=!1;return e.forEach((n,o)=>{let a=this._materialRenderers.get(o);if(!a&&n.adds.length>0&&(a=new VSe(this.rctx,this._materialRepository,o),this._materialRenderers.set(o,a),r=!0,i=!0,s=!0),!a)return;const l=i||a.hasHighlights,c=s||a.hasWater;a.modify(n),i=i||l!==a.hasHighlights,s=s||c!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(o),a.dispose(),r=!0)}),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=Yo(this._materialRenderers,n=>n.hasHighlights)),s&&(this._hasWater=Yo(this._materialRenderers,n=>n.hasWater)),this.notifyChange("updating"),!0}addGeometries(e,r){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const n of i)this._geometries.set(n.id,n);const s=this._pending.empty;for(const n of i)this._pending.adds.add(n);s&&this.notifyChange("updating"),r===os.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,r){const i=this._pending.empty,s=this._pending.adds;for(const n of e)s.has(n)?(this._pending.removed.add(n),s.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n),this._geometries.delete(n.id);i&&!this._pending.empty&&this.notifyChange("updating"),r===os.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,r){const i=this._changes.updates.length===0;for(const s of e){const n=this._changes.updates.pushNew();n.renderGeometry=this._validateRenderGeometry(s),n.updateType=r}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),r){case Ln.TRANSFORMATION:case Ln.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case Ln.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let r=!1;return this._sortedMaterialRenderers.forAll(i=>r=i.updateAnimation(e)||r),r}render(e){this._sortedMaterialRenderers.forAll(r=>{r.material.shouldRender(e)&&r.render(e.output,e.bindParameters)})}intersect(e,r,i,s,n){return this._geometries.forEach(o=>{if(s&&!s(o))return;this._intersectRenderGeometry(o,i,r,0,e,n);const a=this.rendererContext.longitudeCyclical;a&&(o.boundingSphere[0]-o.boundingSphere[3]<a.min&&this._intersectRenderGeometry(o,i,r,a.range,e,n),o.boundingSphere[0]+o.boundingSphere[3]>a.max&&this._intersectRenderGeometry(o,i,r,-a.range,e,n)),n++}),n}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((r,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push(r)}),this._sortedMaterialRenderers.sort((r,i)=>{const s=i.material.renderPriority-r.material.renderPriority;return s!==0?s:r.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,r,i,s,n,o){if(!e.visible)return;let a=0;s+=e.transformation[12],a=e.transformation[13],sV[0]=i[0]-s,sV[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,n,sV,(l,c,h)=>{Olt(r,h,e.material.renderPriority,o,n,e.layerUid,e.graphicUid)},r)}_notifyGraphicGeometryChanged(e){if(C(this.drapeSource.notifyGraphicGeometryChanged))return;let r;for(const i of e){const s=i.graphicUid;v(s)&&s!==r&&(this.drapeSource.notifyGraphicGeometryChanged(s),r=s)}}_notifyGraphicVisibilityChanged(e){if(C(this.drapeSource.notifyGraphicVisibilityChanged))return;let r;for(const i of e){const s=i.graphicUid;v(s)&&s!==r&&(this.drapeSource.notifyGraphicVisibilityChanged(s),r=s)}}_validateRenderGeometries(e){for(const r of e)this._validateRenderGeometry(r);return e}_validateRenderGeometry(e){return C(e.localOrigin)&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],uu.prototype,"drapeSource",void 0),u([d()],uu.prototype,"updating",null),u([d()],uu.prototype,"rctx",null),u([d()],uu.prototype,"rendererContext",void 0),u([d()],uu.prototype,"_materialRepository",null),u([d()],uu.prototype,"_localOriginFactory",null),u([d({readOnly:!0})],uu.prototype,"isEmpty",null),u([d()],uu.prototype,"_materialRenderers",void 0),u([d()],uu.prototype,"_geometries",void 0),uu=u([P("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],uu);let Rlt=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function Olt(t,e,r,i,s,n,o){const a=new Kat(n,o,e),l=c=>{c.set(ts.OVERLAY,a,t.dist,t.normal,t.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==Do.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===Do.ALL){const c=wY(s.ray);l(c),s.results.all.push(c)}}const sV=Ke(),nV=4;function Mlt(){const t=new Lr,e=t.fragment;t.include(sd);const r=(nV+1)/2,i=1/(2*r*r);return e.include(ku),e.uniforms.add([new Pt("depthMap",s=>s.depthTexture),new KM("tex",s=>s.colorTexture),new N3("blurSize",s=>s.blurSize),new Pe("projScale",(s,n)=>{const o=Si(n.camera.eye,n.camera.center);return o>5e4?Math.max(0,s.projScale-(o-5e4)):s.projScale}),new Ur("nearFar",(s,n)=>n.camera.nearFar)]),e.code.add(w`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture2D(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv, nearFar);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${w.float(i)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.code.add(w`
    void main(void) {
      float b = 0.0;
      float w_total = 0.0;

      float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

      float sharpness = -0.05 * projScale / center_d;
      for (int r = -${w.int(nV)}; r <= ${w.int(nV)}; ++r) {
        float rf = float(r);
        vec2 uvOffset = uv + rf * blurSize;
        blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
      }

      gl_FragColor = vec4(b / w_total);
    }
  `),t}const Plt=Object.freeze(Object.defineProperty({__proto__:null,build:Mlt},Symbol.toStringTag,{value:"Module"}));let zSe=class BSe extends kr{initializeProgram(e){return new Nr(e.rctx,BSe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};zSe.shader=new Dr(Plt,()=>ie(()=>import("./SSAOBlur.glsl-8d7114fb.js"),[],import.meta.url));const Ilt="eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM";function V6(t){t.fragment.uniforms.add(new fr("projInfo",(e,r)=>$lt(r))),t.fragment.uniforms.add(new Ur("zScale",(e,r)=>GSe(r))),t.fragment.code.add(w`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function $lt(t){const e=t.camera.projectionMatrix;return e[11]===0?ti(Tae,2/(t.camera.fullWidth*e[0]),2/(t.camera.fullHeight*e[5]),(1+e[12])/e[0],(1+e[13])/e[5]):ti(Tae,-2/(t.camera.fullWidth*e[0]),-2/(t.camera.fullHeight*e[5]),(1-e[8])/e[0],(1-e[9])/e[5])}const Tae=nr();function GSe(t){return t.camera.projectionMatrix[11]===0?ar(Sae,0,1):ar(Sae,1,0)}const Sae=Ke(),Eae=16;function Llt(){const t=new Lr,e=t.fragment;return t.include(sd),e.include(ku),t.include(V6),e.uniforms.add(new Pe("radius",(r,i)=>oK(i.camera))),e.code.add(w`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),e.code.add(w`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.uniforms.add([new Ur("nearFar",(r,i)=>i.camera.nearFar),new Pt("normalMap",r=>r.normalTexture),new Pt("depthMap",r=>r.depthTexture),new Ur("zScale",(r,i)=>GSe(i)),new Pe("projScale",r=>r.projScale),new Pt("rnm",r=>r.noiseTexture),new Ur("rnmScale",(r,i)=>ar(Cae,i.camera.fullWidth/r.noiseTexture.descriptor.width,i.camera.fullHeight/r.noiseTexture.descriptor.height)),new Pe("intensity",r=>r.intensity),new Ur("screenSize",(r,i)=>ar(Cae,i.camera.fullWidth,i.camera.fullHeight))]),e.code.add(w`
    void main(void) {
      fillSphere();
      vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
      float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
        gl_FragColor = vec4(0.0);
        return;
      }

      vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

      // get the normal of current fragment
      vec4 norm4 = texture2D(normalMap, uv);
      vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
      bool isTerrain = norm4.w<0.5;

      float sum = .0;
      vec3 tapPixelPos;

      // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
      // bug or deviation from CE somewhere else?
      float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);

      for(int i = 0; i < ${w.int(Eae)}; ++i) {
        vec2 unitOffset = reflect(sphere[i], fres).xy;
        vec2 offset = vec2(-unitOffset * radius * ps);

        //don't use current or very nearby samples
        if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

        vec2 tc = vec2(gl_FragCoord.xy + offset);
        if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
        vec2 tcTap = tc / screenSize;
        float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

        if (isTerrain) {
          bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
          if (isTerrainTap) {
            continue;
          }
        }

        tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

        sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
      }

      // output the result
      float A = max(1.0 - sum * intensity / float(${w.int(Eae)}),0.0);

      // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
      A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
      gl_FragColor = vec4(A);
    }
  `),t}function oK(t){return Math.max(10,20*t.computeRenderPixelSizeAtDist(Math.abs(4*t.relativeElevation)))}const Cae=Ke(),Dlt=Object.freeze(Object.defineProperty({__proto__:null,build:Llt,getRadius:oK},Symbol.toStringTag,{value:"Module"}));let jSe=class HSe extends kr{initializeProgram(e){return new Nr(e.rctx,HSe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};jSe.shader=new Dr(Dlt,()=>ie(()=>import("./SSAO.glsl-e5f50d64.js"),[],import.meta.url));let Nlt=class extends pi{constructor(){super(...arguments),this.projScale=1}},Flt=class extends Nlt{constructor(){super(...arguments),this.intensity=1}},Ult=class extends pi{},Vlt=class extends Ult{constructor(){super(...arguments),this.blurSize=Ke()}};const GR=2;let qSe=class{constructor(e,r,i,s){this._view=e,this._techniqueRepository=r,this._rctx=i,this._requestRender=s,this._quadVAO=null,this._passParameters=new Flt,this._drawParameters=new Vlt}dispose(){this.enabled=!1,this._quadVAO=et(this._quadVAO)}disposeOffscreenBuffers(){ao(this._ssaoFBO,e=>e.resize(0,0)),ao(this._blur0FBO,e=>e.resize(0,0)),ao(this._blur1FBO,e=>e.resize(0,0))}set enabled(e){e?this._enable():this._disable()}get enabled(){return v(this._enableTime)}get active(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}get colorTexture(){return v(this._blur1FBO)?this._blur1FBO.colorTexture:null}render(e,r,i,s){if(C(this._enableTime)||C(i)||C(s)||C(this._ssaoFBO)||C(this._blur0FBO)||C(this._blur1FBO))return;if(!this.active)return this._enableTime=r,void this._requestRender();this._enableTime===0&&(this._enableTime=r);const n=this._rctx,o=e.camera,a=this._view.qualitySettings.fadeDuration,l=a>0?Math.min(a,r-this._enableTime)/a:1;this._passParameters.normalTexture=s,this._passParameters.depthTexture=i,this._passParameters.projScale=1/o.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*klt/oK(o)**6*l;const c=o.fullViewport,h=c[2],p=c[3],f=h/GR,m=p/GR;this._ssaoFBO.resize(h,p),this._blur0FBO.resize(f,m),this._blur1FBO.resize(f,m),C(this._quadVAO)&&(this._quadVAO=Ia(this._rctx)),n.bindFramebuffer(this._ssaoFBO),n.setViewport(0,0,h,p),n.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),n.bindVAO(this._quadVAO);const y=Ko(this._quadVAO,"geometry");n.drawArrays($t.TRIANGLE_STRIP,0,y);const _=n.bindTechnique(this._blurTechnique,this._passParameters,e);n.setViewport(0,0,f,m),n.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,ar(this._drawParameters.blurSize,0,GR/p),_.bindDraw(this._drawParameters,e,this._passParameters),n.setViewport(0,0,f,m),n.drawArrays($t.TRIANGLE_STRIP,0,y),n.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,ar(this._drawParameters.blurSize,GR/h,0),_.bindDraw(this._drawParameters,e,this._passParameters),n.drawArrays($t.TRIANGLE_STRIP,0,y),n.setViewport(c[0],c[1],c[2],c[3]),l<1&&this._requestRender()}_enable(){if(v(this._enableTime))return;const e={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:0,height:0},r={colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE};this._ssaoFBO=new Ns(this._rctx,r,e),this._blur0FBO=new Ns(this._rctx,r,e),this._blur1FBO=new Ns(this._rctx,r,e);const i=Uint8Array.from(atob(Ilt),s=>s.charCodeAt(0));this._passParameters.noiseTexture=new ct(this._rctx,{target:wt.TEXTURE_2D,pixelFormat:ze.RGB,dataType:Lt.UNSIGNED_BYTE,hasMipmap:!0,width:32,height:32},i),C(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(jSe)),C(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(zSe)),this._enableTime=0,this._requestRender()}_disable(){this._enableTime=null,this._passParameters.noiseTexture=et(this._passParameters.noiseTexture),this._blur1FBO=et(this._blur1FBO),this._blur0FBO=et(this._blur0FBO),this._ssaoFBO=et(this._ssaoFBO)}get gpuMemoryUsage(){return(v(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(v(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(v(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}};const klt=.5;let aK=class WSe extends kr{initializeProgram(e){return new Nr(e.rctx,WSe.shader.get().build(),Ar)}initializePipeline(){return this.configuration.hasAlpha?zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt}):zt({colorWrite:Qt})}};aK.shader=new Dr(pst,()=>ie(()=>import("./TextureOnly.glsl-5238d79c.js"),[],import.meta.url));let lK=class extends Pa{constructor(){super(...arguments),this.hasAlpha=!1}};u([k()],lK.prototype,"hasAlpha",void 0);let Fd=class extends Te{get _bindParameters(){return this._renderContext.bindParameters}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new Zr,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Kt,this._passParameters=new LJ,this._rctx=null,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this._camera=new At,this.worldToPCSRatio=1,this.events=new Fs,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext;const r=e.waterTextureRepository;this._stippleTextureRepository=new uSe(e.renderingContext),this._shaderTechniqueRepository=new sSe({rctx:this._rctx,viewingMode:Be.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:r}),this._renderContext=new ESe(this._rctx,new rK(this._rctx,this.view.state.viewingMode),new qSe(this.view,this._shaderTechniqueRepository,this._rctx,()=>{})),this._handles.add([ne(()=>r.updating,()=>this.events.emit("content-changed"),qs),ne(()=>this.spatialReference,i=>this._localOriginFactory=new tK(i),qs),an(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materialRepository=new nSe(e.textureRepository,this._shaderTechniqueRepository,i=>{(i.renderOccluded&v4)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=Se.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=Cwe(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=Tt.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new qZ($e(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(yt.STAGE,this))}destroy(){this._handles.destroy(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._debugTextureTechnique=ji(this._debugTextureTechnique),this._passParameters.texture=et(this._passParameters.texture),this._bindParameters.highlightDepthTexture=et(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Ve(this._shaderTechniqueRepository),this._temporaryFBO=et(this._temporaryFBO),this._quadVAO=et(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||Yo(this._renderers,e=>e.updating)}get hasOverlays(){return v(this._overlays)&&v(this._overlayRenderTarget)}get gpuMemoryUsage(){return v(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,uu)}createDrapeSourceRenderer(e,r,i){const s=this._renderers.get(e);v(s)&&s.destroy();const n=new r({...i,rendererContext:this,drapeSource:e});return this._renderers.set(e,n),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(ne(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),n}removeDrapeSourceRenderer(e){if(C(e))return;const r=this._renderers.get(e);C(r)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),r.destroy())}collectUnusedRenderTargetMemory(e){let r=!1;if(v(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const[s,n]=this.overlays,o=s.validTargets[i.type]||!n.validTargets[i.type];r=this._overlayRenderTarget.validateUsageForTarget(o,i,e)||r}return r}get overlays(){return It(this._overlays,[])}ensureDrapeTargets(e){v(this._overlays)&&this._overlays.forEach(r=>r.hasTargetWithoutRasterImage=wL(e,i=>i.drapeTargetType===XH.WithoutRasterImage))}ensureDrapeSources(e){v(this._overlays)&&this._overlays.forEach(r=>{r.hasDrapedFeatureSource=wL(e,i=>i.drapeSourceType===BO.Features),r.hasDrapedRasterSource=wL(e,i=>i.drapeSourceType===BO.RasterImage)})}ensureOverlays(e,r){C(this._overlays)&&(this._overlayRenderTarget=new lat(this._rctx),this._overlays=[new Joe(es.INNER,this._overlayRenderTarget),new Joe(es.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=et(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,r){let i=!1;for(const[s,n]of this._renderers){if(e.done)break;(s.destroyed||r(s))&&n.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers()),i&&(v(this._overlays)&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ja,e=>e.updatePolicy===X_.SYNC)}get isEmpty(){return!Wr.OVERLAY_DRAW_DEBUG_TEXTURE&&!Yo(this._renderers,e=>!e.isEmpty)}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let r=!1;return this._renderers.forEach(i=>r=i.updateAnimation(e)||r),r}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,r,i){const s=e.canvasGeometries;if(s.numViews===0)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const n=r.output;if(this.isEmpty||n===V.Highlight&&!this.hasHighlights||n===V.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const o=r.fbo;if(!o.isValid())return!1;const a=2*e.resolution,l=e.resolution;o.resize(a,l);const c=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*i,this._renderContext.output=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===V.Normal?Se.DRAPED_WATER:Se.DRAPED_MATERIAL,e.applyViewport(this._rctx),o.bind(c),e.index===es.INNER&&(c.setClearColor(0,0,0,0),c.clearSafe(Fi.COLOR_BUFFER_BIT)),r.type===ms.Occluded&&(this._renderContext.renderOccludedMask=v4),Wr.OVERLAY_DRAW_DEBUG_TEXTURE&&r.type!==ms.Occluded)for(let h=0;h<s.numViews;h++)this._setViewParameters(s.extents[h],e),this._drawDebugTexture(e.resolution,Blt[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll(({drapeSource:h,renderer:p})=>{if(r.type===ms.ColorNoRasterImage&&h.drapeSourceType===BO.RasterImage)return;const{fullOpacity:f}=h,m=v(f)&&f<1&&n===V.Color;m&&(this.bindTemporaryFramebuffer(this._rctx,a,l),c.clearSafe(Fi.COLOR_BUFFER_BIT));for(let y=0;y<s.numViews;y++)this._setViewParameters(s.extents[y],e),p.render(this._renderContext);m&&v(this._temporaryFBO)&&(o.bind(c),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),f,e.index))}),c.bindFramebuffer(null),o.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,r,i){C(this._temporaryFBO)&&(this._temporaryFBO=new iSe(e,!1)),this._temporaryFBO.resize(r,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,r,i,s){var o;let n=0;for(const a of this._renderers.values())n=((o=a.intersect)==null?void 0:o.call(a,e,r,i,s,n))??n}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),n=s>=0,o=this._renderers.size*(i.renderGroup??(n?f4.MapLayer:f4.ViewLayer))+(n?s:0);this._sortedRenderers.push(new zlt(i,r,o))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(e,r){const i=this._camera;i.viewport=[0,0,r.resolution,r.resolution],Ofe(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),i5(i.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=Yo(this._renderers,r=>r.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=Yo(this._renderers,r=>r.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=Yo(this._renderers,r=>r.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,r){this._ensureDebugPatternResources(e,e,r);const i=this._rctx;i.bindTechnique(this._debugTextureTechnique,this._passParameters,null),i.bindVAO(this._quadVAO),i.drawArrays($t.TRIANGLE_STRIP,0,Ko(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,r,i){if(ce(this._passParameters.color,i[0],i[1],i[2]),this._passParameters.texture)return;const s=new Uint8Array(e*r*4);let n=0;for(let a=0;a<r;a++)for(let l=0;l<e;l++){const c=Math.floor(l/10),h=Math.floor(a/10);c<2||h<2||10*c>e-20||10*h>r-20?(s[n++]=255,s[n++]=255,s[n++]=255,s[n++]=255):(s[n++]=255,s[n++]=255,s[n++]=255,s[n++]=1&c&&1&h?1&l^1&a?0:255:1&c^1&h?0:128)}this._passParameters.texture=new ct(this._rctx,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:e,height:r},s);const o=new lK;o.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(aK,o),this._quadVAO=Ia(this._rctx)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};u([d()],Fd.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([d({autoDestroy:!0})],Fd.prototype,"_shaderTechniqueRepository",void 0),u([d({autoDestroy:!0})],Fd.prototype,"_stippleTextureRepository",void 0),u([d({constructOnly:!0})],Fd.prototype,"view",void 0),u([d()],Fd.prototype,"worldToPCSRatio",void 0),u([d()],Fd.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],Fd.prototype,"updating",null),u([d()],Fd.prototype,"isEmpty",null),Fd=u([P("esri.views.3d.terrain.OverlayRenderer")],Fd);let zlt=class{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}};const Blt=[[1,.5,.5],[.5,.5,1]],cK=-2,v4=as.OccludeAndTransparent;function uK(t,e,r,i){const s=uP(t.rings,!!t.hasZ,_m.CCW_IS_HOLE),n=Bc(s.position.length),o=R2e(s.position,t.spatialReference,0,n,0,s.position,0,s.position.length/3,e,r,i),a=o!=null;return new Hlt(s.position,n,ZSe(s.polygons,s.position,n),YSe(s.outlines,s.position,n),a,o)}function XSe(t,e){const r=uP(t.rings,!1,_m.CCW_IS_HOLE),i=vs(r.position,t.spatialReference,0,r.position,e,0,r.position.length/3);for(let s=2;s<r.position.length;s+=3)r.position[s]=cK;return{position:r.position,polygons:ZSe(r.polygons,r.position),outlines:YSe(r.outlines,r.position),projectionSuccess:i}}function YSe(t,e,r=null){return t.filter(({count:i})=>i>1).map(({index:i,count:s})=>{const n=3*i,o=3*s;return v(r)?new JSe(i,s,zh(e,n,o),zh(r,n,o)):new hK(i,s,zh(e,n,o))})}function ZSe(t,e,r=null){const i=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of t){if(n<=1)continue;const l=3*s,c=3*n,h=o.map(f=>f-s),p=v(r)?new Glt(s,n,zh(e,3*s,3*n),zh(r,l,c),h,a):new jlt(s,n,zh(e,3*s,3*n),h,a);i.push(p)}return i}let hK=class{constructor(e,r,i){this.index=e,this.count=r,this.position=i}},JSe=class extends hK{constructor(e,r,i,s){super(e,r,i),this.mapPositions=s}},Glt=class extends JSe{constructor(e,r,i,s,n,o){super(e,r,i,s),this.holeIndices=n,this.pathLengths=o}},jlt=class extends hK{constructor(e,r,i,s,n){super(e,r,i),this.holeIndices=s,this.pathLengths=n}},Hlt=class{constructor(e,r,i,s,n,o){this.position=e,this.mapPositions=r,this.polygons=i,this.outlines=s,this.projectionSuccess=n,this.sampledElevation=o}};function KSe(t,e){const r=t.fragment;switch(r.code.add(w`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),e.doubleSidedMode){case hs.None:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case hs.View:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case hs.WindingOrder:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:e.doubleSidedMode;case hs.COUNT:}}var hs;(function(t){t[t.None=0]="None",t[t.View=1]="View",t[t.WindingOrder=2]="WindingOrder",t[t.COUNT=3]="COUNT"})(hs||(hs={}));function QSe(t){t.vertex.code.add(w`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}let qlt=class extends Pa{constructor(){super(...arguments),this.instancedDoublePrecision=!1}};function eEe(t,e){e.instanced&&e.instancedDoublePrecision&&(t.attributes.add(A.MODELORIGINHI,"vec3"),t.attributes.add(A.MODELORIGINLO,"vec3"),t.attributes.add(A.MODEL,"mat3"),t.attributes.add(A.MODELNORMAL,"mat3"));const r=t.vertex;e.instancedDoublePrecision&&(r.include(ZF,e),r.uniforms.add(new Lu("viewOriginHi",(i,s)=>bQe(ce(y$,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),y$))),r.uniforms.add(new Lu("viewOriginLo",(i,s)=>wQe(ce(y$,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),y$)))),r.code.add(w`
    vec3 calculateVPos() {
      ${e.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `),r.code.add(w`
    vec3 subtractOrigin(vec3 _pos) {
      ${e.instancedDoublePrecision?w`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),r.code.add(w`
    vec3 dpNormal(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `),e.output===V.Normal&&(OE(r),r.code.add(w`
    vec3 dpNormalView(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `)),e.hasVertexTangents&&r.code.add(w`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${e.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `)}u([k()],qlt.prototype,"instancedDoublePrecision",void 0);const y$=M();var wn;function Wlt(t){switch(t){case"multiply":default:return wn.Multiply;case"ignore":return wn.Ignore;case"replace":return wn.Replace;case"tint":return wn.Tint}}function tEe(t,e,r){if(C(t)||e===wn.Ignore)return r[0]=255,r[1]=255,r[2]=255,void(r[3]=255);const i=ye(Math.round(t[3]*b4),0,b4),s=i===0||e===wn.Tint?0:e===wn.Replace?Xlt:Ylt;r[0]=ye(Math.round(t[0]*Xx),0,Xx),r[1]=ye(Math.round(t[1]*Xx),0,Xx),r[2]=ye(Math.round(t[2]*Xx),0,Xx),r[3]=i+s}(function(t){t[t.Multiply=1]="Multiply",t[t.Ignore=2]="Ignore",t[t.Replace=3]="Replace",t[t.Tint=4]="Tint"})(wn||(wn={}));const Xx=255,b4=85,Xlt=b4,Ylt=2*b4;function rEe(t){t.vertex.code.add(w`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${w.int(wn.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${w.int(wn.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${w.int(wn.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${w.int(wn.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function iEe(t,e){e.hasSymbolColors?(t.include(rEe),t.attributes.add(A.SYMBOLCOLOR,"vec4"),t.varyings.add("colorMixMode","mediump float"),t.vertex.code.add(w`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`)):(t.fragment.uniforms.add(new dP("colorMixMode",r=>FTe[r.colorMixMode])),t.vertex.code.add(w`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`))}function mx(t,e){e.hasVertexColors?(t.attributes.add(A.COLOR,"vec4"),t.varyings.add("vColor","vec4"),t.vertex.code.add(w`void forwardVertexColor() { vColor = color; }`),t.vertex.code.add(w`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):t.vertex.code.add(w`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function Zlt(t){t.fragment.code.add(w`
    #define discardOrAdjustAlpha(color) { if (color.a < ${w.float(Qo)}) { discard; } }
  `)}let dw=class extends ws{constructor(e,r){super(e,"float",di.Draw,(i,s,n)=>i.setUniform1f(e,r(s,n)))}};function pw(t,e){sEe(t,e,new Pe("textureAlphaCutoff",r=>r.textureAlphaCutoff))}function Jlt(t,e){sEe(t,e,new dw("textureAlphaCutoff",r=>r.textureAlphaCutoff))}function sEe(t,e,r){const i=t.fragment;switch(e.alphaDiscardMode!==ui.Mask&&e.alphaDiscardMode!==ui.MaskBlend||i.uniforms.add(r),e.alphaDiscardMode){case ui.Blend:return t.include(Zlt);case ui.Opaque:i.code.add(w`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case ui.Mask:i.code.add(w`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case ui.MaskBlend:t.fragment.code.add(w`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function nEe(t,e){const{vertex:r,fragment:i}=t,s=e.hasModelTransformation;s&&r.uniforms.add(new qi("model",o=>v(o.modelTransformation)?o.modelTransformation:Uu));const n=e.hasColorTexture&&e.alphaDiscardMode!==ui.Opaque;switch(e.output){case V.Depth:case V.Shadow:case V.ShadowHighlight:case V.ShadowExcludeHighlight:case V.ObjectAndLayerIdColor:Nc(r,e),t.include(Gl,e),t.include(tm,e),t.include(OS,e),t.include(py,e),t.include(Zs,e),t.include(A6,e),jw(t),t.varyings.add("depth","float"),n&&i.uniforms.add(new Pt("tex",o=>o.texture)),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPositionWithDepth(proj, view, ${s?"model,":""} vpos, nearFar, depth);
            forwardTextureCoordinates();
            forwardObjectAndLayerIdColor();
          }
        `),t.include(pw,e),i.code.add(w`
          void main(void) {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture2D(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}
            ${e.output===V.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:w`outputDepth(depth);`}
          }
        `);break;case V.Normal:Nc(r,e),t.include(Gl,e),t.include(hP,e),t.include(F6,e),t.include(tm,e),t.include(OS,e),n&&i.uniforms.add(new Pt("tex",o=>o.texture)),t.varyings.add("vPositionView","vec3"),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            vpos = subtractOrigin(vpos);
            ${e.normalType===si.Attribute?w`
            vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
            forwardTextureCoordinates();
          }
        `),t.include(Zs,e),t.include(pw,e),i.code.add(w`
          void main() {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture2D(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}

            ${e.normalType===si.ScreenDerivative?w`
                vec3 normal = screenDerivativeNormal(vPositionView);`:w`
                vec3 normal = normalize(vNormalWorld);
                if (gl_FrontFacing == false) normal = -normal;`}
            gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
          }
        `);break;case V.Highlight:Nc(r,e),t.include(Gl,e),t.include(tm,e),t.include(OS,e),n&&i.uniforms.add(new Pt("tex",o=>o.texture)),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
            forwardTextureCoordinates();
          }
        `),t.include(Zs,e),t.include(pw,e),t.include(Ry,e),i.code.add(w`
          void main() {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture2D(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}
            outputHighlight();
          }
        `)}}function oEe(t,e){const r=t.fragment;if(e.hasVertexTangents?(t.attributes.add(A.TANGENT,"vec4"),t.varyings.add("vTangent","vec4"),e.doubleSidedMode===hs.WindingOrder?r.code.add(w`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):r.code.add(w`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(t.extensions.add("GL_OES_standard_derivatives"),r.code.add(w`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),e.textureCoordinateType!==Xs.None){t.include(zZ,e);const i=e.supportsTextureAtlas?e.hasWebGL2Context?ei.None:ei.Size:ei.None;r.uniforms.add(e.pbrTextureBindType===di.Pass?fp("normalTexture",s=>s.textureNormal,i):q_("normalTexture",s=>s.textureNormal,i)),r.code.add(w`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${e.supportsTextureAtlas?w`vtc.size = ${kh(e,"normalTexture")};`:""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `)}}function pP(t,e){const r=t.fragment;e.receiveAmbientOcclusion?(r.uniforms.add(fp("ssaoTex",(i,s)=>s.ssaoHelper.colorTexture,e.hasWebGL2Context?ei.None:ei.InvSize)),r.constants.add("blurSizePixelsInverse","float",1/GR),r.code.add(w`
      float evaluateAmbientOcclusionInverse() {
        vec2 ssaoTextureSizeInverse = ${kh(e,"ssaoTex",!0)};
        return texture2D(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).a;
      }

      float evaluateAmbientOcclusion() {
        return 1.0 - evaluateAmbientOcclusionInverse();
      }
    `)):r.code.add(w`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)}function fP(t){t.constants.add("ambientBoostFactor","float",Gwe)}function gC(t){t.uniforms.add(new Pe("lightingGlobalFactor",(e,r)=>r.lighting.globalFactor))}function Yw(t,e){const r=t.fragment;switch(t.include(pP,e),e.pbrMode!==dt.Disabled&&t.include(sK,e),t.include(jZ,e),t.include(QM),r.code.add(w`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${e.pbrMode===dt.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),fP(r),gC(r),by(r),r.code.add(w`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${e.spherical?w`normalize(vPosWorld)`:w`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),Cm(r),r.code.add(w`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),e.pbrMode){case dt.Disabled:case dt.WaterOnIntegratedMesh:case dt.Water:t.include(qF,e),r.code.add(w`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case dt.Normal:case dt.Schematic:r.code.add(w`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),r.code.add(w`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),e.useFillLights?r.uniforms.add(new Yg("hasFillLights",(i,s)=>s.enableFillLights)):r.constants.add("hasFillLights","bool",!1),r.code.add(w`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),r.uniforms.add([new Pe("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Pe("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)]),r.code.add(w`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),r.code.add(w`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${e.pbrMode===dt.Schematic?w`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:w`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;case dt.Terrain:case dt.TerrainWithWater:t.include(qF,e),r.code.add(w`const float roughnessTerrain = 0.5;
const float specularityTerrain = 0.5;
const vec3 fresnelReflectionTerrain = vec3(0.04);
vec3 evaluateTerrainLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {
vec3 viewDirection = -vd;
vec3 h = normalize(viewDirection + mainLightDirection);
float NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);
float NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);
float NdotH = clamp(dot(n, h), 0.0, 1.0);
float NdotNG = clamp(dot(n, nup), -1.0, 1.0);
vec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));
float lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];
vec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;
vec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));
vec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;
vec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;
vec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;
vec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;
vec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;
vec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);
vec3 specularColor = f0 * dfg.x + f90 * dfg.y;
vec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;
vec3 outColorLinear = outDiffColor + specularComponent;
vec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));
return outColor;
}`);break;default:e.pbrMode;case dt.COUNT:}}function Hl(){const t=new Float32Array(9);return t[0]=1,t[4]=1,t[8]=1,t}function aEe(t){const e=new Float32Array(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function eN(t,e,r,i,s,n,o,a,l){const c=new Float32Array(9);return c[0]=t,c[1]=e,c[2]=r,c[3]=i,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function Klt(t,e){return new Float32Array(t,e,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:aEe,create:Hl,createView:Klt,fromValues:eN},Symbol.toStringTag,{value:"Module"}));function Qlt(t){t.vertex.uniforms.add(new Rm("colorTextureTransformMatrix",e=>v(e.colorTextureTransformMatrix)?e.colorTextureTransformMatrix:Hl())),t.varyings.add("colorUV","vec2"),t.vertex.code.add(w`void forwardColorUV(){
colorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function ect(t){t.vertex.uniforms.add(new Rm("normalTextureTransformMatrix",e=>v(e.normalTextureTransformMatrix)?e.normalTextureTransformMatrix:Hl())),t.varyings.add("normalUV","vec2"),t.vertex.code.add(w`void forwardNormalUV(){
normalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function tct(t){t.vertex.uniforms.add(new Rm("emissiveTextureTransformMatrix",e=>v(e.emissiveTextureTransformMatrix)?e.emissiveTextureTransformMatrix:Hl())),t.varyings.add("emissiveUV","vec2"),t.vertex.code.add(w`void forwardEmissiveUV(){
emissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function rct(t){t.vertex.uniforms.add(new Rm("occlusionTextureTransformMatrix",e=>v(e.occlusionTextureTransformMatrix)?e.occlusionTextureTransformMatrix:Hl())),t.varyings.add("occlusionUV","vec2"),t.vertex.code.add(w`void forwardOcclusionUV(){
occlusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function ict(t){t.vertex.uniforms.add(new Rm("metallicRoughnessTextureTransformMatrix",e=>v(e.metallicRoughnessTextureTransformMatrix)?e.metallicRoughnessTextureTransformMatrix:Hl())),t.varyings.add("metallicRoughnessUV","vec2"),t.vertex.code.add(w`void forwardMetallicRoughnessUV(){
metallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function Q3(t){t.include(Am),t.code.add(w`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${w.int(wn.Multiply)}) {
        return allMixed;
      }
      if (mode == ${w.int(wn.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${w.int(wn.Replace)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${w.int(wn.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${w.int(wn.Replace)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)}function sct(t){const e=new Lr,{vertex:r,fragment:i,varyings:s}=e;return Nc(r,t),e.include(eP),s.add("vpos","vec3"),e.include(OS,t),e.include(eEe,t),e.include(RTe,t),t.hasColorTextureTransform&&e.include(Qlt),t.output!==V.Color&&t.output!==V.Alpha||(t.hasNormalTextureTransform&&e.include(ect),t.hasEmissionTextureTransform&&e.include(tct),t.hasOcclusionTextureTransform&&e.include(rct),t.hasMetallicRoughnessTextureTransform&&e.include(ict),Cp(r,t),e.include(hP,t),e.include(Gl,t),t.normalType===si.Attribute&&t.offsetBackfaces&&e.include(QSe),e.include(oEe,t),e.include(F6,t),t.instancedColor&&e.attributes.add(A.INSTANCECOLOR,"vec4"),s.add("localvpos","vec3"),e.include(tm,t),e.include(cC,t),e.include(iEe,t),e.include(mx,t),r.uniforms.add(new fr("externalColor",n=>n.externalColor)),s.add("vcolorExt","vec4"),t.hasMultipassTerrain&&s.add("depth","float"),t.hasModelTransformation&&r.uniforms.add(new qi("model",n=>v(n.modelTransformation)?n.modelTransformation:Uu)),r.code.add(w`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${t.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${w.float(Qo)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        } else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${t.normalType===si.Attribute?w`vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${t.hasVertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, ${t.hasModelTransformation?"model,":""} vpos);
          ${t.normalType===si.Attribute&&t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
        ${t.hasColorTextureTransform?w`forwardColorUV();`:""}
        ${t.hasNormalTextureTransform?w`forwardNormalUV();`:""}
        ${t.hasEmissionTextureTransform?w`forwardEmissiveUV();`:""}
        ${t.hasOcclusionTextureTransform?w`forwardOcclusionUV();`:""}
        ${t.hasMetallicRoughnessTextureTransform?w`forwardMetallicRoughnessUV();`:""}
      }
    `)),t.output===V.Alpha&&(e.include(Zs,t),e.include(pw,t),e.include(zu,t),i.uniforms.add([new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Pt("tex",n=>n.texture)),i.include(Q3),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        ${t.hasVertexColors?w`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        gl_FragColor = vec4(opacity_);
      }
    `)),t.output===V.Color&&(e.include(Zs,t),e.include(Yw,t),e.include(pP,t),e.include(pw,t),e.include(t.instancedDoublePrecision?U6:Xw,t),e.include(zu,t),Cp(i,t),i.uniforms.add([r.uniforms.get("localOrigin"),new Wt("ambient",n=>n.ambient),new Wt("diffuse",n=>n.diffuse),new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Pt("tex",n=>n.texture)),e.include(GZ,t),e.include(sK,t),i.include(Q3),e.include(KSe,t),fP(i),gC(i),Cm(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${t.normalType===si.ScreenDerivative?w`
                vec3 normal = screenDerivativeNormal(localvpos);`:w`
                shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
        ${t.pbrMode===dt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        vec3 posWorld = vpos + localOrigin;

        float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
        float shadow = ${t.receiveShadows?"readShadowMap(vpos, linearDepth)":t.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        vec3 matColor = max(ambient, diffuse);
        ${t.hasVertexColors?w`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${t.hasNormalTexture?w`
                mat3 tangentSpace = ${t.hasVertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
                vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`:w`vec3 shadingNormal = normal;`}
        vec3 normalGround = ${t.spherical?w`normalize(posWorld);`:w`vec3(0.0, 0.0, 1.0);`}

        ${t.snowCover?w`
                float snow = smoothstep(0.5, 0.55, dot(normal, normalGround));
                albedo = mix(albedo, vec3(1), snow);
                shadingNormal = mix(shadingNormal, normal, snow);
                ssao = mix(ssao, 1.0, snow);`:""}

        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        ${t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?w`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                ${t.snowCover?w`
                        mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                        emission = mix(emission, vec3(0.0), snow);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:w`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.transparencyPassType===Tt.Color?w`gl_FragColor = premultiplyAlpha(gl_FragColor);`:""}
      }
    `)),e.include(nEe,t),e}const nct=Object.freeze(Object.defineProperty({__proto__:null,build:sct},Symbol.toStringTag,{value:"Module"}));let oct=class extends OSe{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=$e(0,1,.5),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=Ei.Back,this.emissiveFactor=$e(0,0,0),this.instancedDoublePrecision=!1,this.normalType=si.Attribute,this.receiveSSAO=!0,this.receiveShadows=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=$e(.2,.2,.2),this.diffuse=$e(.8,.8,.8),this.externalColor=qt(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=M(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvSizeValue=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.vvSymbolAnchor=[0,0,0],this.vvSymbolRotationMatrix=rs(),this.vvOpacityEnabled=!1,this.vvOpacityValues=[],this.vvOpacityOpacities=[],this.transparent=!1,this.writeDepth=!0,this.customDepthTest=kw.Less,this.textureAlphaMode=ui.Blend,this.textureAlphaCutoff=h4,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=as.Occlude}},act=class extends MSe{constructor(){super(...arguments),this.origin=M(),this.slicePlaneLocalOrigin=this.origin}},dK=class lEe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,r.textureCoordinateType=r.hasColorTexture||r.hasMetallicRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture?Xs.Default:Xs.None,r.objectAndLayerIdColorInstanced=r.instanced}initializeProgram(e){return this._initializeProgram(e,lEe.shader)}_initializeProgram(e,r){return new Nr(e.rctx,r.get().build(this.configuration),Ar)}_convertDepthTestFunction(e){return e===kw.Lequal?$i.LEQUAL:$i.LESS}_makePipeline(e,r){const i=this.configuration,s=e===Tt.NONE,n=e===Tt.FrontFace;return zt({blending:i.output!==V.Color&&i.output!==V.Alpha||!i.transparent?null:s?Du:Oy(e),culling:lct(i)?u6(i.cullFace):null,depthTest:{func:Iv(e,this._convertDepthTestFunction(i.customDepthTest))},depthWrite:(s||n)&&i.writeDepth?Yl:null,colorWrite:Qt,stencilWrite:i.hasOccludees?vm:null,stencilTest:i.hasOccludees?r?vv:$v:null,polygonOffset:s||n?null:I6(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};function lct(t){return t.cullFace!==Ei.None||!t.hasSlicePlane&&!t.transparent&&!t.doubleSidedMode}dK.shader=new Dr(nct,()=>ie(()=>import("./DefaultMaterial.glsl-1bb54c7e.js"),[],import.meta.url));let Zt=class extends io{constructor(){super(...arguments),this.output=V.Color,this.alphaDiscardMode=ui.Opaque,this.doubleSidedMode=hs.None,this.pbrMode=dt.Disabled,this.cullFace=Ei.None,this.transparencyPassType=Tt.NONE,this.normalType=si.Attribute,this.textureCoordinateType=Xs.None,this.customDepthTest=kw.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};u([k({count:V.COUNT})],Zt.prototype,"output",void 0),u([k({count:ui.COUNT})],Zt.prototype,"alphaDiscardMode",void 0),u([k({count:hs.COUNT})],Zt.prototype,"doubleSidedMode",void 0),u([k({count:dt.COUNT})],Zt.prototype,"pbrMode",void 0),u([k({count:Ei.COUNT})],Zt.prototype,"cullFace",void 0),u([k({count:Tt.COUNT})],Zt.prototype,"transparencyPassType",void 0),u([k({count:si.COUNT})],Zt.prototype,"normalType",void 0),u([k({count:Xs.COUNT})],Zt.prototype,"textureCoordinateType",void 0),u([k({count:kw.COUNT})],Zt.prototype,"customDepthTest",void 0),u([k()],Zt.prototype,"spherical",void 0),u([k()],Zt.prototype,"hasVertexColors",void 0),u([k()],Zt.prototype,"hasSymbolColors",void 0),u([k()],Zt.prototype,"hasVerticalOffset",void 0),u([k()],Zt.prototype,"hasSlicePlane",void 0),u([k()],Zt.prototype,"hasSliceHighlight",void 0),u([k()],Zt.prototype,"hasColorTexture",void 0),u([k()],Zt.prototype,"hasMetallicRoughnessTexture",void 0),u([k()],Zt.prototype,"hasEmissionTexture",void 0),u([k()],Zt.prototype,"hasOcclusionTexture",void 0),u([k()],Zt.prototype,"hasNormalTexture",void 0),u([k()],Zt.prototype,"hasScreenSizePerspective",void 0),u([k()],Zt.prototype,"hasVertexTangents",void 0),u([k()],Zt.prototype,"hasOccludees",void 0),u([k()],Zt.prototype,"hasMultipassTerrain",void 0),u([k()],Zt.prototype,"hasModelTransformation",void 0),u([k()],Zt.prototype,"offsetBackfaces",void 0),u([k()],Zt.prototype,"vvSize",void 0),u([k()],Zt.prototype,"vvColor",void 0),u([k()],Zt.prototype,"receiveShadows",void 0),u([k()],Zt.prototype,"receiveAmbientOcclusion",void 0),u([k()],Zt.prototype,"textureAlphaPremultiplied",void 0),u([k()],Zt.prototype,"instanced",void 0),u([k()],Zt.prototype,"instancedColor",void 0),u([k()],Zt.prototype,"objectAndLayerIdColorInstanced",void 0),u([k()],Zt.prototype,"instancedDoublePrecision",void 0),u([k()],Zt.prototype,"doublePrecisionRequiresObfuscation",void 0),u([k()],Zt.prototype,"writeDepth",void 0),u([k()],Zt.prototype,"transparent",void 0),u([k()],Zt.prototype,"enableOffset",void 0),u([k()],Zt.prototype,"cullAboveGround",void 0),u([k()],Zt.prototype,"snowCover",void 0),u([k()],Zt.prototype,"hasColorTextureTransform",void 0),u([k()],Zt.prototype,"hasEmissionTextureTransform",void 0),u([k()],Zt.prototype,"hasNormalTextureTransform",void 0),u([k()],Zt.prototype,"hasOcclusionTextureTransform",void 0),u([k()],Zt.prototype,"hasMetallicRoughnessTextureTransform",void 0),u([k({constValue:!0})],Zt.prototype,"hasVvInstancing",void 0),u([k({constValue:!1})],Zt.prototype,"useCustomDTRExponentForWater",void 0),u([k({constValue:!1})],Zt.prototype,"supportsTextureAtlas",void 0),u([k({constValue:!0})],Zt.prototype,"useFillLights",void 0);function cct(t){const e=new Lr,{vertex:r,fragment:i,varyings:s}=e;return Nc(r,t),e.include(eP),s.add("vpos","vec3"),e.include(OS,t),e.include(eEe,t),e.include(RTe,t),t.output!==V.Color&&t.output!==V.Alpha||(Cp(e.vertex,t),e.include(hP,t),e.include(Gl,t),t.offsetBackfaces&&e.include(QSe),t.instancedColor&&e.attributes.add(A.INSTANCECOLOR,"vec4"),s.add("vNormalWorld","vec3"),s.add("localvpos","vec3"),t.hasMultipassTerrain&&s.add("depth","float"),e.include(tm,t),e.include(cC,t),e.include(iEe,t),e.include(mx,t),r.uniforms.add(new fr("externalColor",n=>n.externalColor)),s.add("vcolorExt","vec4"),r.code.add(w`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${t.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${w.float(Qo)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          } else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${t.hasMultipassTerrain?w`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),t.output===V.Alpha&&(e.include(Zs,t),e.include(pw,t),e.include(zu,t),i.uniforms.add([new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Pt("tex",n=>n.texture)),i.include(Q3),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        ${t.hasVertexColors?w`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}

        gl_FragColor = vec4(opacity_);
      }
    `)),t.output===V.Color&&(e.include(Zs,t),e.include(Yw,t),e.include(pP,t),e.include(pw,t),e.include(t.instancedDoublePrecision?U6:Xw,t),e.include(zu,t),Cp(e.fragment,t),by(i),fP(i),gC(i),i.uniforms.add([r.uniforms.get("localOrigin"),r.uniforms.get("view"),new Wt("ambient",n=>n.ambient),new Wt("diffuse",n=>n.diffuse),new Pe("opacity",n=>n.opacity),new Pe("layerOpacity",n=>n.layerOpacity)]),t.hasColorTexture&&i.uniforms.add(new Pt("tex",n=>n.texture)),e.include(GZ,t),e.include(sK,t),i.include(Q3),e.extensions.add("GL_OES_standard_derivatives"),Cm(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture2D(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${t.pbrMode===dt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${t.hasVertexColors?w`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${t.snowCover?w`albedo = mix(albedo, vec3(1), 0.9);`:w``}
        ${w`
            vec3 shadingNormal = normalize(vNormalWorld);
            albedo *= 1.2;
            vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
            float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);
            float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
            float treeRadialFalloff = vColor.r;
            float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
            additionalLight += backLightFactor * mainLightIntensity;`}
        ${t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?t.spherical?w`vec3 normalGround = normalize(vpos + localOrigin);`:w`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:w``}
        ${t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?w`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                ${t.snowCover?w`
                        mrr = vec3(0.0, 1.0, 0.04);
                        emission = vec3(0.0);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:w`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.transparencyPassType===Tt.Color?w`gl_FragColor = premultiplyAlpha(gl_FragColor);`:w``}
      }
    `)),e.include(nEe,t),e}const uct=Object.freeze(Object.defineProperty({__proto__:null,build:cct},Symbol.toStringTag,{value:"Module"}));let cEe=class uEe extends dK{initializeConfiguration(e,r){super.initializeConfiguration(e,r),r.hasMetallicRoughnessTexture=!1,r.hasEmissionTexture=!1,r.hasOcclusionTexture=!1,r.hasNormalTexture=!1,r.hasModelTransformation=!1,r.normalType=si.Attribute,r.doubleSidedMode=hs.WindingOrder,r.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,uEe.shader)}};cEe.shader=new Dr(uct,()=>ie(()=>import("./RealisticTree.glsl-e8dbc4cd.js"),[],import.meta.url));let fy=class extends Pv{constructor(e){super(e,pct),this.supportsEdges=!0,this._configuration=new Zt,this._vertexBufferLayout=fct(this.parameters)}isVisibleForOutput(e){return e!==V.Shadow&&e!==V.ShadowExcludeHighlight&&e!==V.ShadowHighlight||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;const{instanced:r,hasVertexColors:i,hasSymbolColors:s,vvColorEnabled:n}=e,o=v(r)&&r.includes("color"),a=e.colorMixMode==="replace",l=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return i&&(o||n||s)?!!a||l:i?a?c:l:o||n||s?!!a||l:a?c:l}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=!!this.parameters.instanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.hasVerticalOffset=v(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=v(this.parameters.screenSizePerspective),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,v(this.parameters.customDepthTest)&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?Ei.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=v(this.parameters.modelTransformation),e!==V.Color&&e!==V.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=hs.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?hs.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?hs.WindingOrder:hs.None,this._configuration.instancedColor=v(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!r.ssaoHelper.active&&this.parameters.receiveSSAO,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?dt.Schematic:dt.Normal:dt.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<M6,this._configuration.snowCover=this.hasSnowCover(r),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return v(e.weather)&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,r,i,s,n,o){if(v(this.parameters.verticalOffset)){const a=i.camera;ce(aV,r[12],r[13],r[14]);let l=null;switch(i.viewingMode){case Be.Global:l=ve(Aae,aV);break;case Be.Local:l=le(Aae,yct)}let c=0;const h=ge(_ct,aV,a.eye),p=Me(h),f=ae(h,h,1/p);let m=null;this.parameters.screenSizePerspective&&(m=_e(l,f)),c+=DTe(a,p,this.parameters.verticalOffset,m??0,this.parameters.screenSizePerspective),ae(l,l,c),Oc(oV,l,i.transform.inverseRotation),s=ge(mct,s,oV),n=ge(gct,n,oV)}PTe(e,i,s,n,g7(i.verticalOffset),o)}requiresSlot(e,r){return r===V.Color||r===V.Alpha||r===V.Depth||r===V.Normal||r===V.Shadow||r===V.ShadowHighlight||r===V.ShadowExcludeHighlight||r===V.Highlight||r===V.ObjectAndLayerIdColor?e===(this.parameters.transparent?this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Se.OPAQUE_MATERIAL)||e===Se.DRAPED_MATERIAL:!1}createGLMaterial(e){return new hct(e)}createBufferWriter(){return new mC(this._vertexBufferLayout)}},hct=class extends BZ{constructor(e){super({...e,...e.material.parameters})}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==V.Color&&this._output!==V.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));const r=this._material.parameters;this.updateTexture(r.textureId);const i=e.camera.viewInverseTransposeMatrix;return ce(r.origin,i[3],i[7],i[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(r.treeRendering?cEe:dK,e)}},dct=class extends oct{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}};const pct=new dct;function fct(t){const e=is().vec3f(A.POSITION).vec3f(A.NORMAL),r=t.textureId||t.normalTextureId||t.metallicRoughnessTextureId||t.emissiveTextureId||t.occlusionTextureId;return t.hasVertexTangents&&e.vec4f(A.TANGENT),r&&e.vec2f(A.UV0),t.hasVertexColors&&e.vec4u8(A.COLOR),t.hasSymbolColors&&e.vec4u8(A.SYMBOLCOLOR),de("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(A.OBJECTANDLAYERIDCOLOR),e}const mct=M(),gct=M(),yct=$e(0,0,1),Aae=M(),oV=M(),aV=M(),_ct=M(),vct=["polygon","extent"];let bct=class extends Mm{constructor(e,r,i,s){super(e,r,i,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=$6(this._getSymbolSize());if(a)throw new j("graphics3dextrudesymbollayer:invalid-size",a)}const e=Js(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e),i=Ul(r),s=r[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:s,transparent:n,cullFace:n?Ei.None:Ei.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new fy(o),this._bottomMaterial=new fy({...o,cullFace:Ei.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,vct,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(r,new Ip);return this._createAs3DShape(r,e.renderingInfo,i,s,r.uid)}layerOpacityChanged(e,r){const i=Js(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(i),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();e.forEach(a=>{const l=r(a);v(l)&&l.layerOpacityChanged(o,this._context.isAsync)})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,gv)}slicePlaneEnabledChanged(e,r){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(i=>{const s=r(i);v(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getExtrusionSize(e){let r;return r=e.size&&this._drivenProperties.size?Qot(e.size,2)??0:this._getSymbolSize(),r/=this._context.renderCoordsHelper.unitInMeters,r}applyRendererDiff(e,r){return this._drivenPropertiesChanged(r)?Sn.Recreate_Symbol:Sn.Recreate_Graphics}async queryForSnapping(e,r,i,s){const n=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/ww(r),{objectId:o,target:a}=e,l=te(a);switch(l.z=(l.z??0)+n,e.type){case"edge":{const{start:c,end:h}=e,p=te(c),f=te(h);return p.z=(p.z??0)+n,f.z=(f.z??0)+n,[Xoe(o,l,1/0,p,f)]}case"vertex":return[Zot(o,l,1/0),Xoe(o,a,1/0,a,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,r,i,s,n){const o=Z3(e.geometry);if(C(o))return null;if(o.rings.length===0||!o.rings.some(K=>K.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=uK(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer");const l=kJ(o);if(C(l))return null;const c=new Array,h=Rn(),p=Ie(),f=M(),m=this._context.renderCoordsHelper.viewingMode===Be.Global;m||this._context.renderCoordsHelper.worldUpAtPosition(null,f),xp(o.spatialReference,[l.x,l.y,0],p,this._context.renderCoordsHelper.spatialReference);const y=Ie();Lo(y,p);const _=rs();cE(_,y);const{polygons:b,mapPositions:x,position:T}=a,S=T.length/3,E=new Float64Array(3*S*6),O=new Float64Array(3*S*6),R=new Float64Array(3*S*6),L=new Float64Array(1*S*6);let I=0;for(let K=0;K<b.length;++K){const re=b[K],ee=re.count;if(this._context.clippingExtent&&(Mi(h),Ou(h,re.mapPositions),!op(h,this._context.clippingExtent)))continue;const q=yv(re.mapPositions,re.holeIndices,3);if(q.length===0)continue;const $=3*ee*2+q.length,N=new Array($),F=new Array(q.length),H=6*ee,X=3*E.BYTES_PER_ELEMENT,J=new Ca(E.buffer,I*X,X,(I+H)*X),W=3*O.BYTES_PER_ELEMENT,ue=new Ca(O.buffer,I*W,W,(I+H)*W),pe=new Float64Array(R.buffer,3*I*R.BYTES_PER_ELEMENT,3*H),we=new Float64Array(L.buffer,1*I*L.BYTES_PER_ELEMENT,1*H),Ce=this._getExtrusionSize(r);wct(T,x,q,re,J.typedBuffer,pe,ue.typedBuffer,we,N,F,Ce,f,m),cP(J,J,y),_v(ue,ue,_),I+=6*ee;const je=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),De=new Cct(J.typedBuffer,pe,ue.typedBuffer,we);c.push(Rae(this._material,N,N.length-F.length,De,i,je)),c.push(Rae(this._bottomMaterial,F,0,De,i,je))}if(c.length===0)return null;const U=new Py({geometries:c,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});U.transformation=p;const z=B2e(this.symbolLayer,{opacity:this._getLayerOpacity()}),B=v(z)?{baseMaterial:this._material,edgeMaterials:[z],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,G=new Om(this,U,c,null,null,Sct,s,B);return G.alignedSampledElevation=a.sampledElevation,G.needsElevationUpdates=gv(s.mode),G}};function Rae(t,e,r,i,s,n){const o=new Array(e.length).fill(0),a=[[A.POSITION,new Ye(i.positions,3,!0)],[A.NORMAL,new Ye(i.normals,3,!0)],[A.COLOR,new Ye(s,4,!0)],[A.SIZE,new Ye(i.heights,1,!0)]],l=[[A.POSITION,e],[A.NORMAL,e],[A.COLOR,o]];return new ln(t,a,l,i.elevation,$s.Mesh,n,r)}function wct(t,e,r,i,s,n,o,a,l,c,h,p,f){const m=r.length/3;let y=0,_=2*i.count;xct(t,e,i.index,i.count,r,0,m,s,n,o,a,l,c,_,h,p,f);let b=2*i.count;_=0,Oae(s,n,a,o,y,i.pathLengths[0],i.count,b,l,_,h),b+=4*i.pathLengths[0],_+=2*i.pathLengths[0],y+=i.pathLengths[0];for(let x=1;x<i.pathLengths.length;++x)Oae(s,n,a,o,y,i.pathLengths[x],i.count,b,l,_,h),b+=4*i.pathLengths[x],_+=2*i.pathLengths[x],y+=i.pathLengths[x]}function xct(t,e,r,i,s,n,o,a,l,c,h,p,f,m,y,_,b){le(vl,_);const x=y>0?1:-1;let T=3*r,S=0,E=3*S,O=i,R=3*O;for(let U=0;U<i;++U)b&&(vl[0]=t[T+0],vl[1]=t[T+1],vl[2]=t[T+2],ve(vl,vl)),a[E+0]=t[T+0],a[E+1]=t[T+1],a[E+2]=t[T+2],l[E+0]=e[T+0],l[E+1]=e[T+1],l[E+2]=e[T+2],c[E+0]=-x*vl[0],c[E+1]=-x*vl[1],c[E+2]=-x*vl[2],h[S]=0,a[R+0]=t[T+0]+y*vl[0],a[R+1]=t[T+1]+y*vl[1],a[R+2]=t[T+2]+y*vl[2],l[R+0]=e[T+0],l[R+1]=e[T+1],l[R+2]=e[T+2],c[R+0]=x*vl[0],c[R+1]=x*vl[1],c[R+2]=x*vl[2],h[O]=y,E+=3,R+=3,T+=3,S+=1,O+=1;T=3*n,E=0,R=3*m;const L=y<0?Dae:Lae,I=y<0?Lae:Dae;for(let U=0;U<o;++U)f[E+0]=s[T+L[0]],f[E+1]=s[T+L[1]],f[E+2]=s[T+L[2]],p[R+0]=s[T+I[0]]+i,p[R+1]=s[T+I[1]]+i,p[R+2]=s[T+I[2]]+i,E+=3,R+=3,T+=3}function _$(t,e,r,i,s,n,o){i[n]=i[o],o*=3,t[(n*=3)+0]=t[o+0],t[n+1]=t[o+1],t[n+2]=t[o+2],e[n+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],r[n+0]=s[0],r[n+1]=s[1],r[n+2]=s[2]}const sA=M();function Oae(t,e,r,i,s,n,o,a,l,c,h){let p=s,f=s+1,m=s+o,y=s+o+1,_=a,b=a+1,x=a+2*n,T=a+2*n+1;h<0&&(p=s+o+1,y=s),c*=3;for(let S=0;S<n;++S)S===n-1&&(h>0?(f=s,y=s+o):(f=s,p=s+o)),Tct(t,p,f,m,sA),_$(t,e,i,r,sA,_,p),_$(t,e,i,r,sA,b,f),_$(t,e,i,r,sA,x,m),_$(t,e,i,r,sA,T,y),l[c++]=_,l[c++]=x,l[c++]=T,l[c++]=_,l[c++]=T,l[c++]=b,p++,f++,m++,y++,_+=2,b+=2,x+=2,T+=2}const lV=M(),Mae=M(),Pae=M(),Iae=M(),$ae=M();function Tct(t,e,r,i,s){e*=3,r*=3,i*=3,ce(lV,t[e++],t[e++],t[e++]),ce(Mae,t[r++],t[r++],t[r++]),ce(Pae,t[i++],t[i++],t[i++]),ge(Iae,Mae,lV),ge($ae,Pae,lV),pt(s,$ae,Iae),ve(s,s)}const Yx=M();function Sct(t,e,r,i,s){const n=t.stageObject,o=n.geometries,a=o.length,l=e.mode!=="absolute-height";let c=0;const h=n.transformation,p=BE(Ie(),h);for(let f=0;f<a;f+=2){const m=o[f];if(!BJ(m))continue;const y=m.getMutableAttribute(A.POSITION).data,_=m.vertexAttributes.get(A.SIZE).data,b=new a0e(m.mapPositions),x=y.length/3;let T=0,S=!1,E=0;for(let O=0;O<x;O++){Yx[0]=y[T],Yx[1]=y[T+1],Yx[2]=y[T+2],i(b,v$),l&&(E+=v$.sampledElevation),Wr.TESTS_DISABLE_OPTIMIZATIONS?(ce(Ql,b.array[b.offset+0],b.array[b.offset+1],v$.z+_[T/3]),v(r)&&s.toRenderCoords(Ql,r,Ql),Xe(Ql,Ql,p)):(ce(Ql,y[T+0],y[T+1],y[T+2]),Xe(Ql,Ql,h),s.setAltitude(Ql,v$.z+_[T/3]),Xe(Ql,Ql,p)),y[T]=Ql[0],y[T+1]=Ql[1],y[T+2]=Ql[2];const R=Ect/s.unitInMeters;(Math.abs(Yx[0]-y[T])>=R||Math.abs(Yx[1]-y[T+1])>=R||Math.abs(Yx[2]-y[T+2])>=R)&&(S=!0),b.offset+=3,T+=3}S&&(m.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(o[f]),o[f+1].invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(o[f+1])),c+=E/x}return c/a}const Ql=M(),vl=M(),v$=new lP,Lae=[0,2,1],Dae=[0,1,2],Ect=.01;let Cct=class{constructor(e,r,i,s){this.positions=e,this.elevation=r,this.normals=i,this.heights=s}};function Act(t,e,r,i,s){if(C(t))return null;const n=t.referencesGeometry()&&s?Rct(e,i,s):e,o=t.repurposeFeature(n);try{return t.evaluate({...r,$feature:o})}catch(a){return se.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const cV=new Map;function Rct(t,e,r){const{transform:i,hasZ:s,hasM:n}=r;cV.has(e)||cV.set(e,Oct(e));const o=cV.get(e)(t.geometry,i,s,n);return{...t,geometry:o}}function Oct(t){const e={};switch(t){case"esriGeometryPoint":return(r,i,s,n)=>y2e(i,e,r,s,n);case"esriGeometryPolygon":return(r,i,s,n)=>_2e(i,e,r,s,n);case"esriGeometryPolyline":return(r,i,s,n)=>v2e(i,e,r,s,n);case"esriGeometryMultipoint":return(r,i,s,n)=>g2e(i,e,r,s,n);default:return se.getLogger("esri.views.2d.support.arcadeOnDemand").error(new j("mapview-arcade",`Unable to handle geometryType: ${t}`)),r=>r}}const TLt=1.2,Mct=Kf;let k6=class{constructor(e,r,i,s){this.graphics3DSymbolLayer=e,this.renderGeometries=r,this.boundingBox=i,this._drapeSourceRenderer=s,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,os.ADD);if(e||this._addedToStage){for(const r of this.renderGeometries)r.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Ln.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,os.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=M()){return ce(e,0,0,0)}getBoundingBoxObjectSpace(e=Rn()){return Mi(e)}addObjectState(e,r){e===uy.Highlight&&(this.renderGeometries.forEach(i=>{const s=i.geometry.addHighlight();r.addRenderGeometry(i,s,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Ln.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach(r=>{e.removeRenderGeometry(r)})}removeRenderGeometryObjectState(e,r){e.geometry.removeHighlight(r),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Ln.HIGHLIGHT)}computeAttachmentOrigin(e){for(const r of this.renderGeometries)r.geometry.computeAttachmentOrigin(Zx)&&(e.draped.origin[0]+=Zx[0],e.draped.origin[1]+=Zx[1],e.draped.num++)}async getProjectedBoundingBox(e,r,i,s,n){Mi(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,e,Nae,i),$4e(n,Nae)}if(r){let o;np(n,Zx);const a=zJ(n,r.service.spatialReference,r);try{o=await r.service.queryElevation(Zx[0],Zx[1],s,a,"ground")}catch{}v(o)&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(e,r,i,s){if(this.boundingBox)g5(jp,this.boundingBox);else{const n=e.boundingSphere,o=n[3];jp[0]=n[0]-o,jp[1]=n[1]-o,jp[2]=n[2]-o,jp[3]=n[0]+o,jp[4]=n[1]+o,jp[5]=n[2]+o}return r(jp,0,2),this.calculateRelativeScreenBounds&&s.push({location:np(jp),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),BX(jp,i)}};const Nae=hr(),jp=Rn(),Zx=M();let hEe=class{constructor(e,r,i,s=2048){this.text=e,this._alignment=r,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}get displayHeight(){const e=this._lineSpacing*(this._lines.length-1),r=this._lineHeight;return Math.ceil(e+r+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}get _firstLineYOffset(){return this._backgroundTopPadding+this._haloSize}get _metrics(){if(C(this._metricsCached)){const e=eq(Fae,b$,b$).getContext("2d");this._setFontProperties(e,this._fontSize);let r=2*this._haloSize;const i=this._parameters.definition.font;i.style!=="italic"&&i.style!=="oblique"&&i.weight!=="bold"&&i.weight!=="bolder"||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s,n,o=0,a=0,l=0;this._lines.forEach((y,_)=>{const b=e.measureText(y),x=b.width,T=x+r;this._textWidths.push(x),this._lineWidths.push(T),o=Math.max(o,T),a=Math.max(a,b.actualBoundingBoxAscent),l=Math.max(l,b.actualBoundingBoxDescent),_===0&&(s=b),_===this._lines.length-1&&(n=b)});const c=e.font;let h=Vae.get(c);if(!h){const y=e.measureText(Ict);h=new Lct(y.actualBoundingBoxAscent,y.actualBoundingBoxDescent),Vae.set(c,h)}a=Math.max(a,h.actualBoundingBoxAscent),l=Math.max(l,h.actualBoundingBoxDescent);const p=a+l,f=this._hasBackground?s.actualBoundingBoxAscent:a,m=this._hasBackground?n.actualBoundingBoxDescent:l;this._metricsCached=new $ct(a-f,l-m,p,o,a)}return this._metricsCached}get _lineSpacing(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _lineHeight(){return this._metrics.lineHeight}get _linePadding(){return this._lineHeight*Pct}get _baselinePosition(){return this._metrics.baselinePosition}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _backgroundHorizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _backgroundVerticalPadding(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}get _backgroundTopPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}get _backgroundBottomPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(C(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=e}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case Y_.Left:return this._backgroundHorizontalPadding;case Y_.Center:return(this.displayWidth-this._lineWidths[e])/2;case Y_.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}}render(e,r=0,i=0){e.save();const s=r/=this.renderPixelRatio,n=i/=this.renderPixelRatio,o=this._haloSize,a=this._firstLineYOffset;r+=o,i+=a+this._baselinePosition;const l=this._haloSize>0;l&&this._renderHalo(e,s,n,o,a),this._setFontProperties(e,this._renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],p=this._getLineXOffset(c);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,h,r+p,i),this._renderLineDecoration(e,r+p,i,this._textWidths[c])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,h,r+this._getLineXOffset(c),i),this._renderLineDecoration(e,r+p,i,this._textWidths[c]),i+=this._lineSpacing}if(Wr.TEXT_SHOW_BASELINE){e.strokeStyle=Uae,e.setLineDash([2,2]),e.lineWidth=1;let c=n+a;for(let h=0;h<this._lines.length;++h){const p=c+this._baselinePosition;this._drawLine(e,[s,p],[s+this.displayWidth,p]),c+=this._lineSpacing}}if(Wr.TEXT_SHOW_BORDER&&(e.strokeStyle=Uae,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,n,c),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,r,i,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,a=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*a;break;case"line-through":i-=.33*this._baselinePosition}const l=n?this._haloSize:0;e.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(a+2*l),e.beginPath(),e.moveTo(this._toRenderUnit(r-l),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(r+s+l),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,r,i,s){r=this._toRenderUnit(r),i=this._toRenderUnit(i);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=ye(s,0,Math.floor(o/2)),e.beginPath(),e.moveTo(r,i+s),e.arcTo(r,i,r+s,i,s),e.lineTo(r+n-s,i),e.arcTo(r+n,i,r+n,i+s,s),e.lineTo(r+n,i+o-s),e.arcTo(r+n,i+o,r+n-s,i+o,s),e.lineTo(r+s,i+o),e.arcTo(r,i+o,r,i+o-s,s),e.closePath()):e.rect(r,i,n,o)}_renderHalo(e,r,i,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=eq(Fae,Math.max(o,b$),Math.max(a,b$)),c=l.getContext("2d");c.clearRect(0,0,o,a),this._setFontProperties(c,this._renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this._renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,n):this._renderHaloNative(c,s,n);let p=n+this._baselinePosition;for(let f=0;f<this._lines.length;++f){const m=this._getLineXOffset(f);this._renderLineDecoration(c,s+m,p,this._textWidths[f],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,o,a,this._toRenderUnit(r),this._toRenderUnit(i),o,a),e.globalAlpha=1}_renderHaloEmulated(e,r,i){i+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[a,l]of dEe)this._fillText(e,n,r+o+this._haloSize*a,i+this._haloSize*l);i+=this._lineSpacing}}_renderHaloNative(e,r,i){const s=2*this._haloSize;i+=this._baselinePosition;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this._getLineXOffset(n),l=5,c=.1;for(let h=0;h<l;h++){const p=1-(l-1)*c+h*c;e.lineWidth=this._toRenderUnit(p*s),this._strokeText(e,o,r+a,i)}i+=this._lineSpacing}}_setFontProperties(e,r){e.font=this._parameters.fontString(r),e.textAlign="left",e.textBaseline="alphabetic"}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,r,i,s){e.fillText(r,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(e,r,i,s){e.strokeText(r,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(e,r,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,r,i){const s=this._toRenderUnit(r[0]),n=this._toRenderUnit(r[1]),o=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(n)+.5,p=Math.ceil(n+a)-.5;e.beginPath(),e.moveTo(l,h),e.lineTo(c,h),e.lineTo(c,p),e.lineTo(l,p),e.lineTo(l,h),e.stroke()}};const dEe=[];for(let e=0;e<360;e+=360/16)dEe.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var Y_;function eq(t,e,r){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=r,t.canvas}(function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"})(Y_||(Y_={}));const Fae={canvas:null},Pct=.2,b$=512,Uae="rgb(255, 0, 255, 0.5)",Ict=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();let $ct=class{constructor(e,r,i,s,n){this.paddingTop=e,this.paddingBottom=r,this.lineHeight=i,this.displayWidth=s,this.baselinePosition=n}},Lct=class{constructor(e,r){this.actualBoundingBoxAscent=e,this.actualBoundingBoxDescent=r}};const Vae=new Map,Dct=Object.freeze({left:0,center:.5,right:1}),tN=Object.freeze({"bottom-left":Fr(0,0),bottom:Fr(.5,0),"bottom-right":Fr(1,0),left:Fr(0,.5),center:Fr(.5,.5),right:Fr(1,.5),"top-left":Fr(0,1),top:Fr(.5,1),"top-right":Fr(1,1)});function pEe(t){switch(t){case"left":return Y_.Left;case"right":return Y_.Right;default:return Y_.Center}}function kae(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function Nct(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function Fct(t,e){switch(e){case"bottom":return t==="left"?"bottom-left":t==="right"?"bottom-right":"bottom";case"center":return t;case"top":return t==="left"?"top-left":t==="right"?"top-right":"top"}}function Uct(t){return t==="middle"?"center":t}var ma,zae;function nA(t){return t!=null}function Jx(t){return typeof t=="number"}function z6(t){return typeof t=="string"}function Vct(t){return t==null||z6(t)}function xn(t,e){t&&t.push(e)}function kct(t,e,r,i=Ie()){const s=t||0,n=e||0,o=r||0;return s!==0&&KS(i,i,-s/180*Math.PI),n!==0&&JS(i,i,n/180*Math.PI),o!==0&&r5(i,i,o/180*Math.PI),i}function s0(t,e,r,i,s){const n=t.minSize,o=t.maxSize;if(t.expression)return xn(s,"Could not convert size info: expression not supported"),!1;if(t.useSymbolValue){const a=i.symbolSize[r];return e.minSize[r]=a,e.maxSize[r]=a,e.offset[r]=e.minSize[r],e.factor[r]=0,e.type[r]=ma.DefinedSize,!0}if(nA(t.field))return nA(t.stops)?t.stops.length===2&&Jx(t.stops[0].size)&&Jx(t.stops[1].size)?(Bae(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,r),e.type[r]=ma.DefinedSize,!0):(xn(s,"Could not convert size info: stops only supported with 2 elements"),!1):Jx(n)&&Jx(o)&&nA(t.minDataValue)&&nA(t.maxDataValue)?(Bae(n,o,t.minDataValue,t.maxDataValue,e,r),e.type[r]=ma.DefinedSize,!0):iE[t.valueUnit]!=null?(e.minSize[r]=-1/0,e.maxSize[r]=1/0,e.offset[r]=0,e.factor[r]=1/iE[t.valueUnit],e.type[r]=ma.DefinedSize,!0):t.valueUnit==="unknown"?(xn(s,"Could not convert size info: proportional size not supported"),!1):(xn(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!nA(t.field)){if(t.stops&&t.stops[0]&&Jx(t.stops[0].size))return e.minSize[r]=t.stops[0].size,e.maxSize[r]=t.stops[0].size,e.offset[r]=e.minSize[r],e.factor[r]=0,e.type[r]=ma.DefinedSize,!0;if(Jx(n))return e.minSize[r]=n,e.maxSize[r]=n,e.offset[r]=n,e.factor[r]=0,e.type[r]=ma.DefinedSize,!0}return xn(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Bae(t,e,r,i,s,n){const o=Math.abs(i-r)>0?(e-t)/(i-r):0;s.minSize[n]=o>0?t:e,s.maxSize[n]=o>0?e:t,s.offset[n]=t-r*o,s.factor[n]=o}function zct(t,e,r,i){if(t.normalizationField||t.valueRepresentation)return xn(i,"Could not convert size info: unsupported property"),null;if(!Vct(t.field))return xn(i,"Could not convert size info: field is not a string"),null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return xn(i,"Could not convert size info: multiple fields in use"),null}else e.size.field=t.field}else e.size={field:t.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[ma.Undefined,ma.Undefined,ma.Undefined]};let s;switch(t.axis){case"width":return s=s0(t,e.size,0,r,i),s?e:null;case"height":return s=s0(t,e.size,2,r,i),s?e:null;case"depth":return s=s0(t,e.size,1,r,i),s?e:null;case"width-and-depth":return s=s0(t,e.size,0,r,i),s&&s0(t,e.size,1,r,i),s?e:null;case null:case void 0:case"all":return s=s0(t,e.size,0,r,i),s=s&&s0(t,e.size,1,r,i),s=s&&s0(t,e.size,2,r,i),s?e:null;default:return xn(i,`Could not convert size info: unknown axis "${t.axis}""`),null}}function Bct(t,e,r){for(let s=0;s<3;++s){let n=e.unitInMeters;t.type[s]===ma.DefinedSize&&(n*=e.modelSize[s],t.type[s]=ma.DefinedScale),t.minSize[s]=t.minSize[s]/n,t.maxSize[s]=t.maxSize[s]/n,t.offset[s]=t.offset[s]/n,t.factor[s]=t.factor[s]/n}let i;if(t.type[0]!==ma.Undefined)i=0;else if(t.type[1]!==ma.Undefined)i=1;else{if(t.type[2]===ma.Undefined)return xn(r,"No size axis contains a valid size or scale"),!1;i=2}for(let s=0;s<3;++s)t.type[s]===ma.Undefined&&(t.minSize[s]=t.minSize[i],t.maxSize[s]=t.maxSize[i],t.offset[s]=t.offset[i],t.factor[s]=t.factor[i],t.type[s]=t.type[i]);return!0}function Gae(t,e,r){t[4*e+0]=r.r/255,t[4*e+1]=r.g/255,t[4*e+2]=r.b/255,t[4*e+3]=r.a}function Gct(t,e,r){if(t.normalizationField)return xn(r,"Could not convert color info: unsupported property"),null;if(z6(t.field)){if(!t.stops)return xn(r,"Could not convert color info: missing stops or colors"),null;{if(t.stops.length>8)return xn(r,"Could not convert color info: too many color stops"),null;e.color={field:t.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const i=t.stops;for(let s=0;s<8;++s){const n=i[Math.min(s,i.length-1)];e.color.values[s]=n.value,Gae(e.color.colors,s,n.color)}}}else{if(!(t.stops&&t.stops.length>=0))return xn(r,"Could not convert color info: no field and no colors/stops"),null;{const i=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.color.values[s]=1/0,Gae(e.color.colors,s,i)}}return e}function jct(t,e,r){if(t.normalizationField)return xn(r,"Could not convert opacity info: unsupported property"),null;if(z6(t.field)){if(!t.stops)return xn(r,"Could not convert opacity info: missing stops or opacities"),null;{if(t.stops.length>8)return xn(r,"Could not convert opacity info: too many opacity stops"),null;e.opacity={field:t.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const i=t.stops;for(let s=0;s<8;++s){const n=i[Math.min(s,i.length-1)];e.opacity.values[s]=n.value,e.opacity.opacityValues[s]=n.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return xn(r,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=t.stops&&t.stops.length>=0?t.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.opacity.values[s]=1/0,e.opacity.opacityValues[s]=i}}return e}function uV(t,e,r){const i=r===2&&t.rotationType==="arithmetic";e.offset[r]=i?90:0,e.factor[r]=i?-1:1,e.type[r]=1}function Hct(t,e,r){if(!z6(t.field))return xn(r,"Could not convert rotation info: field is not a string"),null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return xn(r,"Could not convert rotation info: multiple fields in use"),null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return uV(t,e.rotation,0),e;case"roll":return uV(t,e.rotation,1),e;case null:case void 0:case"heading":return uV(t,e.rotation,2),e;default:return xn(r,`Could not convert rotation info: unknown axis "${t.axis}""`),null}}function fEe(t,e,r){if(!t)return null;const i=!e.supportedTypes||!!e.supportedTypes.size,s=!e.supportedTypes||!!e.supportedTypes.color,n=!e.supportedTypes||!!e.supportedTypes.rotation,o=!!e.supportedTypes&&!!e.supportedTypes.opacity,a=t.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return xn(r,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return i?zct(c,l,e,r):l;case"color":return s?Gct(c,l,r):l;case"opacity":return o?jct(c,l,r):null;case"rotation":return n?Hct(c,l,r):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(t.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!Bct(a.size,e,r)?null:a:null}function pK(t){return t&&t.size!=null}function eM(t,e){if(!t)return{enabled:!1};if(Wr.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const r=fEe(t.visualVariables,e);return r?{enabled:!0,visualVariables:r,materialParameters:mEe(r,e),requiresShaderTransformation:pK(r)}:{enabled:!1}}function tM(t,e,r){if(!e||!t.enabled)return!1;const i=t.visualVariables,s=fEe(e.visualVariables,r);return!!s&&!!(w$(i.size,s.size,"size")&&w$(i.color,s.color,"color")&&w$(i.rotation,s.rotation,"rotation")&&w$(i.opacity,s.opacity,"opacity"))&&(t.visualVariables=s,t.materialParameters=mEe(s,r),t.requiresShaderTransformation=pK(s),!0)}function w$(t,e,r){if(!!t!=!!e||t&&t.field!==e.field)return!1;if(t&&r==="rotation"){const i=t,s=e;for(let n=0;n<3;n++)if(i.type[n]!==s.type[n]||i.offset[n]!==s.offset[n]||i.factor[n]!==s.factor[n])return!1}return!0}function mEe(t,e){const r={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},i=pK(t);return t&&t.size?(r.vvSizeEnabled=!0,r.vvSizeMinSize=t.size.minSize,r.vvSizeMaxSize=t.size.maxSize,r.vvSizeOffset=t.size.offset,r.vvSizeFactor=t.size.factor):t&&i&&(r.vvSizeValue=e.transformation.scale),t&&i&&(r.vvSymbolAnchor=e.transformation.anchor,r.vvSymbolRotationMatrix=rs(),Wh(HO),kct(e.transformation.rotation[2],e.transformation.rotation[0],e.transformation.rotation[1],HO),Jh(r.vvSymbolRotationMatrix,HO)),t&&t.color&&(r.vvColorEnabled=!0,r.vvColorValues=t.color.values,r.vvColorColors=t.color.colors),t&&t.opacity&&(r.vvOpacityEnabled=!0,r.vvOpacityValues=t.opacity.values,r.vvOpacityOpacities=t.opacity.opacityValues),r}function tq(t,e,r){if(!t.vvSizeEnabled)return r;kn(n0,r);const i=t.vvSymbolRotationMatrix;Tm(HO,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),ys(n0,n0,HO);for(let s=0;s<3;++s){const n=t.vvSizeOffset[s]+e[0]*t.vvSizeFactor[s];jae[s]=ye(n,t.vvSizeMinSize[s],t.vvSizeMaxSize[s])}return t5(n0,n0,jae),ql(n0,n0,t.vvSymbolAnchor),n0}function qct(t,e,r){if(!e.vvSizeEnabled)return ce(t,1,1,1);for(let i=0;i<3;++i){const s=e.vvSizeOffset[i]+r[0]*e.vvSizeFactor[i];t[i]=ye(s,e.vvSizeMinSize[i],e.vvSizeMaxSize[i])}return t}(function(t){t[t.Undefined=0]="Undefined",t[t.DefinedSize=1]="DefinedSize",t[t.DefinedScale=2]="DefinedScale"})(ma||(ma={})),function(t){t[t.Undefined=0]="Undefined",t[t.DefinedAngle=1]="DefinedAngle"}(zae||(zae={}));const n0=Ie(),jae=M(),HO=Ie();let LE=class{constructor(e,r={}){this.geometry=e,this.boundingSphere=nr(),this.screenToWorldRatio=1,this._transformation=Ie(),this._shaderTransformationDirty=!0,this.id=$c(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.boundingInfo=r.boundingInfo,this.shaderTransformer=r.shaderTransformer,this.castShadow=!!r.castShadow&&r.castShadow}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,r,i=Mw(e)){C(this.boundingInfo)||(Xe(r,this.boundingInfo.center,e),r[3]=this.boundingInfo.radius*i)}get hasShaderTransformation(){return v(this.shaderTransformer)}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return C(this.shaderTransformer)?this.transformation:(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Ie()),kn(this._shaderTransformation,this.shaderTransformer(this.transformation)),this._shaderTransformationDirty=!1),this._shaderTransformation)}get indices(){return this.geometry.indices}get vertexAttributes(){return this.geometry.vertexAttributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};const Wct=Ie(),Hae=$e(0,0,1),Xct=16,Yct=1.5,Jb=NJ,Zct=[Jb/2,Jb/2,1-Jb/2,1-Jb/2],Jct=[q3*Jb,q3*Jb];let rq=class gEe extends Mm{getCachedSize(){return{size:this._getIconSize()}}constructor(e,r,i,s){super(e,r,i,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const r=this._prepareMaterialParameters(),i=this._getPrimitive();if(v(i))this._prepareResourcesPrimitive(r,i);else{const s=yBe(this.symbolLayer),n=_M(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(r,JSON.parse(n.data),e):await this._prepareResourcesHref(r,s,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=$6(this._getIconSize());if(e)throw new j("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,r=Math.round(e.size!=null?$o(e.size):Xct);return this._drivenProperties.size?Math.max(r,64):r}_generateTextureCIM(e){const r=this._getGraphicHash(e);let i=r===""?null:this._cimSymbolTextures.get(r);if(!i){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,e,"esriGeometryPoint",s,void 0,void 0);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:H_.PAD};i=new fx(n.imageData,o),this._cimSymbolTextures.set(r,i),this._context.stage.add(i)}return i}_computeSize(e,r){const i=e.width/e.height;return i>1?[r,Math.round(r/i)]:[Math.round(r*i),r]}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},r=this.symbol;if(Kct(r)){const{screenLength:i,minWorldLength:s,maxWorldLength:n}=r.verticalOffset;e.verticalOffset={screenLength:$o(i),minWorldLength:s||0,maxWorldLength:v(n)?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,r){const i=this._getOutlineSize();if(hV(r)&&i===0)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,v(this._context.sharedResources.textures)){const n=this._context.sharedResources.textures.fromData(`${r}-icon`,()=>XTe(r));this._texture=n.texture,this._releaseTexture=n,e.textureId=this._texture.id}e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Zct;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/Jb,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,r,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(v(this._context.sharedResources.textures)){const o=await Uc(this._context.sharedResources.textures.fromUrl(r,n,{signal:i}));if(o.ok===!1)throw Sc(o.error),new j("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${r})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.params;this._size=this._computeSize(l,s),e.textureId=a.id}this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,r,i){const s=new WE({data:r});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await ie(()=>import("./CIMSymbolRasterizer-a75a2575.js"),["./CIMSymbolRasterizer-a75a2575.js","./cimAnalyzer-21c2b891.js","./BidiEngine-836b7ef6.js","./TileClipper-ae6eca9e.js","./enums-c655c737.js","./number-b10bd8f5.js","./_commonjsHelpers-2f3e7994.js","./imageutils-d9259484.js","./rasterizingUtils-5811f1b0.js"],import.meta.url)).CIMSymbolRasterizer;ur(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:i}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await hFe(p,this._context.layer.spatialReference,n);a=(m,y,_)=>{const b=Act(f,m,{$view:_},"esriGeometryPoint",y);return b!==null?b:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];ur(i);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||Z4e}_getOutlineSize(){let e=0;const r=this.symbolLayer;return v(r.outline)&&r.outline.size!=null?Math.max($o(r.outline.size),0):(e=hV(this._getPrimitive())?Yct:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),r=this.symbolLayer,i=Js(r,"outline","color");if(v(i)){const s=Ze.toUnitRGB(i),n=i.a*e;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(hV(this._getPrimitive()))return Mct;const e=C(this._getPrimitive()),r=Js(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(r,{hasIntrinsicColor:e})}_getAnchorPos(e,r){return e==="relative"?Fr((r.x||0)+.5,.5-(r.y||0)):e in tN?tN[e]:tN.center}_createMaterialAndAddToStage(e,r){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=eM(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let i=v(e.textureId)?this._cimSymbolMaterials.get(e.textureId):null;return i||(i=new PE(e),this._cimSymbolMaterials.set(It(e.textureId,0),i),r.add(i)),i}return this._material=new PE(e),r.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._releaseTexture=ji(this._releaseTexture)}_getScaleFactor(e,r){if(this._drivenProperties.size&&e.size){for(let i=0;i<3;i++){const s=e.size[i];s&&s!=="symbol-value"&&s!=="proportional"&&(e.size[i]=$o(s))}if(e.size[0]==="symbol-value")return 1;if(isFinite(+e.size[0]))return+e.size[0]/r;if(isFinite(+e.size[2]))return+e.size[2]/r}return 1}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry))return null;let i,s=[0,0];if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(r),f={textureId:p.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(f,this._context.stage),s=[p.params.width,p.params.height]}else s=this._size,i=this._material;const n=Y3(r.geometry);if(C(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const o=e.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const p=s[0]>s[1]?s[0]:s[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=Fr(s[0]*l,s[1]*l),h=this.setGraphicElevationContext(r,new Ip);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(r,n,i,a,c,e.layer.uid):this._createAs3DShape(r,n,i,a,c,h,r.uid)}layerOpacityChanged(){const e=this._getFillColor(),r=this._getOutlineColor();this._forEachMaterial(i=>{i.setParameters({color:e}),i.setParameters({outlineColor:r})})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=aP(gEe.elevationModeChangeTypes,i,s);if(n!==_s.UPDATE)return n;const o=td(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!tM(this._fastUpdates,r,this._fastVisualVariableConvertOptions()))return Sn.Recreate_Symbol;v(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return Sn.Fast_Update}_defaultElevationInfoNoZ(){return Qct}_createAs3DShape(e,r,i,s,n,o,a){const l=this.getFastUpdateAttrValues(e),c=l?_=>tq(this._fastUpdates.materialParameters,l,_):void 0,h=this._context.layer.uid,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:h}),f=CH(i,Hae,null,s,n,eut,null,l,p),m=XJ(this._context,r,f,o,a,c);if(C(m))return null;const y=new Om(this,m.object,[f],null,null,W3,o);return y.alignedSampledElevation=m.sampledElevation,y.needsElevationUpdates=td(o.mode)||o.mode==="absolute-height",y.getScreenSize=this._createScreenSizeGetter(n,c),y.calculateRelativeScreenBounds=_=>i.calculateRelativeScreenBounds(y.getScreenSize(),1,_),X3(y,r,this._context.elevationProvider),y}_createAsOverlay(e,r,i,s,n,o){i.renderPriority=this._renderPriority;const a=nr();ta(r,a,this._context.overlaySR),a[2]=cK;const l=this._context.clippingExtent;if(v(l)&&!zX(l,a))return null;const c=this.getFastUpdateAttrValues(e),h=c?_=>tq(this._fastUpdates.materialParameters,c,_):void 0,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),f=CH(i,Hae,a,s,n,null,null,c,p),m=new LE(f,{layerUid:o,graphicUid:e.uid,shaderTransformer:h});a[3]=0,rp(m.boundingSphere,a);const y=new k6(this,[m],null,this._context.drapeSourceRenderer);return y.getScreenSize=this._createScreenSizeGetter(n,h),y.calculateRelativeScreenBounds=_=>i.calculateRelativeScreenBounds(y.getScreenSize(),1,_),y}_createScreenSizeGetter(e,r){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const s=e[0]/this._symbolTextureRatio,n=e[1]/this._symbolTextureRatio;return(o=Ke())=>{const a=r(Wct);return o[0]=a[0]*s+i,o[1]=a[5]*n+i,o}}{const s=e[0]/this._symbolTextureRatio+i,n=e[1]/this._symbolTextureRatio+i;return(o=Ke())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],r=$e(e,e,e),i=Yh(1),s=e*i;return{modelSize:r,symbolSize:$e(s,s,s),unitInMeters:i,transformation:{anchor:wa,scale:Gf,rotation:wa}}}_getGraphicHash(e){let r="";for(const i of this._cimRequiredFields)r+=i+e.attributes[i];return r}_forEachMaterial(e){v(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._material}}};function Kct(t){return t&&t.type==="point-3d"&&t.hasVisibleVerticalOffset()}function hV(t){return!C(t)&&(t==="cross"||t==="x")}rq.PRIMITIVE_SIZE=Jct,rq.elevationModeChangeTypes={definedChanged:_s.UPDATE,staysOnTheGround:_s.NONE,onTheGroundChanged:_s.RECREATE};const Qct={mode:"relative-to-ground",offset:0},eut=qt(0,0,0,1);function iq(t){switch(t){case"butt":return Gh.BUTT;case"square":return Gh.SQUARE;case"round":return Gh.ROUND;default:return null}}function tut(t){return t==="diamond"?"kite":t}function sq(t,e,r=null){const i=[],s=[],n=e.mapPositions;rut(e,s,i);const o=s[0][1].data,a=i[0][1].length,l=new Array(a).fill(0);return iut(e,s,i,l),out(e,s,i,l),sut(e,s,i,l),nut(e,s,i,l),aut(e,s,i,l),lut(e,s,i,l),cut(e,s,i,o),new ln(t,s,i,n,$s.Line,r)}function rut(t,e,r){const{attributeData:{position:i},removeDuplicateStartEnd:s}=t,n=uut(i)&&s,o=i.length/3-(n?1:0),a=new Array(2*(o-1)),l=n?i.slice(0,i.length-3):i;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;e.push([A.POSITION,new Ye(l,3,n)]),r.push([A.POSITION,a])}function iut(t,e,r,i){if(v(t.attributeData.colorFeature))return;const s=t.attributeData.color;e.push([A.COLOR,new Ye(It(s,Lh),4)]),r.push([A.COLOR,i])}function sut(t,e,r,i){if(!v(t.attributeData.normal))return;const s=t.attributeData.normal;e.push([A.NORMAL,new Ye(s,3)]),r.push([A.NORMAL,i])}function nut(t,e,r,i){const s=t.attributeData.colorFeature;C(s)||(e.push([A.COLORFEATUREATTRIBUTE,new Ye([s],1,!0)]),r.push([A.COLOR,i]))}function out(t,e,r,i){if(v(t.attributeData.sizeFeature))return;const s=t.attributeData.size;e.push([A.SIZE,new Ye([It(s,1)],1,!0)]),r.push([A.SIZE,i])}function aut(t,e,r,i){const s=t.attributeData.sizeFeature;C(s)||(e.push([A.SIZEFEATUREATTRIBUTE,new Ye([s],1,!0)]),r.push([A.SIZEFEATUREATTRIBUTE,i]))}function lut(t,e,r,i){const s=t.attributeData.opacityFeature;C(s)||(e.push([A.OPACITYFEATUREATTRIBUTE,new Ye([s],1,!0)]),r.push([A.OPACITYFEATUREATTRIBUTE,i]))}function cut(t,e,r,i){if(C(t.overlayInfo)||t.overlayInfo.renderCoordsHelper.viewingMode!==Be.Global||!t.overlayInfo.spatialReference.isGeographic)return;const s=Bc(i.length),n=Yr(t.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)vX(i,f,s,f,n);const o=i.length/3,a=Ys(o+1);let l=hut,c=dut,h=0,p=0;ce(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),ce(c,s[p++],s[p++],s[p++]),h+=owe(l,c),a[f]=h,[l,c]=[c,l];e.push([A.DISTANCETOSTART,new Ye(a,1,!0)]),r.push([A.DISTANCETOSTART,r[0][1]])}function uut(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const hut=M(),dut=M();function OLt(t,e){if(C(t)||t.length===0)return[];const r=[];return t.forEach(i=>{const s=i.length,n=Bc(3*s);i.forEach((a,l)=>{n[3*l+0]=a[0],n[3*l+1]=a[1],n[3*l+2]=a[2]});const o={attributeData:{position:n,normal:e},removeDuplicateStartEnd:!1};r.push(o)}),r}function put(t,e,r,i){const s=t.type==="polygon"?_m.CCW_IS_HOLE:_m.NONE,n=t.type==="polygon"?t.rings:t.paths,{position:o,outlines:a}=uP(n,!!t.hasZ,s),l=Bc(o.length),c=R2e(o,t.spatialReference,0,l,0,o,0,o.length/3,e,r,i),h=c!=null;return{lines:h?yEe(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function fut(t,e){const r=t.type==="polygon"?_m.CCW_IS_HOLE:_m.NONE,i=t.type==="polygon"?t.rings:t.paths,{position:s,outlines:n}=uP(i,!1,r),o=vs(s,t.spatialReference,0,s,e,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=cK;return{lines:o?yEe(n,s):[],projectionSuccess:o}}function yEe(t,e,r=null){const i=new Array;for(const{index:s,count:n}of t){if(n<=1)continue;const o=3*s,a=3*n;i.push({position:zh(e,3*s,3*n),mapPositions:v(r)?zh(r,o,a):void 0})}return i}function mut(t){const e=new Lr,r=t.hasMultipassTerrain&&(t.output===V.Color||t.output===V.Alpha),i=t.space===Bh.World;t.hasTip&&i&&e.extensions.add("GL_OES_standard_derivatives"),e.include(cSe,t),e.include(gSe,t),t.output===V.Depth&&e.include(py,t);const{vertex:s,fragment:n}=e;return n.include(jc),Nc(s,t),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.AUXPOS1,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vUV","vec2"),e.varyings.add("vSize","float"),hv(e),r&&e.varyings.add("depth","float"),t.hasTip&&e.varyings.add("vLineWidth","float"),s.uniforms.add([new Ur("nearFar",(o,a)=>a.camera.nearFar),new fr("viewport",(o,a)=>a.camera.fullViewport)]),s.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),s.code.add(w`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),i?(e.attributes.add(A.NORMAL,"vec3"),OE(s),s.constants.add("tiltThreshold","float",.7),s.code.add(w`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):s.code.add(w`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`),s.code.add(w`
      #define vecN ${i?"vec3":"vec2"}

      vecN normalizedSegment(vecN pos, vecN prev) {
        vecN segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${i?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      vecN displace(vecN pos, vecN prev, float displacementLen) {
        vecN segment = normalizedSegment(pos, prev);

        vecN displacementDirU = perpendicular(segment);
        vecN displacementDirV = segment;

        ${t.anchor===Ww.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),t.space===Bh.Screen&&(s.uniforms.add(new qi("inverseProjectionMatrix",(o,a)=>a.camera.inverseProjectionMatrix)),s.code.add(w`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),s.code.add(w`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),s.uniforms.add(new Pe("perScreenPixelRatio",(o,a)=>a.camera.perScreenPixelRatio)),s.code.add(w`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${t.hasCap?`
                if(prev.z > posLeft.z) {
                  vec2 diff = posLeft.xy - posRight.xy;
                  planeOrigin.xy += perpendicular(diff) / 2.0;
                }
              `:""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),s.uniforms.add(new Pe("pixelRatio",(o,a)=>a.camera.pixelRatio)),d6(e),s.code.add(w`void main(void) {
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
float lineWidth = getLineWidth();
float screenMarkerSize = getScreenMarkerSize();
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
clip(pos, prev);`),i?(t.hideOnShortSegments&&s.code.add(w`if (areWorldMarkersHidden(pos, prev)) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
return;
}`),s.code.add(w`pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
vec4 displacedPosScreen = projectAndScale(pos);`)):(s.code.add(w`vec4 posScreen = projectAndScale(pos);
vec4 prevScreen = projectAndScale(prev);
vec4 displacedPosScreen = posScreen;
displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);`),t.space===Bh.Screen&&s.code.add(w`vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));
vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);
pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`)),s.code.add(w`
        ${r?"depth = pos.z;":""}
        linearDepth = calculateLinearDepth(nearFar,pos.z);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        ${i?"":"vUV *= displacedPosScreen.w;"}

        ${t.hasTip?"vLineWidth = lineWidth;":""}

        vSize = screenMarkerSize;
        vColor = getColor();

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),r&&e.include(zu,t),e.include(Zs,t),n.uniforms.add([new fr("intrinsicColor",o=>o.color),new Pt("tex",o=>o.texture)]),n.include(Am),e.constants.add("texelSize","float",1/J3),n.code.add(w`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),t.hasTip&&(e.constants.add("relativeMarkerSize","float",QJ/J3),e.constants.add("relativeTipLineWidth","float",Mat),n.code.add(w`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${i?"halfTipLineWidth *= fwidth(samplePos.y);":""}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `)),e.constants.add("symbolAlphaCutoff","float",Qo),n.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${r?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    ${i?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;"}

    ${t.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);"}

    ${t.output===V.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < symbolAlphaCutoff) {
      discard;
    }

    ${t.output===V.Alpha?w`gl_FragColor = vec4(finalColor.a);`:""}
    ${t.output===V.Color?w`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===V.Color&&t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${t.output===V.Highlight?w`gl_FragColor = vec4(1.0);`:""}
    ${t.output===V.Depth?w`outputDepth(linearDepth);`:""}
  }
  `),e}const gut=Object.freeze(Object.defineProperty({__proto__:null,build:mut},Symbol.toStringTag,{value:"Module"})),_Ee=new Map([[A.POSITION,0],[A.UV0,2],[A.AUXPOS1,3],[A.NORMAL,4],[A.COLOR,5],[A.COLORFEATUREATTRIBUTE,5],[A.SIZE,6],[A.SIZEFEATUREATTRIBUTE,6],[A.OPACITYFEATUREATTRIBUTE,7]]);let vEe=class bEe extends kr{initializeProgram(e){return new Nr(e.rctx,bEe.shader.get().build(this.configuration),_Ee)}_makePipelineState(e,r){const i=this.configuration,s=e===Tt.NONE;return zt({blending:i.output===V.Color||i.output===V.Alpha?s?Du:Oy(e):null,depthTest:{func:Iv(e)},depthWrite:s?i.writeDepth?Yl:null:O6(e),colorWrite:Qt,stencilWrite:i.hasOccludees?vm:null,stencilTest:i.hasOccludees?r?vv:$v:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=zt({blending:Du,depthTest:y4,depthWrite:null,colorWrite:Qt,stencilWrite:null,stencilTest:vSe}),this._occluderPipelineOpaque=zt({blending:Du,depthTest:y4,depthWrite:null,colorWrite:Qt,stencilWrite:ySe,stencilTest:_Se}),this._occluderPipelineMaskWrite=zt({blending:null,depthTest:eK,depthWrite:null,colorWrite:null,stencilWrite:vm,stencilTest:vv})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:this.configuration.occluder?e===Se.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===Se.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,r)}};vEe.shader=new Dr(gut,()=>ie(()=>import("./LineMarker.glsl-f5d677e3.js"),[],import.meta.url));let yut=class extends Pv{constructor(e){super(e,new vut),this._vertexAttributeLocations=_Ee,this._configuration=new So,this._layout=this.createLayout()}dispose(){}getConfiguration(e,r){return this._configuration.output=e,this._configuration.space=r.slot===Se.DRAPED_MATERIAL?Bh.Draped:this.parameters.worldSpace?Bh.World:Bh.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==Gh.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.occluder=this.parameters.renderOccluded===as.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=is().vec3f(A.POSITION).vec2f(A.UV0).vec3f(A.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(A.NORMAL),this.parameters.vvSizeEnabled?e.f32(A.SIZEFEATUREATTRIBUTE):e.f32(A.SIZE),this.parameters.vvColorEnabled?e.f32(A.COLORFEATUREATTRIBUTE):e.vec4f(A.COLOR),this.parameters.vvOpacityEnabled&&e.f32(A.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new but(this._layout,this.parameters)}requiresSlot(e,r){return r===V.Color||r===V.Alpha||r===V.Highlight||r===V.Depth?e===Se.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===as.OccludeAndTransparentStencil?e===Se.OPAQUE_MATERIAL||e===Se.OCCLUDER_MATERIAL||e===Se.TRANSPARENT_OCCLUDER_MATERIAL:r===V.Color||r===V.Alpha?e===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===Se.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new _ut(e)}},_ut=class extends BZ{_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(vEe,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==V.Color&&this._output!==V.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},vut=class extends FJ{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=Gh.BUTT,this.anchor=Ww.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1}},but=class{constructor(e,r){this.vertexBufferLayout=e,this._parameters=r}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(){return this._parameters.placement==="begin-end"?12:6}write(e,r,i,s,n){const o=i.vertexAttributes.get(A.POSITION).data,a=o.length/3;let l=[1,0,0];const c=i.vertexAttributes.get(A.NORMAL);this._parameters.worldSpace&&v(c)&&(l=c.data);let h=1,p=0;this._parameters.vvSizeEnabled?p=i.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.SIZE)&&(h=i.vertexAttributes.get(A.SIZE).data[0]);let f=[1,1,1,1],m=0;this._parameters.vvColorEnabled?m=i.vertexAttributes.get(A.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.COLOR)&&(f=i.vertexAttributes.get(A.COLOR).data);let y=0;this._parameters.vvOpacityEnabled&&(y=i.vertexAttributes.get(A.OPACITYFEATUREATTRIBUTE).data[0]);const _=new Float32Array(s.buffer);let b=n*(this.vertexBufferLayout.stride/4);const x=(O,R,L,I)=>{if(_[b++]=O[0],_[b++]=O[1],_[b++]=O[2],_[b++]=L[0],_[b++]=L[1],_[b++]=R[0],_[b++]=R[1],_[b++]=R[2],this._parameters.worldSpace&&(_[b++]=l[0],_[b++]=l[1],_[b++]=l[2]),this._parameters.vvSizeEnabled?_[b++]=p:_[b++]=h,this._parameters.vvColorEnabled)_[b++]=m;else{const U=Math.min(4*I,f.length-4);_[b++]=f[U+0],_[b++]=f[U+1],_[b++]=f[U+2],_[b++]=f[U+3]}this._parameters.vvOpacityEnabled&&(_[b++]=y)};let T;(function(O){O[O.ASCENDING=1]="ASCENDING",O[O.DESCENDING=-1]="DESCENDING"})(T||(T={}));const S=(O,R)=>{const L=ce(wut,o[3*O],o[3*O+1],o[3*O+2]),I=xut;let U=O+R;do ce(I,o[3*U],o[3*U+1],o[3*U+2]),U+=R;while(Q_(L,I)&&U>=0&&U<a);e&&(Xe(L,L,e),Xe(I,I,e)),x(L,I,[-1,-1],O),x(L,I,[1,-1],O),x(L,I,[1,1],O),x(L,I,[-1,-1],O),x(L,I,[1,1],O),x(L,I,[-1,1],O)},E=this._parameters.placement;E!=="begin"&&E!=="begin-end"||S(0,T.ASCENDING),E!=="end"&&E!=="begin-end"||S(a-1,T.DESCENDING)}};const wut=M(),xut=M(),la={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Tut={dash:la.dash,"dash-dot":[...la.dash,...la.dot],dot:la.dot,"long-dash":la["long-dash"],"long-dash-dot":[...la["long-dash"],...la.dot],"long-dash-dot-dot":[...la["long-dash"],...la.dot,...la.dot],none:null,"short-dash":la["short-dash"],"short-dash-dot":[...la["short-dash"],...la["short-dot"]],"short-dash-dot-dot":[...la["short-dash"],...la["short-dot"],...la["short-dot"]],"short-dot":la["short-dot"],solid:null},Sut=8;function Eut(t,e=2){return C(t)?t:{pattern:t.slice(),pixelRatio:e}}function LLt(t,e=2){return{pattern:[t,t],pixelRatio:e}}function wEe(t){return v(t)&&t.type==="style"?Cut(t.style):null}function Cut(t){return v(t)?Eut(Tut[t],Sut):null}const Aut=["polyline","polygon","extent"];let xEe=class TEe extends Mm{constructor(e,r,i,s){super(e,r,i,s)}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=eM(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size&&(this.symbolLayer.size!=null?this.symbolLayer.size:Yh(1))<0)throw new j("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._markerTexture=v(this.symbolLayer.marker)&&v(this._context.sharedResources.textures)?Pat(this._context.sharedResources.textures,tut(this.symbolLayer.marker.style)):null}_getMaterialParameters(e,r=!1){var n;const i=this._getCombinedOpacityAndColor(r&&this._markerColor||this._materialColor);this._patternHidesLine&&!r&&(i[3]=0);const s={width:this._computeMaterialWidth((n=this.symbolLayer)==null?void 0:n.size),color:i,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:iq(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:wEe(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get _materialColor(){return ao(this.symbolLayer.material,e=>e.color)}get _markerColor(){return ao(this.symbolLayer.marker,e=>e.color)}get _lineMaterial(){return C(this._lineMaterialCached)&&(this._lineMaterialCached=new Q2(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}get _ringMaterial(){return C(this._ringMaterialCached)&&(this._ringMaterialCached=new Q2(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}get _wireframeLineMaterial(){return C(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new Q2({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}get _wireframeRingMaterial(){return C(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new Q2({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}get _markerMaterial(){return C(this._markerMaterialCached)&&v(this.symbolLayer.marker)&&v(this._markerTexture)&&(this._markerMaterialCached=new yut({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=ji(this._markerTexture)}_getDrivenSize(e){return this._drivenProperties.size&&e.size?$o(eat(e.size)):1}_getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Jg(this._fastUpdates.visualVariables.size.field,e):null}_getDrivenColor(e){const r=qt(1,1,1,1);return this._drivenProperties.color&&e.color&&(r[0]=e.color[0],r[1]=e.color[1],r[2]=e.color[2],e.color.length>0&&(r[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(r[3]=e.opacity),r}_getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Jg(this._fastUpdates.visualVariables.color.field,e):null}_getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Jg(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Aut,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Ip);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,r.uid)}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!tM(this._fastUpdates,r,this._vvConvertOptions))return Sn.Recreate_Symbol;this._forEachMaterial(s=>s.setParameters(this._fastUpdates.materialParameters))}return Sn.Fast_Update}prepareSymbolLayerPatch(e){var n,o;if(e.diff.type!=="partial")return;const r=e.diff.diff,i={};((n=r.size)==null?void 0:n.type)==="complete"&&(i.width=this._computeMaterialWidth(r.size.newValue),delete r.size),((o=r.cap)==null?void 0:o.type)==="complete"&&(i.cap=iq(It(r.cap.newValue,"butt")),delete r.cap);const s=this._prepareMarkerPatch(e,r);this._prepareMaterialPatch(e,r,s),e.symbolLayerStatePatches.push(()=>this._forEachMaterial(a=>a.setParameters(i)))}layerOpacityChanged(){this._forEachMaterial((e,r)=>this._updateMaterialLayerOpacity(e,r))}_forEachMaterial(e){v(this._lineMaterialCached)&&e(this._lineMaterialCached),v(this._ringMaterialCached)&&e(this._ringMaterialCached),v(this._wireframeLineMaterialCached)&&e(this._wireframeLineMaterialCached),v(this._wireframeRingMaterialCached)&&e(this._wireframeRingMaterialCached),v(this._markerMaterialCached)&&e(this._markerMaterialCached,!0)}_updateMaterialLayerOpacity(e,r=!1){const i=e.parameters.color,s=Js(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!r?0:this._getCombinedOpacity(s),o=qt(i[0],i[1],i[2],n);e.setParameters({color:o})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=aP(TEe.elevationModeChangeTypes,i,s);if(n!==_s.UPDATE)return n;const o=td(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(r=>r.setParameters(e)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof Hr)return bp.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,r,i){const s=e.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=Rn(),c=put(n,this._context.elevationProvider,this._context.renderCoordsHelper,r),h=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(c,o,h,"LineSymbol3DLayer");for(let m=0;m<c.lines.length;m++){const y=c.lines[m],_=y.position,b=y.mapPositions;if(v(this._context.clippingExtent)&&(Mi(l),Ou(l,b),!op(l,this._context.clippingExtent)))continue;const x=this._createGeometry(n.type==="polygon"?this._ringMaterial:this._lineMaterial,e,_,b,n.type,qO.ELEVATED,i);a.push(x),Wr.LINE_WIREFRAMES&&a.push(x.instantiate({material:n.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial})),v(this._markerMaterial)&&a.push(x.instantiate({material:this._markerMaterial}))}if(a.length===0)return null;const p=new Py({geometries:a,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),f=new Om(this,p,a,null,null,oot,r);return f.alignedSampledElevation=c.sampledElevation,f.needsElevationUpdates=td(r.mode),f}_createGeometry(e,r,i,s,n,o,a){const l=n==="polygon",c=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,h=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid});return sq(e,{overlayInfo:o===qO.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:l,mapPositions:s,attributeData:{position:i,size:h?null:this._getDrivenSize(r.renderingInfo),color:c?null:this._getDrivenColor(r.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(r.graphic),colorFeature:this._getColorFeatureAttributeData(r.graphic),opacityFeature:this._getOpacityFeatureAttributeData(r.graphic)}},p)}_createAsOverlay(e,r){const i=e.graphic,s=this._getGeometryAsPolygonOrPolyline(i.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this._ringMaterial:this._lineMaterial;o.renderPriority=this._renderPriority;const a=Wr.LINE_WIREFRAMES?s.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;v(a)&&(a.renderPriority=this._renderPriority-.001),v(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=Rn(),p=Mi(),f=fut(s,this._context.overlaySR),m=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(f,n,m,"LineSymbol3DLayer");for(const y of f.lines){if(Mi(h),Ou(h,y.position),!op(h,this._context.clippingExtent))continue;oE(p,h);const _=x=>{const T=this._createGeometry(x,e,y.position,void 0,s.type,qO.DRAPED,i.uid),S=new LE(T,{layerUid:r,graphicUid:i.uid});return c.push(S),S};if(v(l)){const x=_(l),T=this.symbolLayer.marker.placement;T!=="begin"&&T!=="begin-end"||Ou(h,y.position,0,1),T!=="end"&&T!=="begin-end"||Ou(h,y.position,y.position.length-3,1),this._updateBoundingSphere(x,h)}const b=_(o);if(this._updateBoundingSphere(b,h),Wr.LINE_WIREFRAMES){const x=_(a);this._updateBoundingSphere(x,h)}}return new k6(this,c,p,this._context.drapeSourceRenderer)}_updateBoundingSphere(e,r){ti(e.boundingSphere,.5*(r[0]+r[3]),.5*(r[1]+r[4]),0,.5*Math.sqrt((r[3]-r[0])*(r[3]-r[0])+(r[4]-r[1])*(r[4]-r[1])))}get _patternHidesLine(){const e=this.symbolLayer.pattern;return v(e)&&e.type==="style"&&e.style==="none"}_computeMaterialWidth(e){return e=It(e,Yh(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?$o(1):1:$o(e)}_prepareMaterialPatch(e,r,i){var a;const s=r.material;if(C(s))return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e));if(s.type==="collection")return;const n=s.type==="complete"?ao(s.newValue,l=>l.color):((a=s.diff.color)==null?void 0:a.type)==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);i.useMaterialColor&&this._patchMaterialColor(FM(o),this._markerMaterialCached,e),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterialCached,e),delete r.material}_prepareMarkerPatch(e,r){const i=r.marker;if(C(i)||i.type!=="partial"||v(i.diff.style)||v(i.diff.placement)||v(i.diff.color)&&i.diff.color.type!=="complete")return{changed:!1,useMaterialColor:C(this._markerColor)};const s=i.diff.color;if(C(s))return delete r.marker,{changed:!1,useMaterialColor:C(this._markerColor)};const n=s.newValue;return C(n)?(delete r.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterialCached,e),delete r.marker,{changed:!0,useMaterialColor:!1})}_patchMaterialColor(e,r,i){C(r)||i.symbolLayerStatePatches.push(()=>r.setParameters({color:e}))}};var qO;xEe.elevationModeChangeTypes={definedChanged:_s.RECREATE,staysOnTheGround:_s.NONE,onTheGroundChanged:_s.RECREATE},function(t){t[t.DRAPED=0]="DRAPED",t[t.ELEVATED=1]="ELEVATED"}(qO||(qO={}));let oA=null,w4=!0;function dV(t,e,r){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(w4)try{return new ImageData(t,e)}catch{w4=!1}return SEe(t,e,r)}function Rut(t,e,r,i){if(!e||!r)throw new Error("Cannot construct image data without dimensions");if(w4)try{return new ImageData(t,e,r)}catch{w4=!1}const s=SEe(e,r,i);return s.data.set(t,0),s}function Out(){return oA||(oA=document.createElement("canvas"),oA.width=1,oA.height=1),oA}function SEe(t,e,r){return r||(r=Out()),r.getContext("2d").createImageData(t,e)}var b2;const pV=new WeakMap;let Mut=0,bf=b2=class extends fe{constructor(t){super(t),this.wrap="repeat"}get url(){return this._get("url")||null}set url(t){this._set("url",t),t&&this._set("data",null)}get data(){return this._get("data")||null}set data(t){this._set("data",t),t&&this._set("url",null)}writeData(t,e,r,i){if(t instanceof HTMLImageElement){const s={type:"image-element",src:Rw(t.src,i),crossOrigin:t.crossOrigin};e[r]=s}else if(t instanceof HTMLCanvasElement){const s=t.getContext("2d").getImageData(0,0,t.width,t.height),n={type:"canvas-element",imageData:this._encodeImageData(s)};e[r]=n}else if(t instanceof HTMLVideoElement){const s={type:"video-element",src:Rw(t.src,i),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[r]=s}else if(t instanceof ImageData){const s={type:"image-data",imageData:this._encodeImageData(t)};e[r]=s}}readData(t){switch(t.type){case"image-element":{const e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e}case"canvas-element":{const e=this._decodeImageData(t.imageData),r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),r}case"image-data":return this._decodeImageData(t.imageData);case"video-element":{const e=document.createElement("video");return e.src=t.src,e.crossOrigin=t.crossOrigin,e.autoplay=t.autoplay,e.loop=t.loop,e.muted=t.muted,e.preload=t.preload,e}default:return}}get transparent(){const t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return this._imageDataContainsTransparent(t);if(e){const r=e.substr(e.length-4,4).toLowerCase(),i=e.substr(0,15).toLocaleLowerCase();if(r===".png"||i==="data:image/png;")return!0}return!1}set transparent(t){this._overrideIfSome("transparent",t)}get contentHash(){const t=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",e=(r="")=>`d:${r},t:${this.transparent},w:${t}`;return this.url!=null?e(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?e(this.data.src):(pV.has(this.data)||pV.set(this.data,++Mut),e(pV.get(this.data))):e()}clone(){const t={url:this.url,data:this.data,wrap:this._cloneWrap()};return new b2(t)}cloneWithDeduplication(t){const e=t.get(this);if(e)return e;const r=this.clone();return t.set(this,r),r}_cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(t){let e="";for(let r=0;r<t.data.length;r++)e+=String.fromCharCode(t.data[r]);return{data:btoa(e),width:t.width,height:t.height}}_decodeImageData(t){const e=atob(t.data),r=new Uint8ClampedArray(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return Rut(r,t.width,t.height)}_imageDataContainsTransparent(t){for(let e=3;e<t.data.length;e+=4)if(t.data[e]!==255)return!0;return!1}static from(t){return typeof t=="string"?new b2({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new b2({data:t}):zS(b2,t)}};u([d({type:String,json:{write:nv}})],bf.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],bf.prototype,"data",null),u([ke("data")],bf.prototype,"writeData",null),u([Le("data")],bf.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],bf.prototype,"transparent",null),u([d({json:{write:!0}})],bf.prototype,"wrap",void 0),u([d({readOnly:!0})],bf.prototype,"contentHash",null),bf=b2=u([P("esri.geometry.support.MeshTexture")],bf);const WO=bf;var nq;let Ud=nq=class extends fe{constructor(t){super(t),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const r=v(t)?t.get(this):null;if(r)return r;const i=new nq(this.clonePropertiesWithDeduplication(e));return v(t)&&t.set(this,i),i}clonePropertiesWithDeduplication(t){return{color:v(this.color)?this.color.clone():null,colorTexture:v(this.colorTexture)?this.colorTexture.cloneWithDeduplication(t):null,normalTexture:v(this.normalTexture)?this.normalTexture.cloneWithDeduplication(t):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided,colorTextureTransform:v(this.colorTextureTransform)?this.colorTextureTransform:null,normalTextureTransform:v(this.normalTextureTransform)?this.normalTextureTransform:null}}};u([d({type:Ze,json:{write:!0}})],Ud.prototype,"color",void 0),u([d({type:WO,json:{write:!0}})],Ud.prototype,"colorTexture",void 0),u([d({type:WO,json:{write:!0}})],Ud.prototype,"normalTexture",void 0),u([d({nonNullable:!0,json:{write:!0}})],Ud.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],Ud.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],Ud.prototype,"doubleSided",void 0),u([d()],Ud.prototype,"colorTextureTransform",void 0),u([d()],Ud.prototype,"normalTextureTransform",void 0),Ud=nq=u([P("esri.geometry.support.MeshMaterial")],Ud);const fK=Ud;var oq;let mh=oq=class extends fK{constructor(t){super(t),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const r=v(t)?t.get(this):null;if(r)return r;const i=new oq(this.clonePropertiesWithDeduplication(e));return v(t)&&t.set(this,i),i}clonePropertiesWithDeduplication(t){return{...super.clonePropertiesWithDeduplication(t),emissiveColor:v(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:v(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(t):null,occlusionTexture:v(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(t):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:v(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(t):null,occlusionTextureTransform:v(this.occlusionTextureTransform)?this.occlusionTextureTransform:null,emissiveTextureTransform:v(this.emissiveTextureTransform)?this.emissiveTextureTransform:null,metallicRoughnessTextureTransform:v(this.metallicRoughnessTextureTransform)?this.metallicRoughnessTextureTransform:null}}};u([d({type:Ze,json:{write:!0}})],mh.prototype,"emissiveColor",void 0),u([d({type:WO,json:{write:!0}})],mh.prototype,"emissiveTexture",void 0),u([d({type:WO,json:{write:!0}})],mh.prototype,"occlusionTexture",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],mh.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],mh.prototype,"roughness",void 0),u([d({type:WO,json:{write:!0}})],mh.prototype,"metallicRoughnessTexture",void 0),u([d()],mh.prototype,"occlusionTextureTransform",void 0),u([d()],mh.prototype,"emissiveTextureTransform",void 0),u([d()],mh.prototype,"metallicRoughnessTextureTransform",void 0),mh=oq=u([P("esri.geometry.support.MeshMaterialMetallicRoughness")],mh);const EEe=mh;var rN;const CEe="esri.geometry.support.MeshVertexAttributes",Kx=se.getLogger(CEe);let Zu=rN=class extends fe{constructor(t){super(t),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(t){return w2(t,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},Kx)}castPosition(t){return t&&t instanceof Float32Array&&Kx.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),w2(t,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},Kx)}castUv(t){return w2(t,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},Kx)}castNormal(t){return w2(t,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},Kx)}castTangent(t){return w2(t,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},Kx)}clone(){const t={position:te(this.position),uv:te(this.uv),normal:te(this.normal),tangent:te(this.tangent),color:te(this.color)};return new rN(t)}clonePositional(){const t={position:te(this.position),normal:te(this.normal),tangent:te(this.tangent),uv:this.uv,color:this.color};return new rN(t)}};function fV(t,e,r,i){const{loggerTag:s,stride:n}=e;return t.length%n!=0?(i.error(s,`Invalid array length, expected a multiple of ${n}`),new r([])):t}function w2(t,e,r,i,s){if(!t)return t;if(t instanceof e)return fV(t,i,e,s);for(const n of r)if(t instanceof n)return fV(new e(t),i,e,s);if(Array.isArray(t))return fV(new e(t),i,e,s);{const n=r.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${t.constructor.name}`),new e([])}}function aA(t,e,r){e[r]=Put(t)}function Put(t){const e=new Array(t.length);for(let r=0;r<t.length;r++)e[r]=t[r];return e}u([d({json:{write:aA}})],Zu.prototype,"color",void 0),u([Gt("color")],Zu.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:aA}})],Zu.prototype,"position",void 0),u([Gt("position")],Zu.prototype,"castPosition",null),u([d({json:{write:aA}})],Zu.prototype,"uv",void 0),u([Gt("uv")],Zu.prototype,"castUv",null),u([d({json:{write:aA}})],Zu.prototype,"normal",void 0),u([Gt("normal")],Zu.prototype,"castNormal",null),u([d({json:{write:aA}})],Zu.prototype,"tangent",void 0),u([Gt("tangent")],Zu.prototype,"castTangent",null),Zu=rN=u([P(CEe)],Zu);var jR;const AEe="esri.geometry.support.MeshComponent",Iut=se.getLogger(AEe);let bg=jR=class extends fe{static from(t){return zS(jR,t)}constructor(t){super(t),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}castFaces(t){return w2(t,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},Iut)}castMaterial(t){return zS(t&&typeof t=="object"&&("metallic"in t||"roughness"in t||"metallicRoughnessTexture"in t)?EEe:fK,t)}clone(){return new jR({faces:te(this.faces),shading:this.shading,material:te(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(t,e){const r={faces:te(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(t,e):null,trustSourceNormals:this.trustSourceNormals};return new jR(r)}};u([d({json:{write:!0}})],bg.prototype,"faces",void 0),u([Gt("faces")],bg.prototype,"castFaces",null),u([d({type:fK,json:{write:!0}})],bg.prototype,"material",void 0),u([Gt("material")],bg.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],bg.prototype,"shading",void 0),u([d({type:Boolean})],bg.prototype,"trustSourceNormals",void 0),bg=jR=u([P(AEe)],bg);const $ut=bg,B6=se.getLogger("esri.geometry.support.meshUtils.normalProjection");function Lut(t,e,r,i,s){return j6(i)?(G6(Kg.TO_PCPF,Ii.fromTypedArray(t),Ca.fromTypedArray(e),Ca.fromTypedArray(r),i,Ii.fromTypedArray(s)),s):(B6.error("Cannot convert spatial reference to PCPF"),s)}function DLt(t,e,r,i,s){return j6(i)?(G6(Kg.FROM_PCPF,Ii.fromTypedArray(t),Ca.fromTypedArray(e),Ca.fromTypedArray(r),i,Ii.fromTypedArray(s)),s):(B6.error("Cannot convert to spatial reference from PCPF"),s)}function NLt(t,e,r){return vs(t,e,0,r,U5(e),0,t.length/3),r}function FLt(t,e,r){return vs(t,U5(r),0,e,r,0,t.length/3),e}function Dut(t,e,r){if(C(t))return e;const i=Ca.fromTypedArray(t),s=Ca.fromTypedArray(e);return cP(s,i,r),e}function Nut(t,e,r){if(C(t))return e;cE(Kn,r);const i=Ii.fromTypedArray(t),s=Ii.fromTypedArray(e);return _v(s,i,Kn),eY(Kn)||ZJ(s,s),e}function Fut(t,e,r){if(C(t))return e;cE(Kn,r);const i=Ii.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),s=Ii.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT);if(_v(s,i,Kn),eY(Kn)||ZJ(s,s),t!==e)for(let n=3;n<t.length;n+=4)e[n]=t[n];return e}function Uut(t,e,r,i,s){if(!j6(i))return B6.error("Cannot convert spatial reference to PCPF"),s;G6(Kg.TO_PCPF,Ii.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),Ca.fromTypedArray(e),Ca.fromTypedArray(r),i,Ii.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function ULt(t,e,r,i,s){if(!j6(i))return B6.error("Cannot convert to spatial reference from PCPF"),s;G6(Kg.FROM_PCPF,Ii.fromTypedArray(t,16),Ca.fromTypedArray(e),Ca.fromTypedArray(r),i,Ii.fromTypedArray(s,16));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function G6(t,e,r,i,s,n){if(!e)return;const o=r.count,a=U5(s);if(REe(s))for(let l=0;l<o;l++)i.getVec(l,x$),e.getVec(l,Hp),xp(a,x$,T$,a),Jh(Kn,T$),t===Kg.FROM_PCPF&&Kh(Kn,Kn),Oc(Hp,Hp,Kn),n.setVec(l,Hp);else for(let l=0;l<o;l++){i.getVec(l,x$),e.getVec(l,Hp),xp(a,x$,T$,a),Jh(Kn,T$);const c=HN(r.get(l,1));let h=Math.cos(c);t===Kg.TO_PCPF&&(h=1/h),Kn[0]*=h,Kn[1]*=h,Kn[2]*=h,Kn[3]*=h,Kn[4]*=h,Kn[5]*=h,t===Kg.FROM_PCPF&&Kh(Kn,Kn),Oc(Hp,Hp,Kn),ve(Hp,Hp),n.setVec(l,Hp)}return n}function j6(t){return REe(t)||Vut(t)}function REe(t){return t.isWGS84||spe(t)||wm(t)||xm(t)}function Vut(t){return t.isWebMercator}var Kg;(function(t){t[t.TO_PCPF=0]="TO_PCPF",t[t.FROM_PCPF=1]="FROM_PCPF"})(Kg||(Kg={}));const x$=M(),Hp=M(),T$=Ie(),Kn=rs();let OEe=class{constructor(e){this.data=e,this.type="encoded-mesh-texture",this.encoding=Dg.KTX2_ENCODING}};function fw(t){return(t==null?void 0:t.type)==="encoded-mesh-texture"}async function kut(t){return new Promise((e,r)=>{const i=new Blob([t]),s=new FileReader;s.onload=()=>{const n=s.result;e(JSON.parse(n))},s.onerror=n=>{r(n)},s.readAsText(i)})}async function zut(t,e){return e===Dg.KTX2_ENCODING?new OEe(t):new Promise((r,i)=>{const s=new Blob([t],{type:e}),n=URL.createObjectURL(s),o=new Image,a=()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>r(o),()=>r(o)).then(c):(r(o),c())},l=h=>{URL.revokeObjectURL(n),i(h),c()},c=()=>{o.removeEventListener("load",a),o.removeEventListener("error",l)};o.addEventListener("load",a),o.addEventListener("error",l),o.src=n})}function zf(t){if(C(t))return null;const e=v(t.offset)?t.offset:Z2e,r=v(t.rotation)?t.rotation:0,i=v(t.scale)?t.scale:J2e,s=eN(1,0,0,0,1,0,e[0],e[1],1),n=eN(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),o=eN(i[0],0,0,0,i[1],0,0,0,1),a=Hl();return lE(a,n,o),lE(a,s,a),a}function But(t){const e=new Lr,{vertex:r,fragment:i}=e;return e.include(Gl,t),e.include(mx,t),e.include(fSe,t),Nc(r,t),t.stippleEnabled&&(e.attributes.add(A.UV0,"vec2"),e.attributes.add(A.AUXPOS1,"vec3"),r.uniforms.add(new fr("viewport",(s,n)=>n.camera.fullViewport))),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vpos","vec3"),r.code.add(w`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),t.stippleEnabled&&(r.code.add(w`vec4 vpos2 = transformPosition(proj, view, auxpos1);
vec2 ndcToPixel = viewport.zw * 0.5;
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),t.draped?r.uniforms.add(new Pe("worldToScreenRatio",(s,n)=>1/n.screenToPCSRatio)):r.code.add(w`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(w`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),t.draped?r.code.add(w`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):r.code.add(w`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Pe("stipplePatternPixelSize",s=>KJ(s))),r.code.add(w`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),r.code.add(w`}`),t.output===V.Highlight&&e.include(Ry,t),e.include(Zs,t),i.uniforms.add(new Pe("alphaCoverage",(s,n)=>Math.min(1,s.width*n.camera.pixelRatio))),t.hasVertexColors||i.uniforms.add(new fr("constantColor",s=>s.color)),i.code.add(w`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${t.hasVertexColors?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    ${t.output===V.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(Qo)}) {
      discard;
    }

    ${t.output===V.Color?w`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===V.Highlight?w`outputHighlight();`:""}
  }
  `),e}const Gut=Object.freeze(Object.defineProperty({__proto__:null,build:But},Symbol.toStringTag,{value:"Module"}));let MEe=class PEe extends kr{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==V.Highlight}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,PEe.shader.get().build(this.configuration),Ar)}initializePipeline(){const e=this.configuration,r=Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),i=(s,n=null,o=null)=>zt({blending:n,depthTest:eK,depthWrite:o,colorWrite:Qt,stencilWrite:e.hasOccludees?vm:null,stencilTest:e.hasOccludees?s?vv:$v:null});return e.output===V.Color?(this._occludeePipelineState=i(!0,e.transparent||this._stippleEnabled?r:null,Yl),i(!1,e.transparent||this._stippleEnabled?r:null,Yl)):i(!1)}get primitiveType(){return $t.LINES}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};MEe.shader=new Dr(Gut,()=>ie(()=>import("./NativeLine.glsl-c9c7bb62.js"),[],import.meta.url));let au=class extends io{constructor(){super(...arguments),this.output=V.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}};u([k({count:V.COUNT})],au.prototype,"output",void 0),u([k()],au.prototype,"hasSlicePlane",void 0),u([k()],au.prototype,"hasVertexColors",void 0),u([k()],au.prototype,"transparent",void 0),u([k()],au.prototype,"draped",void 0),u([k()],au.prototype,"stippleEnabled",void 0),u([k()],au.prototype,"stippleOffColorEnabled",void 0),u([k()],au.prototype,"stipplePreferContinuous",void 0),u([k()],au.prototype,"hasOccludees",void 0),u([k({constValue:!1})],au.prototype,"stippleRequiresClamp",void 0),u([k({constValue:!1})],au.prototype,"stippleScaleWithLineWidth",void 0),u([k({constValue:!1})],au.prototype,"stippleRequiresStretchMeasure",void 0);var x4;(function(t){t[t.START=0]="START",t[t.END=1]="END"})(x4||(x4={}));let qae=class extends Pv{constructor(e){super(e,new qut),this._configuration=new au}getConfiguration(e,r){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=r.slot===Se.DRAPED_MATERIAL;const i=v(this.parameters.stipplePattern);return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&v(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!e.visible)return;if(!pxe(r))return void se.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const a=e.vertexAttributes.get(A.POSITION).data,l=i.camera,c=Xut;zn(c,i.point);const h=2;ce(lA[0],c[0]-h,c[1]+h,0),ce(lA[1],c[0]+h,c[1]+h,0),ce(lA[2],c[0]+h,c[1]-h,0),ce(lA[3],c[0]-h,c[1]-h,0);for(let _=0;_<4;_++)if(!l.unprojectFromRenderScreen(lA[_],qm[_]))return;fa(l.eye,qm[0],qm[1],mV),fa(l.eye,qm[1],qm[2],gV),fa(l.eye,qm[2],qm[3],yV),fa(l.eye,qm[3],qm[0],_V);let p=Number.MAX_VALUE,f=0;for(let _=0;_<a.length-5;_+=3){if(ja[0]=a[_]+r[12],ja[1]=a[_+1]+r[13],ja[2]=a[_+2]+r[14],Ha[0]=a[_+3]+r[12],Ha[1]=a[_+4]+r[13],Ha[2]=a[_+5]+r[14],wi(mV,ja)<0&&wi(mV,Ha)<0||wi(gV,ja)<0&&wi(gV,Ha)<0||wi(yV,ja)<0&&wi(yV,Ha)<0||wi(_V,ja)<0&&wi(_V,Ha)<0)continue;if(l.projectToRenderScreen(ja,a1),l.projectToRenderScreen(Ha,l1),a1[2]<0&&l1[2]>0){ge(qp,ja,Ha);const x=l.frustum,T=-wi(x[bi.NEAR],ja)/_e(qp,x[bi.NEAR]);ae(qp,qp,T),me(ja,ja,qp),l.projectToRenderScreen(ja,a1)}else if(a1[2]>0&&l1[2]<0){ge(qp,Ha,ja);const x=l.frustum,T=-wi(x[bi.NEAR],Ha)/_e(qp,x[bi.NEAR]);ae(qp,qp,T),me(Ha,Ha,qp),l.projectToRenderScreen(Ha,l1)}else if(a1[2]<0&&l1[2]<0)continue;a1[2]=0,l1[2]=0;const b=lY(aw(a1,l1,Yae),c);b<p&&(p=b,le(Wae,ja),le(Xae,Ha),f=_/3)}const m=i.rayBegin,y=i.rayEnd;if(p<h*h){let _=Number.MAX_VALUE;if(Oye(aw(Wae,Xae,Yae),aw(m,y,Wut),o1)){ge(o1,o1,m);const b=Me(o1);ae(o1,o1,1/b),_=b/Si(m,y)}o(_,o1,f,!1)}}intersectDraped(e,r,i,s,n,o){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get(A.POSITION).data,l=e.vertexAttributes.get(A.SIZE),c=l?l.data[0]:0,h=s[0],p=s[1],f=((c+1)/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,y=0;for(let _=0;_<a.length-5;_+=3){const b=a[_],x=a[_+1],T=h-b,S=p-x,E=a[_+3]-b,O=a[_+4]-x,R=ye((E*T+O*S)/(E*E+O*O),0,1),L=E*R-T,I=O*R-S,U=L*L+I*I;U<m&&(m=U,y=_/3)}m<f*f&&n(o.dist,o.normal,y,!1)}requiresSlot(e,r){return!(r!==V.Color&&r!==V.Highlight&&r!==V.ObjectAndLayerIdColor||e!==Se.OPAQUE_MATERIAL&&e!==Se.DRAPED_MATERIAL)}createGLMaterial(e){return new jut(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?PSe:ilt;return C(this.parameters.stipplePattern)?new mC(e):new Hut(e.clone().vec3f(A.AUXPOS1).vec2f(A.UV0))}},jut=class extends Mv{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===V.Color&&this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,r)),this._stipplePattern=r),this.ensureTechnique(MEe,e)}},Hut=class{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(A.POSITION).length}write(e,r,i,s,n){BTe(i,this.vertexBufferLayout,e,r,s,n),this._writeAuxpos1(e,i,s,n),this._writeUV0(e,i,s,n)}_writeAuxpos1(e,r,i,s){const n=i.getField(A.AUXPOS1,Ii),o=r.indices.get(A.POSITION),a=r.vertexAttributes.get(A.POSITION).data,l=e,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const m=3*o[p+f],y=a[m],_=a[m+1],b=a[m+2],x=l[0]*y+l[4]*_+l[8]*b+l[12],T=l[1]*y+l[5]*_+l[9]*b+l[13],S=l[2]*y+l[6]*_+l[10]*b+l[14];h[s]=x,h[s+1]=T,h[s+2]=S,s+=c}}_writeUV0(e,r,i,s){var S;const n=i.getField(A.UV0,Ay),o=r.indices.get(A.POSITION),a=r.vertexAttributes.get(A.POSITION).data,l=(S=r.vertexAttributes.get(A.DISTANCETOSTART))==null?void 0:S.data,c=n.typedBufferStride,h=n.typedBuffer;let p=0;h[s*=c]=x4.START,h[s+1]=p,s+=c;const f=3*o[0],m=ce(ja,a[f],a[f+1],a[f+2]);e&&Xe(m,m,e);const y=Ha,_=o.length-1;let b=1;const x=l?(E,O,R)=>p=l[R]:(E,O,R)=>p+=Si(E,O);for(let E=1;E<_;E+=2){const O=3*o[E];ce(y,a[O],a[O+1],a[O+2]),e&&Xe(y,y,e),x(m,y,b++);for(let R=0;R<2;++R)h[s]=1-R,h[s+1]=p,s+=c;le(m,y)}const T=3*o[_];ce(y,a[T],a[T+1],a[T+2]),e&&Xe(y,y,e),x(m,y,b),h[s]=x4.END,h[s+1]=p}},qut=class extends pC{constructor(){super(...arguments),this.color=Lh,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}};const ja=M(),Ha=M(),qp=M(),o1=M(),a1=Zo(),l1=Zo(),Wae=M(),Xae=M(),Yae=Rp(),Wut=Rp(),Xut=M(),lA=[Zo(),Zo(),Zo(),Zo()],qm=[M(),M(),M(),M()],mV=Br(),gV=Br(),yV=Br(),_V=Br(),Yut=["mesh"];class Zut extends Mm{constructor(e,r,i,s){super(e,r,i,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Wr.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new qae({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new qae({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),e=>e.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Yut,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(r,new Ip),s=e.renderingInfo;return this._createAs3DShape(r,s,i,r.uid)}layerOpacityChanged(e,r){const i=this._getLayerOpacity();this._materials.forEach(s=>{s.material.setParameters({layerOpacity:i});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),e.forEach(s=>{const n=r(s);v(n)&&n.layerOpacityChanged(i,this._context.isAsync)})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,gv)}slicePlaneEnabledChanged(e,r){return this._materials.forEach(i=>{i.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e.forEach(i=>{const s=r(i);v(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach(r=>r.material.setParameters({usePBR:e})),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return C(e)?"-":e instanceof Ze?e.toHex():e.contentHash}_materialPropertiesDefault(e,r){const i=this._requiresSymbolVertexColors(),s=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${r},svc:${i}`}}_materialProperties(e,r,i){const s=this._materialPropertiesDefault(e,i);if(!r.material)return s;const{color:n,colorTexture:o,normalTexture:a,doubleSided:l,alphaCutoff:c,alphaMode:h}=r.material,p=this._colorOrTextureUid(n),f=this._colorOrTextureUid(o),m=this._colorOrTextureUid(a);if(s.color=n,s.colorTexture=o,s.normalTexture=a,s.uid=`${s.uid},cmuid:${p},ctmuid:${f},ntmuid:${m},ds:${l},ac:${c},am:${h}`,r.material instanceof EEe){const{metallic:y,roughness:_,metallicRoughnessTexture:b,emissiveColor:x,emissiveTexture:T,occlusionTexture:S}=r.material,E=this._colorOrTextureUid(b),O=this._colorOrTextureUid(x),R=this._colorOrTextureUid(T),L=this._colorOrTextureUid(S);s.metallic=y,s.roughness=_,s.metallicRoughnessTexture=b,s.emissiveColor=x,s.emissiveTexture=T,s.occlusionTexture=S,s.colorTextureTransform=r.material.colorTextureTransform,s.normalTextureTransform=r.material.normalTextureTransform,s.emissiveTextureTransform=r.material.emissiveTextureTransform,s.occlusionTextureTransform=r.material.occlusionTextureTransform,s.metallicRoughnessTextureTransform=r.material.metallicRoughnessTextureTransform,s.uid=`${s.uid},mrm:${y},mrr:${_},mrt:${E},emuid:${O},etmuid:${R},otmuid:${L}`}return s}_setInternalColorValueParameters(e,r){r.diffuse=Ze.toUnitRGB(e),r.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const r=this._getInternalTexture(e,ui.Opaque);return v(r)?r.id:null}_getInternalTexture(e,r){const i=this._getLoadableTextureResource(e);if(!i)return null;const s=`${e.contentHash}/${r}`;let n=this._textures.get(s);return n||(n=new fx(fw(i)?i.data:i,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!fw(i)&&r!==ui.Opaque,encoding:fw(i)&&v(i.encoding)?i.encoding:void 0}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadImmediate(n)),n}_castTextureWrap(e="repeat"){if(typeof e=="string"){const r=this._castTextureWrapIndividual(e);return{s:r,t:r}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return Ot.CLAMP_TO_EDGE;case"mirror":return Ot.MIRRORED_REPEAT;default:return Ot.REPEAT}}_setInternalMaterialParameters(e,r){if(v(e.color)&&this._setInternalColorValueParameters(e.color,r),v(e.colorTexture)){const i=this._getInternalTexture(e.colorTexture,r.textureAlphaMode);v(i)?(r.textureId=i.id,r.textureAlphaPremultiplied=!!i.params.preMultiplyAlpha):r.textureId=void 0}v(e.normalTexture)&&(r.normalTextureId=this._getInternalTextureId(e.normalTexture)),v(e.emissiveColor)&&(r.emissiveFactor=Ze.toUnitRGB(e.emissiveColor)),v(e.emissiveTexture)&&(r.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),v(e.occlusionTexture)&&(r.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),v(e.metallicRoughnessTexture)&&(r.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),r.colorTextureTransformMatrix=zf(e.colorTextureTransform),r.normalTextureTransformMatrix=zf(e.normalTextureTransform),r.occlusionTextureTransformMatrix=zf(e.occlusionTextureTransform),r.emissiveTextureTransformMatrix=zf(e.emissiveTextureTransform),r.metallicRoughnessTextureTransformMatrix=zf(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){const r=this._drivenProperties.color;let i=v(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(r)e.externalColor=Lh;else{const s=v(this.symbolLayer.material)?this.symbolLayer.material.color:null;v(s)?e.externalColor=Ze.toUnitRGBA(s):(i=null,e.externalColor=Lh)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const r=e.vertexAttributes.color;if(C(r))return!1;for(let i=3;i<r.length;i+=4)if(r[i]!==255)return!0;return!1}_getOrCreateMaterial(e,r){var y,_,b;const i=(y=r.material)==null?void 0:y.color,s=(_=r.material)==null?void 0:_.colorTexture,n=(b=r.material)==null?void 0:b.alphaMode,o=n==="blend",a=n!=="opaque"&&(this._hasTransparentVertexColors(e)||v(i)&&i.a<1||v(s)&&s.transparent||o),l=this._materialProperties(e,r,a),c=this._materials.get(l.uid);if(c)return c.material;const h={material:null,isComponentTransparent:a,alphaMode:r.material?r.material.alphaMode:"opaque"},p=l.metallicRoughnessTexture==null&&l.metallic==null&&l.roughness==null,f={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:wa,diffuse:Gf,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Ei.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};p||(f.mrrFactors=[l.metallic!=null?l.metallic:1,l.roughness!=null?l.roughness:1,.5]),r.material&&(f.doubleSided=r.material.doubleSided,f.cullFace=r.material.doubleSided?Ei.None:Ei.Back,f.textureAlphaCutoff=r.material.alphaCutoff),this._setExternalMaterialParameters(f),this._setMaterialTransparentParameter(f,h),this._setInternalMaterialParameters(l,f);const m=new fy(f);return h.material=m,this._materials.set(l.uid,h),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,r){e.transparent=this.needsDrivenTransparentPass||r.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,r.alphaMode==="auto"?e.textureAlphaMode=e.transparent?ui.MaskBlend:ui.Opaque:e.textureAlphaMode=r.alphaMode==="opaque"?ui.Opaque:r.alphaMode==="mask"?ui.Mask:ui.Blend}_addDebugNormals(e,r){const i=r.length,s=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),o=[],a=[],l=[],c=[];for(let m=0;m<i;m++){const y=r[m],_=y.vertexAttributes.get(A.POSITION),b=y.vertexAttributes.get(A.NORMAL),x=y.indices.get(A.POSITION),T=y.indices.get(A.NORMAL),S=_.data,E=b.data;for(let O=0;O<x.length;O++){const R=3*x[O],L=3*T[O];for(let I=0;I<3;I++)o.push(S[R+I]);for(let I=0;I<3;I++)o.push(S[R+I]+E[L+I]*n);if(a.push(a.length),a.push(a.length),O%3==0){this._calculateFaceNormal(S,x,O,tT),this._getFaceVertices(S,x,O,Bo,Qx,eT),me(Bo,Bo,Qx),me(Bo,Bo,eT),ae(Bo,Bo,1/3);for(let I=0;I<3;I++)l.push(Bo[I]);for(let I=0;I<3;I++)l.push(Bo[I]+tT[I]*n);c.push(c.length),c.push(c.length)}}}const h=r[0].transformation,p=new ln(this._debugVertexNormalMaterial,[[A.POSITION,new Ye(o,3,!0)]],[[A.POSITION,a]],null,$s.Line);r.push(p),p.transformation=h;const f=new ln(this._debugFaceNormalMaterial,[[A.POSITION,new Ye(l,3,!0)]],[[A.POSITION,c]],null,$s.Line);f.transformation=h,r.push(f)}_createAs3DShape(e,r,i,s){const n=e.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,r,s);if(C(o))return null;const{geometries:a,objectTransformation:l}=o;Wr.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a);const c=new Py({geometries:a,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});c.transformation=l;const h=B2e(this.symbolLayer,{opacity:this._getLayerOpacity()}),p=v(h)?new pot(a[0].material,[h],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,f=new Om(this,c,a,null,null,W3,i,p);f.needsElevationUpdates=gv(i.mode),f.useObjectOriginAsAttachmentOrigin=!0,i.centerPointInElevationSR=this._getCenterPointInElevationSR(c);const{elevationProvider:m,renderCoordsHelper:y}=this._context,_=(b,x)=>fC(b,m,i,y,x);return f.alignedSampledElevation=W3(f,i,m.spatialReference,_,y),f}_getCenterPointInElevationSR(e){const r=My(0,0,0,v(this._context.elevationProvider.spatialReference)?this._context.elevationProvider.spatialReference:null);return Hfe([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,r),r}_createComponentNormals(e,r,i,s){switch(i.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,r,i,s);case"flat":return this._createComponentNormalsFlat(e,s);case"smooth":return this._createComponentNormalsSmooth(e,s)}}_createComponentNormalsSource(e,r,i,s){if(C(r))return this._createComponentNormalsFlat(e,s);let n=!1;if(!i.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(e,s,o,tT);for(let a=0;a<3;a++){const l=3*s[o+a];Bo[0]=r[l+0],Bo[1]=r[l+1],Bo[2]=r[l+2],_e(tT,Bo)<0&&(r[l+0]=-r[l+0],r[l+1]=-r[l+1],r[l+2]=-r[l+2],n=!0)}}return new vV(r,s,n)}_createComponentNormalsFlat(e,r){const i=Ys(r.length),s=new Array(3*r.length);for(let n=0;n<r.length;n+=3){const o=this._calculateFaceNormal(e,r,n,tT);for(let a=0;a<3;a++)i[n+a]=o[a],s[n+a]=n/3}return new vV(i,s,!1)}_createComponentNormalsSmooth(e,r){const i={};for(let o=0;o<r.length;o+=3){const a=this._calculateFaceNormal(e,r,o,tT);for(let l=0;l<3;l++){const c=r[o+l];let h=i[c];h||(h={normal:M(),count:0},i[c]=h),me(h.normal,h.normal,a),h.count++}}const s=Ys(3*r.length),n=new Array(3*r.length);for(let o=0;o<r.length;o++){const a=i[r[o]];a.count!==1&&(ve(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return new vV(s,n,!1)}_getFaceVertices(e,r,i,s,n,o){const a=3*r[i+0],l=3*r[i+1],c=3*r[i+2];s[0]=e[a+0],s[1]=e[a+1],s[2]=e[a+2],n[0]=e[l+0],n[1]=e[l+1],n[2]=e[l+2],o[0]=e[c+0],o[1]=e[c+1],o[2]=e[c+2]}_calculateFaceNormal(e,r,i,s){return this._getFaceVertices(e,r,i,Bo,Qx,eT),ge(Qx,Qx,Bo),ge(eT,eT,Bo),pt(Bo,Qx,eT),ve(s,Bo),s}_getOrCreateComponents(e){return It(e.components,Jut)}_createPositionBuffer(e,r){let i=e.vertexAttributes.position;const s=r.reprojection===hu.ECEF?r.transformBeforeProject:null;if(v(s)&&(i=Dut(i,new Float64Array(i.length),s)),r.reprojection===hu.NONE)return r.needsBufferCopy?new Float64Array(i):i;const n=v(s)?i:new Float64Array(i.length);return vs(i,e.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,i.length/3),n}_createNormalBuffer(e,r,i){let s=e.vertexAttributes.normal;if(C(s))return null;const n=i.reprojection===hu.ECEF?i.transformBeforeProject:null;if(v(n)&&(s=Nut(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||i.reprojection===hu.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=v(n)?s:new Float32Array(s.length);return Lut(s,o,r,e.spatialReference,a)}_createTangentBuffer(e,r,i){let s=e.vertexAttributes.tangent;if(C(s))return null;const n=i.reprojection===hu.ECEF?i.transformBeforeProject:null;if(v(n)&&(s=Fut(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||i.reprojection===hu.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=v(n)?s:new Float32Array(s.length);return Uut(s,o,r,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const r=this._getVertexOpacityAndColor(e),i=Wlt(Js(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return tEe(r,i,s),s}return null}_createBuffers(e,r){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=e.vertexAttributes.normal,n=e.vertexAttributes.uv,o=e.vertexAttributes.tangent;if(v(s)&&s.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(v(o)&&o.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(v(n)&&n.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,a),c=this._createColorBuffer(e),h=this._createSymbolColorBuffer(r),p=this._createNormalBuffer(e,l,a),f=this._createTangentBuffer(e,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===hu.NONE&&v(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(e,l,p,f),geometryTransformation:a.reprojection===hu.NONE&&v(a.geometryTransformation)?a.geometryTransformation:Ie()}}_computeReprojectionInfo(e){const r=v(e.transform),i=r&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===Be.Local?hu.NONE:hu.ECEF;if(r){if(i===hu.NONE){const n=Ie();return xp(e.spatialReference,e.transform.origin,n,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:n,geometryTransformation:uE(e.transform.localMatrix),needsBufferCopy:!1}}const s=i5(Ie(),e.transform.origin);return ys(s,s,e.transform.localMatrix),{reprojection:i,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(e,r,i,s){const n=this._context.renderCoordsHelper.spatialReference,o=e.anchor;S$[0]=o.x,S$[1]=o.y,S$[2]=o.z;const a=Ie();xp(e.spatialReference,S$,a,n);const l=Ca.fromTypedArray(r);if(Lo(Zae,a),cP(l,l,Zae),v(i)||v(s)){if(Jh(cA,a),Kh(cA,cA),v(i)){const c=Ii.fromTypedArray(i);_v(c,c,cA)}if(v(s)){const c=Ii.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);_v(c,c,cA)}}return a}_validateFaces(e,r){const i=e.vertexAttributes.position.length/3,s=r.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(i<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,r){return r.faces?r.faces:AE(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return!1;const i=this._context.elevationProvider.spatialReference;let s;const n=r.length/3;return v(i)&&!e.spatialReference.equals(i)?(s=new Float64Array(r.length),vs(e.vertexAttributes.position,e.spatialReference,0,s,i,0,n)):s=r,Mi(bV),Ou(bV,s,0,n),!op(bV,this._context.clippingExtent)}_createGeometryInfo(e,r,i){if(!rv(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const s=this._createBuffers(e,r);if(C(s))return null;const{positionBuffer:n,uvBuffer:o,colorBuffer:a,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:h,objectTransformation:p,geometryTransformation:f}=s,m=this._getOrCreateComponents(e),y=new Array;let _=!1;for(const b of m){if(!this._validateFaces(e,b))return null;const x=this._getOrCreateFaces(e,b);if(x.length===0)continue;const T=this._createComponentNormals(n,c,b,x);T.didFlipNormals&&(_=!0);const S=[[A.POSITION,new Ye(n,3,!0)],[A.NORMAL,new Ye(T.normals,3,!0)]],E=[[A.POSITION,x],[A.NORMAL,T.indices]];v(a)&&(S.push([A.COLOR,new Ye(a,4,!0)]),E.push([A.COLOR,x])),v(l)&&(S.push([A.SYMBOLCOLOR,new Ye(l,4,!0)]),E.push([A.SYMBOLCOLOR,new Array(x.length).fill(0)])),v(o)&&(S.push([A.UV0,new Ye(o,2,!0)]),E.push([A.UV0,x])),v(h)&&(S.push([A.TANGENT,new Ye(h,4,!0)]),E.push([A.TANGENT,x]));const O=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),R=this._getOrCreateMaterial(e,b),L=new ln(R,S,E,null,$s.Mesh,O);L.transformation=f,y.push(L)}return _&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:y,objectTransformation:p}}}let vV=class{constructor(e,r,i){this.normals=e,this.indices=r,this.didFlipNormals=i}};const S$=M(),Bo=M(),Qx=M(),eT=M(),tT=M(),Zae=Ie(),cA=rs(),bV=Rn(),Jut=[new $ut];var hu;(function(t){t[t.NONE=0]="NONE",t[t.ECEF=1]="ECEF"})(hu||(hu={}));let Kut=class{constructor(e,r,i,s){this.graphics3DSymbolLayer=e,this.instanceIndex=r,this.elevationAligner=i,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const r=this._lodRenderer.instanceData;e!==r.getVisible(this.instanceIndex)&&r.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,r,i){if(this.elevationAligner){jJ(this.elevationContext.featureExpressionInfoContext,i);const s=(o,a)=>fC(o,e,this.elevationContext,r,a),n=this.elevationAligner(this,this.elevationContext,e.spatialReference,s,r);v(n)&&(this.alignedSampledElevation=n)}}getCenterObjectSpace(e=M()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Wp),Xe(e,this._lodRenderer.baseBoundingSphere.center,Wp)}getBoundingBoxObjectSpace(e=Rn()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Wp);const r=this._lodRenderer.baseBoundingBox;Mi(e);for(let i=0;i<8;++i)ce(Ju,1&i?r[3]:r[0],2&i?r[4]:r[1],4&i?r[5]:r[2]),Xe(Ju,Ju,Wp),mm(e,Ju);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Wp),e.render.origin[0]+=Wp[12],e.render.origin[1]+=Wp[13],e.render.origin[2]+=Wp[14],e.render.num++}async getProjectedBoundingBox(e,r,i,s,n){const o=this.getBoundingBoxObjectSpace(n),a=Qut,l=GX(o)?1:a.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Wp);for(let h=0;h<l;h++){const p=a[h];Ju[0]=o[p[0]],Ju[1]=o[p[1]],Ju[2]=o[p[2]],Xe(Ju,Ju,Wp),c1[3*h+0]=Ju[0],c1[3*h+1]=Ju[1],c1[3*h+2]=Ju[2]}if(!e(c1,0,l))return null;Mi(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],c1[h+p]),o[p+3]=Math.max(o[p+3],c1[h+p]);c&&i.push({location:c1.slice(h,h+3),screenSpaceBoundingRect:c})}if(r&&(np(o,wV),this.elevationContext.mode!=="absolute-height")){let h;const p=zJ(o,r.service.spatialReference,r);try{h=await r.service.queryElevation(wV[0],wV[1],s,p,"ground")}catch{}v(h)&&age(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(e,r){if(e===uy.Highlight){const i=new KF(e);this._addHighlightId(i),r.addExternal(s=>{this._removeHighlightId(s)},i)}}removeObjectState(e){this._highlights.forEach(r=>e.remove(r))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}};const c1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ju=M(),wV=M(),Qut=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Wp=Ie();function eht(t){const e=new Array;return t.stageResources.geometries.forEach(r=>{const i=t.stageResources.textures;e.push(new V2e(r,i))}),{components:e,minScreenSpaceRadius:It(t.lodThreshold,0),pivotOffset:t.pivotOffset}}function tht(t){return{levels:t.map(e=>eht(e))}}function rht(t,e,r){if(t.count!==e.count)return void L6.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=r[9],y=r[10],_=r[11],b=r[12],x=r[13],T=r[14],S=r[15],E=t.typedBuffer,O=t.typedBufferStride,R=e.typedBuffer,L=e.typedBufferStride;for(let I=0;I<i;I++){const U=I*O,z=I*L,B=R[z],G=R[z+1],K=R[z+2],re=R[z+3];E[U]=s*B+l*G+f*K+b*re,E[U+1]=n*B+c*G+m*K+x*re,E[U+2]=o*B+h*G+y*K+T*re,E[U+3]=a*B+p*G+_*K+S*re}}function IEe(t,e,r){if(t.count!==e.count)return void L6.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=t.typedBuffer,y=t.typedBufferStride,_=e.typedBuffer,b=e.typedBufferStride;for(let x=0;x<i;x++){const T=x*y,S=x*b,E=_[S],O=_[S+1],R=_[S+2],L=_[S+3];m[T]=s*E+a*O+h*R,m[T+1]=n*E+l*O+p*R,m[T+2]=o*E+c*O+f*R,m[T+3]=L}}function iht(t,e){const r=Math.min(t.count,e.count),i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride;for(let a=0;a<r;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const y=1/Math.sqrt(m);i[l]=y*h,i[l+1]=y*p,i[l+2]=y*f}}}function aq(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=r*o[h],s[c+1]=r*o[h+1],s[c+2]=r*o[h+2],s[c+3]=r*o[h+3]}}function sht(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;for(let l=0;l<i;l++){const c=l*n,h=l*a;s[c]=o[h]>>r,s[c+1]=o[h+1]>>r,s[c+2]=o[h+2]>>r,s[c+3]=o[h+3]>>r}}Object.freeze(Object.defineProperty({__proto__:null,normalize:iht,scale:aq,shiftRight:sht,transformMat3:IEe,transformMat4:rht},Symbol.toStringTag,{value:"Module"}));function nht(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<9;++p)i[l+p]=n[c+p];l+=s,c+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:nht},Symbol.toStringTag,{value:"Module"}));function oht(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<16;++p)i[l+p]=n[c+p];l+=s,c+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:oht},Symbol.toStringTag,{value:"Module"}));function aht(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],l+=s,c+=o}function iN(t,e){const r=t.count;e||(e=new t.TypedArrayConstructor(r));for(let i=0;i<r;i++)e[i]=t.get(i);return e}Object.freeze(Object.defineProperty({__proto__:null,copy:aht,makeDense:iN},Symbol.toStringTag,{value:"Module"}));function $Ee(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],i[l+1]=n[c+1],l+=s,c+=o}function LEe(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;if(aQe(e.elementType)){const h=lQe(e.elementType);if(oQe(e.elementType))for(let p=0;p<a;++p)i[l]=Math.max(n[c]/h,-1),i[l+1]=Math.max(n[c+1]/h,-1),l+=s,c+=o;else for(let p=0;p<a;++p)i[l]=n[c]/h,i[l+1]=n[c+1]/h,l+=s,c+=o}else $Ee(t,e,r);return t}function lht(t,e,r,i){const s=t.typedBuffer,n=t.typedBufferStride,o=(i==null?void 0:i.count)??t.count;let a=((i==null?void 0:i.dstIndex)??0)*n;for(let l=0;l<o;++l)s[a]=e,s[a+1]=r,a+=n}Object.freeze(Object.defineProperty({__proto__:null,copy:$Ee,fill:lht,normalizeIntegerBuffer:LEe},Symbol.toStringTag,{value:"Module"}));function H6(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],i[l+1]=n[c+1],i[l+2]=n[c+2],l+=s,c+=o}function cht(t,e,r,i,s){const n=t.typedBuffer,o=t.typedBufferStride,a=(s==null?void 0:s.count)??t.count;let l=((s==null?void 0:s.dstIndex)??0)*o;for(let c=0;c<a;++c)n[l]=e,n[l+1]=r,n[l+2]=i,l+=o}Object.freeze(Object.defineProperty({__proto__:null,copy:H6,fill:cht},Symbol.toStringTag,{value:"Module"}));function DEe(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride,a=r?r.count:e.count;let l=(r&&r.dstIndex?r.dstIndex:0)*s,c=(r&&r.srcIndex?r.srcIndex:0)*o;for(let h=0;h<a;++h)i[l]=n[c],i[l+1]=n[c+1],i[l+2]=n[c+2],i[l+3]=n[c+3],l+=s,c+=o}function NEe(t,e,r,i,s,n){const o=t.typedBuffer,a=t.typedBufferStride,l=(n==null?void 0:n.count)??t.count;let c=((n==null?void 0:n.dstIndex)??0)*a;for(let h=0;h<l;++h)o[c]=e,o[c+1]=r,o[c+2]=i,o[c+3]=s,c+=a}Object.freeze(Object.defineProperty({__proto__:null,copy:DEe,fill:NEe},Symbol.toStringTag,{value:"Module"}));function Fb(t,e){return new t(new ArrayBuffer(e*t.ElementCount*uxe(t.ElementType)))}let FEe=class{constructor(e){this._streamDataRequester=e}async loadJSON(e,r){return this._load("json",e,r)}async loadBinary(e,r){return bm(e)?(ur(r),hW(e)):this._load("binary",e,r)}async loadImage(e,r){return this._load("image",e,r)}async _load(e,r,i){if(C(this._streamDataRequester))return(await Pi(r,{responseType:uht[e]})).data;const s=await Uc(this._streamDataRequester.request(r,e,i));if(s.ok===!0)return s.value;throw Sc(s.error),new j("",`Request for resource failed: ${s.error}`)}};const uht={image:"image",binary:"array-buffer",json:"json"};function hht(t={}){return{color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,colorTextureTransform:null,normalTextureTransform:null,occlusionTextureTransform:null,emissiveTextureTransform:null,metallicRoughnessTextureTransform:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply",...t}}function dht(t,e={}){return{data:t,parameters:{wrap:{s:Ot.REPEAT,t:Ot.REPEAT,...e.wrap},noUnpackFlip:!0,mipmap:!1,...e}}}let Jae=class{constructor(e){this._data=e,this._offset4=0,this._dataUint32=new Uint32Array(this._data,0,Math.floor(this._data.byteLength/4))}readUint32(){const e=this._offset4;return this._offset4+=1,this._dataUint32[e]}readUint8Array(e){const r=4*this._offset4;return this._offset4+=e/4,new Uint8Array(this._data,r,e)}remainingBytes(){return this._data.byteLength-4*this._offset4}};var XO,Kae;(function(t){t.SCALAR="SCALAR",t.VEC2="VEC2",t.VEC3="VEC3",t.VEC4="VEC4",t.MAT2="MAT2",t.MAT3="MAT3",t.MAT4="MAT4"})(XO||(XO={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(Kae||(Kae={}));const UEe={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},pht={pbrMetallicRoughness:UEe,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},fht={ESRI_externalColorMixMode:"tint"},Qae=(t={})=>{const e={...UEe,...t.pbrMetallicRoughness},r=mht({...fht,...t.extras});return{...pht,...t,pbrMetallicRoughness:e,extras:r}};function mht(t){switch(t.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:t.ESRI_externalColorMixMode,t.ESRI_externalColorMixMode="tint"}return t}const ght={magFilter:tt.LINEAR,minFilter:tt.LINEAR_MIPMAP_LINEAR,wrapS:Ot.REPEAT,wrapT:Ot.REPEAT},yht=t=>({...ght,...t});function _ht(t){let e,r;return t.replace(/^(.*\/)?([^/]*)$/,(i,s,n)=>(e=s||"",r=n||"","")),{dirPart:e,filePart:r}}const E$={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};let vht=class K0{constructor(e,r,i,s){if(this._context=e,this.uri=r,this.json=i,this._glbBuffer=s,this._bufferLoaders=new Map,this._textureLoaders=new Map,this._textureCache=new Map,this._materialCache=new Map,this._nodeParentMap=new Map,this._nodeTransformCache=new Map,this._supportedExtensions=["KHR_texture_basisu"],this._baseUri=_ht(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),i.scenes==null)throw new j("gltf-loader-unsupported-feature","Scenes must be defined.");if(i.meshes==null)throw new j("gltf-loader-unsupported-feature","Meshes must be defined");if(i.nodes==null)throw new j("gltf-loader-unsupported-feature","Nodes must be defined.");this._computeNodeParents()}static async load(e,r,i){if(bm(r)){const o=_M(r);if(o&&o.mediaType!=="model/gltf-binary")try{const l=JSON.parse(o.isBase64?atob(o.data):o.data);return new K0(e,r,l)}catch{}const a=hW(r);if(K0._isGLBData(a))return this._fromGLBData(e,r,a)}if(r.endsWith(".gltf")){const o=await e.loadJSON(r,i);return new K0(e,r,o)}const s=await e.loadBinary(r,i);if(K0._isGLBData(s))return this._fromGLBData(e,r,s);const n=await e.loadJSON(r,i);return new K0(e,r,n)}static _isGLBData(e){if(e==null)return!1;const r=new Jae(e);return r.remainingBytes()>=4&&r.readUint32()===E$.MAGIC}static async _fromGLBData(e,r,i){const s=await K0._parseGLBData(i);return new K0(e,r,s.json,s.binaryData)}static async _parseGLBData(e){const r=new Jae(e);if(r.remainingBytes()<12)throw new j("gltf-loader-error","GLB binary data is insufficiently large.");const i=r.readUint32(),s=r.readUint32(),n=r.readUint32();if(i!==E$.MAGIC)throw new j("gltf-loader-error","Magic first 4 bytes do not fit to expected GLB value.");if(e.byteLength<n)throw new j("gltf-loader-error","GLB binary data is smaller than header specifies.");if(s!==2)throw new j("gltf-loader-unsupported-feature","An unsupported GLB container version was detected. Only version 2 is supported.");let o,a,l=0;for(;r.remainingBytes()>=8;){const c=r.readUint32(),h=r.readUint32();if(l===0){if(h!==E$.CHUNK_TYPE_JSON)throw new j("gltf-loader-error","First GLB chunk must be JSON.");if(c<0)throw new j("gltf-loader-error","No JSON data found.");o=await kut(r.readUint8Array(c))}else if(l===1){if(h!==E$.CHUNK_TYPE_BIN)throw new j("gltf-loader-unsupported-feature","Second GLB chunk expected to be BIN.");a=r.readUint8Array(c)}else se.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] More than 2 GLB chunks detected. Skipping.");l+=1}if(!o)throw new j("gltf-loader-error","No GLB JSON chunk detected.");return{json:o,binaryData:a}}async getBuffer(e,r){const i=this.json.buffers[e];if(i.uri==null){if(this._glbBuffer==null)throw new j("gltf-loader-error","GLB buffer not present");return this._glbBuffer}const s=await this._getBufferLoader(e,r);if(s.byteLength!==i.byteLength)throw new j("gltf-loader-error","Buffer byte lengths should match.");return s}async _getBufferLoader(e,r){const i=this._bufferLoaders.get(e);if(i)return i;const s=this.json.buffers[e].uri,n=this._context.loadBinary(this._resolveUri(s),r).then(o=>new Uint8Array(o));return this._bufferLoaders.set(e,n),n}async getAccessor(e,r){if(!this.json.accessors)throw new j("gltf-loader-unsupported-feature","Accessors missing.");const i=this.json.accessors[e];if((i==null?void 0:i.bufferView)==null)throw new j("gltf-loader-unsupported-feature","Some accessor does not specify a bufferView.");if(i.type in[XO.MAT2,XO.MAT3,XO.MAT4])throw new j("gltf-loader-unsupported-feature",`AttributeType ${i.type} is not supported`);const s=this.json.bufferViews[i.bufferView],n=await this.getBuffer(s.buffer,r),o=xht[i.type],a=Tht[i.componentType],l=o*a,c=s.byteStride||l;return{raw:n.buffer,byteStride:c,byteOffset:n.byteOffset+(s.byteOffset||0)+(i.byteOffset||0),entryCount:i.count,isDenselyPacked:c===l,componentCount:o,componentByteSize:a,componentType:i.componentType,min:i.min,max:i.max,normalized:!!i.normalized}}async getIndexData(e,r){if(e.indices==null)return;const i=await this.getAccessor(e.indices,r);if(i.isDenselyPacked)switch(i.componentType){case lt.UNSIGNED_BYTE:return new Uint8Array(i.raw,i.byteOffset,i.entryCount);case lt.UNSIGNED_SHORT:return new Uint16Array(i.raw,i.byteOffset,i.entryCount);case lt.UNSIGNED_INT:return new Uint32Array(i.raw,i.byteOffset,i.entryCount)}else switch(i.componentType){case lt.UNSIGNED_BYTE:return iN(this._wrapAccessor(CE,i));case lt.UNSIGNED_SHORT:return iN(this._wrapAccessor(m6,i));case lt.UNSIGNED_INT:return iN(this._wrapAccessor(y6,i))}}async getPositionData(e,r){if(e.attributes.POSITION==null)throw new j("gltf-loader-unsupported-feature","No POSITION vertex data found.");const i=await this.getAccessor(e.attributes.POSITION,r);if(i.componentType!==lt.FLOAT)throw new j("gltf-loader-unsupported-feature","Expected type FLOAT for POSITION vertex attribute, but found "+lt[i.componentType]);if(i.componentCount!==3)throw new j("gltf-loader-unsupported-feature","POSITION vertex attribute must have 3 components, but found "+i.componentCount.toFixed());return this._wrapAccessor(Ii,i)}async getNormalData(e,r){if(e.attributes.NORMAL==null)throw new j("gltf-loader-error","No NORMAL vertex data found.");const i=await this.getAccessor(e.attributes.NORMAL,r);if(i.componentType!==lt.FLOAT)throw new j("gltf-loader-unsupported-feature","Expected type FLOAT for NORMAL vertex attribute, but found "+lt[i.componentType]);if(i.componentCount!==3)throw new j("gltf-loader-unsupported-feature","NORMAL vertex attribute must have 3 components, but found "+i.componentCount.toFixed());return this._wrapAccessor(Ii,i)}async getTangentData(e,r){if(e.attributes.TANGENT==null)throw new j("gltf-loader-error","No TANGENT vertex data found.");const i=await this.getAccessor(e.attributes.TANGENT,r);if(i.componentType!==lt.FLOAT)throw new j("gltf-loader-unsupported-feature","Expected type FLOAT for TANGENT vertex attribute, but found "+lt[i.componentType]);if(i.componentCount!==4)throw new j("gltf-loader-unsupported-feature","TANGENT vertex attribute must have 4 components, but found "+i.componentCount.toFixed());return new zc(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*i.entryCount)}async getTextureCoordinates(e,r){if(e.attributes.TEXCOORD_0==null)throw new j("gltf-loader-error","No TEXCOORD_0 vertex data found.");const i=await this.getAccessor(e.attributes.TEXCOORD_0,r);if(i.componentCount!==2)throw new j("gltf-loader-unsupported-feature","TEXCOORD_0 vertex attribute must have 2 components, but found "+i.componentCount.toFixed());if(i.componentType===lt.FLOAT)return this._wrapAccessor(Ay,i);if(!i.normalized)throw new j("gltf-loader-unsupported-feature","Integer component types are only supported for a normalized accessor for TEXCOORD_0.");return Sht(i)}async getVertexColors(e,r){if(e.attributes.COLOR_0==null)throw new j("gltf-loader-error","No COLOR_0 vertex data found.");const i=await this.getAccessor(e.attributes.COLOR_0,r);if(i.componentCount!==4&&i.componentCount!==3)throw new j("gltf-loader-unsupported-feature","COLOR_0 attribute must have 3 or 4 components, but found "+i.componentCount.toFixed());if(i.componentCount===4){if(i.componentType===lt.FLOAT)return this._wrapAccessor(zc,i);if(i.componentType===lt.UNSIGNED_BYTE)return this._wrapAccessor(Aa,i);if(i.componentType===lt.UNSIGNED_SHORT)return this._wrapAccessor(tP,i)}else if(i.componentCount===3){if(i.componentType===lt.FLOAT)return this._wrapAccessor(Ii,i);if(i.componentType===lt.UNSIGNED_BYTE)return this._wrapAccessor(V3,i);if(i.componentType===lt.UNSIGNED_SHORT)return this._wrapAccessor(g6,i)}throw new j("gltf-loader-unsupported-feature","Unsupported component type for COLOR_0 attribute: "+lt[i.componentType])}hasPositions(e){return e.attributes.POSITION!==void 0}hasNormals(e){return e.attributes.NORMAL!==void 0}hasVertexColors(e){return e.attributes.COLOR_0!==void 0}hasTextureCoordinates(e){return e.attributes.TEXCOORD_0!==void 0}hasTangents(e){return e.attributes.TANGENT!==void 0}async getMaterial(e,r,i){var n,o,a,l,c,h,p,f,m,y;let s=e.material?this._materialCache.get(e.material):void 0;if(!s){const _=e.material!=null?Qae(this.json.materials[e.material]):Qae(),b=_.pbrMetallicRoughness,x=this.hasVertexColors(e),T=this.getTexture(b.baseColorTexture,r),S=this.getTexture(_.normalTexture,r),E=i?this.getTexture(_.occlusionTexture,r):void 0,O=i?this.getTexture(_.emissiveTexture,r):void 0,R=i?this.getTexture(b.metallicRoughnessTexture,r):void 0,L=e.material!=null?e.material:-1;s={alphaMode:_.alphaMode,alphaCutoff:_.alphaCutoff,color:b.baseColorFactor,doubleSided:!!_.doubleSided,colorTexture:await T,normalTexture:await S,name:_.name,id:L,occlusionTexture:await E,emissiveTexture:await O,emissiveFactor:_.emissiveFactor,metallicFactor:b.metallicFactor,roughnessFactor:b.roughnessFactor,metallicRoughnessTexture:await R,hasVertexColors:x,ESRI_externalColorMixMode:_.extras.ESRI_externalColorMixMode,colorTextureTransform:(o=(n=b==null?void 0:b.baseColorTexture)==null?void 0:n.extensions)==null?void 0:o.KHR_texture_transform,normalTextureTransform:(l=(a=_.normalTexture)==null?void 0:a.extensions)==null?void 0:l.KHR_texture_transform,occlusionTextureTransform:(h=(c=_.occlusionTexture)==null?void 0:c.extensions)==null?void 0:h.KHR_texture_transform,emissiveTextureTransform:(f=(p=_.emissiveTexture)==null?void 0:p.extensions)==null?void 0:f.KHR_texture_transform,metallicRoughnessTextureTransform:(y=(m=b==null?void 0:b.metallicRoughnessTexture)==null?void 0:m.extensions)==null?void 0:y.KHR_texture_transform}}return s}async getTexture(e,r){if(!e)return;if((e.texCoord||0)!==0)throw new j("gltf-loader-unsupported-feature","Only TEXCOORD with index 0 is supported.");const i=e.index,s=this.json.textures[i],n=yht(s.sampler!=null?this.json.samplers[s.sampler]:{}),o=this._getTextureSourceId(s),a=this.json.images[o],l=await this._loadTextureImageData(i,s,r);return wW(this._textureCache,i,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>{throw new j("gltf-loader-error",`Unexpected TextureSampler WrapMode: ${p}`)};return{data:l,wrapS:c(n.wrapS)?n.wrapS:h(n.wrapS),wrapT:c(n.wrapT)?n.wrapT:h(n.wrapT),minFilter:n.minFilter,name:a.name,id:i}})}getNodeTransform(e){if(e===void 0)return bht;let r=this._nodeTransformCache.get(e);if(!r){const i=this.getNodeTransform(this._getNodeParent(e)),s=this.json.nodes[e];s.matrix?r=ys(Ie(),i,s.matrix):s.translation||s.rotation||s.scale?(r=uE(i),s.translation&&ql(r,r,s.translation),s.rotation&&(C$[3]=gY(C$,s.rotation),Mc(r,r,C$[3],C$)),s.scale&&t5(r,r,s.scale)):r=uE(i),this._nodeTransformCache.set(e,r)}return r}_wrapAccessor(e,r){return new e(r.raw,r.byteOffset,r.byteStride,r.byteOffset+r.byteStride*(r.entryCount-1)+r.componentByteSize*r.componentCount)}_resolveUri(e){return Eu(e,this._baseUri)}_getNodeParent(e){return this._nodeParentMap.get(e)}_checkVersionSupported(){const e=Lw.parse(this.json.asset.version,"glTF");wht.validate(e)}_checkRequiredExtensionsSupported(){const e=this.json;if(e.extensionsRequired&&!e.extensionsRequired.every(r=>this._supportedExtensions.includes(r)))throw new j("gltf-loader-unsupported-feature","gltf loader was not able to load unsupported feature. Required extensions: "+e.extensionsRequired.join(", "))}_computeNodeParents(){this.json.nodes.forEach((e,r)=>{e.children&&e.children.forEach(i=>{this._nodeParentMap.set(i,r)})})}async _loadTextureImageData(e,r,i){const s=this._textureLoaders.get(e);if(s)return s;const n=this._createTextureLoader(r,i);return this._textureLoaders.set(e,n),n}_getTextureSourceId(e){if(e.extensions!==void 0&&e.extensions.KHR_texture_basisu!==null)return e.extensions.KHR_texture_basisu.source;if(e.source!==null)return e.source;throw new j("gltf-loader-unsupported-feature","Source is expected to be defined for a texture. It can also be omitted in favour of an KHR_texture_basisu extension tag.")}async _createTextureLoader(e,r){const i=this._getTextureSourceId(e),s=this.json.images[i];if(s.uri){if(s.uri.endsWith(".ktx2")){const l=await this._context.loadBinary(this._resolveUri(s.uri),r);return new OEe(new Uint8Array(l))}return this._context.loadImage(this._resolveUri(s.uri),r)}if(s.bufferView==null)throw new j("gltf-loader-unsupported-feature","Image bufferView must be defined.");if(s.mimeType==null)throw new j("gltf-loader-unsupported-feature","Image mimeType must be defined.");const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,r);if(n.byteStride!=null)throw new j("gltf-loader-unsupported-feature","byteStride not supported for image buffer");const a=o.byteOffset+(n.byteOffset||0);return zut(new Uint8Array(o.buffer,a,n.byteLength),s.mimeType)}async getLoadedBuffersSize(){if(this._glbBuffer)return this._glbBuffer.byteLength;const e=await Dk(Array.from(this._bufferLoaders.values())),r=await Dk(Array.from(this._textureLoaders.values()));return e.reduce((i,s)=>i+((s==null?void 0:s.byteLength)??0),0)+r.reduce((i,s)=>i+(s?fw(s)?s.data.byteLength:s.width*s.height*4:0),0)}};const bht=Sfe(Ie(),Math.PI/2),wht=new Lw(2,0,"glTF"),C$=id(),xht={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},Tht={[lt.BYTE]:1,[lt.UNSIGNED_BYTE]:1,[lt.SHORT]:2,[lt.UNSIGNED_SHORT]:2,[lt.FLOAT]:4,[lt.UNSIGNED_INT]:4};function Sht(t){switch(t.componentType){case lt.BYTE:return new _6(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.UNSIGNED_BYTE:return new f6(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.SHORT:return new v6(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.UNSIGNED_SHORT:return new sJ(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.UNSIGNED_INT:return new nJ(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case lt.FLOAT:return new Ay(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount)}}let Eht=0;async function VEe(t,e,r={},i=!0){const s=await vht.load(t,e,r),n="gltf_"+Eht++,o={lods:[],materials:new Map,textures:new Map,meta:Cht(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await Aht(s,async(h,p,f,m)=>{const y=l.get(f)??0;l.set(f,y+1);const _=h.mode!==void 0?h.mode:$t.TRIANGLES,b=_===$t.TRIANGLES||_===$t.TRIANGLE_STRIP||_===$t.TRIANGLE_FAN?_:null;if(C(b))return void se.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Unsupported primitive mode ("+$t[_]+"). Skipping primitive.");if(!s.hasPositions(h))return void se.getLogger("esri.views.3d.glTF").warn("Skipping primitive without POSITION vertex attribute.");const x=s.getPositionData(h,r),T=s.getMaterial(h,r,i),S=s.hasNormals(h)?s.getNormalData(h,r):null,E=s.hasTangents(h)?s.getTangentData(h,r):null,O=s.hasTextureCoordinates(h)?s.getTextureCoordinates(h,r):null,R=s.hasVertexColors(h)?s.getVertexColors(h,r):null,L=s.getIndexData(h,r),I={transform:uE(p),attributes:{position:await x,normal:S?await S:null,texCoord0:O?await O:null,color:R?await R:null,tangent:E?await E:null},indices:await L,primitiveType:b,material:Oht(o,await T,n)};let U=null;v(o.meta)&&v(o.meta.ESRI_lod)&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(U=o.meta.ESRI_lod.thresholds[f]),o.lods[f]=o.lods[f]||{parts:[],name:m,lodThreshold:U},o.lods[f].parts[y]=I});for(const h of o.lods)h.parts=h.parts.filter(p=>!!p);const c=await s.getLoadedBuffersSize();return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{},size:c}}function Cht(t){const e=t.json;let r=null;return e.nodes.forEach(i=>{const s=i.extras;v(s)&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(r=s)}),r}async function Aht(t,e){const r=t.json,i=r.scenes[r.scene||0].nodes,s=i.length>1,n=[];for(const a of i){const l=r.nodes[a];n.push(o(a,0)),Rht(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=r.nodes[a],h=t.getNodeTransform(a);if(c.weights!=null&&se.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Morph targets are not supported."),c.mesh!=null){const p=r.meshes[c.mesh];for(const f of p.primitives)n.push(e(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function Rht(t){return t.extensions&&t.extensions.MSFT_lod&&Array.isArray(t.extensions.MSFT_lod.ids)}function Oht(t,e,r){const i=n=>{const o=`${r}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!t.textures.has(o)){const a=dht(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:Mht.includes(n.minFilter),noUnpackFlip:!0});t.textures.set(o,a)}return o},s=`${r}_mat_${e.id}_${e.name}`;if(!t.materials.has(s)){const n=hht({color:[e.color[0],e.color[1],e.color[2]],opacity:e.color[3],alphaMode:e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,colorMixMode:e.ESRI_externalColorMixMode,textureColor:e.colorTexture?i(e.colorTexture):void 0,textureNormal:e.normalTexture?i(e.normalTexture):void 0,textureOcclusion:e.occlusionTexture?i(e.occlusionTexture):void 0,textureEmissive:e.emissiveTexture?i(e.emissiveTexture):void 0,textureMetallicRoughness:e.metallicRoughnessTexture?i(e.metallicRoughnessTexture):void 0,emissiveFactor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform,metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor});t.materials.set(s,n)}return s}const Mht=[tt.LINEAR_MIPMAP_LINEAR,tt.LINEAR_MIPMAP_NEAREST];function Pht(t,e=AE){return typeof t=="number"?e(t):eW(t)||Tb(t)?new Uint32Array(t):t}function Iht(t){const e=typeof t=="number"?t:t.length;if(e<3)return[];const r=e-2,i=gxe(r);if(typeof t=="number"){let s=0;for(let n=0;n<r;n+=1)n%2==0?(i[s++]=n,i[s++]=n+1,i[s++]=n+2):(i[s++]=n+1,i[s++]=n,i[s++]=n+2)}else{let s=0;for(let n=0;n<r;n+=1)if(n%2==0){const o=t[n],a=t[n+1],l=t[n+2];i[s++]=o,i[s++]=a,i[s++]=l}else{const o=t[n+1],a=t[n],l=t[n+2];i[s++]=o,i[s++]=a,i[s++]=l}}return i}function $ht(t){const e=typeof t=="number"?t:t.length;if(e<3)return new Uint16Array(0);const r=e-2,i=r<=65536?new Uint16Array(3*r):new Uint32Array(3*r);if(typeof t=="number"){let s=0;for(let n=0;n<r;++n)i[s++]=0,i[s++]=n+1,i[s++]=n+2;return i}{const s=t[0];let n=t[1],o=0;for(let a=0;a<r;++a){const l=t[a+2];i[o++]=s,i[o++]=n,i[o++]=l,n=l}return i}}let Lht=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},Dht=class{constructor(e,r,i){this.name=e,this.lodThreshold=r,this.pivotOffset=i,this.stageResources=new Lht,this.numberOfVertices=0}};const wg=se.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function kEe(t,e){const r=await Nht(t,e),i=await zht(r.textureDefinitions??{},e);let s=0;for(const n in i)if(i.hasOwnProperty(n)){const o=i[n];s+=o!=null&&o.image?o.image.width*o.image.height*4:0}return{resource:r,textures:i,size:s+Zge(r)}}async function Nht(t,e){const r=v(e)&&e.streamDataRequester;if(r)return Fht(t,r,e);const i=await Uc(Pi(t,e));if(i.ok===!0)return i.value.data;Sc(i.error),zEe(i.error)}async function Fht(t,e,r){const i=await Uc(e.request(t,"json",r));if(i.ok===!0)return i.value;Sc(i.error),zEe(i.error.details.url)}function zEe(t){throw new j("",`Request for object resource failed: ${t}`)}function Uht(t){const e=t.params,r=e.topology;let i=!0;switch(e.vertexAttributes||(wg.warn("Geometry must specify vertex attributes"),i=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=e.faces;if(n){if(e.vertexAttributes)for(const o in e.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(wg.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),i=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(wg.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),i=!1)):(wg.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),i=!1)}}else wg.warn("Indexed geometries must specify faces"),i=!1;break}default:wg.warn(`Unsupported topology '${r}'`),i=!1}t.params.material||(wg.warn("Geometry requires material"),i=!1);const s=t.params.vertexAttributes;for(const n in s)s[n].values||(wg.warn("Geometries with externally defined attributes are not yet supported"),i=!1);return i}function Vht(t,e){const r=new Array,i=new Array,s=new Array,n=new uC,o=t.resource,a=Lw.parse(o.version||"1.0","wosr");Ght.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions??{},p=t.textures;let f=0;const m=new Map;for(let y=0;y<c.length;y++){const _=c[y];if(!Uht(_))continue;const b=Bht(_),x=_.params.vertexAttributes,T=[];for(const B in x){const G=x[B],K=G.values;T.push([B,new Ye(K,G.valuesPerElement,!0)])}const S=[];if(_.params.topology!=="PerAttributeArray"){const B=_.params.faces;for(const G in B)S.push([G,B[G].values])}const E=b.texture,O=p&&p[E];if(O&&!m.has(E)){const{image:B,params:G}=O,K=new fx(B,G);i.push(K),m.set(E,K)}const R=m.get(E),L=R?R.id:void 0,I=b.material;let U=n.get(I,E);if(C(U)){const B=h[I.substring(I.lastIndexOf("/")+1)].params;B.transparency===1&&(B.transparency=0);const G=O&&O.alphaChannelUsage,K=B.transparency>0||G==="transparency"||G==="maskAndTransparency",re=O?BEe(O.alphaChannelUsage):void 0,ee={ambient:Ul(B.diffuse),diffuse:Ul(B.diffuse),opacity:1-(B.transparency||0),transparent:K,textureAlphaMode:re,textureAlphaCutoff:.33,textureId:L,initTextureTransparent:!0,doubleSided:!0,cullFace:Ei.None,colorMixMode:B.externalColorMixMode||"tint",textureAlphaPremultiplied:!!O&&!!O.params.preMultiplyAlpha};v(e)&&e.materialParamsMixin&&Object.assign(ee,e.materialParamsMixin),U=new fy(ee),n.set(I,E,U)}s.push(U);const z=new ln(U,T,S);f+=S.position?S.position.length:0,r.push(z)}return{engineResources:[{name:l,stageResources:{textures:i,materials:s,geometries:r},pivotOffset:o.model.pivotOffset,numberOfVertices:f,lodThreshold:null}],referenceBoundingBox:kht(r)}}function kht(t){const e=Mi();return t.forEach(r=>{const i=r.boundingInfo;v(i)&&(mm(e,i.bbMin),mm(e,i.bbMax))}),e}async function zht(t,e){const r=[];for(const n in t){const o=t[n],a=o.images[0].data;if(!a){wg.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:Ot.REPEAT,t:Ot.REPEAT},preMultiplyAlpha:BEe(h)!==ui.Opaque},f=v(e)&&e.disableTextures?Promise.resolve(null):dy(l,e);r.push(f.then(m=>({refId:c,image:m,params:p,alphaChannelUsage:h})))}const i=await Promise.all(r),s={};for(const n of i)s[n.refId]=n;return s}function BEe(t){switch(t){case"mask":return ui.Mask;case"maskAndTransparency":return ui.MaskBlend;case"none":return ui.Opaque;default:return ui.Blend}}function Bht(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const Ght=new Lw(1,2,"wosr"),rT=2.1;async function GEe(t,e){const r=jEe(XYe(t));if(r.fileType==="wosr"){const p=await(e.cache?e.cache.loadWOSR(r.url,e):kEe(r.url,e)),{engineResources:f,referenceBoundingBox:m}=Vht(p,e);return{lods:f,referenceBoundingBox:m,isEsriSymbolResource:!1,isWosr:!0}}const i=await(e.cache?e.cache.loadGLTF(r.url,e,!!e.usePBR):VEe(new FEe(e.streamDataRequester),r.url,e,e.usePBR)),s=Js(i.model.meta,"ESRI_proxyEllipsoid"),n=i.meta.isEsriSymbolResource&&v(s)&&i.meta.uri.includes("/RealisticTrees/");n&&!i.customMeta.esriTreeRendering&&(i.customMeta.esriTreeRendering=!0,Xht(i,s));const o=!!e.usePBR,a=i.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:n,mrrFactors:[0,1,.2]}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:[0,1,.5]},l={...e.materialParamsMixin,treeRendering:n},{engineResources:c,referenceBoundingBox:h}=HEe(i,a,l,e.skipHighLods&&r.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:r.specifiedLodIndex});return{lods:c,referenceBoundingBox:h,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1}}function jEe(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function HEe(t,e,r,i){const s=t.model,n=new Array,o=new Map,a=new Map,l=s.lods.length,c=Mi();return s.lods.forEach((h,p)=>{const f=i.skipHighLods===!0&&(l>1&&p===0||l>3&&p===1)||i.skipHighLods===!1&&i.singleLodIndex!=null&&p!==i.singleLodIndex;if(f&&p!==0)return;const m=new Dht(h.name,h.lodThreshold,[0,0,0]);h.parts.forEach(y=>{const _=f?new fy({}):jht(s,y,m,e,r,o,a),{geometry:b,vertexCount:x}=Hht(y,v(_)?_:new fy({})),T=b.boundingInfo;v(T)&&p===0&&(mm(c,T.bbMin),mm(c,T.bbMax)),v(_)&&(m.stageResources.geometries.push(b),m.numberOfVertices+=x)}),f||n.push(m)}),{engineResources:n,referenceBoundingBox:c}}function jht(t,e,r,i,s,n,o){const a=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),l=t.materials.get(e.material),c=v(e.attributes.texCoord0),h=v(e.attributes.normal);if(C(l))return null;const p=qht(l.alphaMode);if(!n.has(a)){if(c){const E=(O,R=!1)=>{if(v(O)&&!o.has(O)){const L=t.textures.get(O);if(v(L)){const I=L.data;o.set(O,new fx(fw(I)?I.data:I,{...L.parameters,preMultiplyAlpha:!fw(I)&&R,encoding:fw(I)&&v(I.encoding)?I.encoding:void 0}))}}};E(l.textureColor,p!==ui.Opaque),E(l.textureNormal),E(l.textureOcclusion),E(l.textureEmissive),E(l.textureMetallicRoughness)}const m=l.color[0]**(1/rT),y=l.color[1]**(1/rT),_=l.color[2]**(1/rT),b=l.emissiveFactor[0]**(1/rT),x=l.emissiveFactor[1]**(1/rT),T=l.emissiveFactor[2]**(1/rT),S=v(l.textureColor)&&c?o.get(l.textureColor):null;n.set(a,new fy({...i,transparent:p===ui.Blend,customDepthTest:kw.Lequal,textureAlphaMode:p,textureAlphaCutoff:l.alphaCutoff,diffuse:[m,y,_],ambient:[m,y,_],opacity:l.opacity,doubleSided:l.doubleSided,doubleSidedType:"winding-order",cullFace:l.doubleSided?Ei.None:Ei.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:h?si.Attribute:si.ScreenDerivative,castShadows:!0,receiveSSAO:!0,textureId:v(S)?S.id:void 0,colorMixMode:l.colorMixMode,normalTextureId:v(l.textureNormal)&&c?o.get(l.textureNormal).id:void 0,textureAlphaPremultiplied:v(S)&&!!S.params.preMultiplyAlpha,occlusionTextureId:v(l.textureOcclusion)&&c?o.get(l.textureOcclusion).id:void 0,emissiveTextureId:v(l.textureEmissive)&&c?o.get(l.textureEmissive).id:void 0,metallicRoughnessTextureId:v(l.textureMetallicRoughness)&&c?o.get(l.textureMetallicRoughness).id:void 0,emissiveFactor:[b,x,T],mrrFactors:[l.metallicFactor,l.roughnessFactor,i.mrrFactors[2]],isSchematic:!1,colorTextureTransformMatrix:zf(l.colorTextureTransform),normalTextureTransformMatrix:zf(l.normalTextureTransform),occlusionTextureTransformMatrix:zf(l.occlusionTextureTransform),emissiveTextureTransformMatrix:zf(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:zf(l.metallicRoughnessTextureTransform),...s}))}const f=n.get(a);if(r.stageResources.materials.push(f),c){const m=y=>{v(y)&&r.stageResources.textures.push(o.get(y))};m(l.textureColor),m(l.textureNormal),m(l.textureOcclusion),m(l.textureEmissive),m(l.textureMetallicRoughness)}return f}function Hht(t,e){const r=t.attributes.position.count,i=Wht(t.indices||r,t.primitiveType),s=Fb(Ii,r);cP(s,t.attributes.position,t.transform);const n=[[A.POSITION,new Ye(s.typedBuffer,s.elementCount,!0)]],o=[[A.POSITION,i]];if(v(t.attributes.normal)){const a=Fb(Ii,r);cE(A$,t.transform),_v(a,t.attributes.normal,A$),n.push([A.NORMAL,new Ye(a.typedBuffer,a.elementCount,!0)]),o.push([A.NORMAL,i])}if(v(t.attributes.tangent)){const a=Fb(zc,r);cE(A$,t.transform),IEe(a,t.attributes.tangent,A$),n.push([A.TANGENT,new Ye(a.typedBuffer,a.elementCount,!0)]),o.push([A.TANGENT,i])}if(v(t.attributes.texCoord0)){const a=Fb(Ay,r);LEe(a,t.attributes.texCoord0),n.push([A.UV0,new Ye(a.typedBuffer,a.elementCount,!0)]),o.push([A.UV0,i])}if(v(t.attributes.color)){const a=Fb(Aa,r);if(t.attributes.color.elementCount===4)t.attributes.color instanceof zc?aq(a,t.attributes.color,255):t.attributes.color instanceof Aa?DEe(a,t.attributes.color):t.attributes.color instanceof tP&&aq(a,t.attributes.color,1/256);else{NEe(a,255,255,255,255);const l=new V3(a.buffer,0,4);t.attributes.color instanceof Ii?qH(l,t.attributes.color,255):t.attributes.color instanceof V3?H6(l,t.attributes.color):t.attributes.color instanceof g6&&qH(l,t.attributes.color,1/256)}n.push([A.COLOR,new Ye(a.typedBuffer,a.elementCount,!0)]),o.push([A.COLOR,i])}return{geometry:new ln(e,n,o),vertexCount:r}}const A$=rs();function qht(t){switch(t){case"BLEND":return ui.Blend;case"MASK":return ui.Mask;case"OPAQUE":case null:case void 0:return ui.Opaque}}function Wht(t,e){switch(e){case $t.TRIANGLES:return Pht(t);case $t.TRIANGLE_STRIP:return Iht(t);case $t.TRIANGLE_FAN:return $ht(t)}}function Xht(t,e){for(let r=0;r<t.model.lods.length;++r){const i=t.model.lods[r];for(const s of i.parts){const n=s.attributes.normal;if(C(n))return;const o=s.attributes.position,a=o.count,l=M(),c=M(),h=M(),p=Fb(Aa,a),f=Fb(Ii,a),m=Lo(Ie(),s.transform);for(let y=0;y<a;y++){o.getVec(y,c),n.getVec(y,l),Xe(c,c,s.transform),ge(h,c,e.center),XN(h,h,e.radius);const _=h[2],b=Me(h),x=Math.min(.45+.55*b*b,1);XN(h,h,e.radius),m!==null&&Xe(h,h,m),ve(h,h),r+1!==t.model.lods.length&&t.model.lods.length>1&&Qs(h,h,l,_>-1?.2:Math.min(-4*_-3.8,1)),f.setVec(y,h),p.set(y,0,255*x),p.set(y,1,255*x),p.set(y,2,255*x),p.set(y,3,255)}s.attributes.normal=f,s.attributes.color=p}}}const JLt=Object.freeze(Object.defineProperty({__proto__:null,fetch:GEe,gltfToEngineResources:HEe,parseUrl:jEe},Symbol.toStringTag,{value:"Module"}));var Bi;function Yht(t){let e=is().mat4f64(A.LOCALTRANSFORM).mat4f64(A.GLOBALTRANSFORM).vec4f64(A.BOUNDINGSPHERE).vec3f64(A.MODELORIGIN).mat3f(A.MODEL).mat3f(A.MODELNORMAL).vec2f(A.MODELSCALEFACTORS);return t.includes("color")&&(e=e.vec4f(A.COLOR)),t.includes("featureAttribute")&&(e=e.vec4f(A.FEATUREATTRIBUTE)),e=e.u8(A.STATE).u8(A.LODLEVEL),t.includes(A.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(A.OBJECTANDLAYERIDCOLOR)),e.alignTo(8),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(Bi||(Bi={}));let Zht=class{constructor(e){this.localTransform=e.getField(A.LOCALTRANSFORM,U3),this.globalTransform=e.getField(A.GLOBALTRANSFORM,U3),this.modelOrigin=e.getField(A.MODELORIGIN,Ca),this.model=e.getField(A.MODEL,dv),this.modelNormal=e.getField(A.MODELNORMAL,dv),this.modelScaleFactors=e.getField(A.MODELSCALEFACTORS,Ay),this.boundingSphere=e.getField(A.BOUNDINGSPHERE,p6),this.color=e.getField(A.COLOR,zc),this.featureAttribute=e.getField(A.FEATUREATTRIBUTE,zc),this.state=e.getField(A.STATE,CE),this.lodLevel=e.getField(A.LODLEVEL,CE),this.objectAndLayerIdColor=e.getField(A.OBJECTANDLAYERIDCOLOR,Aa)}},x2=class extends Te{constructor(e,r){super(e),this.events=new Fs,this._capacity=0,this._size=0,this._next=0,this._buffer=null,this._view=null,this._layout=Yht(r)}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,Bi.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const r=this._view.state;gt(e>=0&&e<this._capacity&&(r.get(e)&Bi.ALLOCATED)!=0,"invalid instance handle"),this._getStateFlag(e,Bi.ACTIVE)?this._setStateFlags(e,Bi.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const r=this._view.state;gt(e>=0&&e<this._capacity&&(r.get(e)&Bi.ALLOCATED)!=0,"invalid instance handle"),r.set(e,0),this._size--}setLocalTransform(e,r,i=!0){this._view.localTransform.setMat(e,r),i&&this.updateModelTransform(e)}getLocalTransform(e,r){this._view.localTransform.getMat(e,r)}setGlobalTransform(e,r,i=!0){this._view.globalTransform.setMat(e,r),i&&this.updateModelTransform(e)}getGlobalTransform(e,r){this._view.globalTransform.getMat(e,r)}updateModelTransform(e){const r=this._view,i=o0,s=md;r.localTransform.getMat(e,ele),r.globalTransform.getMat(e,xV);const n=ys(xV,xV,ele);ce(i,n[12],n[13],n[14]),r.modelOrigin.setVec(e,i),Jh(s,n),r.model.setMat(e,s);const o=r4e(o0,n);o.sort(),r.modelScaleFactors.set(e,0,o[1]),r.modelScaleFactors.set(e,1,o[2]),ox(s,s),Kh(s,s),r.modelNormal.setMat(e,s),this._setStateFlags(e,Bi.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,r){const i=this._view;i.model.getMat(e,md),i.modelOrigin.getVec(e,o0),r[0]=md[0],r[1]=md[1],r[2]=md[2],r[3]=0,r[4]=md[3],r[5]=md[4],r[6]=md[5],r[7]=0,r[8]=md[6],r[9]=md[7],r[10]=md[8],r[11]=0,r[12]=o0[0],r[13]=o0[1],r[14]=o0[2],r[15]=1}applyShaderTransformation(e,r){v(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,r)}getCombinedModelTransform(e,r){return this.getModelTransform(e,r),v(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,r),r}getCombinedLocalTransform(e,r){return this._view.localTransform.getMat(e,r),v(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,r),r}getCombinedMaxScaleFactor(e){let r=this._view.modelScaleFactors.get(e,1);if(v(this.shaderTransformation)){const i=this.shaderTransformation.scaleFactor(o0,this,e);r*=Math.max(i[0],i[1],i[2])}return r}getCombinedMedianScaleFactor(e){let r=this._view.modelScaleFactors.get(e,0);if(v(this.shaderTransformation)){const i=this.shaderTransformation.scaleFactor(o0,this,e);r*=Jht(i[0],i[1],i[2])}return r}getModel(e,r){this._view.model.getMat(e,r)}setFeatureAttribute(e,r){this._view.featureAttribute.setVec(e,r)}getFeatureAttribute(e,r){this._view.featureAttribute.getVec(e,r)}setColor(e,r){this._view.color.setVec(e,r)}setObjectAndLayerIdColor(e,r){this._view.objectAndLayerIdColor.setVec(e,r)}getColor(e,r){this._view.color.getVec(e,r)}setVisible(e,r){r!==this.getVisible(e)&&(this._setStateFlag(e,Bi.VISIBLE,r),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,Bi.VISIBLE)}setHighlight(e,r){r!==this.getHighlight(e)&&(this._setStateFlag(e,Bi.HIGHLIGHT,r),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,Bi.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let r=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++r;return r}_setStateFlags(e,r){const i=this._view.state;r=i.get(e)|r,i.set(e,r)}_clearStateFlags(e,r){const i=this._view.state;r=i.get(e)&~r,i.set(e,r)}_setStateFlag(e,r,i){i?this._setStateFlags(e,r):this._clearStateFlags(e,r)}_getStateFlag(e,r){return!!(this._view.state.get(e)&r)}_grow(){const e=Math.max(Kht,Math.floor(this._capacity*Qht)),r=this._layout.createBuffer(e);if(this._buffer){const i=new Uint8Array(this._buffer.buffer);new Uint8Array(r.buffer).set(i)}this._capacity=e,this._buffer=r,this._view=new Zht(this._buffer)}_findSlot(){const e=this._view.state;let r=this._next;for(;e.get(r)&Bi.ALLOCATED;)r=r+1===this._capacity?0:r+1;return this._next=r+1===this._capacity?0:r+1,r}};function Jht(t,e,r){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),r))}u([d({constructOnly:!0})],x2.prototype,"shaderTransformation",void 0),u([d()],x2.prototype,"_size",void 0),u([d({readOnly:!0})],x2.prototype,"size",null),x2=u([P("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],x2);const Kht=1024,Qht=2,o0=M(),md=rs(),ele=Ie(),xV=Ie();let edt=class extends cp{constructor(e,r){super(i=>this._instanceData.view.boundingSphere.getVec(i,this._tmpSphere),{maximumDepth:25}),this._tmpSphere=cn(),this._tmpMat4=Ie(),this._instanceData=e,this._boundingSphere=r}addInstance(e){const r=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);Xe(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*Mw(i),r.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}},tdt=class{constructor(e,r){this._worldSpaceRadius=e,this._minScreenSpaceRadii=r}selectLevel(e,r,i){const s=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*r/s;let o=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)n>=this._minScreenSpaceRadii[a]&&(o=a);return o}},rdt=class extends O5{constructor(e,r,i,s,n,o){super(e,r),this.layerUid=e,this.graphicUid=r,this.geometryId=i,this.triangleNr=s,this.baseBoundingSphere=n,this.numLodLevels=o}};function mK(t){return Op(t)&&t.intersector===ts.LOD&&!!t.target}let idt=class{constructor(e,r){const i=e.renderContext.rctx,s=r.geometry;this._materialRepository=e.materialRepository,s.material.setParameters({instancedDoublePrecision:!0});const n=s.material.createBufferWriter(),o=n.vertexBufferLayout,a=n.elementCount(s),l=n.allocate(a);n.write(null,null,s,l,0),this.geometry=s,this.material=s.material,this.glMaterials=new RSe(s.material,this._materialRepository),this.vertexBufferLayout=o,this.vbo=jr.createVertex(i,$r.STATIC_DRAW,l.buffer),this.vao=new Pp(i,Ar,{geometry:Hc(o)},{geometry:this.vbo}),this.vertexCount=a}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,r,i,s,n,o,a,l){const c=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,s,(h,p,f,m,y)=>{if(h>=0){if(r!=null&&!r(e.rayBegin,e.rayEnd,h))return;const _=new rdt(o.layerUid,o.graphicUid(n),c,f,a,l);if((e.results.min.drapedLayerOrder==null||y>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||h<e.results.min.dist)&&e.results.min.set(ts.LOD,_,h,p,e.transform.transform,y),e.options.store!==Do.MIN&&(e.results.max.drapedLayerOrder==null||y>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||h>e.results.max.dist)&&e.results.max.set(ts.LOD,_,h,p,e.transform.transform,y),e.options.store===Do.ALL){const b=wY(e.results.min.ray);b.set(ts.LOD,_,h,p,e.transform.transform,y),e.results.all.push(b)}}})}},sdt=class qEe{static async create(e,r,i){const s=await Promise.allSettled(r.components.map(o=>e.controller.schedule(()=>new idt(e,o),i))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(v);if(Fn(i)||n.length!==s.length){n.forEach(o=>o.destroy()),ur(i);for(const o of s)if(o.status==="rejected")throw o.reason}return new qEe(r.minScreenSpaceRadius,n)}constructor(e,r){this.minScreenSpaceRadius=e,this.components=r}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,r,i,s,n,o,a){this.components.forEach(l=>l.intersect(e,r,i,s,n,o,this.boundingSphere,a))}get boundingBox(){if(C(this._boundingBox)){const e=Mi();this.components.forEach(r=>{v(r.boundingInfo)&&(mm(e,r.boundingInfo.bbMin),mm(e,r.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(C(this._boundingSphere)){const e=this.boundingBox,r=M();np(e,r),this._boundingSphere={center:r,radius:.5*oge(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,r)=>e+r.triangleCount,0)}},ndt=class{constructor(e,r,i){this._elementSize=r,this._buffer=jr.createVertex(e,$r.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,r,i,s=0){const n=new Uint8Array(this.array,e*this.elementSize,(r-e)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,r){const i=e*this._elementSize,s=r*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,s)}resize(e){const r=e*this._elementSize,i=new ArrayBuffer(r);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(r),this._capacity=e}},odt=class{constructor(e){this.modelOriginHi=e.getField(A.MODELORIGINHI,Ii),this.modelOriginLo=e.getField(A.MODELORIGINLO,Ii),this.model=e.getField(A.MODEL,dv),this.modelNormal=e.getField(A.MODELNORMAL,dv),this.color=e.getField(A.INSTANCECOLOR,zc),this.featureAttribute=e.getField(A.INSTANCEFEATUREATTRIBUTE,zc),this.objectAndLayerIdColor=e.getField(A.OBJECTANDLAYERIDCOLOR_INSTANCED,Aa)}},tle=class{constructor(e,r){this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=r,this._elementSize=r.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,r=this._tailIndex;return e>=r?e-r:e+this._capacity-r}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){gt(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){gt(this._updating,"not updating"),this.size<ldt*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){gt(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),gt(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){gt(this._updating,"not updating"),gt(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(rle,Math.floor(this._capacity*adt));this._resize(e)}_shrink(){const e=Math.max(rle,Math.floor(this._capacity*cdt));this._resize(e)}_resize(e){if(gt(this._updating,"not updating"),e===this._capacity)return;const r=new ndt(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const i=this.size,s=this._compactInstances(r);gt(s===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=r,this._view=new odt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const r=this._headIndex,i=this._tailIndex;return i<r?(this._buffer.copyRange(i,r,e),r-i):i>r?(this._buffer.copyRange(i,this._capacity,e),r>0&&this._buffer.copyRange(0,r,e,this._capacity-i),r+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,r){e<r?this._buffer.transferRange(e,r):e>r&&(r>0&&this._buffer.transferRange(0,r),this._buffer.transferRange(e,this._capacity))}};const rle=1024,adt=2,ldt=.3,cdt=.5,udt=t=>{const e=t.baseBoundingSphere.radius,r=t.levels.map(i=>i.minScreenSpaceRadius);return new tdt(e,r)};let gh=class extends Te{constructor(e,r){super(e),this.type=ts.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new At,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[Se.OPAQUE_MATERIAL,Se.TRANSPARENT_MATERIAL],this.canRender=!0,this._instanceData=new x2({shaderTransformation:e.shaderTransformation},e.optionalFields),this._frameTask=r.registerTask(yt.LOD_RENDERER,this)}initialize(){this._instanceBufferLayout=ddt(this.optionalFields),this._glInstanceBufferLayout=Hc(this._instanceBufferLayout,1),this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))}destroy(){this._frameTask.remove()}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(r=>{const i=r.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu}),this._highlightRenderInstanceData.forEach(r=>{const i=r.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu}),e}get renderStats(){const e=this._instanceData.size,r=[];return this._levels.forEach((i,s)=>{const n=this._defaultRenderInstanceData[s],o=this._highlightRenderInstanceData[s],a=n.size+o.size,l=i.triangleCount;r.push({renderedInstances:a,renderedTriangles:a*l,trianglesPerInstance:l})}),{totalInstances:e,renderedInstances:r.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:r.reduce((i,s)=>i+s.renderedTriangles,0),levels:r}}async initializeRenderContext(e,r){this._context=e;const i=e.renderContext.rctx,s=await Promise.allSettled(this.symbol.levels.map(o=>(this._defaultRenderInstanceData.push(new tle(i,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new tle(i,this._instanceBufferLayout)),sdt.create(e,o,r)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(v);if(Fn(r)||n.length!==s.length){n.forEach(o=>o.destroy()),ur(r);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=udt(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceData.forEach(e=>e.destroy())}get needsTransparentPass(){return this._levels.some(e=>e.components.some(r=>r.material.requiresSlot(Se.TRANSPARENT_MATERIAL,V.Color)))}get needsHighlight(){return this._highlightRenderInstanceData.some(e=>e.size>0)}prepareRender(e){if(!Wr.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const r=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),r||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ja),this._needFullCycle=!1)}}render(e){!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output)||(e.rctx.bindVAO(),e.output!==V.Highlight&&e.output!==V.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData),e.output!==V.ShadowExcludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData))}intersect(e,r,i,s){if(!this.baseMaterial.isVisible()||C(this._octree))return;const n=M();ge(n,s,i);const o=a=>{this._instanceData.getCombinedModelTransform(a,nle),e.transform.set(nle),Xe(ole,i,e.transform.inverse),Xe(ale,s,e.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a),h=this._levels.length;gt((l&Bi.ACTIVE)!=0,"invalid instance state"),gt(c>=0&&c<h,"invaid lod level"),this._levels[c].intersect(e,r,ole,ale,a,this.metadata,h)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(i,n,o)}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var e;if(C(this._octreeCached)){const r=this._instanceData,i=(e=r.view)==null?void 0:e.state;if(!i)return null;this._octreeCached=new edt(r,this.baseBoundingSphere);for(let s=0;s<r.capacity;++s)i.get(s)&Bi.ACTIVE&&this._octreeCached.addInstance(s)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Ve(this._octreeCached)}_queryDepthRangeOctree(e){if(C(this._octree))return{near:1/0,far:-1/0};const r=e.viewForward,i=this._octree.findClosest(r,cp.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(r,cp.DepthOrder.BACK_TO_FRONT,e.frustum);if(i==null||s==null)return{near:1/0,far:-1/0};const n=e.eye,o=this._instanceData.view;o.boundingSphere.getVec(i,Xp),ge(Xp,Xp,n);const a=_e(Xp,r)-Xp[3];o.boundingSphere.getVec(s,Xp),ge(Xp,Xp,n);const l=_e(Xp,r)+Xp[3];return{near:Math.max(e.near,a),far:Math.min(e.far,l)}}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(e=>e.startUpdateCycle()),this._highlightRenderInstanceData.forEach(e=>e.startUpdateCycle())}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:r,_camera:i,_levelSelector:s}=this;this._defaultRenderInstanceData.forEach(h=>h.beginUpdate()),this._highlightRenderInstanceData.forEach(h=>h.beginUpdate());const n=this._instanceData,o=n.view;let a=n.size;const l=n.capacity;let c=this._instanceIndex;for(let h=0;h<a&&!e.done;++h){c===this._cycleStartIndex&&this._startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&Bi.ALLOCATED)){c=c+1===l?0:c+1,a++;continue}const m=o.lodLevel.get(c);if(p&Bi.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),p&Bi.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[m].freeTail(),p&Bi.REMOVE)n.freeInstance(c);else if(p&Bi.VISIBLE){let y=0;r&&(o.modelOrigin.getVec(c,sle),y=s.selectLevel(sle,n.getCombinedMedianScaleFactor(c),i)),f=p&~(Bi.ACTIVE|Bi.TRANSFORM_CHANGED),y>=0&&(p&Bi.HIGHLIGHT?(ile(this._highlightRenderInstanceData[y],o,c),f|=Bi.HIGHLIGHT_ACTIVE):(ile(this._defaultRenderInstanceData[y],o,c),f|=Bi.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,y)}else f=p&~(Bi.ACTIVE|Bi.TRANSFORM_CHANGED),o.state.set(c,f);if(v(this._octreeCached)){const y=!!(p&Bi.ACTIVE),_=!!(f&Bi.ACTIVE);!y&&_?this._octreeCached.addInstance(c):y&&!_?this._octreeCached.removeInstance(c):y&&_&&p&Bi.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))}c=c+1===l?0:c+1,e.madeProgress()}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>h.endUpdate()),this._highlightRenderInstanceData.forEach(h=>h.endUpdate()),this._context.requestRender()}_renderComponents(e,r){this.levels.forEach((i,s)=>{const n=i.components.map(o=>this._beginComponent(e,r[s],o));i.components.forEach((o,a)=>this._renderComponent(e,n[a],r[s],o,s))})}_beginComponent(e,r,i){const{bindParameters:s,rctx:n,output:o}=e;if(r.size===0||!i.material.requiresSlot(s.slot,e.output))return null;const a=i.glMaterials.load(n,s.slot,o);return v(a)?a.beginSlot(s):null}_renderComponent(e,r,i,s,n){if(C(r))return;const{bindParameters:o,rctx:a}=e,l=a.bindTechnique(r,s.material.parameters,o);a.bindVAO(s.vao),r.ensureAttributeLocations(s.vao),l.bindDraw(pdt,o,s.material.parameters),Wr.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===V.Color&&(l.setUniform4fv("externalColor",lle[Math.min(n,lle.length-1)]),l.setUniform1i("colorMixMode",FTe.replace));const c=a.capabilities.instancing,h=i.capacity,p=i.headIndex,f=i.tailIndex,m=i.firstIndex,y=this._glInstanceBufferLayout,_=(b,x)=>{VZ(a,Ar,i.buffer,y,b),c.drawArraysInstanced(r.primitiveType,0,s.vertexCount,x-b),kZ(a,Ar,i.buffer,y)};s.material.parameters.transparent&&m!=null?p>f?(gt(m>=f&&m<=p,"invalid firstIndex"),_(m,p),_(f,m)):p<f&&(m<=p?(gt(m>=0&&m<=p,"invalid firstIndex"),_(m,p),_(f,h),_(0,m)):(gt(m>=f&&m<=h,"invalid firstIndex"),_(m,h),_(0,p),_(f,m))):p>f?_(f,p):p<f&&(_(0,p),_(f,h)),a.bindVAO(null)}};function ile(t,e,r){const i=t.allocateHead();hdt(e,r,t.view,i)}function hdt(t,e,r,i){xQe(t.modelOrigin,e,r.modelOriginHi,r.modelOriginLo,i),r.model.copyFrom(i,t.model,e),r.modelNormal.copyFrom(i,t.modelNormal,e),t.color&&r.color&&r.color.copyFrom(i,t.color,e),t.objectAndLayerIdColor&&r.objectAndLayerIdColor&&r.objectAndLayerIdColor.copyFrom(i,t.objectAndLayerIdColor,e),t.featureAttribute&&r.featureAttribute&&r.featureAttribute.copyFrom(i,t.featureAttribute,e)}function ddt(t){let e=is().vec3f(A.MODELORIGINHI).vec3f(A.MODELORIGINLO).mat3f(A.MODEL).mat3f(A.MODELNORMAL);return v(t)&&t.includes("color")&&(e=e.vec4f(A.INSTANCECOLOR)),v(t)&&t.includes("featureAttribute")&&(e=e.vec4f(A.INSTANCEFEATUREATTRIBUTE)),v(t)&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(A.OBJECTANDLAYERIDCOLOR_INSTANCED)),e}u([d({constructOnly:!0})],gh.prototype,"symbol",void 0),u([d({constructOnly:!0})],gh.prototype,"optionalFields",void 0),u([d({constructOnly:!0})],gh.prototype,"metadata",void 0),u([d({constructOnly:!0})],gh.prototype,"shaderTransformation",void 0),u([d()],gh.prototype,"_instanceData",void 0),u([d()],gh.prototype,"_cycleStartIndex",void 0),u([d({readOnly:!0})],gh.prototype,"_enableLevelSelection",null),u([d()],gh.prototype,"_updateCyclesWithStaticCamera",void 0),u([d({readOnly:!0})],gh.prototype,"running",null),gh=u([P("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],gh);const sle=M(),Xp=nr(),nle=Ie(),ole=M(),ale=M(),lle=[qt(1,0,1,1),qt(0,0,1,1),qt(0,1,0,1),qt(1,1,0,1),qt(1,0,0,1)],pdt=new act;let cle=class{constructor(e,r,i,s,n,o,a,l,c,h,p,f){this.lodResources=e,this.lodRenderer=r,this.stageResources=i,this.originalMaterialParameters=s,this.resourceSize=n,this.isEsriSymbolResource=o,this.isWosr=a,this.resourceBoundingBox=l,this.symbolSize=c,this.extentPadding=h,this.physicalBasedRenderingEnabled=p,this.pivotOffset=f}},fdt=class extends Mm{getCachedSize(){const[e,r,i]=v(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:r,height:i}}constructor(e,r,i,s){super(e,r,i,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size&&$6(this.symbolLayer))throw new Error;const r=this.symbolLayer;if(this._isPrimitive){const i=r.resource?r.resource.primitive:gge;this._resources=await this._createResourcesForPrimitive(i,e)}else this._resources=await this._createResourcesForUrl(r.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return v(this._resources)?this._resources.extentPadding:0}get _isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return v(this._resources)?this._resources.lodRenderer:null}_setMaterialTransparencyParams(e,r=Js(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(r),s=i<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=i,e.cullFace=s?Ei.None:Ei.Back,e}async _createResourcesForPrimitive(e,r){if(!mot(e))throw new Error(`Unknown object symbol primitive: ${e}`);const i=this.symbolLayer,s=Rn(B4e(e)),n=Ul(FP(s)),o=Ul(NU(n,i)),a=Me(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:Gf,diffuse:Gf,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=!!h.usePBR;this._setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:T,minWorldLength:S,maxWorldLength:E}=f.verticalOffset;h.verticalOffset={screenLength:$o(T),minWorldLength:S||0,maxWorldLength:v(E)?E:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=Lh;else{const T=v(i.material)?i.material.color:null,S=v(T)?Ze.toUnitRGBA(T):Lh;h.externalColor=S}this._fastUpdates=eM(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,b1)),h.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color")),de("enable-feature:objectAndLayerId-rendering")&&(h.instanced.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const m=new fy(h),y=z2e(e,m);if(!y)throw new Error(`Unknown object symbol primitive: ${e}`);const _=n$(y).map(T=>({opacity:1,transparent:T.parameters.transparent})),b=await this._createStageResources(y,p,r),x=await this._createLodRenderer(y,r);return new cle(y,x,b,_,n,l,c,s,o,a,p,b1)}async _createResourcesForUrl(e,r){const i=["transformation"],s={materialParamsMixin:{instanced:i,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=eM(this._context.renderer,this._fastVisualVariableConvertOptions(b1,b1,b1,b1)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color")),de("enable-feature:objectAndLayerId-rendering")&&(i.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const n=this.symbol;if(n.type==="point-3d"&&n.verticalOffset){const{screenLength:z,minWorldLength:B,maxWorldLength:G}=n.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:$o(z),minWorldLength:B||0,maxWorldLength:v(G)?G:1/0},s.materialParamsMixin.castShadows=!1}s.signal=r,s.usePBR=this._context.physicalBasedRenderingEnabled,s.skipHighLods=this._context.skipHighSymbolLods;const o=s.usePBR,a=await GEe(e,s),l=a.isEsriSymbolResource,c=a.isWosr,h=tht(a.lods);h.levels.sort((z,B)=>z.minScreenSpaceRadius-B.minScreenSpaceRadius);const p=this._context,f=this.symbolLayer.material,m=this._getExternalColorParameters(f),y=Js(this.symbolLayer,"material","color"),_=this._getCombinedOpacity(y,{hasIntrinsicColor:!0}),b=this.needsDrivenTransparentPass,x=n$(h),T=n$(h).map(z=>({opacity:z.parameters.opacity||1,transparent:z.parameters.transparent}));x.forEach(z=>{const B=z.parameters;z.setParameters(m);const G=B.opacity*_,K=G<1||b||B.transparent;z.setParameters({opacity:G,transparent:K}),p.screenSizePerspectiveEnabled&&z.setParameters({screenSizePerspective:p.sharedResources.screenSizePerspectiveSettings})});const S=a.referenceBoundingBox,E=Ul(FP(S)),O=Ul(h.levels[0].pivotOffset),R=Ul(NU(E,this.symbolLayer)),L=Me(R);tM(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(S,R,E,O))&&x.forEach(z=>z.setParameters(this._fastUpdates.materialParameters));const I=await this._createStageResources(h,o,r),U=await this._createLodRenderer(h,r);return new cle(h,U,I,T,E,l,c,S,R,L,o,O)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,r,i){const s=this._context.stage,n=n$(e);r!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(n),this._addDisposeResource(()=>s.removeMany(n));const o=$oe(e);s.addMany(o),this._addDisposeResource(()=>s.removeMany(o)),await s.load(o,i),ur(i);const a=Loe(e);return s.addMany(a),this._addDisposeResource(()=>s.removeMany(a)),{materials:n,textures:o,geometries:a}}async _createLodRenderer(e,r){const i=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:a=>this._instanceIndexToGraphicUid.get(a),notifyGraphicGeometryChanged:a=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(a)),notifyGraphicVisibilityChanged:a=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(a))},n=this._fastUpdates.enabled?{applyTransform:(a,l,c)=>{a.getFeatureAttribute(l,R$),kn(c,tq(this._fastUpdates.materialParameters,R$,c))},scaleFactor:(a,l,c)=>(l.getFeatureAttribute(c,R$),qct(a,this._fastUpdates.materialParameters,R$))}:null,o=new gh({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:n},this._context.scheduler);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{i.removeRenderPlugin(o),o.destroy()}),await i.addRenderPlugin(o.slots,o,r),o}_getExternalColorParameters(e){const r={};return this._drivenProperties.color?r.externalColor=Lh:v(e)&&v(e.color)?r.externalColor=Ze.toUnitRGBA(e.color):(r.externalColor=Lh,r.colorMixMode="ignore"),r}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry))return null;const i=Y3(r.geometry);if(C(i))return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const s=this.setGraphicElevationContext(r,new Ip),n=e.renderingInfo;return this._createAs3DShape(r,i,n,s,r.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(C(this._resources))return;const e=this._drivenProperties.opacity,r=!this._isPrimitive,i=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<i.length;n++){const o=i[n],a=Js(this.symbolLayer,"material","color"),l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:r})*l.opacity,h=c<1||e||l.transparent;o.setParameters({opacity:c,transparent:h}),this._isPrimitive&&o.setParameters({cullFace:h?Ei.None:Ei.Back})}}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,gv)}slicePlaneEnabledChanged(){if(C(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(C(this._resources))return!0;const{stageResources:e,isWosr:r}=this._resources;for(const i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):r||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this._hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this._hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!1}applyRendererDiff(e,r){if(C(this._resources))return Sn.Recreate_Symbol;const{stageResources:{materials:i},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in e.diff){if(c!=="visualVariables"||!tM(this._fastUpdates,r,this._fastVisualVariableConvertOptions(n,o,a,l)))return Sn.Recreate_Symbol;for(const h of i)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return Sn.Fast_Update}computeComplexity(){if(C(this._resources))return super.computeComplexity();const e=this._resources.lodResources,r=k2e(e.levels[0]).reduce((n,o)=>n+o.indices.get(A.POSITION).length,0)/3,i=n=>Array.from(n.vertexAttributes.values()).reduce((o,a)=>{var l;return o+(((l=a.data.buffer)==null?void 0:l.byteLength)??0)},0)+Array.from(n.indices.values()).reduce((o,a)=>o+(Array.isArray(a)?12*a.length:a.buffer.byteLength),0),s=$oe(e).reduce((n,o)=>n+(o.params.encoding&&o.params.encoding==="image/ktx2"?o.estimatedTexMemRequired:o.estimatedTexMemRequired/4),0)+Loe(e).reduce((n,o)=>n+i(o),0);return{primitivesPerFeature:r,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:{...j2e(this.symbol,this.symbolLayer),resourceBytes:s}}}_hasLodRenderer(){return v(this._resources)}_createAs3DShape(e,r,i,s,n,o){if(!this._hasLodRenderer()||C(this._resources))return null;const a=this.getFastUpdateAttrValues(e),l=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?zO(i.color,i.opacity):null,c=this._context.clippingExtent;if(ta(r,iT,this._context.elevationProvider.spatialReference),v(c)&&!zX(c,iT))return null;const h=this._requiresTerrainElevation(s),p=this._computeGlobalTransform(r,s,TV,O$),f=this._computeLocalTransform(this._resources,this.symbolLayer,i,ule),m=this._resources.lodRenderer.instanceData,y=m.addInstance();this._instanceIndexToGraphicUid.set(y,n),m.setLocalTransform(y,f,!1),m.setGlobalTransform(y,p),a&&m.setFeatureAttribute(y,a),l&&m.setColor(y,l),v(this._context.stage.renderView.objectAndLayerIdRenderHelper)&&m.setObjectAndLayerIdColor(y,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:n,layerUid:o}));const _=new Kut(this,y,not,s);return h&&(_.alignedSampledElevation=O$.sampledElevation),_.needsElevationUpdates=gv(s.mode),X3(_,r,this._context.elevationProvider),_}_computeGlobalTransform(e,r,i,s){return fC(e,this._context.elevationProvider,r,this._context.renderCoordsHelper,s),iT[0]=e.x,iT[1]=e.y,iT[2]=s.z,xp(e.spatialReference,iT,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,r,i,s){return Wh(s),this._applyObjectRotation(i,!1,s),this._applyObjectRotation(r,!0,s),this._applyObjectScale(e,i,s),this._applyAnchor(e,r,s),s}_applyObjectScale(e,r,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&r.size?r.size:e.symbolSize,n=Poe(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||t5(i,i,n)}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;const r=e.diff.diff;this._preparePatchTransform(e,r),this._preparePatchColor(e,r)}updateGeometry(e,r){if(C(this._resources))return!0;const i=r&&Y3(r);if(C(i))return!1;const s=this.getGeometryElevationMode(r);return e.elevationContext.mode===s&&(this._computeGlobalTransform(i,e.elevationContext,TV,O$),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=O$.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,TV,!0),X3(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,r){if(!(r.heading||r.tilt||r.roll||r.width||r.height||r.depth||r.anchor||r.anchorPosition)||C(this._resources))return;const i=(y,_,b)=>It(y!=null&&y.type==="complete"?y.newValue:_,b),s=i(r.heading,this.symbolLayer.heading,0),n=i(r.tilt,this.symbolLayer.tilt,0),o=i(r.roll,this.symbolLayer.roll,0),a=i(r.width,this.symbolLayer.width,void 0),l=i(r.height,this.symbolLayer.height,void 0),c=i(r.depth,this.symbolLayer.depth,void 0),h=i(r.anchor,this.symbolLayer.anchor,void 0),p=i(r.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete r.heading,delete r.tilt,delete r.roll,delete r.width,delete r.height,delete r.depth,delete r.anchor,delete r.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},m=this._resources;this.loadStatus===wu.LOADED&&e.symbolLayerStatePatches.push(()=>{m.symbolSize=Ul(NU(m.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((y,_)=>{const b=this._computeLocalTransform(m,f,_,ule),x=y.instanceIndex;m.lodRenderer.instanceData.setLocalTransform(x,b,!0)})}_preparePatchColor(e,r){if(!r.material||r.material.type!=="partial")return;const i=r.material.diff;if(!i.color||i.color.type!=="complete"||i.color.newValue==null||i.color.oldValue==null)return;const s=i.color.newValue,n=v(s)?Ze.toUnitRGBA(s):Lh;delete i.color;const o=this._resources;C(o)||e.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(e){return e.mode!=="absolute-height"}_applyObjectRotation(e,r,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&r))return Xnt(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,r,i){const s=M();switch(i.anchor){case"center":le(s,np(e)),xa(s,s);break;case"top":{const n=np(e);ce(s,-n[0],-n[1],-e[5]);break}case"bottom":{const n=np(e);ce(s,-n[0],-n[1],-e[2]);break}case"relative":{const n=np(e),o=FP(e),a=i.anchorPosition,l=a?$e(a.x,a.y,a.z):wa;Q4(s,o,l),me(s,s,n),xa(s,s);break}default:v(r)?xa(s,r):le(s,wa)}return s}_applyAnchor(e,r,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,r);s&&ql(i,i,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,r,i,s){const n=v(e)?Ul(FP(e)):Gf,o=v(e)?this._computeAnchor(e,s,this.symbolLayer):wa,a=this._context.renderCoordsHelper.unitInMeters,l=Poe(v(r)?r:void 0,r,i,a),c=$e(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:v(r)?r:Gf,unitInMeters:a,transformation:{anchor:o,scale:l,rotation:c}}}};const iT=M(),ule=Ie(),TV=Ie(),R$=nr(),O$=new lP;function mdt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function gdt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function lq(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t}function ydt(t,e){if(t===e){const r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function _dt(t,e){const r=e[0],i=e[1],s=e[2],n=e[3];let o=r*n-s*i;return o?(o=1/o,t[0]=n*o,t[1]=-i*o,t[2]=-s*o,t[3]=r*o,t):null}function vdt(t,e){const r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t}function bdt(t){return t[0]*t[3]-t[2]*t[1]}function WEe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1],c=r[2],h=r[3];return t[0]=i*a+n*l,t[1]=s*a+o*l,t[2]=i*c+n*h,t[3]=s*c+o*h,t}function wdt(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+n*a,t[1]=s*l+o*a,t[2]=i*-a+n*l,t[3]=s*-a+o*l,t}function xdt(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1];return t[0]=i*a,t[1]=s*a,t[2]=n*l,t[3]=o*l,t}function Tdt(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t}function Sdt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function Edt(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function Cdt(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)}function Adt(t,e,r,i){return t[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-t[2]*r[1],[t,e,r]}function Rdt(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function XEe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function Odt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Mdt(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3],h=Oa();return Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))}function Pdt(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function Idt(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t}const $dt=WEe,Ldt=XEe;Object.freeze(Object.defineProperty({__proto__:null,LDU:Adt,add:Rdt,adjoint:vdt,copy:mdt,determinant:bdt,equals:Mdt,exactEquals:Odt,frob:Cdt,fromRotation:Tdt,fromScaling:Sdt,identity:gdt,invert:_dt,mul:$dt,multiply:WEe,multiplyScalar:Pdt,multiplyScalarAndAdd:Idt,rotate:wdt,scale:xdt,set:lq,str:Edt,sub:Ldt,subtract:XEe,transpose:ydt},Symbol.toStringTag,{value:"Module"}));let Ddt=class extends ln{constructor(e,r,i,s,n,o,a,l){super(e,r,i,null,$s.Mesh,l),this.path=s,this.geometrySR=n,this.upVectorAlignment=o,this.stencilWidth=a}};var Z_;function YEe(t){return"upVectorAlignment"in t}(function(t){t[t.World=0]="World",t[t.Path=1]="Path"})(Z_||(Z_={}));function ZEe(){return[1,0,0,1]}function Ndt(t){return[t[0],t[1],t[2],t[3]]}function Fdt(t,e,r,i){return[t,e,r,i]}function Udt(t,e){return new Float64Array(t,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:Ndt,create:ZEe,createView:Udt,fromValues:Fdt},Symbol.toStringTag,{value:"Module"}));function JEe(){return{up:M(),right:M()}}function Vdt(t,e,r){Xe(t.up,e.up,r),Xe(t.right,e.right,r)}function kdt(t,e,r){ar(t,_e(r,e.right),_e(r,e.up))}let zdt=class{constructor(){this.pos=M(),this.posES=M(),this.vLeft=M(),this.vRight=M(),this.vMinSiblingLength=0,this.frame=JEe(),this.rotationFrameUp=M(),this.rotationRight=Ke(),this.rotationAngle=0,this.miterStretch=ZEe(),this.maxStretchDistance=0}setFrameFromUpVector(e){le(this.frame.up,e),me(T2,this.vLeft,this.vRight),ve(T2,T2),ae(cq,this.frame.up,_e(T2,this.frame.up)),ge(P$,T2,cq),ve(P$,P$),pt(this.frame.right,P$,this.frame.up)}},KEe=class{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[]}addVertex(e,r){return this.vertices.push(cR(e)),this.vertexNormals.push(cR(r)),this.vertices.length-1}addPole(e,r=null){return this.poles.push({position:cR(e),normal:r?cR(r):null}),this.poles.length-1}addSegment(e,r=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.vertexIndices.length/2}translate(e,r){for(const i of this.vertices)i[0]+=e,i[1]+=r;for(const i of this.poles)i.position[0]+=e,i.position[1]+=r}};function Bdt(t=20){const r=new KEe,i={v0:0,v1:0};r.addPole(Fr(0,0));for(let n=0;n<t;++n){const o=2*n*Math.PI/t,a=Math.cos(o),l=Math.sin(o),c=Fr(a*.5,l*.5),h=Fr(a,l);r.addVertex(c,h)}for(let n=0;n<t-1;++n){const o={v0:n,v1:n+1};r.addSegment(o,i)}const s={v0:t-1,v1:0};return r.addSegment(s,i),r}function Gdt(){const r=new KEe,i=Fr(.5*-1,.5*-1),s=Fr(.5*1,.5*-1),n=Fr(.5*1,.5*1),o=Fr(.5*-1,.5*1),a=Fr(0,-1),l=Fr(1,0),c=Fr(0,1),h=Fr(-1,0);return r.addPole(Fr(0,.5*1),c),r.addPole(Fr(0,.5*1)),r.addPole(Fr(0,.5*-1)),r.addPole(Fr(0,.5*-1),a),r.addVertex(i,a),r.addVertex(s,a),r.addSegment({v0:0,v1:1},{v0:3,v1:3}),r.addVertex(s,l),r.addVertex(n,l),r.addSegment({v0:2,v1:3},{v0:2,v1:1}),r.addVertex(n,c),r.addVertex(o,c),r.addSegment({v0:4,v1:5},{v0:0,v1:0}),r.addVertex(o,h),r.addVertex(i,h),r.addSegment({v0:6,v1:7},{v0:1,v1:2}),r}let jdt=class{constructor(e){this.vertices=e,this.offset=M(),this.xform=Ie();const r=Math.floor((e.length-1)/2);le(this.offset,this.vertices[r].pos);for(const i of this.vertices)ge(i.pos,i.pos,this.offset);ql(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length,r=this.vertices[0];r.index=0,r.vLeft=M(),ge(r.vRight,this.vertices[1].pos,r.pos);let i=Me(r.vRight);r.vMinSiblingLength=i,ve(r.vRight,r.vRight);let s=r;for(let n=1;n<e;++n){const o=this.vertices[n];if(o.index=n,o.vLeft=s.vRight,n<e-1){ge(o.vRight,this.vertices[n+1].pos,o.pos);const a=Me(o.vRight);o.vMinSiblingLength=Math.min(i,a),i=a,ve(o.vRight,o.vRight)}else le(o.vRight,o.vLeft),o.vMinSiblingLength=i;s=o}}};function Hdt(t,e){let r=null;const i=t.vertices.length,s=.99619469809,n=M(),o=M(),a=M(),l=M(),c=M(),h=M(),p=Br();let f=t.vertices[0];le(o,e),ce(n,0,1,0),QF(f.vRight,o,n,n,a,o,s),le(f.frame.up,o),le(f.frame.right,a),r=f;for(let m=1;m<i;++m){f=t.vertices[m],me(c,f.vLeft,f.vRight);let y=Me(c);y>0?(y=1/Math.sqrt(y),c[0]=c[0]*y,c[1]=c[1]*y,c[2]=c[2]*y):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),me(h,r.pos,r.frame.up),UM(f.pos,c,p),ax(p,Vu(h,f.vLeft),l)?(ge(l,l,f.pos),ve(o,l),pt(a,c,o),ve(a,a)):QF(c,r.frame.up,r.frame.right,n,a,o,s),le(f.frame.up,o),le(f.frame.right,a),r=f}}let qdt=class{numProfilesPerJoin(){return 1}extrude(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.index,e.frame,r.vertices[s],r.vertexNormals[s],!1)}},SV=class{constructor(e=.8*Math.PI,r=1){this.cutoffAngle=e,this.numBendSubdivisions=r}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,r,i){const s=Qdt;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){Fu(ple,.5*-e.rotationAngle+n*e.rotationAngle/this.numBendSubdivisions,e.rotationFrameUp),Vdt(s,e.frame,ple);for(let o=0;o<r.vertices.length;++o)gn(r.vertices[o],e.rotationRight)*e.rotationAngle>=0?i(e.index,s,r.vertices[o],r.vertexNormals[o],!1):(Mj(Kb,r.vertices[o],e.miterStretch),i(e.index,e.frame,Kb,r.vertexNormals[o],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let o=0;o<r.vertices.length;++o){const a=gn(r.vertices[o],e.rotationRight)*e.rotationAngle>=0;Mj(Kb,r.vertices[o],e.miterStretch),i(e.index,e.frame,Kb,r.vertexNormals[o],!a)}}},gK=class{rebuildConnectingProfileGeometry(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.index,e.frame,r.vertices[s],r.vertexNormals[s],0,0)}},hle=class extends gK{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}},M$=class extends gK{constructor(e,r=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=r,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.index,e.frame,r.vertices[s],r.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(e,r){const i=yK;ar(i,0,0);const s=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)r(e.index,e.frame,this.profile.vertices[n],i,this.profilePlaneOffset,s)}buildTopology(e,r){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const n=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],a=this.vertexBufferStart+n,l=this.vertexBufferStart+o;this.flip?r(l,a,i):r(i,a,l)}}},dle=class extends gK{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let r=0;r<this.profile.numSegments;++r){const i=this.profile.vertexIndices[2*r+0],s=this.profile.vertexIndices[2*r+1];this.profile.poleIndices[i]===this.profile.poleIndices[s]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,r){const i=e.frame,s=.5*this.sign,n=Kb,o=yK;ar(o,0,0);for(let a=0;a<this.profile.poles.length;++a){const l=this.profile.poles[a];l.normal?r(e.index,i,l.position,l.normal,s,0):r(e.index,i,l.position,o,s,this.sign)}if(this.breakNormals)for(let a=0;a<this.profile.vertices.length;++a)r(e.index,i,this.profile.vertices[a],this.profile.vertexNormals[a],0,0);for(let a=0;a<this.numSegments-1;++a){const l=(1-(a+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let p=0;p<this.profile.vertices.length;++p){const f=this.profile.poles[this.profile.poleIndices[p]];Vf(n,this.profile.vertices[p],f.position),Cc(n,n,c),f.normal?(Xd(n,n,f.position),r(e.index,i,n,f.normal,s*h,0)):(L3(o,n),Cc(o,o,c),Xd(n,n,f.position),r(e.index,i,n,o,s*h,this.sign*h))}}}buildTopology(e,r){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const o=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],l=this.vertexBufferStart+this.profile.poleIndices[o],c=this.vertexBufferStart+this.profile.poleIndices[a];let h=i+o,p=i+a;for(let f=0;f<this.numSegments-1;++f){const m=s+f*this.profile.vertices.length+o,y=s+f*this.profile.vertices.length+a;this.flip?(r(m,p,h),r(p,m,y)):(r(h,p,m),r(y,m,p)),h=m,p=y}this.flip?(r(l,p,h),l!==c&&r(l,c,p)):(r(h,p,l),l!==c&&r(p,c,l))}}},Wdt=class{constructor(e,r,i,s,n,o={}){this.options=o,this._extrusionVertexCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.profile=r,this.path=e,this.extruder=i,this.startCap=s,this.endCap=n;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=r.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=Ys(1*this.numVerticesTotal),this.profileRightAxisData=Ys(4*this.numVerticesTotal),this.profileUpAxisData=Ys(4*this.numVerticesTotal),this.profileVertexAndNormalData=Ys(4*this.numVerticesTotal),this.originData=Ys(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(e,r,i,s,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=r.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=r.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=r.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=r.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=r.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=r.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,n){const o=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[0]*o.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[1]*o.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,r,i,s,n,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=r.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=r.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=r.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=r.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=r.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=r.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount}_rebuildGeometry(){const e=(i,s,n,o,a)=>this.emitVertex(i,s,n,o,a),r=(i,s,n,o,a,l)=>this.emitCapVertex(i,s,n,o,a,l);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,r);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,e);this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,r),this.startCap.rebuildCapGeometry(this.path.vertices[0],r),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],r)}buildTopology(){const e=this.profile.vertices.length,r=this.profile.numSegments,i=this.numExtrusionProfiles-1;let s=3*(2*(r*i));this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const n=new Array,o=new Array,a=new Array,l=(c,h,p)=>{n.push(c),n.push(h),n.push(p),o.push(c),o.push(h),o.push(p),a.push(this.pathVertexData[c]),a.push(this.pathVertexData[h]),a.push(this.pathVertexData[p])};for(let c=0;c<r;++c){const h=this.profile.vertexIndices[2*c],p=this.profile.vertexIndices[2*c+1];for(let f=0;f<i;++f){const m=f*e+h,y=(f+1)*e+p,_=f*e+p;l(m,(f+1)*e+h,y),l(m,y,_)}}this.startCap.buildTopology(this.path.vertices[0],l),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],l),this.vertexIndices=xS(n),this.normalIndices=xS(o),this.pathVertexIndices=xS(a)}onPathChanged(){this._rebuildGeometry()}},QEe=class{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}},eCe=class extends QEe{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=Ys(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=Ys(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let r=0;r<this.builder.numVerticesTotal;++r){let i=this.builder.pathVertexData[r];const s=i===0||i===this.builder.path.vertices.length-1;i*=3;const n=Ydt;ce(n,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const o=4*r,a=cq,l=Kb,c=T2,h=Jdt,p=Kdt;let f=0,m=0;if(ce(h,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),ce(p,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),ar(l,this.builder.profileVertexAndNormalData[o]*e[0],this.builder.profileVertexAndNormalData[o+1]*e[1]),s)pt(c,p,h),f=this.builder.profileRightAxisData[o+3]*e[0],m=this.builder.profileUpAxisData[o+3];else{const _=yK,b=Zdt;ar(_,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const x=$Z(_);L3(_,_);const T=gn(l,_);if(Math.abs(T)>x){ar(b,-_[1],_[0]);const S=gn(l,b);Cc(_,_,x*Math.sign(T)),Cc(b,b,S),Xd(l,_,b)}ce(c,0,0,0)}ce(a,h[0]*l[0]+p[0]*l[1],h[1]*l[0]+p[1]*l[1],h[2]*l[0]+p[2]*l[1]),this.vertexAttributePosition[3*r+0]=n[0]+a[0]+c[0]*f,this.vertexAttributePosition[3*r+1]=n[1]+a[1]+c[1]*f,this.vertexAttributePosition[3*r+2]=n[2]+a[2]+c[2]*f;const y=Kb;ar(y,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*r+0]=h[0]*y[0]+p[0]*y[1]+c[0]*m,this.vertexAttributeNormal[3*r+1]=h[1]*y[0]+p[1]*y[1]+c[1]*m,this.vertexAttributeNormal[3*r+2]=h[2]*y[0]+p[2]*y[1]+c[2]*m}}createGeometryData(){const e=[[A.POSITION,this.builder.vertexIndices],[A.NORMAL,this.builder.normalIndices]],r=[[A.POSITION,new Ye(this.vertexAttributePosition,3,!0)],[A.NORMAL,new Ye(this.vertexAttributeNormal,3,!0)]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;e.push([A.COLOR,new Array(i).fill(0)]),r.push([A.COLOR,new Ye(this.vertexAttributeColor,4)])}return{vertexAttributes:r,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,r,i){const s=this.builder.vertexIndices,n=new Ye(this.vertexAttributePosition,3),o=s.length/3;nP(e,r,0,o,s,n,void 0,void 0,i)}},Xdt=class extends QEe{constructor(e,r,i,s){super(e),this.sizeAttributeValue=r,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new eCe(e),this.vvData=Ys(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=r,this.vvData[4*n+1]=i,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return{vertexAttributes:[[A.POSITION,new Ye(this.builder.originData,3,!0)],[A.PROFILERIGHT,new Ye(this.builder.profileRightAxisData,4,!0)],[A.PROFILEUP,new Ye(this.builder.profileUpAxisData,4,!0)],[A.PROFILEVERTEXANDNORMAL,new Ye(this.builder.profileVertexAndNormalData,4,!0)],[A.FEATUREVALUE,new Ye(this.vvData,4,!0)]],indices:[[A.POSITION,this.builder.pathVertexIndices],[A.PROFILERIGHT,this.builder.vertexIndices],[A.PROFILEUP,this.builder.vertexIndices],[A.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[A.FEATUREVALUE,this.builder.pathVertexIndices]]}}};const Ydt=M(),Kb=Ke(),yK=Ke(),Zdt=Ke(),cq=M(),T2=M(),Jdt=M(),Kdt=M(),P$=M(),Qdt=JEe(),ple=Ie(),EV=8;function ept(t,e){const r=A.FEATUREVALUE;t.attributes.add(r,"vec4");const i=t.vertex;i.code.add(w`
  bool isCapVertex() {
    return ${r}.w == 1.0;
  }
  `),i.uniforms.add(new Ur("size",s=>s.size)),e.vvSize?(i.uniforms.add(new Wt("vvSizeMinSize",s=>s.vvSizeMinSize)),i.uniforms.add(new Wt("vvSizeMaxSize",s=>s.vvSizeMaxSize)),i.uniforms.add(new Wt("vvSizeOffset",s=>s.vvSizeOffset)),i.uniforms.add(new Wt("vvSizeFactor",s=>s.vvSizeFactor)),i.code.add(w`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${r}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):i.code.add(w`vec2 getSize(){
return size;
}`),e.vvOpacity?(i.constants.add("vvOpacityNumber","int",EV),i.uniforms.add([new ya("vvOpacityValues",s=>s.vvOpacityValues,EV),new ya("vvOpacityOpacities",s=>s.vvOpacityOpacities,EV)]),i.code.add(w`
    vec4 applyOpacity(vec4 color) {
      float value = ${r}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):i.code.add(w`vec4 applyOpacity(vec4 color){
return color;
}`),e.vvColor?(i.constants.add("vvColorNumber","int",gp),i.uniforms.add([new ya("vvColorValues",s=>s.vvColorValues,gp),new R6("vvColorColors",s=>s.vvColorColors,gp)]),i.code.add(w`
    vec4 getColor() {
      float value = ${r}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):i.code.add(w`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),t.include(eP),t.attributes.add(A.PROFILERIGHT,"vec4"),t.attributes.add(A.PROFILEUP,"vec4"),t.attributes.add(A.PROFILEVERTEXANDNORMAL,"vec4"),i.code.add(w`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),i.code.add(w`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),i.code.add(w`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),i.code.add(w`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}let tpt=class extends FJ{constructor(){super(...arguments),this.size=Fr(1,1)}};function rpt(t){const e=new Lr,{vertex:r,fragment:i}=e;switch(Nc(r,t),e.varyings.add("vpos","vec3"),e.include(ept,t),t.output!==V.Color&&t.output!==V.Alpha||(e.include(Gl,t),e.include(Xw,t),e.include(cC,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vcolor","vec4"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.code.add(w`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${t.output===V.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.include(zu,t),t.output){case V.Alpha:e.include(Zs,t),i.uniforms.add(new Pe("opacity",s=>s.opacity)),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `);break;case V.Color:e.include(Zs,t),e.include(Yw,t),e.include(pP,t),e.include(Xw,t),e.include(KSe,t),Cp(i,t),fP(i),gC(i),i.uniforms.add([r.uniforms.get("localOrigin"),new Wt("ambient",s=>s.ambient),new Wt("diffuse",s=>s.diffuse),new Wt("specular",s=>s.specular),new Pe("opacity",s=>s.opacity)]),i.include(Am),Cm(i),i.code.add(w`
        void main() {
          discardBySlice(vpos);
          ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          gl_FragColor = vec4(shadedColor, combinedOpacity);
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
          ${t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
        }
      `);break;case V.Depth:case V.Shadow:case V.ShadowHighlight:case V.ShadowExcludeHighlight:e.include(Gl,t),jw(e),e.varyings.add("depth","float"),r.code.add(w`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),e.include(Zs,t),e.include(py,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case V.Normal:e.include(Gl,t),e.include(K3,t),OE(r),e.varyings.add("vnormal","vec3"),r.code.add(w`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Zs,t),i.code.add(w`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case V.Highlight:e.include(Gl,t),e.include(K3,t),e.varyings.add("vnormal","vec3"),r.code.add(w`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Zs,t),e.include(Ry,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const ipt=Object.freeze(Object.defineProperty({__proto__:null,build:rpt},Symbol.toStringTag,{value:"Module"})),tCe=new Map([[A.POSITION,0],[A.PROFILERIGHT,1],[A.PROFILEUP,2],[A.PROFILEVERTEXANDNORMAL,3],[A.FEATUREVALUE,4]]);let spt=class extends tpt{constructor(){super(...arguments),this.ambient=$e(.2,.2,.2),this.diffuse=$e(.8,.8,.8),this.specular=$e(0,0,0),this.opacity=1}},rCe=class iCe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Nr(e.rctx,iCe.shader.get().build(this.configuration),tCe)}initializePipeline(){const e=this.configuration.transparencyPassType,r=this.configuration,i=e===Tt.NONE,s=e===Tt.FrontFace;return zt({blending:r.output!==V.Color&&r.output!==V.Alpha||!r.transparent?null:i?Du:Oy(e),culling:r.hasSlicePlane&&!r.transparent&&r.doubleSidedMode!==hs.None?hwe:null,depthTest:{func:Iv(e)},depthWrite:i||s?Yl:null,colorWrite:Qt,stencilWrite:r.hasOccludees?vm:null,stencilTest:r.hasOccludees?$v:null,polygonOffset:i||s?null:P6})}};rCe.shader=new Dr(ipt,()=>ie(()=>import("./Path.glsl-2eeb3920.js"),[],import.meta.url));let Yn=class extends io{constructor(){super(...arguments),this.output=V.Color,this.doubleSidedMode=hs.None,this.transparencyPassType=Tt.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}};u([k({count:V.COUNT})],Yn.prototype,"output",void 0),u([k({count:hs.COUNT})],Yn.prototype,"doubleSidedMode",void 0),u([k({count:Tt.COUNT})],Yn.prototype,"transparencyPassType",void 0),u([k()],Yn.prototype,"spherical",void 0),u([k()],Yn.prototype,"receiveShadows",void 0),u([k()],Yn.prototype,"receiveAmbientOcclusion",void 0),u([k()],Yn.prototype,"vvSize",void 0),u([k()],Yn.prototype,"vvColor",void 0),u([k()],Yn.prototype,"vvOpacity",void 0),u([k()],Yn.prototype,"hasSlicePlane",void 0),u([k()],Yn.prototype,"transparent",void 0),u([k()],Yn.prototype,"hasOccludees",void 0),u([k()],Yn.prototype,"hasMultipassTerrain",void 0),u([k()],Yn.prototype,"cullAboveGround",void 0),u([k()],Yn.prototype,"doublePrecisionRequiresObfuscation",void 0),u([k({constValue:dt.Disabled})],Yn.prototype,"pbrMode",void 0),u([k({constValue:!0})],Yn.prototype,"hasVvInstancing",void 0),u([k({constValue:!1})],Yn.prototype,"useCustomDTRExponentForWater",void 0),u([k({constValue:!1})],Yn.prototype,"useFillLights",void 0);let npt=class sCe extends Pv{constructor(e){super(e,new apt),this.supportsEdges=!0,this._vertexAttributeLocations=tCe,this._configuration=new Yn,this._vertexBufferLayout=sCe.getVertexBufferLayout()}getConfiguration(e,r){return this._configuration.output=e,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==V.Color&&e!==V.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?hs.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?hs.WindingOrder:hs.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!r.ssaoHelper.active&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==V.Shadow&&e!==V.ShadowExcludeHighlight&&e!==V.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,r,i,s,n,o){const a=e;if(!YEe(a))return;const l=a.path,c=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const b=this.parameters.vvSizeOffset,x=this.parameters.vvSizeFactor,T=this.parameters.vvSizeMinSize,S=this.parameters.vvSizeMaxSize,E=l.sizeAttributeValue;c[0]*=ye(b[0]+E*x[0],T[0],S[0]),c[1]*=ye(b[2]+E*x[2],T[2],S[2])}const h=Math.max(c[0],c[1]),p=e.boundingInfo;if(C(p))return void this._intersectTriangles(l,c,s,n,o);const f=Pw(p.bbMin[0]-h,p.bbMin[1]-h,p.bbMin[2]-h,p.bbMax[0]+h,p.bbMax[1]+h,p.bbMax[2]+h),m=[n[0]-s[0],n[1]-s[1],n[2]-s[2]],y=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),_=[y/m[0],y/m[1],y/m[2]];OJ(f,s,_,i.tolerance)&&this._intersectTriangles(l,c,s,n,o)}_intersectTriangles(e,r,i,s,n){e.baked.size&&e.baked.size[0]===r[0]&&e.baked.size[1]===r[1]||e.baked.bake(r),e.baked.intersect(i,s,n)}createBufferWriter(){return new mC(this._vertexBufferLayout)}requiresSlot(e,r){switch(r){case V.Shadow:case V.ShadowHighlight:case V.ShadowExcludeHighlight:if(!this.parameters.castShadows)return!1;case V.Color:case V.Alpha:case V.Depth:case V.Normal:case V.Highlight:case V.ObjectAndLayerIdColor:return e===(this.parameters.transparent?Se.TRANSPARENT_MATERIAL:Se.OPAQUE_MATERIAL)||e===Se.DRAPED_MATERIAL;default:return!1}}createGLMaterial(e){return new opt(e)}static getVertexBufferLayout(){return is().vec3f(A.POSITION).vec4f(A.PROFILERIGHT).vec4f(A.PROFILEUP).vec4f(A.PROFILEVERTEXANDNORMAL).vec4f(A.FEATUREVALUE)}},opt=class extends Mv{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){(C(this.technique)||e.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output!==V.Color&&this._output!==V.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(rCe,e)}},apt=class extends spt{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}};const lpt=["polyline"];let cpt=class extends Mm{constructor(e,r,i,s){super(e,r,i,s),this._intrinsicSize=Fr(1,1),this._upVectorAlignment=Z_.Path,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=v(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,r=v(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=eM(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this._upVectorAlignment=this.symbolLayer.profileRotation==="heading"?Z_.World:Z_.Path;const s=this.symbolLayer.profile||"circle";switch(s){default:case"circle":this._profile=Bdt(U2e);break;case"quad":this._profile=Gdt()}let n=[0,0];switch(i!=="center"&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(n[0],n[1])),this.symbolLayer.join){case"round":this._extruder=new SV(0,F2e);break;case"bevel":this._extruder=new SV(0,1);break;case"miter":this._extruder=new SV(.8*Math.PI,1);break;default:this._extruder=new qdt}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new hle,this._endCap=new hle;break;case"butt":default:this._startCap=new M$(this._profile,0),this._endCap=new M$(this._profile,0,!0);break;case"square":this._startCap=new M$(this._profile,-.5),this._endCap=new M$(this._profile,.5,!0);break;case"round":{const m=s==="quad";this._startCap=new dle({profile:this._profile,flip:!1,breakNormals:m,subdivisions:jH}),this._endCap=new dle({profile:this._profile,flip:!0,breakNormals:m,subdivisions:jH});break}}const a=Js(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a),c=Ul(l),h=l[3],p=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:p,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:p||o==="none"?Ei.None:Ei.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(ar(this._intrinsicSize,e,r),!p4(this._intrinsicSize[0])||!p4(this._intrinsicSize[1])))throw new j("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||Cc(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled){const m={...f,...this._fastUpdates.materialParameters,size:tye(this._intrinsicSize)};this._material=new npt(m)}else f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new fy(f);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,lpt,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Ip),s=e.renderingInfo;return this._createAs3DShape(r,s,i,r.uid)}layerOpacityChanged(){const e=Js(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(e),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:i})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,gv)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!tM(this._fastUpdates,r,this._vvConvertOptions))return Sn.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return Sn.Fast_Update}_getVertexData(e){let r=0;const i=e.paths,s=[],n=e.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const f of i)r+=f.length;const l=Bc(3*r),c=Bc(3*r);let h=0;for(const f of i){s.push({index:h,numVertices:f.length});for(const m of f)l[h++]=m[0],l[h++]=m[1],l[h++]=e.hasZ?m[2]:0}let p=!0;return v(o)&&!n.equals(o)&&(p=vs(l,n,0,l,o,0,r)),v(o)&&!o.equals(a)?vs(l,o,0,c,a,0,r):this._copyVertices(l,0,c,0,r),{pathVertexDataInfos:s,vertexDataES:l,vertexDataRS:c,projectionSuccess:p,terrainElevation:0}}_copyVertices(e,r,i,s,n){r*=3,s*=3;for(let o=0;o<n;++o)i[s++]=e[r++],i[s++]=e[r++],i[s++]=e[r++]}_createAs3DShape(e,r,i,s){const n=e.geometry,o=new Array,a=n.spatialReference,l=Rn(),c=this._context.renderCoordsHelper;oCe.spatialReference=a;const h=this._getVertexData(n);if(!h.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(h.pathVertexDataInfos.length===0)return n.paths.length!==0&&n.paths.some(y=>y.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;for(const y of h.pathVertexDataInfos){const _=y.index,b=y.numVertices;if(b<2||v(this._context.clippingExtent)&&(Mi(l),Ou(l,h.vertexDataES,3*_,b),!op(l,this._context.clippingExtent)))continue;const x=[];for(let U=_;U<_+3*b;){const z=U++,B=U++,G=U++,K=new zdt;ce(K.posES,h.vertexDataES[z],h.vertexDataES[B],h.vertexDataES[G]);const re=Ynt(K.posES,this._context.elevationProvider,i,c);ce(zi,h.vertexDataRS[z],h.vertexDataRS[B],h.vertexDataRS[G]),c.setAltitude(zi,re),le(K.pos,zi),x.push(K)}const T=new jdt(x);nCe(T,this._upVectorAlignment,this._context.renderCoordsHelper);const S=new Wdt(T,this._profile,this._extruder,this._startCap,this._endCap);let E=null;if(this._fastUpdates.enabled){const U=this._fastUpdates.visualVariables,z=U.size?Jg(U.size.field,e):0,B=U.color?Jg(U.color.field,e):0,G=U.opacity?Jg(U.opacity.field,e):0;E=new Xdt(S,z,B,G)}else{const U=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const G=r.size;U[0]*=fle(G[0],G[2]==="symbol-value"?this.symbolLayer.height||0:G[2],this.symbolLayer.width||0),U[1]*=fle(G[2],G[0]==="symbol-value"?this.symbolLayer.width||0:G[0],this.symbolLayer.height||0)}let z;this._drivenProperties.color&&(z=r.color),this._drivenProperties.opacity&&r.opacity!=null&&(z=z?[z[0],z[1],z[2],r.opacity]:[1,1,1,r.opacity]);const B=new eCe(S);B.bake(U),z&&B.bakeVertexColors(z),E=B}const{vertexAttributes:O,indices:R}=E.createGeometryData(),L=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),I=new Ddt(this._material,O,R,E,a,this._upVectorAlignment,this._stencilWidth,L);I.transformation=E.xform,o.push(I)}if(o.length===0)return null;const p={layerUid:this._context.layer.uid,graphicUid:s},f=new Py({geometries:o,metadata:p}),m=new Om(this,f,o,null,null,hpt,i);return m.alignedSampledElevation=h.terrainElevation,m.needsElevationUpdates=gv(i.mode),m}};function nCe(t,e,r){switch(e){default:case Z_.World:for(const i of t.vertices){me(zi,i.pos,t.offset),r.worldUpAtPosition(zi,zi),i.setFrameFromUpVector(zi),i.rotationFrameUp=i.frame.up,ar(i.rotationRight,1,0),ae(zi,i.frame.up,_e(i.frame.up,i.vLeft)),ge(zi,i.vLeft,zi),xa(zi,zi),ve(zi,zi),ae(a0,i.frame.up,_e(i.frame.up,i.vRight)),ge(a0,i.vRight,a0),ve(a0,a0),pt(mle,i.rotationFrameUp,i.vLeft);const s=Math.sign(_e(mle,i.vRight));if(i.rotationAngle=s*(Math.PI-An(_e(zi,a0))),Math.abs(i.rotationAngle)>0){const o=bU(Math.cos(.5*i.rotationAngle));lq(i.miterStretch,o-1+1,0,0,1)}const n=Math.PI-i.rotationAngle;i.maxStretchDistance=Math.abs(i.vMinSiblingLength/Math.cos(.5*n))}break;case Z_.Path:me(zi,t.vertices[0].pos,t.offset),r.worldUpAtPosition(zi,zi),Hdt(t,zi);for(const i of t.vertices){const s=Math.sign(_e(i.frame.right,i.vRight));pt(i.rotationFrameUp,i.vRight,i.vLeft),ae(i.rotationFrameUp,i.rotationFrameUp,s),ve(i.rotationFrameUp,i.rotationFrameUp);const n=_e(i.rotationFrameUp,i.frame.up),o=_e(i.rotationFrameUp,i.frame.right);if(ae(zi,i.frame.up,-o),ae(a0,i.frame.right,n),me(zi,zi,a0),ve(zi,zi),kdt(i.rotationRight,i.frame,zi),xa(zi,i.vLeft),i.rotationAngle=-s*(Math.PI-An(_e(zi,i.vRight))),Math.abs(i.rotationAngle)>0){const l=bU(Math.cos(.5*i.rotationAngle));lq(i.miterStretch,1+(l-1)*i.rotationRight[0]*i.rotationRight[0],(l-1)*i.rotationRight[0]*i.rotationRight[1],(l-1)*i.rotationRight[0]*i.rotationRight[1],1+(l-1)*i.rotationRight[1]*i.rotationRight[1])}const a=Math.PI-i.rotationAngle;i.maxStretchDistance=Math.abs(i.vMinSiblingLength*bU(Math.cos(.5*a)))}}}function fle(t,e,r){switch(t){case"symbol-value":return r;case"proportional":return e;default:return t}}function upt(t,e,r,i){let s=0;for(const n of t.vertices)r(n.posES,CV),s+=CV.sampledElevation,me(zi,n.pos,t.offset),i.setAltitude(zi,CV.z),ge(n.pos,zi,t.offset);return t.updatePathVertexInformation(),s/t.vertices.length}function hpt(t,e,r,i,s){const n=t.stageObject,o=n.geometries;let a=0;dpt.spatialReference=s.spatialReference;for(const l of o){if(!YEe(l))continue;const c=l.path,h=c.builder.path,p=l.geometrySR;oCe.spatialReference=p,a+=upt(h,e,i,s),l.upVectorAlignment!==Z_.World&&nCe(h,l.upVectorAlignment,s),c.onPathChanged(),l.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(l)}return a/o.length}const dpt=My(0,0,0,null),oCe=My(0,0,0,null),zi=M(),a0=M(),mle=M(),CV=new lP;function ppt(t,e,r,i,s=1){if(r.isGeographic&&i===Be.Global){const c=Bc(e.length),h=e.length,p=Yr(r);for(let f=0;f<h;f+=3)vX(e,f,c,f,p);e=c}ar(_n,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<e.length;c+=3)_n[0]=Math.min(_n[0],e[c]),_n[1]=Math.min(_n[1],e[c+1]);const n=_n[0]%s,o=_n[1]%s,a=_n[0]-n,l=_n[1]-o;for(let c=0;c<e.length;c+=3){const h=c/3*4;t[h]=(e[c]-a)/s,t[h+1]=(e[c+1]-l)/s,t[h+2]=a/s,t[h+3]=l/s}}function aCe(t,e,r,i,s=1){ce(u1,1,0,0),ce(h1,0,1,0),ce(nT,0,0,1),gpt(AV,r),fpt(r,gle)&&mpt(gle,u1,h1,nT,i,AV),ar(_n,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),ar(d1,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let h=0;h<r.length;h+=3){ce(sT,r[h],r[h+1],r[h+2]);const p=_e(u1,sT),f=_e(h1,sT);_n[0]=Math.min(_n[0],p),_n[1]=Math.min(_n[1],f),d1[0]=Math.max(d1[0],p),d1[1]=Math.max(d1[1],f)}const n=_e(nT,AV);OV(l0,_n[0],_n[1],n,u1,h1,nT),OV(p1,d1[0],_n[1],n,u1,h1,nT),OV(f1,_n[0],d1[1],n,u1,h1,nT),ge(p1,p1,l0),ae(p1,p1,.5),ge(f1,f1,l0),ae(f1,f1,.5),me(l0,l0,p1),me(l0,l0,f1);const o=_n[0]%s,a=_n[1]%s,l=_n[0]-o,c=_n[1]-a;for(let h=0;h<r.length;h+=3){ce(sT,r[h],r[h+1],r[h+2]);const p=h/3,f=4*p;t[f]=(_e(u1,sT)-l)/s,t[f+1]=(_e(h1,sT)-c)/s,t[f+2]=l/s,t[f+3]=c/s;const m=9*p;for(let y=0;y<3;y++)e[m+y]=l0[y],e[m+y+3]=p1[y],e[m+y+6]=f1[y]}}const AV=M(),sT=M(),gle=Br(),u1=M(),h1=M(),nT=M(),_n=Ke(),d1=Ke(),l0=M(),p1=M(),f1=M();function fpt(t,e){const r=t.length/3-1;return bye(t,e,0,Math.floor(r/3),Math.floor(r*(2/3)))}function mpt(t,e,r,i,s,n){v(s)?(s.basisMatrixAtPosition(n,Yp),ce(I$,Yp[0],Yp[1],Yp[2]),ce($$,Yp[4],Yp[5],Yp[6]),ce(RV,Yp[8],Yp[9],Yp[10])):(ce(I$,1,0,0),ce($$,0,1,0),ce(RV,0,0,1));const o=t;_e(o,RV)<0&&ae(o,o,-1),le(i,o);const a=_e(o,$$),l=_e(o,I$);Math.abs(a)<Math.abs(l)?(zb(e,I$,o,-l),ve(e,e),pt(r,e,o),ve(r,r),ae(r,r,-1)):(zb(r,$$,o,-a),ve(r,r),pt(e,r,o),ve(e,e))}const Yp=Ie(),I$=M(),$$=M(),RV=M();function gpt(t,e){ce(uA,0,0,0);for(let r=0;r<e.length-3;r+=3)uA[0]+=e[r],uA[1]+=e[r+1],uA[2]+=e[r+2];ae(t,uA,1/(e.length/3-1))}const uA=M();function OV(t,e,r,i,s,n,o){ce(t,e*s[0]+r*n[0]+i*o[0],e*s[1]+r*n[1]+i*o[1],e*s[2]+r*n[2]+i*o[2])}function ypt(t){const e=new Lr,{vertex:r,fragment:i}=e,s=t.output===V.Depth,n=t.hasMultipassTerrain&&(t.output===V.Color||t.output===V.Alpha);return Nc(r,t),e.include(Gl,t),e.include(mx,t),e.include(A6,t),e.attributes.add(A.POSITION,"vec3"),e.varyings.add("vpos","vec3"),n&&e.varyings.add("depth","float"),s&&(e.include(py,t),jw(e),hv(e)),r.code.add(w`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();
      ${n?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${s?w`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:w`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Zs,t),n&&e.include(zu,t),i.include(Am),i.uniforms.add(new fr("eColor",o=>o.color)),t.output===V.Highlight&&e.include(Ry,t),i.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${n?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${t.hasVertexColors?"vColor * eColor;":"eColor;"}

    ${t.output===V.ObjectAndLayerIdColor?w`fColor.a = 1.0;`:""}

    if (fColor.a < ${w.float(Qo)}) {
      discard;
    }

    ${t.output===V.Alpha?w`gl_FragColor = vec4(fColor.a);`:""}

    ${t.output===V.Color?w`gl_FragColor = highlightSlice(fColor, vpos); ${t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${t.output===V.Highlight?w`outputHighlight();`:""};
    ${t.output===V.Depth?w`outputDepth(linearDepth);`:""};
    ${t.output===V.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const _pt=Object.freeze(Object.defineProperty({__proto__:null,build:ypt},Symbol.toStringTag,{value:"Module"}));let lCe=class cCe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,cCe.shader.get().build(this.configuration),Ar)}_createPipeline(e,r){const i=this.configuration,s=e===Tt.NONE,n=e===Tt.FrontFace;return zt({blending:i.output!==V.Color&&i.output!==V.Alpha||!i.transparent?null:s?Du:Oy(e),culling:u6(i.cullFace),depthTest:{func:Iv(e)},depthWrite:(s||n)&&i.writeDepth?Yl:null,colorWrite:Qt,stencilWrite:i.hasOccludees?vm:null,stencilTest:i.hasOccludees?r?vv:$v:null,polygonOffset:s||n?i.polygonOffset?vpt:null:I6(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};lCe.shader=new Dr(_pt,()=>ie(()=>import("./ColorMaterial.glsl-33f8816d.js"),[],import.meta.url));const vpt={factor:1,units:1};let uc=class extends io{constructor(){super(...arguments),this.output=V.Color,this.cullFace=Ei.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=Tt.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1}};u([k({count:V.COUNT})],uc.prototype,"output",void 0),u([k({count:Ei.COUNT})],uc.prototype,"cullFace",void 0),u([k()],uc.prototype,"hasSlicePlane",void 0),u([k()],uc.prototype,"hasVertexColors",void 0),u([k()],uc.prototype,"transparent",void 0),u([k()],uc.prototype,"polygonOffset",void 0),u([k()],uc.prototype,"enableOffset",void 0),u([k()],uc.prototype,"writeDepth",void 0),u([k()],uc.prototype,"hasOccludees",void 0),u([k({count:Tt.COUNT})],uc.prototype,"transparencyPassType",void 0),u([k()],uc.prototype,"hasMultipassTerrain",void 0),u([k()],uc.prototype,"cullAboveGround",void 0),u([k()],uc.prototype,"objectAndLayerIdColorInstanced",void 0);let yle=class extends iK{constructor(e){super(e,new wpt),this.supportsEdges=!0,this._configuration=new uc}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<M6,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,r){return r===V.Color||r===V.Alpha||r===V.Highlight||r===V.Depth&&this.parameters.writeLinearDepth||r===V.ObjectAndLayerIdColor?e===Se.DRAPED_MATERIAL?!0:r===V.Highlight?e===Se.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Se.OPAQUE_MATERIAL):!1}createGLMaterial(e){return new bpt(e)}createBufferWriter(){return new mC(de("enable-feature:objectAndLayerId-rendering")?nlt:PSe)}},bpt=class extends Mv{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==V.Color&&this._output!==V.Alpha||this._updateOccludeeState(e),this.ensureTechnique(lCe,e)}},wpt=class extends pC{constructor(){super(...arguments),this.color=Kf,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ei.None,this.hasOccludees=!1}};var Mo;(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Cross=2]="Cross",t[t.ForwardDiagonal=3]="ForwardDiagonal",t[t.BackwardDiagonal=4]="BackwardDiagonal",t[t.DiagonalCross=5]="DiagonalCross",t[t.COUNT=6]="COUNT"})(Mo||(Mo={}));const uq=.70710678118,_le=uq,xpt=.08715574274;function Tpt(t){const e=new Lr,r=t.hasMultipassTerrain&&(t.output===V.Color||t.output===V.Alpha);t.draped||e.extensions.add("GL_OES_standard_derivatives");const{vertex:i,fragment:s}=e;Nc(i,t),e.include(Gl,t),e.include(mx,t),t.draped?i.uniforms.add(new Pe("worldToScreenRatio",(a,l)=>1/l.screenToPCSRatio)):e.attributes.add(A.BOUNDINGRECT,"mat3"),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.UVMAPSPACE,"vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),r&&e.varyings.add("depth","float");const n=t.style===Mo.ForwardDiagonal||t.style===Mo.BackwardDiagonal||t.style===Mo.DiagonalCross;n&&i.code.add(w`
      const mat2 rotate45 = mat2(${w.float(uq)}, ${w.float(-_le)},
                                 ${w.float(_le)}, ${w.float(uq)});
    `),t.draped||(Cp(i,t),i.uniforms.add(new Pe("worldToScreenPerDistanceRatio",(a,l)=>1/l.camera.perScreenPixelRatio)),i.code.add(w`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),i.code.add(w`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),i.code.add(w`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${w.float(xpt)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),i.code.add(w`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${n?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${n?" * rotate45":""};

      ${t.draped?"":w`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${w.float(t.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const o=t.output===V.Depth;return o&&(e.include(py,t),jw(e),hv(e)),i.code.add(w`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${r?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${o?w`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:w`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Zs,t),s.include(Am),t.draped&&s.uniforms.add(new Pe("texelSize",(a,l)=>1/l.camera.pixelRatio)),t.output===V.Highlight&&e.include(Ry,t),r&&e.include(zu,t),t.output!==V.Highlight&&(s.code.add(w`
      const float lineWidth = ${w.float(t.lineWidth)};
      const float spacing = ${w.float(t.patternSpacing)};
      const float spacingINV = ${w.float(1/t.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),t.draped||s.code.add(w`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),s.uniforms.add(new fr("uColor",a=>a.color)),s.code.add(w`
    void main() {
      discardBySlice(vpos);
      ${r?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${t.hasVertexColors?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${t.output!==V.Highlight?w`color.a *= ${Spt(t)};`:""}

      ${t.output===V.ObjectAndLayerIdColor?w`color.a = 1.0;`:""}

      if (color.a < ${w.float(Qo)}) {
        discard;
      }

      ${t.output===V.Alpha?w`gl_FragColor = vec4(color.a);`:""}

      ${t.output===V.Color?w`gl_FragColor = color; ${t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${t.output===V.Highlight?w`outputHighlight();`:""}
      ${t.output===V.Depth?w`outputDepth(linearDepth);`:""};
    }
  `),e}function Spt(t){function e(r){return t.draped?w`coverage(vuv.${r}, texelSize)`:w`sample(vuv.${r})`}switch(t.style){case Mo.ForwardDiagonal:case Mo.Horizontal:return e("y");case Mo.BackwardDiagonal:case Mo.Vertical:return e("x");case Mo.DiagonalCross:case Mo.Cross:return w`
        1.0 - (1.0 - ${e("x")}) * (1.0 - ${e("y")})
      `;default:return"0.0"}}const Ept=Object.freeze(Object.defineProperty({__proto__:null,build:Tpt},Symbol.toStringTag,{value:"Module"}));let uCe=class hCe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,hCe.shader.get().build(this.configuration),dCe)}_setPipelineState(e,r){const i=this.configuration,s=e===Tt.NONE,n=e===Tt.FrontFace;return zt({blending:i.output===V.Color||i.output===V.Alpha?s?Du:Oy(e):null,culling:u6(i.cullFace),depthTest:{func:Iv(e)},depthWrite:s?i.writeDepth?Yl:null:O6(e),colorWrite:Qt,stencilWrite:i.hasOccludees?vm:null,stencilTest:i.hasOccludees?r?vv:$v:null,polygonOffset:s||n?i.polygonOffset?Cpt:null:I6(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};uCe.shader=new Dr(Ept,()=>ie(()=>import("./Pattern.glsl-adc44d12.js"),[],import.meta.url));const Cpt={factor:1,units:1};let qa=class extends io{constructor(){super(...arguments),this.output=V.Color,this.cullFace=Ei.None,this.transparencyPassType=Tt.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([k({count:V.COUNT})],qa.prototype,"output",void 0),u([k({count:Ei.COUNT})],qa.prototype,"cullFace",void 0),u([k({count:Mo.COUNT})],qa.prototype,"style",void 0),u([k({count:Tt.COUNT})],qa.prototype,"transparencyPassType",void 0),u([k()],qa.prototype,"hasSlicePlane",void 0),u([k()],qa.prototype,"hasVertexColors",void 0),u([k()],qa.prototype,"polygonOffset",void 0),u([k()],qa.prototype,"writeDepth",void 0),u([k()],qa.prototype,"hasOccludees",void 0),u([k()],qa.prototype,"patternSpacing",void 0),u([k()],qa.prototype,"lineWidth",void 0),u([k()],qa.prototype,"enableOffset",void 0),u([k()],qa.prototype,"draped",void 0),u([k()],qa.prototype,"hasMultipassTerrain",void 0),u([k()],qa.prototype,"cullAboveGround",void 0);const dCe=new Map([[A.POSITION,0],[A.COLOR,3],[A.UVMAPSPACE,4],[A.BOUNDINGRECT,5]]);let _K=class extends iK{constructor(e){super(e,new Opt),this.supportsEdges=!0,this._vertexAttributeLocations=dCe,this._configuration=new qa}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<M6,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,r){return r===V.Color||r===V.Alpha||r===V.Highlight||r===V.Depth&&this.parameters.writeLinearDepth?e===Se.DRAPED_MATERIAL?!0:r===V.Highlight?e===Se.OPAQUE_MATERIAL:e===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):!1}createGLMaterial(e){return new Apt(e)}createBufferWriter(){const e=is().vec3f(A.POSITION).vec4u8(A.COLOR).vec4f(A.UVMAPSPACE);return this.parameters.draped||e.mat3f(A.BOUNDINGRECT),new Rpt(e)}},Apt=class extends Mv{_updateParameters(e){return this.ensureTechnique(uCe,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==V.Color&&this._output!==V.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},Rpt=class extends mC{write(e,r,i,s,n){for(const o of this.vertexBufferLayout.fieldNames){const a=i.vertexAttributes.get(o),l=i.indices.get(o);if(a&&l)switch(o){case A.POSITION:{gt(a.size===3);const c=s.getField(o,Ii);c&&C6(l,a.data,e,c,n);break}case A.COLOR:{gt(a.size===3||a.size===4);const c=s.getField(o,Aa);c&&IJ(l,a.data,a.size,c,n);break}case A.UVMAPSPACE:{gt(a.size===4);const c=s.getField(o,zc);c&&ME(l,a.data,c,n);break}case A.BOUNDINGRECT:{gt(a.size===9);const c=s.getField(o,dv);c&&this.writeBoundingRect(l,a.data,e,c,n);break}}}}writeBoundingRect(e,r,i,s,n){const o=i,a=s.typedBuffer,l=s.typedBufferStride,c=e.length;n*=l;for(let h=0;h<c;++h){const p=9*e[h],f=r[p],m=r[p+1],y=r[p+2];a[n]=o[0]*f+o[4]*m+o[8]*y+o[12],a[n+1]=o[1]*f+o[5]*m+o[9]*y+o[13],a[n+2]=o[2]*f+o[6]*m+o[10]*y+o[14];for(let _=3;_<9;++_)a[n+_]=r[p+_];n+=l}}},Opt=class extends pC{constructor(){super(...arguments),this.color=qt(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ei.None,this.hasOccludees=!1,this.style=Mo.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}};function Mpt(t,e,r){return Ipt(Ppt(t),e,r)}function Ppt(t){return t&&t.pattern||null}function Ipt(t,e,r){return v(t)?t.style==="none"||t.style==="solid"?(t.style==="none"&&(e.color=qt(0,0,0,0),e.transparent=!0),new yle(e)):(e.style=$pt(t.style),e.draped=r.isDraped,new _K(e)):new yle(e)}function $pt(t){switch(t){case"horizontal":return Mo.Horizontal;case"vertical":return Mo.Vertical;case"cross":return Mo.Cross;case"forward-diagonal":return Mo.ForwardDiagonal;case"backward-diagonal":return Mo.BackwardDiagonal;case"diagonal-cross":return Mo.DiagonalCross;default:return}}function Lpt(t){return t.material instanceof _K&&!t.material.parameters.draped}function Dpt(t,e){if(Lpt(t)){const r=t.vertexAttributes.get(A.POSITION).data,i=t.getMutableAttribute(A.UVMAPSPACE).data,s=t.getMutableAttribute(A.BOUNDINGRECT).data;aCe(i,s,r,e)}}function Npt(t,e,r,i,s){const n=O2e(t,e,r,i,s),o=t.stageObject.geometries;for(const a of o)Dpt(a,s);return n}const Fpt=["polyline","polygon","extent"];let pCe=class fCe extends Mm{constructor(e,r,i,s){super(e,r,i,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(v(this._material))return;const e=Js(this.symbolLayer,"material","color"),r=this._getCombinedOpacityAndColor(e);this._material=Mpt(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof _K,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(v(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const r=i=>{const s=wEe(e.pattern);return new Q2({width:i,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:iq(e.patternCap||"butt")})};this._outlineMaterial=r($o(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return v(e)&&e.size!=null&&e.size>0&&v(e.color)&&(C(e.pattern)||e.pattern.type!=="style"||e.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Fpt,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(r,new Ip);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(r,i):this._createAs3DShape(r,i,s)}layerOpacityChanged(){if(v(this._material)){const e=this._material.parameters.color,r=Js(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(r);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(v(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=aP(fCe.elevationModeChangeTypes,i,s);if(n!==_s.UPDATE)return n;const o=td(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){if(v(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),v(this._outlineMaterial)){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(e,r,i){var h;const s=Z3(e.geometry);if(C(s))return null;const n=uK(s,this._context.elevationProvider,this._context.renderCoordsHelper,i),o=new Upt(n,r,this._context.layer.uid,e.uid),a=o.renderData.position.length/3;if(this._needsUV&&(o.uvMapSpace=Ys(4*a,!0),o.boundingRect=Bc(9*a,!0),aCe(o.uvMapSpace,o.boundingRect,o.renderData.position,this._context.renderCoordsHelper)),o.objectAndLayerIdColor=(h=this._context.stage.renderView)==null?void 0:h.getObjectAndLayerIdColor(o),this._createAs3DShapeFill(o),this._hasOutline&&this._createAs3DShapeOutline(o),this._logGeometryCreationWarnings(o.renderData,s.rings,"rings","FillSymbol3DLayer"),o.outGeometries.length===0)return null;const l=new Py({geometries:o.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),c=new Om(this,l,o.outGeometries,null,null,Npt,i);return c.alignedSampledElevation=o.renderData.sampledElevation,c.needsElevationUpdates=td(i.mode),c}_createAs3DShapeFill(e){const r=e.renderData.polygons;for(const{position:i,mapPositions:s,holeIndices:n,index:o,count:a}of r){if(v(this._context.clippingExtent)&&(Mi(Ku),Ou(Ku,s),!op(Ku,this._context.clippingExtent)))continue;const l=yv(s,n,3);if(l.length===0)continue;const c=Yoe({material:this._material,indices:l,mapPositions:s,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?sne(e.uvMapSpace,4*o,4*a):null,boundingRect:this._needsUV?zh(e.boundingRect,9*o,9*a):null,objectAndLayerIdColor:e.objectAndLayerIdColor}});e.outGeometries.push(c)}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{mapPositions:s,position:n}=r[i];if(v(this._context.clippingExtent)&&(Mi(Ku),Ou(Ku,s),!op(Ku,this._context.clippingExtent)))continue;const o=sq(this._outlineMaterial,{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:s,attributeData:{position:n}},e.objectAndLayerIdColor),a=o.vertexAttributes.get(A.POSITION);a.data===n&&(a.data=uQe(n)),e.outGeometries.push(o)}}_createAsOverlay(e,r){var a;const i=Z3(e.geometry);if(C(i))return null;this._material.renderPriority=this._renderPriority+this._renderPriorityStep/2,v(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);const s=XSe(i,this._context.overlaySR),n=new Vpt(s,r,this._context.layer.uid,e.uid),o=n.renderData.position.length/3;return this._needsUV&&(n.uvMapSpace=Ys(4*o,!0),ppt(n.uvMapSpace,n.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),n.outBoundingBox=Mi(),n.objectAndLayerIdColor=(a=this._context.stage.renderView)==null?void 0:a.getObjectAndLayerIdColor(n),this._createAsOverlayFill(n),this._hasOutline&&this._createAsOverlayOutline(n),this._logGeometryCreationWarnings(n.renderData,i.rings,"rings","FillSymbol3DLayer"),n.outGeometries.length===0?null:new k6(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e){const r=e.renderData.polygons;for(const{position:i,holeIndices:s,index:n,count:o}of r){const a=Mi(Ku);if(Ou(a,i),!op(a,this._context.clippingExtent))continue;const l=yv(i,s,3);if(l.length===0)continue;oE(e.outBoundingBox,a);const c=Yoe({material:this._material,indices:l,attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?sne(e.uvMapSpace,4*n,4*o):null,objectAndLayerIdColor:e.objectAndLayerIdColor}}),h=new LE(c,e);ti(h.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),e.outGeometries.push(h)}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{position:s}=r[i];if(Mi(Ku),Ou(Ku,s),!op(Ku,this._context.clippingExtent))continue;oE(e.outBoundingBox,Ku);const n=sq(this._outlineMaterial,{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:s}},e.objectAndLayerIdColor),o=new LE(n,e),a=Ku;ti(o.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),e.outGeometries.push(o)}}_getOutlineOpacity(){const e=Js(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(v(e)?e.a:0)}_getOutlineColor(){const e=Js(this.symbolLayer,"outline","color"),r=this._getOutlineOpacity();return zO(v(e)?Ze.toUnitRGB(e):null,r)}test(){return{...super.test(),createAsOverlay:(e,r)=>this._createAsOverlay(e,r),createAs3DShape:(e,r,i)=>this._createAs3DShape(e,r,i)}}};pCe.elevationModeChangeTypes={definedChanged:_s.RECREATE,staysOnTheGround:_s.NONE,onTheGroundChanged:_s.RECREATE};const Ku=Rn();let Upt=class extends N6{constructor(e,r,i,s){super(e,i,s),this.color=r}},Vpt=class extends N6{constructor(e,r,i,s){super(e,i,s),this.color=r}},mCe=class gCe{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=e.background.color[3]!==0?this._colorToRGBA(e.background.color):null}fontString(e){const r=this.definition.font;return`${r.style} ${r.weight} ${e}px ${r.family}, sans-serif`}_colorToRGB(e){return`rgb(${e.slice(0,3).map(r=>Math.floor(255*r)).toString()})`}_colorToRGBA(e){return`rgba(${e.slice(0,3).map(r=>Math.floor(255*r)).toString()},${e[3]})`}static async fromSymbol(e,r){const i=Js(e,"material","color"),s=xu(i,Kf,Ze.toUnitRGBA),n=xu(e.size,12,$o),o=e.lineHeight,a=v(e.background)?Ze.toUnitRGBA(e.background.color):Kf,l={family:xu(e.font,"sans-serif",m=>m.family),decoration:xu(e.font,"none",m=>m.decoration),weight:xu(e.font,"normal",m=>m.weight),style:xu(e.font,"normal",m=>m.style)},c=e.halo,h=v(c)&&v(c.color)&&c.size>0?{size:$o(c.size),color:Ze.toUnitRGBA(c.color)}:{size:0,color:Kf},p=new gCe({color:s,size:n,background:{color:a,padding:v(e.background)?[.65*n,.5*n]:[0,0],borderRadius:v(e.background)?n*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:r}),f=p.fontString(n);try{await document.fonts.load(f)}catch{se.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}return p}},kpt=class{constructor(e,r,i){this._renderer=new hEe(e,r,i)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=eq(zpt,this._renderer.renderedWidth,this._renderer.renderedHeight),r=e.getContext("2d");return r.save(),this._renderer.render(r,0,0),r.restore(),new fx(e,{wrap:{s:Ot.CLAMP_TO_EDGE,t:Ot.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:H_.PAD})}};const zpt={canvas:null},Bpt=[0,0,1];let Gpt=class extends Mm{constructor(e,r,i,s){super(e,r,i,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=$6(this.symbolLayer.size);if(e)throw new j("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await mCe.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const r=e.graphic,i=Y3(r.geometry);if(C(i))return this.logger.warn(`unsupported geometry type for text symbol: ${r.geometry.type}`),null;const s=this.symbolLayer.text;if(C(s)||s==="")return null;const n=XX(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(v(n)&&!xge(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const o=new C2e(n,this.symbolLayer.horizontalAlignment,Uct(this.symbolLayer.verticalAlignment));return this._createAs3DShape(r,i,s,o)}createLabel(e,r,i,s){const n=e.graphic,o=Y3(n.geometry);if(C(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=r.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,r,i,s)}setGraphicElevationContext(e,r,i=0){const s=super.setGraphicElevationContext(e,r);return s.addOffsetRenderUnits(i),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,r){return vle(e,r,(i,s)=>{this.updateGraphicElevationContext(s,i)}),_s.UPDATE}slicePlaneEnabledChanged(e,r){return vle(e,r,i=>{for(const s of i.stageObject.geometries)s.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}skipHighSymbolLodsChanged(){return!0}updateGraphicElevationContext(e,r){const i=r.elevationContext;this.setGraphicElevationContext(e,i,v(r.metadata)?r.metadata.elevationOffset:0),r.needsElevationUpdates=td(i.mode)||i.mode==="absolute-height"}_defaultElevationInfoNoZ(){return Hpt}_createAs3DShape(e,r,i,s,n,o){const a=this.setGraphicElevationContext(e,new Ip,s.elevationOffset),l=Js(e.geometry,"type")==="polyline",c=e.uid;let h=null,p=null;if(C(o)){const I=pEe(s.horizontalPlacement);h=new kpt(i,I,this._textRenderParameters);let U=null;if(v(this._context.sharedResources.textures)){p=this._context.sharedResources.textures.fromData(h.key,()=>h.create(),()=>{v(U)&&U.release()});const z=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if(C(z)||Gu(z))return p.release(),null;U=z}}const f=jpt(h,s),m={occlusionTest:!0,screenOffset:s.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,drawInSecondSlot:!0};if(v(o)?m.textureId=o.id:v(p)&&(m.textureId=p.texture.id),v(s.verticalOffset)){const{screenLength:I,minWorldLength:U,maxWorldLength:z}=s.verticalOffset;m.verticalOffset={screenLength:$o(I),minWorldLength:U||0,maxWorldLength:v(z)?z:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:I,screenSizePerspectiveSettingsLabels:U}=this._context.sharedResources;m.screenSizePerspective=U.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),m.screenSizePerspectiveAlignment=I}let y;if(l&&(m.shaderPolygonOffset=1e-4),m.hasSlicePlane=this._context.slicePlaneEnabled,v(n)){const I=JSON.stringify(m);y=n.get(I),C(y)&&(y=new PE(m),n.add(I,y))}else y=new PE(m);const _=s.translation,b=v(h)?Fr(h.displayWidth,h.displayHeight):Xl,x=s.centerOffset,T=CH(y,Bpt,_,null,b,x,[0,0],null),S=XJ(this._context,r,T,a,c);if(C(S))return null;const E=new Om(this,S.object,[T],C(n)?[y]:null,p,W3,a);E.alignedSampledElevation=S.sampledElevation,E.needsElevationUpdates=td(a.mode)||a.mode==="absolute-height";const{displayWidth:O,displayHeight:R}=v(h)?h:s;E.getScreenSize=(I=Ke())=>(I[0]=O,I[1]=R,I);const L=new N2e(s.elevationOffset,i);return E.metadata=L,X3(E,r,this._context.elevationProvider),E}};function vle(t,e,r){t&&t.forEach(i=>{const s=e(i);v(s)&&r(s,i.graphic)})}function jpt(t,e){if(e.verticalPlacement==="baseline"){const i=Dct[e.horizontalPlacement],s=v(t)?t.baselineAnchorY:0;return Fr(i,s)}const r=Fct(e.horizontalPlacement,e.verticalPlacement);return tN[r]}const Hpt={mode:"relative-to-ground",offset:0},qpt={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},Wpt=["polyline","polygon","extent"];let hq=class pb extends Mm{constructor(e,r,i,s){super(e,r,i,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,Wpt,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Ip);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(r):this._createAs3DShape(r,i,r.uid)}ensureMaterial(){if(v(this._material))return;const e=new USe,r=this.symbolLayer.color;v(r)&&(e.color=Ze.toUnitRGBA(r));const i=this._getCombinedOpacity(r,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=v(this.symbolLayer.waveDirection)?pb.headingVectorFromAngle(this.symbolLayer.waveDirection):Fr(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=qpt[s];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new FSe(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(C(this._material))return;const e=this._material.parameters.color,r=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:i})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=aP(pb.elevationModeChangeTypes,i,s);if(n!==_s.UPDATE)return n;const o=td(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){return v(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(e,r,i){const s=Z3(e.geometry);if(C(s))return null;const n=uK(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),o=n.position.length/3,a=Bc(2*o);this._createUVCoordsFromVertices(a,n.mapPositions,o,this._context.elevationProvider.spatialReference);const l=new Xpt(n,a);if(this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,s.rings,"rings","WaterSymbol3DLayer"),l.outGeometries.length===0)return null;const c=new Py({geometries:l.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),h=new Om(this,c,l.outGeometries,null,null,O2e,r);return h.alignedSampledElevation=l.renderData.sampledElevation,h.needsElevationUpdates=td(r.mode),h}_createUVCoordsFromVertices(e,r,i,s){const n=al(s);Xh(c0);for(let l=0;l<i;l++)ar(ble,r[3*l],r[3*l+1]),mX(c0,ble);kE(c0,c0,n);const o=c0[0]%pb.unitSizeOfTexture,a=c0[1]%pb.unitSizeOfTexture;L$[0]=c0[0]-o,L$[1]=c0[1]-a;for(let l=0;l<i;l++)e[2*l]=(r[3*l]*n-L$[0])/pb.unitSizeOfTexture,e[2*l+1]=(r[3*l+1]*n-L$[1])/pb.unitSizeOfTexture}_create3DShapeGeometries(e){const r=e.renderData.polygons,i=e.uvCoords;for(const{count:s,index:n,position:o,mapPositions:a,holeIndices:l}of r){if(v(this._context.clippingExtent)&&(Mi(u0),Ou(u0,a),!op(u0,this._context.clippingExtent)))continue;const c=yv(a,l,3);if(c.length===0)continue;const h=zh(i,2*n,2*s),p=Zoe({material:this._material,indices:c,mapPositions:a,attributeData:{position:o,uv0:h}});e.outGeometries.push(p)}}_createAsOverlay(e){const r=Z3(e.geometry);if(C(r))return null;this._material.renderPriority=this._renderPriority;const i=XSe(r,this._context.overlaySR),s=i.position.length/3,n=Bc(2*s);this._createUVCoordsFromVertices(n,i.position,s,this._context.overlaySR);const o=new Ypt(i,n,this._context.layer.uid,e.uid);return o.outBoundingBox=Mi(),this._createAsOverlayWater(o),this._logGeometryCreationWarnings(o.renderData,r.rings,"rings","WaterSymbol3DLayer"),o.outGeometries.length===0?null:new k6(this,o.outGeometries,o.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const r=e.uvCoords,i=e.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of i){if(Mi(u0),Ou(u0,s),!op(u0,this._context.clippingExtent))continue;oE(e.outBoundingBox,u0);const l=yv(s,n,3);if(l.length===0)continue;const c=zh(r,2*o,2*a),h=Zoe({material:this._material,indices:l,attributeData:{position:s,uv0:c}}),p=new LE(h,e),f=u0;ti(p.boundingSphere,.5*(f[0]+f[3]),.5*(f[1]+f[4]),0,.5*Math.sqrt((f[3]-f[0])*(f[3]-f[0])+(f[4]-f[1])*(f[4]-f[1]))),e.outGeometries.push(p)}}static headingVectorFromAngle(e){const r=Ke(),i=K4(e);return r[0]=Math.sin(i),r[1]=Math.cos(i),r}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};hq.unitSizeOfTexture=100,hq.elevationModeChangeTypes={definedChanged:_s.RECREATE,staysOnTheGround:_s.NONE,onTheGroundChanged:_s.RECREATE};const L$=Ke(),c0=hr(),ble=Ke(),u0=Rn();let Xpt=class extends N6{constructor(e,r){super(e,null,null),this.uvCoords=r}},Ypt=class extends N6{constructor(e,r,i,s){super(e,i,s),this.uvCoords=r}};function Zpt(t,e,r,i){const s=wle[t.type]&&wle[t.type][e.type]||Jpt[e.type];return s?new s(t,e,r,i):(se.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const Jpt={icon:rq,object:fdt,line:xEe,path:cpt,fill:pCe,extrude:bct,text:Gpt,water:hq},wle={"mesh-3d":{fill:Zut}};let Kpt=class extends HJ{set symbol(e){this._symbol=e,e.symbolLayers.forEach((r,i)=>{const s=this.symbolLayers[i];v(s)&&(s.symbol=e,s.symbolLayer=r)})}get symbol(){return this._symbol}constructor(e,r,i){super(r.schedule),this._symbol=e,this._context=r,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const i=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const s=[];for(let n=0;n<i;n++){const o=r.getItemAt(n);if(o.enabled===!1)continue;D$.renderPriority=1-(1+n)/i,D$.renderPriorityStep=1/i,D$.ignoreDrivers=o._ignoreDrivers;const a=Zpt(this.symbol,o,this._context,D$),l=W4(e,()=>{this.symbolLayers[n]=null,a.destroy()});l&&s.push(l),this.symbolLayers[n]=a}if(await Z4(this.symbolLayers,async(n,o)=>{if(v(n))try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}}),s.forEach(n=>n.remove()),ur(e),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(e){const r=this.symbolLayers[e];return v(r)?r.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>v(e)&&e.queryForSnapping)}createGraphics3DGraphic(e,r){const i=e.graphic,s=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const a=this.symbolLayers[o];s[o]=v(a)?a.createGraphics3DGraphic(e):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new qot(i,r||this,s,e.layer,n)}get complexity(){return WJ(this.symbolLayers.map(e=>Js(e,"complexity")))}globalPropertyChanged(e,r){const i=this.symbolLayers.length;for(let s=0;s<i;s++){const n=this.symbolLayers[s],o=a=>{const l=a.layers[s];return l instanceof Om?l:null};if(v(n)&&!n.globalPropertyChanged(e,r,o))return!1}return!0}applyRendererDiff(e,r){return this.loadStatus!==wu.LOADED?Sn.Recreate_Symbol:this.symbolLayers.reduce((i,s)=>i!==Sn.Recreate_Symbol&&v(s)?Math.min(i,s.applyRendererDiff(e,r)):i,Sn.Fast_Update)}prepareSymbolPatch(e){if(this.loadStatus===wu.FAILED||e.diff.type!=="partial")return;const r=e.diff.diff;if(!r.symbolLayers||r.symbolLayers.type!=="partial")return;const i=r.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(C(s))return;const o=i[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),e.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{const h=l.layers[n];v(h)&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(e,r){for(let i=0;i<this.symbolLayers.length;i++){const s=this.symbolLayers[i];if(C(s))continue;const n=e.layers[i];if(C(n)||!s.updateGeometry(n,r))return!1}return!0}onRemoveGraphic(e){for(let r=0;r<this.symbolLayers.length;r++){const i=this.symbolLayers[r];if(C(i))continue;const s=e.layers[r];v(s)&&i.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,r=0,i=0;return this.symbolLayers.forEach(s=>{C(s)||(s.loadStatus===wu.LOADING?e++:s.isFastUpdatesEnabled()?i++:r++)}),{loading:e,slow:r,fast:i}}async queryForSnapping(e,r,i,s){const n=this.symbolLayers.filter(v).filter(a=>v(a.queryForSnapping)).map(a=>a.queryForSnapping(e,r,i,s)),o=await Promise.all(n);return ur(s),o.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)v(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}};const D$={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};let Qpt=class extends HJ{constructor(e,r,i){super(r),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return v(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const r=await this.symbol.fetchSymbol({signal:e});r.id=this.symbol.id,this.graphics3DSymbol=this._convert(r),v(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return v(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:qJ}globalPropertyChanged(e,r){return!!v(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,r)}applyRendererDiff(e,r){return v(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,r):Sn.Recreate_Symbol}prepareSymbolPatch(e){v(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,r){return!!v(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,r)}onRemoveGraphic(){}getFastUpdateStatus(){return v(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){v(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}};function vK(t){return t instanceof Qpt?t.graphics3DSymbol:t instanceof Kpt?t:null}const rM=se.getLogger("esri.views.3d.layers.graphics.labelPlacement");function eft(t){const e=cft(t);if(C(e))return null;const r=tft(t,e);if(C(r))return null;const i=r.anchor,s=!!e.hasLabelVerticalOffset;return ift({anchor:i,verticalOffset:e.verticalOffset,screenOffset:Ke(),centerOffset:qt(0,0,0,-1),centerOffsetUnits:"world",translation:M(),elevationOffset:0,hasLabelVerticalOffset:s},r,t)}function tft(t,e){if(e.anchor)return e;const r=t.labelClass.labelPlacement,i=up[r],s=i||T4(t);return r&&!i&&rM.warnOncePerTick(`the requested label placement '${r}' is currently unsupported in SceneView.`),rft(s,t)}function bK(t){const e=t.graphics3DGraphic.graphics3DSymbol,r=vK(e);return v(r)?r.symbol.symbolLayers.getItemAt(0):null}function rft(t,e){const r=e.graphics3DGraphic.graphic.geometry;if(C(r))return null;if(v(e.disablePlacement))return e.labelClass.labelPlacement?(rM.warnOncePerTick(xle(t.placement,e.disablePlacement.logEntityDescription)),T4(e)):t;const i=r.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return rM.warnOncePerTick(xle(t.placement,`'${i}' geometries`)),T4(e);break;case"point":case"mesh":return t}return t}function xle(t,e){return`the requested label placement '${t}' is currently unsupported for ${e} in SceneView.`}function T4(t){const e=t.graphics3DGraphic.graphic.geometry;if(C(e))return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const r=bK(t);return v(r)&&r.type==="extrude"?up["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return up["above-center"];default:return}}function ift(t,e,r){const i=r.graphics3DGraphic.graphic.geometry;if(C(i))return null;switch(i.type){case"point":nft(t,e,r);break;case"polygon":sft(t,e,r);break;case"mesh":wK(t,e,r.graphics3DGraphic.layers[0])}return t}function sft(t,e,r){const i=bK(r);if(!C(i))switch(i.type){case"extrude":{const s=r.graphics3DGraphic.layers[0];v(s)?(s.getBoundingBoxObjectSpace(YO),np(YO,t.translation),t.translation[2]=Ev(YO)/2):ce(t.translation,0,0,0),wK(t,e,s);break}}}function nft(t,e,r){const i=bK(r);if(C(i))return;const s=r.graphics3DGraphic.layers[0];switch(v(s)?s.getCenterObjectSpace(t.translation):ce(t.translation,0,0,0),i.type){case"icon":case"text":oft(t,e,r,s);break;case"object":wK(t,e,s)}}function oft(t,e,r,i){const{graphics3DGraphic:s}=r,n=v(i)?i.getScreenSize():null;if(!s.isDraped&&v(n)){const o=aft(r);hA[0]=n[0]/2*(e.normalizedOffset[0]-o[0]),hA[1]=n[1]/2*(e.normalizedOffset[1]-o[1]),t.screenOffset[0]=hA[0],t.hasLabelVerticalOffset?(t.centerOffset[1]=hA[1],t.centerOffsetUnits="screen"):t.screenOffset[1]=hA[1]}else t.hasLabelVerticalOffset||t.anchor==="center"||(up[r.labelClass.labelPlacement]&&rM.warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),t.anchor="center")}function aft(t,e=uft){const{graphics3DGraphic:r}=t,i=r.layers[0],s=v(i)?i.stageObject.geometries[0].material:null;if(s&&s instanceof PE){const n=s.parameters.anchorPosition;e[0]=2*(n[0]-.5),e[1]=2*(n[1]-.5)}else e[0]=0,e[1]=0;return e}function wK(t,e,r){const i=v(r)?r.getBoundingBoxObjectSpace(YO):YO,s=$e(i[3]-i[0],i[4]-i[1],i[5]-i[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);t.centerOffset[0]=n/2*e.normalizedOffset[0];const o=t.translation[2],a=s[2]/2*e.normalizedOffset[1];t.translation[2]=0,t.elevationOffset=o+a;const l=Me(s);t.centerOffset[2]=l/2*e.normalizedOffset[2]}function lft(t){return t==="above-center"}function cft(t){const e=t.labelClass.labelPlacement,{labelSymbol:r,graphics3DGraphic:i}=t,s=vK(i.graphics3DSymbol),n=ao(s,a=>a.symbol.type==="point-3d"?a.symbol:null),o=up[e]||T4(t);return v(n)&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Tle(n.verticalOffset),anchor:null,normalizedOffset:null}:r&&r.hasVisibleVerticalOffset()&&(C(n)||!n.supportsCallout()||!n.verticalOffset||i.isDraped)?lft(o.placement)?{placement:"above-center",verticalOffset:Tle(r.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(rM.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function Tle(t){const{screenLength:e,minWorldLength:r,maxWorldLength:i}=t;return{screenLength:e,minWorldLength:r,maxWorldLength:i}}const up={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Sle={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const t in Sle){const e=Sle[t],r=up[t];e.forEach(i=>{up[i]=r})}Object.freeze&&(Object.freeze(up),Object.keys(up).forEach(t=>{Object.freeze(up[t]),Object.freeze(up[t].normalizedOffset)}));const hA=[0,0],uft=[0,0],YO=Rn();let Ele=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,r){this._materials.set(e,r),this._stage.add(r)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}};const MV=512,PV=4096,hft=.85,dft=.95;let pft=class{constructor(){this.offset={x:0,y:0},this.uvMinMax=nr()}},fft=class{constructor(e,r){this.textId=e,this.textRenderer=r,this.placement=new pft,this.rendered=!1}},HR=class extends Te{constructor(e){super(e),this.type=$s.Texture,this.id=$c(),this.events=new Fs,this._glTexture=null,this._needsClear=!1,this._elementsToAddOrUpdate=new Map,this._elementsToRemove=new Map,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=et(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this._atlas.size.width}get height(){return this._atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,flipped:!0,samplingMode:tt.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return v(this._glTexture)||(this._glTexture=new ct(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(yt.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=Vi(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=et(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",MV.toString()),e.setAttribute("height",MV.toString()),e}_update2DCanvasSize(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())}_createAtlasRegion(e=MV){this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,r){let i=Math.max(e,r);return i+=256,i=qS(i),i=Math.min(i,PV),i}_resizeAtlas(e,r){r=r||e;const i=this._atlas;i.size.width=e,i.size.height=r,v(this._glTexture)&&this._glTexture.resize(e,r),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this._atlas;e.cursor.x=dA,e.cursor.y=dA+Cle,e.lineHeight=0,this._needsClear=!0}_getAtlasUsage(){const e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this._elementsToRemove.size,r=this._elementsToAddOrUpdate.size,i=this._elements.size;return this._getAtlasUsage()/i*(i+r-e)}_addAtlasElement(e,r,i,s){const n=this._atlas,{renderedWidth:o,renderedHeight:a}=e.textRenderer;e.placement.offset.x=n.cursor.x,e.placement.offset.y=n.cursor.y,ti(e.placement.uvMinMax,e.placement.offset.x/n.size.width,1-(e.placement.offset.y+a)/n.size.height,(e.placement.offset.x+o)/n.size.width,1-e.placement.offset.y/n.size.height),n.cursor.x+=i,n.lineHeight=Math.max(n.lineHeight,s),this._elements.set(r,e)}_removeAtlasElement(e){if(e&&this._elements.has(e.textId)){const r=e.placement.offset;this._ctx.clearRect(r.x,r.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}}_ensureStageObjects(e){const r=this._stageObjects.get(e);if(r)return r;const i=new Set;return this._stageObjects.set(e,i),i}_addStageObject(e,r){this._ensureStageObjects(e).add(r)}_removeStageObject(e,r){const i=this._stageObjects.get(e);i&&i.delete(r)&&(r.geometries[0].vertexAttributes.get(A.SIZE).data=[0,0],r.geometryVertexAttrsUpdated(r.geometries[0]))}_processAddition(e,r){const i=this._atlas,s=e.textId,n=e.textRenderer.renderedWidth,o=e.textRenderer.renderedHeight,a=n+dA,l=o+dA+Cle;if(i.cursor.x+a<i.size.width&&i.cursor.y+l<i.size.height)this._addAtlasElement(e,s,a,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s);else{if(!(i.cursor.y+l+i.lineHeight<i.size.height)){const c=this._getExpectedAtlasUsage(),h=c>hft&&i.size.width<PV;return h&&this._resizeAtlas(2*i.size.width,2*i.size.height),!r||!h&&c>dft&&i.size.width===PV?(this._processRemovals(),eS.OK):(this._repack(),eS.REPACK)}i.cursor.x=dA,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,s,a,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s)}return eS.OK}_processRemovals(){this._elementsToRemove.forEach((e,r)=>{const i=this._stageObjects.get(r);i&&i.size!==0||this._removeAtlasElement(e),i&&i.size===0&&this._stageObjects.delete(r)}),this._elementsToRemove.clear()}_repack(){this._processRemovals(),this._elements.forEach((e,r)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(r,e)}),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}_processRenderingRequest(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const r=this._stageObjects.get(e.textId);r&&r.forEach(i=>{i.geometries[0].vertexAttributes.get(A.UV0).data=new Float32Array(e.placement.uvMinMax),i.geometries[0].vertexAttributes.get(A.SIZE).data=[e.textRenderer.displayWidth,e.textRenderer.displayHeight],i.geometryVertexAttrsUpdated(i.geometries[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,r=!0){if(C(this._glTexture))return ea.YIELD;let i=!1;if(Yo(this._elementsToAddOrUpdate,(n,o)=>{const a=this._elements.get(o);if(a&&a.rendered){const l=this._stageObjects.get(o);return l&&l.forEach(c=>{const h=c.geometries[0].vertexAttributes,p=this._elements.get(o);h.get(A.UV0).data=p.placement.uvMinMax,h.get(A.SIZE).data=[p.textRenderer.displayWidth,p.textRenderer.displayHeight],c.geometryVertexAttrsUpdated(c.geometries[0])}),this._elementsToAddOrUpdate.delete(o),e.madeProgress(),!1}return this._processAddition(this._elementsToAddOrUpdate.get(o),r)===eS.REPACK&&(i=!0,!0)}),i)return this.runTask(Ja,!1),void e.madeProgress();let s=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),Yo(this._elementsToRender,(n,o)=>(this._processRenderingRequest(n),this._elementsToRender.delete(o),s=!0,e.madeProgress(),e.done)),s&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&pat.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())}addTextTexture(e,r){const i=e.key;this._elementsToAddOrUpdate.has(i)||this._elementsToAddOrUpdate.set(i,new fft(i,e)),this._addStageObject(i,r),this._elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,r){const i=e.key;this._elementsToRemove.set(i,this._elements.get(i)),this._removeStageObject(i,r)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this._elements.size===0)return;const e=[];this._elements.forEach((i,s)=>e.push({element:i,key:s}));let r=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){r=!1;break}if(!r||this._elementsToRemove.size){e.sort((i,s)=>i.key.localeCompare(s.key)),this._elements.clear();for(const{element:i,key:s}of e)this._elements.set(s,i);this._repack(),this.setDirty()}}get test(){const{_elements:e,_stageObjects:r,_elementsToRemove:i,_atlas:s}=this,n=this;return{elements:e,stageObjects:r,elementsToRemove:i,atlas:s,resizeAtlas:(o,a)=>n._resizeAtlas(o,a),run:(o,a)=>n.runTask(o,a)}}};u([d({constructOnly:!0})],HR.prototype,"view",void 0),u([d({type:Boolean})],HR.prototype,"updating",void 0),HR=u([P("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],HR);const dA=2,Cle=2;var eS;(function(t){t[t.OK=0]="OK",t[t.REPACK=1]="REPACK"})(eS||(eS={}));let Ale=class{constructor(e,r){this.labelingContext=e,this.graphics3DGraphic=r,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},mft=class{constructor(e,r,i,s,n){this.labelClass=e,this.graphics3DSymbol=r,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=s,this.labelFunction=n,this.calloutSymbolLayerIndex=0}},gft=class{constructor(e,r,i,s,n,o,a){this.layer=e,this.graphics3DCore=r,this.scaleVisibility=i,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=n,this.disablePlacement=o,this.active=a,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new lSe({pickable:!0,disableOctree:!0},e.uid)}},fb=class extends Te{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new Zr,this._handles.add([ne(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),ne(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(yt.LABELER,this)]),this._textTextureAtlas=new HR({view:this.view}),this._hudMaterialCollection=new Ele(this.view._stage),this._calloutMaterialCollection=new Ele(this.view._stage)}dispose(){this._handles=Ve(this._handles),this._textTextureAtlas=et(this._textTextureAtlas),this._hudMaterialCollection=et(this._hudMaterialCollection),this._calloutMaterialCollection=et(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.graphics.forEach((r,i)=>{const s=new Ale(e,r);this._labels.set(i,s),e.labelsToInitialize.set(i,s),r.setVisibilityFlag(Ac.USER_SETTING,!0,Oo.LABEL)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((r,i)=>{r.setVisibilityFlag(Ac.USER_SETTING,!1,Oo.LABEL),this.setLabelGraphicVisibility(r,!1),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const r of e.graphics3DGraphic.labelLayers){if(!r._labelClass)continue;const i=e.textRenderers[r._labelIndex];v(i)&&this._textTextureAtlas.addTextTexture(i,r.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const r of e.graphics3DGraphic.labelLayers){if(!r._labelClass)continue;const i=e.textRenderers[r._labelIndex];v(i)&&this._textTextureAtlas.removeTextTexture(i,r.stageObject)}e.rendered=!1}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),ea.YIELD}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const r of this._labelingContexts)if(r.active){if(!Rle(r)){if(yft(r)){this._deactivateLabelingContext(r);continue}if(this._createLabelClassContext(r),IV(r)){this._dirty=!0;continue}if(!Rle(r))continue}Yo(r.labelsToInitialize,(i,s)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(s,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(r.labelsToInitialize.delete(s),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(r=>this._removeLabelTextureFromAtlas(r)),this._labelsToAdd.forEach(r=>this._addLabelTextureToAtlas(r)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var o,a,l;const r=(o=e.labelClassAbortController)==null?void 0:o.signal;await((l=(a=e.layer).when)==null?void 0:l.call(a)),ur(r),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,s=i.layer,n=s.labelingInfo&&s.labelingInfo.filter(c=>!!c.symbol);!n||n.length===0||(await Z4(n,async(c,h)=>{const p=c.symbol,f=vK(i.getOrCreateGraphics3DSymbol(p));if(C(f))return void se.getLogger(this.declaredClass).error("Failed to create Graphics3DSymbol for label");await f.load(),ur(r);let m=null;XX(p)&&p.hasVisibleCallout()&&(m=Got(p,i.symbolCreationContext),await m.load(),ur(r));const y=await Uc(S2e(c,e.layer.fieldsIndex,this.view.spatialReference));if(ur(r),y.ok===!0){const _=await this._createTextRenderParameters(f.symbol);ur(r),e.labelClassContexts[h]=new mft(c,f,m,_,y.value)}else se.getLogger(this.declaredClass).error(`Label expression failed to evaluate: ${y.error}`)}),ur(r))}async _createLabelClassContext(e){return C(e.labelClassPromise)&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(r=>{if(Ks(r))throw r;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const r=e.symbolLayers.getItemAt(0);return r&&r.type==="text"?mCe.fromSymbol(r,this.view.state.rasterPixelRatio):null}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const r=e.labelClassAbortController;e.labelClassAbortController=new AbortController,jh(r),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,r,i,s,n){const o=new C2e(i.verticalOffset,kae(i.anchor),Nct(i.anchor),e.text,i.translation,i.elevationOffset,i.centerOffset,i.screenOffset,i.centerOffsetUnits,e.displayWidth,e.displayHeight);return h0.graphic=r,h0.renderingInfo=null,h0.layer=s,n.createLabel(h0,o,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,r,i,s,n){return h0.graphic=e,h0.layer=n,h0.renderingInfo=new zot(null,r,s.translation,s.centerOffset,s.screenOffset,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(h0)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const r=e.graphics3DGraphic;if(r.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,s=i.labelClassContexts;if(!s||s.length===0||!i.emptySymbolLabelSupported&&r.layers.length===0)return!1;let n=!1;const o=r.graphic,a=i.layer,l=N$(i.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const p=e.textRenderers[h],f=e.textLabelPlacements[h];if(C(p)||C(f))continue;const m=s[h],y=m.graphics3DSymbol,_=y.symbol&&y.symbol.type==="label-3d"?y.symbol:null,b=y.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(i.elevationInfoOverride);const x=this._createTextSymbolGraphic(p,o,f,a,b);if(C(x))return!1;x._labelClass=m.labelClass,x._labelIndex=h,r.addLabelGraphic(x,c,i.stageLayer),r.setVisibilityFlag(Ac.USER_SETTING,l,Oo.LABEL),r.clearVisibilityFlag(Ac.SCALE_RANGE,Oo.LABEL),r.setVisibilityFlag(Ac.DECONFLICTION,!1,Oo.LABEL),n=!0;const T=m.graphics3DCalloutSymbolLayer;if(T&&f.hasLabelVerticalOffset){T.setElevationInfoOverride(i.elevationInfoOverride);const S=this._createLineCalloutGraphic(o,_,T,f,a);v(S)&&(m.calloutSymbolLayerIndex=r.labelLayers.length,r.addLabelGraphic(S,c,i.stageLayer))}break}return i.scaleVisibility&&n&&i.scaleVisibility.updateGraphicLabelScaleVisibility(r),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const r=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(i._labelClass==null)continue;const s=r[i._labelIndex].graphics3DSymbol.symbolLayers[0];s!=null&&s.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var n;if(e.textInitialized)return;const r=e.labelingContext,i=r.labelClassContexts;if(!i||i.length===0)return;const s=e.graphics3DGraphic.graphic;for(let o=0;o<i.length;o++){const a=i[o];if(e.textRenderers[o]=null,e.textLabelPlacements[o]=null,!a.textRenderParameters)continue;const l=a.labelFunction;let c;if(l.type==="arcade")try{const T=l.needsHydrationToEvaluate()?knt(s,r.layer):s;c=l.evaluate(T)}catch{c=null}else c=l.evaluate(s);if(C(c)||c===""||/^\s+$/.test(c))continue;const h=a.graphics3DSymbol,p=((n=h.symbol)==null?void 0:n.type)==="label-3d"?h.symbol:null;if(!h.symbolLayers[0])continue;const f=e.graphics3DGraphic,m=a.labelClass,y=r.disablePlacement,_=eft({graphics3DGraphic:f,labelSymbol:p,labelClass:m,disablePlacement:y});if(C(_))continue;const b=kae(_.anchor),x=pEe(b);e.textRenderers[o]=new hEe(c,x,a.textRenderParameters),e.textLabelPlacements[o]=_}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,r){const i=r.graphic.uid;if(e.graphics.set(i,r),e.active){const s=new Ale(e,r);this._labels.set(i,s),e.labelsToInitialize.set(i,s)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,r){const i=r.graphic.uid,s=this._labels.get(i);e.graphics.delete(i),s&&(this._destroyGraphic(s,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,r){this._labels.has(r)&&(this._labels.delete(r),this._labelsToAdd.delete(r),this._labelsToRemove.delete(r)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,r){if(!r)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of r){const s=e.graphics.get(i);s&&(this._removeGraphic(e,s),this._addGraphic(e,s))}}_globalPropertyChanged(e,r){for(const i of r.labelClassContexts){const s=new Map;r.graphics.forEach(o=>s.set(o.graphic.uid,o));const n=o=>o.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,s,n),i.graphics3DCalloutSymbolLayer){const o=a=>a.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,o)}}}_visibilityInfoChange(e){const r=N$(e.layer);r&&!e.active&&this._activateLabelingContext(e),!r&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((r,i)=>{const s=this._labels.get(i);s&&(this._destroyGraphic(s,i),s.visible=!1,s.rendered=!1,e.labelsToInitialize.set(i,s))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const r of this._labelingContexts)if(r.graphics3DCore===e)return r;return null}addGraphicsOwner(e,r,i){const s=i&&i.emptySymbolLabelSupported||!1,n=i&&i.elevationInfoOverride||null,o=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,l=new gft(a,e,r,s,n,o,N$(a));return this.view._stage.add(l.stageLayer),this._labelingContexts.push(l),this.setDirty(),{addGraphic:c=>this._addGraphic(l,c),removeGraphic:c=>this._removeGraphic(l,c),featureReductionChange:()=>{},layerLabelsEnabled:()=>N$(l.layer),labelingInfoChange:c=>this._labelingInfoChange(l,c),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),clear:()=>{}}}removeGraphicsOwner(e){const r=this._findLabelingContext(e);if(!r)return;const i=this._labelingContexts.indexOf(r);this._labelingContexts.splice(i,1),r.graphics.forEach(s=>this._removeGraphic(r,s)),this.view._stage.remove(r.stageLayer),this.setDirty()}setLabelGraphicVisibility(e,r){const i=e.graphic.uid,s=this._labels.get(i);s&&s.visible!==r&&(r&&!s.rendered?(this._labelsToAdd.set(i,s),this._labelsToRemove.delete(i),s.textInitialized||s.labelingContext.labelsToInitialize.set(i,s)):!r&&s.rendered&&(this._labelsToRemove.set(i,s),this._labelsToAdd.delete(i)),s.visible=r,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(r=>IV(r))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((r,i)=>r+(IV(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function IV(t){return!!t.labelClassPromise&&!!t.labelClassAbortController}function Rle(t){return t.labelClassContexts&&t.labelClassContexts.length}function yft(t){return t.labelClassContexts===null}function N$(t){var e;return t.labelsVisible===!0&&!!((e=t.labelingInfo)!=null&&e.some(r=>!!r.symbol))}u([d({constructOnly:!0})],fb.prototype,"view",void 0),u([d({constructOnly:!0})],fb.prototype,"deconflictor",void 0),u([d()],fb.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],fb.prototype,"updating",null),fb=u([P("esri.views.3d.layers.graphics.Labeler")],fb);const h0=new Bot(null,null,null);let qR=class S2{constructor(e,r,i,s=null){this.lij=[0,0,0],this.extent=hr(),this.resolution=0,this.loadPriority=0,this.measures={visibility:da.VISIBLE_ON_SURFACE,screenRect:hr(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(e,r,i,s)}acquire(e,r,i,s){this.tilingScheme=s,this.id=S2.id(e,r,i),this.lij[0]=e,this.lij[1]=r,this.lij[2]=i,s.getExtent(e,r,i,this.extent),this.resolution=s.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const r=this.lij[0]+1,i=2*this.lij[1],s=2*this.lij[2];return e?(e[0].acquire(r,i,s,this.tilingScheme),e[1].acquire(r,i+1,s,this.tilingScheme),e[2].acquire(r,i,s+1,this.tilingScheme),e[3].acquire(r,i+1,s+1,this.tilingScheme),e):[new S2(r,i,s,this.tilingScheme),new S2(r,i+1,s,this.tilingScheme),new S2(r,i,s+1,this.tilingScheme),new S2(r,i+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,oy(e.measures.screenRect,this.measures.screenRect)}static id(e,r,i){return`${e}/${r}/${i}`}};var da;(function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",t[t.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(da||(da={}));const yCe=.5*Math.PI,_ft=yCe/Math.PI*180;let vft=class{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:M(),direction:M()};for(let r=0;r<4;r++)this._extent[r]={origin:M(),direction:M(),cap:{next:null,direction:M()}},this._planes[r]=Br();this._planes[bi.NEAR]=Br(),this._planes[bi.FAR]=Br(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,r,i,s=!0){const n=this._extent;this._toRenderBoundingExtent(e,r,i),me(this._center.origin,n[0].origin,n[2].origin),ae(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),s||ae(this._center.direction,this._center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this._renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,my(a.cap.direction,a.origin,l.origin),b3(a.direction,a.cap.direction,a.origin,this._planes[o]),s||ae(a.direction,a.direction,-1)}b3(n[0].cap.direction,n[1].cap.direction,n[0].origin,this._planes[bi.NEAR]),s?d7(this._planes[bi.NEAR],this._planes[bi.FAR]):(A5(this._planes[bi.FAR],this._planes[bi.NEAR]),d7(this._planes[bi.NEAR],this._planes[bi.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=r,this._minGlobalAltitude=.9*Yr(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,r,i=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===Be.Global){const n=this._maxSpanSpatialReference.isGeographic?_ft:yCe*r;if(this._maxSpan>n)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){const n=this._extent[0];return!(i||!e.intersectsRay(Vu(n.origin,n.direction)))}for(let n=0;n<this._extent.length;n++){const o=this._extent[n];if(!i&&e.intersectsRay(Vu(o.origin,o.direction))||e.intersectsLineSegment(aw(o.origin,o.cap.next,wft),o.cap.direction))return!0}const s=i?this._planes:this._planesWithoutFar;for(let n=0;n<e.lines.length;n++){const o=e.lines[n];if(qet(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,r,i){gX(e,gd),gd[2]=i,xp(r,gd,$V,this._renderCoordsHelper.spatialReference),Lo(Ole,$V),Mi(ec);for(const{x0:n,x1:o,y0:a,y1:l}of bft)for(let c=0;c<5;c++){const h=c/4;gd[0]=Ft(e[n],e[o],h),gd[1]=Ft(e[a],e[l],h),gd[2]=i,uo(gd,r,gd,this._renderCoordsHelper.spatialReference),Xe(gd,gd,Ole),mm(ec,gd)}ce(this._extent[0].origin,ec[0],ec[1],ec[2]),ce(this._extent[1].origin,ec[3],ec[1],ec[2]),ce(this._extent[2].origin,ec[3],ec[4],ec[2]),ce(this._extent[3].origin,ec[0],ec[4],ec[2]);for(let n=0;n<4;++n)Xe(this._extent[n].origin,this._extent[n].origin,$V)}_toRenderBoundingExtentLocal(e,r,i){c5(e,r,Wm,this._renderCoordsHelper.spatialReference),ce(this._extent[0].origin,Wm[0],Wm[1],i),ce(this._extent[1].origin,Wm[2],Wm[1],i),ce(this._extent[2].origin,Wm[2],Wm[3],i),ce(this._extent[3].origin,Wm[0],Wm[3],i)}_toRenderBoundingExtent(e,r,i){switch(this._renderCoordsHelper.viewingMode){case Be.Global:this._toRenderBoundingExtentGlobal(e,r,i);break;case Be.Local:this._toRenderBoundingExtentLocal(e,r,i);break;default:this._renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(e){if(wi(e.planes[bi.NEAR],this._center.origin)<0&&_e(this._center.direction,e.direction)<0)return!0;for(let r=0;r<4;r++){const i=this._extent[r];if(wi(e.planes[bi.NEAR],i.origin)<0&&_e(i.direction,e.direction)<0)return!0}return!1}};const bft=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],gd=M(),$V=Ie(),Ole=Ie(),ec=Rn(),Wm=hr(),wft=Rp();let xft=class{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustum=new v_(e),this._extendedFrustum=new v_(e),this._intersector=new vft({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,r){this._surfaceElevation=r,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>r,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}end(){this._cache.clear()}calculate(e){if(this._allTilesInvisible)return da.INVISIBLE;const r=this._renderCoordsHelper.viewingMode===Be.Global&&e.lij[0]>=Tft&&e.lij[0]<Sft,i=this._getOrCalculateSingleTileVisibility(e,!r);return i!==da.INVISIBLE&&r?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const r=v_.nearFarLineIndices,i=e.mutablePoints;for(const s of r){const[n,o]=s,a=i[n],l=i[o];ge(Qc,l,a),ae(Qc,Qc,Cft),me(i[o],a,Qc)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let r=da.INVISIBLE;const i=this._cache.get(e.id);if(i!=null)return i;const s=$le.acquire();e.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==da.INVISIBLE&&(r=o,o===da.VISIBLE_ON_SURFACE))break}return $le.release(s),this._cache.set(e.id,r),r}_getOrCalculateSingleTileVisibility(e,r){const i=this._cache.get(e.id);if(i!=null)return i;const s=this._calculateSingleTileVisibility(e);return r&&this._cache.set(e.id,s),s}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===Be.Global&&e.lij[0]<Eft?this._calculateSingleTileVisibilitySided(e,!1)===da.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_calculateSingleTileVisibilitySided(e,r){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,r);const i=Yr(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,i)?this._intersector.isVisibleInFrustum(this._frustum,i,!0)?da.VISIBLE_ON_SURFACE:da.VISIBLE_WHEN_EXTENDED:da.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const r=this._renderCoordsHelper.worldUpAtPosition(e.eye,Qc);this._aboveGround||xa(r,r);const i=An(-_e(r,e.viewForward));if(this._allTilesInvisible=i>(Math.PI+e.fovY)/2,this._allTilesInvisible||(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),n=this._extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this._renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this._renderCoordsHelper.worldUpAtPosition(l,Qc),a){case nt.FAR_BOTTOM_LEFT:case nt.FAR_TOP_LEFT:case nt.NEAR_BOTTOM_LEFT:case nt.NEAR_TOP_LEFT:p7(this._extendedFrustum.planes[bi.LEFT],Qc,Qc);break;case nt.FAR_BOTTOM_RIGHT:case nt.FAR_TOP_RIGHT:case nt.NEAR_BOTTOM_RIGHT:case nt.NEAR_TOP_RIGHT:p7(this._extendedFrustum.planes[bi.RIGHT],Qc,Qc)}ae(Qc,Qc,s.direction),this._renderCoordsHelper.intersectInfiniteManifold(Vu(l,Qc),s.zWithMargin,l)}}if(this._extendedFrustum.updatePoints(n),fa(n[nt.NEAR_BOTTOM_LEFT],n[nt.NEAR_BOTTOM_RIGHT],n[nt.NEAR_TOP_RIGHT],Ple),fa(n[nt.NEAR_BOTTOM_RIGHT],n[nt.NEAR_TOP_RIGHT],n[nt.NEAR_TOP_LEFT],Ile),_e(Ple,Ile)<0){const o=this._extendedFrustum.mutablePoints;this._aboveGround?[o[nt.NEAR_BOTTOM_LEFT],o[nt.NEAR_BOTTOM_RIGHT]]=[o[nt.NEAR_BOTTOM_RIGHT],o[nt.NEAR_BOTTOM_LEFT]]:[o[nt.NEAR_TOP_LEFT],o[nt.NEAR_TOP_RIGHT]]=[o[nt.NEAR_TOP_RIGHT],o[nt.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(o)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-Mle;return{zWithMargin:e,pointIndices:v_.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:r=>r>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+Mle;return{zWithMargin:e,pointIndices:v_.planePointIndices.top,direction:1,needsAltitudeAdjustment:r=>r<e}}};const Tft=2,Sft=6,Eft=12,Cft=.95,Mle=1,Qc=M(),Ple=Br(),Ile=Br(),$le=new Po(Array,t=>{t.length!==4&&(t[0]=new qR,t[1]=new qR,t[2]=new qR,t[3]=new qR)},t=>{t[0].release(),t[1].release(),t[2].release(),t[3].release()});let Aft=class{constructor(e){this._camera=new At,this._focusOnMap=[0,0],this._screenRect=hr(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new xft(e.renderCoordsHelper)}begin(e,r,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=r.x,this._focusOnMap[1]=r.y,fX(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=EDe(e.extent,this._focusOnMap),e.measures.visibility!==da.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const r=Rft,i=1<<r,s=e.measures.screenRect;Xh(s);let n=0;const o=e.lij[0]+r,a=e.lij[1]<<r,l=e.lij[2]<<r,c=this._tileSizeWithBias(e),h=c*c;for(let p=0;p<i;p++)for(let f=0;f<i;f++)if(n+=this._computeScreenArea(e,o,a+p,l+f,s),n>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===da.VISIBLE_WHEN_EXTENDED?this._tileSize*Oft:this._tileSize}_computeScreenArea(e,r,i,s,n){const o=e.measures.visibility===da.VISIBLE_WHEN_EXTENDED;this._projectToScreen(r,i,s,o,d0),Xh(LV);for(let a=0;a<4;a++)mX(LV,d0[a]);return z_(n,LV,n),ane(d0[0],d0[1],d0[2])+ane(d0[0],d0[2],d0[3])}_projectToScreen(e,r,i,s,n){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,r,i,pA),this._toRenderCoords(pA,0,3,p0[0]),this._toRenderCoords(pA,2,3,p0[1]),this._toRenderCoords(pA,2,1,p0[2]),this._toRenderCoords(pA,0,1,p0[3]),s&&(this._projectToPlane(p0,this._camera.frustum[bi.NEAR]),this._projectToPlane(p0,this._camera.frustum[bi.TOP]),this._projectToPlane(p0,this._camera.frustum[bi.BOTTOM]));for(let o=0;o<4;o++)this._camera.projectToRenderScreen(p0[o],Lle),this._camera.renderToScreen(Lle,n[o])}_projectToPlane(e,r){for(let s=0;s<4;s++)mA[s]=wi(r,e[s]);const i=Math.max(mA[0],mA[1],mA[2],mA[3]);if(i>0){const s=ae(fA,r,-i);for(let n=0;n<4;n++)me(e[n],e[n],s)}}_toRenderCoords(e,r,i,s){return fA[0]=e[r],fA[1]=e[i],fA[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(fA,this._tilingScheme.spatialReference,s),s}};const LV=hr(),Rft=2,Oft=5,d0=[cs(),cs(),cs(),cs()],pA=hr(),fA=M(),p0=[M(),M(),M(),M()],mA=[0,0,0,0],Lle=Zo();function sNt(t,e,r){if(C(t)||C(r))return!1;let i=!0;return yn[0]=t.xmin!=null?t.xmin:0,yn[1]=t.ymin!=null?t.ymin:0,yn[2]=t.zmin!=null?t.zmin:0,i=i&&vs(yn,t.spatialReference,0,e,r,0,1),yn[0]=t.xmax!=null?t.xmax:0,yn[1]=t.ymax!=null?t.ymax:0,yn[2]=t.zmax!=null?t.zmax:0,i=i&&vs(yn,t.spatialReference,0,e,r,3,1),t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.zmin==null&&(e[2]=-1/0),t.xmax==null&&(e[3]=1/0),t.ymax==null&&(e[4]=1/0),t.zmax==null&&(e[5]=1/0),i}function _Ce(t,e,r){if(C(t)||C(r))return!1;let i=!0;return yn[0]=t.xmin!=null?t.xmin:0,yn[1]=t.ymin!=null?t.ymin:0,yn[2]=t.zmin!=null?t.zmin:0,i=i&&vs(yn,t.spatialReference,0,yn,r,0,1),e[0]=yn[0],e[1]=yn[1],yn[0]=t.xmax!=null?t.xmax:0,yn[1]=t.ymax!=null?t.ymax:0,yn[2]=t.zmax!=null?t.zmax:0,i=i&&vs(yn,t.spatialReference,0,yn,r,0,1),e[2]=yn[0],e[3]=yn[1],t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.xmax==null&&(e[2]=1/0),t.ymax==null&&(e[3]=1/0),i}const yn=M();let Ao=class extends Te{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(v(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void se.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const r=this._get("filterExtent");if(r===e||v(r)&&e&&r.equals(e))return;const i=v(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(C(this.filterExtent))return null;const e=hr();return _Ce(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new ft,this.tileSize=512,this._idToTile=new Map,this._handles=new Zr,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new Kt}initialize(){this._handles.add([ne(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),ri),ne(()=>{var e,r,i;return[this.tileSize,(e=this.cameraOnSurface)==null?void 0:e.location,this.tilingScheme,(r=this.viewState)==null?void 0:r.contentCamera,(i=this.focus)==null?void 0:i.location]},()=>this._setDirty(),qs)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(yt.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Vi(this._frameWorker),this._handles=Ve(this._handles)}addClient(){const e=Pft();return this._clients.add(e),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ja))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),v(this._frameWorker)&&(this._frameWorker.priority=yt.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&v(this._frameWorker)&&(this._frameWorker.priority=yt.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new Aft({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map(r=>new qR(r[0],r[1],r[2],e))}_purgeHorizonTiles(e){e.sort((r,i)=>{const s=r.measures.screenRect,n=i.measures.screenRect;return s[1]+s[3]-(n[1]+n[3])}),Xh(F$);for(let r=0;r<e.length;r++)if(z_(F$,e.data[r].measures.screenRect,F$),wp(F$)>Ift)return e.data.slice(r,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:r}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!l5(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==da.INVISIBLE&&(i.measures.shouldSplit?(r.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const r=e.filter(s=>{const n=this._idToTile.get(s.id);return n?(n.copyMeasurementsFrom(s),n.used=!0):this._idToTile.set(s.id,s),!n}),i=this.tiles.items.filter(s=>!s.used&&(this._idToTile.delete(s.id),!0));this.tiles.removeMany(i),this.tiles.addMany(r),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,r)=>e.measures.visibility!==r.measures.visibility?e.measures.visibility===da.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-r.measures.distance),this.tiles.forEach((e,r)=>e.loadPriority=r)}};u([d({constructOnly:!0})],Ao.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Ao.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Ao.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],Ao.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],Ao.prototype,"focus",void 0),u([d({constructOnly:!0})],Ao.prototype,"viewState",void 0),u([d({constructOnly:!0})],Ao.prototype,"terrain",void 0),u([d()],Ao.prototype,"tiles",void 0),u([d()],Ao.prototype,"tileSize",void 0),u([d({readOnly:!0})],Ao.prototype,"tilingScheme",null),u([d()],Ao.prototype,"filterExtent",null),u([d({readOnly:!0})],Ao.prototype,"_filterExtentRect",null),u([d({readOnly:!0})],Ao.prototype,"_rootTileIds",null),u([d({value:!1})],Ao.prototype,"suspended",null),u([d({readOnly:!0})],Ao.prototype,"updating",null),Ao=u([P("esri.views.3d.layers.support.FeatureTileTree3D")],Ao);let Mft=0;function Pft(){return Mft++}const F$=hr(),Ift=10;let fn=class extends Te{constructor(){super(...arguments),this._propertiesPool=new cy({camera:At},this),this._lastSeenCameraProjectionValues=new At,this.mode=Tr.ANIMATING,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new Fs,this.viewingMode=Be.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,r){this._set("viewingMode",e),this._set("spatialReference",r),this._set("constraints",new _g({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new cy({camera:At},this)}createInitialCamera(){if(this.viewingMode===Be.Global){const e=Yr(this.spatialReference).radius;this.camera=new At({eye:$e(4*e,0,0),center:$e(e,0,0),up:$e(0,0,1)})}else this.camera=new At({eye:$e(0,0,100),center:$e(0,0,0),up:$e(0,1,0)})}get animation(){return this.cameraController instanceof B3&&v(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Qu&&Qu.copyFrom(e),Qu.computeUp(this.viewingMode),this.events.emit("before-camera-change",Qu);const r=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Qu)&&(this._lastSeenCameraProjectionValues.copyFrom(Qu),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),(!r||!r.equals(Qu))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Qu)),this._cameraChanged=!r||!r.almostEquals(Qu),this._cameraChanged)){const i=Rde(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get contentCamera(){return It(this._contentCamera,this.camera)}set contentCamera(e){this._contentCamera=v(e)?e.clone():null}get fixedContentCamera(){return v(this._contentCamera)}get isGlobal(){return this.viewingMode===Be.Global}get isLocal(){return this.viewingMode===Be.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(this.removeHandles(Dle),this.addHandles(ra(()=>e.state===ls.Finished||e.state===ls.Stopped,()=>{this._set("cameraController",null),this.updateCamera(r=>e.onControllerEnd(r))},{sync:!0,once:!0}),Dle),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ls.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==ls.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();Qu.copyFrom(this._get("camera")),e(Qu),this.camera=Qu,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,r){return e.fov!==r.fov||e.fullViewport[0]!==r.fullViewport[0]||e.fullViewport[1]!==r.fullViewport[1]||e.fullViewport[2]!==r.fullViewport[2]||e.fullViewport[3]!==r.fullViewport[3]||e.padding[cr.TOP]!==r.padding[cr.TOP]||e.padding[cr.RIGHT]!==r.padding[cr.RIGHT]||e.padding[cr.BOTTOM]!==r.padding[cr.BOTTOM]||e.padding[cr.LEFT]!==r.padding[cr.LEFT]}};u([d()],fn.prototype,"mode",void 0),u([d({readOnly:!0,type:TE})],fn.prototype,"animation",null),u([d({type:At})],fn.prototype,"camera",null),u([d({readOnly:!0})],fn.prototype,"pixelRatio",null),u([d()],fn.prototype,"rasterPixelRatio",void 0),u([d()],fn.prototype,"contentPixelRatio",void 0),u([d({})],fn.prototype,"_contentCamera",void 0),u([d({type:At})],fn.prototype,"contentCamera",null),u([d({readOnly:!0})],fn.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],fn.prototype,"constraints",void 0),u([d({readOnly:!0})],fn.prototype,"events",void 0),u([d({readOnly:!0})],fn.prototype,"isGlobal",null),u([d({readOnly:!0})],fn.prototype,"isLocal",null),u([d({readOnly:!0})],fn.prototype,"viewingMode",void 0),u([d({readOnly:!0})],fn.prototype,"spatialReference",void 0),u([d()],fn.prototype,"navigating",null),u([d()],fn.prototype,"stationary",null),u([d()],fn.prototype,"_cameraChanged",void 0),u([d()],fn.prototype,"cameraController",null),fn=u([P("esri.views.3d.state.ViewState")],fn);const $ft=fn,Qu=new At,Dle="ViewStateHandles";let Lft=class{constructor(e,r,i){this.viewingMode=e,this._forEachLayer=r,this._view=i,this._externalIntersectionHandlers=new Kt,this._tolerance=pE,this._tmpRay=no(),this._tmpRegion=hr(),this._validateHUDIntersector=Qh(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,r,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),Nle(this.viewingMode),r,i)}intersectScreenFreePointFallback(e,r,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),r,i)}intersectRayFreePointFallback(e,r,i){return this.intersectRay(e,Nle(this.viewingMode),r,i)||this._intersectRayFreePointLocal(e,r)}intersectRay(e,r,i,s){return r.options.selectionMode=!1,r.options.store=Do.MIN,this.computeIntersection(e,r,s),!!r.results.min&&r.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,r,i=.5,s=.5){return e.getRenderCenter(k$,i,s),k$[0]+=.0466,k$[1]-=.0123,bJ(e,k$,r)}intersectIntersectorScreen(e,r,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),r,i)}intersectToolIntersectorScreen(e,r,i){const s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,r,i)}intersectToolIntersectorRay(e,r,i){r.options.selectionMode=!0,this.computeIntersection(e,r,i);const s=r.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||Op(s)&&s.intersector!==ts.TERRAIN||(r.options.selectionMode=!1,this.computeIntersection(e,r,i))}setTolerance(e=pE){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((r,i)=>r.type===ts.TERRAIN?1:i.type===ts.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((r,i)=>r.type===ts.TERRAIN?1:i.type===ts.TERRAIN?-1:0)}_getPickRay(e,r){const i=this._view.state.camera;return Bxe(i,e,r)}_intersectRayFreePointLocal(e,r){return this.viewingMode!==Be.Local||C(e)||me(r,e.origin,ve(He.get(),e.direction)),!1}intersectElevationFromScreen(e,r,i=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),r,i,s)}_intersectElevation(e,r,i=0,s=null){if(C(e))return null;const n=v(r)?r.mode:"absolute-height",o=v(r)?It(r.offset,0):0,a=n!=="on-the-ground"?o+i:0,l=a/this._view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,a,V$)){const T=this._view.computeMapPointFromVec3d(V$);return T.z??(T.z=0),T.z-=o,T}return null}const c=this._view.state.camera,h=He.get();c.projectToRenderScreen(e.origin,h);const p=new Fle(null,this._forEachLayer),f=this._view.slicePlane,m=v(f)?Jee(f):null,y=Qh(this.viewingMode);y.options.store=Do.MIN,y.options.verticalOffset=l;const _=e.origin,b=me(He.get(),_,e.direction);y.reset(_,b,c),y.point=h;const x=v(s)?"type"in s&&s.type==="graphics"?T=>{var S;return((S=T.metadata)==null?void 0:S.layerUid)!==s.uid}:T=>{var S;return((S=T.metadata)==null?void 0:S.graphicUid)!==s.uid}:null;switch(n){case"relative-to-scene":{const T=S=>{var E;return(C(x)||x(S))&&!!((E=S.metadata)!=null&&E.isElevationSource)};y.intersect(p.layers,h,this._tolerance,null,T),this._externalIntersectionHandlers.forAll(S=>{if(S.type===ts.I3S||S.type===ts.TERRAIN){const E=S.slicePlaneEnabled?m:null;S.intersect(y,E,y.rayBegin,y.rayEnd,h)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(T=>{if(T.isGround){const S=T.slicePlaneEnabled?m:null;T.intersect(y,S,y.rayBegin,y.rayEnd,h)}})}if(y.results.min.getIntersectionPoint(V$)){const T=this._view.computeMapPointFromVec3d(V$);return T.z=i,T}return null}computeIntersection(e,r,i){var y;if(C(e))return;const s=this._view.state.camera,n=He.get();s.projectToRenderScreen(e.origin,n);const o=new Fle(i,this._forEachLayer);r.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const a=e.origin,l=me(He.get(),e.origin,e.direction);r.reset(a,l,s),r.intersect(o.layers,n,this._tolerance);const c=this._view.slicePlane,h=v(c)?Jee(c):null;r.intersect(o.sliceableLayers,n,this._tolerance,h);const p=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll(_=>{const b=_.layerUid,x=Array.isArray(b),T=x?b:[b];x&&(r.options.filteredLayerUids=[]);let S=!1;for(const E of T)o.filterLayerUid(E)?S=!0:x&&r.options.filteredLayerUids.push(E);if(r.options.isFiltered=!S,_.isGround&&p||!r.options.isFiltered){const E=_.slicePlaneEnabled?h:null;_.intersect(r,E,a,l,n)}});const f=He.get(),m=this._view.basemapTerrain;if(i&&i.enableDraped&&v(m.spatialReference)&&r.results.ground.getIntersectionPoint(f)){const _=m.overlayManager.renderer,b=this._view.renderCoordsHelper.spatialReference,x=He.get();this._view.renderCoordsHelper.fromRenderCoords(f,x,m.spatialReference),x[2]=It((y=this._view.elevationProvider)==null?void 0:y.getElevation(f[0],f[1],f[2],b,"ground"),0),_.intersect(r,x,r.results.ground,T=>o.filterRenderGeometry(T))}r.sortResults(),this._processHUDResults(r)}_processHUDResults(e){const r=e.results.hud;oy(this._tmpRegion,Az);const i=this._view.state.camera,s=[],n=this._tmpRegion,o=x=>{const T=new Nft(x);i.projectToRenderScreen(x.target.center,T.screenPoint),T.screenPoint[0]=Math.floor(T.screenPoint[0]),T.screenPoint[1]=Math.floor(T.screenPoint[1]),s.push(T),mX(n,T.screenPoint)};e.sortResults(r.all),v(r.min.dist)&&o(r.min);for(const x of r.all)r.min.target.object!==x.target.object&&r.max.target.object!==x.target.object&&o(x);if(v(r.max.dist)&&r.max.target.object!==r.min.target.object&&o(r.max),!s.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const a=i.fullWidth,l=i.fullHeight,c=Math.max(0,n[0]-WR),h=Math.max(0,n[1]-WR),p=Math.min(Cu(n)+2*WR,a-c),f=Math.min(wp(n)+2*WR,l-h),m=new Uint8Array(p*f*4);this._view._stage.renderer.readHUDVisibility(c,h,p,f,m);let y=!0;const _=C(e.results.max.dist);let b=0;for(const x of s)for(const T of Dft)if(m[4*(Math.min(x.screenPoint[0]+T[0],a)-n[0]+(Math.min(x.screenPoint[1]+T[1],l)-n[1])*p)]){y&&(e.results.min.copy(x.result),y=!1),_&&e.results.max.copy(x.result),e.options.store===Do.ALL&&e.results.all.splice(b++,0,x.result);break}}};const WR=1,Dft=(()=>{const t=[],e=WR;for(let r=-e;r<=e;r++)for(let i=-e;i<=e;i++)t.push([i+e,r+e]);return t})();let Nft=class{constructor(e){this.result=e,this.screenPoint=Zo()}},U$;function Nle(t){return U$&&U$.viewingMode===t||(U$=Qh(t)),U$}let Fle=class{constructor(e,r){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,r(i=>{i.pickable&&this.filterLayerUid(i.apiLayerUid)&&(i.sliceable?this.sliceableLayers:this.layers).push(i)})}filterLayerUid(e){const{include:r,exclude:i}=this;return C(e)?r==null&&i==null:(r==null||r.has(e))&&(i==null||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function Ule(t){return typeof t=="object"&&"intersect"in t}const V$=M(),k$=Zo();let uNt=class{constructor(e,r){this.spatialReference=e,this._view=r}getElevation(e,r,i){return this._view.elevationProvider.getElevation(e,r,0,this.spatialReference,i)}async queryElevation(e,r,i,s,n){return this._view.elevationProvider.queryElevation(e,r,0,this.spatialReference,n,i,s)}},Fft=class{constructor(e,r,i,s){this.spatialReference=r,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(yt.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(e,r,i,s=0){return new Promise((n,o)=>{const a={x:e,y:r,minDemResolution:s,result:{resolve:n,reject:o},signal:i};this._queries.push(a),ba(i,()=>{Qq(this._queries,a),o(qr())})})}get running(){return this._queries.length>0}runTask(e){const r=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return r.forEach(h=>h.result.reject()),void e.madeProgress();const s=r.map(h=>[h.x,h.y]),n=r.reduce((h,p)=>Math.min(h,p.minDemResolution),1/0),o=new OM({points:s,spatialReference:this.spatialReference}),a=r.length>1&&r.some(h=>!!h.signal)?new AbortController:null,l=v(a)?a.signal:r[0].signal;if(v(a)){let h=0;r.forEach(p=>ba(p.signal,()=>{h++,p.result.reject(qr()),h===r.length&&a.abort()}))}const c={...this._queryOptions,minDemResolution:n,signal:l};i.queryElevation(o,c).then(h=>{r.forEach((p,f)=>{v(p.signal)&&p.signal.aborted?p.result.reject(qr()):p.result.resolve(h.geometry.points[f][2])})}).catch(h=>{r.forEach(p=>p.result.reject(h))}),e.madeProgress()}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask(Ja)}}},XR=class extends Fs.EventedMixin(Te){get spatialReference(){var e,r;return(r=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:r.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this._handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=Ve(this._elevationQueryCached)}get _elevationQuery(){return C(this._elevationQueryCached)&&(this._elevationQueryCached=new Fft(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQueryCached}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,r,i,s,n){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const a=this.lastElevationQuery;if(e===a.x&&r===a.y&&i===a.z&&Cn(s,a.spatialReference)&&n===a.queryContext)return a.result}let o=null;return o=z$(o,this._im,e,r,i,s,n),C(o)&&(o=z$(o,this._ground,e,r,i,s,n)),n==="scene"&&(o=z$(o,this._scene,e,r,i,s,n)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:r,z:i,spatialReference:s,queryContext:n,result:o}),o}queryElevation(e,r,i,s,n,o=null,a=0){const l=K_();return this._elevationQuery.queryElevation(e,r,o,a).then(c=>{n==="scene"&&(c=z$(c,this._scene,e,r,i,s,n)),l.resolve(c)}).catch(c=>{Ks(c)?l.reject(c):l.resolve(this.getElevation(e,r,i,s,n))}),l.promise}register(e,r){this._handles.set(r,r.on("elevation-change",i=>this.emit("elevation-change",i))),this._providersFromContext(e).push(r)}unregister(e){var r;this._handles.has(e)&&((r=this._handles.get(e))==null||r.remove(),this._handles.delete(e));for(const i of[this._im,this._ground,this._scene]){const s=i.indexOf(e);s>-1&&i.splice(s,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}};function z$(t,e,r,i,s,n,o){for(const a of e){const l=a.getElevation(r,i,s,n,o);v(l)&&(t=v(t)?Math.max(l,t):l)}return t}u([d({constructOnly:!0})],XR.prototype,"view",void 0),u([d()],XR.prototype,"spatialReference",null),XR=u([P("esri.views.3d.support.CombinedElevationProvider")],XR);let YR=class dq{static isValidProfile(e){return e in dq.profiles}static getDefaultProfile(){return de("esri-iPhone")?"low":"medium"}static apply(e,r){const i=dq.profiles[e];r.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,r.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,r.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,r.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,r.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,r.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const s=r.sceneService.object,n=i.sceneService.object;s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration,r.sceneService.point.lodFactor=i.sceneService.point.lodFactor,r.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,r.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,r.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,r.tiledSurface.lodBias=i.tiledSurface.lodBias,r.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,r.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,r.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,r.heatmap.pixelRatio=i.heatmap.pixelRatio,r.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,r.fadeDuration=i.fadeDuration,r.antialiasingEnabled=i.antialiasingEnabled,r.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,r.highQualityTransparency=i.highQualityTransparency,r.memoryLimit=i.memoryLimit,r.additionalCacheMemory=i.additionalCacheMemory,r.frameRate=i.frameRate,r.maximumPixelRatio=i.maximumPixelRatio}};function Vle(){const t=!!de("esri-mobile"),e=!!de("ios"),r=400;return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},fadeDuration:0,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?.8:1,polylineLodFactor:t?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:t},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!de("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},fadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?600:750,additionalCacheMemory:t?0:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?1.2:2,polylineLodFactor:t?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!de("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},fadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:t?900:1500,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:t?1:1/0}}}YR.test={reset(){const t=Vle();for(const e in t)YR.profiles[e]=t[e]}},function(t){t.profiles=Vle()}(YR||(YR={}));const sN=YR;function vCe(){return new Float32Array(4)}function Uft(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Ap(t,e,r,i){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function Vft(t,e){return new Float32Array(t,e,4)}function bCe(){return vCe()}function wCe(){return Ap(1,1,1,1)}function xCe(){return Ap(1,0,0,0)}function TCe(){return Ap(0,1,0,0)}function SCe(){return Ap(0,0,1,0)}function ECe(){return Ap(0,0,0,1)}const kft=bCe(),zft=wCe(),Bft=xCe(),Gft=TCe(),jft=SCe(),Hft=ECe();Object.freeze(Object.defineProperty({__proto__:null,ONES:zft,UNIT_W:Hft,UNIT_X:Bft,UNIT_Y:Gft,UNIT_Z:jft,ZEROS:kft,clone:Uft,create:vCe,createView:Vft,fromValues:Ap,ones:wCe,unitW:ECe,unitX:xCe,unitY:TCe,unitZ:SCe,zeros:bCe},Symbol.toStringTag,{value:"Module"}));const kle=new Ze([0,255,255]),zle=new Ze([0,0,0]),Ble=1,Gle=.25,jle=.4,Hle=.2;let wf=class extends Te{constructor(){super(...arguments),this.color=kle.clone(),this.haloColor=null,this.haloOpacity=Ble,this.fillOpacity=Gle,this.shadowOpacity=jle,this.shadowColor=zle.clone(),this.shadowDifference=Hle}static toEngineOptions(e){const r=Ze.toUnitRGBA(e.color??kle),i=v(e.haloColor)?Ze.toUnitRGBA(e.haloColor):r,s=Ze.toUnitRGBA(e.shadowColor??zle),n=e.haloOpacity??Ble,o=e.fillOpacity??Gle,a=e.shadowOpacity??jle,l=e.shadowDifference??Hle;return{color:Ap(r[0],r[1],r[2],r[3]),haloColor:Ap(i[0],i[1],i[2],i[3]),haloOpacity:n,haloOpacityOccluded:.25*n,fillOpacity:o,fillOpacityOccluded:.25*o,shadowOpacity:a,shadowColor:qt(s[0],s[1],s[2],s[3]),occludedShadowOpacity:a*(1-l)}}};u([d({type:Ze})],wf.prototype,"color",void 0),u([d({type:Ze})],wf.prototype,"haloColor",void 0),u([d()],wf.prototype,"haloOpacity",void 0),u([d()],wf.prototype,"fillOpacity",void 0),u([d()],wf.prototype,"shadowOpacity",void 0),u([d({type:Ze})],wf.prototype,"shadowColor",void 0),u([d()],wf.prototype,"shadowDifference",void 0),wf=u([P("esri.views.3d.support.HighlightOptions")],wf);const pq=wf;let mb=class extends fe{constructor(e){super(e),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map(s=>s.toJSON()),r=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:zE(r),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],mb.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],mb.prototype,"outSpatialReference",void 0),u([d()],mb.prototype,"transformation",void 0),u([d()],mb.prototype,"transformForward",void 0),mb=u([P("esri.rest.support.ProjectParameters")],mb);const xK=mb,qft=Ls(xK);async function CCe(t,e,r){e=qft(e);const i=X5(t),s={...i.query,f:"json",...e.toJSON()},n=e.outSpatialReference,o=zE(e.geometries[0]),a=qBe(s,r);return Pi(i.path+"/project",a).then(({data:{geometries:l}})=>sve(l,o,n))}async function TK(t=null,e){var s,n;if(Qr.geometryServiceUrl)return Qr.geometryServiceUrl;if(!t)throw new j("internal:geometry-service-url-not-configured");let r;r="portal"in t?t.portal||Io.getDefault():t,await r.load({signal:e});const i=(n=(s=r.helperServices)==null?void 0:s.geometry)==null?void 0:n.url;if(!i)throw new j("internal:geometry-service-url-not-configured");return i}async function Wft(t,e,r=null,i){const s=await TK(r,i),n=new xK;n.geometries=[t],n.outSpatialReference=e;const o=await CCe(s,n,{signal:i});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new j("internal:geometry-service-projection-failed")}const Xft=Object.freeze(Object.defineProperty({__proto__:null,getGeometryServiceURL:TK,projectGeometry:Wft},Symbol.toStringTag,{value:"Module"}));let Yft=class{constructor(e,r){this.spatialReference=r,this.unitInMeters=al(this.spatialReference,Yr(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=TK(e&&e.get("portalItem")).catch(()=>{throw new j("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const r=await this._geometryServiceURLPromise;let i,s=!0;Array.isArray(e[0])&&typeof e[0]!="number"?i=e:(i=[e],s=!1);const n=i.map(l=>l instanceof _t?l:new _t(l,this.spatialReference)),o=new xK({geometries:n,outSpatialReference:We.WGS84}),a=(await CCe(r,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0).filter(l=>!!l);return s?a:a[0]}},Bd=class extends Te{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};u([d()],Bd.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Bd.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Bd.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],Bd.prototype,"snapshotAvailable",void 0),u([d()],Bd.prototype,"polygonLodFactor",void 0),u([d()],Bd.prototype,"polylineLodFactor",void 0),u([d()],Bd.prototype,"skipHighSymbolLods",void 0),Bd=u([P("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Bd);let rm=class extends Te{constructor(){super(...arguments),this.lodFactor=1}};u([d()],rm.prototype,"lodFactor",void 0),rm=u([P("esri.views.3d.support.QualitySettings.LoDFactorSettings")],rm);let S4=class extends rm{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};S4=u([P("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],S4);let Og=class extends Te{constructor(){super(...arguments),this.object=new S4,this.point=new rm,this.integratedMesh=new rm,this.pointCloud=new rm,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:S4})],Og.prototype,"object",void 0),u([d({type:rm})],Og.prototype,"point",void 0),u([d({type:rm})],Og.prototype,"integratedMesh",void 0),u([d({type:rm})],Og.prototype,"pointCloud",void 0),u([d()],Og.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Og=u([P("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Og);let h_=class extends Te{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=400}};u([d()],h_.prototype,"lodBias",void 0),u([d()],h_.prototype,"angledSplitBias",void 0),u([d()],h_.prototype,"reduceTileLevelDifferences",void 0),u([d()],h_.prototype,"textureFadeDuration",void 0),h_=u([P("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],h_);let tS=class extends Te{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],tS.prototype,"pixelRatio",void 0),u([d()],tS.prototype,"maxTotalNumberOfFeatures",void 0),tS=u([P("esri.views.3d.support.QualitySettings.HeatmapSettings")],tS);let Rl=class extends Te{constructor(){super(...arguments),this.graphics3D=new Bd,this.sceneService=new Og,this.tiledSurface=new h_,this.heatmap=new tS,this.fadeDuration=400,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.memoryLimit=void 0,this.additionalCacheMemory=void 0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};u([d({type:Bd})],Rl.prototype,"graphics3D",void 0),u([d({type:Og})],Rl.prototype,"sceneService",void 0),u([d({type:h_})],Rl.prototype,"tiledSurface",void 0),u([d({type:tS})],Rl.prototype,"heatmap",void 0),u([d()],Rl.prototype,"fadeDuration",void 0),u([d()],Rl.prototype,"antialiasingEnabled",void 0),u([d()],Rl.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],Rl.prototype,"highQualityTransparency",void 0),u([d()],Rl.prototype,"memoryLimit",void 0),u([d()],Rl.prototype,"additionalCacheMemory",void 0),u([d()],Rl.prototype,"frameRate",void 0),u([d()],Rl.prototype,"maximumPixelRatio",void 0),Rl=u([P("esri.views.3d.support.QualitySettings.QualitySettings")],Rl);const qle=Rl;function Zft(t){return rW(t)&&t.length>=3}function Jft(t){return(iW(t)||Array.isArray(t))&&t.length>=3}function Kft(t){return Zft(t)||Jft(t)}let Qft=class fq{constructor(e,r,i,s){this.viewingMode=e,this.spatialReference=r,this.unitInMeters=i,this._coordinateSystem=s,this._tmpCoordinateSystem=p9e(s)}set extent(e){e&&f9e(this._coordinateSystem,e,this._coordinateSystem)}getAltitude(e){return x9e(this._coordinateSystem,e)}setAltitude(e,r,i=e){return P0e(this._coordinateSystem,i,r,e)}setAltitudeOfTransformation(e,r){T9e(this._coordinateSystem,r,e,r)}worldUpAtPosition(e,r){return _9e(this._coordinateSystem,e,r)}worldBasisAtPosition(e,r,i){return v9e(this._coordinateSystem,e,r,i)}basisMatrixAtPosition(e,r){const i=this.worldBasisAtPosition(e,Pc.X,He.get()),s=this.worldBasisAtPosition(e,Pc.Y,He.get()),n=this.worldBasisAtPosition(e,Pc.Z,He.get());return Tm(r,i[0],i[1],i[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),r}headingAtPosition(e,r){const i=this.worldUpAtPosition(e,He.get()),s=this.worldBasisAtPosition(e,Pc.Y,He.get()),n=uye(r,s,i);return ol(n)}intersectManifoldClosestSilhouette(e,r,i){return WU(this._coordinateSystem,r,this._tmpCoordinateSystem),w9e(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,r,i){WU(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=He.get();return b9e(this._tmpCoordinateSystem,e,s)?le(i,s):null}intersectInfiniteManifold(e,r,i){if(this.viewingMode===Be.Global)return this.intersectManifold(e,r,i);WU(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,n=He.get();return ax(s.plane,e,n)?le(i,n):null}toRenderCoords(e,r,i){return yF(e)?ta(e,r,this.spatialReference):uo(e,r,i,this.spatialReference)}fromRenderCoords(e,r,i=null){return yF(r)?(v(i)&&(r.spatialReference=i),Hfe(e,this.spatialReference,r)):Kft(r)?uo(e,this.spatialReference,r,i)?r:null:iv(e,this.spatialReference,r)}static create(e,r){switch(e){case Be.Local:return new fq(Be.Local,r,al(r),y9e());case Be.Global:return new fq(Be.Global,r,1,g9e(r))}}static renderUnitScaleFactor(e,r){return Wle(e)/Wle(r)}};function Wle(t){if(eE(t,Be.Global))return 1;const e=I0e(!1,t);return al(e)}var Bf;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.BASEMAP=1]="BASEMAP",t[t.I3S_INDEX=2]="I3S_INDEX",t[t.I3S_DATA=3]="I3S_DATA",t[t.SYMBOLOGY=4]="SYMBOLOGY"})(Bf||(Bf={}));const emt=(()=>{const t=new Array;return t[Bf.ELEVATION]=10,t[Bf.BASEMAP]=10,t[Bf.I3S_INDEX]=10,t[Bf.I3S_DATA]=10,t[Bf.SYMBOLOGY]=5,t})(),tmt=30;function ACe(t){return typeof t.getUsedMemory=="function"}function rmt(t){return new Ol({view:t})}const B$=1,DV=1,imt=.75,smt=.6,Xle=1.3;let Ol=class extends Te{constructor(e){super(e),this._quality=1,this._memoryUsed=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new qY,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(B$),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){e!=null&&e>=0&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}newCache(e,r){return new fBe(e,this._cacheStorage,r)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<smt&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(B$);else if(e)(this._memoryPredicted>1.1*DV||this._memoryUsed>DV)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/Xle),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>DV)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/Xle),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<imt&&this._quality<B$){this._stableQuality=this._quality;const r=.05;e=this._updateQuality(this._quality+r)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),B$))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){let e=0,r=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(e+=this.view.basemapTerrain.getUsedMemory());const i=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderer.edgeView;v(i)&&(e+=i.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach(a=>{if(ACe(a)){const l=a.ignoresMemoryFactor()?this._quality:1;e+=a.getUsedMemory()*l,r+=a.getUnloadedMemory()*l}});const s=C(this._warnMemoryUsage)||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(e>n&&s){this._warnMemoryUsage=e;const a=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);se.getLogger(this.declaredClass).warn(`Memory Limit exceeded! Limit: ${a(n)} Current: ${a(e)} Projected: ${a(e+r)} Quality: ${l}%`)}this._memoryUsed=e/n,this._memoryPredicted=(e+r)/n;const o=n-e;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const r=e._numQualityChanges;return e._numQualityChanges=0,r}}}};u([d({constructOnly:!0})],Ol.prototype,"view",void 0),u([d()],Ol.prototype,"maxMemory",null),u([d()],Ol.prototype,"additionalCacheMemory",null),u([d()],Ol.prototype,"memoryFactor",null),u([d()],Ol.prototype,"updating",null),u([d()],Ol.prototype,"usedMemory",null),u([d()],Ol.prototype,"_quality",void 0),u([d()],Ol.prototype,"_memoryUsed",void 0),u([d()],Ol.prototype,"_updating",void 0),u([d()],Ol.prototype,"_stableQuality",void 0),u([d()],Ol.prototype,"_maxMemory",void 0),u([d()],Ol.prototype,"_additionalCacheMemory",void 0),Ol=u([P("esri.views.3d.support.MemoryController")],Ol);let nmt=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},omt=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new amt}},amt=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},lmt=class{constructor(e,r,i,s){this._workerFunc=e,this._callbackFunc=r,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=s.map(n=>new omt(n))}destroy(){this._clients.length=0}hasQuota(e){const r=this._clients[e];return!!r&&(this._totalNumWorkers<this._maxTotalNumWorkers||r.numWorkers+r.tasks.length<r.typeWorkerQuota)}push(e){const r=this._clients[e.client];r&&(this._totalNumWorkers<this._maxTotalNumWorkers?(r.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,s)=>this._taskCallback(i,s))):r.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const r=this._clients[e.client];this._totalNumWorkers--,r.numWorkers--,r.statistics.requests++,r.statistics.size+=e.size||0,r.statistics.duration+=e.duration||0,r.statistics.speed=r.statistics.duration>0?r.statistics.size/r.statistics.duration:0,gt(r.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(r,i)=>this._taskCallback(r,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,r){e._cancelled||(this._callbackFunc(e,r),this._taskFinished(e))}getStatsForType(e){const r=this._clients[e];return r?{quota:r.typeWorkerQuota,workers:r.numWorkers,queueSize:r.tasks.length,requestStats:r.statistics}:null}get test(){const e=this;return{set workerFunc(r){e._workerFunc=r}}}},nN=class extends Te{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,r,i){this._loadQueue=new lmt((s,n)=>this._startLoading(s,n),(s,n)=>this._doneLoadingCB(s,n),e,r),i&&(this._frameTask=i.registerTask(yt.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Vi(this._frameTask),this._tasks.forEach(e=>jh(e.abortController)),this._loadQueue=Ve(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,r,i,s={}){const n=K_();n.__signal=v(s)?s.signal:null;const o=this._createOrUpdateTask(e,r,i,s,n);return ba(s,()=>this._cancelRequest(o,n)),n.promise}_createTask(e,r,i,s,n,o){const a=new hmt(e,r,i,s,n);return this._updateTask(a,o),this._tasks.set(n,a),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,r){var i;r3(e.resolvers,r),r.reject(qr()),e.resolvers.length===0&&(e.status===_h.DOWNLOADING&&(e.status=_h.CANCELLED,this._loadQueue.cancel(e),(i=e.abortController)==null||i.abort(),e.request=null,e.abortController=null),e.status=_h.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,r){e.resolvers.push(r)}_createOrUpdateTask(e,r,i,s,n){const o=dmt(v(s)&&s.uid||e,r,i),a=this._tasks.get(o);return a?(this._updateTask(a,n),a):this._createTask(e,s,r,i,o,n)}_doneLoadingCB(e,r){this._loadQueue&&(gt(e.status===_h.DOWNLOADING),e.status=_h.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:r}):this._doneLoading(e,r))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const r=this._onLoadQueue.shift();ur(r.task.abortController),r.task.abortController=null,r.callback(r.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const r=this._doneQueue.shift();r.task.status!==_h.DOWNLOADED&&(r.err=r.err||qr()),this._doneLoading(r.task,r.err),e.madeProgress()}}_doneLoading(e,r){if(r&&!Ks(r)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const s of e.resolvers)if(r)Ks(r)?s.reject(r):s.reject(new j("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${r}`,{url:e.url,error:r}));else{--i;const n=i<=0?e.result:te(e.result);s.resolve(n)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,r){if(e.status===_h.CANCELLED)return!1;let i,s;switch(e.startTime=performance.now(),e.status=_h.DOWNLOADING,e.docType){case"binary":s="array-buffer",i=0;break;case"image":s="image";break;case"image+type":s="array-buffer";break;default:s="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=Pi(e.url,{...e.options,responseType:s,timeout:i,signal:n});let o=()=>{};const a=c=>{e.duration=performance.now()-e.startTime,e.size=c instanceof ArrayBuffer?c.byteLength:e.size||0,e.result=c,this._frameTask?this._onLoadQueue.push({callback:r,task:e}):(e.abortController=null,r(e))},l=c=>{e.status===_h.DOWNLOADING&&r(e,c),o()};return e.docType!=="image+type"?(e.request.then(c=>a(c.data),l),!0):(e.request.then(c=>{const h=c.data,p=umt(h);if(s="image",e.size=h.byteLength,p==="unknown")return e.request=Pi(e.url,{responseType:s,timeout:i,signal:n}),void e.request.then(y=>a(y.data),l);const f=new Blob([h],{type:p}),m=window.URL.createObjectURL(f);o=()=>window.URL.revokeObjectURL(m),e.request=Pi(m,{responseType:s,timeout:i,signal:n}),e.request.then(y=>a(new q6(y.data,p,o)),l)},l),!0)}get test(){return{loadQueue:this._loadQueue}}};u([d({readOnly:!0})],nN.prototype,"updating",void 0),nN=u([P("esri.views.3d.support.StreamDataLoader")],nN);const cmt={numRetries:0};function umt(t){if(t.byteLength<2)return"unknown";const e=new Uint8Array(t,0,t.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let q6=class{constructor(e,r,i){this.image=e,this.type=r,this.release=i}get isOpaque(){return this.type==="image/jpeg"}},hmt=class extends nmt{constructor(e,r,i,s,n){super(s),this.url=e,this.options=r,this.docType=i,this.key=n,this.result=null,this.status=_h.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=cmt.numRetries}};function dmt(t,e,r){return`${t}:${e}:${r}`}var _h;(function(t){t[t.QUEUED=1]="QUEUED",t[t.DOWNLOADING=2]="DOWNLOADING",t[t.DOWNLOADED=3]="DOWNLOADED",t[t.CANCELLED=4]="CANCELLED"})(_h||(_h={}));let oN=class extends Te{constructor(){super(...arguments),this.updating=!1}};function pmt(t){return new xf({view:t})}u([d({readOnly:!0})],oN.prototype,"updating",void 0),oN=u([P("esri.views.3d.support.ResourceControllerMain")],oN);let xf=class extends oN{constructor(){super(...arguments),this._immediateTask=mE,this._normalTask=mE,this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=A8e(),this._memoryController=rmt(this.view),this._streamDataLoader=new nN,this._streamDataLoader.setup(tmt,emt,this._scheduler),this.addHandles([ne(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},ri),ne(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=kS({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(yt.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(yt.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Vi(this._frameTask),this._streamDataLoader=Ve(this._streamDataLoader),this._memoryController=Ve(this._memoryController),this._scheduler=Ve(this._scheduler)}get updating(){var e,r,i;return!!((e=this._memoryController)!=null&&e.updating||(r=this._streamDataLoader)!=null&&r.updating||(i=this._immediateTask)!=null&&i.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const r=this._streamDataLoader;return{request:(i,s,n)=>r.request(i,s,e,n),get busy(){return!r.hasDownloadSlots(e)}}}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(bW(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};u([d({constructOnly:!0})],xf.prototype,"view",void 0),u([d()],xf.prototype,"_scheduler",void 0),u([d()],xf.prototype,"_memoryController",void 0),u([d()],xf.prototype,"_streamDataLoader",void 0),u([d()],xf.prototype,"_immediateTask",void 0),u([d()],xf.prototype,"_normalTask",void 0),u([d({readOnly:!0})],xf.prototype,"updating",null),xf=u([P("esri.views.3d.support.ResourceControllerImpl")],xf);function fmt(t){return"performanceInfo"in t}const oT=M(),mmt=M(),Xm=M(),Ym=M();function gmt(t,e,r=0){const i=t.extent;if(C(i))return!1;if(r===0)return Vfe(i,e);const s=Math.min(i[2]-i[0],i[3]-i[1]);return SDe(i,e,r*s)}function G$(t,e,r,i){le(oT,r),oT[i]=e[i];const s=ge(oT,oT,e),n=ge(mmt,t,e),o=_e(n,s),a=_e(s,s);let l;l=o<=0?e:a<=o?r:me(oT,e,ae(s,s,o/a));const c=ge(oT,t,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function ymt(t,e,r){const i=t.extent;if(C(i))return 0;Xm[0]=i[0],Xm[1]=i[1],Xm[2]=r,Ym[0]=i[2],Ym[1]=i[3],Ym[2]=r;let s=1/0,n=1/0;return e[0]<Xm[0]?s=G$(e,Xm,Ym,0):e[0]>Ym[0]&&(s=G$(e,Ym,Xm,0)),e[1]<Xm[1]?n=G$(e,Xm,Ym,1):e[1]>Ym[1]&&(n=G$(e,Ym,Xm,1)),Math.min(s,n)}function _mt(t,e,r){if(C(t))return PZ();if(t.spatialReference.isGeographic&&!Aw(t.spatialReference))return new j("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const i=Ec.checkUnsupported(t);if(v(i))return i;if(C(r))return new j("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const s=vmt(t,r);if(s)return s;const n=t.spatialReference;return v(e)&&!(n.equals(e)||e.isWGS84&&n.isWebMercator)?new j("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function vmt(t,e){const r=t.lods,i=r[0].resolution*2**r[0].level,s=[i*t.size[0],i*t.size[1]],n=[t.origin.x,t.origin.y],o=Ffe(e),a=hr();Ec.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>j2){const c=r[0].scale*2**r[0].level;let h=Math.max((o[3]-o[1])/t.size[1],(o[2]-o[0])/t.size[0])*c/i;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new j("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:j2})}return null}const bmt=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:_mt,isInsideExtent:gmt,tiltToExtentEdge:ymt},Symbol.toStringTag,{value:"Module"}));function wmt(){return!0}function xmt(){return 0}function Tmt(t,e){if(C(t))return PZ();const r=t.lods.length-1,i=t.spatialReference,s=Aw(i)||wm(i)||xm(i);if(i.isWebMercator){if(!Ec.makeWebMercatorAuxiliarySphere(r).compatibleWith(t))return new j("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new j("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Ec.makeGCSWithTileSize(t.spatialReference,t.size[0],r).compatibleWith(t))return t.spatialReference.isWGS84?new j("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new j("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return v(e)&&!t.spatialReference.equals(e)?new j("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const Smt=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:Tmt,isInsideExtent:wmt,tiltToExtentEdge:xmt},Symbol.toStringTag,{value:"Module"})),Emt={[Be.Global]:Smt,[Be.Local]:bmt};function Df(t,e){t||console.warn("Terrain: "+e)}let En=!1,E4=!1;function Cmt(t){E4=t,En=En||t}function Amt(t){En=t}function Re(t,e){var r;if(En&&!t){const i=(r=new Error().stack)==null?void 0:r.slice(5);throw console.warn("Terrain internal: "+(e||"")+" at "+i),new Error("Assertion failed"+(e?": "+e:""))}}function mq(t){return W6(t)?{fullExtent:t.fullExtent,minScale:t.layer.minScale,maxScale:t.layer.maxScale,tilemapCache:null}:t.layer}function C4(t){return(t==null?void 0:t.type)==="imagery-tile"||(t==null?void 0:t.type)==="wcs"}function W6(t){return(t==null?void 0:t.type)==="imagery-tile-3d"}function SK(t){return(t==null?void 0:t.type)==="tile-3d"}function iM(t){return(t==null?void 0:t.type)==="vector-tile-3d"}function RCe(t){return(t==null?void 0:t.type)==="wmts-3d"}function gq(t){return(t==null?void 0:t.type)==="elevation-3d"}function gA(t){return(t==null?void 0:t.type)==="group"}function A4(t){return t&&(SK(t)||RCe(t)||W6(t)||iM(t))}function yq(t){return t&&(SK(t)||W6(t)||iM(t)||RCe(t))}function sM(t){return yq(t)||gq(t)}function Rmt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return v(e)&&"type"in e&&e.type==="raster-tile"}function Omt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return v(e)&&"type"in e&&e.type==="vector-tile"}function Mmt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return v(e)&&"type"in e&&e.type==="tile-texture"}function Pmt(t){var r;const e=(r=t==null?void 0:t.sourceLayerInfo)==null?void 0:r.data;return e instanceof HTMLImageElement||e instanceof q6||e instanceof HTMLCanvasElement||e instanceof ImageData}function MS(t){return v(t)&&"release"in t&&t.release(),null}function Yle(t){return t.fetchTile&&t.hasOverriddenFetchTile!==!1}function EK(t,e,r,i){return Emt[i].checkIfTileInfoSupportedForViewSR(t,r,e)}function X6(t,e,r){let i=null,s=null;if((t==null?void 0:t.type)==="wmts"){const n=Imt(t,e,r);i=n.tileInfo,s=n.fullExtent}else{s=C4(t)?t.getCompatibleFullExtent(e):t.fullExtent;const n=r===Be.Local;if(C4(t))i=t.getCompatibleTileInfo(e,s,n);else if((t==null?void 0:t.type)==="vector-tile"){const o=n&&!$mt(e)||Lmt.force512VTL,a=t.tileInfo.spatialReference.isGeographic;i=o?t.tileInfo:t.tileInfo.getOrCreateCompatible(256,a?1:2)}else i=t.tileInfo}return v(i)&&v(s)&&EK(i,s,e,r)==null?{tileInfo:i,fullExtent:s}:null}function Imt(t,e,r){const i=f$e(t);if(v(i)){if(!ft.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const s=i.find(n=>EK(n.tileInfo,n.fullExtent,e,r)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function $mt(t){return t.isWGS84||t.isWebMercator||spe(t)||!BS(t)}const Lmt={force512VTL:!1};function Zle(t){return"["+t[0]+","+t[1]+","+t[2]+"]"}function Zm(t){return"("+t[0]+","+t[1]+","+t[2]+")"}function Mh(t,e,r=Fmt){return Math.abs(t-e)<r}function _q(t){return t===Rt.NORTH_EAST?Rt.SOUTH_WEST:t===Rt.NORTH_WEST?Rt.SOUTH_EAST:t===Rt.SOUTH_WEST?Rt.NORTH_EAST:Rt.NORTH_WEST}function R4(t){return t===Rt.NORTH?Rt.SOUTH:t===Rt.EAST?Rt.WEST:t===Rt.SOUTH?Rt.NORTH:Rt.EAST}function Dmt(t){return t===Rt.NORTH_WEST||t===Rt.SOUTH_WEST}function Nmt(t){return t===Rt.NORTH_WEST||t===Rt.NORTH_EAST}function Jle(t){return t===Rt.NORTH_WEST||t===Rt.WEST||t===Rt.SOUTH_WEST}function Kle(t){return t===Rt.NORTH_EAST||t===Rt.EAST||t===Rt.SOUTH_EAST}function Qle(t){return t===Rt.SOUTH_EAST||t===Rt.SOUTH||t===Rt.SOUTH_WEST}function ece(t){return t===Rt.NORTH_EAST||t===Rt.NORTH||t===Rt.NORTH_WEST}const Xf=[Rt.NORTH,Rt.EAST,Rt.SOUTH,Rt.WEST],O4=[Rt.NORTH_EAST,Rt.SOUTH_EAST,Rt.SOUTH_WEST,Rt.NORTH_WEST],Fmt=1e-5;let Umt=class{constructor(e,r){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=sM(e)?r.basemapTerrain.getUsedMemoryForLayerView(e):e.getUsedMemory(),fmt(e)){const i=e.performanceInfo;this.displayedNumberOfFeatures=i.displayedNumberOfFeatures,this.maximumNumberOfFeatures=i.maximumNumberOfFeatures,this.totalNumberOfFeatures=i.totalNumberOfFeatures}}},Vmt=class{constructor(e){var i;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,v(e.resourceController)){const s=e.resourceController.memoryController;this.totalMemory=(s.maxMemory??0)*hE.MEGABYTES,this.usedMemory=Math.round(s.usedMemory*this.totalMemory),this.quality=s.memoryFactor,this.load=e.resourceController.scheduler.load}this.terrainMemory=((i=e.basemapTerrain)==null?void 0:i.getUsedMemory())??0;const r=e._stage&&e._stage.renderView&&e._stage.renderer.edgeView;this.edgesMemory=v(r)?r.usedMemory:0,e.allLayerViews.items.forEach(s=>{(ACe(s)||sM(s))&&this.layerPerformanceInfos.push(new Umt(s,e))}),this.layerPerformanceInfos.sort((s,n)=>n.memory-s.memory)}},kmt=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,r,i){const s=i?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(s);return v(n)?Promise.resolve(n):this._loadOnce(this._gltfLoading,this._gltfMemCache,s,o=>VEe(new FEe(o.streamDataRequester),e,o,i),r)}loadWOSR(e,r){const i=`wosr:${e}:${r.disableTextures}`,s=this._wosrMemCache.get(i);return v(s)?Promise.resolve(s):this._loadOnce(this._wosrLoading,this._wosrMemCache,i,n=>kEe(e,n),r)}async _loadOnce(e,r,i,s,n){ur(n);const o=ba(n,()=>this._abortLoad(e,i));let a=e.get(i);if(a)a.refCount++;else{const l=new AbortController;a={refCount:1,abortController:l,promise:s({...n,signal:l.signal})},e.set(i,a)}try{const l=await a.promise;return r.put(i,l,l.size),e.delete(i),ur(n),l}finally{Vi(o)}}_abortLoad(e,r){const i=e.get(r);v(i)&&--i.refCount>0||(e.delete(r),v(i)&&i.abortController.abort())}},zmt=class extends H2{constructor(e,r,i,s){super(r,s),this._streamDataRequester=e,this._parameters=i}async fromUrl(e,r,i){ur(i);const s=v(i)?i.signal:null,n=this.makeUid(e,r);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:n,signal:a.signal});o={referenceCount:0,texture:null,textureAsync:null,abortController:a};const c=o;this._textureRequests.set(n,o),o.textureAsync=l.then(async h=>{const p=this._createTexture(e,h,r);return c.texture=p,c.abortController=null,this._stage.add(p),await this._stage.load(p),{uid:n,texture:p,release:()=>this._release(n)}},h=>{throw c.abortController=null,h})}o.referenceCount++;try{return await _W(o.textureAsync,s)}catch(a){throw this._release(n),a}}_createTexture(e,r,i){var n;const s={...this._parameters,powerOfTwoResizeMode:H_.PAD};if(ede(e)){if(i||r.width===0&&r.height===0){const o=r.width?r.height/r.width:1;i=i||64,o>1?(r.width=Math.round(i/o),r.height=i):(r.width=i,r.height=Math.round(i*o))}(n=this._stage.renderView)!=null&&n.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return s.width=r.width,s.height=r.height,new fx(r,s)}},Bmt=class{constructor(e){this.textures=null,this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Bf.SYMBOLOGY),this.objectResourceCache=new kmt((i,s)=>e.resourceController.memoryController.newCache(i,s)),this.textures=new zmt(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:Ot.CLAMP_TO_EDGE,t:Ot.CLAMP_TO_EDGE}},e.resourceController.scheduler);const r=Yr(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=_Te(e.viewingMode,r),this.screenSizePerspectiveSettingsLabels=jit(e.viewingMode,r)}destroy(){Ve(this.textures),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return yp();this._graphicsOwners.push(e);const r=ne(()=>{var i;return(i=e.layer)==null?void 0:i.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),yp(()=>{r.remove(),r3(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(r=>{var i;return((i=r.layer)==null?void 0:i.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new Zr;const r=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([ne(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,r,ri),this._viewState.events.on("camera-projection-changed",r)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=Ve(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;j$.distance=e.centerOnSurfaceInfrequent.distance,j$.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(j$),this.screenSizePerspectiveSettingsLabels.update(j$),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}};const j$={distance:0,fovY:0};let E2=class{constructor(e,r,i=""){this.graphics=e,this._symbol=new P_({symbolLayers:[new M_({material:{color:r},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new sx({text:i,halo:{color:"white",size:1/.75},material:{color:r},size:12})]})}show(e,r){if(C(r))return;this.hide();const i=new _t({x:e[0],y:e[1],z:e[2],spatialReference:r});this._graphic=new Sa({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){v(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}},b_=class extends Te{constructor(e){super(e),this.handles=new Zr}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],b_.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],b_.prototype,"surface",void 0),u([d({constructOnly:!0})],b_.prototype,"state",void 0),b_=u([P("esri.views.3d.support.PointOfInterest")],b_);const Gmt=Array;let Vd=class extends b_{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new cy({location:_t,renderLocation:Gmt},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=M(),this._tmpPoint=new _t}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(an(()=>{var r,i;return(i=(r=this.map)==null?void 0:r.ground)==null?void 0:i.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=Ve(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,r=Si(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return $w(i,r,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return this._updateSurfaceAltitude(0),ea.YIELD;const e=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,e);const r=(this._tmpPoint.z??0)>jmt&&this.renderCoordsHelper.viewingMode===Be.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:r?Hmt:0}).then(s=>this._updateSurfaceAltitude(s.geometry.z??0)).catch(s=>{Ks(s)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,ea.YIELD}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(NV,this._estimatedSurfaceAltitude,this._camera.eye),Qa(this._get("renderLocation"),NV)||(this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),NV)),this.notifyChange("renderLocation"))}};u([d({constructOnly:!0})],Vd.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Vd.prototype,"cache",void 0),u([d({constructOnly:!0})],Vd.prototype,"task",void 0),u([d({readOnly:!0})],Vd.prototype,"location",null),u([d({constructOnly:!0})],Vd.prototype,"map",void 0),u([d({readOnly:!0})],Vd.prototype,"renderLocation",void 0),u([d({readOnly:!0})],Vd.prototype,"scale",null),u([d({readOnly:!0})],Vd.prototype,"updating",null),Vd=u([P("esri.views.3d.support.CameraOnSurface")],Vd);const NV=M(),jmt=1e5,Hmt=1e6,qmt=Array;let vh=class extends b_{constructor(e){super(e),this._propertiesPool=new cy({location:_t,renderLocation:qmt},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=M(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Vi(this._frameWorker),this._propertiesPool=Ve(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,ea.YIELD}_updateRenderLocation(){const e=Xmt;let r=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!r&&i&&(r=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),r&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=Ymt;r&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(le(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),r?this.distance=Si(this._camera.eye,e):(ae(e,this._camera.viewForward,this._get("distance")),me(e,e,this._camera.eye)),Qa(this._get("renderLocation"),e)||this._set("renderLocation",le(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,r){var s,n;const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,r))return!1;if(this.state.isGlobal){const o=Yr(this.renderCoordsHelper.spatialReference).radius,a=o+e,l=ga(i.eye),c=l<a*a,h=Si(i.eye,r);if(c&&h>o/4){const p=a-Math.sqrt(l);return ae(r,i.viewForward,p),me(r,r,i.eye),!0}}else{const o=(s=this.surface)!=null&&s.ready?this.surface.extent:null;v(o)&&c5(o,(n=this.surface)==null?void 0:n.spatialReference,yA,this.renderCoordsHelper.spatialReference)&&(r[0]=ye(r[0],yA[0],yA[2]),r[1]=ye(r[1],yA[1],yA[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,r){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,r)){if(Wr.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,s=Si(i,e),n=Si(i,r);if(Math.abs(n-s)/s>Wmt)return!0}return!1}};u([d({constructOnly:!0})],vh.prototype,"scheduler",void 0),u([d({constructOnly:!0})],vh.prototype,"task",void 0),u([d()],vh.prototype,"distance",void 0),u([d({constructOnly:!0})],vh.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],vh.prototype,"location",null),u([d({readOnly:!0})],vh.prototype,"renderLocation",void 0),u([d()],vh.prototype,"updating",void 0),vh=u([P("esri.views.3d.support.CenterOnSurface")],vh);const Wmt=.05,Xmt=M(),Ymt=M(),yA=hr();let Zmt=class{constructor(e){this._handles=new Zr,this.events=new Fs,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",r=>this._layerViewsChanged(r))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=Ve(this._handles)}_layerViewsChanged(e){e.added.forEach(r=>{r.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(r.on("visible-geometry-changed",()=>this._contentChanged()),r.uid)}),e.removed.forEach(r=>this._handles.remove(r.uid))}_contentChanged(){this.events.emit("request-update",Jmt)}};const Jmt={},Kmt=Array;let Tf=class extends b_{constructor(e){super(e),this._propertiesPool=new cy({location:_t,renderLocation:Kmt},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([ne(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),ne(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(yt.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=Ve(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),r=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(r,tce);const n=Math.max(0,(Math.acos(_e(tce,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!Q_(e,r)){const c=this._propertiesPool.get("renderLocation");le(c,r),this._set("renderLocation",c)}return ea.YIELD}const o=1-ye(n/(.5*Math.PI),0,1),a=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(rce);const l=this._propertiesPool.get("renderLocation");return Qs(l,r,rce,a),e&&Q_(e,l)||this._set("renderLocation",l),ea.YIELD}_calculateScreenHorizontalEdgeOnSurface(e){const r=this.state.contentCamera,i=r.getRenderCenter(Zo());if(i[1]=r.aboveGround?r.padding[cr.BOTTOM]:r.fullHeight-r.padding[cr.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(r.unprojectFromRenderScreen(i,_A)){ge(_A,_A,r.eye);const n=ve(_A,_A);if(this.renderCoordsHelper.intersectManifold(Vu(r.eye,n),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,r.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],Tf.prototype,"_dirty",void 0),u([d({constructOnly:!0})],Tf.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Tf.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],Tf.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],Tf.prototype,"updating",null),u([d({readOnly:!0})],Tf.prototype,"location",null),u([d({readOnly:!0})],Tf.prototype,"renderLocation",void 0),Tf=u([P("esri.views.3d.support.pointsOfInterest.Focus")],Tf);const tce=M(),_A=M(),rce=M();let xg=class extends Te{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=M();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new Zr}initialize(){this.view.state.isLocal&&(this._handles.add([ne(()=>{var e,r;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(r=this.surfaceView)==null?void 0:r.extent]},()=>this._update()),an(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||C(this.surfaceView.extent)||C(this.surfaceView.spatialReference))return void this._set("location",null);const e=gX(this.surfaceView.extent),r=new _t({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(r,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{Ks(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",r)}};u([d({constructOnly:!0})],xg.prototype,"view",void 0),u([d({constructOnly:!0})],xg.prototype,"cache",void 0),u([d()],xg.prototype,"surface",null),u([d()],xg.prototype,"surfaceView",null),u([d({readOnly:!0})],xg.prototype,"location",void 0),u([d({readOnly:!0})],xg.prototype,"renderLocation",null),xg=u([P("esri.views.3d.terrain.StableSurfaceCenter")],xg);let Tg=class extends Te{constructor(e){super(e),this._tileGeometryUpdateExtent=Xh(),this._tileGeometryUpdateSpatialReference=null,this.events=new Fs,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(yt.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating&&(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Qmt),Xh(this._tileGeometryUpdateExtent),this._set("updating",!1)),ea.YIELD}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,z_(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let r=1;r<this.centerOnSurfaces.length;r++){const i=this.centerOnSurfaces[r];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,r){const i=this.state.contentCamera.eye,s=egt,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,m1,r),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,g1,r),m1[0]<g1[0]?(s[0]=m1[0],s[2]=g1[0]):(s[0]=g1[0],s[2]=m1[0]),m1[1]<g1[1]?(s[1]=m1[1],s[3]=g1[1]):(s[1]=g1[1],s[3]=m1[1]),l5(s,e)}};u([d({constructOnly:!0})],Tg.prototype,"state",void 0),u([d({constructOnly:!0})],Tg.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],Tg.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Tg.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Tg.prototype,"surface",void 0),u([d({readOnly:!0})],Tg.prototype,"updating",void 0),Tg=u([P("esri.views.3d.support.SurfaceGeometryUpdates")],Tg);const Qmt={},m1=M(),g1=M(),egt=Xh();let $l=class extends Te{constructor(e){super(e),this._handles=new Zr,this._tmpRay=no(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new cy({renderPointOfView:tgt},this),this.renderPointOfView=M(),this._pois=new Array,this._debugCenters=new Map}initialize(){var h;const{state:e,basemapTerrain:r,renderCoordsHelper:i,map:s}=this.view;this._surfaceIntersector=Qh(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Do.MIN,this._contentIntersector=Qh(e.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=(h=this.view.basemapTerrain)==null?void 0:h.elevationQueryCache,l={state:e,scheduler:o,surface:r,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new vh({...l,task:yt.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new vh({...l,task:yt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new vh({...l,task:yt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Vd({...l,cache:a,task:yt.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("surfaceGeometryUpdates",new Tg({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new Zmt({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new xg({cache:a,view:this.view})),this._set("focus",new Tf({state:e,scheduler:o,surface:r,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:(p,f)=>this._estimateSurfaceIntersectionAtRenderPoint(p,this.view.state.contentCamera,f)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new E2(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new E2(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new E2(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new E2(c,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new E2(c,"green","Focus")),this._handles.add([ne(()=>e.contentCamera,p=>this._cameraChanged(p),ri),ne(()=>r.extent,()=>this._updateCenterPointsOfInterest()),ra(()=>!r.updating,()=>this._updateCenterPointsOfInterest(),ri),an(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),an(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),ra(()=>Wr.SHOW_POI,p=>this._setDebug(p),kt)]),this._cameraChanged(this.view.state.contentCamera);for(const p of this._pois)p.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(r=>r.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return C(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,aT,igt)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(aT):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(C(e))return this._surfaceAltitudeAtCenter;const r=e.origin,i=me(aT,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,i),this._surfaceIntersector.results.min.getIntersectionPoint(aT)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(aT)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,r,i){const s=bJ(r,e,rgt);if(C(s))return null;const n=s.origin,o=me(aT,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s,r),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,o),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const r=e.eye;Qa(this.renderPointOfView,r)||this._set("renderPointOfView",le(this._propertiesPool.get("renderPointOfView"),r))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(r=>r.hide()),void this._handles.remove("debug");for(const r of this._pois)this._handles.add(ne(()=>r.renderLocation,i=>{var s;return(s=this._debugCenters.get(r))==null?void 0:s.show(i,r.renderCoordsHelper.spatialReference)},kt),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],$l.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],$l.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],$l.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],$l.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],$l.prototype,"focus",void 0),u([d({readOnly:!0})],$l.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],$l.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],$l.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],$l.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],$l.prototype,"view",void 0),u([d({readOnly:!0})],$l.prototype,"updating",null),$l=u([P("esri.views.3d.support.PointsOfInterest")],$l);const tgt=Array,aT=M(),rgt=no(),igt={exclude:new Set([f_])};let sgt=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,r){this._store.put(e,r,r.values.byteLength+256)}},ngt=class{constructor(e,r,i,s){this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in e?(this.values=e.pixelData,this.width=e.width,this.height=e.height,this.noDataValue=e.noDataValue):(this.values=e,this.width=r,this.height=i,this.noDataValue=s)}get hasNoDataValues(){if(C(this._hasNoDataValues)){const e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}get minValue(){return this._ensureBounds(),this._minValue}get maxValue(){return this._ensureBounds(),this._maxValue}_ensureBounds(){if(v(this._minValue))return;const{noDataValue:e,values:r}=this;let i=1/0,s=-1/0,n=!0;for(const o of r)o===e?this._hasNoDataValues=!0:(i=o<i?o:i,s=o>s?o:s,n=!1);n?(this._minValue=0,this._maxValue=0):(this._minValue=i,this._maxValue=s>-3e38?s:0)}},OCe=class{constructor(e,r,i,s,n={}){this._mainMethod=r,this._transferLists=i,this._listeners=[],this._promise=R0e(e,{...n,schedule:s}).then(o=>{if(this._thread===void 0){this._thread=o,this._promise=null,n.hasInitialize&&this.broadcast({},"initialize");for(const a of this._listeners)this._connectListener(a)}else o.close()}),this._promise.catch(o=>se.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${o}`))}on(e,r){const i={removed:!1,eventName:e,callback:r,threadHandle:null};return this._listeners.push(i),this._connectListener(i),yp(()=>{i.removed=!0,Qq(this._listeners,i),this._thread&&v(i.threadHandle)&&i.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(e,r){return this.invokeMethod(this._mainMethod,e,r)}invokeMethod(e,r,i){if(this._thread){const s=this._transferLists[e],n=s?s(r):[];return this._thread.invoke(e,r,{transferList:n,signal:i})}return this._promise?this._promise.then(()=>(ur(i),this.invokeMethod(e,r,i))):Promise.reject(null)}broadcast(e,r){return this._thread?Promise.all(this._thread.broadcast(r,e)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(e,r)):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then(r=>{e.removed||(e.threadHandle=r)})}},ice=class extends OCe{constructor(e=null){super("LercWorker","_decode",{_decode:r=>[r.buffer]},e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,r,i){return e&&e.byteLength!==0?this.invoke({buffer:e,options:r},i):Promise.resolve(null)}release(){--this.ref<=0&&(ZO.forEach((e,r)=>{e===this&&ZO.delete(r)}),this.destroy())}};const ZO=new Map;function ogt(t=null){let e=ZO.get(t);return e||(v(t)?(e=new ice(r=>t.immediate.schedule(r)),ZO.set(t,e)):(e=new ice,ZO.set(null,e))),++e.ref,e}var xc,sce,nce;(function(t){t[t.FILL=1]="FILL",t[t.LINE=2]="LINE",t[t.SYMBOL=3]="SYMBOL",t[t.CIRCLE=4]="CIRCLE"})(xc||(xc={})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.FILL=1]="FILL",t[t.OUTLINE=2]="OUTLINE",t[t.LINE=3]="LINE",t[t.ICON=4]="ICON",t[t.CIRCLE=5]="CIRCLE",t[t.TEXT=6]="TEXT",t[t.TILEINFO=7]="TILEINFO"}(sce||(sce={})),function(t){t[t.PAINTER_CHANGED=0]="PAINTER_CHANGED",t[t.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",t[t.LAYER_CHANGED=2]="LAYER_CHANGED",t[t.LAYER_REMOVED=3]="LAYER_REMOVED",t[t.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(nce||(nce={}));let agt=class{constructor(e){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}},QNt=class{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}};function tFt(t,e,r,i,s,n){const o=r-s;if(o>=0)return(e>>o)+(i-(n<<o))*(t>>o);const a=-o;return e-(n-(i<<a))*(t>>a)<<a}let rFt=class{constructor(e,r,i){this._rows=Math.ceil(r/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(e,r){const i=Math.min(Math.max(Math.floor(r/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][s]||null}getCellSpan(e,r,i,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function lgt(t,e,r,i,s,n){const o=e[i++];for(let a=0;a<o;a++){const l=new agt(n);l.xTile=e[i++],l.yTile=e[i++],l.hash=e[i++],l.priority=e[i++];const c=e[i++];for(let f=0;f<c;f++){const m=e[i++],y=e[i++],_=e[i++],b=e[i++],x=!!e[i++],T=e[i++],S=r[i++],E=r[i++],O=e[i++],R=e[i++];l.colliders.push({xTile:m,yTile:y,dxPixels:_,dyPixels:b,hard:x,partIndex:T,width:O,height:R,minLod:S,maxLod:E})}const h=t[i++];for(let f=0;f<h;f++)l.textVertexRanges.push([t[i++],t[i++]]);const p=t[i++];for(let f=0;f<p;f++)l.iconVertexRanges.push([t[i++],t[i++]]);s.push(l)}return i}function sFt(t,e,r){for(const[i,s]of t.symbols)cgt(t,e,r,s,i)}function cgt(t,e,r,i,s){const n=t.layerData.get(s);if(n.type===xc.SYMBOL){for(const o of i){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=r?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=r?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=e,n.opacityChanged=!0}}let Y6=class{constructor(e,r){this.layerUIDs=[],this.isDestroyed=!1,this._data=e,this.memoryUsed=e.byteLength;let i=1;const s=new Uint32Array(e);this.layerUIDs=[];const n=s[i++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[i++];this.bufferDataOffset=i,r&&(this.layer=r.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return C(this._data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(e){C(this._data)||(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},ugt=class extends Y6{constructor(e,r){super(e,r),this.type=xc.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.lineIndexStart=i[s++],this.lineIndexCount=i[s++];const n=i[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=i[s++],c=i[s++],h=i[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){v(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),v(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),v(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.lineVertexBuffer=jr.createVertex(e,$r.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.lineIndexBuffer=jr.createIndex(e,$r.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new ed(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}},hgt=class extends Y6{constructor(e,r){super(e,r),this.type=xc.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.fillIndexStart=i[s++],this.fillIndexCount=i[s++],this.outlineIndexStart=i[s++],this.outlineIndexCount=i[s++];const n=i[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=i[s++],c=i[s++],h=i[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){v(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),v(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),v(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,v(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),v(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),v(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.fillVertexBuffer=jr.createVertex(e,$r.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.fillIndexBuffer=jr.createIndex(e,$r.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=s[i++];this.outlineVertexBuffer=jr.createVertex(e,$r.STATIC_DRAW,new Int32Array(n.buffer,4*i,l)),i+=l;const c=s[i++];this.outlineIndexBuffer=jr.createIndex(e,$r.STATIC_DRAW,new Uint32Array(s.buffer,4*i,c)),i+=c;const h=this.layer,p=h.fillMaterial,f=h.outlineMaterial;this.fillVertexArrayObject=new ed(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new ed(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}},dgt=class extends Y6{constructor(e,r,i){super(e,r),this.type=xc.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(e),n=new Int32Array(e),o=new Float32Array(e);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const m=s[a++],y=s[a++],_=s[a++];this.iconPerPageElementsMap.set(m,[y,_])}const c=s[a++];for(let f=0;f<c;f++){const m=s[a++],y=s[a++],_=s[a++];this.glyphPerPageElementsMap.set(m,[y,_])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=lgt(s,n,o,a,this.symbols,i),this.bufferDataOffset=a}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[r,i]of this.iconPerPageElementsMap)e+=i[1];for(const[r,i]of this.glyphPerPageElementsMap)e+=i[1];return e/3}doDestroy(){v(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),v(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),v(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),v(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,v(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),v(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),v(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),v(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,r=this.iconOpacityBuffer;e.length>0&&e.byteLength===r.size&&r.setSubData(e,0,0,e.length);const i=this.textOpacity,s=this.textOpacityBuffer;i.length>0&&i.byteLength===s.size&&s.setSubData(i,0,0,i.length)}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.iconVertexBuffer=jr.createVertex(e,$r.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.iconIndexBuffer=jr.createIndex(e,$r.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=s[i++];this.textVertexBuffer=jr.createVertex(e,$r.STATIC_DRAW,new Int32Array(n.buffer,4*i,l)),i+=l;const c=s[i++];this.textIndexBuffer=jr.createIndex(e,$r.STATIC_DRAW,new Uint32Array(s.buffer,4*i,c)),i+=c,this.iconOpacityBuffer=jr.createVertex(e,$r.STATIC_DRAW,this.iconOpacity.buffer),this.textOpacityBuffer=jr.createVertex(e,$r.STATIC_DRAW,this.textOpacity.buffer);const h=this.layer,p=h.iconMaterial,f=h.textMaterial;this.iconVertexArrayObject=new ed(e,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new ed(e,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}},pgt=class extends Y6{constructor(e,r){super(e,r),this.type=xc.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.circleIndexStart=i[s++],this.circleIndexCount=i[s++],this.bufferDataOffset=s}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){v(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),v(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),v(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++];this.circleVertexBuffer=jr.createVertex(e,$r.STATIC_DRAW,new Int32Array(n.buffer,4*i,o)),i+=o;const a=s[i++];this.circleIndexBuffer=jr.createIndex(e,$r.STATIC_DRAW,new Uint32Array(s.buffer,4*i,a)),i+=a;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new ed(e,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}};const uFt=!0,hFt=32,oce=200,fgt=1/de("mapview-transitions-duration");let mgt=class extends Fs{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){var i;if(this._stage===e)return;const r=this._stage;this._stage=e,e?(i=this._stage)!=null&&i.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):r==null||r.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return C(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=K_(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=K_(),this.requestRender()),this._fadeOutResolver.promise}endTransitions(){var e,r;(e=this._fadeInResolver)==null||e.call(this),this._fadeInResolver=null,(r=this._fadeOutResolver)==null||r.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;(e=this.parent)==null||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(e,r){if(this.fadeTransitionEnabled){const i=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===i)this.computedVisible=this.visible;else{const n=e*fgt;this.computedOpacity=s>i?Math.max(i,s-n):Math.min(i,s+n),this.computedVisible=this.computedOpacity>0;const o=i===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},vq=class gb{static getId(e,r,i,s){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${r}/${i}/${s}`}constructor(e,r,i,s){this.set(e,r,i,s)}get key(){return this}get id(){return this.toString()}set id(e){this.set(e)}get hash(){const e=4095&this.row,r=4095&this.col,i=63&this.level;return(3&this.world)<<30|r<<22|e<<8|i}acquire(e,r,i,s){this.set(e,r,i,s)}contains(e){const r=e.level-this.level;return r>=0&&this.row===e.row>>r&&this.col===e.col>>r&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new gb(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,r,i,s){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[n,o,a,l]=e.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+e,this.row=+r,this.col=+i,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new gb(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const e=this.level+1,r=this.row<<1,i=this.col<<1,s=this.world;return[new gb(e,r,i,s),new gb(e,r,i+1,s),new gb(e,r+1,i,s),new gb(e,r+1,i+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};vq.pool=new Po(vq,null,null,25,50);let ggt=class extends mgt{constructor(e,r,i,s,n,o,a=n,l=o){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new vq(e),this.resolution=r,this.x=i,this.y=s,this.width=n,this.height=o,this.rangeX=a,this.rangeY=l}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(e){const r=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.width/this.rangeX*r,a=this.height/this.rangeY*r;YX(i,o,0,0,0,a,0,s,n,1),lE(this.transforms.dvs,e.displayViewMat3,i)}},FV=class MCe extends ggt{constructor(e,r,i,s,n,o,a,l=null){super(e,r,i,s,n,o,4096,4096),this._memCache=l,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=a,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<oce}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<oce)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(e){let r=!1;for(const i of e)if(this.layerData.has(i)){const s=this.layerData.get(i);this._memoryUsedByLayerData-=s.memoryUsed,s.type===xc.SYMBOL&&this.symbols.has(i)&&(this.symbols.delete(i),r=!0),s.destroy(),this.layerData.delete(i),this.layerCount--}v(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),r&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(PCe.delete(this),MCe._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(e){let r=!1;if(e){const{bucketsWithData:i,emptyBuckets:s}=e,n=this._createRenderBuckets(i);if(s&&s.byteLength>0){const o=new Uint32Array(s);for(const a of o)this._deleteLayerData(a)}for(const[o,a]of n)this._deleteLayerData(o),a.type===xc.SYMBOL&&(this.symbols.set(o,a.symbols),r=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(o,a),this.layerCount++;v(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[i,s]of this.layerData)s.type===xc.SYMBOL&&(this._hasSymbolBuckets=!0);r&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(r){r.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const r=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*r,s=this.height/this.rangeY*r,n=[0,0];e.toScreen(n,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;ZX(o),cF(o,o,n),JX(o,o,Math.PI*e.rotation/180),KX(o,o,[i,s,1])}_createTransforms(){return{dvs:Hl(),tileMat3:Hl(),tileUnitsToPixels:Hl()}}static _destroyRenderBuckets(e){if(!e)return;const r=new Set;e.forEach(i=>{r.has(i)||(i.destroy(),r.add(i))}),e.clear()}_createRenderBuckets(e){const r=new Map,i=new Map;for(const s of e){const n=this._deserializeBucket(s,i);for(const o of n.layerUIDs)r.set(o,n)}return r}_deserializeBucket(e,r){let i=r.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case xc.FILL:i=new hgt(e,this.styleRepository);break;case xc.LINE:i=new ugt(e,this.styleRepository);break;case xc.SYMBOL:i=new dgt(e,this.styleRepository,this);break;case xc.CIRCLE:i=new pgt(e,this.styleRepository)}return r.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;const r=this.layerData.get(e);this._memoryUsedByLayerData-=r.memoryUsed,r.destroy(),this.layerData.delete(e),this.layerCount--}};const PCe=new Map;function ygt(){PCe.forEach((t,e)=>{console.log(`
${e.key}:`),t[0].forEach(r=>console.log(r)),console.log("========"),t[1].forEach(r=>console.log(r))})}const fFt={value:.5,readOnly:!0},_gt={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let rS=class{constructor(e=0,r=0){this.min=e,this.max=r,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},vgt=class{constructor(e,r){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(r[2]-r[0]),this.dy=(e.width-1)/(r[3]-r[1]),this.x0=r[0],this.y1=r[3]}},bgt=class{constructor(e,r,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=r,this.samplerData=new vgt(i,r)}computeMinMaxValue(e,r,i,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(r/o)===this.i&&Math.floor(i/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.data.width,h=this.samplerData.data.values,p=.5*I3;let f=(c-1)/o,m=(i-this.j*o)*f,y=(r-this.i*o)*f;if(f<1){const _=Math.floor(m),b=Math.floor(y),x=_+b*c,T=h[x],S=h[x+1],E=h[x+c],O=h[x+c+1];if(T+S+E+O<p){const R=m-_,L=y-b,I=NP(T,S,E,O,R,L),U=NP(T,S,E,O,R+f,L),z=NP(T,S,E,O,R,L+f),B=NP(T,S,E,O,R+f,L+f);return s.min=Math.min(I,U,z,B),s.max=Math.max(I,U,z,B),s}m=_,y=b,f=1}else m=Math.floor(m),y=Math.floor(y),f=Math.ceil(f);for(let _=m;_<=m+f;_++)for(let b=y;b<=y+f;b++){const x=h[_+b*c];x<p?(a=Math.min(a,x),l=Math.max(l,x)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}};const wgt=.5*I3;function Hi(t,e,r){if(C(r))return null;for(const i of r){if(!i)continue;const s=i.safeWidth;let n=ye(i.dy*(i.y1-e),0,s),o=ye(i.dx*(t-i.x0),0,s);const a=Math.floor(n),l=Math.floor(o),c=i.data.width,h=a*c+l,p=i.data.values,f=p[h],m=p[h+1],y=h+c,_=p[y],b=p[y+1];if(f+_+m+b<wgt){n-=a,o-=l;const x=f+(m-f)*o;return x+(_+(b-_)*o-x)*n}}return null}let yh=class extends Te{constructor(e){super(e),this._handles=new Zr}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles=Ve(this._handles)}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(r=>{const i=r.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const s=ICe(i.fullExtent,this.viewSpatialReference);v(s)&&e.push(Ffe(s))}}),e}};function xgt(t,e){return t===Be.Global?new bq(e):new wq(e)}u([d({readOnly:!0})],yh.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],yh.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],yh.prototype,"stencilEnabledExtents",null),u([d()],yh.prototype,"viewSpatialReference",void 0),u([d()],yh.prototype,"tilingScheme",void 0),u([d()],yh.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],yh.prototype,"layers",void 0),u([d({constructOnly:!0})],yh.prototype,"layerViews",void 0),yh=u([P("esri.views.3d.terrain.ExtentHelper")],yh);let bq=class extends yh{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?qbe:EZe}};bq=u([P("esri.views.3d.terrain.ExtentHelperGlobal")],bq);let wq=class extends yh{_computeLayerViewsExtent(){const e=Xh(),r=this.viewSpatialReference;this.layerViews.forEach(n=>{const o=n.layer;if(n.isResolved()&&(o.type!=="graphics"||!o.internal)){const a=ICe("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,r);z_(e,a,e)}});const i=Sz(e)?e:null,s=this._get("layerViewsExtent");return iw(i,s)?s:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const r=this.viewSpatialReference,i=Xh();this.layers.forEach(o=>{if(o.loaded&&cO(o)){const a=X6(o,r,Be.Local);if(C(a))return;const{tileInfo:l,fullExtent:c}=a;v(l)&&v(c)&&(C4(o)||e.compatibleWith(l)&&c.spatialReference.equals(e.spatialReference))&&z_(i,c,i)}}),z_(i,this.defaultTiledLayersExtent,i);const s=Sz(i)?i:null,n=this._get("tiledLayersExtent");return iw(s,n)?n:s}};function ICe(t,e){return v(t)&&!t.spatialReference.equals(e)?Bfe(t,t.spatialReference,e):t}wq=u([P("esri.views.3d.terrain.ExtentHelperLocal")],wq);var pr;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.MAP=1]="MAP"})(pr||(pr={}));const yb=[pr.ELEVATION,pr.MAP];function $Ce(){var e;const t=(e=globalThis.require)==null?void 0:e.modules;if(t){const r=Object.keys(t);for(const i of r)i.search(".glsl")!==-1&&delete t[i]}}const Tgt=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let f0,Ml=class extends Te{get running(){return this._placementDirty&&(this._drapeSources.size>0||this._view.graphics.length>0||Wr.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this._view.state.isGlobal}get _worldToPCSRatio(){return v(this._spatialReference)&&this._spatialReference.isGeographic&&!this._view.state.isLocal?Yr(this._spatialReference).metersPerDegree:1}get _view(){return this.surface.view}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}constructor(e){super(e),this._handles=new Zr,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=de("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){var r;const e=this._view;this.renderer=new Fd({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=Qh(this._view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this.setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",i=>{var s;return(s=e._stage)==null?void 0:s.renderer.setParameters({hasOverlayWater:i})}),this.renderer.events.on("renders-occluded",()=>{this.setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this.setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateOverlayResult()),ne(()=>{var i,s,n;return[(i=e.pointsOfInterest)==null?void 0:i.renderPointOfView,(n=(s=e.pointsOfInterest)==null?void 0:s.centerOnSurfaceFrequent)==null?void 0:n.location]},()=>this.setPlacementDirty()),ne(()=>{var i,s;return[(i=e.state)==null?void 0:i.pixelRatio,(s=e.state)==null?void 0:s.contentPixelRatio]},()=>this.setPlacementDirty(),ri),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(yt.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",i=>{this._updateOverlays(Ja,i,Ps.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,Ps.BACKGROUND,i.pixelRatio)})]),(r=e._stage)==null||r.renderer.setParameters({renderOverlay:i=>{this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(i),this._drawOverlayTextures(this.renderer.overlays,Ps.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}})}destroy(){this._handles=Ve(this._handles),v(f0)&&(f0.hide(),f0=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const r=this._view.renderSpatialReference;v(e)&&v(r)?(this._renderSR=r,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new ev(-20037508342787e-6,20037508342787e-6):new ev(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,r,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this.renderer.createDrapeSourceRenderer(e,r,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),s}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,uu)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&v(e.setDrapingExtent)&&v(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){var e;(e=this._view._stage)==null||e.renderer.setParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this._view.state.contentCamera,Ps.UPDATE)}_updateOverlays(e,r,i){if(!this._spatialReference)return ea.YIELD;const s=this._computeOverlayResolution(r);this._computeOverlayExtents(r,s,Jm);const n=Cu(Jm.inner)/Cu(Jm.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const o=this._updateOverlay(es.INNER,Jm.inner,s,1*Jm.pixelRatioAdjustment,Jm.mapUnitsPerPixel),a=this._updateOverlay(es.OUTER,Jm.outer,s,n*Jm.pixelRatioAdjustment,Jm.mapUnitsPerPixel);o!==If.EXTENT&&a!==If.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(i)),o===If.NONE&&a===If.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const r=this._view.state.contentPixelRatio,i=e.fullWidth/e.pixelRatio*r,s=e.fullHeight/e.pixelRatio*r;return Math.min(qS(Math.max(i,s)+256),this._maxResolution)}_updateOverlay(e,r,i,s,n){if(this.renderer.overlays.length===0)return If.NONE;const o=this.renderer.overlays[e],a=o.mapUnitsPerPixel;if(o.mapUnitsPerPixel=n,o.pixelRatio=s,Sgt(r,o.extent)&&i===o.resolution)return a===n?If.NONE:If.RERENDER_ONLY;oy(o.extent,r),o.resolution=i;const l=gX(o.extent);return o.renderLocalOrigin=jO(l[0],l[1],0,"OV_"+this._latestOriginId++),If.EXTENT}setTileParameters(e){const r=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[es.INNER],s=this.renderer.overlays[es.OUTER],n=e.extent;this._rectInsideRect(i.extent,n)||this._rectanglesOverlap(n,i.extent)||this._rectanglesOverlap(n,s.extent)?(this._setTileOverlayData(n,es.INNER,r),this._setTileOverlayData(n,es.OUTER,r)):(this._clearTileOverlayData(es.INNER,r),this._clearTileOverlayData(es.OUTER,r))}else this._clearTileOverlayData(es.INNER,r),this._clearTileOverlayData(es.OUTER,r)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const r=this.renderer.overlays[es.INNER],i=this.renderer.overlays[es.OUTER],s=this._pointIsInExtent(e,r.extent)?r:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,r,i){if(this.renderer.overlays.length===0)return;const s=this.renderer.overlays[r].extent,n=Cu(s),o=wp(s);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(s[0],a);const l=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);a>l&&(a=l-(e[2]-e[0]))}i.setScale(r,Cu(e)/n,wp(e)/o),i.setOffset(r,(a-s[0])/n,(e[1]-s[1])/o)}_clearTileOverlayData(e,r){r.setScale(e,-1,-1),r.setOffset(e,-1,-1)}async reloadShaders(){$Ce(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Ja)}_dispatchAnimationUpdate(e){const r=e-this._animationTimeLast;if(r>=this.surface.view._stage.renderer.animationTimestep||v(this._view.state.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=r/this.surface.view._stage.renderer.animationTimeDilation,s=new UTe(this._view.state.camera,i,this._view.state.forcedAnimationTime);this.renderer.updateAnimation(s)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this._view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,r,i,s){const n=this._view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Agt,r,i);if(C(n))return!1;const o=n.origin,a=me(H$,n.origin,n.direction);return this._groundIntersector.reset(o,a,e),this._groundIntersector.intersect([]),this._view.basemapTerrain.intersect(this._groundIntersector,null,o,a),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,r){let i=.5;const s=.55,n=this._view.renderCoordsHelper.getAltitude(e.eye),o=this._view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,l=ye(o.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+a,e.aboveGround?n-a:1/0),c=e.aboveGround;if(this._view.viewingMode==="global"){const h=H$;JE(E5(C5,Yr(this._view.spatialReference).radius+l),Vu(e.eye,e.viewForward),h),ge(h,h,e.eye);const p=tv.normalize(uye(e.viewForward,h,e.viewRight))/e.fovY+.5,f=p<=0||p>=1?.5:s;i=c?f*p:p+f*(1-p)}else{const h=.5*Math.PI-Math.acos(-e.viewForward[2]),p=Math.tan(h),f=qt(0,p,1,0),m=Ru(f,f,e.projectionMatrix)[1],y=ye(.5+.5*m,0,1);i=y===1||y===0?.5:c?y*s:1-(1-y)*s}return!!this._intersectGroundFromView(e,.5,i,r)&&YW(r,e.eye)<o.distance*o.distance}_computeOverlayExtents(e,r,i){const s=this._view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=M();this._findHorizonBasedPointOfInterest(e,n)||le(n,s);const o=Math.max(.1,Si(e.eye,n)),a=fv(this._view.renderCoordsHelper,s,e.eye),l=Math.PI/2-Math.abs(a-Math.PI/2);Wr.OVERLAY_SHOW_CENTER?(C(f0)&&(f0=new E2(this._view.graphics,"red")),f0.show(n,this._renderSR)):v(f0)&&f0.hide(),this._overlaySREqualsRenderSR||uo(n,this._renderSR,n,this._spatialReference);const c=this.surface.extent,h=!this._isSpherical&&v(this._spatialReference)&&this._spatialReference.isGeographic,p=h&&v(this._spatialReference)?1/Yr(this._spatialReference).metersPerDegree:1,f=this._view.state.contentPixelRatio,m=e.perScreenPixelRatio/f*o*p;i.mapUnitsPerPixel=m/this._worldToPCSRatio;let y=r*m/2,_=!1,b=h?90:1/0;this._isSpherical&&v(c)&&v(this._spatialReference)&&(this._spatialReference.isWebMercator?(y/=Math.cos(HN(n[1])),b=c[3]):(_=!0,y/=Yr(this._spatialReference).metersPerDegree,b=90),y>=b&&(y=b,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let x=1;_&&(x=1/Math.max(.2,Math.cos(Math.abs(jt(n[1])))),y*x>180&&(x=180/y),i.mapUnitsPerPixel*=x);const T=Math.log(2)/12;y=Math.exp(Math.round(Math.log(y)/T)*T);const S=y*x,E=32,O=.5*r/(E*S),R=.5*r/(E*y);n[0]=Math.round(n[0]*O)/O,n[1]=Math.round(n[1]*R)/R;const L=i.inner;L[0]=n[0]-S,L[1]=n[1]-y,L[2]=n[0]+S,L[3]=n[1]+y,this._isSpherical&&this._shiftExtentToFitBounds(L,1/0,b);const I=i.outer;if(6*S>Cu(c))oy(I,c);else if(l<=.25*Math.PI)I[0]=L[0]-S,I[1]=L[1]-y,I[2]=L[2]+S,I[3]=L[3]+y;else{uo(e.eye,this._renderSR,H$,this._spatialReference),Vf(y1,n,H$);let z=-Math.atan2(y1[1],y1[0])+.125*Math.PI;z<0&&(z+=2*Math.PI);const B=Math.floor(z/(.25*Math.PI));kE(y1,Tgt[B],2*y),y1[0]*=x,y1[2]*=x,ZW(I,L,y1)}if(this._isSpherical)I[0]=this._longitudeCyclical.clamp(I[0]),I[2]=this._longitudeCyclical.clamp(I[2]),I[1]=Math.max(I[1],-b),I[3]=Math.min(I[3],b);else{const z=Ez(L,c,Egt),B=Ez(I,c,Cgt);wee(z,B)&&(I[2]=I[0],I[3]=I[1])}const U=Math.abs(L[2]-L[0])/r;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,U),i.pixelRatioAdjustment=i.mapUnitsPerPixel/U}_drawOverlayTextures(e,r,i=this._view.state.contentPixelRatio){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const s=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const n=this._drawOverlay(e[es.INNER],i),o=this._drawOverlay(e[es.OUTER],i);n!==EE.CHANGED&&o!==EE.CHANGED||this.surface.updateTileOverlayParams(Ps.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),s?(this.surface.requestRender(r),r===Ps.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Ps.BACKGROUND)}_drawOverlay(e,r){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,r)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,r){return!C(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(r[0],r[2],e[0])||this._longitudeCyclical.contains(r[0],r[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],r[0]))&&!(e[1]>r[3]||e[3]<r[1]):l5(e,r))}_rectInsideRect(e,r){return!C(r)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],r[0])&&this._longitudeCyclical.contains(e[0],e[2],r[2])&&r[1]>e[1]&&r[3]<e[3]:wee(e,r))}_pointIsInExtent(e,r){if(this._longitudeCyclical)return this._longitudeCyclical.contains(r[0],r[2],e.x)&&e.y>=r[1]&&e.y<=r[3];const i=e.x,s=e.y;return i>r[0]&&i<r[2]&&s>r[1]&&s<r[3]}_shiftExtentToFitBounds(e,r,i){let s=0,n=0;e[0]<-r?s=e[0]+r:e[2]>r&&(s=r-e[2]),e[1]<-i?n=e[1]+i:e[3]>i&&(n=i-e[3]),rF(e,s,n)}get test(){return{renderer:this.renderer,update:()=>this.runTask(Ja)}}};function Sgt(t,e){const i=Wr.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(t[2]-t[0],t[3]-t[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-t[0])<=i&&Math.abs(e[1]-t[1])<=i&&Math.abs(e[2]-t[2])<=i&&Math.abs(e[3]-t[3])<=i}u([d()],Ml.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],Ml.prototype,"running",null),u([d()],Ml.prototype,"_placementDirty",void 0),u([d()],Ml.prototype,"_contentUpdated",void 0),u([d()],Ml.prototype,"_isSpherical",null),u([d()],Ml.prototype,"_worldToPCSRatio",null),u([d({autoDestroy:!0})],Ml.prototype,"renderer",void 0),u([d({constructOnly:!0})],Ml.prototype,"surface",void 0),u([d()],Ml.prototype,"suspended",null),u([d()],Ml.prototype,"updating",null),u([d({type:Boolean})],Ml.prototype,"hasHighlights",null),u([d({type:Boolean})],Ml.prototype,"rendersOccluded",null),Ml=u([P("esri.views.3d.terrain.OverlayManager")],Ml);const y1=nr(),H$=M(),Jm={inner:hr(),outer:hr(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},Egt=hr(),Cgt=hr(),Agt=no();var If;(function(t){t[t.NONE=0]="NONE",t[t.EXTENT=1]="EXTENT",t[t.RERENDER_ONLY=2]="RERENDER_ONLY"})(If||(If={}));let LCe=class xq{constructor(e,r){this._factoryCallback=e,this._lengthCallback=r,this._pool=new Map}acquire(e){if(!xq.test.disabled){const r=this._pool.get(e);if(r&&r.length!==0)return r.pop()}try{return this._factoryCallback(e)}catch(r){const i=window.performance&&window.performance.memory;let s="";throw i&&(s=`
  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+r+s),r}}release(e){if(xq.test.disabled)return;const r=this._lengthCallback(e);let i=this._pool.get(r);i||(i=new Kt({shrink:!0}),this._pool.set(r,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}};LCe.test={disabled:!1};let Rgt=class{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Mi(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}},ace=class{constructor(e,r,i,s,n){this.attributes=e,this.localOrigin=r,this.index0=i,this.stride=s,this.count=n}getVertexIndex(e){return this.getAttributeIndex(e)}getAttributeIndex(e){return Re(0<=e&&e<this.count),this.index0+this.stride*e}_getVertexRaw(e,r){this.attributes.position.getVec(e,r)}_getNormalRaw(e,r){this.attributes.normalCompressed.getVec(e,r)}getVertexPos(e,r){this._getVertexRaw(this.getAttributeIndex(r),e),me(e,e,this.localOrigin)}getNormal(e,r){const i=Ke();this._getNormalRaw(this.getAttributeIndex(r),i),Igt(e,i)}_setNormal(e,r,i,s){nM(this.attributes.normalCompressed,e,r,i,s)}_setUV(e,r,i){Fc(this.attributes.uv0,e,r,i)}setNormalFromValues(e,r,i,s){this._setNormal(this.getAttributeIndex(e),r,i,s)}setVertexFromValuesRawPositionUV(e,r,i,s,n,o){const a=this.getAttributeIndex(e);this.attributes.position.setValues(a,r,i,s),this._setUV(a,n,o)}setVertexFromValuesRawPositionUVNormal(e,r,i,s,n,o,a,l,c){const h=this.getAttributeIndex(e);this.attributes.position.setValues(h,r,i,s),this._setUV(h,n,o),this._setNormal(h,a,l,c)}};const Ogt=is().vec3f(A.POSITION).vec2i16(A.UV0).vec2i16(A.NORMALCOMPRESSED,{glNormalized:!0}),CK=new LCe(t=>Ogt.createBuffer(t),t=>t.count);function Mgt(){CK.clear()}function DCe(t){return CK.acquire(t)}function Pgt(t){CK.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null}function nM(t,e,r,i,s){const n=1/(Math.abs(r)+Math.abs(i)+Math.abs(s)),o=r*n,a=i*n,l=s<=0?(o>=0?1:-1)*(1-Math.abs(a)):o,c=s<=0?(a>=0?1:-1)*(1-Math.abs(o)):a;t.setValues(e,cce(l),cce(c))}function Igt(t,e){const r=uce(e[0]),i=uce(e[1]),s=1-Math.abs(r)-Math.abs(i);t[2]=s,s<0?(t[0]=(r>=0?1:-1)*(1-Math.abs(i)),t[1]=(i>=0?1:-1)*(1-Math.abs(r))):(t[0]=r,t[1]=i),ve(t,t)}const lce=16384;function Fc(t,e,r,i){t.setValues(e,r*lce,i*lce)}function cce(t){return ye(Math.round(32767*t),-32767,32767)}function uce(t){return ye(t/32767,-1,1)}function il(t,e,r,i){t<i[0]?i[0]=t:t>i[3]&&(i[3]=t),e<i[1]?i[1]=e:e>i[4]&&(i[4]=e),r<i[2]?i[2]=r:r>i[5]&&(i[5]=r)}let $gt=class{constructor(){this.sinLonLUT=new Array(MR+1),this.cosLonLUT=new Array(MR+1),this.sinLatLUT=new Array(MR+1),this.cosLatLUT=new Array(MR+1)}update(e,r,i){const s=r[0],n=r[2];for(let o=0;o<=e;o++){const a=o/e,l=s*(1-a)+n*a;this.sinLonLUT[o]=Math.sin(l),this.cosLonLUT[o]=Math.cos(l);const c=i(a);this.sinLatLUT[o]=Math.sin(c),this.cosLatLUT[o]=Math.cos(c)}}},q$=class{constructor(){this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]}},Lgt=class{constructor(){this.cornerNeighborData=[new q$,new q$,new q$,new q$],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]}},Dgt=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.shading=!1,this.samplerDataVersion=0,this.neighborData=new Lgt}},NCe=class aN{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Ve(this._current),this._next=Ve(this._next),this._waiting=Ve(this._waiting),this._delayed=Ve(this._delayed)}get current(){if(C(this._current))return null;if(!this._isFadingEnabled){const r=this._delayed||this._waiting||this._next||this._current;r!==this._current&&(this._current=null,this.clear(),this._current=r)}let e=aN.test.fadeMoment;if(v(this._delayed)&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,Qg.Immediate),this._delayed=null)),v(this._next)){e=e||performance.now();const r=this._fadeDuration,i=v(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==bn.FADING,n=e-this._fadeStart>=r;(i||s||n)&&(Ve(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(C(this._next))return 1;const e=aN.test.fadeMoment||performance.now(),r=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return r>i?0:1-r/i}get isFading(){return v(this._next)||v(this._delayed)}push(e,r=Qg.Immediate){this._delayed=Ve(this._delayed),this._push(e,r)}_push(e,r){if(this._isFadingEnabled||this.clear(),C(this._current))return void(this._current=e);const i=aN.test.fadeMoment||performance.now();return r!==Qg.Immediate?(this._delayed=e,void(this._delayedTime=i+r)):C(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(C(e)||(Ve(this._waiting),this._waiting=e))}get _fadeDuration(){return C(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const r=this._getFadeDuration();return e+r-e%r}get _isFadingEnabled(){return this._getFadeDuration()>0}};var Qg;NCe.test={fadeMoment:0},function(t){t[t.Immediate=0]="Immediate",t[t.Delayed=5e3]="Delayed"}(Qg||(Qg={}));var DE;(function(t){t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT",t[t.NONE=0]="NONE",t[t.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(DE||(DE={}));let FCe=class{constructor(){this._queue=new Kt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),v(e)&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var r;const e=(r=this._last)==null?void 0:r.children;return e&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},Ngt=class{constructor(){this._q=new Kt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),!C(e)){this._q.pushArray(e);for(let r=0;r<this._q.length;++r){const i=this._q.data[r];i.isLeaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function JO(t,e,r){if(C(e)||C(e.fullExtent))return!1;const i=e.fullExtent,s=t.extent;if(r){if(s[0]<i.xmin||s[1]<i.ymin||s[2]>i.xmax||s[3]>i.ymax)return!1}else if(i.xmin>s[2]||i.ymin>s[3]||i.xmax<s[0]||i.ymax<s[1])return!1;const n=t.surface.tilingScheme.levels[t.level].scale,o=e.minScale;if(o>0&&n>1.00000001*o)return!1;const a=e.maxScale;return!(a>0&&n<.99999999*a)}function ey(t,e){const r=t.lij,i=e.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function UCe(t,e,r=null){C(r)||r.length===0?t===DE.BACK_TO_FRONT?e.sort(Fgt):e.sort(Ugt):e.sort((i,s)=>Vgt(i,s,t,r))}function Fgt(t,e){const r=e.screenDepth-t.screenDepth;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function Ugt(t,e){const r=t.screenDepth-e.screenDepth;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function VCe(t,e,r){const i=t.screenDepth,s=e.screenDepth;return i<s?-r:i>s?r:ey(t,e)}function Vgt(t,e,r,i){return hce(t,i)===hce(e,i)?VCe(t,e,r):t?r:-r}function hce(t,e){for(const r of e)if(t.intersectsExtent(r))return!0;return!1}function kgt(t,e){const r=t.distanceToPOI-e.distanceToPOI;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function zgt(t,e){const r=t.length;for(let i=0;i<r;++i)t.getItemAt(i).updateDistanceToPOI(e);t.sort(kgt)}function Bgt(t,e,r){let i=1,s=0,n=0;for(;t!==e;)if(i*=.5,s*=.5,n*=.5,1&t.lij[2]&&(s+=.5),!(1&t.lij[1])&&(n+=.5),(t=t.parent)==null)throw new Error("tile was not a descendant of upsampleTile");r.init(e,s,n,i)}function Ggt(t){for(let e=0;e<t.length;e++){const r=t[e],i=r.parent;if(i)for(let s=0;s<4;s++){const n=i.children[s];if(n&&n!==r)return!0}}return!1}function MFt(t,e){if(!t||!e||t[0]===e[0])return!1;const r=t[0]<e[0],i=r?t:e,s=r?e:t,n=1<<s[0]-i[0];return Math.floor(s[1]/n)===i[1]&&Math.floor(s[2]/n)===i[2]}let AK=class{get updating(){return!!this._tileRequested}init(e,r,i,s){this.tile=e,this._layerIdx=r,this._layerClass=i,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(r,i),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,bn.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return v(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,r=this._layerClass,i=this.tile.surface.layerViewByIndex(e,r),s=mq(i),{minLevel:n,maxLevel:o}=i.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?JO:()=>!0;let h=this.tile;const p=h.level;let f;const m=this._tileLayerInfo.upsampleInfo,y=v(m)?m.tile.level:-1,_=!!v(m)&&y-p>=a,b=Js(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=n;){const x=h.level,T=p-x,S=h.layerInfo[r][e];if(S.data&&T>=a){(!_||x>y)&&this._setUpsampleTile(h),S.dataInvalidated&&(f=h);break}if((C(b)||b.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&x<=o&&!S.data&&!S.dataMissing&&((C(f)||h.level===n||x%Hbe==0||p-f.level<a)&&(f=h),T>=l))break;h=h.parent}return v(f)&&p-f.level<a&&this._tileLayerInfo.upsampleInfo&&(f=null),f}_findAncestorWithData(){const e=this.tile.vlevel,r=this._desiredMinLevelDelta;let i;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=r)return s;i=s}return i}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,bn.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}},jgt=class extends AK{get _desiredMinLevelDelta(){throw dce}get _progressiveLevelModulo(){throw dce}dispose(){}};const dce=new Error("Abstract method called on TileAgent"),tc=new jgt;let kCe=class extends AK{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return Ej(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}},zCe=class extends AK{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Hbe}};var mw,Zw;(function(t){t[t.Stretch=0]="Stretch",t[t.Lut=1]="Lut",t[t.Hillshade=2]="Hillshade",t[t.COUNT=3]="COUNT"})(mw||(mw={})),function(t){t[t.Noop=0]="Noop",t[t.PerBand=1]="PerBand",t[t.COUNT=2]="COUNT"}(Zw||(Zw={}));function Hgt(t,e){t.fragment.uniforms.add([new Pt("u_colormap",r=>r.u_colormap),new Pe("u_colormapOffset",r=>r.colormap.u_colormapOffset),new Pe("u_colormapMaxIndex",r=>r.colormap.u_colormapMaxIndex),new Pe("u_opacity",r=>r.common.u_opacity)]),t.fragment.code.add(w`
    vec4 colormap(vec4 currentPixel, bool isFloat) {
      float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
      vec4 result;
      // handle no data and out of range pixels
      if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
        result = vec4(0.0, 0.0, 0.0, 0.0);
      } else {
        // colormap lookup
        vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
        result = ${tl(e,"u_colormap","texelCoordinates","(1.0 / vec2(u_colormapMaxIndex + 1.0, 1.0))")};
      }
      return result;
    }
  `)}function qgt(t,e){t.fragment.uniforms.add(fp("u_transformGrid",r=>r.u_transformGrid,e.hasWebGL2Context?ei.None:ei.InvSize)),t.fragment.uniforms.add(new Ur("u_transformSpacing",r=>r.common.u_transformSpacing)),t.fragment.uniforms.add(new Ur("u_targetImageSize",r=>r.common.u_targetImageSize)),t.fragment.code.add(w`
    vec2 projectPixelLocation(vec2 coords) {
      // Pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]
      vec2 index_image = floor(coords * u_targetImageSize);

      // Pixel's corresponding cell index in transform grid
      // Each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle
      vec2 oneTransformPixel = vec2(4.0, 1.0);
      vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;

      // Correspoding position in transform grid cell, cell center coordinates
      vec2 pos = fract((index_image + 0.5) / u_transformSpacing);

      // Pixel's corresponding transform cell location, cell center coordinates
      vec2 transform_location = index_transform + 0.5;

      vec2 srcLocation;

      // Use lower triangle or upper triangle
      if (pos.s <= pos.t) {
        vec3 ll_abc = ${tl(e,"u_transformGrid","transform_location")}.rgb;
        vec3 ll_def = ${tl(e,"u_transformGrid","vec2(transform_location.s + 1.0, transform_location.t)")}.rgb;
        srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
        srcLocation.t = dot(ll_def, vec3(pos, 1.0));
      } else {
        vec3 ur_abc = ${tl(e,"u_transformGrid","vec2(transform_location.s + 2.0, transform_location.t)")}.rgb;
        vec3 ur_def = ${tl(e,"u_transformGrid","vec2(transform_location.s + 3.0, transform_location.t)")}.rgb;
        srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
        srcLocation.t = dot(ur_def, vec3(pos, 1.0));
      }

      return srcLocation;
    }
  `)}let BCe=class extends pi{constructor(){super(...arguments),this.scale=1,this.offset=Xl}};function GCe(t){t.attributes.add(A.POSITION,"vec2"),t.attributes.add(A.UV0,"vec2"),t.vertex.uniforms.add(new Pe("scale",e=>e.scale)),t.vertex.uniforms.add(new Ur("offset",e=>e.offset)),t.varyings.add("uv","vec2"),t.varyings.add("vuv","vec2"),t.vertex.code.add(w`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}let Wgt=class extends BCe{constructor(e,r,i){super(),this.common=e,this.u_image=r,this.u_transformGrid=i}};function Xgt(t,e){t.include(qgt,e),t.fragment.uniforms.add([new Pt("u_image",r=>r.u_image),new Yg("u_flipY",r=>r.common.u_flipY),new Yg("u_applyTransform",r=>r.common.u_applyTransform)]),t.fragment.code.add(w`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}var Fe;(function(t){t[t.Normal=0]="Normal",t[t.Average=1]="Average",t[t.Lighten=2]="Lighten",t[t.Lighter=3]="Lighter",t[t.Plus=4]="Plus",t[t.Screen=5]="Screen",t[t.ColorDodge=6]="ColorDodge",t[t.Darken=7]="Darken",t[t.Multiply=8]="Multiply",t[t.ColorBurn=9]="ColorBurn",t[t.Overlay=10]="Overlay",t[t.SoftLight=11]="SoftLight",t[t.HardLight=12]="HardLight",t[t.VividLight=13]="VividLight",t[t.Hue=14]="Hue",t[t.Saturation=15]="Saturation",t[t.Luminosity=16]="Luminosity",t[t.Color=17]="Color",t[t.DestinationOver=18]="DestinationOver",t[t.DestinationAtop=19]="DestinationAtop",t[t.DestinationIn=20]="DestinationIn",t[t.DestinationOut=21]="DestinationOut",t[t.SourceAtop=22]="SourceAtop",t[t.SourceIn=23]="SourceIn",t[t.SourceOut=24]="SourceOut",t[t.Xor=25]="Xor",t[t.Difference=26]="Difference",t[t.Exclusion=27]="Exclusion",t[t.Minus=28]="Minus",t[t.Invert=29]="Invert",t[t.Reflect=30]="Reflect",t[t.COUNT=31]="COUNT"})(Fe||(Fe={}));const Tq={normal:Fe.Normal,average:Fe.Average,lighten:Fe.Lighten,lighter:Fe.Lighter,screen:Fe.Screen,plus:Fe.Plus,"color-dodge":Fe.ColorDodge,darken:Fe.Darken,multiply:Fe.Multiply,"color-burn":Fe.ColorBurn,overlay:Fe.Overlay,"soft-light":Fe.SoftLight,"hard-light":Fe.HardLight,"vivid-light":Fe.VividLight,hue:Fe.Hue,saturation:Fe.Saturation,luminosity:Fe.Luminosity,color:Fe.Color,difference:Fe.Difference,exclusion:Fe.Exclusion,minus:Fe.Minus,invert:Fe.Invert,reflect:Fe.Reflect,"destination-over":Fe.DestinationOver,"destination-atop":Fe.DestinationAtop,"destination-in":Fe.DestinationIn,"destination-out":Fe.DestinationOut,"source-atop":Fe.SourceAtop,"source-in":Fe.SourceIn,"source-out":Fe.SourceOut,xor:Fe.Xor};function Ygt(t){return t===Fe.DestinationOver||t===Fe.DestinationAtop||t===Fe.DestinationIn||t===Fe.DestinationOut||t===Fe.SourceAtop||t===Fe.SourceIn||t===Fe.SourceOut||t===Fe.Xor}function RK(t){t.code.add(w`
    float lineFactorAtPosition(float value) {
      float pos = value * ${w.float(257)};
      if(pos < 0.5 || pos > ${w.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function Zgt(t,e){const r=e.blendMode;r!==Fe.Normal&&(r===Fe.Reflect&&t.code.add(w`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),r!==Fe.ColorDodge&&r!==Fe.VividLight||t.code.add(w`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),r!==Fe.ColorBurn&&r!==Fe.VividLight||t.code.add(w`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),r===Fe.Overlay&&t.code.add(w`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),r===Fe.HardLight&&t.code.add(w`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),r===Fe.SoftLight&&t.code.add(w`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),r===Fe.VividLight&&t.code.add(w`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),r!==Fe.Hue&&r!==Fe.Saturation&&r!==Fe.Color&&r!==Fe.Luminosity||(t.code.add(w`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),r!==Fe.Hue&&r!==Fe.Saturation||t.code.add(w`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),t.code.add(w`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${r===Fe.Multiply?w`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Average?w`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Lighten?w`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Darken?w`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Lighter?w`return vec4(cl * ol + cb * ob, ol + ob);`:r===Fe.Plus?w`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:r===Fe.Minus?w`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:r===Fe.Screen?w`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Difference?w`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Invert?w`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:r===Fe.DestinationOver?w`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:r===Fe.DestinationAtop?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:r===Fe.DestinationOut?w`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:r===Fe.SourceAtop?w`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:r===Fe.SourceOut?w`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:r===Fe.Xor?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:r===Fe.DestinationIn?w`return vec4(cb * ob * ol, ol * ob);`:r===Fe.SourceIn?w`return vec4(cl * ol * ob, ol * ob);`:r===Fe.Hue?w`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Saturation?w`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Color?w`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Luminosity?w`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Exclusion?w`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Reflect?w`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.ColorDodge?w`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.ColorBurn?w`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.Overlay?w`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.SoftLight?w`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.HardLight?w`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===Fe.VividLight?w`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:w``}
    }
  `))}var Dn,hp,Yd;(function(t){t[t.Composite=0]="Composite",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.GroupBackgroundComposite=3]="GroupBackgroundComposite",t[t.COUNT=4]="COUNT"})(Dn||(Dn={})),function(t){t[t.NotRequired=0]="NotRequired",t[t.Required=1]="Required",t[t.COUNT=2]="COUNT"}(hp||(hp={})),function(t){t[t.Off=0]="Off",t[t.On=1]="On",t[t.COUNT=2]="COUNT"}(Yd||(Yd={}));function jCe(t,e){const r=e.output===Dn.GridComposite,i=e.output===Dn.ColorComposite,s=e.output===Dn.GroupBackgroundComposite,n=e.output===Dn.Composite;r&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(RK)),i&&t.fragment.uniforms.add(new Wt("backgroundColor",c=>c.backgroundColor));const o=e.baseOpacityMode===hp.Required;if(o&&t.fragment.uniforms.add(new Pe("baseOpacity",c=>c.baseOpacity)),n){const c=e.hasWebGL2Context?ei.None:ei.InvSize;t.fragment.uniforms.add(fp("fboColor",h=>h.fboTexture,c))}const a=e.blendMode!==Fe.Normal,l=e.premultipliedSource===Yd.On;t.fragment.include(Zgt,e),t.fragment.code.add(w`
    vec4 getBackground(vec2 uv) {
      return ${o?w`baseOpacity *`:""} ${s?w`vec4(0.0, 0.0, 0.0, 0.0)`:i?w`vec4(backgroundColor, 1.0)`:r?w`vec4(gridColor(uv), 1.0)`:w`${tl(e,"fboColor","gl_FragCoord.xy")}`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${a?w`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:w`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(n&&!o||s)?w`colorLayer * opacity;`:w`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}let Z6=class extends Wgt{constructor(e,r,i,s,n,o){super(e,s,n),this.colormap=r,this.symbolizer=i,this.u_colormap=o,this.backgroundColor=wa,this.fboTexture=null,this.baseOpacity=1}},Jgt=class extends Z6{},Kgt=class extends Z6{};function Qgt(t){const e=new Lr;return e.include(GCe),e.include(Xgt,t),e.include(Hgt,t),e.include(jCe,t),e.fragment.code.add(w`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),t.colorizerType===mw.Stretch?tyt(e,t):t.colorizerType===mw.Lut?eyt(e):t.colorizerType===mw.Hillshade&&ryt(e,t),e}function eyt(t){t.fragment.code.add(w`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function tyt(t,e){t.fragment.uniforms.add([new dP("u_bandCount",i=>i.symbolizer.u_bandCount),new ya("u_minCutOff",i=>i.symbolizer.u_minCutOff,3),new ya("u_maxCutOff",i=>i.symbolizer.u_maxCutOff,3),new ya("u_factor",i=>i.symbolizer.u_factor,3),new Pe("u_minOutput",i=>i.symbolizer.u_minOutput),new Pe("u_maxOutput",i=>i.symbolizer.u_maxOutput),new Yg("u_useGamma",i=>i.symbolizer.u_useGamma),new ya("u_gamma",i=>i.symbolizer.u_gamma,3),new ya("u_gammaCorrection",i=>i.symbolizer.u_gammaCorrection,3),new Pe("u_opacity",i=>i.common.u_opacity)]),t.fragment.code.add(w`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const r=e.applyColormap?w`gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:w`gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;t.fragment.code.add(w`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===Zw.Noop?w`
        gl_FragColor = applyBackgroundBlend(currentPixel);`:w`
        if (currentPixel.a == 0.0) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${r}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function ryt(t,e){const r=t.fragment;r.uniforms.add([new Pt("u_image",s=>s.u_image),new dP("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new ya("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new ya("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new ya("u_cosZs",s=>s.symbolizer.u_cosZs,6),new ya("u_weights",s=>s.symbolizer.u_weights,6),new Ur("u_factor",s=>s.symbolizer.u_factor),new Pe("u_minValue",s=>s.symbolizer.u_minValue),new Pe("u_maxValue",s=>s.symbolizer.u_maxValue),new Ur("u_srcImageSize",s=>s.common.u_srcImageSize)]),r.include(Am),r.code.add(w`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),r.code.add(w`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?w`gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:w`hillshade *= alpha;
gl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;r.code.add(w`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}const iyt=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:Kgt,ColorizerStretchUniforms:Jgt,ColorizerUniforms:Z6,build:Qgt},Symbol.toStringTag,{value:"Module"}));function syt(t,e,r="nearest",i=!1){var c;const s=!(i&&e.pixelType==="u8"),n=s?Lt.FLOAT:Lt.UNSIGNED_BYTE,o=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),a=(c=t.capabilities.textureFloat)==null?void 0:c.textureFloatLinear,l={width:e.width,height:e.height,target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:t.type===bt.WEBGL2&&s?Et.RGBA32F:ze.RGBA,samplingMode:!a||r!=="bilinear"&&r!=="cubic"?tt.NEAREST:tt.LINEAR,dataType:n,wrapMode:Ot.CLAMP_TO_EDGE,flipped:!1};return new ct(t,l,o)}function nyt(t,e){const{spacing:r,offsets:i,coefficients:s,size:[n,o]}=e,a=r[0]>1,l={width:a?4*n:n,height:o,target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:t.type===bt.WEBGL2?Et.RGBA32F:ze.RGBA,dataType:Lt.FLOAT,samplingMode:tt.NEAREST,wrapMode:Ot.CLAMP_TO_EDGE,flipped:!1},c=new Float32Array(a?n*o*16:2*i.length);if(a&&s!=null)for(let h=0,p=0;h<s.length;h++)c[p++]=s[h],h%3==2&&(c[p++]=1);else for(let h=0;h<o;h++)for(let p=0;p<n;p++){const f=4*(h*n+p),m=2*(p*o+h);c[f]=i[m],c[f+1]=i[m+1],c[f+3]=i[m]===-1?0:1}return new ct(t,l,c)}function pce(t,e){const r={width:e.length/4,height:1,target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,wrapMode:Ot.CLAMP_TO_EDGE,flipped:!1};return new ct(t,r,e)}function oyt(t,e,r,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!t,u_opacity:i,u_transformSpacing:t?t.spacing:Xl,u_transformGridSize:t?t.size:Xl,u_targetImageSize:e,u_srcImageSize:r}}function ayt(t,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:t?t.length/4-1:0}}function lyt(t){return{u_bandCount:t.bandCount,u_minOutput:t.outMin,u_maxOutput:t.outMax,u_minCutOff:t.minCutOff,u_maxCutOff:t.maxCutOff,u_factor:t.factor,u_useGamma:t.useGamma,u_gamma:t.gamma,u_gammaCorrection:t.gammaCorrection}}function cyt(t){return{u_hillshadeType:t.hillshadeType,u_sinZcosAs:t.sinZcosAs,u_sinZsinAs:t.sinZsinAs,u_cosZs:t.cosZs,u_weights:t.weights,u_factor:t.factor,u_minValue:t.minValue,u_maxValue:t.maxValue}}const fce={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let uyt=class{constructor(e,r,i=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=e,this.source=r,this.width=i||r.width,this.height=s||r.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=et(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...fce,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||fce}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){v(e)&&e.length>0?this._bandIds&&e.every((r,i)=>{var s;return!!((s=this._bandIds)!=null&&s[i])&&r===this._bandIds[i]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,v(this._rasterTexture)){const r=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(r==="bilinear"?tt.LINEAR:tt.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=et(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((C(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),v(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&C(this._transformGridTexture)&&(this._transformGridTexture=nyt(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:r,width:i,height:s,opacity:n}=this,o=oyt(r,[i,s],[this.source.width,this.source.height],n),a=ayt(e.colormap,e.colormapOffset),l=this.symbolizerParameters.type==="stretch"?lyt(this.symbolizerParameters):null,c=this.symbolizerParameters.type==="hillshade"?cyt(this.symbolizerParameters):null;return new Z6(o,a,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get memoryUsage(){if(C(this._memoryUsed)){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(r=>v(r)?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=et(this._rasterTexture),this._transformGridTexture=et(this._transformGridTexture),this._colormapTexture=et(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const i=this.source?this.source.extractBands(r):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=et(this._rasterTexture));const s=C(r)&&C(this.bandIds)||v(r)&&v(this.bandIds)&&r.join("")===this.bandIds.join("");if(v(this._rasterTexture)&&s)return;this._rasterTexture=et(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=syt(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((s,n)=>s!==r[n])?(this._colormapTexture=et(this._colormapTexture),this._colormapTexture=pce(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=pce(e,i),void(this._colormap=i)):(this._colormapTexture=et(this._colormapTexture),void(this._colormap=null))}},lN=class{constructor(){this.waitingAgents=new Kt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const r=UV.acquire();return r._init(e),r}release(){this.dispose(),cN.delete(this),UV.release(this)}dispose(){this.loadingAgent=et(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=MS(this._data)}static prune(){UV.prune(0)}_init(e){this.waitingAgents.clear(),this._data=MS(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=jh(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){v(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,r){if(e===r||C(r))this._unsetUpsampleInfo();else{if(C(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===r)return;this._upsampleInfo.tile.unrefMapData()}r.refMapData(),Bgt(e,r,this._upsampleInfo)}}get data(){return this._data}set data(e){MS(this._data),this._data=e}};const UV=new Po(lN,null,()=>{}),cN=new Map;function hyt(){cN.size>0&&(console.log(`${cN.size} live TilePerLayerInfo allocations:`),cN.forEach(t=>console.log(t,`
`)))}let C2=class{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}};var Ct;(function(t){t[t.NONE=0]="NONE",t[t.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",t[t.SPLIT=2]="SPLIT",t[t.VSPLITMERGE=4]="VSPLITMERGE",t[t.MERGE=8]="MERGE",t[t.RENDERDATA=16]="RENDERDATA",t[t.GEOMETRY=32]="GEOMETRY",t[t.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",t[t.TEXTURE_FADING=128]="TEXTURE_FADING"})(Ct||(Ct={}));const VV=M(),lT=M(),mo=M(),dyt=.1;let OK=class{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=hr(),this._elevationBounds=Ke(),this.layerInfo=[[],[]],this.extentInRadians=hr(),this.centerAtSeaLevel=M(),this._center=[M(),cn(),M()],this.up=WW(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=M()}static prune(){MK.prune(0),PK.prune(0),lN.prune()}get _isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[rn.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){var i;this._dirty=!1;const e=((i=this.parent)==null?void 0:i.frustumVisibility)??pa.INTERSECTS;this._frustumVisibility=e===pa.INSIDE?pa.INSIDE:e===pa.OUTSIDE?pa.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const r=this._frustumVisibility!==pa.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}get shouldLoad(){const e=this._surface.snapLevel;if(v(e)){const r=this.level-e;if(r===0)return!0;if(r===1)return!1}return this.isLeaf}init(e,r,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Yr(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[rn.MIDDLE][3]=0,this.vlevel=e?e[0]:0,r&&r.elevationBounds?zn(this._elevationBounds,r.elevationBounds):ar(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const s of yb){const n=i.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=lN.acquire(this._surface.upsampleInfoPool),s===pr.ELEVATION&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,MR)}release(){Df(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of yb){for(const r of this.layerInfo[e])r.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[pr.MAP].reduce((e,r)=>e+(r instanceof FV?r.memoryUsage:0),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const r=this._surface.tilingScheme.pixelSize;return r*r*4}_ensureUsedMemory(){if(v(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;let e=0;for(const{data:i}of this.layerInfo[pr.MAP])i instanceof FV?e+=this._getTerrainDataMemory(i):this._mapTileMemoryInternal+=this._getTerrainDataMemory(i);const r=this._cpuImageMemorySize;for(const i of this.layerInfo[pr.ELEVATION])this._usedMemory+=i.data?r:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=Bw(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,r){const i=this.layerInfo[e][r];return i!=null&&i.data?e===pr.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===pr.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof C2?Bw(e.texture):e instanceof HTMLImageElement||e instanceof q6?this._cpuImageMemorySize:e instanceof FV||e instanceof uyt?e.memoryUsage:0}updateScreenDepth(e){const r=this._center[rn.MIDDLE],i=e,s=r[0],n=r[1],o=r[2],a=i[2]*s+i[6]*n+i[10]*o+i[14];this.screenDepth=a<0?0:a/(i[3]*s+i[7]*n+i[11]*o+i[15])}shouldSplit(e,r,i){if(!this.visible||v(e.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===pa.OUTSIDE))return Ct.NONE;const s=this.level;ge(VV,this._center[rn.MIDDLE],r);let n=ga(VV),o=rn.MIDDLE;ge(lT,this._center[rn.TOP],r);const a=ga(lT);a<n&&(n=a,o=rn.TOP),ge(lT,this._center[rn.BOTTOM],r);const l=ga(lT);if(l<n&&(n=l,o=rn.BOTTOM),this._edgeLen2>n&&s<e.maxLod)return Ct.SPLIT;const c=Math.sqrt(n),h=e.fovX*c*2,p=this._edgeLen/h,f=()=>{const b=s+Math.ceil(-Math.log2(e.relativeWidthLimit/p));return b!==this.vlevel?(this.vlevel=b,Ct.VSPLITMERGE):Ct.NONE_HIT_MAXLOD};if(v(i)&&i-s===1)return s>=e.maxLod?f():Ct.SPLIT;const m=_e(this.up,VV),y=this._elevationBounds[1]-this._elevationBounds[0],_=y/this.edgeLen;if(e.aboveGround&&m>0&&_<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-_>0)return Ct.NONE;if(p<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,Ct.VSPLITMERGE):Ct.NONE;if(s>=e.maxLod)return f();if(s>6){ge(lT,this._center[o],r),ae(mo,this.up,m),ge(mo,mo,lT);const b=ga(mo);if(b>this.radius*this.radius){ae(mo,mo,this.radius/Math.sqrt(b)),me(mo,mo,this._center[o]),ge(mo,r,mo);const x=Math.min(1,(Math.abs(_e(mo,this.up))+.5*y+this._curvatureHeight)/Me(mo)),T=dyt/e.angledSplitBias,S=e.fovY*c*2;if(x*(this._edgeLen/S)<T*e.relativeHeightLimit)return Ct.NONE}}return Ct.SPLIT}setChildren(e,r,i,s){Df(!!(e&&r&&i&&s),"Null child passed"),this._children[0]=e,this._children[1]=r,this._children[2]=i,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of yb)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const r of yb){const i=this.layerInfo[r];for(const s of i)s.loadingAgent&&s.loadingAgent!==tc&&(W$(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(Ct.GEOMETRY),this.resetPendingUpdate(Ct.TEXTURE_NOFADING),this.resetPendingUpdate(Ct.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[pr.MAP];for(const r of e)r.loadingAgent&&r.loadingAgent!==tc&&(W$(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(iw(e,this._clippingArea))return!1;const r=this._intersectsClippingArea,i=this._isWithinClippingArea;v(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=i&&this._isWithinClippingArea,n=!(i||r||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(Ct.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,r){return this.layerInfo[r][e]}hasLayerData(e,r){const i=this.layerInfo[r][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of yb){const r=this.layerInfo[e];for(const i of r)if(i.loadingAgent&&i.loadingAgent!==tc&&i.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(Ct.SPLIT)||e!==pr.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===Ct.SPLIT||e===Ct.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,r,i){const s=this.layerInfo[r][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),r,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),r,e),i.dataArrived(this),!0;if(s.requestPromise)return!0;jh(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,r,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const r=this._children;return r[0]?r[0].findByLij(e)||r[1].findByLij(e)||r[2].findByLij(e)||r[3].findByLij(e):null}distanceToSquared(e){return ga(ge(mo,this._center[rn.MIDDLE],e))}containsPoint(e){const r=this.extent;return e[0]>=r[0]&&e[1]>=r[1]&&e[0]<=r[2]&&e[1]<=r[3]}containsPointXY(e,r){const i=this.extent;return e>=i[0]&&r>=i[1]&&e<=i[2]&&r<=i[3]}unrequestLayerData(e,r,i){const s=this.layerInfo[r][e],n=s.waitingAgents,o=n.removeUnordered(i)!=null;Df(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,r,i){const s=this.layerInfo[r][e];s.data=i,s.dataInvalidated=!1,s.waitingAgents.forAll(n=>n.dataArrived(this)),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,r,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${r}/${e} error ${i}`);const s=this.layerInfo[r][e];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,r){switch(e){case pr.MAP:return this._updateTexture(r);case pr.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===bn.FADING?Ct.TEXTURE_NOFADING:Ct.TEXTURE_FADING),this.setPendingUpdate(e===bn.FADING?Ct.TEXTURE_FADING:Ct.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(Ct.GEOMETRY);for(const e of this.layerInfo[pr.ELEVATION])e.pendingUpdates|=Ct.GEOMETRY}invalidateLayerData(e,r){this.layerInfo[r][e].invalidateSourceData(),this.restartAgents(r)}computeElevationBounds(){const e=this._elevationBounds,r=e[0],i=e[1];ar(e,1/0,-1/0);const s=this.layerInfo[pr.ELEVATION];let n=!0;for(const o of s)v(o.elevationBounds)&&(e[0]=Math.min(e[0],o.elevationBounds.min),e[1]=Math.max(e[1],o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(n=!1));n&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),r===e[0]&&i===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBounds,r=.5*(e[0]+e[1]),i=this._center;ae(mo,this.up,r),me(i[rn.MIDDLE],this.centerAtSeaLevel,mo),ae(mo,this.up,e[0]),me(i[rn.TOP],this.centerAtSeaLevel,mo),ae(mo,this.up,e[1]),me(i[rn.BOTTOM],this.centerAtSeaLevel,mo)}findElevationBoundsForLayer(e,r){const i=this.layerInfo[pr.ELEVATION][e],s=Ej(this.level),n=Math.max(this.vlevel-s,0),o=i.elevationBounds;if(v(o)&&o.level>=r&&o.level<=n)return;const a=this._surface.layerViewByIndex(e,pr.ELEVATION),l=mq(a);if(!JO(this,l,!1))return;const c=fyt;let h=!1;const p=i.data;if(p&&p.level<=n){const f=i.data;c.min=f.samplerData.data.minValue,c.max=f.samplerData.data.maxValue,c.hasNoDataValues=f.samplerData.data.hasNoDataValues,c.level=this.level,h=!0}else{let f,m,y=0;for(let _=this._parent;_&&(!m||y<s)&&(y=this.vlevel-_.level,f=m||f,m=_.layerInfo[pr.ELEVATION][e].data,!(!m&&f&&_.level<=n));_=_.parent);m=m||f,m&&(m.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],c),c.min!==1/0&&(c.level=m.level,h=!0))}h&&(C(i.elevationBounds)&&(i.elevationBounds=new rS),i.elevationBounds.copyFrom(c))}modifyLayers(e,r,i){const s=this.layerInfo[i];for(const a of s)a.loadingAgent&&a.loadingAgent!==tc&&(W$(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)e[a]===void 0&&s[a].release();const n=new Array(...s),o=r.length;s.length=o;for(let a=0;a<o;a++){const l=r[a];s[a]=l>-1?n[l]:lN.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,bn.FADING))}updateAgents(e){if(this.renderData){const r=this.layerInfo[e];for(const i of r)i.loadingAgent===tc&&(i.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of yb){const r=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==tc&&(i.loadingAgent.setSuspension(r),i.loadingAgent===tc&&this.updateRenderData(e,bn.FADING))}}removeLayerAgent(e,r){const i=this.layerInfo[r][e];i.loadingAgent&&i.loadingAgent!==tc&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,r){const i=this.layerInfo[r][e];i.loadingAgent=tc,!i.data&&C(i.upsampleInfo)&&this._createOrUpdateAgents(e+1,r)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||jS(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,r,i){var s,n,o;for(let a=e;a<r;++a){const l=this._surface.layerViewByIndex(a,i);if(A4(l)&&((s=l==null?void 0:l.layer)==null?void 0:s.blendMode)!=="normal"||jS((n=l==null?void 0:l.layer)==null?void 0:n.parent)&&this._hasBlendableAncestor((o=l==null?void 0:l.layer)==null?void 0:o.parent))return!0}return!1}_createOrUpdateAgents(e,r){const i=this.layerInfo[r];if(i.length===0)return;const s=this._isSuspended(r);for(let n=e;n<i.length;++n){const o=i[n];let a=!1;const l=this._surface.layerViewByIndex(n,r),c=mq(l);if(o.loadingAgent?JO(this,c,!1)?(o.loadingAgent!==tc&&o.loadingAgent.setSuspension(s),o.loadingAgent!==tc&&(a=o.loadingAgent.update())):o.dispose():JO(this,c,!1)&&(o.loadingAgent=pyt(this,n,r,s),a=o.loadingAgent.startLoading(),a?o.loadingAgent===tc&&this.setPendingUpdate(Ct.GEOMETRY):(W$(o.loadingAgent),o.loadingAgent=tc)),o.loadingAgent===tc&&this.updateRenderData(r,bn.FADING),!this._hasBlendModes(e,i.length,r)&&a&&l.isOpaque)return}}_isWithinExtent(e){const r=this.extent;return r[0]>=e[0]&&e[2]>=r[2]&&r[1]>=e[1]&&e[3]>=r[3]}intersectsExtent(e){const r=this.extent;return r[2]>=e[0]&&e[2]>=r[0]&&r[3]>=e[1]&&e[3]>=r[1]}getElevationVerticesPerSide(e){const r=this.vlevel-this.level,i=Math.max(this.level-e,Ej(this.level)-r),s=ye(1+(this.maxTesselation>>i),2,this.maxTesselation+1),n=this.getDefaultVerticesPerSide();return Math.max(s,n)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,r){if(!e)return null;const i=this.surface.rootTiles;if(v(i)){for(const s of i)if(myt(s,e)){let n=s,o=e[0]-n.level-1;for(;o>=0&&!n.isLeaf&&!r(n);){const a=e[1]>>o&1,l=e[2]>>o&1;n=n.children[2*a+l],o--}return r(n)?n:null}}return null}findNeighborTile(e,r){const i=this.lij,s=this.getNeighborLIJ(i,e);return s?gyt(i,s)?r(this)?this:null:this._findLIJ(s,r):null}findCorner(e,r){const i=e===Rt.NORTH_EAST?1:e===Rt.NORTH_WEST?0:e===Rt.SOUTH_WEST?2:3;let s=this;for(;s.children[0]&&(!r||!r(s));)s=s.children[i];return s}findNeighborCornerTileExact(e,r){var i;return((i=this.findNeighborTile(e,s=>r(s)||s.level===this.level))==null?void 0:i.findCorner(_q(e),r))||null}forAllSubtreeOnSide(e,r){const i=e===Rt.NORTH?[0,1]:e===Rt.NORTH_EAST?[1]:e===Rt.EAST?[1,3]:e===Rt.SOUTH_EAST?[3]:e===Rt.SOUTH?[2,3]:e===Rt.SOUTH_WEST?[2]:e===Rt.WEST?[0,2]:[0],s=n=>{const o=n.children;!r(n)&&o[0]&&i.forEach(a=>s(o[a]))};s(this)}forallNeighbors(e){O4.forEach(r=>this.findNeighborCornerTileExact(r,e)),Xf.forEach(r=>{var i;return(i=this.findNeighborTile(r,s=>s.level===this.level||e(s)))==null?void 0:i.forAllSubtreeOnSide(R4(r),e)})}getNeighborEdgeStartVertexIndex(e,r){if(!r)return 0;const i=this.level-r.level;if(Re(!En||i>=0),i===0)return 0;const s=2**i,n=(1&e)==1,o=n?0:1,a=r.lij[o+1]*s,l=this.lij[o+1],c=l-a,h=n?s-1-c:c;return En&&(Re(a<=l&&l<a+s),Re(0<=h&&h<s)),h}forEachLoadedNeighbor(e){const r=this.level,i=s=>s.level===r||s.isLoaded;Xf.forEach(s=>{const n=this.findNeighborTile(s,i);n!=null&&n!==this&&n.forAllSubtreeOnSide(R4(s),o=>!!o.isLoaded&&(e(o,s),!0))}),O4.forEach(s=>{var o;const n=(o=this.findNeighborTile(s,i))==null?void 0:o.findCorner(_q(s),a=>a.isLoaded);Re(!n||Sq(this,n,s)),n!=null&&n.isLoaded&&e(n,s)})}getNeighborLIJ(e,r){const i=ece(r)?-1:Qle(r)?1:0,s=Jle(r)?-1:Kle(r)?1:0,n=[e[0],e[1]+i,e[2]+s];return n[1]<0?null:this.surface.isGlobal?this.wrapLIJ(n):n[2]<0?null:n}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this.lij[2]===0}get isNorthEnd(){return this.lij[1]===0}get isSouthEnd(){return this.extent[1]+Oa()>=this.surface.extent[1]}checkGeometryWaterproofness(){var e;E4&&(Re(this.isLoaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const r=this.extent,i=this.surface.rootTilesExtent,s=.25*(r[2]-r[0]);if(ece(e)&&r[3]+s>=i[3]||Qle(e)&&r[1]-s<=i[1])return!1;const n=this.surface.isGlobal;return!(!n&&Jle(e)&&r[0]-s<=i[0])&&!(!n&&Kle(e)&&r[2]+s>=i[2])}updateDistanceToPOI(e){const r=this._lastPOI;if(this.distanceToPOI>=0&&r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2])return;le(this._lastPOI,e);const i=this._center[rn.MIDDLE],s=e[0]-i[0],n=e[1]-i[1],o=e[2]-i[2];this.distanceToPOI=s*s+n*n+o*o}};function pyt(t,e,r,i){const s=r===pr.ELEVATION?PK.acquire():MK.acquire();return s.init(t,e,r,i),s}function W$(t){t.dispose(),t instanceof kCe?PK.release(t):t instanceof zCe&&MK.release(t)}const MK=new Po(zCe),PK=new Po(kCe),fyt=new rS;var rn;function myt(t,e){const r=t.level,i=e[0];if(r>i)return!1;const s=i-r,n=Math.floor(e[1]/2**s),o=Math.floor(e[2]/2**s);return n===t.lij[1]&&o===t.lij[2]}function gyt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function yyt(t,e,r){if(C(t)||C(e))return!1;if(t.level===0&&e.level===0&&(t.isEastEnd&&e.isWestEnd&&r===Rt.EAST||t.isWestEnd&&e.isEastEnd&&r===Rt.WEST))return!0;const i=Math.max(1e-6*(t.extent[2]-t.extent[0]),1);switch(r){case Rt.NORTH:return Mh(t.extent[3],e.extent[1],i);case Rt.SOUTH:return Mh(t.extent[1],e.extent[3],i);case Rt.EAST:return Mh(t.extent[2],e.extent[0],i)||Mh(t.extent[2],-e.extent[0],i);case Rt.WEST:return Mh(t.extent[0],e.extent[2],i)||Mh(t.extent[0],-e.extent[2],i)}}function Sq(t,e,r){return!C(t)&&!C(e)&&e!==t&&(t.level>=e.level?mce(t,e,r):mce(e,t,_q(r)))}function mce(t,e,r){Re(t.level>=e.level);const i=Dmt(r),s=Nmt(r),n=t.extent,o=e.extent,a=[i?n[0]:n[2],s?n[3]:n[1]],l=[i?o[2]:o[0],s?o[1]:o[3]],c=1e-5*(n[2]-n[0]),h=Mh(a[0],l[0],c)||t.surface.isGlobal&&Mh(a[0],-l[0],c),p=Mh(a[1],l[1],c);if(h&&p)return!0;if(t.level===e.level||!h&&!p)return Re(!1),!1;const f=h?gce(o[1],o[3],n[1],n[3],c):gce(o[0],o[2],n[0],n[2],c);return Re(f),f}function gce(t,e,r,i,s=Oa()){return t-s<=r&&r<=i&&i<=e+s}(function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"})(rn||(rn={}));let _yt=class{constructor(){this._scales=qt(-1,-1,-1,-1),this._offsets=qt(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,r,i){this._scales[2*e]=r,this._scales[2*e+1]=i}setOffset(e,r,i){this._offsets[2*e]=r,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}};function vyt(t,e){t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),e.spherical?t.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):t.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),t.fragment.code.add(w`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}let IK=class extends OSe{constructor(){super(...arguments),this.slicePlaneLocalOrigin=M(),this.origin=this.slicePlaneLocalOrigin}};var Rc;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight"})(Rc||(Rc={}));let byt=class extends IK{constructor(){super(...arguments),this.identifier=Rc.Material,this.output=V.Color,this.transparent=!1,this.integratedMesh=!1}},wyt=class extends IK{constructor(){super(...arguments),this.identifier=Rc.ShadowMap}},xyt=class extends IK{constructor(){super(...arguments),this.identifier=Rc.Highlight}},M4=class extends ws{constructor(e,r){super(e,"vec4",di.Draw,(i,s,n)=>i.setUniform4fv(e,r(s,n)))}};var ty;function Tyt(t,e){const{vertex:r,fragment:i}=t;r.uniforms.add([new M4("overlayTexOffset",(s,n)=>Syt(s,n)),new M4("overlayTexScale",(s,n)=>Eyt(s,n))]),i.constants.add("overlayOpacity","float",1),i.uniforms.add(new Pt("ovColorTex",(s,n)=>Eq(s,n))),HCe(t,e)}function HCe(t,e){t.extensions.add("GL_OES_standard_derivatives"),e.pbrMode!==dt.Water&&e.pbrMode!==dt.WaterOnIntegratedMesh&&e.pbrMode!==dt.TerrainWithWater||t.include(LSe,e);const{vertex:r,fragment:i}=t;t.varyings.add("vtcOverlay","vec4"),r.code.add(w`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),i.code.add(w`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),i.code.add(w`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),i.code.add(w`
    vec4 getOverlayColorTexel(vec4 texCoords) {
          vec2 texDim =  ${kh(e,"ovColorTex")};

          vec4 color0 = ${tl(e,"ovColorTex","vec2(texCoords.x * 0.5, texCoords.y)*texDim")};
          vec4 color1 = ${tl(e,"ovColorTex","vec2(texCoords.z * 0.5 + 0.5, texCoords.w)*texDim")};

          bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
          bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));

          return mix(color1 * float(isValid1), color0, float(isValid0));
    }
  `),e.pbrMode!==dt.Water&&e.pbrMode!==dt.WaterOnIntegratedMesh&&e.pbrMode!==dt.TerrainWithWater||(by(i),Cm(i),i.code.add(w`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function Eq(t,e){return e.overlays.length===0?null:t.identifier===Rc.Material&&t.output===V.Color?e.overlays[es.INNER].getColorTextureNoRasterImage():t.identifier===Rc.Material&&t.output===V.ObjectAndLayerIdColor?e.overlays[es.INNER].getColorTexture(Nl.ObjectAndLayerIdColor):t.identifier===Rc.Highlight?e.overlays[es.INNER].getValidTexture(ms.Highlight):null}function Syt(t,e){for(const r of e.overlays){const{index:i,extent:s}=r;Ufe(s)>0&&(PS[2*i]=t.toMapSpace[0]/Cu(s)-s[0]/Cu(s),PS[2*i+1]=t.toMapSpace[1]/wp(s)-s[1]/wp(s))}return PS}function Eyt(t,e){for(const r of e.overlays){const{index:i,extent:s}=r;Ufe(s)>0&&(PS[2*i]=t.toMapSpace[2]/Cu(s),PS[2*i+1]=t.toMapSpace[3]/wp(s))}return PS}(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(ty||(ty={}));const PS=nr();var Yf;(function(t){t[t.LayerOnly=0]="LayerOnly",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.COUNT=3]="COUNT"})(Yf||(Yf={}));let Cyt=class extends pi{constructor(){super(...arguments),this.overlayOpacity=1}};function vA(t,e){t.vertex.uniforms.add([new P4("overlayTexOffset"),new P4("overlayTexScale")]),t.fragment.uniforms.add([new Pe("overlayOpacity",r=>r.overlayOpacity),new Pt("ovColorTex",(r,i)=>i.overlays.length===0?null:i.overlays[es.INNER].getColorTexture(r.overlaySource))]),HCe(t,e)}function Ayt(t,e){const{vertex:r,fragment:i,varyings:s}=t;s.add("vtc","vec2"),r.uniforms.add(new P4("texOffsetAndScale")),i.uniforms.add(new yce("tex")),i.uniforms.add(new kV("textureOpacities"));const n=e.textureFadingEnabled&&!e.renderOccluded;n&&(r.uniforms.add(new P4("nextTexOffsetAndScale")),s.add("nvtc","vec2"),i.uniforms.add(new yce("texNext")),i.uniforms.add(new kV("nextTexOpacities")),i.uniforms.add(new Ryt("fadeFactor")));const o=e.tileBlendInput===Yf.ColorComposite,a=e.tileBlendInput===Yf.GridComposite;a&&i.include(RK),o&&i.uniforms.add(new kV("backgroundColor")),r.code.add(w`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${n?w`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:w``}
  }`),i.code.add(w`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${a||o?w`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${o?w`backgroundColor`:w`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:w`return color;`}
    }`),n?i.code.add(w`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):i.code.add(w`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}let Ryt=class extends ws{constructor(e){super(e,"float")}},kV=class extends ws{constructor(e){super(e,"vec3")}},P4=class extends ws{constructor(e){super(e,"vec4")}},yce=class extends ws{constructor(e){super(e,"sampler2D")}},qCe=class extends Cyt{};function Oyt(t){const e=new Lr,{vertex:r,fragment:i,varyings:s}=e;e.include(eP),e.include(hP,t),e.include(tm,t);const n=()=>{e.include(K3,t),r.code.add(w`
      vec3 decodeNormalTerrain(vec2 e) {
        float z = 1.0 - abs(e.x) - abs(e.y);
        vec3 n = vec3(e + vec2(e.x >= 0.0 ? 1.0 : -1.0, e.y >= 0.0 ? 1.0 : -1.0) * min(z,0.0),z);
        return normalize(n);
      }

      vec3 getNormal() {
        return  ${t.shading?w`decodeNormalTerrain(normalCompressed)`:w`getLocalUp(position, localOrigin)`};
      }
  `)};Nc(r,t),e.include(Gl,t);const o=t.overlayMode!==ty.Disabled;switch(t.output){case V.Color:{e.include(Ayt,t),e.include(Yw,t),o&&e.include(vA,{...t,pbrMode:t.pbrMode===dt.Terrain?dt.TerrainWithWater:dt.Water});const a=t.overlayMode===ty.EnabledWithWater;a&&e.include(vyt,t),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),n(),(t.atmosphere||t.screenSizePerspective)&&OE(r);const l=t.receiveShadows&&!t.renderOccluded;l&&e.include(cC,t),t.atmosphere&&s.add("wnormal","vec3"),t.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),r.code.add(w`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${a?w`forwardVertexTangent(vnormal);`:w``}

          ${t.atmosphere?w`wnormal = normalize((viewNormal * vec4(normalize(positionWorld), 1.0)).xyz);`:""}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${o?w`setOverlayVTC(uv);`:""}
          ${t.tileBorders?w`forwardTextureCoordinates();`:""}

          ${t.screenSizePerspective?w`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${l?w`forwardLinearDepth();`:""}

        }
      `),e.extensions.add("GL_OES_standard_derivatives"),e.extensions.add("GL_EXT_shader_texture_lod"),e.include(Zs,t),e.include(Yw,t),e.include(pP,t),e.include(Xw,t),Cp(i,t),fP(i),gC(i),i.uniforms.add([r.uniforms.get("localOrigin"),new Wt("viewDirection",(c,h)=>ve(_ce,ce(_ce,h.camera.viewMatrix[12],h.camera.viewMatrix[13],h.camera.viewMatrix[14])))]),a&&i.uniforms.add([new Pt("ovWaterTex",(c,h)=>h.overlays.length===0?null:h.overlays[es.INNER].getNormalTexture(c.overlaySource)),new CTe("view",(c,h)=>ql(Myt,h.camera.viewMatrix,c.origin))]),i.code.add(w`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),by(i),Cm(i),i.code.add(w`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${t.receiveShadows&&!t.renderOccluded?"readShadowMap(vpos, linearDepth)":t.spherical&&t.shading?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${o?w`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${t.invisible?w`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }
          ${t.atmosphere?w`
              float ndotl = clamp(vndl, 0.0, 1.0);
              vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
              atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); // avoid atmosphere on bright base maps
              atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
              atm *= tileColor.a; // premultiply with tile alpha`:""}

          vec3 albedo = ${t.atmosphere?w`atm + tileColor.rgb;`:w`tileColor.rgb;`}

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${t.pbrMode===dt.Terrain||t.pbrMode===dt.TerrainWithWater?w`gl_FragColor = vec4(evaluateTerrainLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:w`gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${a?w`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${t.screenSizePerspective?w`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${t.visualizeNormals?t.spherical?w`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:w`
                  vec3 tNormal = normalize(normal);
                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${t.tileBorders?w`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
        }
      `)}break;case V.Depth:o&&e.include(vA,t),e.include(py,t),hv(e),jw(e),r.code.add(w`
              void main(void) {
                ${o?w`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),i.code.add(w`
              void main() {
                ${o&&t.invisible?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case V.Shadow:case V.ShadowHighlight:case V.ShadowExcludeHighlight:e.include(py,t),hv(e),jw(e),r.code.add(w`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),i.code.add(w`void main() {
outputDepth(linearDepth);
}`);break;case V.Normal:o&&e.include(vA,t),s.add("vnormal","vec3"),OE(r),n(),r.code.add(w`
            void main(void) {
              ${o?w`setOverlayVTC(getUV0());`:""}
              gl_Position = transformPosition(proj, view, position);
              vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
            }
        `),i.code.add(w`
            void main() {
              ${o&&t.invisible?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
              vec3 normal = normalize(vnormal);
              if (gl_FrontFacing == false) {
                normal = -normal;
              }
              gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
            }
        `);break;case V.Highlight:o&&e.include(vA,t),r.code.add(w`
          void main() {
            ${o?w`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),e.include(Ry,t),i.code.add(w`
          void main() {
            ${o?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return t.output===V.ObjectAndLayerIdColor&&(e.include(vA,{...t,pbrMode:dt.Disabled}),r.code.add(w`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),i.code.add(w`void main() {
gl_FragColor = getOverlayColorTexel(vtcOverlay);
}`)),e}const Myt=Ie(),_ce=M(),Pyt=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:qCe,build:Oyt},Symbol.toStringTag,{value:"Module"}));let WCe=class XCe extends kr{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2,r.spherical=e.viewingMode===Be.Global}initializeProgram(e){return new Nr(e.rctx,XCe.shader.get().build(this.configuration),YCe)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const r=this.configuration,i=r.backfaceCullingEnabled&&!r.renderOccluded;return zt({blending:r.renderOccluded?Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA):null,culling:i?FZ:null,depthTest:r.renderOccluded?null:{func:$i.LESS},depthWrite:r.renderOccluded?null:Yl,colorWrite:Qt,stencilTest:e?Lat(jl.IntegratedMeshMaskExcluded):null})}getPipelineState(e,r){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,r)}};WCe.shader=new Dr(Pyt,()=>ie(()=>import("./Terrain.glsl-fdc516ce.js"),[],import.meta.url));const YCe=new Map([[A.POSITION,0],[A.UV0,1],[A.NORMALCOMPRESSED,2]]);let Iyt=class{constructor(){this.geometryInfo=new Rgt,this.intersectionData=null,this.geometryState=null,this._textureRef=new NCe(()=>this.tile.surface.textureFadeDuration),this.overlay=new _yt,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}get tile(){return this._tile}init(e){this.clear(),this._tile=e;const r=this.geometryInfo;r.indices=null,r.vertexAttributes=null,Mi(r.boundingBox),r.indexCount=0,r.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new Dgt,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._shadingChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),En&&this.tile.intersectsClippingArea)for(let r=0;r<4;++r)Re(this.geometryInfo.outerEdges[r].count===this.geometryState.neighborData.edgeResolutions[r]+1)}_calculateEdgeResolution(e,r){var l;const i=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const c=i.surface.extent;if(v(c)&&(e===0&&i.extent[3]>c[3]||e===1&&i.extent[2]>c[2]||e===2&&i.extent[1]<c[1]||e===3&&i.extent[0]<c[0]))return s}const n=i.level,o=Xf[e];if(!r)return Re(C((l=i.surface)==null?void 0:l.rootTiles)||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(o)),s;if(r.isLoaded){const c=r,h=c.renderData.geometryState,p=n-c.level;if(Re(p>=0),p===0){const y=h.numVerticesPerSide-1;return Math.max(y,s)}const f=2**p,m=h.neighborData.edgeResolutions[(e+2)%4]/f;return Math.max(1,m)}Re(!r.isLeaf);let a=s;return r.forAllSubtreeOnSide(R4(o),c=>c===i||(c.isLoaded?(a=Math.max(a,2**(c.level-n)),!0):(Re(!c.isLeaf),!1))),a}updateNeighborData(){var a;const e=this.tile;if(!e.intersectsClippingArea)return;const r=e.renderData.geometryState.neighborData,i=l=>(l.isLoaded||l.level===e.level)&&(l==null?void 0:l.intersectsClippingArea),s=r.edgePeerNeighbors,n=r.edgePeerNeighborSamplerVersions;for(let l=0;l<4;++l){const c=e.findNeighborTile(Xf[l],i),h=Ub(e,c),p=((a=h==null?void 0:h.renderData)==null?void 0:a.geometryState.samplerDataVersion)??-1,f=s[l],m=h!==Ub(e,f),y=n[l]!==p;s[l]=c,(m||y)&&(n[l]=p,this._markEdgeDirty(l));const _=r.edgeResolutions[l],b=this._calculateEdgeResolution(l,c);Re(vp(b)),Re(b>=1),r.edgeResolutions[l]=b,_!==b&&this._markEdgeResolutionDirty(l)}const o=r.cornerPeerNeighbors;for(let l=0;l<4;++l){const c=e.findNeighborTile(O4[l],i);o[l]=c;const h=Ub(e,s[l]),p=Ub(e,s[(l+1)%4]),f=Ub(e,c);yd[l]=f,yd[(l+1)%4]=p,yd[(l+2)%4]=e,yd[(l+3)%4]=h,Re(yd.some(b=>(b==null?void 0:b.isLoaded)||b===e));const m=yd.reduce((b,x)=>Math.min(b,(x==null?void 0:x.level)??1/0),1/0);yd.forEach((b,x)=>{b&&(b==null?void 0:b.level)>m&&(yd[x]=null)}),Re(yd.some(b=>(b==null?void 0:b.isLoaded)||b===e));const y=r.cornerNeighborData[l].cornerTiles,_=r.cornerNeighborData[l].cornerTileSamplerVersions;for(let b=0;b<4;++b){const x=yd[b],T=(x==null?void 0:x.renderData.geometryState.samplerDataVersion)??-1,S=y[b]!==x,E=!S&&_[b]!==T;(S||E)&&(y[b]=x,_[b]=T,this._markCornerDirty(l))}Re(y.some(b=>(b==null?void 0:b.isLoaded)||b===e))}En&&Re(this.geometryState.neighborData.edgeResolutions.every(l=>l>0));for(let l=0;l<4;++l)yd[l]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;En&&Re(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every(l=>l>0)),this.intersectionData=null;const r=this.tile,i=this._vao,s=this.geometryInfo.vertexAttributes,n=!i||!s||this._wireframeChanged||this._shadingChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,o=!n&&(this._dirtyEdges!==0||this._dirtyEdgeResolutions!==0),a=!o&&this._dirtyCorners!==0;n?(this.releaseGeometry(),this._createGeometry(e)):o||a?r.updateEdgeElevations():a?r.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,Pgt(this.geometryInfo),!0)}ensureTexture(e,r){return v(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),C(this._texture)&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){v(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_markCornerDirty(e){const r=1<<e;this._dirtyCorners|=r}_markEdgeDirty(e){const r=1<<e;this._dirtyEdges|=r}_markEdgeResolutionDirty(e){const r=1<<e;this._dirtyEdgeResolutions|=r,this._dirtyEdges|=r}_markAllEdgesAndCornersDirty(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}updateGeometryState(){const e=this._getElevationInfo(),r=this.tile,i=e.samplerData?r.getElevationVerticesPerSide(e.maxTileLevel):r.getDefaultVerticesPerSide(),s=Math.max(i,5);let n=r.clippingArea;r.intersectsClippingArea&&!r.isWithinClippingArea||(n=null);const o=this.geometryState;let a=!1;o.numVerticesPerSide!==s&&(this._numVerticesPerSideChanged=!0,o.numVerticesPerSide=s,o.samplerDataVersion++,a=!0),e.changed&&(this._samplerDataChanged=!0,o.samplerData=e.samplerData,o.samplerDataVersion++,a=!0),ry(o.clippingArea,n)||(this._clippingAreaChanged=!0,o.clippingArea=n,a=!0);const l=r.surface,c=l.wireframe;o.wireframe!==c&&(this._wireframeChanged=!0,o.wireframe=c,a=!0);const h=l.shading;return o.shading!==h&&(this._shadingChanged=h,o.shading=h,a=h),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=a),a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const r=this.geometryInfo.vertexAttributes,i=this.geometryInfo.indices,s=e.gl;this._vao=new Pp(e,YCe,{geometry:Hc(r.layout)},{geometry:jr.createVertex(e,s.STATIC_DRAW,r.buffer)},jr.createIndex(e,s.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,r=Qg.Immediate){v(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,r)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,r=this.tile.layerInfo[pr.ELEVATION],i=r.length,s=new Array(i);let n=0,o=0,a=!1;for(let h=0;h<i;h++){const p=r[h];if(v(p.upsampleInfo)){const f=p.upsampleInfo.tile,m=f.layerInfo[pr.ELEVATION][h].data,y=m&&m.samplerData;e&&e[n]===y||(a=!0),s[n++]=y,o=Math.max(o,f.lij[0])}else if(p.data){const f=this.tile.surface.layerViewByIndex(h,pr.ELEVATION);if(JO(this.tile,f.layer,!1)){const m=p.data;e&&e[n]===m.samplerData||(a=!0),s[n++]=m.samplerData,o=this.tile.level}}}v(e)&&e.length!==n&&(a=!0);const l=n>0,c=l?s:null;return l&&(s.length=n),{changed:a,samplerData:c,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){var r,i;const e=xu(this.intersectionData,0,s=>s.estimatedMemoryUsage);return(((r=this.geometryInfo.indices)==null?void 0:r.byteLength)??0)+(((i=this.geometryInfo.vertexAttributes)==null?void 0:i.byteLength)??0)+e}get textureDescriptor(){return v(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}checkGeometryWaterproofness(){if(!En)return;const e=this.tile;if(Re(e==null?void 0:e.isLoaded),!e.isLoaded||!e.intersectsClippingArea)return;const r=e.renderData;if(e.level===0)return;const i=e.surface.extent;if(v(i)&&!e.intersectsExtent(i))return;const s=Xf.map((l,c)=>!!v(i)&&(c<2?-1:1)*(e.extent[3-c]-i[3-c])<0),n=e.level;Re(this._dirtyCorners===0),Re(this._dirtyEdges===0),Re(this._dirtyEdgeResolutions===0),Re(!this._numVerticesPerSideChanged),Re(!this._samplerDataChanged),Re(!this._clippingAreaChanged),Re(!this._wireframeChanged);const o=O4.map(l=>e.findNeighborCornerTileExact(l,c=>!c.intersectsClippingArea||c.isLoaded||c.level===e.level)??null).map(l=>l!=null&&l.intersectsClippingArea?l:null),a=this.geometryState.neighborData;for(let l=0;l<4;++l){const c=a.cornerPeerNeighbors[l],h=o[l];Re(h===c,`Tile[${e.lij}].corner[${l}] out of date: cur=[${c==null?void 0:c.lij}] exp=[${h==null?void 0:h.lij}]`)}Xf.forEach((l,c)=>{if(s[c])return;const h=e.findNeighborTile(l,N=>(N.level===n||(N==null?void 0:N.isLoaded))&&(N==null?void 0:N.intersectsClippingArea));if(!h){const N=!e.surface.updatingRootTiles&&v(e.surface.rootTiles)&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(l);return void Re(!N)}Re(h.isLoaded||h.level===e.level),Re(h===this.geometryState.neighborData.edgePeerNeighbors[c]);const p=n-h.level;if(!h.isLoaded)return Re(!h.isLeaf),void Re(p===0);const f=h.renderData;Re(yyt(e,h,l)),Re(p>=0);const m=2**p;if(p<0)return void Re(!1);const y=r.geometryInfo,_=y.outerEdges[c],b=y.numVerticesPerSide-1,x=f.geometryInfo;if(!x)return void Re(!1);{const N=this.geometryState.neighborData.edgePeerNeighbors[c];if(N!=null&&N.isLoaded){const F=N.renderData;Re(N==N),Re(r.geometryState.neighborData.edgePeerNeighborSamplerVersions[c]===F.geometryState.samplerDataVersion),Re(this.geometryState.neighborData.edgePeerNeighborSamplerVersions[c]===F.geometryState.samplerDataVersion)}}const T=(c+2)%4,S=x.outerEdges[T],E=_.count-1,O=S.count-1;Re(E*m===O,`Tile[${e.lij}]:e${c},res=${E} edgeRes mismatch with Neighbor[${h.lij}]:e${T},res=${O} (expected:${E*m})`);const R=e.extent,L=l===Rt.NORTH||l===Rt.SOUTH,I=S.count-1,U=I/2**p,z=_.count-1;if(U<1)return void Re(z===1);Re(U===z),Re(vp(U));const B=x.numVerticesPerSide-1;Re(p>0||U===Math.max(B,b));const G=e.getNeighborEdgeStartVertexIndex(c,h);Re(0<=G&&G<m);const K=G*U;Re(0<=K&&K<=I-U);let re=0,ee=K;_.getVertexPos(Zp,0),_.getVertexPos(Jp,_.count-1);const q=Si(Zp,Jp),$=Math.max($yt,1e-4*q);for(let N=0;N<=U;++N){_.getVertexPos(Zp,re),S.getVertexPos(Jp,ee);const F=N/U,H=L?R[0]+F*(R[2]-R[0]):l===Rt.WEST?R[0]:R[2],X=L?l===Rt.SOUTH?R[1]:R[3]:R[1]+F*(R[3]-R[1]),J=e.surface.extent;if(C(J)||a5(J,H,X)){const W=AM(Zp,Jp),ue=yc(Zp)-br.radius,pe=yc(Jp)-br.radius,we=W<$;if(!we){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${c}[${re}/${_.count}] and [${h.lij}].edge${T}[${ee}/${S.count}]`),v(J)&&console.warn("  surface extent= ",J," x,y=",H,",",X);const Ce=M();ge(Ce,r.localOrigin,f.localOrigin),yc(Ce)>0&&console.warn(`   localOrigins: ${r.localOrigin} vs ${f.localOrigin} d=${yc(Ce)} [${Ce}]`),(()=>{const je=gs(Zp),De=gs(Jp);e.updateEdgeElevations(),h.updateEdgeElevations(),_.getVertexPos(Zp,re),S.getVertexPos(Jp,ee);const xe=M();so(xe,Zp,je),yc(xe)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${je} vs ${Zp} d=${yc(xe)} [${xe}]`),so(xe,Jp,De),yc(xe)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${De} vs ${Jp} d=${yc(xe)} [${xe}]`)})(),Re(we,`Mismatch in tile [${e.lij}].edge[${c}][${re}/${_.count}] vs neighbor [${h.lij}].edge[${T}][${ee}/${S.count}] ${Zm(Zp)} vs ${Zm(Jp)}  dist=${W} h(t|n|d)=${ue}|${pe}|${pe-ue}`)}if(e.surface.shading){_.getNormal(cT,re),S.getNormal(uT,ee),ve(vce,cT),ve(bce,uT);const Ce=_e(vce,bce),je=1-Ce<.01||!1||e===h;if(!je){const De=M();so(De,cT,uT);const xe=()=>`Mismatch in tile edge normal ${Zle(e.lij)} (${re}/${_.count-1}) edge ${c} vs neighbor ${Zle(h.lij)}  (${ee}/${S.count-1}) nedge ${T} :${Zm(cT)} vs ${Zm(uT)}  dot = ${Ce} : ${Zm(De)}`;console.warn("Mismatch in tile edge normal: ",xe());{e.updateEdgeElevations(),h.updateEdgeElevations();const Ne=M(),Ue=M();_.getNormal(Ne,re),S.getNormal(Ue,ee),Q_(cT,Ne)||console.warn("Missing update in tile normal: ",Zm(cT)," => ",Zm(Ne)),Q_(uT,Ue)||console.warn("Missing update in neighbor normal: ",Zm(uT)," => ",Zm(Ue))}Re(je,xe())}}}re+=1,ee+=1}})}};const Zp=M(),Jp=M(),cT=M(),uT=M(),vce=M(),bce=M(),$yt=1,yd=[null,null,null,null];function Ub(t,e){return e!=null&&e.isLoaded||e===t?e:null}const Lyt=65536;function Dyt(t,e){const r=t.tile,{extent:i,extentInRadians:s,surface:n}=r,o=t.localOrigin,a=t.geometryState,l=n.isWebMercator,c=n.shading||Jw,h=a.numVerticesPerSide,p=h-1,f=(h-2)**2,m=l&&(e===Oh.HAS_SOUTH_POLE||e===Oh.HAS_BOTH_POLES),y=l&&(e===Oh.HAS_NORTH_POLE||e===Oh.HAS_BOTH_POLES),_=6,b=((m?1:0)+(y?1:0))*_*(p+1),x=a.neighborData,T=x.edgeResolutions.reduce((I,U)=>I+U+1,0),S=DCe(f+b+T),E=t.geometryInfo;E.numVerticesPerSide=a.numVerticesPerSide,E.vertexAttributes=S;const O=E.boundingBox;Mi(O);const R=$K(t);on.update(p,s,R),Nyt(t),sAe(t,f),ZCe(t);const L=[];if((()=>{let I=f+T;const U=o[0],z=o[1],B=o[2],G=r.ellipsoid.radius,K=i[1],re=i[3],ee=(q,$)=>{const N=$*h;il(-U,-z,q*G-B,O),L.push({connectedRowOffset:N,connectedOuterEdgeOffset:q===1?0:2,rowOffset:I,latitudeResolution:_});const F=QCe(q===-1?K:re,G),H=q*Math.PI/2-F,X=.99*(q===1?1:-1),J=G+0,W=S.position,ue=S.uv0,pe=S.normalCompressed;for(let we=1;we<=_;++we){const Ce=F+H*(we/_),je=Math.cos(Ce),De=Math.sin(Ce);for(let xe=0;xe<=p;xe++){const Ne=xe/p,Ue=on.sinLonLUT[xe],xt=on.cosLonLUT[xe]*je,Qe=Ue*je,Ut=De,Xt=xt*J-U,er=Qe*J-z,Yt=Ut*J-B;il(Xt,er,Yt,O),W.setValues(I,Xt,er,Yt),Fc(ue,I,Ne,X),c&&nM(pe,I,xt,Qe,Ut),++I}}};m&&ee(-1,0),y&&ee(1,p)})(),iAe(E,a.numVerticesPerSide,L,[0,h-1],[0,h-1],a.wireframe),t.intersectionData=null,En)for(let I=0;I<4;++I)Re(E.outerEdges[I].count===x.edgeResolutions[I]+1)}function Nyt(t){const e=t.tile;e.intersectsClippingArea&&(e.surface.shading||Jw?Uyt(t):Fyt(t))}function Fyt(t){const e=t.geometryState,r=e.numVerticesPerSide,i=r-2,s=r-1,n=t.geometryInfo,o=n.vertexAttributes,a=o.position,l=o.uv0,c=t.tile,h=c.extent,p=h[0],f=h[2],m=h[1],y=h[3],_=c.ellipsoid.radius,b=e.samplerData,x=t.localOrigin,T=x[0],S=x[1],E=x[2],O=n.boundingBox,R=a.typedBuffer,L=a.typedBufferStride;let I=0;for(let U=1;U<=i;U++){const z=U/s,B=m*(1-z)+y*z,G=on.sinLatLUT[U],K=on.cosLatLUT[U];for(let re=1;re<=i;re++){const ee=re/s,q=p*(1-ee)+f*ee,$=on.sinLonLUT[re],N=on.cosLonLUT[re],F=_+Hi(q,B,b),H=N*K*F-T,X=$*K*F-S,J=G*F-E;il(H,X,J,O);const W=I*L;R[W]=H,R[W+1]=X,R[W+2]=J,Fc(l,I,ee,z),++I}}}function Uyt(t){const e=t.geometryState,r=e.numVerticesPerSide,i=r-2,s=r-1,n=t.geometryInfo,o=n.vertexAttributes,a=o.position,l=o.uv0,c=o.normalCompressed,h=t.tile,p=h.extent,f=p[0],m=p[2],y=p[1],_=p[3],b=h.ellipsoid.radius,x=e.samplerData,T=t.localOrigin,S=T[0],E=T[1],O=T[2],R=a.typedBuffer,L=a.typedBufferStride,I=1/s,U=n.boundingBox;let z=0;if(1<=i){const B=I,G=y*(1-B)+_*B,K=on.sinLatLUT[1],re=on.cosLatLUT[1];for(let ee=1;ee<=i;ee++){const q=ee*I,$=f*(1-q)+m*q,N=on.sinLonLUT[ee],F=on.cosLonLUT[ee],H=b+Hi($,G,x),X=H*F*re-S,J=H*N*re-E,W=H*K-O;il(X,J,W,U);const ue=(ee-1)*L;R[ue]=X,R[ue+1]=J,R[ue+2]=W,Fc(l,ee-1,q,B)}}for(let B=1;B<=i;B++){const G=B*I,K=y*(1-G)+_*G,re=on.sinLatLUT[B],ee=on.cosLatLUT[B],q=B+1,$=q*I,N=y*(1-$)+_*$,F=on.sinLatLUT[q],H=on.cosLatLUT[q],X=on.sinLonLUT[0],J=on.cosLonLUT[0],W=b+Hi(f,K,x);let ue=J*ee*W-S,pe=X*ee*W-E,we=re*W-O;const Ce=z*L;let je=R[Ce],De=R[Ce+1],xe=R[Ce+2];for(let Ne=1;Ne<=i;Ne++){const Ue=Ne*I,xt=f*(1-Ue)+m*Ue,Qe=on.sinLonLUT[Ne],Ut=on.cosLonLUT[Ne];let Xt=Ut*ee,er=Qe*ee,Yt=re,mr=0,Jr=0,Sr=0;{let it=0,Je=0,at=0;if(Ne<i){const Rr=(z+1)*L;it=R[Rr],Je=R[Rr+1],at=R[Rr+2]}else{const Rr=on.sinLonLUT[s],Or=on.cosLonLUT[s],Mr=b+Hi(m,K,x);it=Or*ee*Mr-S,Je=Rr*ee*Mr-E,at=re*Mr-O}const ut=ue,St=pe,Ht=we;ue=je,pe=De,we=xe,je=it,De=Je,xe=at,mr=it-ut,Jr=Je-St,Sr=at-Ht}{let it=0,Je=0,at=0;if(B>1){const ut=(z-i)*L;it=R[ut],Je=R[ut+1],at=R[ut+2]}else{const ut=on.sinLatLUT[0],St=on.cosLatLUT[0],Ht=b+Hi(xt,y,x);it=Ut*St*Ht-S,Je=Qe*St*Ht-E,at=ut*Ht-O}{const ut=b+Hi(xt,N,x),St=Ut*H*ut-S,Ht=Qe*H*ut-E,Rr=F*ut-O;if(B<i){const Ci=z+i,sr=Ci*L;R[sr]=St,R[sr+1]=Ht,R[sr+2]=Rr,il(St,Ht,Rr,U),Fc(l,Ci,Ue,$)}const Or=it-St,Mr=Je-Ht,Pr=at-Rr;Yt*Yt<.999&&(Xt=Sr*Mr-Jr*Pr,er=mr*Pr-Sr*Or,Yt=Jr*Or-mr*Mr)}}const xr=1/Math.sqrt(Xt*Xt+er*er+Yt*Yt);nM(c,z,Xt*xr,er*xr,Yt*xr),++z}}}function Vyt(t){t.tile.intersectsClippingArea&&(ZCe(t),J6(t))}function kyt(t){t.tile.intersectsClippingArea&&(KCe(t),JCe(t,!0),J6(t))}function ZCe(t){t.tile.intersectsClippingArea&&(KCe(t),JCe(t))}function JCe(t,e=!1){const r=t.geometryState,i=t.geometryInfo,s=r.neighborData,n=t.tile,o=n.level,a=n.extent,l=n.ellipsoid.radius,c=n.extentInRadians,h=c[0],p=c[2],f=c[1],m=c[3],y=r.samplerData,_=a[0],b=a[2],x=a[1],T=a[3],S=$K(t),E=i.boundingBox,O=t.localOrigin,R=O[0],L=O[1],I=O[2],U=n.surface.shading||Jw,z=i.vertexAttributes,B=z.position,G=B.typedBuffer,K=B.typedBufferStride,re=z.uv0;for(let ee=0;ee<4;++ee){const q=ee===1||ee===3,$=s.edgeResolutions[ee];Re(vp($));const N=$+1,F=Ub(n,s.edgePeerNeighbors[ee]);if(aAe(n,F,ee)){nAe(t,ee,F);continue}const H=v(F);Re(!H||F.level===n.level),Re(!H||ey(n,F)<=0);const X=F==null?void 0:F.renderData,J=X==null?void 0:X.geometryState;if(En){const Je=n.surface;if(!F&&Je&&!Je.updatingRootTiles){const at=Xf[ee],ut=n.findNeighborTile(at,St=>St.isLoaded||St.isLeaf||St.level===n.level);ut?ut.intersectsClippingArea&&(Re(!ut.isLoaded),Re(!ut.isLeaf),Re(ut.level===o)):Re(C(Je==null?void 0:Je.rootTiles)||!n.shouldHaveNeighbor(at))}}const W=ee===1?a[2]:a[0],ue=F==null?void 0:F.extent,pe=ue&&q?ee===1?ue[0]:ue[2]:W,we=ee===0?a[3]:a[1],Ce=ee===1?1:0,je=ee===0?1:0,De=ee===1?p:h,xe=ee===0?m:f,Ne=Math.sin(De),Ue=Math.cos(De),xt=Math.sin(xe),Qe=Math.cos(xe),Ut=J==null?void 0:J.samplerData,Xt=H?(Je,at,ut)=>.5*(Hi(Je,at,y)+Hi(ut,at,Ut)):(Je,at,ut)=>Hi(Je,at,y),er=i.outerEdges[ee],Yt=e&&N>3?N-3:1,mr=v(y)&&y.some(Je=>Je!=null),Jr=v(Ut)&&Ut.some(Je=>Je!=null),Sr=mr||Jr,xr=1/$,it=er.index0;U?(Re(!ue||Mh(ue[2]-ue[0],a[2]-a[0])),(()=>{const Je=ee===1?-1:ee===3?1:0,at=ee===0?-1:ee===2?1:0,ut=(a[2]-a[0])*xr,St=Je*ut,Ht=at*ut,Rr=q?Je*((p-h)*xr):0,Or=q?0:at*xr,Mr=je,Pr=q?De+Rr:De,Ci=q?Math.sin(Pr):Ne,sr=q?Math.cos(Pr):Ue,wr=q?De-Rr:De,gr=q?Math.sin(wr):Ne,xs=q?Math.cos(wr):Ue,ni=q?xe:S(Mr+Or),Wi=q?xt:Math.sin(ni),Ai=q?Qe:Math.cos(ni),ki=q?xe:S(Mr-Or),ds=q?xt:Math.sin(ki),Us=q?Qe:Math.cos(ki);let po=0,Gn=0,Ts=0;{const oi=0*xr,Uo=q?W:_*(1-oi)+b*oi,ll=q?pe:Uo,he=q?x*(1-oi)+T*oi:we,yi=q?De:h*(1-oi)+p*oi,ad=q?Ne:Math.sin(yi),ia=q?Ue:Math.cos(yi),qc=q?S(oi):xe,ht=q?Math.sin(qc):xt,Zl=q?Math.cos(qc):Qe,ss=l+Xt(Uo,he,ll);po=ia*Zl*ss,Gn=ad*Zl*ss,Ts=ht*ss}let Xi=0,Yi=0,Ss=0;{const oi=1*xr,Uo=q?W:_*(1-oi)+b*oi,ll=q?pe:Uo,he=q?x*(1-oi)+T*oi:we,yi=q?De:h*(1-oi)+p*oi,ad=q?Ne:Math.sin(yi),ia=q?Ue:Math.cos(yi),qc=q?S(oi):xe,ht=q?Math.sin(qc):xt,Zl=q?Math.cos(qc):Qe,ss=l+Xt(Uo,he,ll);Xi=ia*Zl*ss,Yi=ad*Zl*ss,Ss=ht*ss}for(let oi=1;oi<N-1;oi+=Yt){let Uo=0,ll=0,he=0;{const Vo=(oi+1)*xr,ju=q?W:_*(1-Vo)+b*Vo,Hu=q?pe:ju,ai=q?x*(1-Vo)+T*Vo:we,Lp=q?De:h*(1-Vo)+p*Vo,Lm=q?Ne:Math.sin(Lp),gx=q?Ue:Math.cos(Lp),Dv=q?S(Vo):xe,yx=q?Math.sin(Dv):xt,Nv=q?Math.cos(Dv):Qe,Dy=l+Xt(ju,ai,Hu);Uo=gx*Nv*Dy,ll=Lm*Nv*Dy,he=yx*Dy}const yi=Uo,ad=ll,ia=he,qc=Xi,ht=Yi,Zl=Ss;Xi=yi,Yi=ad,Ss=ia;{const Vo=it+oi,ju=Vo*K,Hu=qc-R,ai=ht-L,Lp=Zl-I;G[ju]=Hu,G[ju+1]=ai,G[ju+2]=Lp,il(Hu,ai,Lp,E);const Lm=oi*xr;Fc(re,Vo,q?Ce:Lm,q?Lm:je)}const ss=po,Lv=Gn,sU=Ts;po=qc,Gn=ht,Ts=Zl;const cl=qc,Iy=ht,Im=Zl,tr=1/Math.sqrt(cl*cl+Iy*Iy+Im*Im),yP=Im*tr;let $m=0,$y=0,Ly=0;if(Sr&&yP*yP<.999){let Vo=0,ju=0,Hu=0;{const ai=ee===0?-1:1;Vo=ai*(yi-ss),ju=ai*(ad-Lv),Hu=ai*(ia-sU)}{const ai=oi*xr,Lp=q?W:_*(1-ai)+b*ai,Lm=q?pe:Lp,gx=q?x*(1-ai)+T*ai:we,Dv=q?De:h*(1-ai)+p*ai,yx=q?Ne:Math.sin(Dv),Nv=q?Ue:Math.cos(Dv),Dy=q?S(ai):xe,ul=q?Math.sin(Dy):xt,_P=q?Math.cos(Dy):Qe;let yC=cl,Y=Iy,be=Im;if(H){const Oe=l+Hi(Lm-St,gx-Ht,Ut),dr=q?_P:Us;yC=(q?xs:Nv)*dr*Oe,Y=(q?gr:yx)*dr*Oe,be=(q?ul:ds)*Oe}{const Oe=l+Hi(Lp+St,gx+Ht,y),dr=q?_P:Ai,jn=(q?sr:Nv)*dr*Oe,Es=(q?Ci:yx)*dr*Oe,hl=(q?ul:Wi)*Oe;H||(yC=2*cl-jn,Y=2*Iy-Es,be=2*Im-hl);const Ny=ee===3?-1:1,WK=Ny*(yC-jn),XK=Ny*(Y-Es),YK=Ny*(be-hl);$m=Hu*XK-ju*YK,$y=Vo*YK-Hu*WK,Ly=ju*WK-Vo*XK;const nU=1/Math.sqrt($m*$m+$y*$y+Ly*Ly);$m*=nU,$y*=nU,Ly*=nU}}}else $m=cl*tr,$y=Iy*tr,Ly=Im*tr;er.setNormalFromValues(oi,$m,$y,Ly)}})()):(()=>{for(let Je=1;Je<N-1;Je+=Yt){const at=Je*xr,ut=q?Ce:at,St=q?at:je,Ht=q?W:_*(1-at)+b*at,Rr=q?x*(1-at)+T*at:we,Or=q?pe:Ht,Mr=q?De:h*(1-at)+p*at,Pr=q?Ne:Math.sin(Mr),Ci=q?Ue:Math.cos(Mr),sr=q?S(at):xe,wr=q?Math.sin(sr):xt,gr=q?Math.cos(sr):Qe,xs=Xt(Ht,Rr,Or),ni=l+xs,Wi=Ci*gr*ni-R,Ai=Pr*gr*ni-L,ki=wr*ni-I;il(Wi,Ai,ki,E);const ds=it+Je,Us=ds*K;G[Us]=Wi,G[Us+1]=Ai,G[Us+2]=ki,Fc(re,ds,ut,St)}})()}}function KCe(t){oAe(t)}function QCe(t,e){return Math.PI/2-2*Math.atan(Math.exp(-t/e))}function zyt(t,e,r,i){return QCe(t*(1-i)+e*i,r)}function Byt(t,e,r){return t*(1-r)+e*r}function $K(t){const e=t.tile;if(e.surface.isWebMercator){const i=e.extent,s=e.ellipsoid.radius;return n=>zyt(i[1],i[3],s,n)}const r=e.extentInRadians;return i=>Byt(r[1],r[3],i)}function Gyt(t,e){const r=t.tile.extent,i=t.geometryState,s=r[0],n=r[1],o=r[2]-s,a=r[3]-n,l=i.clippingArea,c=v(l)?Math.max(0,(l[0]-s)/o):0,h=v(l)?Math.max(0,(l[1]-n)/a):0,p=v(l)?Math.min(1,(l[2]-s)/o):1,f=v(l)?Math.min(1,(l[3]-n)/a):1,m=i.numVerticesPerSide,y=(m-2)**2,_=i.neighborData.edgeResolutions.reduce((S,E)=>S+E+1,0),b=DCe(y+_),x=t.geometryInfo,T=x.boundingBox;Mi(T),x.numVerticesPerSide=i.numVerticesPerSide,x.vertexAttributes=b,ti(x.uvRange,c,h,p,f),jyt(t),sAe(t,y),eAe(t),iAe(x,i.numVerticesPerSide,[],[0,m-1],[0,m-1],i.wireframe),t.intersectionData=null}function jyt(t){const e=t.tile;e.intersectsClippingArea&&(e.surface.shading?qyt(t):Hyt(t))}function Hyt(t){const e=t.geometryState,r=e.samplerData,i=t.tile,s=i.surface,n=t.localOrigin,o=s.isWebMercatorOnPlateeCarree,a=e.clippingArea,l=v(a)?a:K6,c=i.extent,h=c[0],p=c[1],f=c[2],m=c[3],y=Math.max(h,l[0]),_=Math.min(f,l[2]),b=Math.max(p,l[1]),x=Math.min(m,l[3]),T=n[0],S=n[1],E=n[2],O=i.ellipsoid.radius,R=i.horizontalScale,L=LK(o,O,R),I=e.numVerticesPerSide,U=I-1,z=I-2,B=t.geometryInfo,G=B.uvRange,K=G[0],re=G[1],ee=G[2],q=G[3],$=B.boundingBox,N=B.vertexAttributes,F=N.position,H=N.uv0;let X=0;for(let J=1;J<=z;J++){const W=J/U,ue=ye(p*(1-W)+m*W,b,x),pe=ye(W,re,q),we=L(ue)-S;for(let Ce=1;Ce<=z;Ce++){const je=Ce/U,De=ye(h*(1-je)+f*je,y,_),xe=ye(je,K,ee),Ne=De*R-T,Ue=Hi(De,ue,r)-E;il(Ne,we,Ue,$),F.setValues(X,Ne,we,Ue),Fc(H,X,xe,pe),++X}}}function qyt(t){const e=t.tile,r=e.surface;if(!(r.shading||Jw))return;const i=t.geometryState,s=i.samplerData,n=t.localOrigin,o=r.isWebMercatorOnPlateeCarree,a=i.clippingArea,l=v(a)?a:K6,c=e.extent,h=c[0],p=c[1],f=c[2],m=c[3],y=Math.max(h,l[0]),_=Math.min(f,l[2]),b=Math.max(p,l[1]),x=Math.min(m,l[3]),T=e.ellipsoid.radius,S=e.horizontalScale,E=i.numVerticesPerSide,O=E-1,R=E-2,L=t.geometryInfo,I=L.vertexAttributes,U=I.position,z=I.uv0,B=I.normalCompressed,G=L.uvRange,K=G[0],re=G[1],ee=G[2],q=G[3],$=L.boundingBox,N=n[0],F=n[1],H=n[2],X=U.typedBuffer,J=U.typedBufferStride;let W=0;const ue=ye(p,b,x),pe=o?(Math.PI/2-2*Math.atan(Math.exp(-ue/T)))*T:ue*S,we=1/O,Ce=ye(p*(1-we)+m*we,b,x);let je=pe,De=o?(Math.PI/2-2*Math.atan(Math.exp(-Ce/T)))*T:Ce*S;for(let xe=1;xe<=R;xe++){const Ne=xe/O,Ue=ye(p*(1-Ne)+m*Ne,b,x),xt=ye(Ne,re,q),Qe=De,Ut=(xe-1)/O,Xt=ye(p*(1-Ut)+m*Ut,b,x),er=je,Yt=(xe+1)/O,mr=ye(p*(1-Yt)+m*Yt,b,x),Jr=o?(Math.PI/2-2*Math.atan(Math.exp(-mr/T)))*T:mr*S,Sr=ye(Yt,re,q);je=De,De=Jr;const xr=ye(h,y,_);let it=xr*S,Je=Hi(xr,Ue,s);const at=1/O,ut=ye(at,K,ee),St=ye(h*(1-ut)+f*ut,y,_);let Ht=ut,Rr=St,Or=St*S,Mr=Hi(St,Ue,s);if(xe===1){const Pr=Or-N,Ci=je-F,sr=Mr-H,wr=0*J;X[wr]=Pr,X[wr+1]=Ci,X[wr+2]=sr,il(Pr,Ci,sr,$);const gr=ye(at,K,ee);Fc(z,W,gr,xt)}for(let Pr=1;Pr<=R;Pr++){const Ci=Or,sr=Mr,wr=(Pr+1)/O,gr=ye(wr,K,ee),xs=ye(h*(1-wr)+f*wr,y,_),ni=Rr;Rr=xs;{const Ts=W+1,Xi=Ts*J;if(xe===1||Pr===R){const Yi=xs*S,Ss=Hi(xs,Ue,s);if(xe===1&&Pr<R){const oi=Yi-N,Uo=Qe-F,ll=Ss-H;X[Xi]=oi,X[Xi+1]=Uo,X[Xi+2]=ll,il(oi,Uo,ll,$),Fc(z,Ts,gr,xt)}Or=Yi,Mr=Ss}else Or=X[Xi]+N,Mr=X[Xi+2]+H}const Wi=Or,Ai=Mr,ki=it,ds=Je;it=Ci,Je=sr;const Us=(W-R)*J,po=xe===1?Hi(ni,Xt,s):X[Us+2]+H,Gn=Hi(ni,mr,s);if(xe<R){const Ts=W+R,Xi=Ts*J,Yi=Ci-N,Ss=Jr-F,oi=Gn-H;X[Xi]=Yi,X[Xi+1]=Ss,X[Xi+2]=oi,il(Yi,Ss,oi,$);const Uo=Ht;Ht=gr,Fc(z,Ts,Uo,Sr)}{const Ts=Wi-ki,Xi=er-Jr,Yi=Xi*(Ai-ds),Ss=Ts*(po-Gn),oi=-Xi*Ts,Uo=Yi*Yi+Ss*Ss+oi*oi;if(Uo===0)nM(B,W,0,0,1);else{const ll=1/Math.sqrt(Uo);nM(B,W,Yi*ll,Ss*ll,oi*ll)}}++W}}}function Wyt(t,e){t.tile.intersectsClippingArea&&(rAe(t),tAe(t,!0),J6(t))}function Xyt(t,e){t.tile.intersectsClippingArea&&(eAe(t),J6(t))}function eAe(t,e){t.tile.intersectsClippingArea&&(rAe(t),tAe(t,!1))}function tAe(t,e){const r=t.geometryState,i=r.neighborData,s=t.tile,n=s.surface,o=n.shading||Jw,a=s.extent,l=r.clippingArea,c=v(l)?l:K6,h=a[0],p=a[2],f=a[1],m=a[3],y=[m>c[3],p>c[2],f<c[1],h<c[0]],_=t.geometryInfo,b=s.horizontalScale,x=LK(n.isWebMercatorOnPlateeCarree,s.ellipsoid.radius,b),T=_.boundingBox,S=_.uvRange[0],E=_.uvRange[1],O=_.uvRange[2],R=_.uvRange[3],L=Math.max(h,c[0]),I=Math.min(p,c[2]),U=Math.max(f,c[1]),z=Math.min(m,c[3]),B=t.localOrigin,G=B[0],K=B[1],re=B[2],ee=r.samplerData;for(let q=0;q<4;++q){const $=q===1||q===3,N=i.edgeResolutions[q];Re(vp(N));const F=N+1,H=y[q],X=Ub(s,i.edgePeerNeighbors[q]);if(!H&&aAe(s,X,q)){nAe(t,q,X);continue}const J=v(X)&&!H,W=X==null?void 0:X.renderData,ue=W==null?void 0:W.geometryState;if(En&&(Re(!J||X.level===s.level),Re(!J||ey(s,X)<=0),s&&!X&&!n.updatingRootTiles)){const xt=Xf[q],Qe=s.findNeighborTile(xt,Ut=>Ut.isLoaded||Ut.isLeaf||Ut.level===s.level);n.updatingRootTiles||(Qe?Qe.intersectsClippingArea&&(Re(!Qe.isLoaded),Re(!Qe.isLeaf),Re(Qe.level===s.level)):Re(C(n==null?void 0:n.rootTiles)||!s.shouldHaveNeighbor(xt)))}const pe=ye(q===1?p:h,L,I),we=ye(q===0?m:f,U,z),Ce=ue==null?void 0:ue.samplerData,je=_.outerEdges[q],De=e&&F>3?F-3:1,xe=ye(q===1?1:0,S,O),Ne=ye(q===0?1:0,E,R),Ue=J?(xt,Qe)=>.5*(Hi(xt,Qe,Ce)+Hi(xt,Qe,ee)):(xt,Qe)=>Hi(xt,Qe,ee);if(o){const xt=(p-h)/N,Qe=$?q===1?xt:-xt:0,Ut=$?0:q===0?xt:-xt,Xt=-Qe,er=-Ut;let Yt=0,mr=0,Jr=0;{const Je=0/N,at=$?pe:ye(h*(1-Je)+p*Je,L,I),ut=$?ye(f*(1-Je)+m*Je,U,z):we,St=Ue(at,ut);Yt=at*b,mr=x(ut),Jr=St}let Sr=0,xr=0,it=0;{const Je=1/N,at=$?pe:ye(h*(1-Je)+p*Je,L,I),ut=$?ye(f*(1-Je)+m*Je,U,z):we,St=Ue(at,ut);Sr=at*b,xr=x(ut),it=St}for(let Je=1;Je<F-1;Je+=De){const at=Je/N,ut=Sr,St=xr,Ht=it;{const ni=$?xe:ye(at,S,O),Wi=$?ye(at,E,R):Ne,Ai=ut-G,ki=St-K,ds=Ht-re;il(ut,ki,ds,T),je.setVertexFromValuesRawPositionUV(Je,Ai,ki,ds,ni,Wi)}{const ni=(Je+1)/N,Wi=$?pe:ye(h*(1-ni)+p*ni,L,I),Ai=$?ye(f*(1-ni)+m*ni,U,z):we,ki=Ue(Wi,Ai);Sr=Wi*b,xr=x(Ai),it=ki}const Rr=Sr,Or=it,Mr=Yt,Pr=mr,Ci=Jr;Yt=ut,mr=St,Jr=Ht;let sr=0,wr=0,gr=0;if($){const ni=xr-St,Wi=Or-Ht,Ai=Pr-St,ki=Ci-Ht,ds=ye(f*(1-at)+m*at,U,z),Us=pe+Xt,po=Us*b-ut,Gn=Hi(Us,ds,ee)-Ht,Ts=q===3?-1:1;if(sr=Ts*(-Ai+ni)*Gn,wr=Ts*po*(-ki+Wi),gr=-Ts*po*(-Ai+ni),J){const Xi=pe+Qe,Yi=Xi*b-ut;sr=(-Ai+ni)*(Gn-(Hi(Xi,ds,Ce)-Ht)),wr=(po-Yi)*(-ki+Wi),gr=-(po-Yi)*(-Ai+ni)}}else{const ni=Rr-ut,Wi=Or-Ht,Ai=Mr-ut,ki=Ci-Ht,ds=ye(h*(1-at)+p*at,L,I),Us=we+er,po=Hi(ds,Us,ee)-Ht,Gn=x(Us)-St,Ts=q===2?-1:1;if(sr=Ts*Gn*(-ki+Wi),wr=Ts*(-Ai+ni)*po,gr=-Ts*Gn*(-Ai+ni),J){const Xi=ds,Yi=we+Ut,Ss=x(Yi)-St;sr=(-Gn+Ss)*(-ki+Wi),wr=(-Ai+ni)*(-po+(Hi(Xi,Yi,Ce)-Ht)),gr=-(-Gn+Ss)*(-Ai+ni)}}const xs=1/Math.sqrt(sr*sr+wr*wr+gr*gr);je.setNormalFromValues(Je,sr*xs,wr*xs,gr*xs)}}else for(let xt=1;xt<F-1;xt+=De){const Qe=xt/N,Ut=$?pe:ye(h*(1-Qe)+p*Qe,L,I),Xt=$?ye(f*(1-Qe)+m*Qe,U,z):we,er=$?xe:ye(Qe,S,O),Yt=$?ye(Qe,E,R):Ne,mr=Ue(Ut,Xt),Jr=Ut*b-G,Sr=x(Xt)-K,xr=mr-re;il(Jr,Sr,xr,T),je.setVertexFromValuesRawPositionUV(xt,Jr,Sr,xr,er,Yt)}}}function rAe(t,e){oAe(t)}function Yyt(t,e){return(Math.PI/2-2*Math.atan(Math.exp(-t/e)))*e}function Zyt(t,e){return t*e}function LK(t,e,r){return t?i=>Yyt(i,e):i=>Zyt(i,r)}function iAe(t,e,r,i,s,n){const o=e-1,a=t.vertexAttributes.count,l=2*(Math.min(e-2,i[1])-Math.max(1,i[0]))*(Math.min(e-2,s[1])-Math.max(1,s[0])),c=Xf.map((S,E)=>E===0&&s[1]<e-2||E===1&&i[1]<e-2||E===2&&s[0]>1||E===3&&i[0]>1),h=t.outerEdges.reduce((S,E,O)=>S+(c[O]?0:o-2+E.count-1),0),p=r.reduce((S,E)=>S+o*(2*(E.latitudeResolution-1)+1),0),f=n?2:1,m=3*(l+h+p)*f,y=a>=Lyt?new Uint32Array(m):new Uint16Array(m);let _=0;const b=e-2,x=o-2;Re(x>=0);const T=(S,E,O,R,L,I)=>{const U=S*L,z=I[U],B=I[U+1],G=I[U+2],K=E*L,re=I[K],ee=I[K+1],q=I[K+2],$=O*L,N=I[$],F=I[$+1],H=I[$+2],X=R*L,J=I[X],W=I[X+1],ue=I[X+2];return(re-J)*(re-J)+(ee-W)*(ee-W)+(q-ue)*(q-ue)>(z-N)*(z-N)+(B-F)*(B-F)+(G-H)*(G-H)};if(n){const S=(O,R,L)=>{y[_++]=O,y[_++]=R,y[_++]=R,y[_++]=L,y[_++]=L,y[_++]=O,En&&(Re(O<a),Re(R<a),Re(L<a),Re(_<=m))};(()=>{for(let O=Math.max(s[0],1)-1;O<Math.min(s[1],e-2)-1;++O){const R=O*b;for(let L=Math.max(i[0],1)-1;L<Math.min(i[1],e-2)-1;++L){const I=O*b+L,U=I+1,z=U+b,B=z-1,G=R+L,K=G+1,re=K+b,ee=re-1,q=t.vertexAttributes.position.typedBuffer,$=t.vertexAttributes.position.typedBufferStride;T(G,K,re,ee,$,q)?(S(I,U,z),S(z,B,I)):(S(I,U,B),S(B,z,U))}}})(),Re(_===3*l*f),(()=>{for(let O=0;O<4;++O){const R=_;if(c[O])continue;const L=t.outerEdges[O],I=t.innerEdges[O];let U=0,z=0;const B=L.count,G=I.count;Re(G===o-1);let K=0;const re=O===1||O===2?(ee,q,$)=>S(ee,q,$):(ee,q,$)=>S(ee,$,q);for(;U<B-1||z<G-1;){const ee=I.getVertexIndex(z),q=L.getVertexIndex(U),$=U<B-1,N=z<G-1;$&&(!N||($?0+o*(U+.5)/(B-1):0)<=(N?1+x*(z+.5)/(G-1):0))?(++U,En&&Re(U<B),re(ee,q,L.getVertexIndex(U)),K++):(++z,En&&Re(z<G),re(ee,q,I.getVertexIndex(z)),K++)}En&&(Re(U===B-1),Re(z===G-1),Re(K===B+G-2),Re(K===o-2+L.count-1),Re(_===R+3*K*f))}})(),Re(_===3*(l+h)*f);const E=O=>{const R=t.outerEdges[O.connectedOuterEdgeOffset];let L=R.getVertexIndex(0),I=R.stride;for(let U=0;U<O.latitudeResolution;++U){const z=U===0?O.rowOffset:L+e;for(let B=0;B<o;B++)S(L,L+1,z+B),U<O.latitudeResolution-1&&S(L+1,z+B+1,z+B),L+=I;L=z,I=1}};r.forEach(E)}else{(()=>{const E=Math.max(s[0],1)-1,O=Math.min(s[1],e-2)-1,R=Math.max(i[0],1)-1,L=Math.min(i[1],e-2)-1;for(let I=E;I<O;++I){const U=I*b;for(let z=R;z<L;++z){const B=U+z,G=B+1,K=G+b,re=K-1,ee=t.vertexAttributes.position.typedBuffer,q=t.vertexAttributes.position.typedBufferStride;T(B,G,K,re,q,ee)?(y[_]=B,y[_+1]=G,y[_+2]=K,y[_+3]=K,y[_+4]=re,y[_+5]=B):(y[_]=B,y[_+1]=G,y[_+2]=re,y[_+3]=re,y[_+4]=G,y[_+5]=K),_+=6}}})(),Re(_===3*l*f),(()=>{for(let E=0;E<4;++E){if(c[E])continue;const O=t.outerEdges[E],R=t.innerEdges[E];let L=0,I=0;const U=O.count,z=R.count;Re(z===o-1);const B=E===1||E===2,G=B?1:2,K=B?2:1,re=O.index0,ee=O.stride,q=R.index0,$=R.stride;for(;L<U-1||I<z-1;){const N=q+I*$,F=re+L*ee,H=L<U-1,X=I<z-1,J=H&&(!X||(H?0+o*(L+.5)/(U-1):0)<=(X?1+x*(I+.5)/(z-1):0));J?++L:++I;const W=J?F+ee:N+$;y[_]=N,y[_+G]=F,y[_+K]=W,_+=3}}})(),Re(_===3*(l+h)*f);const S=E=>{const O=t.outerEdges[E.connectedOuterEdgeOffset];let R=O.getVertexIndex(0),L=O.stride;for(let I=0;I<E.latitudeResolution;++I){const U=I===0?E.rowOffset:R+e;for(let z=0;z<o;z++){const B=U+z;y[_]=R,y[_+1]=R+1,y[_+2]=B,I<E.latitudeResolution-1?(y[_+3]=R+1,y[_+4]=B+1,y[_+5]=B,_+=6):_+=3,R+=L}R=U,L=1}};r.forEach(S)}Re(_===m),t.indices=y,t.indexCount=m}function sAe(t,e){const r=t.localOrigin,i=t.geometryInfo,s=t.geometryState.neighborData.edgeResolutions,n=i.numVerticesPerSide-2,o=i.vertexAttributes;let a=e;for(let l=0;l<4;++l){{const c=l===0||l===2,h=(l===0?n-1:0)*n+(l===1?n-1:0),p=(c?0:1)*n+(c?1:0);i.innerEdges[l]=new ace(o,r,h,p,n)}{const c=a,h=s[l]+1;i.outerEdges[l]=new ace(o,r,c,1,h),a+=h}}}function nAe(t,e,r){const i=(e+2)%4,s=t.geometryState,n=t.tile,o=s.neighborData,a=n.level-r.level,l=e===1||e===3,c=o.edgeResolutions[e];Re(vp(c));const h=c+1,p=t.geometryInfo,f=p.boundingBox,m=p.outerEdges[e],y=p.uvRange[0],_=p.uvRange[1],b=p.uvRange[2],x=p.uvRange[3],T=ye(e===1?1:0,y,b),S=ye(e===0?1:0,_,x),E=r.renderData,O=E.geometryState,R=E.geometryInfo.outerEdges[i],L=n.getNeighborEdgeStartVertexIndex(e,r)*c,I=c*2**a;Re(O.neighborData.edgeResolutions[i]===I),Re(R.count-1===I);const U=E.localOrigin[0]-t.localOrigin[0],z=E.localOrigin[1]-t.localOrigin[1],B=E.localOrigin[2]-t.localOrigin[2],G=m.attributes,K=m.index0,re=m.stride,ee=G.position.typedBuffer,q=G.position.typedBufferStride,$=G.normalCompressed.typedBuffer,N=G.normalCompressed.typedBufferStride,F=G.uv0,H=R.attributes,X=R.index0,J=R.stride,W=H.position.typedBuffer,ue=H.position.typedBufferStride,pe=H.normalCompressed.typedBuffer,we=H.normalCompressed.typedBufferStride;for(let Ce=1;Ce<h-1;++Ce){const je=K+re*Ce,De=X+J*(L+Ce),xe=je*q,Ne=De*ue,Ue=W[Ne]+U,xt=W[Ne+1]+z,Qe=W[Ne+2]+B;ee[xe]=Ue,ee[xe+1]=xt,ee[xe+2]=Qe,il(Ue,xt,Qe,f);const Ut=je*N,Xt=De*we;$[Ut]=pe[Xt],$[Ut+1]=pe[Xt+1];const er=Ce/c,Yt=l?T:ye(er,y,b),mr=l?ye(er,_,x):S;Fc(F,je,Yt,mr)}}function oAe(t){var Ne;const e=t.geometryState,r=e.neighborData,i=t.localOrigin,s=r.cornerNeighborData,n=t.geometryInfo,o=n.outerEdges,a=n.boundingBox,l=t.tile,c=((Ne=t.tile.surface.view)==null?void 0:Ne.viewingMode)==="local",h=l.ellipsoid.radius,p=l.extentInRadians,f=l.horizontalScale;let m=0,y=0,_=0;const b=(Ue,xt,Qe)=>{const Ut=p[xt===0?1:3],Xt=p[Ue===0?0:2],er=Math.cos(Ut),Yt=Math.sin(Ut),mr=Math.sin(Xt),Jr=Math.cos(Xt),Sr=h+Qe;m=Jr*er*Sr,y=mr*er*Sr,_=Yt*Sr},x=c?(()=>{const Ue=t.geometryState.clippingArea,xt=l.extent,Qe=v(Ue)&&(xt[3]>Ue[3]||xt[2]>Ue[2]||xt[1]<Ue[1]||xt[0]<Ue[0]),Ut=LK(l.surface.isWebMercatorOnPlateeCarree,l.ellipsoid.radius,f);return(Xt,er,Yt)=>{const mr=Xt===0?K[0]:K[2],Jr=er===0?K[1]:K[3],Sr=Qe?ye(mr,Ue[0],Ue[2]):mr,xr=Qe?ye(Jr,Ue[1],Ue[3]):Jr,it=Yt;m=Sr*f,y=Ut(xr),_=it}})():b;let T=0,S=0,E=0,O=0,R=0,L=0,I=0,U=0,z=0;const B=c&&t.tile.surface.isWebMercatorOnPlateeCarree,G=(Ue,xt,Qe,Ut,Xt)=>{let er=0,Yt=0,mr=0;if(c){const Jr=xt*f,Sr=B?(Math.PI/2-2*Math.atan(Math.exp(-Qe/h)))*h:Qe*f;er=Jr-m,Yt=Sr-y,mr=Ut-_}else{const Jr=$K(Ue),Sr=Ue.tile,xr=Sr.extent,it=Sr.extentInRadians,Je=(xt-xr[0])/(xr[2]-xr[0]),at=(Qe-xr[1])/(xr[3]-xr[1]),ut=it[0]*(1-Je)+it[2]*Je,St=Jr(at),Ht=Math.cos(St),Rr=Math.sin(St),Or=Math.sin(ut),Mr=Math.cos(ut),Pr=h+Ut;er=Mr*Ht*Pr-m,Yt=Or*Ht*Pr-y,mr=Rr*Pr-_}switch(Xt){case 0:I+=er,U+=Yt,z+=mr;break;case 1:O-=er,R-=Yt,L-=mr;break;case 2:I-=er,U-=Yt,z-=mr;break;case 3:O+=er,R+=Yt,L+=mr}},K=l.extent,re=e.clippingArea,ee=v(re)?re:K6,q=K[0],$=K[2],N=K[1],F=K[3],H=[F>ee[3],$>ee[2],N<ee[1],q<ee[0]],X=Math.max(q,ee[0]),J=Math.min($,ee[2]),W=Math.max(N,ee[1]),ue=Math.min(F,ee[3]),pe=n.uvRange[0],we=n.uvRange[1],Ce=n.uvRange[2],je=n.uvRange[3],De=l.surface.shading||Jw,xe=Ue=>{var xr;const xt=s[Ue].cornerTiles;T=0,S=0,E=1;let Qe=1/0;for(let it=0;it<4;++it)Qe=Math.min(Qe,((xr=xt[it])==null?void 0:xr.level)??1/0);for(let it=0;it<4;++it){const Je=xt[it];bA[it]=(Je==null?void 0:Je.level)===Qe?Je:null}let Ut=1,Xt=0;for(let it=0;it<4;++it){const Je=bA[it];Je&&(Ut=Math.max(Ut,Je==null?void 0:Je.renderData.geometryState.numVerticesPerSide),Xt=Je.extent[2]-Je.extent[0])}const er=Xt,Yt=Ut;Re(Yt>1);const mr=er/Yt;for(let it=0;it<4;++it){const Je=bA[(it+3)%4],at=bA[it%4];if(!Je&&!at)continue;const ut=it===0?1:it===1?2:it===2?3:0,St=it===0?2:it===1?3:it===2?0:1;if(Je&&at){const Ht=zV[it][0]*mr,Rr=zV[it][1]*mr,Or=Je.extent,Mr=Or[ut===0||ut===1?2:0]+Ht,Pr=Or[ut===0||ut===3?3:1]+Rr,Ci=at.extent,sr=Ci[St===0||St===1?2:0]+Ht,wr=Ci[St===0||St===3?3:1]+Rr,gr=Je.renderData,xs=at.renderData,ni=Hi(Mr,Pr,gr.geometryState.samplerData),Wi=Hi(sr,wr,xs.geometryState.samplerData);G(gr,Mr,Pr,.5*(ni+Wi),it)}else{const Ht=Je??at,Rr=Je?ut:St,Or=Ht.extent,Mr=zV[it],Pr=Or[Rr===0||Rr===1?2:0]+Mr[0]*mr,Ci=Or[Rr===0||Rr===3?3:1]+Mr[1]*mr,sr=Ht.renderData,wr=Hi(Pr,Ci,sr.geometryState.samplerData);G(sr,Pr,Ci,wr,it)}}if(!c){const it=Math.sqrt(m*m+y*y+_*_);T=m/it,S=y/it,E=_/it}const Jr=Math.sqrt(O*O+R*R+L*L);O/=Jr,R/=Jr,L/=Jr;const Sr=Math.sqrt(I*I+U*U+z*z);if(I/=Sr,U/=Sr,z/=Sr,c||E*E<.999){T=L*U-R*z,S=O*z-L*I,E=R*I-O*U;const it=1/Math.sqrt(T*T+S*S+E*E);T*=it,S*=it,E*=it}};for(let Ue=0;Ue<4;++Ue){const xt=Ue,Qe=(Ue+1)%4,Ut=Ue===0||Ue===1?1:0,Xt=Ue===0||Ue===3?1:0,er=ye(Ut,pe,Ce),Yt=ye(Xt,we,je),mr=o[xt],Jr=Ue===0||Ue===3?mr.count-1:0,Sr=o[Qe],xr=Ue===0||Ue===1?Sr.count-1:0,it=s[Ue].cornerTiles;let Je=-1;for(let St=0;St<4;++St){const Ht=it[St];Ht&&(Je===-1||ey(it[Je],Ht)>0)&&(Je=St)}const at=Je,ut=it[at];if(T=0,S=0,E=1,ut!==l){const St=l.level-ut.level,Ht=2**St,Rr=[ut.lij[0]+St,ut.lij[1]*Ht,ut.lij[2]*Ht],Or=[Rr[1]+Ht===l.lij[1],Ue===0&&(at===1||at===0&&ut!==it[3])||Ue===1&&(at===0||at===1&&ut!==it[2]),Rr[1]===l.lij[1]+1,Ue===2&&(at===3||at===2&&ut!==it[1])||Ue===3&&(at===2||at===3&&ut!==it[0])],Mr=Or.reduce((gr,xs)=>gr+(xs?1:0),0);Re(Mr===1||Mr===2);let Pr=-1,Ci=-1;const sr=ut.renderData;if(Mr===1){const gr=Or.findIndex(ni=>ni);Re(0<=gr&&gr<=3),Pr=(gr+2)%4;const xs=t.geometryState.neighborData.edgeResolutions[gr];Ci=l.getNeighborEdgeStartVertexIndex(gr,ut)*xs+xs*(gr===0&&Ue===0||gr===1&&Ue===0||gr===2&&Ue===1||gr===3&&Ue===3?1:0)}else{Re(Or[1]||Or[3]),Pr=Or[1]?3:1;const gr=sr.geometryState.neighborData.edgeResolutions[Pr];Ci=Ue===0||Ue===3?0:gr}const wr=sr.geometryInfo.outerEdges[Pr];{const gr=mr.index0+Jr*mr.stride,xs=Sr.index0+xr*Sr.stride,ni=wr.index0+Ci*wr.stride;{const Wi=wr.attributes.position,Ai=Wi.typedBuffer,ki=ni*Wi.typedBufferStride,ds=t.localOrigin,Us=wr.localOrigin,po=Ai[ki]+Us[0]-ds[0],Gn=Ai[ki+1]+Us[1]-ds[1],Ts=Ai[ki+2]+Us[2]-ds[2];il(po,Gn,Ts,a);{const Xi=mr.attributes.position,Yi=Xi.typedBuffer,Ss=gr*Xi.typedBufferStride;Yi[Ss]=po,Yi[Ss+1]=Gn,Yi[Ss+2]=Ts}{const Xi=Sr.attributes.position,Yi=Xi.typedBuffer,Ss=xs*Xi.typedBufferStride;Yi[Ss]=po,Yi[Ss+1]=Gn,Yi[Ss+2]=Ts}}Fc(mr.attributes.uv0,gr,er,Yt),Fc(Sr.attributes.uv0,xs,er,Yt);{const Wi=wr.attributes.normalCompressed.typedBuffer,Ai=ni*wr.attributes.normalCompressed.typedBufferStride;{const ki=mr.attributes.normalCompressed,ds=ki.typedBuffer,Us=gr*ki.typedBufferStride;ds[Us]=Wi[Ai],ds[Us+1]=Wi[Ai+1]}{const ki=Sr.attributes.normalCompressed,ds=ki.typedBuffer,Us=xs*ki.typedBufferStride;ds[Us]=Wi[Ai],ds[Us+1]=Wi[Ai+1]}}}}else{const St=H[xt],Ht=H[Qe];let Rr;if(St||Ht){const Ci=ye(q*(1-Ut)+$*Ut,X,J),sr=ye(N*(1-Xt)+F*Xt,W,ue),wr=e.samplerData;Rr=Hi(Ci,sr,wr)}else Rr=Jyt(it);x(Ut,Xt,Rr),(De||Jw)&&xe(Ue);const Or=m-i[0],Mr=y-i[1],Pr=_-i[2];il(Or,Mr,Pr,a),mr.setVertexFromValuesRawPositionUVNormal(Jr,Or,Mr,Pr,er,Yt,T,S,E),Sr.setVertexFromValuesRawPositionUVNormal(xr,Or,Mr,Pr,er,Yt,T,S,E)}}for(let Ue=0;Ue<4;++Ue)bA[Ue]=null}function Jyt(t){var n,o;const e=t.reduce((a,l)=>Math.min(a,(l==null?void 0:l.level)??1/0),1/0);En&&(Re(!t[0]||!t[2]||Sq(t[0],t[2],Rt.SOUTH_WEST)),Re(!t[1]||!t[3]||Sq(t[1],t[3],Rt.NORTH_WEST)));let r=0,i=0;for(let a=0;a<4;++a){const l=t[a];if(l&&l.level===e){const c=a===0||a===1,h=a===0||a===3,p=l.extent,f=p[c?0:2],m=p[h?1:3],y=(o=(n=l.renderData)==null?void 0:n.geometryState)==null?void 0:o.samplerData;i+=Hi(f,m,y),r++}}const s=r?i/r:0;return Re(s!=null),s}function J6(t){const e=t.vao,r=t.geometryInfo.vertexAttributes.position.typedBuffer;e.vertexBuffers.geometry.setSubData(r,0,0,r.length)}const zV=[[0,1],[1,0],[0,-1],[-1,0]],on=new $gt,K6=fX(-1/0,-1/0,1/0,1/0),bA=[null,null,null,null];function aAe(t,e,r){if(!e)return!1;const i=ey(t,e);return i>0||i===0&&r>=2}const Jw=!0;let Kyt=class extends OK{get horizontalScale(){return this._horizontalScaleFactor}constructor(e,r,i){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=hr(),e!==void 0&&this.init(e,r,i)}init(e,r,i){super.init(e,r,i);const s=i.view.renderSpatialReference,n=i.spatialReference,o=v(s)&&$W(s)&&v(n)&&n.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const a=this.surface.isWebMercatorOnPlateeCarree,l=this._extentInRenderSR,c=this.extent;if(a){const h=$e(c[0],c[1],0);uo(h,We.WebMercator,h,We.PlateCarree);const p=$e(c[2],c[3],0);uo(p,We.WebMercator,p,We.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=p[0],l[3]=p[1]}else for(let h=0;h<4;++h)l[h]=c[h]*o;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,r=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),s=Math.sqrt(r*r+i*i),n=.5*(this.elevationBounds[0]-this.elevationBounds[1]),o=Math.max(s,n);this._center[rn.MIDDLE][3]=o}_calculateFrustumVisibilityStatus(e){const r=this._aabb(),i=r[0],s=r[1],n=r[2],o=r[3],a=r[4],l=r[5];let c=!0;for(let h=0;h<6;h++){const p=e[h],f=p[0],m=p[1],y=p[2],_=p[3];if(f*(f>0?i:o)+m*(m>0?s:a)+y*(y>0?n:l)+_>=0)return pa.OUTSIDE;c=c&&f*(f<0?i:o)+m*(m<0?s:a)+y*(y<0?n:l)+_<=0}return c?pa.INSIDE:pa.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return F4e(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,r,i,s){return X$[0]=1/r[0],X$[1]=1/r[1],X$[2]=1/r[2],MJ(this._aabb(),e,X$,i,s)}createGeometry(){Gyt(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){Wyt(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){Xyt(this.renderData,this._horizontalScaleFactor)}};const X$=M();let Qyt=class{constructor(){this.extent=nr(),this.minLevel=0,this.maxLevel=0,this.callback=null}},uN=class extends Te{constructor(){super(...arguments),this._queries=new Kt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Kt({initialSize:30}),this._queryPool=new Po(Qyt)}queryVisibleLevelRange(e,r,i,s){const n=this._queryPool.acquire();rp(n.extent,e),n.minLevel=r??-Number.MAX_VALUE,n.maxLevel=i??Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const r=this._queries.data[e];this._queryPool.release(r),r.callback(e>=this._queriesInvPtr),r.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const r=e.level;let i=0;for(;i<this._queriesInvPtr;){const s=this._queries.data[i],n=s.extent;r>=s.minLevel&&r<=s.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};u([d()],uN.prototype,"updating",null),uN=u([P("esri.views.3d.terrain.ScaleRangeQueries")],uN);let e0t=class extends OK{get convexHull(){return this._convexHull}constructor(e,r,i){super(),this._convexHull=new Array(24),this._boundingSphere=cn(),e!==void 0&&this.init(e,r,i)}init(e,r,i){super.init(e,r,i);const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=e[0],h=Ft(o,l,.5),p=Ft(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),JDe(this.centerAtSeaLevel,p,h,this.ellipsoid.radius);const m=Ul(this.centerAtSeaLevel);ve(m,m),this.up=m,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)ce(e[rn.MIDDLE],0,0,0),ce(e[rn.TOP],0,0,0),ce(e[rn.BOTTOM],0,0,0),e[rn.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const r=e[rn.MIDDLE],i=this.convexHull;let s=0;for(let n=0;n<8;++n)s=Math.max(s,t0t(r,i,3*n));e[rn.MIDDLE][3]=Math.sqrt(s)}}_calculateFrustumVisibilityStatus(e){if(!I_(e,this._boundingSphere))return pa.OUTSIDE;if(this.lij[0]<10)return pa.INTERSECTS;const r=this.convexHull,i=this.surface.view.state.camera.near;let s=!0;for(let n=0;n<ov.NUM;n++){const o=n===bi.NEAR,a=e[n],l=a[0],c=a[1],h=a[2],p=a[3]-(o?i:0);let f=!1;for(let m=0;m<8;++m){const y=3*m;if(l*r[y+0]+c*r[y+1]+h*r[y+2]+p<0){if(f=!0,!s)break}else s=!1}if(!f)return pa.OUTSIDE}return s?pa.INSIDE:pa.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){Dyt(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),En&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,r=e,i=this.elevationBounds,s=this.ellipsoid.radius,n=i[1];if(this.level===0)ce(r,0,0,0),e[3]=s+n;else{const o=this.extentInRadians,a=.5*(o[0]+o[2]),l=o[1],c=o[3];_1(Tce,a,l,s),_1(Sce,a,c,s),me(r,Tce,Sce);const h=.5*(i[0]+i[1]);ae(r,r,(s+h)/yc(r));const p=this.convexHull;let f=0;const m=(_,b)=>{const x=_[0]-p[3*b+0],T=_[1]-p[3*b+1],S=_[2]-p[3*b+2];return Math.sqrt(x*x+T*T+S*S)};for(let _=0;_<8;++_){const b=m(r,_);f=Math.max(f,b)}const y=f;e[3]=y+2}}_updateConvexHull(){const e=this.extentInRadians,r=this.ellipsoid.radius;if(this.level===0)return;const i=this.elevationBounds,s=this._getPatchType(),n=this.surface.isWebMercator,o=n&&s===Oh.HAS_NORTH_POLE,a=n&&s===Oh.HAS_SOUTH_POLE,l=a||o,c=Math.PI/2,h=e[0],p=e[2],f=a?-c:e[1],m=o?c:e[3],y=.5*(h+p),_=i[0],b=r+(l?Math.min(0,_-1):_),x=(q,$,N)=>_1(q,$,N,b),T=M(),S=M(),E=M(),O=M();x(T,h,f),x(S,h,m),x(E,p,m),x(O,p,f);const R=(q,$)=>{for(let N=0;N<3;++N)this._convexHull[3*$+N]=q[N]};R(T,0),R(S,1),R(E,2),R(O,3);const L=i[1],I=r+(l?Math.max(0,L+1):L),U=M(),z=M(),B=M();_1(z,y,m,b),_1(B,y,f,b),me(U,z,B),ve(U,U);const G=M(),K=M(),re=(q,$)=>{so(K,q,$),ve(K,K);const N=-_e(q,G)/_e(K,G);Re(N>=0),ae(K,K,N),me(q,q,K)};if(2**this.lij[0]>2*this.lij[1]){const q=B,$=M();pt($,xce,q),ve($,$),pt(G,q,$),ve(G,G),Re(Mh(_e(G,q)/yc(q),0)),re(T,S),re(O,E),R(T,0),R(O,3)}else if(2**this.lij[0]!==2*this.lij[1]){const q=z,$=M();pt($,xce,q),ve($,$),pt(G,$,q),ve(G,G),re(S,T),re(E,O),R(S,1),R(E,2)}const ee=(q,$)=>{const N=I/_e($,U);for(let F=0;F<3;++F)this._convexHull[3*q+F]=$[F]*N};ee(4,T),ee(5,S),ee(6,E),ee(7,O)}_getPatchType(){const e=this.lij[1],r=e===0,i=e===(1<<this.level)-1;return r?i?Oh.HAS_BOTH_POLES:Oh.HAS_NORTH_POLE:i?Oh.HAS_SOUTH_POLE:Oh.REGULAR}intersectsRay(e,r,i,s){const n=this._boundingSphere,o=n[3]+i,a=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],l=n[0]-e[0],c=n[1]-e[1],h=n[2]-e[2],p=(l*r[0]+c*r[1]+h*r[2])/a,f=r[0]*p-l,m=r[1]*p-c,y=r[2]*p-h;return f*f+m*m+y*y<o*o}getDefaultVerticesPerSide(){return this.level<wce.length?wce[this.level]+1:2}updateCornerElevations(){kyt(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){Vyt(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var ue;if(!En||this.level<=2)return;const e=this._boundingSphere,r=e[3],i=e,s=M(),n=this.ellipsoid.radius,o=this.elevationBounds;o[1],o[0];const a=n+o[0],l=1,c=0,h=this._center[rn.MIDDLE][3],p=this.convexHull,f=(pe,we)=>{for(let Ce=0;Ce<3;++Ce)pe[Ce]=p[3*we+Ce]};{const pe=M(),we=M(),Ce=M(),je=M(),De=M(),xe=(Ne,Ue,xt,Qe)=>{f(we,Ne),f(Ce,Ue),f(je,xt),so(we,we,Ce),so(je,je,Ce),pt(pe,we,je),ve(pe,pe);const Ut=_e(pe,Ce);f(De,Qe);const Xt=_e(pe,De),er=Math.abs(Xt-Ut);Re(Mh(er,0),`Non coplanar ${Ne},${Ue},${xt},${Qe} diff = ${er}`)};xe(0,1,2,3),xe(4,5,6,7),xe(0,1,4,5),xe(1,2,5,6),xe(2,3,6,7),xe(3,0,7,4)}const m=Bc(24),y=(pe,we,Ce)=>{const je=4*pe;for(let De=0;De<3;++De)m[je+De]=we[De];m[je+3]=Ce},_=M(),b=M(),x=M(),T=M(),S=(pe,we,Ce,je)=>{f(_,we),f(b,Ce),f(x,je),so(_,_,b),ve(_,_),so(x,x,b),ve(x,x),pt(T,_,x),ve(T,T);const De=_e(T,b);y(pe,T,De)};S(0,0,1,2),S(1,1,0,4),S(2,1,5,2),S(3,3,2,6),S(4,4,0,3),S(5,4,6,5);const E=1,O=(pe,we,Ce,je)=>{const De=4*pe;return m[De+0]*we+m[De+1]*Ce+m[De+2]*je-m[De+3]},R=(pe,we,Ce,je)=>O(pe,we,Ce,je)>=-E,L=(pe,we)=>R(pe,we[0],we[1],we[2]),I=2**this.lij[0]>2*this.lij[1],U=(pe,we,Ce)=>Math.sqrt(lAe(pe,we,Ce,i[0],i[1],i[2]))<r,z=pe=>U(pe[0],pe[1],pe[2]),B=(pe,we)=>U(pe[we+0],pe[we+1],pe[we+2]),G=this.extentInRadians,K=.5*(G[0]+G[2]),re=G[1],ee=G[3],q=M(),$=M();_1(q,K,ee,a),_1($,K,re,a);const N=I?"Upper":"Lower";let F=!0;for(let pe=0;pe<6;++pe){for(let we=0;we<8;++we){const Ce=3*we,je=R(pe,p[Ce+0],p[Ce+1],p[Ce+2]);F&&(F=je),Re(je,`Tile[${this.lij}] Convex hull point ${we} outside of plane ${pe}`)}Re(L(pe,$),`Tile[${this.lij}] (${N}) bottom mid outside of plane ${pe}`),Re(L(pe,q),`Tile[${this.lij}] (${N}) top mid outside of plane ${pe}`)}Re(F,"Not all convex hull points are inside  convex hull polyhedron"),Re(z($),`Tile[${this.lij}] (${N}) bottom mid outside of bounding sphere`),Re(z(q),`Tile[${this.lij}] (${N}) top mid outside of bounding sphere`);for(let pe=0;pe<8;++pe){const we=B(p,3*pe);Re(we,`Tile[${this.lij}] Convex hull point ${pe} outside of bounding sphere`)}for(let pe=0;pe<6;++pe)for(let we=0;we<8;++we){const Ce=3*we;R(pe,p[Ce+0],p[Ce+1],p[Ce+2])||console.error(`Tile[${this.lij}] Convex hull point ${we} outside of plane ${pe}`)}const H=this.extentInRadians,X=Math.max(H[2]-H[0],H[3]-H[1]),J=Math.round(X*n),W=this.renderData;if(W){const pe=W.geometryInfo,we=W.localOrigin,Ce=(ue=pe.vertexAttributes)==null?void 0:ue.position;if(!Ce)return;const je=Ce.count,De=M(),xe=pe.numVerticesPerSide-2,Ne=xe*xe,Ue=W.geometryState.neighborData,xt=Ue.edgeResolutions.reduce((Qe,Ut)=>Qe+Ut+1,0);for(let Qe=0;Qe<je;++Qe){const Ut=Qe<Ne,Xt=!Ut&&Qe<Ne+xt;let er=!1,Yt=-1;if(Xt){let sr=Ne;for(let wr=0;wr<4;++wr){const gr=Ue.edgeResolutions[wr];if(Qe===sr||Qe===sr+gr-1){er=!0;break}if(sr+=gr,Qe<sr){Yt=wr;break}}}const mr=Yt,Jr=er,Sr=Xt&&!Jr,xr=Xt?Ue.edgePeerNeighbors[mr]:null,it=Xt&&xr&&ey(this,xr)>0,Je=Ut?"internal":Sr?"edge":Jr?"corner":"pole";Ce.getVec(Qe,s),me(De,s,we);const at=yc(De)-n;let ut=0,St=!1;const Ht=o[0]-at,Rr=at-o[1],Or=Ht>l,Mr=Rr>l,Pr=Or||Mr,Ci=`Tile[${this.lij}].vertex[${Qe}]:${Je}`+(Or?"(below)":Mr?"(above)":"")+(it?"(Neighbor)":"");{const sr=AM(De,i);if(sr>=r+c){const wr=sr-r;Pr||(console.error(`${Ci} is out of the bounding sphere by ${wr.toFixed(0)} / ${r.toFixed(0)}[tol=${c}] h=${at.toFixed(0)} / [${o[0].toFixed(0)}..${o[1].toFixed(0)}] (${(wr/r).toFixed(0)})`),St=!0)}}for(let sr=0;sr<6;++sr)if(!R(sr,De[0],De[1],De[2])){const wr=O(sr,De[0],De[1],De[2]),gr=Qe%xe,xs=(Qe-gr)/xe;sr===0&&Ht||sr===5&&Rr||(console.error(`${Ci} (${gr},${xs})|${xe}] is out of the bounding trapezoid plane ${sr} h=${Math.round(at)} / [${Math.round(o[0])}..${Math.round(o[1])}] dist=${Math.round(wr)} radii = ${Math.round(r)}/${Math.round(h)}} : maxL = ${J}`),++ut)}if(St||ut>0)break}}}};const wce=[128,64,64,32,16,8,8,4];function t0t(t,e,r){return lAe(t[0],t[1],t[2],e[r+0],e[r+1],e[r+2])}function lAe(t,e,r,i,s,n){const o=i-t,a=s-e,l=n-r;return o*o+a*a+l*l}const _1=(t,e,r,i)=>{const s=Math.cos(e),n=Math.sin(e),o=Math.cos(r),a=Math.sin(r);t[0]=i*o*s,t[1]=i*o*n,t[2]=i*a},xce=[0,0,1],Tce=M(),Sce=M();let r0t=class{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}},cAe=class extends Pa{constructor(){super(...arguments),this.blendMode=Fe.Normal}};u([k({count:Fe.COUNT})],cAe.prototype,"blendMode",void 0);let iS=class extends cAe{constructor(){super(...arguments),this.output=Dn.Composite,this.baseOpacityMode=hp.NotRequired,this.premultipliedSource=Yd.Off,this.hasWebGL2Context=!1}};u([k({count:Dn.COUNT})],iS.prototype,"output",void 0),u([k({count:hp.COUNT})],iS.prototype,"baseOpacityMode",void 0),u([k()],iS.prototype,"premultipliedSource",void 0),u([k()],iS.prototype,"hasWebGL2Context",void 0);var Kw;function i0t(t){const e=new Lr;if(e.include(GCe),t.background===Kw.Only){const r=t.output===Dn.ColorComposite;return r?e.fragment.uniforms.add(new Wt("backgroundColor",i=>i.backgroundColor)):(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(RK)),e.fragment.code.add(w`
    void main() {
      gl_FragColor = vec4(${r?w`backgroundColor`:w`gridColor(uv)`}, 1.0);
    }
  `),e}return e.include(jCe,t),e.fragment.uniforms.add(new Pt("tex",r=>r.texture)),e.fragment.uniforms.add(new Pe("opacity",r=>r.opacity)),e.fragment.code.add(w`void main() {
vec4 bgColor = getBackground(uv);
gl_FragColor = blendLayers(bgColor, texture2D(tex, uv), opacity);
}`),e}(function(t){t[t.BelowLayer=0]="BelowLayer",t[t.Only=1]="Only",t[t.COUNT=2]="COUNT"})(Kw||(Kw={}));const s0t=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Kw},build:i0t},Symbol.toStringTag,{value:"Module"}));let n0t=class extends BCe{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=wa}},uAe=class hAe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,hAe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt})}};uAe.shader=new Dr(s0t,()=>ie(()=>import("./BlendLayers.glsl-0c860dcd.js"),[],import.meta.url));let dAe=class extends iS{constructor(){super(...arguments),this.background=Kw.BelowLayer}};u([k()],dAe.prototype,"background",void 0);let BV=class{constructor(e,r,i,s,n,o){this.texture=e,this.type=r,e.retain(),this.offsetAndScale=qt(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=$e(s,n,o)}destroy(){this.texture.release()}};function hN(){return[1,0,0,1,0,0]}function o0t(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function a0t(t,e,r,i,s,n){return[t,e,r,i,s,n]}function l0t(t,e){return new Float64Array(t,e,6)}Object.freeze(Object.defineProperty({__proto__:null,clone:o0t,create:hN,createView:l0t,fromValues:a0t},Symbol.toStringTag,{value:"Module"}));function c0t(t){return t instanceof Float32Array&&t.length>=2}function u0t(t){return Array.isArray(t)&&t.length>=2}function GV(t){return c0t(t)||u0t(t)}const h0t=96,d0t=39.37;function DK(t,e){return e.type?ar(t,e.x,e.y):zn(t,e)}function p0t(t){return al(t)}function f0t(t,e){const r=t.targetGeometry,i=e.targetGeometry;return r.x=i.x,r.y=i.y,r.spatialReference=i.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}const m0t=function(){const t=Ke();return function(e,r,i){const s=r.targetGeometry;DK(t,s);const n=.5*Q6(r);return e.xmin=t[0]-n*i[0],e.ymin=t[1]-n*i[1],e.xmax=t[0]+n*i[0],e.ymax=t[1]+n*i[1],e.spatialReference=s.spatialReference,e}}();function Q6(t){return t.scale*g0t(t.targetGeometry)}function g0t(t){return v(t)&&va(t.spatialReference)?1/(p0t(t.spatialReference)*d0t*h0t):1}function y0t(t){return K4(t.rotation)||0}const NK=function(){const t=Ke(),e=Ke(),r=Ke();return function(i,s,n,o,a,l){return LZ(t,s),Cc(e,n,.5*l),ar(r,1/o*l,-1/o*l),OZ(i,e),a&&AZ(i,i,a),$be(i,i,r),RZ(i,i,t),i}}(),_0t=function(){const t=Ke();return function(e,r,i,s){const n=Q6(r),o=y0t(r);return DK(t,r.targetGeometry),NK(e,t,i,n,o,s)}}(),v0t=function(){const t=Ke();return function(e,r,i,s){const n=Q6(r);return DK(t,r.targetGeometry),NK(e,t,i,n,0,s)}}();function b0t(t){const e=V_(t);return e?e.valid[1]-e.valid[0]:0}function w0t(t,e){return Math.round(b0t(t)/e)}var Cq;const Km=[0,0];let Q0=Cq=class extends fe{constructor(t){super(t),this._viewpoint2D={center:Ke(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new Hr,this.id=0,this.inverseTransform=hN(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=hN(),this.transformNoRotation=hN(),this.displayMat3=Hl(),this.displayViewMat3=Hl(),this.viewMat3=Hl(),this.viewMat2d=Obe(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,r=t.targetGeometry;e.center[0]=r.x,e.center[1]=r.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=r.spatialReference}this._update()}copy(t){const e=this.size,r=this.viewpoint;return r&&e?(this.viewpoint=f0t(r,t.viewpoint),this._set("size",zn(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new Cq({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,r){return GV(e)?ab(t,e,this.inverseTransform):(Km[0]=e,Km[1]=r,ab(t,Km,this.inverseTransform))}toScreen(t,e,r){return GV(e)?ab(t,e,this.transform):(Km[0]=e,Km[1]=r,ab(t,Km,this.transform))}toScreenNoRotation(t,e,r){return GV(e)?ab(t,e,this.transformNoRotation):(Km[0]=e,Km[1]=r,ab(t,Km,this.transformNoRotation))}getScreenTransform(t,e){const{center:r}=this._viewpoint2D,i=this._get("pixelRatio")||1,s=this._get("size");return NK(t,r,s,e,0,i),t}_update(){const{center:t,spatialReference:e,scale:r,rotation:i}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new Vc({targetGeometry:new _t(t[0],t[1],e),scale:r,rotation:i});if(this._set("viewpoint",o),!n||!e||!r)return;this.resolution=Q6(o),this.rotation=i,this.scale=r,this.spatialReference=e,zn(this.center,t);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;YX(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=ZX(this.viewMat3),h=Rh(n[0]/2,n[1]/2),p=Rh(-n[0]/2,-n[1]/2),f=K4(i);cF(c,c,h),JX(c,c,f),cF(c,c,p),lE(this.displayViewMat3,this.displayMat3,c);const m=OZ(this.viewMat2d,h);return AZ(m,m,f),RZ(m,m,p),m0t(this.extent,o,n),_0t(this.transform,o,n,s),Pbe(this.inverseTransform,this.transform),v0t(this.transformNoRotation,o,n,s),this.worldScreenWidth=w0t(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],Q0.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],Q0.prototype,"pixelRatio",null),u([d({json:{write:!0}})],Q0.prototype,"size",null),u([d()],Q0.prototype,"spatialReference",void 0),u([d({type:Vc,json:{write:!0}})],Q0.prototype,"viewpoint",null),Q0=Cq=u([P("esri.views.2d.ViewState")],Q0);const x0t=Q0,T0t=.125;let S0t=class{constructor(){this._renderParams={context:null,drawPhase:1,state:new x0t({viewpoint:new Vc({targetGeometry:new _t(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null}}dispose(){this._renderParams=null}render(e,r,i,s,n,o,a,l,c,h){const p=o.adjustLevel(r[0]),f=this._renderParams;f.context=e,f.painter=s,f.glyphMosaic=s.glyphMosaic,f.spriteMosaic=s.spriteMosaic,f.pixelRatio=h,f.displayLevel=p,f.requiredLevel=p;const m=o.getScale(r[0]),[y,_]=o.getShift(r,a*m),b=T0t*a*m/c,x=i.transforms.dvs;x[0]=b,x[4]=-b,x[6]=-1-y-l[0]*a*2,x[7]=1+_+(1-l[1])*a*2-2,f.state.size[0]=c,f.state.size[1]=c,i.stage||i.attachWithContext(e),i.triangleCount=0,s.drawTile(f,i,n)}},pAe=class fAe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,fAe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt})}};pAe.shader=new Dr(iyt,()=>ie(()=>import("./RasterColorizer.glsl-7a68e3c7.js"),[],import.meta.url));let dN=class extends iS{constructor(){super(...arguments),this.colorizerType=mw.Stretch,this.stretchType=Zw.Noop,this.applyColormap=!0}};u([k({count:mw.COUNT})],dN.prototype,"colorizerType",void 0),u([k({count:Zw.COUNT})],dN.prototype,"stretchType",void 0),u([k()],dN.prototype,"applyColormap",void 0);let Ece=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const r=this._fbos.get(e);if(r)return r;const i=new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.DEPTH_RENDER_BUFFER,width:e,height:e});return this._fbos.set(e,i),i}};const E0t=se.getLogger("esri.views.3d.terrain");let C0t=class{constructor(e,r){this._rctx=e,this._techniqueRepository=r,this._fbos=[],this._vectorTileHelper=new S0t,this._bindParameters=new h6(null,null,null),this._blendLayersTechniqueConfig=new dAe,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=Ia(this._rctx,lC)}dispose(){this._fbos.forEach(et),this._fbos=null,this._vtFBO=et(this._vtFBO),this._vaoQuad=et(this._vaoQuad),this._vectorTileHelper=et(this._vectorTileHelper),this._backgroundTechnique=ji(this._backgroundTechnique),this._applyOpacityTechnique=ji(this._applyOpacityTechnique),this._blendLayersTechnique=ji(this._blendLayersTechnique)}_getBlendLayersTechnique(e,r,i,s=Yd.Off,n=Kw.BelowLayer){return this._blendLayersTechniqueConfig.output=r,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechniqueConfig.background=n,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(uAe,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,r){const i=this._getBlendLayersTechnique(Fe.Normal,r?Dn.ColorComposite:Dn.GridComposite,hp.NotRequired,Yd.Off,Kw.Only),s=this._rctx.bindTechnique(i,e,this._bindParameters);this._render(s)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays($t.TRIANGLE_STRIP,0,Ko(this._vaoQuad,"geometry"))}drawGroup(e,r,i,s,n,o=Yd.On){r===Dn.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const a=this._getBlendLayersTechnique(s,r,n,o),l=this._rctx.bindTechnique(a,e,this._bindParameters);this._render(l)}drawRasterData(e,r,i,s,n,o=Yd.Off){if(C(e.texture))return;e.fboTexture=r===Dn.GroupBackgroundComposite||s===Fe.Normal&&n===hp.NotRequired&&o===Yd.Off?null:this.switch(i).colorTexture;const a=this._getBlendLayersTechnique(s,r,n,o),l=this._rctx.bindTechnique(a,e,this._bindParameters);this._render(l)}drawImageryTileData(e,r,i,s,n,o){const a=o.sourceLayerInfo.data;if(!a.source||(o.tile.surface.layerViewByIndex(o.layerIndex,pr.MAP).ensureSymbolizerParameters(a),!a.bind(this._rctx)))return;e.fboTexture=s===Fe.Normal&&n===hp.NotRequired?null:this.switch(i).colorTexture;const l=this._getRasterColorizerTechnique(a,r,s,n);a.opacity=e.opacity;const c=a.getUniforms();c.scale=o.scale,c.offset=o.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(l,c,null);this._render(h)}_getRasterColorizerTechnique(e,r,i,s){const n=e.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(n.type);return C(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new dN,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=r,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=s,this._rasterColorizerConfig.colorizerType=o,this._rasterColorizerConfig.applyColormap=!!n.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?Zw.Noop:Zw.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(pAe,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,r,i,s,n,o,a,l,c){const h=this._rctx,p=o.sourceLayerInfo.data,f=o.tile.surface.layerViewByIndex(o.layerIndex,pr.MAP),m=n===hp.Required||e.opacity<1||s!==Fe.Normal||r!==Dn.Composite,y=m?Yd.On:Yd.Off;this._getBlendLayersTechnique(s,r,n,y).bindPipelineState(h);let _=null,b=null;m?(b=this.currentFBO(i),C(this._vtFBO)&&(this._vtFBO=new Ece(this._rctx)),_=this._vtFBO.get(i),h.bindFramebuffer(_),this._clearCurrentFBO()):c&&h.clearSafe(Fi.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(h,o.sourceLod,p,f.painter,f.layer.styleRepository,f.schemaHelper,Math.round(1/o.scale),o.offset,l,a)}catch(x){E0t.warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return!v(_)||(h.bindFramebuffer(b),e.texture=_.colorTexture,e.offset=Xl,e.scale=1,this.drawRasterData(e,r,i,s,n,y),c)}copyFBOToTexture(e){const r=this._rctx,i=r.bindTexture(e.texture,ct.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;r.gl.copyTexImage2D(wt.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),r.bindTexture(i,ct.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(Fi.COLOR_BUFFER_BIT|Fi.DEPTH_BUFFER_BIT)}_initFBO(e,r,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,r,r),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,r=0,i=!0){if(this._current=r,r>=this._fbos.length)for(let s=this._fbos.length;s<=r;s++)this._fbos.push(new Ece(this._rctx));this._initFBO(this._fbos[r].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const r=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),r}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const r=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},A0t=class{constructor(e,r,i,s){this.start=e,this.end=r,this.blendMode=i,this.opacity=s}},R0t=class{constructor(e,r,i){this._rctx=e,this.tileSize=r,this._techniqueRepository=i,this._passParameters=new n0t,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new C0t(this._rctx,this._techniqueRepository),this._blackTex=new C2(pKe(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=et(this._composition),this._backgroundTexture=ji(this._backgroundTexture),this._blackTex=ji(this._blackTex)}get backgroundIsGrid(){return C(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,r){if(!e.renderData)return;const i=e.surface,s=i.baseOpacity;let n=0,o=0,a=this.tileSize,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;I4.clear(),hT.length=0;const p=e.layerInfo[pr.MAP];let f=p.length,m=0;for(;m<p.length;m++){const b=i.layerViewByIndex(m,pr.MAP),x=b.layer.opacity;Cce[m]=x;const T=b.fullOpacity;if(Ace[m]=T,Mpe(b.layer)&&f>=p.length&&(f=m),A4(b)){Rce[m]=b.layer.blendMode;let E=b.layer.blendMode!=="normal";if(jS(b.layer.parent)){const O=Aq(b.layer.parent);v(O)&&O!==""&&(E=mAe(b.layer.parent)||E)}E&&(h=E,l=!1)}if(x===0&&!h){p[m].pendingUpdates&=~(Ct.TEXTURE_NOFADING&Ct.TEXTURE_FADING);continue}++o;const S=jV(e,m);if(S){if(p[m].pendingUpdates&=~(Ct.TEXTURE_NOFADING&Ct.TEXTURE_FADING),jS(b.layer.parent)){const E=Aq(b.layer.parent);v(E)&&E!==""&&gAe(b.layer.parent,m)}iM(b)?a=Math.max(a,this.tileSize*c):s===1&&T===1&&(b.isOpaque||this._dataToTexture(S)&&S.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++n}}this._rctx.type===bt.WEBGL1&&(a=O0t(a));const y=a/this.tileSize,_=m-1;this._ensureBackgroundTexture(this.tileSize),n!==0?n===1&&!h&&this._useLayerTexture(e,_,f,Ace[_])||this._composeMapLayers(e,r,_,f,Cce,Rce,a,y,!l||h,I4,h):this._useBackgroundTexture(e,o)}_ensureBackgroundTexture(e){C(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=Xl,this._passParameters.scale=1,this._passParameters.opacity=1,v(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,v(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}_useBackgroundTexture(e,r){let i=Qg.Immediate;(e.surface.view.layerViewManager.updating||r>0)&&(i=Qg.Delayed);const s=e.renderData;this._backgroundTexture&&C(s.textureReference)&&(i=Qg.Immediate),s.setTextureReference(v(this._backgroundTexture)?new BV(this._backgroundTexture,bn.FADING,Oce,e.surface.baseOpacity,0,1):null,i)}_useLayerTexture(e,r,i,s){const n=r<i,o=n?1:e.surface.baseOpacity,a=n?e.surface.baseOpacity:1,l=jV(e,r);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new BV(l.sourceLayerInfo.data,bn.FADING,l,o,a,s)),!0)}_composeMapLayers(e,r,i,s,n,o,a,l,c,h,p){this._composition.ensureBuffer(a);const f=e.surface.baseOpacity;let m=!1,y=tt.LINEAR_MIPMAP_LINEAR,_=!1,b=0;for(let S=i;S>=0;S--){const E=jV(e,S);if(!E||n[S]===0&&!p)continue;const O=S<s&&f<1&&!m;this._passParameters.baseOpacity=O?f:1;const R=this._passParameters.baseOpacity<1?hp.Required:hp.NotRequired;O&&(m=!0);let L=!1;h.forEach(B=>{B.start===S&&(hT.push(B),this._composition.openGroup(a),L=!0)});const I=b===0,U=L?Dn.GroupBackgroundComposite:c&&I?this.backgroundIsGrid?Dn.GridComposite:Dn.ColorComposite:Dn.Composite,z=Tq[o[S]];for(Omt(E)?(this._passParameters.opacity=n[S],_=this._composition.drawVectorData(this._passParameters,U,a,z,R,E,l,this.tileSize,_)):Rmt(E)?(this._passParameters.opacity=n[S],this._composition.drawImageryTileData(this._passParameters,U,a,z,R,E),this._hasNearestInterpolation(E)&&(y=tt.NEAREST)):this._dataToTexture(E)&&(this._passParameters.texture=E.sourceLayerInfo.data.texture,this._passParameters.offset=E.offset,this._passParameters.scale=E.scale,this._passParameters.opacity=n[S],this._composition.drawRasterData(this._passParameters,U,a,z,R));hT.length>0&&hT[hT.length-1].end===S;){const B=hT.pop();this._passParameters.opacity=B.opacity,this._passParameters.offset=Xl,this._passParameters.scale=1;const G=c&&I?this.backgroundIsGrid?Dn.GridComposite:Dn.ColorComposite:Dn.Composite;this._composition.drawGroup(this._passParameters,G,a,Tq[B.blendMode],R)}b++}const x=e.renderData,T=x.ensureTexture(a,()=>this._buildTexture(a,y));this._composition.copyFBOToTexture(T),this._composition.unbind(),x.setTextureReference(new BV(T,r,Oce,m?1:f,0,1))}_hasNearestInterpolation(e){const r=e.sourceLayerInfo.data;return!!r.source&&r.interpolation==="nearest"}_dataToTexture(e){if(Pmt(e)){const r=e.sourceLayerInfo;r.data=this._buildTexture(r.data),e.tile.setMemoryDirty()}return Mmt(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,r=tt.LINEAR_MIPMAP_LINEAR){if(C(e))return null;const i={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:r,maxAnisotropy:this._maxAnisotropy,preMultiplyAlpha:!0,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if(typeof e=="number")i.width=i.height=e,n=new C2(new ct(s,i));else if(e instanceof q6)i.isOpaque=e.isOpaque,n=new C2(new ct(s,i,e.image)),e.release();else try{i.width=e.width,i.height=e.height,n=new C2(new ct(s,i,e))}catch{n=new C2(Ewe(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,ct.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,ct.TEXTURE_UNIT_FOR_UPDATES),n}get test(){return{backgroundTexture:this._backgroundTexture}}};function O0t(t){const e=qS(t),r=e*e,i=t*t;if(r===i)return t;const s=e/2;return r-i<i-s*s?e:s}function jV(t,e){eu.layerIndex=e;const r=t.layerInfo[pr.MAP][e];if(v(r.data))return ar(eu.offset,0,0),eu.tile=t,eu.scale=1,eu.sourceLod=t.lij,eu.sourceLayerInfo=r,eu;const i=r.upsampleInfo;if(v(i)){const s=i.tile.layerInfo[pr.MAP][e];return eu.tile=i.tile,zn(eu.offset,i.offset),eu.scale=i.scale,eu.sourceLod=i.tile.lij,eu.sourceLayerInfo=s,eu}return null}function Aq(t){return t.get("uid")}function mAe(t){let e=t.blendMode!=="normal";return jS(t.parent)&&(e=mAe(t.parent)||e),e}function gAe(t,e){jS(t.parent)&&gAe(t.parent,e);const r=Aq(t);if(v(r)&&r!==""){const i=I4.get(r);i?i.start=e:I4.set(r,new A0t(e,e,t.blendMode,t.opacity))}}const Cce=new Array,Ace=new Array,Rce=new Array,I4=new Map,hT=new Array,eu={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},Oce={offset:[0,0],scale:1},yAe=200,HV=40,M0t=.8,P0t=10,ZR=1e-6;function I0t(t,e,r){const i=e,s=r;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=t[a];if(i[a]<l){if(s[a]<=ZR)return!1;const c=(l-i[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-ZR){const c=(l-i[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=t[a+3];if(i[a]>l){if(s[a]>=-ZR)return!1;const c=(l-i[a])/s[a];n=Math.max(n,c)}else if(s[a]>=ZR){const c=(l-i[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}let Mce=class{constructor(e,r,i,s,n){this.aabb=e,this.axis=r,this.d=i,this.midStartIndex=s,this.rightStartIndex=n}},FK=class Rq{constructor(e,r,i,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=r,this.positionAttribute=s,this._rayDirection=M(),this.bspNodeTree=new Array;const n=i-r,o=n<=_Ae?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=F0t(e,r,i,s.data,s.stride),l=ye(Math.log2(n/HV),2,P0t),c=(h,p,f)=>{const m=D0t(o,a,h,p),y=p-h;if(y<=HV){const E=new Mce(m,void 0,0,h,p);return this.bspNodeTree.push(E),E}const{axis:_,midValue:b}=N0t(m),x=L0t(o,a,h,p,_,b),T=(E,O)=>{if(f>l)return;const R=O-E;return R<HV||R>=M0t*y?void 0:c(E,O,f+1)},S=new Mce(m,_,b,x.next,x.mid);return this.bspNodeTree.push(S),S.leftNode=T(h,x.next),S.rightNode=T(x.mid,p),S};c(0,n,0),this.triangleVertexIndices=U0t(o,e,r,i)}}intersectRayTriangleRange(e,r){{if(e>=r)return;const i=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this._rayOrigin,a=o[0],l=o[1],c=o[2],h=this._rayDirection,p=h[0],f=h[1],m=h[2];for(let y=e,_=3*e;y<r;++y){let b=i[_++]*n;const x=s[b++],T=s[b++],S=s[b];b=i[_++]*n;const E=s[b++],O=s[b++],R=s[b];b=i[_++]*n;const L=E-x,I=O-T,U=R-S,z=s[b++]-x,B=s[b++]-T,G=s[b]-S,K=f*G-B*m,re=m*z-G*p,ee=p*B-z*f,q=L*K+I*re+U*ee;if(Math.abs(q)<=Number.EPSILON)continue;const $=a-x,N=l-T,F=c-S,H=$*K+N*re+F*ee;if(q>0){if(H<0||H>q)continue}else if(H>0||H<q)continue;const X=N*U-I*F,J=F*L-U*$,W=$*I-L*N,ue=p*X+f*J+m*W;if(q>0){if(ue<0||H+ue>q)continue}else if(ue>0||H+ue<q)continue;const pe=(z*X+B*J+G*W)/q;if(pe>=0){const we=this.indices[y]+this.firstTriangleIndex,Ce=RJ(L,I,U,z,B,G,$0t);this._callback(pe,Ce,we,!1)}}}Rq.numFacesTested+=r-e}intersectRay(e,r){Rq.numFacesTested=0;const i=$e(e.r0[0],e.r0[1],e.r0[2]),s=$e(e.r1[0],e.r1[1],e.r1[2]),n=s[0]-i[0],o=s[1]-i[1],a=s[2]-i[2];if(n*n+o*o+a*a<ZR)return;this._rayOrigin=i;const l=this._rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this._callback=r;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,r,i){const s=this._rayOrigin,n=this._rayDirection;if(!I0t(e.aabb,s,n))return;const o=e.axis,a=e.d;if(s[o]<a||n[o]<0){const l=r,c=e.midStartIndex;if(l<c){const h=e.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[o]>a||n[o]>0){const l=e.rightStartIndex,c=i;if(l<c){const h=e.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}};FK.numFacesTested=0;const $0t=M(),dT=[1/0,1/0,1/0],pT=[-1/0,-1/0,-1/0];function L0t(t,e,r,i,s,n){let o=r,a=i;for(;o<a;){const c=t[o];e[6*c+s+3]<=n?++o:(--a,t[o]=t[a],t[a]=c)}let l=o;for(a=i;l<a;){const c=t[a-1];e[6*c+s]>=n?--a:(t[a-1]=t[l],t[l]=c,++l)}return{next:o,mid:l}}function D0t(t,e,r,i){if(i<=r)return Pw(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*t[r];for(let n=0;n<3;++n)dT[n]=e[s+0+n],pT[n]=e[s+3+n]}for(let s=r+1;s<i;++s){const n=6*t[s];for(let o=0;o<3;++o)dT[o]=Math.min(dT[o],e[n+0+o]),pT[o]=Math.max(pT[o],e[n+3+o])}return Pw(dT[0],dT[1],dT[2],pT[0],pT[1],pT[2])}function N0t(t){const e=t[3]-t[0],r=t[4]-t[1],i=t[5]-t[2],s=e>r?e>i?0:r>i?1:2:r>i?1:i>e?2:0;return{axis:s,midValue:(t[s]+t[s+3])/2}}function F0t(t,e,r,i,s){const n=r-e,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+e),c=t[l+0]*s,h=t[l+1]*s,p=t[l+2]*s;for(let f=0;f<3;++f){const m=i[c+f],y=i[h+f],_=i[p+f];o[6*a+f]=Math.min(m,y,_),o[6*a+3+f]=Math.max(m,y,_)}}return o}function U0t(t,e,r,i){const s=i-r;let n=0;for(let a=r;a<i;++a)for(let l=0;l<3;++l)n=Math.max(e[3*a+l],n);const o=n<=_Ae?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(t[a]+r);for(let c=0;c<3;++c){const h=e[l+c];o[3*a+c]=h}}return o}const _Ae=65535;let ns=class extends io{constructor(){super(...arguments),this.output=V.Color,this.overlayMode=ty.Disabled,this.tileBlendInput=Yf.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.atmosphere=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.shading=!Wr.TERRAIN_USE_LEGACY_SHADING,this.useLegacyTerrainShading=Wr.TERRAIN_USE_LEGACY_SHADING,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=dt.Terrain}};u([k({count:V.COUNT})],ns.prototype,"output",void 0),u([k({count:ty.COUNT})],ns.prototype,"overlayMode",void 0),u([k({count:Yf.COUNT})],ns.prototype,"tileBlendInput",void 0),u([k()],ns.prototype,"spherical",void 0),u([k()],ns.prototype,"doublePrecisionRequiresObfuscation",void 0),u([k()],ns.prototype,"atmosphere",void 0),u([k()],ns.prototype,"receiveShadows",void 0),u([k()],ns.prototype,"hasSlicePlane",void 0),u([k()],ns.prototype,"backfaceCullingEnabled",void 0),u([k()],ns.prototype,"stencilEnabled",void 0),u([k()],ns.prototype,"textureFadingEnabled",void 0),u([k()],ns.prototype,"renderOccluded",void 0),u([k()],ns.prototype,"hasScreenSpaceReflections",void 0),u([k()],ns.prototype,"hasCloudsReflections",void 0),u([k()],ns.prototype,"shading",void 0),u([k()],ns.prototype,"useLegacyTerrainShading",void 0),u([k()],ns.prototype,"invisible",void 0),u([k()],ns.prototype,"tileBorders",void 0),u([k()],ns.prototype,"visualizeNormals",void 0),u([k()],ns.prototype,"screenSizePerspective",void 0),u([k()],ns.prototype,"receiveAmbientOcclusion",void 0),u([k({count:dt.COUNT})],ns.prototype,"pbrMode",void 0),u([k({constValue:si.CompressedAttribute})],ns.prototype,"normalType",void 0),u([k({constValue:Xs.Compressed})],ns.prototype,"textureCoordinateType",void 0),u([k({constValue:!1})],ns.prototype,"highStepCount",void 0),u([k({constValue:!1})],ns.prototype,"useCustomDTRExponentForWater",void 0),u([k({constValue:!1})],ns.prototype,"useFillLights",void 0);const qV=7,V0t=10,WV=Rn();var In;(function(t){t[t.Opaque=0]="Opaque",t[t.Semitransparent=1]="Semitransparent",t[t.TransparentWithDraped=2]="TransparentWithDraped",t[t.Empty=3]="Empty"})(In||(In={}));let hc=class extends Te{get _isGlobal(){return this._stage.viewingMode===Be.Global}get shading(){return this._techniqueConfiguration.shading}set shading(e){this._techniqueConfiguration.shading=e}constructor(e){super(e),this.type=ts.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new ns,this._passParameters=new qCe,this._rctx=null,this._renderDataPool=new Po(Iyt),this._patchGroups=new Map,this._patchGroupsDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new FCe,this._highestVisibleLODTile=null,this._visible=!0,this._transparencyState=In.Opaque,this._velvetOverground=!0,this._castShadows=!0,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=as.Occlude}initialize(){const e=[Se.OPAQUE_TERRAIN,Se.TRANSPARENT_TERRAIN,Se.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}destroy(){this._stage.removeRenderPlugin(this),Mgt()}get canRender(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===In.TransparentWithDraped||e===In.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get needsLinearDepth(){return this._overlayRenderer.hasWater}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return f_}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?v4:as.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,v(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,Ct.TEXTURE_FADING)}updateTileTexture(e,r){v(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,r===Ct.TEXTURE_FADING?bn.FADING:bn.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(r))}updateTileGeometryState(e){for(const i of e.layerInfo[pr.ELEVATION])i.pendingUpdates&=~Ct.GEOMETRY;e.resetPendingUpdate(Ct.GEOMETRY);const r=e.renderData.updateGeometryState();return r&&this.setDirty(),r}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const r=e.renderData;r&&(r.releaseGeometry(),this._renderDataPool.release(r),r.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const r=V0t-qV,i=Math.max(0,Math.floor((e.level-r)/qV)*qV);if(this._isGlobal&&i===0)return wa;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this._visible=e,this.setDirty()}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=Ps.UPDATE){this._patchGroupsDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=Ps.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=Ps.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.techniqueRepository,this._tileRenderer=new R0t(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=Ewe(this._rctx)}uninitializeRenderContext(){this._emptyTex=et(this._emptyTex),this._tileRenderer=et(this._tileRenderer)}intersect(e,r,i,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==In.Opaque)return;const n=k0t,o=z0t;ge(n,s,i),ce(o,1/n[0],1/n[1],1/n[2]);const a=e.results.min,l=e.results.max,c=e.results.ground,h=e.options.store===Do.MIN,p=!!e.results.ground.target,f=SUe(e.verticalOffset),m=e.tolerance;let y,_=h&&v(a.dist)?a.dist:1/0;const b=T=>{const S=T.renderData;if(!(S!=null&&S.vao))return;const E=S.geometryInfo;g5(WV,E.boundingBox);const O=S.localOrigin;v(f)&&(f.localOrigin=O,f.applyToAabb(WV));const R=WV;if(fT[0]=i[0]-O[0],fT[1]=i[1]-O[1],fT[2]=i[2]-O[2],!MJ(R,fT,o,m,_))return;const L=(ee,q,$)=>{ee.set(this.type,T,q,$,Uu),_=h&&v(a.dist)?a.dist:1/0},I=(ee,q)=>{if(v(q)&&ee>=0&&(e.options.backfacesTerrain||_e(q,n)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||r==null||r(i,s,ee))){if((c.dist==null||ee<c.dist)&&L(c,ee,q),e.options.isFiltered)return;e.options.store===Do.ALL&&(C(y)?(y=wY(e.ray),L(y,ee,q),e.results.all.push(y)):ee<y.dist&&L(y,ee,q)),(a.dist==null||ee<a.dist)&&L(a,ee,q),e.options.store!==Do.MIN&&(l.dist==null||ee>l.dist)&&L(l,ee,q)}},U=B0t;ge(U,s,O);const z=E.indices,B=E.vertexAttributes,G=B.getField(A.POSITION,Ii),K=new Ye(G.typedBuffer,3,!1,B.stride/4),re=E.indexCount/3;if(C(f)&&re>yAe){const ee=T.renderData;C(ee.intersectionData)&&(ee.intersectionData=new FK(z,0,re,K)),ee.intersectionData.intersectRay({r0:fT,r1:U},I)}else nP(fT,U,0,re,z,K,null,f,I)},x=this._rootTiles;v(x)&&(()=>{const T=this._tileIterator;T.reset(x);const S=e.options.invisibleTerrain;for(let E=T.next();E;E=T.next())!(E.visible||S&&E.intersectsClippingArea)||!v(f)&&!E.intersectsRay(i,n,m,_)||p&&this._useStencilForTile(E)?T.skipSubtree():b(E)})()}processScaleRangeQueries(e,r){var i;if(!r.done)for(this._updatePatchGroups();e.updating&&!r.done;){e.prepare();for(const s of this._patchGroups.values())for(const n of s)v((i=n.renderData)==null?void 0:i.textureReference)&&e.queriesForTile(n);e.process(),r.madeProgress()}}prepareTechnique(e){if(e.bindParameters.slot===Se.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&v4))return null}else{const r=this.transparency===In.Opaque?Se.OPAQUE_TERRAIN:Se.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==r)return null}switch(e.output){case V.Color:return this.transparency===In.Empty?null:(this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=v(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.active,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty?ty.Disabled:this._overlayRenderer.hasWater?ty.EnabledWithWater:ty.Enabled,this._updateTechnique(V.Color,e.bindParameters.slot===Se.OCCLUDED_TERRAIN));case V.Shadow:case V.ShadowExcludeHighlight:return this._castShadows&&e.bindParameters.lighting.globalFactor===1?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(V.Shadow,!1)):null;case V.Depth:return this.transparency===In.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(V.Depth,!1));case V.Normal:return this.transparency===In.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(V.Normal,!1));case V.ObjectAndLayerIdColor:return this.transparency===In.Empty?null:this._updateTechnique(V.ObjectAndLayerIdColor,!1);case V.Highlight:return this.transparency!==In.Empty&&this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(V.Highlight,!1)):null}return null}render(e,r){const i=e.bindParameters.lighting.globalFactor===1;switch(this._updatePatchGroups(),r.useStencil=!1,e.output){case V.Color:{const s=e.bindParameters.slot===Se.OCCLUDED_TERRAIN?Nl.Occluded:Nl.ColorAndWater;this.transparency===In.Opaque?this._renderMaterialPass(e,r,s):e.offscreenRenderingHelper.renderToTargets(()=>this._renderMaterialPass(e,r,s),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break}case V.Depth:case V.Normal:this._renderAuxiliaryPass(e,r,Nl.None);break;case V.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,r,Nl.Highlight);break;case V.Shadow:case V.ShadowExcludeHighlight:this._castShadows&&i&&this._renderAuxiliaryPass(e,r,Nl.None);break;case V.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,r,Nl.ObjectAndLayerIdColor)}}_renderMaterialPass(e,r,i){const{rctx:s}=e;this._passParameters.overlaySource=i,s.bindTechnique(r,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._renderPatchGroups(e,r,i)}_renderAuxiliaryPass(e,r,i){const s=e.rctx;this._passParameters.overlaySource=i,s.bindTechnique(r,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,r,i)}updateTileBackground(e=null){if(C(this._tileRenderer))return;const r=this._tileRenderer;let i=null;if(v(e)){const s=Ze.toUnitRGBA(e);i=$e(s[0]||0,s[1]||0,s[2]||0)}r.setBackground(i),this._allTiles.forAll(s=>r.updateTileTexture(s,bn.FADING)),this._techniqueConfiguration.tileBlendInput=r.backgroundIsGrid?Yf.GridComposite:v(r.backgroundColor)?Yf.ColorComposite:Yf.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==DE.NONE){const e=Array.from(this._patchGroups.values()),r=this._stencilEnabledLayerExtents;for(const i of e)UCe(this.renderOrder,i,r);e.sort((i,s)=>VCe(i[0],s[0],this.renderOrder)),this._patchGroups=new Map(e.map(i=>[i[0].renderData.localOrigin,i])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var r;const e=this._rootTiles;if(!C(e)){(r=e[0])==null||r.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();for(const i of e)this._rebuildPatchGroupsForRootTile(i)}}_rebuildPatchGroupsForRootTile(e){const r=this._tileIterator;for(r.resetOne(e);!r.done;){const i=r.next(),s=i.renderData;if(!s){this._numTilesCulled++;continue}if(!i.visible){this._numTilesCulled++,r.skipSubtree();continue}const n=s.localOrigin;let o=this._patchGroups.get(n);o||(o=new Array,this._patchGroups.set(n,o)),o.push(i),(!this._highestVisibleLODTile||i.vlevel>this._highestVisibleLODTile.vlevel)&&(this._highestVisibleLODTile=i),r.skipSubtree()}}_useStencilForTile(e){for(const r of this._stencilEnabledLayerExtents)if(e.intersectsExtent(r))return!0;return!1}_renderPatchGroupsAuxiliary(e,r,i){const s=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(n=>{const o=n[0].renderData.localOrigin;r.program.bindDraw(new QH(o),e.bindParameters,this._passParameters);for(let a=0;a<n.length;a++)this._renderPatch(e,r,n[a],$t.TRIANGLES,s,i)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,r,i){const s=e.bindParameters.camera,n=r.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const p=_Te(this._stage.viewingMode,this._ellipsoidRadius),f=this.pointsOfInterest.centerOnSurfaceFrequent.distance;p.update({distance:f,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,a=i===Nl.Occluded;a&&(n.bindTexture("tex",this._emptyTex),n.setUniform3fv("textureOpacities",wa),n.setUniform4fv("texOffsetAndScale",Kf));const l=v(this._tileRenderer)&&v(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:wa;this._techniqueConfiguration.tileBlendInput===Yf.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?$t.LINES:$t.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&n.bindTexture("texNext",this._emptyTex);const h=this._patchGroups;for(const p of h.values()){const f=p[0].renderData.localOrigin;r.program.bindDraw(new QH(f),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const m of p){const y=m.renderData,_=y.textureReference;if(!C(_)){if(!a){n.setUniform4fv("texOffsetAndScale",_.offsetAndScale),n.bindTexture("tex",_.texture.texture);const b=y.textureFadeFactor,x=b<1?y.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&v(x)&&b<1?(n.setUniform1f("fadeFactor",b),n.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),n.setUniform3fv("nextTexOpacities",x.opacities),n.bindTexture("texNext",x.texture.texture)):n.setUniform1f("fadeFactor",1),y.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",_.opacities)}this._renderPatch(e,r,m,c,o,i),m.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,r,i,s,n,o){const a=i.renderData,l=a.vao,c=l.indexBuffer;if(C(c))return void(En&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const h=r.program;o===Nl.None||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),n&&(r.useStencil=this._useStencilForTile(i),r.bindPipelineState(e.rctx,e.bindParameters.slot));const p=a.geometryInfo.indexCount;e.rctx.bindVAO(l),h.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(s,p,c.indexType,0)}_bindOverlayPatchData(e,r){e.setUniform4fv("overlayTexOffset",r.offsets),e.setUniform4fv("overlayTexScale",r.scales)}_updateTechnique(e,r){return this._techniqueConfiguration.output=e,e===V.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=r,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(WCe,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};u([d({constructOnly:!0})],hc.prototype,"_overlayRenderer",void 0),u([d({constructOnly:!0})],hc.prototype,"_stage",void 0),u([d({readOnly:!0})],hc.prototype,"_isGlobal",null),u([d({constructOnly:!0})],hc.prototype,"_allTiles",void 0),u([d({constructOnly:!0})],hc.prototype,"_ellipsoidRadius",void 0),u([d({value:!1})],hc.prototype,"renderingDisabled",null),u([d()],hc.prototype,"renderPatchBorders",null),u([d()],hc.prototype,"visualizeNormals",null),u([d()],hc.prototype,"cullBackFaces",null),u([d({value:DE.FRONT_TO_BACK})],hc.prototype,"renderOrder",null),u([d()],hc.prototype,"wireframe",null),hc=u([P("esri.views.3d.terrain.TerrainRenderer")],hc);const k0t=M(),z0t=M(),fT=M(),B0t=M();let G0t=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Sf=class extends Te{constructor(e){super(e),this._handles=new Zr}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(ne(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=Ve(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(r=>!(!cO(r)||r.isRejected())&&!(r.isFulfilled()&&!j0t(r,this.viewSpatialReference,this.viewingMode))&&(e=r,!((r==null?void 0:r.type)==="vector-tile"||C4(r)))),e)if(e.isResolved()){const r=X6(e,this.viewSpatialReference,this.viewingMode);if(v(r)){const i=new Ec(r.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const r=e.when().catch(()=>{}).then(()=>{r!==this._waitTask||this.destroyed||this._update()});this._waitTask=r}_lockTilingScheme(e){if(this.viewingMode===Be.Global){const r=e.levels.length-1;e.spatialReference.isWebMercator?e=Ec.makeWebMercatorAuxiliarySphere(r):Aw(e.spatialReference)&&(e=Ec.makeGCSWithTileSize(e.spatialReference,e.pixelSize,r))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(ne(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Be.Global){const e=this.extentHelper.viewSpatialReference,r=Aw(e)||wm(e)||xm(e);e.isWebMercator?this.tilingScheme=Ec.WebMercatorAuxiliarySphere:r&&(this.tilingScheme=Ec.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;v(e)&&!iw(e,this.extent)&&(this.tilingScheme=Ec.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function j0t(t,e,r){return v(X6(t,e,r))}u([d()],Sf.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],Sf.prototype,"extent",void 0),u([d({value:!1})],Sf.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],Sf.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],Sf.prototype,"layers",void 0),u([d({constructOnly:!0})],Sf.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],Sf.prototype,"viewingMode",void 0),Sf=u([P("esri.views.3d.terrain.TilingSchemeLogic")],Sf);let H0t=class{constructor(){this.offset=Ke(),this.scale=0,this.tile=null}init(e,r,i,s){this.tile=e,this.offset[0]=r,this.offset[1]=i,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}},rr=class extends Fs.EventedMixin(Te){constructor(e){var r,i;super(e),this._scaleRangeQueries=new uN,this._iteratorPool=new Po(FCe,s=>s.remove=()=>this._iteratorPool.release(s)),this._postorderIterator=new Ngt,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visibleCached=!1,this._usedMemory=null,this._performanceInfo=new G0t,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=M(),this._eyePosSurfaceSR=M(),this._splitLimits=new r0t,this._frustum=w3(),this._viewProjectionMatrix=Ie(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new Zr,this._watchUpdatingTracking=new em,this._frameTask=mE,this._allTiles=new Kt,this._upsampleInfoPool=new Po(H0t),this._rootTilesExtent=hr(),this.updatingProgress=0,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=We.WebMercator,this.visibleElevationBounds=new rS(1/0,-1/0),this.rootTileElevationBounds=new rS(1/0,-1/0),this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this.oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this._shading=!0,this._isWebMercator=!1,this._isWebMercatorOnPlateeCarree=!1,this._isGlobal=!((i=(r=e.view)==null?void 0:r.state)!=null&&i.isLocal)}initialize(){this._lercDecoder=ogt(this.view.resourceController),this._tilePool=this.view.state.isLocal?new Po(Kyt):new Po(e0t);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",o=>o.unloadMapData()),this._elevationQueryCache=new sgt(e.newCache("elevation-query")),this._set("overlayManager",new Ml({surface:this})),this._handles.add([ne(()=>this.overlayManager.hasHighlights,o=>this._renderer.setNeedsHighlight(o)),ne(()=>this.overlayManager.rendersOccluded,o=>this._renderer.setRenderOccludedOverlay(o)),ne(()=>this.overlayManager.renderer.isEmpty,()=>this._evaluateTransparency())],"overlayManager"),this._renderer=new hc({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:Yr(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([ne(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?bn.UNFADED:bn.IMMEDIATE)},qs),ne(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?bn.UNFADED:bn.IMMEDIATE),qs),ne(()=>this.renderingDisabled,()=>{var o,a;return(a=(o=this.view)==null?void 0:o._stage)==null?void 0:a.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled})},ri),ne(()=>this.backgroundColor,o=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(o)},qs),ne(()=>this.snapLevel,()=>this._viewChanged=!0,ri),ne(()=>this.view.pointsOfInterest,o=>{this._renderer.pointsOfInterest=o,this._watchUpdatingTracking.removeAll(),o&&this._watchUpdatingTracking.add(()=>o.focus.renderLocation,()=>this._allTilesSorted=!1)}),ne(()=>Wr.TERRAIN_TILE_TREE_SHOW_TILES,o=>{o&&!this._treeDebugger?ie(()=>import("./TerrainTileTree3DDebugger-c54a3fcf.js"),["./TerrainTileTree3DDebugger-c54a3fcf.js","./TileTreeDebugger-e1d9ec89.js"],import.meta.url).then(({TerrainTileTree3DDebugger:a})=>{!this._treeDebugger&&Wr.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new a({view:this.view}))}):o||(this._treeDebugger=Ve(this._treeDebugger))},kt)]);const{spatialReference:r}=this.view;this._extentHelper=xgt(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:r});const i=new u3({getCollections:()=>{var o,a,l;return(l=(a=(o=this.view)==null?void 0:o.defaultsFromMap)==null?void 0:a.mapCollections)==null?void 0:l.map(({layers:c})=>c)},getChildrenFunction:o=>o&&"layers"in o?o.layers:null}),s=new Sf({layers:i,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",s),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Bf.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Bf.BASEMAP);const n=this.view.resourceController.scheduler;this._frameTask=n.registerTask(yt.TERRAIN_SURFACE,this),this._handles.add([ne(()=>this._extentHelper.stencilEnabledExtents,o=>this._renderer.setStencilEnabledLayerExtents(o),kt),ne(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),ri),ne(()=>this.extent,()=>this._updateRootTiles(),kt),this.view.on("resize",()=>this._viewChangeUpdate()),ne(()=>{var l,c;const o=this.view,a=o.state;return[this._lodBias,this.lodSnapping,(c=(l=o.resourceController)==null?void 0:l.memoryController)==null?void 0:c.memoryFactor,a.camera,a.contentCamera,a.fixedContentCamera]},()=>this._viewChangeUpdate(),qs),ne(()=>{var o,a;return(a=(o=this.view.qualitySettings)==null?void 0:o.tiledSurface)==null?void 0:a.textureFadeDuration},o=>this._renderer.textureFadingEnabled=o>0,kt),ne(()=>{var o;return(o=this.view.qualitySettings)==null?void 0:o.physicallyBasedRenderingEnabled},o=>this._renderer.pbrMode=o?dt.Terrain:dt.Disabled,kt),ne(()=>this._userClippingExtent,()=>this._updateClippingExtent(),ri)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._handles.add([ne(()=>{var o;return(o=this.view)==null?void 0:o.map.ground.shading},()=>{this._updateShadingIfChanged()})]),this._updateShading(),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=ji(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=Ve(this._upsampleMapCache),this._elevationQueryCache=Ve(this._elevationQueryCache);const e=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",Ve(this.tilingSchemeLogic)),e.destroy(),this._basemapLayerViewHandles.forEach((r,i)=>this._unregisterTiledLayerView(i)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Ve(this.overlayManager)),this._tilePool=Ve(this._tilePool),OK.prune(),this._treeDebugger=Ve(this._treeDebugger),this._renderer=Ve(this._renderer),this._iteratorPool=Ve(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=Ve(this._upsampleInfoPool),ygt(),hyt()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var e,r;if(this.lodSnapping===GO.ON){const i=this.view,s=this.tilingScheme,n=(r=(e=i.pointsOfInterest)==null?void 0:e.cameraOnSurface)==null?void 0:r.scale;if(n&&s){const o=i.state.contentCamera;let a=D5(i,o.eye,o.viewForward,o.up).tilt;a>90&&(a=180-a);const l=2*(a/90)**2,c=s.levelAtScale(n)-l;return Math.round(c)}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?GO.ON:GO.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:r}=this.view;if(C(r)||C(e))return null;const i=hr(),s=_Ce(r,i,e)?i:null,n=this._get("extent");return iw(s,n)?n:s}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=Ez(this.groundExtent,this._userClippingExtent,hr()),r=this._get("extent");return iw(e,r)?r:e}get groundExtent(){return v(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return(e=this.tilingSchemeLogic)==null?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view.map.ground.opacity}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return v(this._rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){var e;return((e=this.tilingScheme)==null?void 0:e.spatialReference)??null}get backgroundColor(){return this.view.map.ground.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){var e;return((e=this.tilingSchemeLogic)==null?void 0:e.tilingSchemeLocked)??!1}set velvetOverground(e){this._renderer.velvetOverground=e,this._set("velvetOverground",e)}get wireframe(){return this._renderer.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}set _visible(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.transparency===In.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get textureFadeDuration(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}intersect(e,r,i,s){this._renderer.intersect(e,r,i,s)}getElevation(e,r,i,s){const n=this._rootTiles;if(C(n)||!n.length||n[0].layerInfo[pr.ELEVATION].length===0)return null;const o=bl;return o[0]=e,o[1]=r,o[2]=i,uo(o,s,o,this._spatialReference)?Ice(n,o[0],o[1]):(se.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}getElevations(e,r,i){const s=this._rootTiles,n=s?s[0].layerInfo[pr.ELEVATION].length:0;if(!C(s)&&s.length&&n!==0)for(let o=0;o<r;++o){const a=3*o;i(o,Ice(s,e[a+0],e[a+1]))}else for(let o=0;o<r;++o)i(o,null)}getScale(e){if(!this.tilingScheme)return null;if(!ta(e,bl,this.spatialReference))return se.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const r=this._rootTiles;if(v(r)){for(const i of r)if(i!=null&&i.containsPoint(bl)){let s=i;for(;s.children[0]&&!s.rendered;){const n=s.children[0].extent;let o=0;bl[0]>n[2]&&(o+=1),bl[1]<n[1]&&(o+=2),s=s.children[o]}return this._getLodBiasCorrectedScale(s.level)}}return 1/0}getSphereElevationBounds(e,r,i,s,n){var h;if(bl[0]=e,bl[1]=r,bl[2]=i,bl[3]=s,!uo(bl,n,bl,(h=this.tilingScheme)==null?void 0:h.spatialReference))return se.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let o=1/0,a=-1/0;const l=p=>{if(p&&bee(p.extent,bl))if(p.isLeaf||p.rendered)o=Math.min(o,p.elevationBounds[0]),a=Math.max(a,p.elevationBounds[1]);else for(const f of p.children)l(f)},c=this._rootTiles;if(v(c))for(const p of c)l(p);return{min:o,max:a}}getSphereScale(e,r){if(!this.tilingScheme)return null;if(!ta(e,bl,this.spatialReference))return se.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;bl[3]=r;let i=null;const s=o=>{if(o&&bee(o.extent,bl)){const a=o.children;if(a[0]&&!o.rendered)for(const l of a)s(l);else{const l=this._getLodBiasCorrectedScale(o.level);i=i==null?l:Math.min(i,l)}}},n=this._rootTiles;if(v(n))for(const o of n)s(o);return i}queryVisibleScaleRange(e,r,i,s){const n=r?this.tilingScheme.levelAtScale(r):0,o=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,n+a,o+a,s)}_evaluateTransparency(){var o,a;const e=this.baseOpacity,r=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,s=this._allSurfaceLayersTransparent()?r?In.Empty:In.TransparentWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?In.Opaque:In.Semitransparent,n=i!==s;return n&&(this._renderer.transparency=s,(a=(o=this.view)==null?void 0:o._stage)==null||a.renderer.setParameters({terrainTransparency:this._renderer.transparency})),n}_updateTilingScheme(){var i,s,n;const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;Df(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((s=(i=this.view)==null?void 0:i.state)!=null&&s.isLocal),this.tilingScheme&&this._removeAllTiles();const r=(e==null?void 0:e.spatialReference)??We.WebMercator;this._spatialReference=r,this._isWebMercator=!!(r!=null&&r.isWebMercator),this._isWebMercatorOnPlateeCarree=this._isWebMercator&&$W((n=this.view)==null?void 0:n.renderSpatialReference),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles())}_acquireTile(e,r,i,s){const n=this._tilePool.acquire();return Y$[0]=e,Y$[1]=r,Y$[2]=i,n.init(Y$,s,this),n}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:r}=this;if(!r)return;const i=X0t;let s=r.rootTilesInExtent(e,i,5*j2);if(v(this._rootTiles)){if(s.length>j2)return void se.getLogger(this.declaredClass).warn(CZe);const n=this._rootTiles.map(a=>a.lij),o=KOe(n,s,Pce);if(this._updatingRootTiles=!0,o.removed.length>0||o.added.length>0){const a=this._rootTiles.filter(l=>!(o.removed.findIndex(c=>Pce(c,l.lij))>-1)||(this._purgeTile(l),!1));o.added.forEach(l=>a.push(this._newRootTile(l))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,s.length>j2&&(se.getLogger(this.declaredClass).warn(AZe),s=r.rootTilesInExtent(e,i,j2)),this._setRootTiles(s.map(n=>this._newRootTile(n)));iw(i,this._rootTilesExtent)||(this._rootTilesExtent=hr(i)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(r=>r.isLoaded&&r.intersectsClippingArea);e.forEach(r=>this._renderer.updateTileGeometryState(r)),e.forEach(r=>r.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(e.length===0)return;e.sort(ey);const r=this.renderer;e.forEach(i=>r.updateGeometryIfNeeded(i)),e.forEach(i=>this._pendingTilesForElevationUpdateEvent.add(i))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===Ct.SPLIT}_newRootTile(e){const r=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(r)&&r.setPendingUpdate(Ct.SPLIT),this._loadTile(r),this._markTileToUpdate(r),this._updateRootTileElevationBounds(),r}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),v(e)){const r=this._iteratorPool.acquire();for(r.reset(e);!r.done;)this._allTiles.push(r.next());r.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(Ct.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(C(e))return;const r=Ggt(e),i=this.visibleElevationBounds;let s=r?i.min:1/0,n=r?i.max:-1/0;const o=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){const c=l.next();c.updateClippingStatus(o)&&c.resetPendingUpdate(Ct.GEOMETRY)&&this._updateTileGeometryState(c),c.setPendingUpdate(Ct.RENDERDATA),c.computeVisibility(),c.updateScreenDepth(a),c.renderData&&(s=Math.min(c.elevationBounds[0],s),n=Math.max(c.elevationBounds[1],n))}l.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(s)&&isFinite(n)&&(i.min!==s||i.max!==n)&&(this.visibleElevationBounds=new rS(s,n))}_updateRootTileElevationBounds(){let e=1/0,r=-1/0;const i=this._rootTiles;v(i)&&i.forEach(({elevationBounds:n})=>{e=Math.min(e,n[0]),r=Math.max(r,n[1])});const s=this.rootTileElevationBounds;s.min===e&&s.max===r||(this.rootTileElevationBounds=new rS(e,r))}_updateViewDependentParameters(){const{camera:e,contentCamera:r}=this.view.state,i=Math.tan(.5*r.fovX),s=Math.tan(.5*r.fovY),n=this.tilingScheme.pixelSize,o=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=n/e.width*this.maxTextureScale*o,this._splitLimits.relativeHeightLimit=n/e.height*this.maxTextureScale*o,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(C(this._splitLimits.frustum)&&(this._splitLimits.frustum=w3()),hF(this._splitLimits.frustum,r.frustum)):this._splitLimits.frustum=null,hF(this._frustum,e.frustum),ys(this._viewProjectionMatrix,r.projectionMatrix,r.viewMatrix),le(this._eyePosRenderSR,r.eye),uo(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(vAe(e)?this._loadChildren(e):W0t(e)&&this._loadParent(e))}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForGeometryUpdate(e){const r=this._pendingTilesToUpdate;e.forEachLoadedNeighbor(i=>{r.add(i)})}_updateTileTexture(e,r){const i=e.resetPendingUpdate(Ct.TEXTURE_FADING)?Ct.TEXTURE_FADING:!!e.resetPendingUpdate(Ct.TEXTURE_NOFADING)&&Ct.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,r.madeProgress())}_emitElevationUpdateEventForTiles(){const e=YV.extent;Xh(e),this._pendingTilesForElevationUpdateEvent.forEach(r=>z_(e,r.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),YV.spatialReference=this.spatialReference,this.emit("elevation-change",YV)}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const r=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,r),this._updateElevation(e),this._updateTextures(e),r||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed?this.requestUpdate():this.getUsedMemory(),this.notifyChange("updatingProgressValue")}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const r=this._iteratorPool.acquire();r.reset(this._rootTiles);const i=this.snapLevel,s=this._splitLimits,n=this._eyePosRenderSR;for(;!r.done;){const o=r.next(),a=o.shouldSplit(s,n,i);if(a!==Ct.SPLIT){if(o.resetPendingUpdate(Ct.SPLIT)&&o.updateAgentSuspension(),a===Ct.VSPLITMERGE&&o.updateAgents(pr.ELEVATION),r.skipSubtree(),!o.isLeaf){o.setPendingUpdate(Ct.MERGE),o.resetPendingUpdate(Ct.SPLIT);const l=this._iteratorPool.acquire();l.resetOne(o);const c=this._viewProjectionMatrix;for(let h=l.next();!l.done;h=l.next())this._updateClippingStatus(h),h.updateVisibility(),h.updateScreenDepth(c);l.remove()}}else o.resetPendingUpdate(Ct.MERGE),o.isLeaf&&(o.setPendingUpdate(Ct.SPLIT),r.skipSubtree()),o.rendered&&o.setPendingUpdate(Ct.RENDERDATA)}r.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(zgt(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){Re(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))}_batchUpdatePendingTileGeometries(){const e=this._pendingTilesToUpdate;if(e.size===0)return;const r=Array.from(this._pendingTilesToUpdate.keys()).filter(n=>n.isLoaded&&n.intersectsClippingArea),i=(n,o)=>{!(o!=null&&o.isLoaded)||!o.intersectsClippingArea||o.level<n.level||e.has(o)||(e.add(o),r.push(o),o.renderData.updateNeighborData())};r.sort(ey);const s=r.length;for(let n=0;n<s;++n){const o=r[n];Re(o.isLoaded),Re(o.intersectsClippingArea);const a=o.renderData;a.updateNeighborData();const l=a._dirtyEdgeResolutions,c=a.geometryState.neighborData;for(let h=0;h<4;++h)if(l&1<<h){const p=a.geometryState.neighborData.edgePeerNeighbors[h];p&&(p==null?void 0:p.level)>=o.level&&p.forAllSubtreeOnSide(R4(Xf[h]),f=>!(!f.isLoaded||!f.intersectsClippingArea)&&(Re(e.has(f)||ey(o,f)<0),i(o,f),!0)),i(o,c.cornerPeerNeighbors[h]),i(o,c.cornerPeerNeighbors[(h+1)%4])}}e.clear(),this._updateTilesGeometries(r),En&&E4&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,r){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const s=this.view.state.fixedContentCamera;let n=!1;for(;!e.done;){n=!0;let o=!1;const a=!this._allTiles.some(l=>{var h;if(!i&&!s&&!l.visible)return e.done;let c=l;if(l.resetPendingUpdate(Ct.MERGE)){if(!r)return l.setPendingUpdate(Ct.MERGE),e.done;for(;(h=c.parent)!=null&&h.resetPendingUpdate(Ct.MERGE);)c=c.parent;this._mergeTile(c),o=!0,e.madeProgress()}else l.resetPendingUpdate(Ct.SPLIT)&&(this._splitTile(l),o=!0,e.madeProgress());return!e.done&&c===l&&l.resetPendingUpdate(Ct.RENDERDATA)&&(this._updateRenderData(l),e.madeProgress()),e.done});if(o&&(this._allTilesSorted=!1,this._allTilesDirty=!0),a){if(!i){i=!0;continue}if(!o)break}else this._allTilesDirty=!0}n?e.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(r=>(r.resetPendingUpdate(Ct.GEOMETRY)&&(this._updateTileGeometryState(r),this._updateTileTexture(r,e),this.shortBatches&&this._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done)),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(r=>(this._updateTileTexture(r,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Ps.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*SZe}_getLodBiasCorrectedScale(e){const r=this.tilingScheme.levels,i=ye(e-this._lodBias,0,r.length-1),s=i-Math.floor(i);return r[Math.floor(i)].scale*(1-s)+r[Math.ceil(i)].scale*s}_removeAllTiles(){v(this._rootTiles)&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return!1;let r=!1;for(let i=0;i<4;++i)r=this._purgeTile(e.children[i])||r;return e.unsetChildren(),r}_purgeTile(e){const r=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),r}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){Df(e.isLeaf,"tile that is already split should not be split again!");const r=e.level+1,i=2*e.lij[1],s=2*e.lij[2];e.setChildren(this._createTile(r,i,s,e),this._createTile(r,i,s+1,e),this._createTile(r,i+1,s,e),this._createTile(r,i+1,s+1,e)),e.setPendingUpdate(Ct.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}_emitTileScaleChange(e,r=e.level){Z$.spatialReference=this.spatialReference,Z$.extent=e.extent,Z$.scale=this._getLodBiasCorrectedScale(r),this.emit("scale-change",Z$)}_createTile(e,r,i,s){Df(!!s,"_createTile sanity check");const n=this._acquireTile(e,r,i,s);return n.updateClippingStatus(this.extent),n.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(n)&&n.setPendingUpdate(Ct.SPLIT),n}get shortBatches(){return this.view.state.mode!==Tr.IDLE}_mergeTile(e){Df(!e.hasPendingUpdate(Ct.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(Df(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}_loadChildren(e){Df(e.rendered,"parent should be rendered"),this._unloadTile(e);const r=e.children;r.forEach(i=>this._loadTile(i)),r.forEach(i=>this._pendingTilesToUpdate.add(i)),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_loadParent(e){const r=e.parent;this._unloadChildren(r),this._loadTile(r),this._markTileToUpdate(r),this._emitTileScaleChange(r,r.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_unloadChildren(e){const r=e.children;if(r[0])for(let i=0;i<4;++i){const s=r[i];this._unloadChildren(s),this._unloadTile(s)}}_loadTile(e){e.load(),e.setPendingUpdate(Ct.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_elevationDataArrived(e,r,i){const s=new bgt(e.lij,e.extent,i);e.dataArrived(r,pr.ELEVATION,s);const n=[e],o=e.level,a=this._iteratorPool.acquire();for(a.reset(n);!a.done;){const l=a.next();l.findElevationBoundsForLayer(r,o),l.computeElevationBounds()}o===0&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(n)}_handleLayerViewChanges(e=Ja){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let r=!1;const i=new Set;let s=-1;for(const n of this.view.allLayerViews.items)if(i.add(n.uid),sM(n)||gA(n))if(this._basemapLayerViewHandles.has(n.uid)&&!gA(n)){const o=this._layerClassFromLayerView(n),a=this._getLayerIdxByUID(o,n.uid);v(a)&&((a<s||C(s))&&(r=!0),s=a)}else this._registerTiledLayerView(n),n.layer.loaded&&(r=!0);this._basemapLayerViewHandles.forEach((n,o)=>{i.has(o)||(this._unregisterTiledLayerView(o),r=!0)}),r&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){var r,i;let e=((i=(r=this.view.map)==null?void 0:r.ground)==null?void 0:i.opacity)===0;for(const s of this.view.allLayerViews.items)if(yq(s)&&!Mpe(s.layer)&&s.fullOpacity!==0)return e=!1,e;return e}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((A4(e)||gA(e))&&Ygt(Tq[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return gq(e)?pr.ELEVATION:pr.MAP}_registerTiledLayerView(e){const r=[];if((A4(e)||gA(e))&&r.push(ne(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(bn.UNFADED)})),gA(e))return;const i=this._layerClassFromLayerView(e);r.push(ne(()=>e.suspended,()=>this._updateTiledLayers())),r.push(ne(()=>e.fullOpacity,()=>this._updateTileTextures(bn.UNFADED))),r.push(ne(()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null,()=>this._restartAllAgents(i))),e.on("data-changed",()=>{const s=this._getLayerIdxByUID(i,e.uid);v(s)&&this._invalidateLayerData(s,i)}),this._basemapLayerViewHandles.set(e.uid,r)}_unregisterTiledLayerView(e){const r=this._basemapLayerViewHandles.get(e);if(r){for(let i=0;i<r.length;i++)r[i].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,r=[[],[]];let i=null;e.forEach(s=>{if(!s.layer||s.suspended||!sM(s)||!s.fullExtent)return;const n=this._layerClassFromLayerView(s);if(n===pr.MAP){const o=s.displayLevelRange.maxLevel;o!==1/0&&(i===null||o>i)&&(i=o)}r[n].push(s)});for(const s of yb){const n=this._layerViews[s],o=r[s];o.reverse();const a=o.length;let l=n.length!==a;const c=new Array(a),h=new Array(n.length);this._layerIndexByUid[s].clear();for(let p=0;p<a;p++){const f=o[p].uid;this._layerIndexByUid[s].set(f,p);const m=n.indexOf(o[p]);c[p]=m,p!==m&&(l=!0),m>-1&&(h[m]=p)}if(l){const p=this._postorderIterator;for(p.reset(this._rootTiles);!p.done;)p.next().modifyLayers(h,c,s);this._layerViews[s]=o,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const r=this._postorderIterator;for(r.reset(this._rootTiles);!r.done;){const i=r.next();i.restartAgents(e),e===pr.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,r){return this._layerViews[r][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(r=>{r.updateAgents(pr.MAP),e===bn.IMMEDIATE?this.renderer.updateTileTexture(r,Ct.TEXTURE_NOFADING):r.updateRenderData(pr.MAP,e)}),this._evaluateTransparency()}_invalidateLayerData(e,r){this._allTiles.forAll(i=>i.removeLayerAgent(e,r)),this._allTiles.forAll(i=>i.invalidateLayerData(e,r))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=Ps.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,r,i,s){const n=this.layerViewByIndex(r,i),o=n.layer;return!o.tilemapCache||iM(n)?this._requestTileData(e,i,n,s):(++this._asyncWorkItems,o.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...s,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,ur(s),Ks(a)||this._dataMissing(e,i,n,{notInTilemap:!0}),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,n,s),s.signal)))}_requestTileData(e,r,i,s){return r===pr.ELEVATION?gq(i)?this._requestElevationTileData(e,i,s):Promise.reject():yq(i)?this._requestMapTileData(e,i,s):Promise.reject()}_requestElevationTileData(e,r,i){++this._asyncWorkItems;const s=a=>{if(Fn(i))return;const l=this._layerIndexByUid[pr.ELEVATION].get(r.uid);l!=null?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,l,a)):se.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",pr.ELEVATION,e.lij.toString())},n=a=>{Ks(a)||(this._dataMissing(e,pr.ELEVATION,r,a),this.requestUpdate())};if(Yle(r.layer))return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:I3,signal:i.signal}).then(a=>{if(!Fn(i))return this._frameTask.schedule(()=>s(a),i.signal,n);se.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")},n).finally(()=>{--this._asyncWorkItems});const o=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(o,"binary",i).then(a=>this._lercDecoder.decode(a,{noDataValue:I3},i.signal)).then(a=>{a?s(new ngt(a)):n(new Error("LERC decoding failed"))},n).finally(()=>{--this._asyncWorkItems})}_requestMapTileData(e,r,i){++this._asyncWorkItems;const s=(h,p)=>{--this._asyncWorkItems,MS(p),Fn(i)||(this._dataMissing(e,pr.MAP,r,h),this.requestUpdate())},n=h=>p=>s(p,h),o=h=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Fn(i)?MS(h):this._mapTileDataArrived(e,r,h)},i.signal,n(h)).catch(n(h)),a=(h,p=null)=>this._frameTask.schedule(()=>s(h,p));if(iM(r)){const h=r.schemaHelper.getLevelRowColumn(e.lij);return r.fetchTile(h[0],h[1],h[2],i).then(o,a)}if(W6(r))return r.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(o,a);if(SK(r)&&Yle(r.layer))return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(h=>{if(Fn(i))return se.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(qr());o(h)},a);let l=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);MXe(r.layer)&&r.layer.refreshTimestamp&&(l+=`${l.includes("?")?"&":"?"}_ts=${r.layer.refreshTimestamp}`);const c=r.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,c,i).then(o,a)}_mapTileDataArrived(e,r,i){const s=this._getLayerIdxByUID(pr.MAP,r.uid);v(s)?e.dataArrived(s,pr.MAP,i):(MS(i),se.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,r){return this._layerIndexByUid[e].get(r)}_dataMissing(e,r,i,s){const n=this._getLayerIdxByUID(r,i.uid);v(n)?e.dataMissing(n,r,s):se.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(r=>{r.renderData&&this.overlayManager.setTileParameters(r)}),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(r=>{r.isLeaf&&e.numLeaves++;const i=r.level;r.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),r.visible&&(e.numVisible++,r.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}getUsedMemory(){return this.tilingScheme?(C(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),v(this._usedMemory)?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce((e,r)=>e+r.usedMemory,0):null}getUsedMemoryForLayerView(e){let r=0;const i=this._layerClassFromLayerView(e),s=this._getLayerIdxByUID(i,e.uid);return v(s)&&this._allTiles.forAll(n=>r+=n.getUsedMemoryForLayer(i,s)),r}getTile(e){if(C(e)||C(this._rootTiles))return null;const r=e.split("/").map(a=>+a);if(r[0]===0)return this._rootTiles.find(a=>a.lij[1]===r[1]&&a.lij[2]===r[2]);const i=2**r[0],s=Math.floor(r[1]/i),n=Math.floor(r[2]/i);let o;if(this._rootTiles.some(a=>a.lij[1]===s&&a.lij[2]===n&&(o=a,!0)),o){let a=1<<r[0]-1;for(;o.lij[0]<r[0];){let l=r[1]&a?2:0;if((r[2]&a)>0&&l++,!o.children[l])return null;o=o.children[l],a>>=1}return Df(o.lij[0]===r[0]&&o.lij[1]===r[1]&&o.lij[2]===r[2],"not the right tile?"),o}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{v(e._rootTiles)&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){XV.clear(),e._allTiles.forAll(i=>{i.visible&&i.rendered&&XV.push(i)});const r=XV.toArray();return UCe(e.renderOrder,r),r},lockTilingScheme(r,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(r)}}}checkAllTilesWaterproofness(){if(!E4)return;const e=this._rootTiles;if(C(e))return;const r=o=>{var a,l,c;return((c=(l=(a=o==null?void 0:o.renderData)==null?void 0:a.geometryInfo)==null?void 0:l.indices)==null?void 0:c.length)>0},i=(o,a)=>{r(o)&&console.error("Tile[",o.lij,"] has geometry although parent[",a.lij,"] has geom")},s=o=>{var a,l;if(o.intersectsClippingArea)if(o.renderData&&!o.renderData.geometryState&&console.error("Tile[",o.lij,"] has renderData but not geometryState"),o.renderData&&!o.renderData.geometryInfo&&console.error("Tile[",o.lij,"] has renderData but not geometryInfo"),!((a=o.renderData)!=null&&a.geometryInfo)||(((l=o.renderData.geometryInfo.indices)==null?void 0:l.length)??0)>0||console.error("Tile[",o.lij,"] has renderData but no indices - geometryInfo: ",o.renderData.geometryInfo),r(o)){o.checkGeometryWaterproofness();for(const c of o.children)i(c,o)}else if(o.isLeaf)console.error("Tile[",o.lij,"] has no geometry and no children, from root to leaf");else for(const c of o.children)s(c)},n=o=>{var h;const a=((h=o.parent)==null?void 0:h.visible)??!0,l=o.visible;o.computeVisibility();const c=o.visible;if(l!==c&&a&&console.error(" Tile[",o.lij,"] has out of date visibility: ",l," instead of ",c),!o.isLeaf)for(const p of o.children)n(p)};for(const o of e)s(o),n(o)}get isGlobal(){return this._isGlobal}get shading(){return this._shading}_updateShadingIfChanged(){var r,i,s;((s=(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.ground)==null?void 0:s.shading)!==this._shading&&this._updateShading()}_updateShading(){var r,i,s;const e=(s=(i=(r=this.view)==null?void 0:r.map)==null?void 0:i.ground)==null?void 0:s.shading;this._shading=e,this.renderer&&(this.renderer.shading=e,this.renderer.setNeedsRender()),this._updateAllTileGeometries()}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateeCarree(){return this._isWebMercatorOnPlateeCarree}isEastEndWrap(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this.isGlobal&&e[2]===0}lijEastEnd(e){return 2**(e+(v(this.spatialReference)&&this.spatialReference.isGeographic?1:0))}wrapEastWest(e){const r=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<r)return e;if(!this.isGlobal)return null;const s=(i+(i<0?r:0))%r;return[e[0],e[1],s]}enableInternalChecks(e){Amt(e)}enableWaterproofnessChecks(e){Cmt(e)}};u([d()],rr.prototype,"_renderer",void 0),u([d({constructOnly:!0})],rr.prototype,"_scaleRangeQueries",void 0),u([d()],rr.prototype,"_hasPendingUpdates",void 0),u([d()],rr.prototype,"_asyncWorkItems",void 0),u([d()],rr.prototype,"_allTilesDirty",void 0),u([d()],rr.prototype,"_allTilesSorted",void 0),u([d()],rr.prototype,"_viewChanged",void 0),u([d({readOnly:!0})],rr.prototype,"_watchUpdatingTracking",void 0),u([d()],rr.prototype,"_frameTask",void 0),u([d({readOnly:!0})],rr.prototype,"snapLevel",null),u([d({readOnly:!0})],rr.prototype,"lodSnapping",null),u([d({constructOnly:!0})],rr.prototype,"view",void 0),u([d()],rr.prototype,"_userClippingExtent",null),u([d()],rr.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],rr.prototype,"extent",null),u([d({readOnly:!0})],rr.prototype,"groundExtent",null),u([d({readOnly:!0})],rr.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],rr.prototype,"updating",null),u([d({readOnly:!0})],rr.prototype,"running",null),u([d(_gt)],rr.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],rr.prototype,"updatingProgressValue",null),u([d()],rr.prototype,"_maxNumUpdating",void 0),u([d()],rr.prototype,"baseOpacity",null),u([d()],rr.prototype,"hasCompositeBlendMode",void 0),u([d({readOnly:!0})],rr.prototype,"overlayManager",void 0),u([d({readOnly:!0})],rr.prototype,"viewingMode",null),u([d()],rr.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],rr.prototype,"ready",null),u([d({value:DE.FRONT_TO_BACK})],rr.prototype,"renderOrder",null),u([d({readOnly:!0})],rr.prototype,"rootTiles",null),u([d()],rr.prototype,"_rootTiles",void 0),u([d({readOnly:!0})],rr.prototype,"spatialReference",null),u([d({type:Ze})],rr.prototype,"backgroundColor",null),u([d({value:!1})],rr.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],rr.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],rr.prototype,"tilingSchemeLocked",null),u([d({readOnly:!0})],rr.prototype,"tilingSchemeLogic",void 0),u([d({value:!0})],rr.prototype,"velvetOverground",null),u([d()],rr.prototype,"wireframe",null),u([d({value:!1})],rr.prototype,"suspended",null),u([d()],rr.prototype,"textureFadeDuration",null),u([d()],rr.prototype,"visibleElevationBounds",void 0),u([d()],rr.prototype,"rootTileElevationBounds",void 0),u([d()],rr.prototype,"_layerViewsDirty",void 0),u([d()],rr.prototype,"renderPatchBorders",null),u([d()],rr.prototype,"visualizeNormals",null),u([d()],rr.prototype,"renderingDisabled",null),rr=u([P("esri.views.3d.terrain.TerrainSurface")],rr);const q0t=rr;function Pce(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function vAe(t){const e=t.children;if(!e[0])return!1;for(const r of e)if(r.shouldLoad)return!0;for(const r of e)if(vAe(r))return!0;return!1}function W0t(t){var e;return t.isLeaf&&(((e=t.parent)==null?void 0:e.shouldLoad)??!1)}const bl=nr(),X0t=hr(),Y$=[0,0,0],XV=new Kt,YV={spatialReference:null,extent:hr(),context:"ground"},Z$={spatialReference:null,extent:null,scale:0};function Ice(t,e,r){var i;for(const s of t){if(!s.containsPointXY(e,r))continue;let n=s;for(;n&&!n.renderData;){const a=(e>n.extentMidX?1:0)+(r<n.extentMidY?2:0);n=n.children[a]}const o=((i=n==null?void 0:n.renderData)==null?void 0:i.geometryState.samplerData)??null;return Hi(e,r,o)}return null}let Y0t=class{constructor(e,r,i){this.operation=e,this.geometry=r,this.states=i}},JR=class extends Te{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,r){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((s,n)=>{const o=this._ensureGeomRecord(e,n);s.forEach(({geometry:a,operation:l,states:c},h)=>{let p=!1;if(l===os.UPDATE){const f=o.get(h);if(f){if(c&Ln.TRANSFORMATION){const m=this.model.getObject(n);this.model.updateRenderGeometryTransformation(m,a,f)&&(p=!0)}p||r.updates.push({renderGeometry:f,updateType:c})}else gt(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(l===os.REMOVE||p){const f=o.get(h);f?(r.removes.push(f),o.delete(h)):l===os.REMOVE&&gt(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(l===os.ADD||p){const f=this.model.getObject(n);if(v(f)){const m=this.model.getRenderGeometry(f,a);r.adds.push(m),o.set(h,m)}}}),o.size===0&&this._residentGeomRecords.get(e).delete(n)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}getResidentRenderGeometries(e,r){const i=this._residentGeomRecords.get(e);i&&i.forEach(s=>s.forEach(n=>r.push(n)))}_objectStateChanged(e,r){for(const i of r.geometries)this._updateOrCreateDirtyRecord(r,i,null,os.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Ln.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Ln.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Ln.OCCLUDEE,e)}objectGeometryUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,os.UPDATE,Ln.GEOMETRY)}layerAdded(e){e.objects.forAll(r=>this._layerObjectAdded(e,r))}layerRemoved(e){e.objects.forAll(r=>this._layerObjectRemoved(e,r))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,r){const i=e.id;for(const s of r.geometries)this._objectGeometryAdded(r,s,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const r of e.objects)this._layerObjectAdded(e.layer,r)}layerObjectsRemoved(e){for(const r of e.objects)this._layerObjectRemoved(e.layer,r)}_layerObjectRemoved(e,r){const i=e.id;for(const s of r.geometries)this._objectGeometryRemoved(r,s,i)}shaderTransformationChanged(e){const r=this._residentGeomRecords.get(e.id);r&&r.forEach((i,s)=>{const n=this.model.getObject(s);n&&n.hasVolativeTransformation()&&i.forEach(o=>o.shaderTransformationChanged())})}objectTransformation(e){const r=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(r,i).forEach(s=>{this._updateOrCreateDirtyRecord(e,s.geometry,r,os.UPDATE,Ln.TRANSFORMATION)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.geometry)}_objectGeometryAdded(e,r,i=null){this._updateOrCreateDirtyRecord(e,r,i,os.ADD)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.geometry)}_objectGeometryRemoved(e,r,i=null){this._updateOrCreateDirtyRecord(e,r,i,os.REMOVE)}_updateOrCreateDirtyRecord(e,r,i,s,n=Ln.NONE){i=It(i,this._getParentLayerId(e));const o=e.id,a=r.id,l=this._ensureDirtyRecord(i,o),c=l.get(a);if(c){const h=c.operation;h===os.REMOVE&&s===os.ADD&&c.states!==Ln.NONE?c.operation=os.UPDATE:h===os.REMOVE&&s===os.ADD||h===os.ADD&&s===os.REMOVE?l.delete(a):h!==os.UPDATE||s!==os.REMOVE&&s!==os.UPDATE?(gt((h===os.REMOVE||h===os.ADD)&&s===os.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=n):(c.operation=s,c.states|=n)}else l.set(a,new Y0t(s,r,n));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,r){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s}get _hasDirtyGeometryRecords(){return Yo(this._dirtyGeomRecords,e=>Yo(e,r=>r&&r.size>0))}_ensureDirtyRecord(e,r){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s}_getParentLayerId(e){return v(e.parentLayer)?e.parentLayer.id:PMe}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let r="";return this._dirtyGeomRecords.forEach((i,s)=>{i.forEach((n,o)=>{r.length>0&&(r+=`
`),r+=s+"."+o;const a=[];n.forEach(l=>{const c=l.operation;a[c]||(a[c]=[]),a[c].push(l.geometry.id)});for(let l=0;l<a.length;l++)if(a[l]){r+=" "+e[l-1]+": ";for(let c=0;c<a[l].length;c++)r+=a[l][c]+", "}})}),r}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((r,i)=>r+i.size,0)},commit:r=>e._dirtyGeomRecords.forEach((i,s)=>e.commitLayer(s,r))}}};u([d({constructOnly:!0})],JR.prototype,"model",void 0),u([d()],JR.prototype,"dirty",void 0),JR=u([P("esri.views.3d.webgl-engine.lib.ModelDirtySet")],JR);const Z0t=JR;let pN=class extends Te{constructor(){super(...arguments),this.dirtySet=new Z0t({model:this}),this._content=new Map,this._originFactory=new tK(null)}getObject(e){return this._content.get(e)}add(e){const r=e.id;gt(!this._content.has(r),"Model/Stage already contains object to be added"),this._content.set(r,e),m4(e)&&this.dirtySet.layerAdded(e)}remove(e){gt(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),m4(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const r of e)v(r)&&(gt(!this._content.has(r.id),"Model/Stage already contains object to be added"),this._content.set(r.id,r))}removeMany(e){for(const r of e)gt(this._content.has(r.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(r.id),r.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,r){this._content.forEach(i=>{i.type===e&&r(i)})}getRenderGeometry(e,r){const{shaderTransformer:i,localOrigin:s}=r,n=new LE(r,{boundingInfo:r.boundingInfo,shaderTransformer:i,castShadow:e.castShadow});return n.updateTransformation(o=>e.getCombinedStaticTransformation(r,o)),n.localOrigin=v(s)?s:this._originFactory.getOrigin(n.boundingSphere),n}updateRenderGeometryTransformation(e,r,i){if(C(e))return!1;i.updateTransformation(n=>e.getCombinedStaticTransformation(r,n));const s=this._originFactory.getOrigin(i.boundingSphere);return i.localOrigin!==s}getStats(){const e={},r=Array.from(this._content.values());for(let i=0;i<$s.COUNT;++i)e[i]=r.filter(s=>s.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],pN.prototype,"dirtySet",void 0),pN=u([P("esri.views.3d.webgl-engine.parts.Model")],pN);function J0t(){const t=new Float32Array(4);return t[3]=1,t}function bAe(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function K0t(t,e,r,i){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function wAe(t,e){return new Float32Array(t,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:bAe,create:J0t,createView:wAe,fromValues:K0t},Symbol.toStringTag,{value:"Module"}));const NE=1e-6,wA=[0,0,0],J$=[0,0,0];function Q0t(t,e){const{data:r,size:i}=t,s=r.length/i;if(s<=0)return;const n=new l_t(t);fN(wA,n.minProj,n.maxProj),Vb(wA,wA,.5),Ph(J$,n.maxProj,n.minProj);const o=Oq(J$),a=new c_t;a.quality=o,s<14&&(t=new Ye(new Float64Array(n.buffer,112,42),3));const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],m=[0,0,0],y=[0,0,0];switch(e_t(n,t,y,l,c,h,p,f,m,a)){case 1:return void Nce(wA,J$,e);case 2:return void a_t(t,p,e)}t_t(t,y,l,c,h,p,f,m,a),xAe(t,a.b0,a.b1,a.b2,$S,LS);const _=[0,0,0];Ph(_,LS,$S),a.quality=Oq(_),a.quality<o?TAe(a.b0,a.b1,a.b2,$S,LS,_,e):Nce(wA,J$,e)}function e_t(t,e,r,i,s,n,o,a,l,c){return r_t(t,i,s),Mq(i,s)<NE?1:(Ph(o,i,s),Ho(o,o),i_t(e,i,o,n)<NE?2:(Ph(a,s,n),Ho(a,a),Ph(l,n,i),Ho(l,l),Ih(r,a,o),Ho(r,r),_b(e,r,o,a,l,c),0))}const xA=[0,0,0],TA=[0,0,0],eh=[0,0,0],th=[0,0,0],rh=[0,0,0],m0=[0,0,0],g0=[0,0,0],y0=[0,0,0];function t_t(t,e,r,i,s,n,o,a,l){s_t(t,e,r,xA,TA),xA[0]!==void 0&&(Ph(eh,xA,r),Ho(eh,eh),Ph(th,xA,i),Ho(th,th),Ph(rh,xA,s),Ho(rh,rh),Ih(m0,th,n),Ho(m0,m0),Ih(g0,rh,o),Ho(g0,g0),Ih(y0,eh,a),Ho(y0,y0),_b(t,m0,n,th,eh,l),_b(t,g0,o,rh,th,l),_b(t,y0,a,eh,rh,l)),TA[0]!==void 0&&(Ph(eh,TA,r),Ho(eh,eh),Ph(th,TA,i),Ho(th,th),Ph(rh,TA,s),Ho(rh,rh),Ih(m0,th,n),Ho(m0,m0),Ih(g0,rh,o),Ho(g0,g0),Ih(y0,eh,a),Ho(y0,y0),_b(t,m0,n,th,eh,l),_b(t,g0,o,rh,th,l),_b(t,y0,a,eh,rh,l))}function r_t(t,e,r){let i=Mq(t.maxVert[0],t.minVert[0]),s=0;for(let n=1;n<7;++n){const o=Mq(t.maxVert[n],t.minVert[n]);o>i&&(i=o,s=n)}Ic(e,t.minVert[s]),Ic(r,t.maxVert[s])}const ih=[0,0,0];function i_t(t,e,r,i){const{data:s,size:n}=t;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){ih[0]=s[l]-e[0],ih[1]=s[l+1]-e[1],ih[2]=s[l+2]-e[2];const c=r[0]*ih[0]+r[1]*ih[1]+r[2]*ih[2],h=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],p=ih[0]*ih[0]+ih[1]*ih[1]+ih[2]*ih[2]-c*c/h;p>o&&(o=p,a=l)}return Ic(i,s,a),o}const $n=[0,0];function s_t(t,e,r,i,s){o_t(t,e,$n,s,i);const n=EAe(r,e);$n[1]-NE<=n&&(i[0]=void 0),$n[0]+NE>=n&&(s[0]=void 0)}const $ce=[0,0,0],Lce=[0,0,0],Dce=[0,0,0],mT=[0,0,0],gT=[0,0,0],K$=[0,0,0];function _b(t,e,r,i,s,n){if(SAe(e)<NE)return;Ih($ce,r,e),Ih(Lce,i,e),Ih(Dce,s,e),IS(t,e,$n),gT[1]=$n[0],mT[1]=$n[1],K$[1]=mT[1]-gT[1];const o=[r,i,s],a=[$ce,Lce,Dce];for(let l=0;l<3;++l){IS(t,o[l],$n),gT[0]=$n[0],mT[0]=$n[1],IS(t,a[l],$n),gT[2]=$n[0],mT[2]=$n[1],K$[0]=mT[0]-gT[0],K$[2]=mT[2]-gT[2];const c=Oq(K$);c<n.quality&&(Ic(n.b0,o[l]),Ic(n.b1,e),Ic(n.b2,a[l]),n.quality=c)}}const n_t=[0,0,0];function IS(t,e,r){const{data:i,size:s}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<i.length;n+=s){const o=i[n]*e[0]+i[n+1]*e[1]+i[n+2]*e[2];r[0]=Math.min(r[0],o),r[1]=Math.max(r[1],o)}}function o_t(t,e,r,i,s){const{data:n,size:o}=t;Ic(i,n),Ic(s,i),r[0]=EAe(n_t,e),r[1]=r[0];for(let a=o;a<n.length;a+=o){const l=n[a]*e[0]+n[a+1]*e[1]+n[a+2]*e[2];l<r[0]&&(r[0]=l,Ic(i,n,a)),l>r[1]&&(r[1]=l,Ic(s,n,a))}}function Nce(t,e,r){Ic(r.center,t),Vb(r.halfSize,e,.5),r.quaternion[0]=0,r.quaternion[1]=0,r.quaternion[2]=0,r.quaternion[3]=1}const Qm=[0,0,0],yT=[0,0,0],SA=[0,0,0],$S=[0,0,0],LS=[0,0,0],Fce=[0,0,0];function a_t(t,e,r){Ic(Qm,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?Qm[0]=0:Math.abs(e[1])>Math.abs(e[2])?Qm[1]=0:Qm[2]=0,SAe(Qm)<NE&&(Qm[0]=Qm[1]=Qm[2]=1),Ih(yT,e,Qm),Ho(yT,yT),Ih(SA,e,yT),Ho(SA,SA),xAe(t,e,yT,SA,$S,LS),Ph(Fce,LS,$S),TAe(e,yT,SA,$S,LS,Fce,r)}function xAe(t,e,r,i,s,n){IS(t,e,$n),s[0]=$n[0],n[0]=$n[1],IS(t,r,$n),s[1]=$n[0],n[1]=$n[1],IS(t,i,$n),s[2]=$n[0],n[2]=$n[1]}const Q$=[0,0,0],Kp=[1,0,0,0,1,0,0,0,1],_T=[0,0,0];function TAe(t,e,r,i,s,n,o){Kp[0]=t[0],Kp[1]=t[1],Kp[2]=t[2],Kp[3]=e[0],Kp[4]=e[1],Kp[5]=e[2],Kp[6]=r[0],Kp[7]=r[1],Kp[8]=r[2],u_t(o.quaternion,Kp),fN(_T,i,s),Vb(_T,_T,.5),Vb(o.center,t,_T[0]),Vb(Q$,e,_T[1]),fN(o.center,o.center,Q$),Vb(Q$,r,_T[2]),fN(o.center,o.center,Q$),Vb(o.halfSize,n,.5)}const tu=7;let l_t=class{constructor(e){this.minVert=new Array(tu),this.maxVert=new Array(tu);const r=64*tu;this.buffer=new ArrayBuffer(r);let i=0;this.minProj=new Float64Array(this.buffer,i,tu),i+=8*tu,this.maxProj=new Float64Array(this.buffer,i,tu),i+=8*tu;for(let l=0;l<tu;++l)this.minVert[l]=new Float64Array(this.buffer,i,3),i+=24;for(let l=0;l<tu;++l)this.maxVert[l]=new Float64Array(this.buffer,i,3),i+=24;for(let l=0;l<tu;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(tu),n=new Array(tu),{data:o,size:a}=e;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<tu;++l){let c=s[l];Ic(this.minVert[l],o,c),c=n[l],Ic(this.maxVert[l],o,c)}}},c_t=class{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}};function Oq(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function fN(t,e,r){t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2]}function Ph(t,e,r){t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2]}function Vb(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}function Ic(t,e,r=0){t[0]=e[r+0],t[1]=e[r+1],t[2]=e[r+2]}function Ih(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2];t[0]=s*l-n*a,t[1]=n*o-i*l,t[2]=i*a-s*o}function Ho(t,e){const r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){const i=1/Math.sqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}}function SAe(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function Mq(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}function EAe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function u_t(t,e){const r=e[0]+e[4]+e[8];if(r>0){let i=Math.sqrt(r+1);t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i}else{let i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);const s=(i+1)%3,n=(i+2)%3;let o=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*n+n]+1);t[i]=.5*o,o=.5/o,t[3]=(e[3*s+n]-e[3*n+s])*o,t[s]=(e[3*s+i]+e[3*i+s])*o,t[n]=(e[3*n+i]+e[3*i+n])*o}}const KO=id(),Qb=M(),h_t=M(),d_t=rs();let P4t=class{constructor(e){const o=e*56;this.buffer=new ArrayBuffer(o),this.obbs=new Array(e);for(let a=0;a<e;a++)this.obbs[a]={center:qW(this.buffer,56*a+0),halfSize:qye(this.buffer,56*a+24),quaternion:wAe(this.buffer,56*a+36)}}};function CAe(t=[0,0,0],e=[-1,-1,-1],r=id()){return{center:gs(t),halfSize:mF(e),quaternion:bAe(r)}}function Uce(t){return CAe(t.center,t.halfSize,t.quaternion)}function $4t(t,e){le(e.center,t.center),le(e.halfSize,t.halfSize),_Y(e.quaternion,t.quaternion)}function L4t(t,e){return e=e||CAe(),Q0t(t,e),e}function vb(t,e){const r=wi(e,t.center),i=eU(t,e);return r>i?1:r<-i?-1:0}function D4t(t,e){e||(e=Rn());const r=QX(d_t,t.quaternion),i=t.halfSize[0]*Math.abs(r[0])+t.halfSize[1]*Math.abs(r[3])+t.halfSize[2]*Math.abs(r[6]),s=t.halfSize[0]*Math.abs(r[1])+t.halfSize[1]*Math.abs(r[4])+t.halfSize[2]*Math.abs(r[7]),n=t.halfSize[0]*Math.abs(r[2])+t.halfSize[1]*Math.abs(r[5])+t.halfSize[2]*Math.abs(r[8]);return e[0]=t.center[0]-i,e[1]=t.center[1]-s,e[2]=t.center[2]-n,e[3]=t.center[0]+i,e[4]=t.center[1]+s,e[5]=t.center[2]+n,e}function N4t(t,e){return wi(e,t.center)-eU(t,e)}function F4t(t,e){return wi(e,t.center)+eU(t,e)}function U4t(t,e){return vb(t,e[0])<=0&&vb(t,e[1])<=0&&vb(t,e[2])<=0&&vb(t,e[3])<=0&&vb(t,e[4])<=0&&vb(t,e[5])<=0}function V4t(t,e,r,i=0){Iw(KO,t.quaternion),ge(Qb,e,t.center);const s=pp(Qb,Qb,KO),n=pp(h_t,r,KO);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(i+t.halfSize[l]-s[l])/n[l],h=(-i-t.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>t.halfSize[l]+i||s[l]<-t.halfSize[l]-i)return!1;return o<=a}(()=>{const t=new Int8Array(162);let e=0;const r=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=6};return r([6,2,3,1,5,4]),r([0,2,3,1,5,4]),r([0,2,3,7,5,4]),r([0,1,3,2,6,4]),r([0,1,3,2,0,0]),r([0,1,5,7,3,2]),r([0,1,3,7,6,4]),r([0,1,3,7,6,2]),r([0,1,5,7,6,2]),r([0,1,5,4,6,2]),r([0,1,5,4,0,0]),r([0,1,3,7,5,4]),r([0,2,6,4,0,0]),r([0,0,0,0,0,0]),r([1,3,7,5,0,0]),r([2,3,7,6,4,0]),r([2,3,7,6,0,0]),r([2,3,1,5,7,6]),r([0,1,5,7,6,2]),r([0,1,5,7,6,4]),r([0,1,3,7,6,4]),r([4,5,7,6,2,0]),r([4,5,7,6,0,0]),r([4,5,1,3,7,6]),r([0,2,3,7,5,4]),r([6,2,3,7,5,4]),r([6,2,3,1,5,4]),t})();function eU(t,e){Iw(KO,t.quaternion),pp(Qb,e,KO);const r=t.halfSize;return Math.abs(Qb[0]*r[0])+Math.abs(Qb[1]*r[1])+Math.abs(Qb[2]*r[2])}function k4t(t,e){for(let r=0;r<8;++r){const i=e[r];i[0]=1&r?-t.halfSize[0]:t.halfSize[0],i[1]=2&r?-t.halfSize[1]:t.halfSize[1],i[2]=4&r?-t.halfSize[2]:t.halfSize[2],pp(i,i,t.quaternion),me(i,i,t.center)}}function p_t(t){return yc(t.halfSize)}function f_t(t,e,r,i,s){if(_Y(s.quaternion,t.quaternion),i===Be.Global){Iw(eL,t.quaternion),pp(_0,t.center,eL),oz(vT,_0),Gpe(bT,vT,t.halfSize),so(bT,vT,bT);const n=Me(bT);me(bT,vT,t.halfSize);const o=Me(bT);if(n<r)le(s.center,t.center),ce(_0,r,r,r),me(s.halfSize,t.halfSize,_0);else{const a=o>0?1+e/o:1,l=n>0?1+r/n:1,c=(l+a)/2,h=(l-a)/2;ae(s.halfSize,vT,h),zb(s.halfSize,s.halfSize,t.halfSize,c),ae(s.center,vT,c),zb(s.center,s.center,t.halfSize,h),Bpe(_0,_0),Q4(s.center,s.center,_0),pp(s.center,s.center,s.quaternion)}}else{const n=ce(_0,0,0,1);zb(s.center,t.center,n,(r+e)/2),Iw(eL,t.quaternion),pp(n,n,eL),oz(n,n),zb(s.halfSize,t.halfSize,n,(r-e)/2)}return s}const _0=M(),vT=M(),bT=M(),eL=id();let m_t=class{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return this._indexRanges.length===0}componentCount(){const e=this._indexRanges;let r=0;for(let i=0;i<e.length;i+=2)r+=e[i+1];return r}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=g_t(e)}forEachComponent(e){const r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i],n=s+r[i+1];for(let o=s;o<n;o++)if(!e(o))return!1}return!0}forEachComponentRange(e){const r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i];if(!e(s,s+r[i+1]))return!1}return!0}computeOffsetRanges(e){const r=new Array(this._indexRanges.length),i=this._indexRanges;for(let s=0;s<i.length;s+=2){const n=i[s],o=n+i[s+1],a=e[n],l=e[o];r[s]=a,r[s+1]=l-a}return r}};function g_t(t){const e=new Array;if(t.length===0)return e;let r=t[0],i=1;for(let s=1;s<t.length;s++){const n=t[s];r+i===n?i+=1:(e.push(r),e.push(i),r=n,i=1)}return e.push(r),e.push(i),e}let y_t=class{constructor(e,r){this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=r.slice();const i=this.count;this.visibility=new m_t(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let s=0;s<i;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return C(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return C(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return C(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((C(this.cachedHighlightRanges)||C(this.cachedDefaultRanges))&&v(this.highlightCounts)){const{highlightRanges:e,defaultRanges:r}=__t(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=r}}};function __t(t,e,r){const i=[],s=[];let n=r.length,o=r.length;return e.forEachComponent(a=>(t[a]>0?(n!==a-1&&(i.length&&i.push(r[n+1]-i[i.length-1]),i.push(r[a])),n=a):(o!==a-1&&(s.length&&s.push(r[o+1]-s[s.length-1]),s.push(r[a])),o=a),!0)),i.length&&i.push(r[n+1]-i[i.length-1]),s.length&&s.push(r[o+1]-s[s.length-1]),{highlightRanges:i,defaultRanges:s}}let KR=class extends Te{constructor(){super(...arguments),this.visible=DS.Hidden}};var DS;u([d({autoDestroy:!0})],KR.prototype,"renderable",void 0),u([d({autoDestroy:!0})],KR.prototype,"components",void 0),KR=u([P("esri.views.3d.webgl-engine.collections.Component.ComponentObject")],KR),function(t){t[t.Hidden=0]="Hidden",t[t.Visible=1]="Visible"}(DS||(DS={}));function v_t(t,e,r,i){if(r>=e)return t;t==null&&(t=b_t());const s=t.isVisibleBit;let n=t.data;const o=RAe(n),a=r/o|0,l=r-o*a,c=(e-1)/o|0,h=n,p=i===s;if(!(r<h.length*o)&&p){const m=a+1,y=Math.ceil(h.length*1.5),_=c+1;let b=Math.max(m,y);b=Math.min(b,_),n=new Uint32Array(b),n.set(h)}return a<n.length&&(n[a]=x_t(n[a],l,p)),t.data=n,t}function AAe(t,e){if(t==null)return!0;const{isVisibleBit:r,data:i}=t,s=RAe(i);return e<i.length*s?w_t(r,i,e,s):!t.isVisibleBit}function b_t(t=!0){return{isVisibleBit:!t,data:new Uint32Array(0)}}function w_t(t,e,r,i){const s=r/i|0,n=r-s*i;return T_t(e[s],n)===t}function RAe(t){return t.BYTES_PER_ELEMENT*8}function x_t(t,e,r){return t&~(1<<e)|(r?1:0)<<e}function T_t(t,e){return(t&1<<e)!=0}let S_t=class{constructor(e,r){this._indices=v(e.indices)?e.indices:AE(e.positions.length/3),this._positions=new Ii(e.positions),this._components=r,this._componentIntersectionData=new Array(r.count)}getComponentAabb(e,r){if(v(this._perComponentAabbs)){for(let i=0;i<6;i++)r[i]=this._perComponentAabbs[6*e+i];return r}return this._computePerComponentAabbs(),this.getComponentAabb(e,r)}getComponentPositions(e,r){r.indices=this._indices,r.data=this._positions.typedBuffer,r.stride=this._positions.typedBufferStride,r.startIndex=this._components.offsets[e],r.endIndex=this._components.offsets[e+1]}intersect(e,r,i,s,n,o,a){const l=new Ye(this._positions.typedBuffer,3,!1,this._positions.typedBufferStride),c=this._indices,h=this._components.offsets,p=LTe(e,r,E_t),f=e[2],m=r[2];this._components.visibility.forEachComponent(y=>{if(!AAe(this._components.pickability,y))return!0;const _=this.getComponentAabb(y,C_t);if(v(o)){const E=o[y];v(n)?n.componentOffset=E:(e[2]=f-E,r[2]=m-E)}if(v(n)&&n.applyToAabb(_),!OJ(_,e,p,i))return!0;const b=h[y]/3,x=h[y+1]/3,T=x-b,S=(E,O,R)=>a(y,E,Oc(O,O,s),R);return C(n)&&T>yAe?(this._componentIntersectionData[y]==null&&(this._componentIntersectionData[y]=new FK(this._indices,b,x,l)),this._componentIntersectionData[y].intersectRay({r0:e,r1:r},S)):nP(e,r,b,x,c,l,void 0,n,S),!0})}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);const r=this._indices,i=this._positions.typedBuffer,s=this._positions.typedBufferStride,n=this._components.offsets;let o=0;for(let a=0;a<e;a++){const l=n[a],c=n[a+1];let h=1/0,p=1/0,f=1/0,m=-1/0,y=-1/0,_=-1/0;for(let b=l;b<c;b++){const x=r[b]*s,T=i[x],S=i[x+1],E=i[x+2];h=Math.min(h,T),p=Math.min(p,S),f=Math.min(f,E),m=Math.max(m,T),y=Math.max(y,S),_=Math.max(_,E)}this._perComponentAabbs[o++]=h,this._perComponentAabbs[o++]=p,this._perComponentAabbs[o++]=f,this._perComponentAabbs[o++]=m,this._perComponentAabbs[o++]=y,this._perComponentAabbs[o++]=_}}get positions(){return this._positions}get indices(){return this._indices}};const E_t=M(),C_t=Rn();let A_t=class{constructor(e,r,i){this.material=e,this.geometry=r,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}},R_t=class{constructor(e,r,i,s){this.vao=e,this.primitiveType=r,this.parameters=i,this.indexed=s}dispose(){this.vao.dispose()}},O_t=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function M_t(t,e){return{near:t,far:e}}function mP(t){return t?oM(t,1/0,-1/0):M_t(1/0,-1/0)}function oM(t,e,r){return t.near=e,t.far=r,t}function FE(t,e,r=t){return e!=null&&(r.near=Math.min(t.near,e.near),r.far=Math.max(t.far,e.far)),r}function tL(t,e){return t.near<=e&&e<=t.far}const Pq={near:0,far:0};function P_t(t,e){const r=mP(),{eye:i,frustum:s,viewForward:n}=t;e.forAll(o=>{const a=v(o.offsetObb)?o.offsetObb:o.obb,l=_e(so(lu,a.center,i),n),c=eU(a,n);if(tL(r,l-c)&&tL(r,l+c))return;const h=N_t(a,s);if(h===-1)return;if(h===0)return eg.far=l+c,eg.near=l-c,void FE(r,eg);const p=rL.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<rL.length;o++){const a=rL.data[o];if(tL(r,a.near)&&tL(r,a.far))continue;eg.far=a.far,eg.near=1/0,D_t(v(a.object.offsetObb)?a.object.offsetObb:a.object.obb,i,I_t,c=>{let h=$_t;for(let p=0;p<OAe&&c.length>0;p++){if(!(a.mask&1<<p))continue;L_t(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){ce(Ll,c.data[p+0],c.data[p+1],c.data[p+2]);const f=_e(so(Ll,Ll,i),n);eg.near=Math.min(eg.near,f)}})===0&&(eg.near=0),FE(r,eg)}return rL.length=0,r}const rL=new Kt({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=yw(t.object),t)}),eg=mP(),Ll=M(),v1=M(),I_t=new Kt({deallocator:null}),$_t=new Kt({deallocator:null});function L_t(t,e,r){r.length=0;const i=e.length-3;ZV(Ll,e,i);const s=wi(t,Ll);s<=0&&(r.push(Ll[0]),r.push(Ll[1]),r.push(Ll[2]));let n=0,o=s;for(;n<i;n+=3){ZV(v1,e,n);const a=wi(t,v1);o*a<0&&(Qs(Ll,v1,Ll,a/(a-o)),Dl(r,Ll)),a<=0&&Dl(r,v1),o=a,le(Ll,v1)}o*s<0&&(ZV(v1,e,i),Qs(Ll,v1,Ll,s/(s-o)),Dl(r,Ll))}function ZV(t,e,r){return ce(t,e.data[r+0],e.data[r+1],e.data[r+2])}function Dl(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function D_t(t,e,r,i){Iw(kce,t.quaternion),so(lu,e,t.center),pp(lu,lu,kce);const s=8*((lu[0]<-t.halfSize[0]?-1:lu[0]>t.halfSize[0]?1:0)+3*(lu[1]<-t.halfSize[1]?-1:lu[1]>t.halfSize[1]?1:0)+9*(lu[2]<-t.halfSize[2]?-1:lu[2]>t.halfSize[2]?1:0)+13),n=Vce[s];if(n===0)return n;QX(iL,t.quaternion),KX(iL,iL,t.halfSize);const o=(a,l)=>{const c=Vce[s+l+1];return ce(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),Oc(a,a,iL),me(a,t.center,a)};return r.length=0,Dl(r,o(JV,0)),Dl(r,o(zce,1)),Dl(r,o(lu,2)),Dl(r,o(Bce,3)),i(r),n===1||(r.length=0,Dl(r,JV),Dl(r,Bce),Dl(r,o(lu,4)),Dl(r,o(Gce,5)),i(r),n===2||(r.length=0,Dl(r,JV),Dl(r,Gce),Dl(r,o(lu,6)),Dl(r,zce),i(r))),n}const Vce=(()=>{const t=new Int8Array(216);let e=0;const r=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),t})(),OAe=4;function N_t(t,e){let r=0;for(let i=0;i<OAe;i++){const s=vb(t,e[i]);if(s>0)return-1;s===0&&(r|=1<<i)}return r}const iL=rs(),kce=id(),lu=M(),JV=M(),zce=M(),Bce=M(),Gce=M();let F_t=class{constructor(e){this._objects=e}submit(e,r){this._objects.preSubmit(r),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,r,i))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?P_t(e,this._objects.visibleObjects):null}};function U_t(t){const e=is().vec3f(A.POSITION);return t.normals&&e.vec2i16(A.NORMALCOMPRESSED,{glNormalized:!0}),t.textureCoordinates===Xs.Default?e.vec2f(A.UV0):t.textureCoordinates===Xs.Atlas&&(e.vec2f(A.UV0),e.vec4u16(A.UVREGION,{glNormalized:!0})),t.colors&&e.vec4u8(A.COLOR,{glNormalized:!0}),e.alignTo(4)}let V_t=class{constructor(){this.externalColor=nr(),this.externalColorMixMode=wn.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}},k_t=class extends ws{constructor(e,r){super(e,"int",di.Draw,(i,s,n)=>i.setUniform1i(e,r(s,n)))}};var im;(function(t){t[t.Uniform=0]="Uniform",t[t.Varying=1]="Varying",t[t.COUNT=2]="COUNT"})(im||(im={}));const UK=429496.7296;function MAe(t,e){H3(t/UK*.5+.5,e)}function z_t(t,e){switch(e.componentData){case im.Varying:return B_t(t,e);case im.Uniform:return G_t(t);case im.COUNT:return;default:e.componentData}}function B_t(t,e){const{vertex:r,fragment:i}=t;r.include(jc),r.uniforms.add(q_("componentColorTex",n=>n.componentParameters.texture.texture,e.hasWebGL2Context?ei.None:ei.Size)),t.attributes.add(A.COMPONENTINDEX,"float"),t.varyings.add("vExternalColorMixMode","mediump float"),t.varyings.add("vExternalColor","vec4");const s=e.output===V.ObjectAndLayerIdColor;s&&t.varyings.add("vObjectAndLayerIdColor","vec4"),t.include(rEe),r.constants.add("elevationScale","float",2*UK),r.constants.add("stride","float",de("enable-feature:objectAndLayerId-rendering")?3:2),r.code.add(w`
  vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
    vec2 textureSize = ${kh(e,"componentColorTex")};

    float index = componentIndex * stride + typeOffset;
    float coordX = mod(index, textureSize.x);
    float coordY = floor(index / textureSize.x);

    return vec2(coordX, coordY) + 0.5;
  }
  `),r.code.add(w`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return ${tl(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = ${tl(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?w`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = ${tl(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
          }`:w`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),i.code.add(w`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?w`gl_FragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function G_t(t){const{vertex:e,fragment:r}=t;e.uniforms.add(new M4("externalColor",i=>i.componentParameters.externalColor)),r.uniforms.add(new k_t("externalColorMixMode",i=>i.componentParameters.externalColorMixMode)),t.varyings.add("vExternalColor","vec4"),e.code.add(w`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),r.code.add(w`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}
void outputObjectAndLayerIdColor() {
gl_FragColor = vec4(1.0,0.0,0.0,0.0);
}`)}var Dh;function j_t(t,e){const r=t.vertex;switch(r.code.add(w`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case Dh.None:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) {}`);break;case Dh.Opaque:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case Dh.Transparent:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(t){t[t.None=0]="None",t[t.Transparent=1]="Transparent",t[t.Opaque=2]="Opaque",t[t.COUNT=3]="COUNT"})(Dh||(Dh={}));var sm;function J4t(t){return t&&wm(t)?sm.Mars:t&&xm(t)?sm.Moon:sm.Earth}(function(t){t[t.Earth=1]="Earth",t[t.Mars=2]="Mars",t[t.Moon=3]="Moon",t[t.COUNT=4]="COUNT"})(sm||(sm={}));var Su;(function(t){t[t.None=0]="None",t[t.NoOverlay=1]="NoOverlay",t[t.ColorOverlay=2]="ColorOverlay",t[t.ColorOverlayWithWater=3]="ColorOverlayWithWater",t[t.COUNT=4]="COUNT"})(Su||(Su={}));let _r=class extends Pa{constructor(){super(...arguments),this.output=V.Color,this.textureCoordinateType=Xs.None,this.componentData=im.Uniform,this.cullFace=Ei.Back,this.vertexDiscardMode=Dh.None,this.doubleSidedMode=hs.WindingOrder,this.alphaDiscardMode=ui.Opaque,this.integratedMeshMode=Su.None,this.transparencyPassType=Tt.NONE,this.ellipsoidMode=sm.Earth,this.pbrMode=dt.Disabled,this.normalType=si.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.useLegacyTerrainShading=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.hasWebGL2Context=!1}};u([k({count:V.COUNT})],_r.prototype,"output",void 0),u([k({count:Xs.COUNT})],_r.prototype,"textureCoordinateType",void 0),u([k({count:im.COUNT})],_r.prototype,"componentData",void 0),u([k({count:Ei.COUNT})],_r.prototype,"cullFace",void 0),u([k({count:Dh.COUNT})],_r.prototype,"vertexDiscardMode",void 0),u([k({count:hs.COUNT})],_r.prototype,"doubleSidedMode",void 0),u([k({count:ui.COUNT})],_r.prototype,"alphaDiscardMode",void 0),u([k({count:Su.COUNT})],_r.prototype,"integratedMeshMode",void 0),u([k({count:Tt.COUNT})],_r.prototype,"transparencyPassType",void 0),u([k({count:sm.COUNT})],_r.prototype,"ellipsoidMode",void 0),u([k({count:dt.COUNT})],_r.prototype,"pbrMode",void 0),u([k({count:si.COUNT})],_r.prototype,"normalType",void 0),u([k()],_r.prototype,"spherical",void 0),u([k()],_r.prototype,"doublePrecisionRequiresObfuscation",void 0),u([k()],_r.prototype,"hasVertexColors",void 0),u([k()],_r.prototype,"hasNormals",void 0),u([k()],_r.prototype,"hasSlicePlane",void 0),u([k()],_r.prototype,"hasBaseColorTexture",void 0),u([k()],_r.prototype,"receiveAmbientOcclusion",void 0),u([k()],_r.prototype,"receiveShadows",void 0),u([k()],_r.prototype,"blendingEnabled",void 0),u([k()],_r.prototype,"hasScreenSpaceReflections",void 0),u([k()],_r.prototype,"hasPolygonOffset",void 0),u([k()],_r.prototype,"hasMetallicRoughnessTexture",void 0),u([k()],_r.prototype,"hasEmissionTexture",void 0),u([k()],_r.prototype,"hasOcclusionTexture",void 0),u([k()],_r.prototype,"hasNormalTexture",void 0),u([k()],_r.prototype,"hasOccludees",void 0),u([k()],_r.prototype,"hasMultipassTerrain",void 0),u([k()],_r.prototype,"cullAboveGround",void 0),u([k()],_r.prototype,"useLegacyTerrainShading",void 0),u([k()],_r.prototype,"hasCloudsReflections",void 0),u([k()],_r.prototype,"snowCover",void 0),u([k()],_r.prototype,"objectAndLayerIdColor",void 0),u([k()],_r.prototype,"hasWebGL2Context",void 0),u([k({constValue:di.Draw})],_r.prototype,"pbrTextureBindType",void 0),u([k({constValue:!0})],_r.prototype,"hasSliceHighlight",void 0),u([k({constValue:!1})],_r.prototype,"hasSliceInVertexProgram",void 0),u([k({constValue:!1})],_r.prototype,"useCustomDTRExponentForWater",void 0),u([k({constValue:!1})],_r.prototype,"hasVertexTangents",void 0),u([k({constValue:!0})],_r.prototype,"supportsTextureAtlas",void 0),u([k({constValue:!1})],_r.prototype,"highStepCount",void 0),u([k({constValue:!1})],_r.prototype,"instancedDoublePrecision",void 0),u([k({constValue:!0})],_r.prototype,"useFillLights",void 0),u([k({constValue:!1})],_r.prototype,"objectAndLayerIdColorInstanced",void 0);function jce(t,e){t.include(mx,e),t.fragment.include(Q3);const r=t.fragment;r.uniforms.add(new M4("baseColor",i=>i.baseColor)),r.uniforms.add(new dw("objectOpacity",i=>i.objectOpacity)),e.hasVertexColors?r.code.add(w`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):r.code.add(w`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),r.code.add(w`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function Hce(t,e){const r=t.fragment;switch(e.doubleSidedMode){case hs.None:r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case hs.View:t.include(wS,e),r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case hs.WindingOrder:r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:e.doubleSidedMode;case hs.COUNT:}switch(e.normalType){case si.Attribute:case si.CompressedAttribute:t.include(F6,e),r.code.add(w`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case si.ScreenDerivative:t.extensions.add("GL_OES_standard_derivatives"),t.include(wS,e),r.code.add(w`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case si.Ground:e.spherical?(t.include(wS,e),r.code.add(w`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):r.code.add(w`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),t.extensions.add("GL_OES_standard_derivatives"),r.code.add(w`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:e.normalType;case si.COUNT:}}function H_t(t,e){const r=t.fragment;if(e.hasBaseColorTexture&&(e.output===V.Color||e.alphaDiscardMode!==ui.Opaque)){t.include(zZ,e);const i=e.textureCoordinateType===Xs.Atlas;r.uniforms.add(q_("baseColorTexture",s=>s.texture,i?e.hasWebGL2Context?ei.None:ei.Size:ei.None)),i?(t.include(Awe),r.code.add(w`
        vec4 readBaseColorTexture() {
          vec2 textureSize = ${kh(e,"baseColorTexture")};
          return textureAtlasLookup(baseColorTexture, textureSize, vuv0, vuvRegion);
        }
      `)):r.code.add(w`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)}else r.code.add(w`vec4 readBaseColorTexture() { return vec4(1.0); }`)}function q_t(t){const e=new Lr;e.include(wS,t),e.include(F6,t),e.include(mx,t),e.include(tm,t),e.include(cC,t),e.include(z_t,t),e.include(Jlt,t),e.include(Hst,t),e.include(H_t,t),e.include(j_t,t);const{vertex:r,fragment:i}=e;t.pbrMode!==dt.Normal&&t.pbrMode!==dt.Schematic||(e.include(GZ,t),t.hasNormalTexture&&e.include(oEe,t));const s=t.output===V.Shadow||t.output===V.ShadowHighlight||t.output===V.ShadowExcludeHighlight;s&&t.componentData===im.Varying?r.code.add(w`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):r.code.add(w`#define discardShadows(castShadows) {}`);const n=t.integratedMeshMode===Su.ColorOverlay||t.integratedMeshMode===Su.ColorOverlayWithWater,o=n&&t.output===V.Color&&t.pbrMode===dt.WaterOnIntegratedMesh;return n&&(e.include(Yw,t),e.include(Tyt,t),t.spherical?r.code.add(w`
      const float invEllipsoidRadius = ${w.float(1/(t.ellipsoidMode===sm.Earth?br.radius:t.ellipsoidMode===sm.Mars?Jf.radius:ny.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):r.code.add(w`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),o&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),r.code.add(w`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${t.output===V.ObjectAndLayerIdColor?w`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${w.float(Qo)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${t.output===V.ObjectAndLayerIdColor?w`forwardObjectAndLayerIdColor();`:""}
      ${o?t.spherical?w`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:w`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${n?w`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),t.output===V.Alpha&&(i.include(ku),e.include(zu,t),e.include(jce,t),n&&i.uniforms.add(new Pt("ovColorTex",(a,l)=>Eq(a,l))),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?w`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),t.output===V.Color&&(i.include(ku),e.include(zu,t),e.include(jce,t),e.include(Hce,t),e.include(Yw,t),t.receiveShadows?(e.include(U6,t),i.code.add(w`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):i.code.add(w`float evaluateShadow() { return 0.0; }`),n&&i.uniforms.add(new Pt("ovColorTex",(a,l)=>Eq(a,l))),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?w`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),t.pbrMode===dt.Normal||t.pbrMode===dt.Schematic?(Cm(i),i.code.add(w`
        ${t.pbrMode===dt.Normal?w`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),t.hasNormalTexture?i.code.add(w`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):i.code.add(w`vec3 shadingNormal = normalVertex;`),i.code.add(w`${t.spherical?w`vec3 normalGround = normalize(positionWorld());`:w`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),i.code.add(w`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${t.snowCover?w`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${n?w` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(t.receiveShadows?i.code.add(w`float shadow = evaluateShadow();`):t.spherical?(gC(i),i.code.add(w`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):i.code.add(w`float shadow = 0.0;`),o&&i.uniforms.add(new Pt("ovNormalTex",(a,l)=>VK(l))),t.snowCover&&(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(w`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)),i.code.add(w`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${n?w` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${o?w`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),i.code.add(w`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${t.transparencyPassType===Tt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),(t.output===V.Depth||s)&&(e.include(py,t),i.code.add(w`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),t.output===V.Normal&&(e.include(Hce,t),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${t.normalType===si.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),t.output===V.ObjectAndLayerIdColor&&e.fragment.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?w`gl_FragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),t.output===V.Highlight&&(e.include(Ry,t),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?w`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  gl_FragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),e}function VK(t){return t.overlays.length===0?null:t.overlays[es.INNER].getValidTexture(ms.Water)}const W_t=Object.freeze(Object.defineProperty({__proto__:null,build:q_t,getOverlayNormalTexture:VK},Symbol.toStringTag,{value:"Module"}));let PAe=class IAe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2,r.spherical=e.viewingMode===Be.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Nr(e.rctx,IAe.shader.get().build(this.configuration),$Ae)}_setPipelineState(e){const r=this.configuration,i=r.integratedMeshMode!==Su.None,s=e===Tt.NONE,n=e===Tt.FrontFace;return zt({blending:r.output!==V.Color&&r.output!==V.Alpha||!r.blendingEnabled?null:s?Du:Oy(e),culling:u6(r.cullFace),depthTest:{func:Iv(e)},depthWrite:s||n?Yl:null,colorWrite:Qt,stencilWrite:i||r.hasOccludees?vm:null,stencilTest:i?Dat(jl.IntegratedMeshMaskExcluded):r.hasOccludees?$v:null,polygonOffset:s||n?r.hasPolygonOffset?{factor:2,units:2}:null:P6})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};PAe.shader=new Dr(W_t,()=>ie(()=>import("./ComponentShader.glsl-29f56061.js"),[],import.meta.url));const $Ae=new Map([[A.POSITION,0],[A.NORMAL,1],[A.NORMALCOMPRESSED,1],[A.COLOR,2],[A.UV0,3],[A.UVREGION,4],[A.COMPONENTINDEX,5]]);let X_t=class extends pi{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},kK=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function ps(t={}){return(e,r)=>{const i=e._parameterCount??0;if(e._parameterCount=i+1,t.vectorOps){const s=t.vectorOps;Object.defineProperty(e,r,{get(){return this[i]},set(n){const o=this[i];if(o==null)this[i]=n;else{if(s.equals(o,n))return;s.copy(o,n)}this._setDirty()}})}else Object.defineProperty(e,r,{get(){return this[i]},set(s){this[i]!==s&&(t.dispose&&this[i]&&this[i].dispose(),this[i]=s,this._setDirty())}})}}function qce(){return(t,e)=>{const r=t._parameterCount??0;t._parameterCount=r+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(r),Object.defineProperty(t,e,{get(){return this[r]},set(i){this[r]!==i&&(this[r]=i,this._setDirty())}})}}let tU=class{constructor(e){this._low=Gi(),this._high=Gi(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const r=this._low,i=this._high;le(r,e),so(i,e,r)}setElements(e,r,i){ce(Wce,e,r,i),this.set(Wce)}get(e){return me(e,this._low,this._high)}getLowScaled(e){return ae(e,this._low,1)}};const Wce=M();let Zn=class extends X_t{constructor(e,r){super(),this.toMapSpace=r,this.baseColor=Ap(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Xr(1,1,.5),this.emissiveFactor=Xr(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new mN,this.componentParameters=new QO,this.textureAlphaCutoff=h4,this.alphaDiscardMode=ui.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=sm.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new _r;const i=new tU(e.position),s=aEe(e.rotationScale);ox(s,s),this.transformNormalGlobalFromModel=Kh(s,s),this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=ji(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return v(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return v(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return v(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return v(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return v(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(e,r,i,s){const n=this._techniqueConfiguration;n.hasVertexColors=s.colors,n.hasNormals=s.normals,n.textureCoordinateType=s.textureCoordinates,n.hasMetallicRoughnessTexture=v(this.metallicRoughnessTexture),n.hasEmissionTexture=v(this.emissionTexture),n.hasOcclusionTexture=v(this.occlusionTexture),n.hasNormalTexture=v(this.normalTexture),n.transparencyPassType=r.identifier===Rc.Material&&i.transparencyPassType!=null?i.transparencyPassType:Tt.NONE,n.hasMultipassTerrain=r.identifier===Rc.Material&&i.multipassTerrain!=null&&i.multipassTerrain.enabled,n.cullAboveGround=r.identifier===Rc.Material&&i.multipassTerrain!=null&&i.multipassTerrain.cullAboveGround,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?hs.View:hs.None,n.hasBaseColorTexture=v(this.baseColorTexture);const o=this._computeWhichMaterialPass();n.blendingEnabled=o===Wa.Transparent||o===Wa.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?Z_t(i)?VK(i)?Su.ColorOverlayWithWater:Su.ColorOverlay:Su.NoOverlay:Su.None,n.useLegacyTerrainShading=this.isIntegratedMesh&&Wr.TERRAIN_USE_LEGACY_SHADING,n.hasPolygonOffset=this.polygonOffsetEnabled;const a=this.hasParametersFromSource&&C(this.baseColorTexture);if(n.pbrMode=n.integratedMeshMode===Su.ColorOverlayWithWater?dt.WaterOnIntegratedMesh:this.usePBR?a?dt.Schematic:dt.Normal:dt.Disabled,n.normalType=n.integratedMeshMode===Su.None?n.hasNormals?si.CompressedAttribute:si.ScreenDerivative:si.Ground,n.hasSlicePlane=v(i.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,r.identifier===Rc.ShadowMap)n.output=V.Shadow,n.vertexDiscardMode=Dh.None;else if(r.identifier===Rc.Highlight)n.output=V.Highlight,n.vertexDiscardMode=Dh.None;else{switch(this._computeWhichMaterialPass()===Wa.OpaqueAndTransparent?n.vertexDiscardMode=r.transparent?Dh.Opaque:Dh.Transparent:n.vertexDiscardMode=Dh.None,n.output=r.output,n.receiveAmbientOcclusion=!1,n.receiveShadows=!1,r.output){case V.Color:n.receiveAmbientOcclusion=i.ssaoHelper.active,n.hasOccludees=i.hasOccludees,n.receiveShadows=i.shadowMap.ready,n.hasScreenSpaceReflections=i.ssr.enabled,n.hasCloudsReflections=v(i.cloudsFade.data);break;case V.Alpha:n.hasOccludees=i.hasOccludees;break;case V.ObjectAndLayerIdColor:n.objectAndLayerIdColor=!0}n.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(PAe,n,this._technique),this._setClean(),this._technique}hasSnowCover(e){return v(e.weather)&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,r,i){if(this.objectOpacity===0)return;const s=i.renderable.geometry,n=i.components,o=i.renderable.meta.cameraDepthSquared,a=n.geometryRanges,l=n.highlightRanges,c=n.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case Wa.Opaque:e.materialOpaque.submitDraw(this,s,a,o);break;case Wa.Transparent:e.materialTransparent.submitDraw(this,s,a,o);break;case Wa.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,s,a,o),e.materialTransparent.submitDraw(this,s,a,o);break;case Wa.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,s,a,o),Y_t(r)&&e.highlightIntegratedMesh.submitDraw(this,s,a,o)}const h=this.componentParameters.castShadows!==Nn.None;h&&e.shadowMap.submitDraw(this,s,a,o),v(l)&&(e.highlight.submitDraw(this,s,l,o),h&&e.highlightShadowMap.submitDraw(this,s,l,o)),h&&v(c)&&e.defaultShadowMap.submitDraw(this,s,c,o)}_computeWhichMaterialPass(){return this.isIntegratedMesh?Wa.IntegratedMesh:this.objectOpacity<1?Wa.Transparent:this.componentParameters.opaqueOverride===Nn.All?Wa.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===ui.Blend||this.alphaDiscardMode===ui.MaskBlend?Wa.Transparent:this.componentParameters.transparent===Nn.None?Wa.Opaque:this.componentParameters.transparent===Nn.All?Wa.Transparent:Wa.OpaqueAndTransparent}};var Wa,Nn;u([ps({vectorOps:Jpe})],Zn.prototype,"baseColor",void 0),u([ps()],Zn.prototype,"usePBR",void 0),u([ps()],Zn.prototype,"hasParametersFromSource",void 0),u([ps({vectorOps:see})],Zn.prototype,"mrrFactors",void 0),u([ps({vectorOps:see})],Zn.prototype,"emissiveFactor",void 0),u([ps({dispose:!0})],Zn.prototype,"baseColorTexture",void 0),u([ps({dispose:!0})],Zn.prototype,"metallicRoughnessTexture",void 0),u([ps({dispose:!0})],Zn.prototype,"emissionTexture",void 0),u([ps({dispose:!0})],Zn.prototype,"occlusionTexture",void 0),u([ps({dispose:!0})],Zn.prototype,"normalTexture",void 0),u([ps()],Zn.prototype,"objectOpacity",void 0),u([qce()],Zn.prototype,"commonMaterialParameters",void 0),u([qce()],Zn.prototype,"componentParameters",void 0),u([ps()],Zn.prototype,"textureAlphaCutoff",void 0),u([ps()],Zn.prototype,"alphaDiscardMode",void 0),u([ps()],Zn.prototype,"isIntegratedMesh",void 0),u([ps()],Zn.prototype,"polygonOffsetEnabled",void 0),u([ps()],Zn.prototype,"ellipsoidMode",void 0),u([ps()],Zn.prototype,"hasOccludees",void 0),function(t){t[t.Opaque=0]="Opaque",t[t.Transparent=1]="Transparent",t[t.OpaqueAndTransparent=2]="OpaqueAndTransparent",t[t.IntegratedMesh=3]="IntegratedMesh"}(Wa||(Wa={}));let mN=class extends kK{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Ei.Back,this.hasSlicePlane=!0}};u([ps()],mN.prototype,"doubleSided",void 0),u([ps()],mN.prototype,"cullFace",void 0),u([ps()],mN.prototype,"hasSlicePlane",void 0);let QO=class extends kK{constructor(){super(...arguments),this.externalColor=qt(1,1,1,1),this.externalColorMixMode=wn.Multiply,this.castShadows=Nn.All}get transparent(){return this.externalColor[3]<1?Nn.All:Nn.None}get opaqueOverride(){return this.externalColorMixMode===wn.Replace&&this.externalColor[3]===1?Nn.All:Nn.None}get visible(){return this.externalColor[3]>0?Nn.All:Nn.None}get type(){return im.Uniform}};u([ps({vectorOps:Jpe})],QO.prototype,"externalColor",void 0),u([ps()],QO.prototype,"externalColorMixMode",void 0),u([ps()],QO.prototype,"castShadows",void 0),function(t){t[t.All=0]="All",t[t.Some=1]="Some",t[t.None=2]="None"}(Nn||(Nn={}));let QR=class extends kK{constructor(){super(...arguments),this.texture=null,this.transparent=Nn.None,this.opaqueOverride=Nn.None,this.castShadows=Nn.None}get type(){return im.Varying}};function Y_t(t){return t.overlays.length!==0&&v(t.overlays[es.INNER].getValidTexture(ms.Highlight))}function Z_t(t){return t.overlays.length!==0&&v(t.overlays[es.INNER].getColorTextureNoRasterImage())}u([ps()],QR.prototype,"texture",void 0),u([ps()],QR.prototype,"transparent",void 0),u([ps()],QR.prototype,"opaqueOverride",void 0),u([ps()],QR.prototype,"castShadows",void 0);const $4=is().vec3f(A.POSITION).u16(A.COMPONENTINDEX).u16(A.U16PADDING),LAe=is().vec2u8(A.SIDENESS),J_t=Hc(LAe),DAe=is().vec3f(A.POSITION0).vec3f(A.POSITION1).u16(A.COMPONENTINDEX).u8(A.VARIANTOFFSET,{glNormalized:!0}).u8(A.VARIANTSTROKE).u8(A.VARIANTEXTENSION,{glNormalized:!0}).u8(A.U8PADDING,{glPadding:!0}).u16(A.U16PADDING,{glPadding:!0}),Iq=DAe.clone().vec3f(A.NORMAL),$q=DAe.clone().vec3f(A.NORMALA).vec3f(A.NORMALB),NAe=new Map([[A.POSITION0,0],[A.POSITION1,1],[A.COMPONENTINDEX,2],[A.VARIANTOFFSET,3],[A.VARIANTSTROKE,4],[A.VARIANTEXTENSION,5],[A.NORMAL,6],[A.NORMALA,6],[A.NORMALB,7],[A.SIDENESS,8]]);function Xce(t,e,r){const i=e/3,s=new Uint32Array(r+1),n=new Uint32Array(r+1),o=(x,T)=>{x<T?s[x+1]++:n[T+1]++};for(let x=0;x<i;x++){const T=t[3*x],S=t[3*x+1],E=t[3*x+2];o(T,S),o(S,E),o(E,T)}let a=0,l=0;for(let x=0;x<r;x++){const T=s[x+1],S=n[x+1];s[x+1]=a,n[x+1]=l,a+=T,l+=S}const c=new Uint32Array(6*i),h=s[r],p=(x,T,S)=>{if(x<T){const E=s[x+1]++;c[2*E]=T,c[2*E+1]=S}else{const E=n[T+1]++;c[2*h+2*E]=x,c[2*h+2*E+1]=S}};for(let x=0;x<i;x++){const T=t[3*x],S=t[3*x+1],E=t[3*x+2];p(T,S,x),p(S,E,x),p(E,T,x)}const f=(x,T)=>{const S=2*x,E=T-x;for(let O=1;O<E;O++){const R=c[S+2*O],L=c[S+2*O+1];let I=O-1;for(;I>=0&&c[S+2*I]>R;I--)c[S+2*I+2]=c[S+2*I],c[S+2*I+3]=c[S+2*I+1];c[S+2*I+2]=R,c[S+2*I+3]=L}};for(let x=0;x<r;x++)f(s[x],s[x+1]),f(h+n[x],h+n[x+1]);const m=new Int32Array(3*i),y=(x,T)=>x===t[3*T]?0:x===t[3*T+1]?1:x===t[3*T+2]?2:-1,_=(x,T)=>{const S=y(x,T);m[3*T+S]=-1},b=(x,T,S,E)=>{const O=y(x,T);m[3*T+O]=E;const R=y(S,E);m[3*E+R]=T};for(let x=0;x<r;x++){let T=s[x];const S=s[x+1];let E=n[x];const O=n[x+1];for(;T<S&&E<O;){const R=c[2*T],L=c[2*h+2*E];R===L?(b(x,c[2*T+1],L,c[2*h+2*E+1]),T++,E++):R<L?(_(x,c[2*T+1]),T++):(_(L,c[2*h+2*E+1]),E++)}for(;T<S;)_(x,c[2*T+1]),T++;for(;E<O;)_(c[2*h+2*E],c[2*h+2*E+1]),E++}return m}let FAe=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?Q_t:K_t}write(e,r,i){const s=this._edgeHashFunction(i);nL.seed=s;const n=nL.getIntRange(0,255),o=nL.getIntRange(0,this.settings.variants-1),a=.7,l=nL.getFloat(),c=255*(.5*evt(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);e.position0.setVec(r,i.position0),e.position1.setVec(r,i.position1),e.componentIndex.set(r,i.componentIndex),e.variantOffset.set(r,n),e.variantStroke.set(r,o),e.variantExtension.set(r,c)}trim(e,r){return e.slice(0,r)}};const zK=new Float32Array(6),L4=new Uint32Array(zK.buffer),U_=new Uint32Array(1);function K_t(t){const e=zK;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],U_[0]=5381;for(let r=0;r<L4.length;r++)U_[0]=31*U_[0]+L4[r];return U_[0]}function Q_t(t){const e=zK;e[0]=wT(t.position0[0]),e[1]=wT(t.position0[1]),e[2]=wT(t.position0[2]),e[3]=wT(t.position1[0]),e[4]=wT(t.position1[1]),e[5]=wT(t.position1[2]),U_[0]=5381;for(let r=0;r<L4.length;r++)U_[0]=31*U_[0]+L4[r];return U_[0]}const Yce=1e4;function wT(t){return Math.round(t*Yce)/Yce}function evt(t,e){const r=t<0?-1:1;return Math.abs(t)**e*r}let D4=class{constructor(){this._commonWriter=new FAe}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return Iq.createBuffer(e)}write(e,r,i){this._commonWriter.write(e,r,i),me(sL,i.faceNormal0,i.faceNormal1),ve(sL,sL),e.normal.setVec(r,sL)}trim(e,r){return this._commonWriter.trim(e,r)}};D4.Layout=Iq,D4.glLayout=Hc(Iq,1);let N4=class{constructor(){this._commonWriter=new FAe}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return $q.createBuffer(e)}write(e,r,i){this._commonWriter.write(e,r,i),e.normalA.setVec(r,i.faceNormal0),e.normalB.setVec(r,i.faceNormal1)}trim(e,r){return this._commonWriter.trim(e,r)}};N4.Layout=$q,N4.glLayout=Hc($q,1);const sL=M(),nL=new iO,bb=-1;var F4;function tvt(t,e,r,i=avt){const s=t.vertices.position,n=t.vertices.componentIndex,o=jt(i.anglePlanar),a=jt(i.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=Lq.edge,p=h.position0,f=h.position1,m=h.faceNormal0,y=h.faceNormal1,_=ovt(t),b=nvt(t),x=b.length/4,T=e.allocate(x);let S=0;const E=x,O=r.allocate(E);let R=0,L=0,I=0;const U=t3e(0,x),z=new Float32Array(x);z.forEach((ee,q,$)=>{s.getVec(b[4*q+0],p),s.getVec(b[4*q+1],f),$[q]=Si(p,f)}),U.sort((ee,q)=>z[q]-z[ee]);const B=new Array,G=new Array;for(let ee=0;ee<x;ee++){const q=U[ee],$=z[q],N=b[4*q+0],F=b[4*q+1],H=b[4*q+2],X=b[4*q+3],J=X===bb;if(s.getVec(N,p),s.getVec(F,f),J)ce(m,_[3*H+0],_[3*H+1],_[3*H+2]),le(y,m),h.componentIndex=n.get(N),h.cosAngle=_e(m,y);else{if(ce(m,_[3*H+0],_[3*H+1],_[3*H+2]),ce(y,_[3*X+0],_[3*X+1],_[3*X+2]),h.componentIndex=n.get(N),h.cosAngle=_e(m,y),ivt(h,c))continue;h.cosAngle<-.9999&&le(y,m)}L+=$,I++,J||rvt(h,l)?(e.write(T,S++,h),B.push($)):svt(h,o)&&(r.write(O,R++,h),G.push($))}const K=new Float32Array(B.reverse()),re=new Float32Array(G.reverse());return{regular:{instancesData:e.trim(T,S),lodInfo:{lengths:K}},silhouette:{instancesData:r.trim(O,R),lodInfo:{lengths:re}},averageEdgeLength:L/I}}function rvt(t,e){return t.cosAngle<e}function ivt(t,e){return t.cosAngle>e}function svt(t,e){const r=An(t.cosAngle),i=Lq.fwd,s=Lq.ortho;return my(i,t.position1,t.position0),r*(_e(pt(s,t.faceNormal0,t.faceNormal1),i)>0?-1:1)>e}function nvt(t){const e=t.faces.length/3,r=t.faces,i=t.neighbors;let s=0;for(let a=0;a<e;a++){const l=i[3*a+0],c=i[3*a+1],h=i[3*a+2],p=r[3*a+0],f=r[3*a+1],m=r[3*a+2];s+=l===bb||p<f?1:0,s+=c===bb||f<m?1:0,s+=h===bb||m<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<e;a++){const l=i[3*a+0],c=i[3*a+1],h=i[3*a+2],p=r[3*a+0],f=r[3*a+1],m=r[3*a+2];(l===bb||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===bb||f<m)&&(n[o++]=f,n[o++]=m,n[o++]=a,n[o++]=c),(h===bb||m<p)&&(n[o++]=m,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function ovt(t){const e=t.faces.length/3,r=t.vertices.position,i=t.faces,s=KV.v0,n=KV.v1,o=KV.v2,a=new Float32Array(3*e);for(let l=0;l<e;l++){const c=i[3*l+0],h=i[3*l+1],p=i[3*l+2];r.getVec(c,s),r.getVec(h,n),r.getVec(p,o),ge(n,n,s),ge(o,o,s),pt(s,n,o),ve(s,s),a[3*l+0]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(F4||(F4={}));const Lq={edge:{position0:M(),position1:M(),faceNormal0:M(),faceNormal1:M(),componentIndex:0,cosAngle:0},ortho:M(),fwd:M()},KV={v0:M(),v1:M(),v2:M()},avt={anglePlanar:4,angleSignificantEdge:35};function lvt(t){const e=cvt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Zce.updateSettings(t.writerSettings),Jce.updateSettings(t.writerSettings),tvt(e,Zce,Jce)}function cvt(t,e,r,i){if(e){const o=Xce(r,i,t.count);return new uvt(r,i,o,t)}const s=WH(t.buffer,t.stride/4,{originalIndices:r,originalIndicesLength:i}),n=Xce(s.indices,i,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:$4.createView(s.buffer)}}let uvt=class{constructor(e,r,i,s){this.faces=e,this.facesLength=r,this.neighbors=i,this.vertices=s}};const Zce=new D4,Jce=new N4,u5t=is().vec3f(A.POSITION0).vec3f(A.POSITION1),hvt=is().vec3f(A.POSITION0).vec3f(A.POSITION1).u16(A.COMPONENTINDEX).u16(A.U16PADDING,{glPadding:!0});let dvt=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},pvt=class{constructor(e,r=1){this._rctx=e,this._fieldCount=r,this.textureWidth=4096,this._dirty=!0,this._texture=new ct(this._rctx,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,wrapMode:Ot.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this._data=new Aa(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,r,i,s,n,o){const a=e*this._fieldCount+r;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,s),this._data.set(a,2,n),this._data.set(a,3,o)}setDataElement(e,r,i,s){const n=e*this._fieldCount+r;this._dirty=!0,this._data.set(n,i,s)}resizeToFit(e){const r=e*this._fieldCount;if(r>=this._data.count){const i=Math.ceil((r+1)/this.textureWidth)*this.textureWidth,s=new Aa(new ArrayBuffer(4*i));s.typedBuffer.set(this._data.typedBuffer),this._data=s}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,r=this._texture.descriptor.height;this._data.count>e*r&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const UAe=65536;let fvt=class{constructor(e,r=1){this.textureBuffer=new pvt(e,r),this._indexManager=new dvt(UAe)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},VAe=class{constructor(e,r=1){this._rctx=e,this._fieldCount=r,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>UAe)return null;const r=new fvt(this._rctx,this._fieldCount);return this._buffers.push(r),r}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const Kce=se.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class mvt{constructor(e,r){this._renderManager=e,this._viewingMode=r,this._objects=[new Kt,new Kt],this._renderSubmit=new F_t(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=de("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new VAe(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){gt(this._objects[DS.Hidden].length===0&&this._objects[DS.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const r=new KR;return r.toMapSpace=e.toMapSpace,r.transform=e.transform,r.obb=Uce(e.obb),r.components=new y_t(this._componentBufferManager,e.geometry.componentOffsets),r.renderable=this._createRenderable(e,r.components),r.intersectionGeometry=new S_t(e.geometry.positionData,r.components),this._objects[r.visible].push(r),r}destroyObject(e){const r=e;this._objects[r.visible].removeUnordered(r),r.destroy(),this._notifyDirty()}setObjectVisibility(e,r){const i=e;r!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[r].push(i),i.visible=r,this._notifyDirty())}preSubmit(e){const r=e.camera.eye;this.visibleObjects.forAll(i=>i.renderable.meta.cameraDepthSquared=Vn(r,i.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,r){const i=e.renderable.material;r(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,r){const i=e;i.components.visibility.reset(r),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,r){return e.components.visibility.forEachComponent(r)}getComponentCount(e){const r=e,i=r.components.visibility.componentCount();return{visible:i,invisible:r.components.count-i}}setComponentData(e,r){const i=e,s=i.renderable.material,n=i.components,o=n.materialDataBuffer,a=n.materialDataIndices,l=new V_t,c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,m=0,y=0,_=n.verticalOffsets,b=1/0,x=-1/0,T=!1,S=!1,E=0;for(let O=0;O<n.count;O++){r(O,l),f+=+(l.externalColor[3]<1),m+=+(l.externalColorMixMode===wn.Replace&&l.externalColor[3]===1),y+=+l.castShadows,tEe(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[O],0,h[0],h[1],h[2],h[3]),T||(T=O>0&&E!==p[0]),E=p[0],S||(S=l.elevationOffset!==0),S&&C(_)&&(_=new Array(O).fill(0)),v(_)&&(_[O]=l.elevationOffset),b=Math.min(b,l.elevationOffset),x=Math.max(x,l.elevationOffset),MAe(l.elevationOffset,h),c.setData(a[O],1,h[0],h[1],h[2],h[3]);const R=l.objectAndLayerIdColor;v(R)&&c.setData(a[O],2,R[0],R[1],R[2],R[3]),l.pickable!==AAe(n.pickability,O)&&(n.pickability=v_t(n.pickability,n.count,O,l.pickable))}n.verticalOffsets=S?_:null,i.offsetObb=S?f_t(i.obb,b,x,this._viewingMode,v(i.offsetObb)?i.offsetObb:Uce(i.obb)):null,T||S||this._hasObjectAndLayerId?(s.componentParameters=new QR,s.componentParameters.castShadows=QV(y,n.count),s.componentParameters.transparent=QV(f,n.count),s.componentParameters.opaqueOverride=QV(m,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new QO,s.componentParameters.castShadows=l.castShadows?Nn.All:Nn.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._notifyDirty()}getComponentAabb(e,r,i,s=!1){e.intersectionGeometry.getComponentAabb(r,i);const n=e,o=n.components.verticalOffsets;if(s||C(o))return i;const a=o[r];if(this._viewingMode===Be.Local||a===0)return i[2]+=a,i[5]+=a,i;const l=TUe(a);return l.localOrigin=n.transform.position,l.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,r,i){return e.intersectionGeometry.getComponentPositions(r,i)}intersect(e,r,i,s,n,o){const a=e;v(n)&&(n.localOrigin=a.transform.position);const l=ox(Qce,a.transform.rotationScale);so(oL,r,a.transform.position),so(aL,i,a.transform.position),Oc(oL,oL,l),Oc(aL,aL,l);const c=Kh(Qce,l);return a.intersectionGeometry.intersect(oL,aL,s,c,n,a.components.verticalOffsets,o)}addEdges(e,r,i,s){const n=e,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return r.addComponentObject(e,n.transform,{center:n.obb.center,radius:p_t(n.obb)},a,o,l,i,s)}async extractEdgeInformation(e,r,i){const s=e,n=s.components.visibility;if(n.allInvisible())return{buffer:hvt.createBuffer(0),origin:[0,0,0]};const{indices:o,positions:a}=s.intersectionGeometry,l=s.components.offsets,c=$4.createBuffer(a.count);H6(c.position,a),_v(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,o,l);const h=c.count,p=this._computeVisibilityIndices(o,n,l,h);return{origin:gs(s.transform.position),buffer:await r.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,r,i){let s=0;for(let n=0;n<i.length-1;n++){const o=i[n],a=i[n+1];for(let l=o;l<a;l++){const c=r?r[l]:l;e.set(c,s)}s++}}_computeVisibilityIndices(e,r,i,s){if(e&&r.allVisible())return e;let n=0;r.forEachComponentRange((l,c)=>(n+=i[c]-i[l],!0));const o=Array.isArray(e)?new Array(n):(e==null?void 0:e.BYTES_PER_ELEMENT)===2||s<=65536?new Uint16Array(n):new Uint32Array(n);let a=0;return r.forEachComponentRange((l,c)=>{const h=i[l],p=i[c];for(let f=h;f<p;f++)o[a++]=e?e[f]:f;return!0}),o}addComponentHighlight(e,r){const i=e.components;C(i.highlightCounts)&&(i.highlightCounts=new Uint32Array(i.count+1)),i.highlightCounts[r]++===0&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,r){const i=e.components;if(C(i.highlightCounts))return void Kce.warn("Removing non-existing highlight.");const s=i.highlightCounts[r],n=i.highlightCounts[i.count];if(s!==0){if(s>1)return i.highlightCounts[r]=s-1,void(i.highlightCounts[i.count]=n-1);i.highlightCounts[r]=0,i.highlightsDirty(),this._notifyDirty(),n===1?i.highlightCounts=null:i.highlightCounts[i.count]=n-1}else Kce.warn("Removing non-existing highlight.")}clearHighlights(e){const r=e.components;v(r.highlightCounts)&&(r.highlightCounts=null,r.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[DS.Visible]}_createRenderable(e,r){const i=this._renderManager.rctx,s=e.geometry,n=s.vertices.layoutParameters,o=jr.createVertex(i,$r.STATIC_DRAW,s.vertices.data),a=ao(s.indices,_=>jr.createIndex(i,$r.STATIC_DRAW,_)),l=Hc(U_t(n)),c=new Uint16Array(s.vertices.count);for(let _=0;_<r.count;_++){const b=r.offsets[_],x=r.offsets[_+1],T=r.materialDataIndices[_];if(v(s.indices))for(let S=b;S<x;S++)c[s.indices[S]]=T;else for(let S=b;S<x;S++)c[S]=T}const h=jr.createVertex(i,$r.STATIC_DRAW,c.buffer),p=new Zn(e.transform,e.toMapSpace),f=new ed(i,$Ae,{data:l,componentIndices:gvt},{data:o,componentIndices:h},a),m=new R_t(f,$t.TRIANGLES,n,v(a)),y={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteSize+h.byteSize+(v(a)?a.byteSize:0)};return new A_t(p,m,y)}_notifyDirty(){this._renderManager.notifyDirty()}}const gvt=Hc(is().u16(A.COMPONENTINDEX));function QV(t,e){return t===e?Nn.All:t===0?Nn.None:Nn.Some}const Qce=Hl(),oL=M(),aL=M();let kAe=class extends pi{constructor(){super(...arguments),this.opacity=1}};function yvt(t){const e=new Lr;return e.include(sd),e.fragment.uniforms.add(new Pt("tex",r=>r.texture)),t.hasOpacityFactor&&e.fragment.uniforms.add(new Pe("opacity",r=>r.opacity)),e.fragment.code.add(w`
    void main() {
      gl_FragColor = texture2D(tex, uv) ${t.hasOpacityFactor?"* opacity":""};
    }`),e}const _vt=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:kAe,build:yvt},Symbol.toStringTag,{value:"Module"}));var _a;(function(t){t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.PremultipliedAlpha=2]="PremultipliedAlpha",t[t.COUNT=3]="COUNT"})(_a||(_a={}));let Dq=class extends Pa{constructor(){super(...arguments),this.alphaMode=_a.None,this.hasOpacityFactor=!1}};u([k({count:_a.COUNT})],Dq.prototype,"alphaMode",void 0),u([k()],Dq.prototype,"hasOpacityFactor",void 0);let zAe=class BAe extends kr{initializeProgram(e){return new Nr(e.rctx,BAe.shader.get().build(this.configuration),Ar)}initializePipeline(){switch(this.configuration.alphaMode){case _a.None:return zt({colorWrite:Qt});case _a.Alpha:return zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt});case _a.PremultipliedAlpha:case _a.COUNT:return zt({blending:Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt})}}};zAe.shader=new Dr(_vt,()=>ie(()=>import("./Compositing.glsl-6b385cea.js"),[],import.meta.url));let GAe=class extends pi{};function vvt(){const t=new Lr;return t.include(sd),t.fragment.uniforms.add(new Pt("tex",e=>e.texture)),t.fragment.code.add(w`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),t}const bvt=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:GAe,build:vvt},Symbol.toStringTag,{value:"Module"}));let jAe=class HAe extends kr{initializeProgram(e){return new Nr(e.rctx,HAe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};jAe.shader=new Dr(bvt,()=>ie(()=>import("./HUDCompositing.glsl-ab165e02.js"),[],import.meta.url));let qAe=class extends pi{};function wvt(){const t=new Lr;return t.include(sd),t.fragment.uniforms.add([new Pt("colorTexture",e=>e.colorTexture),new Pt("alphaTexture",e=>e.alphaTexture),new Pt("frontFaceTexture",e=>e.frontFaceTexture)]),t.fragment.code.add(w`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),t}const xvt=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:qAe,build:wvt},Symbol.toStringTag,{value:"Module"}));let WAe=class XAe extends kr{initializeProgram(e){return new Nr(e.rctx,XAe.shader.get().build(),Ar)}initializePipeline(){return zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt})}};WAe.shader=new Dr(xvt,()=>ie(()=>import("./OITCompositing.glsl-ee418071.js"),[],import.meta.url));let YAe=class extends pi{constructor(){super(...arguments),this.overlayIndex=es.INNER,this.opacity=1}};function Tvt(){const t=new Lr;return t.include(sd),t.fragment.uniforms.add(new Pt("tex",e=>e.texture)),t.fragment.uniforms.add(new dP("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new Pe("opacity",e=>e.opacity)),t.fragment.code.add(w`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
gl_FragColor = texture2D(tex, overlayUV) * opacity;
}`),t}const Svt=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:YAe,build:Tvt},Symbol.toStringTag,{value:"Module"}));let ZAe=class JAe extends kr{initializeProgram(e){return new Nr(e.rctx,JAe.shader.get().build(),Ar)}initializePipeline(){return zt({blending:Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt})}};ZAe.shader=new Dr(Svt,()=>ie(()=>import("./OverlayCompositing.glsl-e36b2e5e.js"),[],import.meta.url));let Evt=class{constructor(e,r){this._rctx=e,this._techniqueRepository=r,this._configuration=new Dq,this._passParameters=new kAe,this._oitParameters=new qAe,this._hudParameters=new GAe,this._overlayParameters=new YAe}destroy(){this._vao=et(this._vao)}compositeOIT(e,r,i,s){this._oitParameters.colorTexture=r,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=s;const n=this._rctx,o=this._techniqueRepository.acquire(WAe);n.bindTechnique(o,this._oitParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays($t.TRIANGLE_STRIP,0,Ko(a,"geometry")),o.release()}compositeHUD(e,r){this._hudParameters.texture=r;const i=this._rctx,s=this._techniqueRepository.acquire(jAe);i.bindTechnique(s,this._hudParameters,e);const n=this._ensureVAO();i.bindVAO(n),i.drawArrays($t.TRIANGLE_STRIP,0,Ko(n,"geometry")),s.release()}compositeOverlay(e,r,i,s){this._overlayParameters.texture=r,this._overlayParameters.opacity=i,this._overlayParameters.overlayIndex=s;const n=this._rctx,o=this._techniqueRepository.acquire(ZAe);n.bindTechnique(o,this._overlayParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays($t.TRIANGLE_STRIP,0,Ko(a,"geometry")),o.release()}composite(e,r,i=_a.None,s=1){const n=this._rctx;this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=s!==1,this._passParameters.texture=r,this._passParameters.opacity=s;const o=this._techniqueRepository.acquire(zAe,this._configuration);n.bindTechnique(o,this._passParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays($t.TRIANGLE_STRIP,0,Ko(a,"geometry")),o.release()}_ensureVAO(){return C(this._vao)&&(this._vao=Ia(this._rctx)),this._vao}};const Cvt=1e4,Nq=100,Avt=500,Rvt=500,Ovt=.1;function Mvt(t,e,r){return $J(e,t)*(r[1]-r[0])+r[0]}function Pvt(t,e,r){let i=0;if(!e.some(n=>(i+=n.numGeometries,i>=Cvt)))return Vvt.compute(t,e);const s=mP();return r.forAll(n=>{n.visible&&FE(s,Ivt(t,n))}),s}function Ivt(t,e){if(!e.visible)return;const r=mP(),i=e.getSpatialQueryAccelerator();return v(i)?$vt(r,t,i):Lvt(r,t,e.objects),r}function $vt(t,e,r){const i=e.eye,s=e.viewForward,n=e.frustum,o=l=>l.visible,a=r.objectCount;if(a<Avt)oM(Th,e.near,Math.min(t.near,e.far)),r.forEachInDepthRange(i,s,cp.DepthOrder.FRONT_TO_BACK,Th,(l,c)=>{Fq(t,e,l),Th.far=t.near,c.setRange(Th)},n,o),oM(Th,Math.max(t.far,e.near),e.far),r.forEachInDepthRange(i,s,cp.DepthOrder.BACK_TO_FRONT,Th,(l,c)=>{Fq(t,e,l),Th.near=t.far,c.setRange(Th)},n,o);else{const l=Math.max(Math.min(a,Rvt),Math.ceil(a*Ovt)),c=r.findClosest(s,cp.DepthOrder.FRONT_TO_BACK,n,o,l),h=r.findClosest(s,cp.DepthOrder.BACK_TO_FRONT,n,o,l);c&&h&&(eue(t,e,c.boundingVolumeWorldSpace.bounds),eue(t,e,h.boundingVolumeWorldSpace.bounds))}}function Lvt(t,e,r){xT.clear(),r.forAll(i=>{i.visible&&i.geometries.length!==0&&xT.add(i)}),xT.empty||(xT.sort(e),oM(Th,e.near,Math.min(t.near,e.far)),xT.forEachInDepthRange(Th,cp.DepthOrder.FRONT_TO_BACK,(i,s)=>{s<t.near&&Fq(t,e,i)}),oM(Th,Math.max(t.far,e.near),e.far),xT.forEachInDepthRange(Th,cp.DepthOrder.BACK_TO_FRONT,(i,s,n)=>{t.far=Math.max(t.far,n)}))}function Fq(t,e,r){if(!r.visible||!I_(e.frustum,r.boundingVolumeWorldSpace.bounds))return;const i=r.transformation,s=Uvt;r.geometries.forEach(n=>{ys(s,i,n.shaderTransformation);const o=Mw(s);KAe(t,e,n.boundingInfo,s,o)})}function KAe(t,e,r,i,s){if(C(r))return;Xe(qo,r.center,i);const{eye:n,viewForward:o}=e,a=o[0]*(qo[0]-n[0])+o[1]*(qo[1]-n[1])+o[2]*(qo[2]-n[2]);if(qo[3]=r.radius*s,!(a-qo[3]>t.near&&a+qo[3]<t.far)&&I_(e.frustum,qo))if(r.radius>Nq&&r.getChildren())for(const l of r.getChildren())KAe(t,e,l,i,s);else Uq.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function eue(t,e,r){const i=e.eye,s=e.viewForward,n=(r[0]-i[0])*s[0]+(r[1]-i[1])*s[1]+(r[2]-i[2])*s[2];t.near=Math.min(t.near,n-r[3]),t.far=Math.max(t.far,n+r[3])}let Dvt=class{constructor(){this._items=new Kt({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const r=e.eye,i=e.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-r[0])*i[0]+(n[1]-r[1])*i[1]+(n[2]-r[2])*i[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(e,r,i){if(r===cp.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<e.near||n.near>e.far||i(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<e.near||n.near>e.far||i(n.obj,n.near,n.far)}}},Nvt=class{constructor(){this._view=Ie(),this._viewProj=Ie(),this._frustum=w3(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,r){this._reset(),kn(this._view,e.viewMatrix),ys(this._viewProj,e.projectionMatrix,this._view),hF(this._frustum,e.frustum);const i=this._view,s=i[2],n=i[6],o=i[10],a=i[14];r.forAll(f=>f.forEachGeometry(m=>{if(!m.visible||!m.castShadow)return;let y;m.hasShaderTransformation?(m.computeBoundingSphere(m.shaderTransformation,qo,1),y=qo):y=m.boundingSphere;const _=s*y[0]+n*y[1]+o*y[2]+a,b=_-y[3],x=_+y[3];this._geometries.push(m),this._near.push(-x),this._far.push(-b)}));const l=new O_t;if(this._geometries.length===0)return l;for(let f=0;f<this._geometries.length;++f)this._near[f]>l.far&&(l.far=this._near[f]),this._near[f]>2&&this._far[f]<l.near&&(l.near=this._far[f]);const c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;let h=0,p=0;for(let f=0;f<this._geometries.length;++f)this._near[f]<l.near&&(this._near[f]>=c.near?l.near=this._near[f]:this._nearCandidates[h++]=f),this._far[f]>l.far&&(this._far[f]<=c.far?l.far=this._far[f]:this._farCandidates[p++]=f);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((f,m)=>this._near[f]<this._near[m]?-1:this._near[f]>this._near[m]?1:0),this._farCandidates.sort((f,m)=>this._far[f]<this._far[m]?1:this._far[f]>this._far[m]?-1:0);for(let f=0;f<this._nearCandidates.length;++f){const m=this._nearCandidates[f];if(this._near[m]<l.near){const y=this._geometries[m],_=y.boundingInfo;this._includeNearBoundingInfoRec(_,y.shaderTransformation,l)}}for(let f=0;f<this._farCandidates.length;++f){const m=this._farCandidates[f];if(this._far[m]>l.far){const y=this._geometries[m],_=y.boundingInfo;this._includeFarBoundingInfoRec(_,y.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,r,i){if(C(e))return;const s=e.center;Xe(qo,s,r);const n=Mw(r),o=qo[0],a=qo[1],l=qo[2],c=e.radius*n,h=this._frustum;if(h[0][0]*o+h[0][1]*a+h[0][2]*l+h[0][3]>c||h[1][0]*o+h[1][1]*a+h[1][2]*l+h[1][3]>c||h[2][0]*o+h[2][1]*a+h[2][2]*l+h[2][3]>c||h[3][0]*o+h[3][1]*a+h[3][2]*l+h[3][3]>c)return;const p=this._view[2]*o+this._view[6]*a+this._view[10]*l+this._view[14],f=p+c;if(!(-(p-c)<2||-f>=i.near))if(-f>this._looseRange.near)i.near=-f;else{if(c>Nq){const m=e.getChildren();if(m!==void 0){for(const y of m)this._includeNearBoundingInfoRec(y,r,i);return}}Uq.unionDepthRangeWithAABB(i,this._viewProj,r,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,r,i){if(C(e))return;let s=e.radius;const n=e.center;Xe(qo,n,r);const o=Mw(r),a=qo[0],l=qo[1],c=qo[2];s*=o;const h=this._frustum;if(h[0][0]*a+h[0][1]*l+h[0][2]*c+h[0][3]>s||h[1][0]*a+h[1][1]*l+h[1][2]*c+h[1][3]>s||h[2][0]*a+h[2][1]*l+h[2][2]*c+h[2][3]>s||h[3][0]*a+h[3][1]*l+h[3][2]*c+h[3][3]>s)return;const p=this._view[2]*a+this._view[6]*l+this._view[10]*c+this._view[14]-s;if(!(-p<=i.far))if(-p<this._looseRange.far)i.far=-p;else{if(s>Nq){const f=e.getChildren();if(f!==void 0){for(const m of f)this._includeFarBoundingInfoRec(m,r,i);return}}Uq.unionDepthRangeWithAABB(i,this._viewProj,r,e.bbMin,e.bbMax)}}},Fvt=class{constructor(){this._modelViewProj=Ie(),this._clipPosition=[nr(),nr(),nr(),nr(),nr(),nr(),nr(),nr()]}unionDepthRangeWithAABB(e,r,i,s,n){const o=this._modelViewProj;ys(o,r,i);let a=!1;for(let l=0;l<8;++l){const c=this._clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this._clipPosition[ek[l][0]],h=this._clipPosition[ek[l][1]],p=this._clipPosition[ek[l][2]],f=this._clipTriangle(c,h,p);let m=!0;for(let y=0;y<f.length;++y)if(f[y][3]>=2){m=!1;break}if(!m){a=!0;for(let y=0;y<f.length;++y){const _=f[y][3];Number.isFinite(_)&&(e.near=Math.min(_,e.near),e.far=Math.max(_,e.far))}}}return a}_inside(e,r){return r===0?e[0]>=-e[3]:r===1?e[1]>=-e[3]:r===2?e[0]<=e[3]:r===3?e[1]<=e[3]:void gt(!1)}_intersect(e,r,i){let s=0;return i===0?s=(-e[3]-e[0])/(r[0]-e[0]+r[3]-e[3]):i===1?s=(-e[3]-e[1])/(r[1]-e[1]+r[3]-e[3]):i===2?s=(e[3]-e[0])/(r[0]-e[0]-r[3]+e[3]):i===3&&(s=(e[3]-e[1])/(r[1]-e[1]-r[3]+e[3])),e5(nr(),e,r,s)}_clipTriangle(e,r,i){let s=[e,r,i];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}};const ek=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],qo=cn(),Uvt=Ie(),Th=mP(),xT=new Dvt,Vvt=new Nvt,Uq=new Fvt;let kvt=class{},zvt=class extends pi{constructor(){super(...arguments),this.textures=new kvt}};function Bvt(){const t=new Lr;return t.attributes.add(A.POSITION,"vec2"),t.vertex.uniforms.add(new fr("drawPosition",(e,r)=>Gvt(e,r))),t.varyings.add("vUV","vec2"),t.vertex.code.add(w`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),t.fragment.uniforms.add(new Pt("textureInput",e=>e.textures.input)),t.fragment.uniforms.add(new Pt("textureMask",e=>e.textures.mask)),t.fragment.uniforms.add(new Pt("textureOverlay",e=>e.textures.overlay)),t.fragment.uniforms.add(new Yg("maskEnabled",e=>e.magnifier.maskEnabled)),t.fragment.uniforms.add(new Yg("overlayEnabled",e=>e.magnifier.overlayEnabled)),t.fragment.code.add(w`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),t}function Gvt(t,e){const r=e.camera.pixelRatio,i=t.magnifier.offset.x*r,s=t.magnifier.offset.y*r;Ff(t.magnifier.position,tue);const n=e.camera.screenToRender(tue,jvt),o=Math.ceil(r*t.magnifier.size),a=e.camera.fullWidth,l=e.camera.fullHeight;return ti(Hvt,(n[0]+i)/a*2-1,(n[1]-s)/l*2-1,o/a*2,o/l*2)}const tue=cs(),jvt=Tme(),Hvt=nr();async function qvt(t){const e=ie(()=>import("./mask-svg-023bbc42.js"),[],import.meta.url),r=ie(()=>import("./overlay-svg-d62383f3.js"),[],import.meta.url),i=dy((await e).default,{signal:t}),s=dy((await r).default,{signal:t}),n={mask:await i,overlay:await s};return ur(t),n}let A2=class extends Te{constructor(){super(...arguments),this._handles=new Zr,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new zvt,this.events=new Fs,this.attributeLocations=new Map([[A.POSITION,0]]),this._tmpScreenPoint=cs(),this._tmpRenderPoint=Tme()}get updating(){return C(this._imageSources)&&v(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const r=()=>{this._updateResourceLoading(),this.events.emit("request-render")};v(this._magnifier)&&this._handles.add(ne(()=>ao(this._magnifier,i=>i.version),r)),r()}get enabled(){return v(this._validMagnifier)}get _validMagnifier(){return v(this._magnifier)&&this._magnifier.visible&&v(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get _factor(){return v(this._magnifier)&&this._magnifier.factor||1}destroy(){this._magnifier=null,this._handles.destroy(),v(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,r){const i=this._validMagnifier;if(C(i))return;const s=r.camera.pixelRatio,n=Math.ceil(s*i.size);if(this._updateResources(e,n),C(this._resources))return;const o=this._passParameters.textures,a=Math.ceil(1/this._factor*n);o.input.resize(a,a),Ff(i.position,this._tmpScreenPoint);const l=r.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=r.camera.fullWidth,h=r.camera.fullHeight,p=.5*a,f=.5*a;l[0]=ye(l[0],p,c-p-1),l[1]=ye(l[1],f,h-f-1);const m=Math.floor(l[0]-p),y=Math.floor(l[1]-f),_=this._resources.program;_.bindTexture("textureInput",o.input),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,m,y,a,a,0),this._passParameters.magnifier=i,e.useProgram(_),_.bindPass(this._passParameters,r),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays($t.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(C(e))return;const r=e.maskUrl,i=e.overlayUrl;!v(this._imageLoadTask)||this._imageLoadTask.maskUrl===r&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),v(this._imageSources)||v(this._imageLoadTask)||(this._imageLoadTask={maskUrl:r,overlayUrl:i,task:EM(async s=>{const n=C(r)||C(i)?qvt(s):null,o=v(r)?dy(r,{signal:s}):n.then(l=>l.mask),a=v(i)?dy(i,{signal:s}):n.then(l=>l.overlay);this._imageSources={mask:await o,overlay:await a},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,r){if(!this.enabled)return void this._disposeResources();if(v(this._resources)){if(this._passParameters.textures.size!==r){const s=this._createTextureResources(e,r);if(C(s))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=s}return}const i=this._createTextureResources(e,r);C(i)||(this._resources={program:this._createProgram(e),vao:Ia(e,UZ,this.attributeLocations,0,1),pipelineState:zt({blending:Mp(Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Qt})},this._passParameters.textures=i)}_disposeResources(){C(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,r){if(C(this._imageSources))return null;this._imageSources.overlay.width=r,this._imageSources.overlay.height=r,this._imageSources.mask.width=r,this._imageSources.mask.height=r;const i=new ct(e,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0,preMultiplyAlpha:!ede(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),s=new ct(e,{target:wt.TEXTURE_2D,pixelFormat:ze.ALPHA,internalFormat:ze.ALPHA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!0},this._imageSources.mask);return{input:new ct(e,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR,flipped:!1}),mask:s,overlay:i,size:r}}_createProgram(e){return new Nr(e,Bvt(),this.attributeLocations)}};u([d()],A2.prototype,"_imageSources",void 0),u([d()],A2.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],A2.prototype,"updating",null),A2=u([P("esri/views/3d/webgl-engine/lib/MagnifierHelper")],A2);let Wvt=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new Aa(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,r,i,s,n,o=null,a=null,l=null){if(!(e&&r&&i&&s)||(this._layerUidToId.set(s,i),this._layerUidToPopupEnabled.set(s,n),!n))return;let c=this._layerUidToGraphicsUidToObjectId.get(s);c||(c=new Map,this._layerUidToGraphicsUidToObjectId.set(s,c)),c.set(r,{objectId:e,attributeNodeId:o,attributeIndex:a,subLayerId:l})}getObjectAndLayerIdColor(e){const r=this.getObjectAndLayerIdColorArray(e);return qt(r.get(0,1),r.get(0,2),r.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const r=this._layerUidToPopupEnabled.get(e.layerUid);if(r===void 0)return se.getLogger(this.declaredClass).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(r===!1)return this.colorZero;let i=this._uidToRenderColor.get(e.layerUid);i||(i=new Map,this._uidToRenderColor.set(e.layerUid,i));let s=i.get(e.graphicUid);if(!s){for(;!s;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(s=o)}if(s>16777215)throw new Error("Object ID Overflow");i.set(e.graphicUid,s),this._colorToUID.set(s,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,s,!1),new Aa(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[r,i]of this._colorToUID.entries()){const s=this._layerUidToGraphicsUidToObjectId.get(i.layerUid);let n=null;s?(n=s.get(i.graphicUid),n||se.getLogger(this.declaredClass).warn("getColorMapping: no entry found for graphicsId "+i.graphicUid)):se.getLogger(this.declaredClass).warn("getColorMapping: no entry found for layerUid "+i.layerUid);const o=this._layerUidToId.get(i.layerUid);o||se.getLogger(this.declaredClass).warn("no layerId found for uid "+i.layerUid),n&&o&&e.set(r,n.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:n.objectId,lid:o,attrId:n.attributeNodeId,attrIdx:n.attributeIndex,subLayerId:n.subLayerId}:{type:"object-and-layer-id",oid:n.objectId,lid:o})}return e}};var aM;(function(t){t[t.FrontToBack=0]="FrontToBack",t[t.BackToFront=1]="BackToFront"})(aM||(aM={}));let v0=class{constructor(e,r,i=aM.FrontToBack){this._rctx=e,this._techniqueRepository=r,this._sorting=i,this._draws=new Kt({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,r,i,s){const n=this._draws.pushNew();n.geometry=r,n.geometryRanges=i,n.material=e,n.depthSquaredHint=s,n.indexType=(r.indexed?r.vao.indexBuffer.indexType:null)??0}dispatch(e,r){const i=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.map(a=>a.material.prepareTechnique(this._techniqueRepository,e,r,a.geometry.parameters)),o=this._draws.length;for(let a=0;a<o;a++){const l=n[a];l===s&&l.configuration.transparencyPassType===Tt.NONE||(i.bindTechnique(l,e,r),s=l);const c=this._draws.data[a],h=c.geometry;i.bindVAO(h.vao),this._previouslyBoundDraw.get(l)!==c.material&&(l.program.bindDraw(c.material,r,e),this._previouslyBoundDraw.set(l,c.material));const p=c.geometryRanges,f=p.length;if(c.indexType!==0){const m=gN.get(c.indexType);for(let y=0;y<f;y+=2){const _=p[y],b=p[y+1];i.drawElements(h.primitiveType,b,c.indexType,_*m)}}else for(let m=0;m<f;m+=2){const y=p[m],_=p[m+1];i.drawArrays(h.primitiveType,y,_)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===aM.FrontToBack?1:-1;this._draws.sort((r,i)=>{const s=e*(r.depthSquaredHint-i.depthSquaredHint);return s!==0?s:r.geometry.vao.size-i.geometry.vao.size})}get count(){return this._draws.length}};const gN=new Map;gN.set(lt.UNSIGNED_BYTE,1),gN.set(lt.UNSIGNED_SHORT,2),gN.set(lt.UNSIGNED_INT,4);let Xvt=class{constructor(e,r){this.rctx=e,this.shaderTechniqueRepository=r,this.canRender=!0,this._materialPassParameters=new byt,this._shadowPassParameters=new wyt,this._highlightPassParameters=new xyt,this._systems=new Set,this._passes={materialOpaque:new v0(e,r),materialTransparent:new v0(e,r,aM.BackToFront),materialIntegratedMesh:new v0(e,r),shadowMap:new v0(e,r),highlight:new v0(e,r),highlightIntegratedMesh:new v0(e,r),highlightShadowMap:new v0(e,r),defaultShadowMap:new v0(e,r)}}register(e){this._systems.add(e)}prepareRender(e){if(this._systems.size!==0){for(const r of Object.values(this._passes))r.prepareSubmit();this._systems.forEach(r=>r.submit(this._passes,e.bindParameters));for(const r of Object.values(this._passes))r.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(e){if(this._systems.size!==0)switch(this._configure(e),this._materialPassParameters.output=e.output,e.bindParameters.slot){case Se.OPAQUE_MATERIAL:switch(e.output){case V.Color:case V.Depth:case V.Normal:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case V.Highlight:return this._passes.highlight.dispatch(this._highlightPassParameters,e.bindParameters);case V.Shadow:return this._passes.shadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case V.ShadowHighlight:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case V.ShadowExcludeHighlight:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case V.ObjectAndLayerIdColor:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters)}return;case Se.TRANSPARENT_MATERIAL:switch(e.output){case V.Color:case V.Alpha:case V.Depth:case V.Normal:case V.ObjectAndLayerIdColor:return this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters)}return;case Se.INTEGRATED_MESH:switch(e.output){case V.Color:case V.Depth:case V.Normal:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case V.Highlight:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,e.bindParameters);case V.ObjectAndLayerIdColor:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters)}return}}notifyDirty(){this._context.requestRender()}slots(){return[Se.OPAQUE_MATERIAL,Se.TRANSPARENT_MATERIAL,Se.INTEGRATED_MESH]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const r={near:1/0,far:-1/0};return this._systems.forEach(i=>{const s=i.queryShadowCasterDepthRange(e);v(s)&&FE(r,s,r)}),r}_configure(e){const r=e.output===V.Shadow||e.output===V.ShadowHighlight||e.output===V.ShadowExcludeHighlight?this._shadowPassParameters:e.output===V.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,r)}_updateParameters(e,r){const i=e.bindParameters.camera,s=i.viewInverseTransposeMatrix;ce(tk,s[3],s[7],s[11]),rk.set(tk),le(r.transformWorldFromViewTH,rk.high),le(r.transformWorldFromViewTL,rk.low),le(r.slicePlaneLocalOrigin,tk),Jh(r.transformViewFromCameraRelativeRS,i.viewMatrix),kn(r.transformProjFromView,i.projectionMatrix),r.identifier===Rc.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===Se.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===Se.INTEGRATED_MESH,Kh(rue,r.transformViewFromCameraRelativeRS),ox(r.transformNormalViewFromGlobal,rue))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}};const tk=M(),rue=rs(),rk=new tU;let Yvt=class{constructor(){this._step=nue,this._dilation=1,this._firstIdleTime=0}frame(e,r){if(r?this._firstIdleTime===0&&(this._firstIdleTime=performance.now()):this._firstIdleTime=0,de("enable-feature:high-quality-idle")){const s=r?performance.now()-this._firstIdleTime:0;if(s>=iue+Jvt)return this._step=1/0,void(this._dilation=1);this._dilation=s>=iue?Kvt:1}else this._dilation=1;const i=ye(e/Zvt,nue,e1t);this._step===1/0?this._step=i:this._step=this._step*sue+i*(1-sue)}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=0}};const Zvt=.5,iue=6e4,Jvt=5e3,Kvt=10,sue=.9,Qvt=30,nue=1e3/1,e1t=1e3/Qvt,t1t=8.6,r1t=.4;function i1t(){const t=new Lr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(A.POSITION,"vec2"),t.varyings.add("uv","vec2"),t.attributes.add(A.UV0,"vec2"),e.uniforms.add(new Pt("coverageTex",n=>n.coverageTexture)),i.add(w`void main() {
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),r.uniforms.add(new Pt("tex",n=>n.blurColorTexture)),r.uniforms.add(new Pt("origin",n=>n.highlightColorTexture)),r.uniforms.add(new fr("uColor",n=>n.color)),r.uniforms.add(new fr("haloColor",n=>n.haloColor)),r.uniforms.add(new fr("opacities",n=>ti(s1t,n.haloOpacity,n.haloOpacityOccluded,n.fillOpacity,n.fillOpacityOccluded))),r.constants.add("outlineSize","float",t1t),r.constants.add("blurSize","float",r1t),s.add(w`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),t}const s1t=nr(),n1t=Object.freeze(Object.defineProperty({__proto__:null,build:i1t},Symbol.toStringTag,{value:"Module"}));let QAe=class eRe extends kr{initializeProgram(e){return new Nr(e.rctx,eRe.shader.get().build(),Ar)}initializePipeline(){return zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt})}};QAe.shader=new Dr(n1t,()=>ie(()=>import("./HighlightApply.glsl-6cfb4dda.js"),[],import.meta.url));let tRe=class extends pi{constructor(){super(...arguments),this.blurSize=Ke()}};function o1t(){const t=new Lr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(A.POSITION,"vec2"),t.attributes.add(A.UV0,"vec2"),t.varyings.add("blurCoordinate","vec3"),e.uniforms.add(new Pt("coverageTex",n=>n.coverageTexture)),r.uniforms.add(new N3("blurSize",n=>n.blurSize)),i.add(w`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),r.uniforms.add(new KM("tex",n=>n.blurInputTexture)),s.add(w`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture2D(tex, uv);
if (blurCoordinate.z == 1.0) {
gl_FragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
gl_FragColor = sum;
}
}`),t}const a1t=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:tRe,build:o1t},Symbol.toStringTag,{value:"Module"}));let rRe=class iRe extends kr{initializeProgram(e){return new Nr(e.rctx,iRe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};rRe.shader=new Dr(a1t,()=>ie(()=>import("./HighlightBlur.glsl-0076f665.js"),[],import.meta.url));let sRe=class extends pi{constructor(){super(...arguments),this.invFramebufferDim=Ke()}};function l1t(){const t=new Lr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(A.POSITION,"vec2"),i.add(w`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),r.uniforms.add(new KM("tex",n=>n.inputTexture)),r.uniforms.add(new N3("invFramebufferDim",n=>n.invFramebufferDim)),s.add(w`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),t}const c1t=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:sRe,build:l1t},Symbol.toStringTag,{value:"Module"}));let nRe=class oRe extends kr{initializeProgram(e){return new Nr(e.rctx,oRe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};nRe.shader=new Dr(c1t,()=>ie(()=>import("./HighlightDownsample.glsl-499eba95.js"),[],import.meta.url));let oue=class extends pi{constructor(){super(...arguments),this.color=Ap(1,0,1,1),this.haloColor=Ap(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=qt(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}};const u1t=32;let h1t=class{constructor(e,r){this._techniqueRep=e,this._rctx=r,this._viewportToRestore=nr(),this._passParameters=new oue,this._downsampleDrawParameters=new sRe,this._blurDrawParameters=new tRe,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this._quadVAO)return;this._quadVAO=Ia(this._rctx);const e={colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE,width:0,height:0},r={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:0,height:0};this._blur0Fbo=new Ns(this._rctx,e,r),this._blur1Fbo=new Ns(this._rctx,e,r),this._blurTechnique=this._techniqueRep.acquire(rRe),this._downsampleTechnique=this._techniqueRep.acquire(nRe),this._applyTechnique=this._techniqueRep.acquire(QAe)}dispose(){if(this._blurTechnique=ji(this._blurTechnique),this._downsampleTechnique=ji(this._downsampleTechnique),this._applyTechnique=ji(this._applyTechnique),this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._blur0Fbo=et(this._blur0Fbo),this._blur1Fbo=et(this._blur1Fbo)}setDefaultOptions(e){this._passParameters={...new oue,...e}}render(e,r,i){this._passParameters.highlightColorTexture=r.colorTexture,this._assertResources();const s=e.camera;rp(this._viewportToRestore,s.fullViewport);const n=s.fullWidth,o=s.fullHeight,a=s.pixelRatio,l=Math.ceil(n/a),c=Math.ceil(o/a);this._blur0Fbo.resize(l,c),this._blur1Fbo.resize(l,c);const h=this._rctx;h.bindVAO(this._quadVAO);let p=null;this._gridUpdateResources(r,u1t),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,p=this._grid.vao;const f=h.bindTechnique(this._blurTechnique,this._passParameters,e);h.bindVAO(p),h.bindFramebuffer(this._blur0Fbo),h.setViewport(0,0,l,c),h.setClearColor(0,0,0,0),h.clear(Fi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=r.colorTexture,ar(this._blurDrawParameters.blurSize,1/l,0),f.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Ko(p,"geometry")),h.bindFramebuffer(this._blur1Fbo),h.clear(Fi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,ar(this._blurDrawParameters.blurSize,0,1/c),f.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Ko(p,"geometry")),h.bindFramebuffer(i),h.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,e),h.drawArrays(this._applyTechnique.primitiveType,0,Ko(p,"geometry")),h.bindVAO(null)}_gridUpdateResources(e,r){const i=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[e],n=!0),s.viewportWidth===e.width&&s.viewportHeight===e.height||(n=!0,s.viewportWidth=e.width,s.viewportHeight=e.height),s.coverageMipmap[0]=e,s.cellPixelSize!==r&&(s.cellPixelSize=r,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:wt.TEXTURE_2D,pixelFormat:ze.RGB,dataType:Lt.UNSIGNED_SHORT_5_6_5,samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},p={colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new Ns(i,p,h)}}const o=Math.ceil(e.height/s.cellPixelSize),a=Math.ceil(e.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,m=4,y=new Float32Array(f*m*l*c);let _=0;for(let b=0;b<l;b++)for(let x=0;x<c;x++)y[_+0]=(x-.5)*p*2-1,y[_+1]=(b-.5)*h*2-1,y[_+2]=x*p,y[_+3]=b*h,y[_+4]=(x+.5)*p*2-1,y[_+5]=(b-.5)*h*2-1,y[_+6]=x*p,y[_+7]=b*h,y[_+8]=(x-.5)*p*2-1,y[_+9]=(b+.5)*h*2-1,y[_+10]=x*p,y[_+11]=b*h,y[_+12]=(x-.5)*p*2-1,y[_+13]=(b+.5)*h*2-1,y[_+14]=x*p,y[_+15]=b*h,y[_+16]=(x+.5)*p*2-1,y[_+17]=(b-.5)*h*2-1,y[_+18]=x*p,y[_+19]=b*h,y[_+20]=(x+.5)*p*2-1,y[_+21]=(b+.5)*h*2-1,y[_+22]=x*p,y[_+23]=b*h,_+=f*m;s.vao&&s.vao.dispose(!0),s.vao=new Pp(i,Ar,{geometry:lC},{geometry:jr.createVertex(i,$r.STATIC_DRAW,y)})}}_gridComputeMipmap(e){const r=this._rctx,i=this._grid,s=r.bindTechnique(this._downsampleTechnique,this._passParameters,e);r.bindVAO(this._quadVAO);for(let n=0;n<i.mipmapLevels;n++){r.bindFramebuffer(i.coverageMipmap[n+1]);const o=i.coverageMipmap[n+1].width,a=i.coverageMipmap[n+1].height;this._downsampleDrawParameters.inputTexture=i.coverageMipmap[n].colorTexture,ar(this._downsampleDrawParameters.invFramebufferDim,1/o,1/a),s.bindDraw(this._downsampleDrawParameters,e,this._passParameters),r.setViewport(0,0,o,a),r.drawArrays($t.TRIANGLE_STRIP,0,Ko(this._quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(v(this._blur0Fbo)?this._blur0Fbo.gpuMemoryUsage:0)+(v(this._blur1Fbo)?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const r of this._grid.coverageMipmap)e+=r.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}};const d1t={dataType:Lt.UNSIGNED_BYTE,internalFormat:ze.RGBA},p1t={};let f1t=class{constructor(e){this._rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(e=>e.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(e=>e.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(e=>e.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(e=>e.dispose()),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(e){const r=e.id;this._activeTargets.has(r)&&(this._activeTargets.delete(r),this._disposeWithFramebuffers(this._depthTextures,r),this._disposeWithFramebuffers(this._depthBuffers,r),this._disposeWithFramebuffers(this._colorTextures,r))}_disposeWithFramebuffers(e,r){const i=e.get(r);i&&(this._framebuffers.forEach((s,n)=>{s.colorAttachment!==i&&s.depthStencilAttachment!==i||(s.detachAll(),s.dispose(),this._framebuffers.delete(n))}),i.dispose(),e.delete(r))}getDepthTexture(e,r){if(!this.depthTextureSupported)return null;let i=this._depthTextures.get(e.id);return!i||i.descriptor.width===r.width&&i.descriptor.height===r.height||(i.dispose(),i=yw()),i||(i=new ct(this._rctx,{target:wt.TEXTURE_2D,pixelFormat:ze.DEPTH_STENCIL,dataType:Lt.UNSIGNED_INT_24_8,samplingMode:tt.NEAREST,wrapMode:Ot.CLAMP_TO_EDGE,width:r.width,height:r.height}),this._depthTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,r){if(this.depthTextureSupported)return null;let i=this._depthBuffers.get(e.id);return i?i.descriptor.width===r.width&&i.descriptor.height===r.height||i.resize(r.width,r.height):(i=new y2(this._rctx,{internalFormat:Ya.DEPTH_STENCIL,...r}),this._depthBuffers.set(e.id,i),this._activeTargets.add(e.id)),i}getColorTexture(e,r){let i=this._colorTextures.get(e.id);return i&&(i.descriptor.width===r.width&&i.descriptor.height===r.height||(i.dispose(),i=yw())),i||(i=new ct(this._rctx,{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:e.samplingMode!=null?e.samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:r.width,height:r.height}),this._colorTextures.set(e.id,i),this._activeTargets.add(e.id)),i}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:$c(),...p1t,...e}}registerColorTarget(e={}){return{id:$c(),...d1t,...e}}getFramebuffer(e,r,i){const s=this._getKey(r,i);let n=this._framebuffers.get(s);const o=this.getColorTexture(r,e);if(this.depthTextureSupported){const l=i?this.getDepthTexture(i,e):void 0;return n?((n.width!==e.width||n.height!==e.height||n.colorTexture!==o||n.depthStencilTexture!==l)&&(n.detachAll(),n.resize(e.width,e.height),n.attachColorTexture(o),n.attachDepthStencilTexture(l)),n):(n=v(i)?new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.DEPTH_STENCIL_TEXTURE},o,l):new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},o),this._framebuffers.set(s,n),n)}const a=i?this.getDepthBuffer(i,e):void 0;return n?((n.width!==e.width||n.height!==e.height||n.colorTexture!==o)&&(n.detachAll(),n.resize(e.width,e.height),n.attachColorTexture(o),n.attachDepthStencilBuffer(a)),n):(n=new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:i?Ir.DEPTH_STENCIL_RENDER_BUFFER:Ir.NONE},o,a),this._framebuffers.set(s,n),n)}_getKey(e,r){return`${e.id}_${r?r.id:"X"}_${e.name}${r?"_"+r.name:""}`}get gpuMemoryUsage(){let e=0;const r=new Set,i=s=>{r.has(s)||(r.add(s),e+=Bw(s))};return this._depthTextures.forEach(i),this._colorTextures.forEach(i),this._depthBuffers.forEach(i),e}},m1t=class{constructor(e,r){this._rctx=e,this._compositingHelper=r,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._background={type:"color",color:[0,0,0,1]};const i=e.type===bt.WEBGL2;this._renderTargetHelper=new f1t(e);const s=this._renderTargetHelper;this._mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=o=>s.registerColorTarget({name:o,dataType:Lt.FLOAT,internalFormat:i?Et.RGBA32F:ze.RGBA,samplingMode:tt.NEAREST});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:tt.NEAREST}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:i?Et.RGBA4:ze.RGBA,dataType:Lt.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:i?Et.RGBA4:ze.RGBA,dataType:Lt.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this._mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this._mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,r){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,r)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}setupRenderTarget(e){e||(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1])),this._mainColorTarget=this._mainColorTarget===0&&e?1:0}initializeFrame(e){const r=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),r.setClearStencil(0);const i=this._background.color;r.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),r.clearSafe(Fi.COLOR_BUFFER_BIT|Fi.DEPTH_BUFFER_BIT|Fi.STENCIL_BUFFER_BIT)}composite(e){v(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,_a.None)}renderTmpAndCompositeToMain(e,r,i,s=!1){this.renderToTargets(e,this.tmpColor,s?this.tmpDepth:this.mainDepth,g1t),this._compositingHelper.composite(r,this._getColorTexture(this.tmpColor),i)}renderHUDVisibility(e,r=!1){this.renderToTargets(e,this.hudVisibility,r?this.tmpDepth:this.mainDepth,y1t)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets(()=>this._compositingHelper.compositeHUD(e,this._getColorTexture(this.tmpColor)),this.hudVisibility,this.tmpDepth)}renderOITPass(e,r,i){let s,n;switch(r){case Tt.Color:s=this.colorFloatTarget,n=[0,0,0,0];break;case Tt.Alpha:s=this.alphaFloatTarget,n=[1,1,1,1];break;case Tt.FrontFace:s=this.frontFaceTarget,n=[0,0,0,0]}i?this.renderToTargets(e,s,this.tmpDepth,n,!0,!0):this.renderToTargets(e,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),_a.PremultipliedAlpha)}compositeOccludedOntoMain(e,r){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),_a.PremultipliedAlpha,r)}compositeTransparentOntoOpaque(e,r){r?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(Fi.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}renderToFBO(e,r,i=!1,s=!1){const n=this._rctx;let o=0;if(r){const l=Math.max(1e-13,r[3]);n.setClearColor(r[0],r[1],r[2],l),o|=Fi.COLOR_BUFFER_BIT}i&&(o|=Fi.DEPTH_BUFFER_BIT),s===!1?s=0:(s===!0&&(s=255),o|=Fi.STENCIL_BUFFER_BIT),o&&n.clearSafe(o,s),e(),n.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderToTargets(e,r,i,s,n=!1,o=!1){const a=this.bindTarget(r,i);return this.renderToFBO(e,s,n,o),a}bindTarget(e,r){const i=this._renderTargetHelper.getFramebuffer(this._dimensions,e,r);return this._rctx.bindFramebuffer(i),i}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}};const g1t=[0,0,0,0],y1t=[0,1,0,1];let _1t=class{constructor(e){this._context=e,this._renderPlugins=new Kt,this._slots=[];for(let r=0;r<Se.MAX_SLOTS;++r)this._slots[r]=[]}add(e,r,i){const s=()=>{if(i!=null&&i.aborted)throw r.uninitializeRenderContext(),qr();this._renderPlugins.push(r);for(const o of e)this._slots[o].push(r);this._context.requestRender()},n=r.initializeRenderContext(this._context,i);if(Gu(n))return n.then(s);s()}remove(e){if(this._renderPlugins.removeUnordered(e)!=null){for(let r=0;r<this._slots.length;++r)this._slots[r]=this._slots[r].filter(i=>i!==e);e.uninitializeRenderContext(),this._context.requestRender()}}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)})}updateAnimation(e){let r=!1;return this._renderPlugins.forAll(i=>{i.updateAnimation&&(r=i.updateAnimation(e)||r)}),r}render(){const e=this._slots[this._context.renderContext.bindParameters.slot],r=new Array;e.filter(i=>{if(!i.canRender)return!1;if(v1t(i)){const s=i.prepareTechnique(this._context.renderContext);return!!s&&(r.push(s),!0)}return r.push(null),!0}).forEach((i,s)=>i.render(this._context.renderContext,r[s]))}queryDepthRange(e){const r=b1t;return r.near=1/0,r.far=-1/0,this._renderPlugins.forAll(i=>{if(i.queryDepthRange){const s=i.queryDepthRange(e);s&&FE(r,s,r)}}),r}get needsTransparentPass(){return this._renderPlugins.some(e=>!!e.needsTransparentPass)}get needsHighlight(){return this._renderPlugins.some(e=>!!e.needsHighlight)}get needsLinearDepth(){return this._renderPlugins.some(e=>!!e.needsLinearDepth)}get needsLaserlineWithContrastControl(){const e=this._slots[Se.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce((e,r)=>e|r.renderOccludedFlags,0)}};function v1t(t){return"prepareTechnique"in t}const b1t={near:0,far:0};let aRe=class extends ISe{};const rU=255,w1t=1/rU;function x1t(t){const e=new Lr,r=e.fragment;return r.include(jc),r.include(ku),e.include(V6),e.include(sd),e.include(U6,t),r.uniforms.add([new Pt("depthMap",i=>i.linearDepthTexture),new qi("inverseViewMatrix",(i,s)=>Lo(aue,ql(aue,s.camera.viewMatrix,s.camera.center))),new Ur("nearFar",(i,s)=>s.camera.nearFar)]),r.constants.add("sampleValue","float",w1t),r.code.add(w`void main(void) {
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
gl_FragColor = vec4(sampleValue);
}`),e}const aue=Ie(),T1t=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:aRe,ShadowCastMaxSamples:rU,build:x1t},Symbol.toStringTag,{value:"Module"}));var Qw;(function(t){t[t.Gradient=0]="Gradient",t[t.Threshold=1]="Threshold",t[t.COUNT=2]="COUNT"})(Qw||(Qw={}));let Vq=class extends Pa{constructor(){super(...arguments),this.visualization=Qw.Gradient,this.bandsEnabled=!1}};u([k({count:Qw.COUNT})],Vq.prototype,"visualization",void 0),u([k()],Vq.prototype,"bandsEnabled",void 0);let lRe=class extends pi{constructor(e){super(),this.shadowCastMap=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=FM(S1t),this.bandSize=.1,this.threshold=.5}};const S1t=qt(.01,0,.25,1);function E1t(t){const e=new Lr,r=e.fragment;r.include(jc),r.include(ku),e.include(V6),e.include(sd);const{visualization:i,bandsEnabled:s}=t;r.constants.add("inverseSampleValue","float",rU),r.uniforms.add([new Pt("shadowCastMap",a=>a.shadowCastMap),new Pe("sampleScale",a=>a.sampleScale),new Pe("opacityFromElevation",a=>a.opacityFromElevation),new fr("uColor",a=>a.color)]);const n=i===Qw.Gradient,o=i===Qw.Threshold;return n&&s?r.uniforms.add(new Pe("bandSize",a=>a.bandSize)):o&&r.uniforms.add(new Pe("threshold",a=>a.threshold)),r.code.add(w`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?w`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?w`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?w`* strength`:""});
      }
    `),e}const C1t=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:lRe,build:E1t},Symbol.toStringTag,{value:"Module"}));let cRe=class uRe extends kr{constructor(e,r){super(e,r,()=>this.destroy())}initializeProgram(e){return new Nr(e.rctx,uRe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Du,colorWrite:Qt,depthTest:null,depthWrite:null})}get primitiveType(){return $t.TRIANGLE_STRIP}};cRe.shader=new Dr(C1t,()=>ie(()=>import("./ShadowCastVisualize.glsl-820dcc72.js"),[],import.meta.url));const A1t=4e4,R1t=5e4,hRe=1/512;let yN=class extends Te{constructor(e,r,i,s){super({}),this._techniqueRepository=e,this._rctx=r,this._data=i,this._requestRender=s,this._passParameters=new lRe(this._data.shadowCastTexture),this._techniqueConfig=new Vq,this._enabled=!1,this._vao=Ia(r),this._techniqueConfig.visualization=Qw.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=et(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(cRe,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const r=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,this._passParameters,e),this._rctx.drawArrays(r.primitiveType,0,Ko(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>hRe}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const r=this._passParameters.color;uS(e,r)||(rp(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],yN.prototype,"opacityFromElevation",null),yN=u([P("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],yN);let U4=class extends Pa{constructor(){super(...arguments),this.receiveShadows=!0,this.hasWebGL2Context=!1}};u([k()],U4.prototype,"receiveShadows",void 0),u([k()],U4.prototype,"hasWebGL2Context",void 0);let dRe=class pRe extends kr{constructor(e){super(e,new U4,()=>this.destroy())}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,pRe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Bn(Ee.ONE,Ee.ONE,Ee.ONE,Ee.ONE),colorWrite:Qt,depthTest:null,depthWrite:null})}get primitiveType(){return $t.TRIANGLE_STRIP}};dRe.shader=new Dr(T1t,()=>ie(()=>import("./ShadowCastAccumulate.glsl-1902ab35.js"),[],import.meta.url));let Pl=class extends Te{constructor(e,r,i,s,n,o){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=n,this._requestRender=o,this._progress=0,this._sampleCount=0,this._passParameters=new aRe,this._enabledInternal=!1,this._cachedLightDirections=[],this._depthRange=Pq,this._previewing=!1,this._handles=new Zr,this._cameraForcedForScreenshot=!1,this._bindParameters=new h6(new rK(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._vao=Ia(e);const a={colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE,width:0,height:0},l={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new Ns(e,a,l),this._accumulationRenderer=new yN(r,e,this,o);const c=this._stage.view.resourceController.scheduler;this._handles.add([c.registerTask(yt.SHADOW_ACCUMULATOR,this),ne(()=>i.renderView,h=>{this._handles.remove(lue),v(h)&&this._handles.add(h.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),lue)},qs),ne(()=>this._previewing,()=>this._requestRenderIfEnabled(),ri)])}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(C(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new dRe(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabledInternal&&this._sampleCount>0}get canAccumulate(){return this._passParameters.linearDepthTexture!==null&&this._depthRange!==Pq&&this._opacityFromElevation>hRe}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const r=this._cachedLightDirections;if(ry(r,e,Q_))return;const i=Math.min(rU,e.length);r.length=i,this._sampleCount=i;for(let s=0;s<i;++s)r[s]=le(r[s]??M(),e[s]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,r,i,s){if(this._depthRange=r,this._updateCamera(i),this._bindParameters.contentCamera=s,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const n=this._cameraForcedForScreenshot?this._sampleCount:Math.min(O1t,this._sampleCount-this._progress);for(let o=0;o<n;++o)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=et(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=et(this._fbo),this._vao=et(this._vao),this._accumulationTechniqueCached=ji(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){e.enabled!==void 0&&(this._enabled=e.enabled),e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,r){return!this._isActive||this._progress<1||e<0||e>this._fbo.width||r<0||r>this._fbo.height?0:(this._fbo.readPixels(e,r,1,1,ze.RGBA,Lt.UNSIGNED_BYTE,cue),cue[0]/this._progress)}_start(){this._progress=0,this._enabledInternal=!0}_stop(){this._enabledInternal=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Fi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,Ko(this._vao,"geometry"))}_sampleLightDirection(){return this._progress++,this._lightDirections[this._progress*M1t%this._lightDirections.length]}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-WS(A1t,R1t,e.relativeElevation))}set _enabled(e){e!==this._enabledInternal&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabledInternal&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};u([d()],Pl.prototype,"_progress",void 0),u([d()],Pl.prototype,"_sampleCount",void 0),u([d()],Pl.prototype,"_enabledInternal",void 0),u([d()],Pl.prototype,"_depthRange",void 0),u([d()],Pl.prototype,"_previewing",void 0),u([d()],Pl.prototype,"_accumulationRenderer",void 0),u([d()],Pl.prototype,"_isRefining",null),u([d()],Pl.prototype,"_isActive",null),u([d()],Pl.prototype,"canAccumulate",null),u([d()],Pl.prototype,"_isDoneAccumulating",null),u([d()],Pl.prototype,"_opacityFromElevation",null),u([d()],Pl.prototype,"running",null),Pl=u([P("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Pl);const O1t=6,lue="renderView",M1t=104729,cue=new Uint8Array(4),uue={highlightedThreshold:.99999,selfShadowThreshold:.025};function P1t(t){const e=new Lr;e.include(Xw,t);const r=e.fragment;return r.include(jc),r.include(ku),e.include(V6),e.include(sd),r.uniforms.add([new Pt("defaultDepthTex",(i,s)=>s.shadowMap.getSnapshot($E.Default)),new Pt("highlightDepthTex",(i,s)=>s.shadowMap.getSnapshot($E.Highlight)),new Pt("depthMap",(i,s)=>s.linearDepthTexture),new Pt("highlightMap",(i,s)=>s.highlightColorTexture),new fr("uColor",i=>i.shadowColor),new Ur("nearFar",(i,s)=>s.camera.nearFar),new Pe("opacity",i=>i.shadowOpacity),new Pe("occludedOpacity",i=>i.occludedShadowOpacity),new Pe("terminationFactor",i=>i.opacityElevation*i.dayNightTerminator),new Wt("lightingMainDirectionView",(i,s)=>ve(due,Xe(due,s.lighting.mainLight.direction,s.camera.viewInverseTransposeMatrix))),new Ur("texelSize",(i,s)=>v(s.linearDepthTexture)?ar(I1t,1/s.linearDepthTexture.descriptor.width,1/s.linearDepthTexture.descriptor.height):Xl),new qi("inverseViewMatrix",(i,s)=>Lo(hue,ql(hue,s.camera.viewMatrix,s.camera.center)))]),r.constants.add("unoccludedHighlightFlag","vec4",s2e).add("highlightedThreshold","float",uue.highlightedThreshold).add("selfShadowThreshold","float",uue.selfShadowThreshold),r.code.add(w`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),r.code.add(w`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),e}const hue=Ie(),due=M(),I1t=Ke(),$1t=Object.freeze(Object.defineProperty({__proto__:null,build:P1t},Symbol.toStringTag,{value:"Module"}));let L1t=class extends pi{constructor(){super(...arguments),this.shadowColor=qt(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},fRe=class mRe extends kr{constructor(e){super(e,new U4,()=>this.destroy())}initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,mRe.shader.get().build(this.configuration),Ar)}initializePipeline(){return zt({blending:Bn(Ee.SRC_ALPHA,Ee.ONE,Ee.ONE_MINUS_SRC_ALPHA,Ee.ONE_MINUS_SRC_ALPHA),colorWrite:Qt,depthTest:null,depthWrite:null})}get primitiveType(){return $t.TRIANGLE_STRIP}};fRe.shader=new Dr($1t,()=>ie(()=>import("./ShadowHighlight.glsl-465513d5.js"),[],import.meta.url));const D1t=.001953125,N1t=4e4,F1t=5e4;let U1t=class{constructor(e,r){this._rctx=e,this._viewingMode=r,this._maxOpacity=1,this._passParameters=new L1t,this._drawParameters=new ISe,this._vao=Ia(this._rctx)}get _technique(){return C(this._techniqueCached)&&(this._techniqueCached=new fRe({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}render(e,r){if(!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const i=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(r),this._rctx.bindTechnique(i,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,Ko(this._vao,"geometry"))}get gpuMemoryUsage(){var e;return((e=this._vao)==null?void 0:e.size)??0}setDefaultOptions(e){this._passParameters={...this._passParameters,...e},this._updateMaxOpacity()}updateParameters(e,r){this._passParameters.opacityElevation=1-WS(N1t,F1t,e.relativeElevation);const i=this._viewingMode===Be.Global?ve(pue,e.center):ce(pue,0,0,1),s=_e(i,r);this._passParameters.dayNightTerminator=WS(0,1,ye(30*s,0,1))}dispose(){this._vao=et(this._vao),this._techniqueCached=ji(this._techniqueCached)}get isVisible(){const{opacityElevation:e,dayNightTerminator:r}=this._passParameters;return this._maxOpacity*e*r>=D1t}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}};const pue=M(),fue=_y();let V1t=class{constructor(){this._plane=_y()}get isEnabled(){return!Uye(this.plane,fue)}get plane(){return this._plane}set plane(e){lx(e||fue,this._plane)}},k1t=class extends pi{};function lM(t){t.uniforms.add(new fr("resolution",e=>{const{descriptor:r}=e.colorTexture,i=r.width,s=r.height;return ti(z1t,1/i,1/s,i,s)}))}const z1t=nr(),TT={maxSearchSteps:8,maxDistanceAreaTex:16};function B1t(){const t=new Lr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(A.POSITION,"vec2"),r.add("uv","vec2"),r.add("offsets[2]","vec4"),r.add("maxOffset","vec4"),r.add("pixelCoord","vec2"),lM(i),i.code.add(w`
      void main() {
        uv = position * 0.5 + vec2(0.5);
        gl_Position = vec4(position, 0, 1);

        pixelCoord = uv * resolution.zw;
        offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${w.int(TT.maxSearchSteps)} );
      }
    `),s.uniforms.add(new Pt("edgesTexture",n=>n.edges.colorTexture)),s.uniforms.add(new Pt("areaTexture",n=>n.areaTexture)),s.uniforms.add(new Pt("searchTexture",n=>n.searchTexture)),lM(s),s.code.add(w`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 sampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {
        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);
      }

      vec2 round( vec2 x ) {
        return sign(x) * floor(abs(x) + 0.5);
      }

      float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float searchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${w.int(TT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float searchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${w.int(TT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float searchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${w.int(TT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${w.int(TT.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${w.int(TT.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      void main() {
        ivec4 subsampleIndices = ivec4(0.0);
        vec4 weights = vec4(0.0);
        vec2 e = texture2D( edgesTexture, uv ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = searchXLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x );
          coords.y = offsets[1].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTexture, coords, 0.0 ).r;
          coords.x = searchXRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y );
          d.y = coords.x;
          d = d * resolution.z - pixelCoord.x;
          vec2 sqrt_d = sqrt( abs(d) );
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = searchYUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z );
          coords.x = offsets[0].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTexture, coords, 0.0 ).g;
          coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w );
          d.y = coords.y;
          d = d * resolution.w - pixelCoord.y;
          vec2 sqrt_d = sqrt(abs(d));
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0)).g;
          weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
        }
        gl_FragColor = weights;
      }
    `),t}const G1t=Object.freeze(Object.defineProperty({__proto__:null,build:B1t},Symbol.toStringTag,{value:"Module"}));let gRe=class yRe extends kr{initializeProgram(e){return new Nr(e.rctx,yRe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};gRe.shader=new Dr(G1t,()=>ie(()=>import("./BlendWeights.glsl-2278557c.js"),[],import.meta.url));function j1t(){const t=new Lr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(A.POSITION,"vec2"),r.add("uv","vec2"),r.add("offsets[2]","vec4"),lM(i),i.code.add(w`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}`),s.uniforms.add(new Pt("blendWeightsTexture",n=>n.blend.colorTexture)),s.uniforms.add(new Pt("colorTexture",n=>n.colorTexture)),lM(s),s.code.add(w`void main() {
vec4 a;
a.rb = texture2D(blendWeightsTexture, uv).rb;
a.g = texture2D(blendWeightsTexture, offsets[1].zw).g;
a.a = texture2D(blendWeightsTexture, offsets[1].xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
gl_FragColor = texture2D( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTexture, uv, 0.0 );
vec4 Cop = texture2D( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
gl_FragColor = mix(C, Cop, s);
}
}`),t}const H1t=Object.freeze(Object.defineProperty({__proto__:null,build:j1t},Symbol.toStringTag,{value:"Module"}));let _Re=class vRe extends kr{initializeProgram(e){return new Nr(e.rctx,vRe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};_Re.shader=new Dr(H1t,()=>ie(()=>import("./Blur.glsl-b1c10fc8.js"),[],import.meta.url));const mue={threshold:.05,localConstrastAdaption:2};function q1t(){const t=new Lr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(A.POSITION,"vec2"),lM(i),r.add("uv","vec2"),r.add("offsets[3]","vec4"),i.code.add(w`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
offsets[2] = uv.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}`),s.uniforms.add(new Pt("colorTexture",n=>n.colorTexture)),s.code.add(w`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture2D(colorTexture, uv).rgb;

      vec3 Cleft = texture2D(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture2D(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${w.float(mue.threshold)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture2D(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture2D(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture2D(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture2D(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges.xy *= step(maxDelta, float(${w.float(mue.localConstrastAdaption)}) * delta.xy);

      gl_FragColor = vec4(edges, 0.0, 0.0);
    }
  `),t}const W1t=Object.freeze(Object.defineProperty({__proto__:null,build:q1t},Symbol.toStringTag,{value:"Module"}));let bRe=class wRe extends kr{initializeProgram(e){return new Nr(e.rctx,wRe.shader.get().build(),Ar)}initializePipeline(){return zt({colorWrite:Qt})}};bRe.shader=new Dr(W1t,()=>ie(()=>import("./EdgeDetect.glsl-7bec60c5.js"),[],import.meta.url));let eO=class extends Te{constructor(e,r){super({}),this._rctx=e,this._techniqueRep=r,this._passParameters=new k1t,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=jh(this._abortController),this.disable()}_loadResources(e){if(v(this._abortController))return!1;if(v(this._passParameters.searchTexture))return!0;this._abortController=new AbortController;const r=this._abortController.signal;return ie(()=>import("./SmaaRenderPassData-660b7d34.js"),[],import.meta.url).then(i=>this._loadTextures(i,r)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,r){return ur(r),Promise.all([this._loadTextureFromBase64(e.areaTexture,tt.LINEAR,ze.RGB),this._loadTextureFromBase64(e.searchTexure,tt.NEAREST,ze.LUMINANCE)]).then(([i,s])=>{Fn(r)?(i.dispose(),s.dispose(),ur(r)):(this._passParameters.areaTexture=i,this._passParameters.searchTexture=s)})}get updating(){return v(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const r=new Pa;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(bRe,r,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(gRe,r,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(_Re,r,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=dKe(this._rctx),this._passParameters.edges=new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,pixelFormat:ze.RGB,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:4,height:4}),this._passParameters.blend=new Ns(this._rctx,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.LINEAR,wrapMode:Ot.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=et(this._vao),this._passParameters.areaTexture=et(this._passParameters.areaTexture),this._passParameters.searchTexture=et(this._passParameters.searchTexture),this._passParameters.blend=et(this._passParameters.blend),this._passParameters.edges=et(this._passParameters.edges),this._isEnabled=!1)}get _validPassParameters(){return this._isEnabled?this._passParameters:null}render(e){const r=this._validPassParameters;if(C(r))return;r.colorTexture=e;const i=this._rctx,s=i.getBoundFramebufferObject(),n=e.descriptor.width,o=e.descriptor.height;i.bindVAO(this._vao),i.setViewport(0,0,n,o),r.edges.resize(n,o),i.bindFramebuffer(r.edges),i.setClearColor(0,0,0,1),i.clear(Fi.COLOR_BUFFER_BIT),i.bindTechnique(this._edgeDetectTechnique,r,null),i.drawArrays($t.TRIANGLES,0,3),r.blend.resize(n,o),i.bindFramebuffer(r.blend),i.setClearColor(0,0,1,1),i.clear(Fi.COLOR_BUFFER_BIT),i.bindTechnique(this._blendWeightsTechnique,r,null),i.drawArrays($t.TRIANGLES,0,3),i.bindFramebuffer(s),i.setClearColor(0,1,0,1),i.clear(Fi.COLOR_BUFFER_BIT),i.bindTechnique(this._blurTechnique,r,null),i.drawArrays($t.TRIANGLES,0,3)}_loadTextureFromBase64(e,r,i){return dy(e).then(s=>new ct(this._rctx,{pixelFormat:i,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.CLAMP_TO_EDGE,width:s.width,height:s.height,samplingMode:r},s))}};u([d()],eO.prototype,"_abortController",void 0),u([d({readOnly:!0})],eO.prototype,"updating",null),eO=u([P("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],eO);function X1t(t,e){const r=-t[0],i=-t[1],s=-t[2],n=e[3],o=e[7],a=e[11],l=e[15];e[0]+=n*r,e[1]+=n*i,e[2]+=n*s,e[4]+=o*r,e[5]+=o*i,e[6]+=o*s,e[8]+=a*r,e[9]+=a*i,e[10]+=a*s,e[12]+=l*r,e[13]+=l*i,e[14]+=l*s}function Y1t(t,e){const r=t[0],i=t[1],s=t[2];e[12]+=r*e[0]+i*e[4]+s*e[8],e[13]+=r*e[1]+i*e[5]+s*e[9],e[14]+=r*e[2]+i*e[6]+s*e[10],e[14]+=r*e[3]+i*e[7]+s*e[11]}let Z1t=class{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const r=this._originData.get(e.id)||new J1t(e);return r.refCount++,this._originData.has(r.origin.id)||this._originData.set(r.origin.id,r),r}release(e){e.refCount--,e.refCount===0&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach(r=>{kn(r.viewMatrix,e),Y1t(r.origin.vec3,r.viewMatrix)})}},J1t=class{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=Ie()}},K1t=class extends Wwe{constructor(e,r){super(),this.distanceFalloffFactor=e,this.transparency=r,this.transformNormalViewFromGlobal=rs()}},Q1t=class extends Xwe{constructor(){super(...arguments),this.transformNormalViewFromGlobal=rs(),this.slicePlaneLocalOrigin=M(),this.transformNormalGlobalFromModel=rs()}};function ebt(t){const e=w`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;t.code.add(e)}const tbt=Fr(.5,-4e-4);function rbt(t,e){const r=t.vertex;r.include(ebt),r.constants.add("depthBias","vec2",tbt),r.uniforms.add(new Ur("inverseViewport",(i,s)=>s.inverseViewport)),e.legacy?(r.uniforms.add(new qi("proj",(i,s)=>s.camera.projectionMatrix)),r.code.add(w`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(r.uniforms.add(new Rm("transformNormalViewFromGlobal",i=>i.transformNormalViewFromGlobal)),r.uniforms.add(new qi("transformProjFromView",i=>i.transformProjFromView)),r.code.add(w`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),r.code.add(w`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function ibt(t,e){const r=t.fragment;r.constants.add("coverageTestThreshold","float",.01),e.antialiasing?r.code.add(w`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):r.code.add(w`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function sbt(t,e){const r=t.vertex;e.silhouette?(r.code.add(w`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),e.legacy?r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function nbt(t,e){const r=t.vertex;r.include(jc),r.uniforms.add(new Pe("distanceFalloffFactor",i=>i.distanceFalloffFactor)),r.code.add(w`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),r.uniforms.add(q_("componentDataTex",i=>i.componentDataTexture,e.hasWebGL2Context?ei.None:ei.InvSize)),t.attributes.add(A.COMPONENTINDEX,"float"),r.constants.add("componentColorFieldOffset","float",0),r.constants.add("componentOtherFieldOffset","float",1),r.constants.add("componentVerticalOffsetFieldOffset","float",2),r.constants.add("componentFieldCount","float",3),r.constants.add("lineWidthFractionFactor","float",8),r.constants.add("extensionLengthOffset","float",128),r.constants.add("verticalOffsetScale","float",2*UK),r.code.add(w`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;

      vec2 textureSizeInverse = ${kh(e,"componentDataTex",!0)};

      float colIndex = mod(fieldIndex, 1.0 / textureSizeInverse.x);
      float rowIndex = floor(fieldIndex * textureSizeInverse.x);

      return vec2(colIndex, rowIndex) + 0.5;
    }

    struct ComponentData {
      vec4 color;
      float lineWidth;
      float extensionLength;
      float type;
      float verticalOffset;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);

      vec4 colorValue = ${tl(e,"componentDataTex","colorIndex")};
      vec4 otherValue = ${tl(e,"componentDataTex","otherIndex")};
      float verticalOffset = (rgba2float(${tl(e,"componentDataTex","verticalOffsetIndex")}) - 0.5) * verticalOffsetScale;

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        otherValue.x * (255.0 / lineWidthFractionFactor),
        otherValue.y * 255.0 - extensionLengthOffset,
        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
        verticalOffset
      );
    }
  `),e.legacy?r.code.add(w`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(r.uniforms.add(new F3("transformNormalGlobalFromModel",i=>i.transformNormalGlobalFromModel)),r.code.add(w`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),e.silhouette?(t.attributes.add(A.NORMALA,"vec3"),t.attributes.add(A.NORMALB,"vec3"),r.code.add(w`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add(A.NORMAL,"vec3"),r.code.add(w`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),e.legacy?r.code.add(w`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(r.include(ZF,e),r.include(ZF,e),r.uniforms.add([new Rm("transformViewFromCameraRelativeRS",i=>i.transformViewFromCameraRelativeRS),new F3("transformWorldFromModelRS",i=>i.transformWorldFromModelRS),new Lu("transformWorldFromModelTL",i=>i.transformWorldFromModelTL),new Lu("transformWorldFromModelTH",i=>i.transformWorldFromModelTH),new Wt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL),new Wt("transformWorldFromViewTH",i=>i.transformWorldFromViewTH)]),r.code.add(w`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${e.spherical?w`normalize(transformWorldFromModelTL + rotatedModelPosition);`:w`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),r.uniforms.add(new qi("transformProjFromView",(i,s)=>s.camera.projectionMatrix)),r.code.add(w`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),r.code.add(w`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function obt(t){return t.mode===Tn.SKETCH||t.mode===Tn.MIXED}var Tn,kb;(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH",t[t.MIXED=2]="MIXED",t[t.COUNT=3]="COUNT"})(Tn||(Tn={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.SILHOUETTE=1]="SILHOUETTE"}(kb||(kb={}));function BK(t,e){const r=t.vertex;switch(t.attributes.add(A.SIDENESS,"vec2"),e.mode===Tn.MIXED?r.code.add(w`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):r.code.add(w`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case Tn.MIXED:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case Tn.SKETCH:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case Tn.SOLID:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case Tn.COUNT:break;default:e.mode}}function abt(t,e){const r=t.vertex;switch(t.include(BK,e),e.mode){case Tn.SOLID:r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case Tn.SKETCH:r.uniforms.add(new dw("strokesAmplitude",i=>i.strokesTexture.amplitude)),r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case Tn.MIXED:r.uniforms.add(new dw("strokesAmplitude",i=>i.strokesTexture.amplitude)),r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function lbt(t,e){t.include(BK,e);const{vertex:r,fragment:i}=t;switch(obt(e)&&(r.uniforms.add(q_("strokesTexture",s=>s.strokesTexture.texture,e.hasWebGL2Context?ei.None:ei.InvSize)),r.uniforms.add([new dw("strokesLog2Resolution",s=>Math.log2(s.strokesTexture.resolution)),new dw("strokeVariants",s=>s.strokesTexture.variants)]),t.varyings.add("vStrokeUV","vec2"),i.uniforms.add([new KM("strokesTexture",s=>s.strokesTexture.texture),new dw("strokesNormalizationScale",s=>s.strokesTexture.normalizationScale)]),r.code.add(w`
      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);

        vec2 textureSizeInverse = ${kh(e,"strokesTexture",!0)};
        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * textureSizeInverse;
        vStrokeUV.x += variantOffset;
      }
    `),t.fragment.include(jc),i.code.add(w`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case Tn.SOLID:r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),i.code.add(w`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case Tn.SKETCH:r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),i.code.add(w`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case Tn.MIXED:t.varyings.add("vType","float"),r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),i.code.add(w`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function cbt(t){const e=new Lr,{vertex:r,fragment:i}=e;return t.legacy&&r.uniforms.add([new gue("model"),new gue("localView")]),e.include(rbt,t),e.include(nbt,t),e.include(abt,t),e.include(BK,t),e.include(lbt,t),e.include(Zs,t),e.include(sbt,t),e.include(ibt,t),e.include(zu,t),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),r.uniforms.add([new Ur("pixelToNDC",(s,n)=>ar(ubt,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new fr("viewport",(s,n)=>n.camera.fullViewport),new Pe("pixelRatio",(s,n)=>n.camera.pixelRatio)]),e.attributes.add(A.POSITION0,"vec3"),e.attributes.add(A.POSITION1,"vec3"),e.attributes.add(A.VARIANTOFFSET,"float"),e.attributes.add(A.VARIANTSTROKE,"float"),e.attributes.add(A.VARIANTEXTENSION,"float"),r.code.add(w`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      vViewPos = viewPos;

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      ${t.antialiasing?w`
        const float aaPaddingPixels = 1.0;

        // Line size with padding
        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;`:w`
        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;`}

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${t.mode===Tn.SKETCH?w`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:t.mode===Tn.MIXED?w`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),i.code.add(w`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      gl_FragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),e}const ubt=Ke();let gue=class extends ws{constructor(e){super(e,"mat4")}};const hbt=Object.freeze(Object.defineProperty({__proto__:null,build:cbt},Symbol.toStringTag,{value:"Module"}));let xRe=class TRe extends kr{initializeConfiguration(e,r){r.hasWebGL2Context=e.rctx.type===bt.WEBGL2}initializeProgram(e){return new Nr(e.rctx,TRe.shader.get().build(this.configuration),NAe)}initializePipeline(e){return e.blendMinMax?zt({blending:Bn(Ee.ONE,Ee.ONE,Ee.ZERO,Ee.ONE,gm.ADD,e.blendMinMax.MAX),depthTest:{func:$i.LEQUAL},colorWrite:Qt}):zt({depthTest:{func:$i.LEQUAL},depthWrite:Yl,colorWrite:Qt})}};xRe.shader=new Dr(hbt,()=>ie(()=>import("./EdgeShader.glsl-20934619.js"),[],import.meta.url));let Ef=class extends io{constructor(){super(...arguments),this.mode=Tn.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}};u([k({count:Tn.COUNT})],Ef.prototype,"mode",void 0),u([k()],Ef.prototype,"hasSlicePlane",void 0),u([k()],Ef.prototype,"silhouette",void 0),u([k()],Ef.prototype,"legacy",void 0),u([k()],Ef.prototype,"antialiasing",void 0),u([k()],Ef.prototype,"doublePrecisionRequiresObfuscation",void 0),u([k()],Ef.prototype,"hasMultipassTerrain",void 0),u([k()],Ef.prototype,"cullAboveGround",void 0),u([k()],Ef.prototype,"spherical",void 0);const dbt=8,ik=128,pbt={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},fbt={solid:Tn.SOLID,sketch:Tn.SKETCH,uber:Tn.MIXED};let sk=class SRe{constructor(e,r,i){this._rctx=e,this._shaderTechniqueRepository=r,this._configuration=new Ef,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[ir.TRANSPARENT]:{[ir.TRANSPARENT]:new Kt,[ir.OPAQUE]:new Kt},[ir.OPAQUE]:{[ir.TRANSPARENT]:new Kt,[ir.OPAQUE]:new Kt}},this._renderablesDirty=!1,this._drawParameters=new Q1t,this._settings={...pbt,...i},this.key=SRe.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:Wr.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=fbt[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}dispose(){this._technique=ji(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,r){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[r][ir.TRANSPARENT].forAll(e),this._sortedRenderables[r][ir.OPAQUE].forAll(e)}updateTechnique(e,r){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=r,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(xRe,this._configuration,this._technique),this._technique}bindRegularEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!1),e,r)}bindSilhouetteEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!0),e,r)}renderRegularEdges(e,r,i,s,n){this._render(e,r,r.regular.vao,i,s,n)}renderSilhouetteEdges(e,r,i,s,n){this._render(e,r,r.silhouette.vao,i,s,n)}_render(e,r,i,s,n,o){o>0&&(this._bindDraw(e,r,s,n),this._rctx.bindVAO(i),this._rctx.capabilities.instancing.drawArraysInstanced($t.TRIANGLE_FAN,0,4,o))}_bindDraw(e,r,i,s){if(this._drawParameters.componentDataTexture=r.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in r.transform)this._lastOriginId!==r.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",r.transform.origin.viewMatrix),this._lastOriginId=r.transform.origin.origin.id),e.setUniformMatrix4fv("model",r.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=r.transform.origin.origin.vec3;else{const n=new tU(r.transform.position),o=Kh(yue,ox(yue,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=n.low,this._drawParameters.transformWorldFromModelTH=n.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=o;const a=s.camera.viewInverseTransposeMatrix;ce(this._drawParameters.slicePlaneLocalOrigin,a[3],a[7],a[11])}e.bindDraw(this._drawParameters,s,i)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[ir.TRANSPARENT][ir.TRANSPARENT].clear(),this._sortedRenderables[ir.TRANSPARENT][ir.OPAQUE].clear(),this._sortedRenderables[ir.OPAQUE][ir.TRANSPARENT].clear(),this._sortedRenderables[ir.OPAQUE][ir.OPAQUE].clear(),this._renderables.forEach(r=>{r.objectTransparency!==ir.INVISIBLE&&r.edgeTransparency!==ir.INVISIBLE&&this._sortedRenderables[r.objectTransparency][r.edgeTransparency].push(r)});const e=(r,i)=>"origin"in r.transform?"origin"in i.transform?r.transform.origin.origin.id<i.transform.origin.origin.id?-1:r.transform.origin.origin.id>i.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[ir.TRANSPARENT][ir.TRANSPARENT].sort(e),this._sortedRenderables[ir.TRANSPARENT][ir.OPAQUE].sort(e),this._sortedRenderables[ir.OPAQUE][ir.TRANSPARENT].sort(e),this._sortedRenderables[ir.OPAQUE][ir.OPAQUE].sort(e)}static getKey(e,r,i){return`edges-t:${e}:${r}:${i}`}};const yue=Hl();function t6t(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:mbt(t.layout)}}function lL(t){return gbt(t.layout).createView(t.buffer)}function mbt(t){const e=new Array;return t.fields.forEach((r,i)=>{const s={...r,constructor:ERe(r.constructor)};e.push([i,s])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}function gbt(t){const e=is();return e.stride=t.stride,e.fieldNames=t.fieldNames,t.fields.forEach(r=>e.fields.set(r[0],{...r[1],constructor:_bt(r[1].constructor)})),e}const ybt=[QZ,Ay,Ii,zc,dv,tJ,rJ,iJ,Ca,p6,eJ,U3,CE,f6,V3,Aa,m6,sJ,g6,tP,y6,nJ,Qwe,exe,oJ,_6,txe,rxe,ixe,v6,sxe,nxe,oxe,axe,lxe,cxe];function ERe(t){return`${t.ElementType}_${t.ElementCount}`}function _bt(t){return CRe.get(t)}const CRe=new Map;ybt.forEach(t=>CRe.set(ERe(t),t));let vbt=class extends OCe{constructor(e){super("EdgeProcessingWorker","extract",{extract:r=>[r.dataBuffer],extractComponentsEdgeLocations:r=>[r.dataBuffer],extractEdgeLocations:r=>[r.dataBuffer]},e)}async process(e,r,i){if(i)return lvt(e);const s=await this.invoke(new nk(e),r);return this._unpackOutput(s)}async extractEdgeLocations(e,r){const i=await this.invokeMethod("extractEdgeLocations",new nk(e),r);return lL(i)}async extractComponentsEdgeLocations(e,r){const i=await this.invokeMethod("extractComponentsEdgeLocations",new nk(e),r);return lL(i)}_unpackOutput(e){return{regular:{instancesData:lL(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:lL(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}},nk=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=Array.isArray(e.indices)?e.indices:e.indices.buffer,this.indicesType=Array.isArray(e.indices)?"Array":tW(e.indices)?"Uint32Array":"Uint16Array",this.indicesLength=e.indicesLength}};function bbt(t){const r=EA.resolution,i=r/2,s=new Uint8Array(4*r*r),n=4*r*i,o=EA.amplitude,a=2*o,l=4*r,c=Math.log2(r)+1,h=EA.strokes.length;let p=(c-1)*h*l;for(const{distance:m,pressure:y}of EA.strokes){let _=m,b=y,x=p;for(let T=0;T<c;T++){T!==0&&(_=_ue(_,cM.DISTANCE),b=_ue(b,cM.PRESSURE));for(let S=0;S<EA.resolution;S++){const E=.5+(_?_[S%_.length]/a:0),O=b?b[S%b.length]:1;H3(E,s,x),H3(O,s,x+n),x+=4}x-=l*(h+1)}p+=l}const f=new ct(t,{pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:tt.LINEAR,width:r,height:r,wrapMode:Ot.REPEAT},s);return new xbt(r,a,o,h,f)}function _ue(t,e){if(!t)return null;const r=t.length/2,i=wbt*r,s=new Array(r);let n=0;const o=e===cM.PRESSURE;for(let a=0;a<t.length;a+=2){const l=(t[a]+t[a+1])/2;s[n++]=o?Math.min(i,1-(1-l)*vue):Math.min(i,l*vue)}return s}var cM;(function(t){t[t.DISTANCE=0]="DISTANCE",t[t.PRESSURE=1]="PRESSURE"})(cM||(cM={}));const wbt=.1,vue=.5;let xbt=class{constructor(e,r,i,s,n){this.resolution=e,this.normalizationScale=r,this.amplitude=i,this.variants=s,this.texture=n}dispose(){this.texture=et(this.texture)}};const EA={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function bue(t){let e=null;for(const r of t){const i=r.type;if(Tbt(r)){if(C(e))e=i;else if(e!==i)return"uber"}}return v(e)?e:"uber"}function wue(t){let e=ir.INVISIBLE;for(const{material:r}of t)if(ARe(r)){if(r.color[3]*r.opacity<1)return ir.TRANSPARENT;e=ir.OPAQUE}return e}function xue(t){let e=ir.INVISIBLE;for(const{material:r}of t)if(ARe(r)){switch(r.objectTransparency){case ir.TRANSPARENT:case ir.INVISIBLE:return ir.TRANSPARENT;case ir.OPAQUE:if(r.opacity<1)return ir.TRANSPARENT}e=ir.OPAQUE}return e}function ARe(t){return t.size*t.color[3]*t.opacity>0}function Tbt(t){return t.size*t.color[3]>0}function Tue(t,e,r,i){for(let s=0;s<t.length;s++){const n=t[s].index,o=e[s],a=e[s+1];if(i)for(let l=o;l<a;l++){const c=i[l];r.set(c,n)}else for(let l=o;l<a;l++)r.set(l,n)}}let kd=class extends Te{constructor(t){super(t),this._updatingHandles=new em,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=M(),this._localOrigins=new Z1t(new tK(t.renderSR))}initialize(){this._worker=new vbt(this.schedule),this._componentColorManager=new VAe(this.rctx,3);const t=LAe.createBuffer(4);for(let e=0;e<4;e++)t.sideness.set(e,0,e===0||e===3?0:1),t.sideness.set(e,1,e===0||e===1?0:1);this._verticesBufferObject=jr.createVertex(this.rctx,$r.STATIC_DRAW,t.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach(t=>this._discardObjectEntry(t)),this._perObjectData.clear(),this._strokesTexture=et(this._strokesTexture),this._componentColorManager=Ve(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=et(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(t,e,r,i,s,n,o,a){if(this.hasObject(t))return this.getObjectMemoryUsage(t);let l;const c=new Eue(new Promise(p=>l=p),r.center,r.radius);this._perObjectData.set(t,c);const h=await this._updatingHandles.addPromise(this._addComponentGeometry(e,c,i,s,n,o,a));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(t,e,r,i){if(this.destroyed)return void se.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(t);let n;(s==null?void 0:s.renderables.length)>0&&this._perObjectDataEvictionCache.add(s);const o=t.boundingVolumeWorldSpace.bounds,a=new Eue(new Promise(c=>n=c),o,Hg(o));this._perObjectData.set(t,a);const l=new Array;if(r.mergeGeometries&&t.geometries.length>1&&Sbt(t))l.push(this._addObjectMergedGeometries(t,a,e,r,i));else for(let c=0;c<t.geometries.length;c++){const h=t.geometries[c];h.material.supportsEdges&&l.push(this._addGeometry(t,a,h,e[0],r,i))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(t){t&&(t.renderables.length&&(t.renderables.forEach(e=>this._removeRenderable(e)),this.setNeedsRender()),t.loaded=null)}hasObject(t){return this._perObjectData.has(t)}async updateAllComponentOpacities(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));if(C(r))return;const i=e instanceof Array?s=>e[s]:()=>e;r.renderables.forEach(s=>{const n=s.components.meta.length;for(let o=0;o<n;o++){const a=i(o),l=s.components.meta[o],c=l.index;l.material.opacity=a,s.components.buffer.textureBuffer.setDataElement(c,1,3,255*a)}this._updateTransparency(s)}),this.setNeedsRender()}async getObjectMemoryUsage(t){const e=await this._getObjectEntry(t);return v(e)?e.renderables.reduce((r,i)=>r+i.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(t,e,r,i){const s=t instanceof Py,n=!!r.hasSlicePlane,o=bue(e),a=sk.getKey(o,n,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(t));C(l)||(l.renderables.forEach(c=>{if(a!==c.rendererKey){const h=this._renderers.get(c.rendererKey),p=this._acquireRenderer(o,n,s);h.removeRenderable(c),--h.refCount,c.rendererKey=a,p.addRenderable(c)}for(let h=0;h<e.length;h++)c.components.meta[h].material=e[h];i&&this._updateComponentBuffer(c.components),this._updateTransparency(c)}),this.setNeedsRender())}async updateAllVerticalOffsets(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));C(r)||(r.renderables.forEach(i=>{const s=i.components.meta;for(let n=0;n<s.length;n++)i.components.meta[n].verticalOffset=(e==null?void 0:e[n])??0;this._updateComponentBuffer(i.components)}),this.setNeedsRender())}async updateObjectVisibility(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));v(r)&&(r.renderables.forEach(i=>i.visible=e),this.setNeedsRender())}removeObject(t){const e=this._perObjectData.get(t);e&&(this._perObjectData.delete(t),this._discardObjectEntry(e))}async _getObjectEntry(t){const e=this._perObjectData.get(t);if(!e)throw new Error("no object");return await e.loaded,e.loaded==null?null:e}render(t,e){if(C(this._componentColorManager))return;this._localOrigins.updateViewMatrices(t.camera.viewMatrix);const r=t.camera.viewInverseTransposeMatrix,i=M(),s=new tU;let n=0,o=0;if(this._renderers.forEach(l=>{if(l.refCount===0)this._renderers.delete(l.key),l.dispose();else{let c=!0,h=!0;l.forEachRenderable(p=>{p.visible&&(n+=p.statistics.averageEdgeLength,o++,c&&p.regular&&(l.updateTechnique(t,!1),c=!1),h&&p.silhouette&&(l.updateTechnique(t,!0),h=!1))},e)}}),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),o===0)return;const a=new K1t(40*n/o,e);ce(i,r[3],r[7],r[11]),s.set(i),le(a.transformWorldFromViewTH,s.high),le(a.transformWorldFromViewTL,s.low),Jh(a.transformViewFromCameraRelativeRS,t.camera.viewMatrix),Kh(Oue,a.transformViewFromCameraRelativeRS),ox(a.transformNormalViewFromGlobal,Oue),a.transformProjFromView=t.camera.projectionMatrix,this._updateObjectCameraDistances(t),this._renderers.forEach(l=>{this._renderRegularEdges(l,t,a),this._renderSilhouetteEdges(l,t,a)})}_updateTransparency(t){const e=wue(t.components.meta),r=xue(t.components.meta);e===t.edgeTransparency&&r===t.objectTransparency||(t.edgeTransparency=e,t.objectTransparency=r,this._renderers.get(t.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(t,e,r){t.getCombinedStaticTransformation(e,r);const i=v(e.localOrigin)?this._localOrigins.register(e.localOrigin):this._localOrigins.acquire(ce(this._tmpModelPosition,r[12],r[13],r[14]));return e.localOrigin=i.origin,X1t(i.origin.vec3,r),i}_updateComponentBuffer(t){const{meta:e,buffer:r}=t,i=new Uint8Array(4);for(let s=0;s<e.length;s++){const n=e[s].material,o=e[s].index,a=ye(Math.round(n.size*dbt),0,255),l=ye(n.extensionLength,-ik,255-ik)+ik,c=n.type==="solid"?F4.SOLID:F4.SKETCH,h=255*n.opacity,p=n.color,f=255*p[0],m=255*p[1],y=255*p[2],_=255*p[3];r.textureBuffer.setData(o,0,f,m,y,_),r.textureBuffer.setData(o,1,a,l,c,h),MAe(e[s].verticalOffset,i),r.textureBuffer.setData(o,2,i[0],i[1],i[2],i[3])}}_createComponentBuffers(t){if(C(this._componentColorManager))return null;const e=new Array,r=this._componentColorManager.getBuffer(t.length);for(let s=0;s<t.length;s++){const n=t[s],o=r.acquireIndex();e.push({index:o,verticalOffset:0,material:n})}const i=new Ebt(r,e);return this._updateComponentBuffer(i),i}_extractEdges(t,e,r,i,s,n=s.length){return this._worker.process({data:e,indices:s,indicesLength:n,writerSettings:t,skipDeduplicate:r},this._workerAbort.signal,i)}_createRenderable(t,e,r,i,s){const n=c=>v(this._verticesBufferObject)?new Cbt(new Pp(this.rctx,NAe,{vertices:J_t,instances:c===kb.REGULAR?D4.glLayout:N4.glLayout},{vertices:this._verticesBufferObject,instances:jr.createVertex(this.rctx,$r.STATIC_DRAW,c===kb.REGULAR?t.regular.instancesData.buffer:t.silhouette.instancesData.buffer)}),c===kb.REGULAR?t.regular.lodInfo:t.silhouette.lodInfo):null,o=t.regular.lodInfo.lengths.length>0?n(kb.REGULAR):null,a=t.silhouette.lodInfo.lengths.length>0?n(kb.SILHOUETTE):null,l=(v(o)?o.vao.size:0)+(v(a)?a.vao.size:0);return new Rbt(o,a,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:t.averageEdgeLength},r,wue(e.meta),xue(e.meta),e,i)}async _addGeometry(t,e,r,i,s,n){const o=r.vertexAttributes.get(A.POSITION),a=r.indices.get(A.POSITION),l=Ie(),c=this._computeModelTransformWithLocalOrigin(t,r,l),h=new Rue(o,a,l,c);return this._addPositionData(e,h,r.edgeIndicesLength,i,s,n)}async _addPositionData(t,e,r,i,s,n=!1){if(t.loaded==null)return;const o=this._createComponentBuffers([i]);if(C(o)||r<=0)return;const a=this._acquireRenderer(i.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=e,h=e.indices,p=e.position,f=p.data.length/p.size,m=$4.createBuffer(f);for(let b=0;b<f;b++)m.position.set(b,0,p.data[b*p.size+0]),m.position.set(b,1,p.data[b*p.size+1]),m.position.set(b,2,p.data[b*p.size+2]);Tue(o.meta,[0,m.componentIndex.count],m.componentIndex);const y=await this._updatingHandles.addPromise(this._extractEdges(a.writerSettings,m,!1,n,h,r));if(t.loaded==null)return;const _=this._createRenderable(y,o,new Abt(l,c),a.key,!1);t.renderables.push(_),a.addRenderable(_),this._gpuMemoryUsage+=_.statistics.gpuMemoryUsage}async _addComponentGeometry(t,e,r,i,s,n,o){if(e.loaded==null)return 0;const a=this._createComponentBuffers(n);if(C(a))return 0;const l=bue(n),c=this._acquireRenderer(l,o.hasSlicePlane||!1,!1),h=$4.createBuffer(r.count);H6(h.position,r),Tue(a.meta,s,h.componentIndex,i);const p=!0,f=c.writerSettings,m=await this._updatingHandles.addPromise(this._extractEdges(f,h,p,!1,i));if(e.loaded==null)return 0;const y=this._createRenderable(m,a,t,c.key,!0);return e.renderables.push(y),c.addRenderable(y),y.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(t,e,r,i,s){const n=new Map;let o=0,a=null,l=0;for(let x=0;x<t.geometries.length;x++){const T=t.geometries[x];if(!T.material.supportsEdges)continue;!a&&T.localOrigin&&(a=T);const S=T.vertexAttributes.get(A.POSITION);l+=S.data.length/S.size,o+=T.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let x=0;x<t.geometries.length;x++){const T=t.geometries[x];if(!T.material.supportsEdges)continue;const S=T.vertexAttributes.get(A.POSITION),E=T.indices.get(A.POSITION);let O=n.get(S.data);if(O==null){O=p.length/3;for(let R=0;R<S.data.length;R+=S.size)p.push(S.data[R+0]),p.push(S.data[R+1]),p.push(S.data[R+2]);n.set(S.data,O)}if(E)for(let R=0;R<T.edgeIndicesLength;R++)h[f++]=O+E[R]}const m=a||t.geometries[0],y=Ie(),_=this._computeModelTransformWithLocalOrigin(t,m,y);for(let x=0;x<t.geometries.length;x++)t.geometries[x].localOrigin=_.origin;const b=new Rue({data:p,size:3},h,y,_);await this._updatingHandles.addPromise(this._addPositionData(e,b,h.length,r[0],i,s))}_acquireRenderer(t,e,r){const i=sk.getKey(t,e,r);let s=this._renderers.get(i);return C(this._strokesTexture)&&(this._strokesTexture=bbt(this.rctx)),s||(s=new sk(this.rctx,this.techniqueRepository,{type:t,hasSlicePlane:e,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===Be.Global}),this._renderers.set(i,s)),++s.refCount,s}_removeRenderable(t){Sue(t.regular),Sue(t.silhouette);const e=this._renderers.get(t.rendererKey);if(e){e.removeRenderable(t),--e.refCount,"origin"in t.transform&&this._localOrigins.release(t.transform.origin),this._gpuMemoryUsage-=t.statistics.externalMemoryUsage?0:t.statistics.gpuMemoryUsage;for(const r of t.components.meta)t.components.buffer.releaseIndex(r.index)}}_updateObjectCameraDistances(t){const e=t.camera.eye,r=t.camera.viewForward,i=M(),s=n=>{so(i,n.center,e);const o=_e(i,r),a=n.radius,l=o<-a?1/0:o<a?0:o-a;n.renderables.forEach(c=>c.distanceToCamera=l)};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(t,e,r){const i=t.bindRegularEdges(r,e),s=r.transparency,n=e.camera.perScreenPixelRatio;t.forEachRenderable(o=>{if(!Cue(o)||!o.visible)return;const a=cL(o.regular.lod.lengths,o.distanceToCamera,n);t.renderRegularEdges(i,o,r,e,a)},s)}_renderSilhouetteEdges(t,e,r){const i=t.bindSilhouetteEdges(r,e),s=r.transparency,n=e.camera.perScreenPixelRatio;t.forEachRenderable(o=>{if(!Aue(o)||!o.visible)return;const a=cL(o.silhouette.lod.lengths,o.distanceToCamera,n);t.renderSilhouetteEdges(i,o,r,e,a)},s)}get test(){return{hasRenderedPrimitives:t=>{let e=!1;const r=t.perScreenPixelRatio,i=(s,n)=>s.forEachRenderable(o=>{o.visible&&!e&&(Cue(o)&&(e=cL(o.regular.lod.lengths,o.distanceToCamera,r)>0),!e&&Aue(o)&&(e=cL(o.silhouette.lod.lengths,o.distanceToCamera,r)>0))},n);return this._renderers.forEach(s=>{e||(i(s,ir.OPAQUE),i(s,ir.TRANSPARENT))}),e}}}};function Sue(t){v(t)&&(t.vao.vertexBuffers.instances.dispose(),t.vao.dispose(!1),t.vao=null)}function Sbt(t){let e=null,r=null;for(let i=0;i<t.geometries.length;i++){const s=t.geometries[i];if(s.material.supportsEdges){if(e){if(!ry(e,s.transformation))return!1}else e=s.transformation;if(!r&&v(s.localOrigin))r=s;else if(r&&v(r.localOrigin)&&v(s.localOrigin)&&r.localOrigin.id!==s.localOrigin.id)return!1}}return!0}u([d({constructOnly:!0})],kd.prototype,"rctx",void 0),u([d({constructOnly:!0})],kd.prototype,"renderSR",void 0),u([d({constructOnly:!0})],kd.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],kd.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],kd.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],kd.prototype,"schedule",void 0),u([d({readOnly:!0})],kd.prototype,"_updatingHandles",void 0),u([d({readOnly:!0})],kd.prototype,"updating",null),kd=u([P("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],kd);class Eue{constructor(e,r,i){this.center=r,this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}class Ebt{constructor(e,r){this.buffer=e,this.meta=r}}let Cbt=class{constructor(e,r){this.vao=e,this.lod=r}};class Abt{constructor(e,r){this.modelMatrix=e,this.origin=r}}class Rbt{constructor(e,r,i,s,n,o,a,l){this.regular=e,this.silhouette=r,this.statistics=i,this.transform=s,this.edgeTransparency=n,this.objectTransparency=o,this.components=a,this.rendererKey=l,this.distanceToCamera=0,this.visible=!0}}function Cue(t){return v(t.regular)}function Aue(t){return v(t.silhouette)}function cL(t,e,r){const i=e*r,s=r3e(t,i,!0);return s===-1?i<t[0]?t.length:0:t.length-s}let Rue=class{constructor(e,r,i,s){this.position=e,this.indices=r,this.modelTransform=i,this.origin=s}};const Oue=rs();function Pm(t){return window.WebGL2RenderingContext&&t instanceof window.WebGL2RenderingContext}let Mue=class{constructor(e,r,i,s,n,o,a,l,c){this.createQuery=e,this.deleteQuery=r,this.resultAvailable=i,this.getResult=s,this.disjoint=n,this.beginTimeElapsed=o,this.endTimeElapsed=a,this.createTimestamp=l,this.timestampBits=c}},Sg=!1;function Obt(t,e){if(e.disjointTimerQuery)return null;let r=t.getExtension("EXT_disjoint_timer_query_webgl2");return r&&Pm(t)?new Mue(()=>t.createQuery(),i=>{t.deleteQuery(i),Sg=!1},i=>t.getQueryParameter(i,t.QUERY_RESULT_AVAILABLE),i=>t.getQueryParameter(i,t.QUERY_RESULT),()=>t.getParameter(r.GPU_DISJOINT_EXT),i=>{Sg||(Sg=!0,t.beginQuery(r.TIME_ELAPSED_EXT,i))},()=>{t.endQuery(r.TIME_ELAPSED_EXT),Sg=!1},i=>r.queryCounterEXT(i,r.TIMESTAMP_EXT),()=>t.getQuery(r.TIMESTAMP_EXT,r.QUERY_COUNTER_BITS_EXT)):(r=t.getExtension("EXT_disjoint_timer_query"),r?new Mue(()=>r.createQueryEXT(),i=>{r.deleteQueryEXT(i),Sg=!1},i=>r.getQueryObjectEXT(i,r.QUERY_RESULT_AVAILABLE_EXT),i=>r.getQueryObjectEXT(i,r.QUERY_RESULT_EXT),()=>t.getParameter(r.GPU_DISJOINT_EXT),i=>{Sg||(Sg=!0,r.beginQueryEXT(r.TIME_ELAPSED_EXT,i))},()=>{r.endQueryEXT(r.TIME_ELAPSED_EXT),Sg=!1},i=>r.queryCounterEXT(i,r.TIMESTAMP_EXT),()=>r.getQueryEXT(r.TIMESTAMP_EXT,r.QUERY_COUNTER_BITS_EXT)):null)}function Mbt(t,e){const r=t.capabilities.disjointTimerQuery;return C(r)?null:new Pbt(r,e)}let Pbt=class{constructor(e,r){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,r.forEach(i=>{const s=this._timer.createQuery(),n=this._timer.createQuery();this._queryPool.push(s,n),this._queryResults.set(i,null)})}start(){Sg||(this._currentQuery=this._queryPool.pop(),C(this._currentQuery)||(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||C(this._currentQuery)||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const r=this._queryResults.get(e);if(C(r))return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(r))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(r)/1e6;return this._queryPool.unshift(r),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){v(this._currentQuery)&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){v(this._currentQuery)&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{C(e)||this._timer.deleteQuery(e)})}};var Oi;(function(t){t.OVERLAY="overlay",t.PREPARE="prepare",t.SHADOW_MAP="shadow map",t.LINEAR_DEPTH="linear depth",t.ACCUMULATED_SHADOWS="accumulated shadows",t.NORMALS="normals",t.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",t.SSAO="SSAO",t.OPAQUE="opaque",t.OPAQUE_EDGES="opaque edges",t.VOXEL="voxel",t.TRANSPARENT="transparent",t.TRANSPARENT_EDGES="transparent edges",t.HUD_VISIBILITY="HUD visibility",t.TRANSPARENT_TERRAIN="transparent terrain",t.ENVIRONMENT="environment",t.LASER_LINE="laser line",t.OCCLUDED="occluded",t.ANTIALIASING="antialiasing",t.HIGHLIGHTS="highlights",t.HUD="HUD",t.HUD_OCCLUDED="HUD occluded",t.FINISH="finish"})(Oi||(Oi={}));const Pue="Total";let Ibt=class{constructor(e){this._rctx=e,this._startTimeStampCPU=0,this._lastTimeStampCPU=0,this._totalCPUTime=new Ug(Pue),this._cpuTimeSamplers=new Map(Object.values(Oi).map(r=>[r,new Ug(r)])),this._enableGPUTimer=0,this._totalGPUTime=new Ug("GPU"),this._gpuTimeSamplers=new Map(Object.values(Oi).map(r=>[r,new Ug(r)])),this._totalTime=0,this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return v(this._gpuTimerPool)}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return performance.now()-this._startTimeStampCPU}enableGPUPerformanceInfo(){if(C(this._gpuTimerPool)){const e=[...Object.values(Oi),Pue];this._gpuTimerPool=Mbt(this._rctx,e)}return C(this._gpuTimerPool)?{hasGPUTimerSupport:!1,remove:()=>{}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:gW(()=>{--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=et(this._gpuTimerPool))})})}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=performance.now(),v(this._gpuTimerPool)&&this._gpuTimerPool.start()}advance(e){const r=performance.now();if(this._cpuTimeSamplers.get(e).record(r-this._lastTimeStampCPU),this._lastTimeStampCPU=r,v(this._gpuTimerPool)){const i=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(i),this._gpuTimerPool.start()}}finishFrame(){if(v(this._gpuTimerPool)){const r=this._gpuTimerPool.stop(Oi.FINISH);this._gpuTimeSamplers.get(Oi.FINISH).record(r)}const e=performance.now()-this._startTimeStampCPU;this._totalTime=this._totalTime+e,this._totalCPUTime.record(e),v(this._gpuTimerPool)&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((r,i)=>r+(i.last||0),0)),++this._totalFrameCount}},cu=class extends Te{get _bindParameters(){return this._renderContext.bindParameters}isFeatureEnabled(t,e=this._state){return It(this._renderStateFeatures.get(e,t),!1)}setFeatureEnabled(t,e,r){this._renderStateFeatures.set(e,t,r),this.notifyChange("_renderStateFeatures"),this._requestRender()}get _antialiasing(){return this._antialiasingEnabled||this.isFeatureEnabled(Gs.Antialiasing)}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Gs.HighQualityTransparency)}get hasWaterReflection(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(Gs.WaterReflection))}get hasWater(){return this._hasWater||this._hasOverlayWater}constructor(t,e,r,i,s,n,o,a){super({}),this._stage=t,this._materialRepository=e,this._shaderTechniqueRepository=i,this._rctx=s,this._compositingHelper=n,this._magnifierHelper=o,this._requestRender=a,this._materialRenderers=new Kt,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._renderOverlay=l=>{},this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._sliceHelper=new V1t,this._state=Tr.IDLE,this._renderStateFeatures=Rne(),this._antialiasingEnabled=!0,this._highQualityTransparencyEnabled=!0,this._terrainRenderingEnabled=!0,this._terrainTransparency=In.Opaque,this._waterReflectionEnabled=!1,this._ssaoEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new Yvt,this._handles=new Zr,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new eO(this._rctx,i),a(),this._offscreen=new m1t(this._rctx,this._compositingHelper),this.performanceInfo=new Ibt(this._rctx),this._shadowMap=new rK(this._rctx,t.viewingMode),this._ssaoHelper=new qSe(t.view,i,this._rctx,a),this._highlight=new h1t(i,this._rctx),this._shadowHighlight=new U1t(this._rctx,t.viewingMode),this._shadowAccumulator=new Pl(this._rctx,i,t,l=>{const c=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(l.camera,l.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=c},(l,c,h)=>{l.shadowMap.start(l.camera,c,h),this._renderShadowCascades(V.Shadow,l.shadowMap),l.camera.setGLViewport(this._rctx),this._prepare(l.camera,l.contentCamera)},a),this._renderContext=new Hat(this._rctx,this._offscreen,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new _1t({renderContext:this._renderContext,techniqueRepository:i,textureRepository:r,materialRepository:this._materialRepository,requestRender:a,controller:t}),this.renderPassManager=new Xvt(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([ne(()=>this._stage.view.state.camera,()=>a(),qs),ne(()=>Wr.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,l=>{this._renderHiddenTransparentEdges=l?()=>this._renderEdges(ir.TRANSPARENT):()=>{},a()},kt),ne(()=>this._ssaoEnabled||this.isFeatureEnabled(Gs.SSAO),l=>this._ssaoHelper.enabled=l,qs)])}normalizeCtorArgs(){return{}}destroy(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=Vi(this._gpuTimerHandle),this._materialRenderers.forAll(t=>t.dispose()),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=et(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),fxe.prune()}disposeOffscreenBuffers(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing&&this._smaaPass.updating||v(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return C(this._edgeView)&&(this._edgeView=new kd({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:t=>this._stage.view.resourceController.immediate.schedule(t)}),this._handles.add(ne(()=>ao(this._edgeView,t=>t.updating),()=>this._requestRender(),ri)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return dX(this._bindParameters.ssr.reprojectionMatrix,Uu)}set _reprojectionMatrix(t){Kq(this._bindParameters.ssr.reprojectionMatrix,t)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){var t;return!!((t=this._shadowMap)!=null&&t.enabled)}setParameters(t){const{_shadowMap:e,_bindParameters:r}=this;if(t.screenSpaceReflectionsEnabled!==void 0&&r.ssr.enabled!==t.screenSpaceReflectionsEnabled&&(r.ssr.enabled=t.screenSpaceReflectionsEnabled,this._requestRender()),t.shadowMap!==void 0&&this._shadowMap.enabled!==t.shadowMap&&(this._shadowMap.enabled=t.shadowMap,this._requestRender()),t.shadowMapMaxCascades!==void 0&&e.maxCascades!==t.shadowMapMaxCascades&&(e.maxCascades=t.shadowMapMaxCascades,this._requestRender()),v(t.environment)){v(t.environment.weather)&&(this._bindParameters.weather=t.environment.weather,this._bindParameters.weatherVisible=!!t.weatherVisible),t.environment.lighting.ambientOcclusionEnabled!==void 0&&this._ssaoEnabled!==t.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=t.environment.lighting.ambientOcclusionEnabled,this._requestRender()),t.environment.lighting.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==t.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=t.environment.lighting.waterReflectionEnabled,this._requestRender());const i=t.environment.lighting.type!=="virtual";r.enableFillLights!==i&&(r.enableFillLights=i,this._requestRender())}t.background&&this._offscreen.background!==t.background&&(this._offscreen.background=t.background,this._requestRender()),t.antialiasingEnabled!==void 0&&this._antialiasingEnabled!==t.antialiasingEnabled&&(this._antialiasingEnabled=t.antialiasingEnabled,this._requestRender()),t.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==t.highQualityTransparency&&(this._highQualityTransparencyEnabled=t.highQualityTransparency,this._requestRender()),t.defaultHighlightOptions!==void 0&&(this._highlight.setDefaultOptions(t.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(t.defaultHighlightOptions),this._requestRender()),t.overlays!==void 0&&this._bindParameters.overlays!==t.overlays&&(this._bindParameters.overlays=t.overlays,this._requestRender()),t.hasOverlayWater!==void 0&&this._hasOverlayWater!==t.hasOverlayWater&&(this._hasOverlayWater=t.hasOverlayWater,this._requestRender()),t.renderOverlay!==void 0&&this._renderOverlay!==t.renderOverlay&&(this._renderOverlay=t.renderOverlay,this._requestRender()),t.slicePlane!==void 0&&this._sliceHelper.plane!==t.slicePlane&&(this._sliceHelper.plane=t.slicePlane,this._requestRender()),t.terrainRenderingEnabled!==void 0&&this._terrainRenderingEnabled!==t.terrainRenderingEnabled&&(this._terrainRenderingEnabled=t.terrainRenderingEnabled,this._requestRender()),t.terrainTransparency!==void 0&&this._terrainTransparency!==t.terrainTransparency&&(this._terrainTransparency=t.terrainTransparency,this._requestRender()),t.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(t.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(t,e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:i,updates:s}=t;if(r.length===0&&i.length===0&&s.length===0)return;const n=ASe(t);let o=!1;n.forEach((a,l)=>{if(e.done)return;let c=this._materialRenderers.find(h=>h.material===l);C(c)&&a.adds.length>0&&(c=new VSe(this._rctx,this._materialRepository,l),this._materialRenderers.push(c)),c&&(c.modify(a),c.isEmpty&&(o=!0)),a.removes.forEach(h=>t.removes.removeUnordered(h)),a.adds.forEach(h=>t.adds.removeUnordered(h)),a.updates.forEach(h=>t.updates.removeUnordered(h)),e.madeProgress()}),o&&this._materialRenderers.filterInPlace(a=>!a.isEmpty||(a.dispose(),!1)),this._hasHighlights=this._materialRenderers.some(a=>a.hasHighlights),this._bindParameters.hasOccludees=this._materialRenderers.some(a=>a.hasOccludees),this._hasWater=this._materialRenderers.some(a=>a.hasWater),this._hasHUDElements=this._materialRenderers.some(a=>a.requiresSlot(Se.LINE_CALLOUTS_HUD_DEPTH,V.Color)||a.requiresSlot(Se.HUD_MATERIAL,V.Color)||a.requiresSlot(Se.LABEL_MATERIAL,V.Color)),this._requestRender()}updateAnimation(t){const e=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll(r=>this._hasAnimations=r.updateAnimation(t)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(t)||this._hasAnimations,this._hasAnimations!==e&&(this._gpuTimerHandle=e?Vi(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}render(t,e,r,i,s){this._isRendering=!0,this.performanceInfo.startFrame();const{camera:n,contentCamera:o,mode:a}=r;this._state=a,this._renderOverlay(s),this.performanceInfo.advance(Oi.OVERLAY),this._renderContext.time=s,this._bindParameters.transparencyPassType=Tt.NONE;const l=this._offscreen;l.setupRenderTarget(this.hasWaterReflection);const c=_y(this._sliceHelper.plane);i===zw.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(t),n.setGLViewport(this._rctx),this._prepare(n,o),this._renderPlugins.prepareRender(),this.performanceInfo.advance(Oi.PREPARE);const h=this._computeDepthRange(n);this._renderShadowMap(t,n,this._bindParameters.lighting.mainLight.direction,h),this.performanceInfo.advance(Oi.SHADOW_MAP),l.initializeFrame(n),this._ensureBindParameters(n,o),this._renderLinearDepth(),this.performanceInfo.advance(Oi.LINEAR_DEPTH),this._accumulateShadows(h,n,o),this.performanceInfo.advance(Oi.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(Oi.NORMALS),this._ensureBindParametersSSR(s),this._renderSSAO(s),this.performanceInfo.advance(Oi.SSAO),this._renderContext.output=V.Color,l.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Oi.OPAQUE);const p=this._terrainRenderingEnabled&&(this._terrainTransparency===In.Semitransparent||this._terrainTransparency===In.TransparentWithDraped),f=this._highQualityTransparency&&p;this._renderTerrainLinearDepth(f),this._setMultipassEnabled(f),this._setTerrainCulling(f),this._renderEdges(ir.OPAQUE),this.performanceInfo.advance(Oi.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(Se.VOXEL),this.performanceInfo.advance(Oi.VOXEL),this._renderHiddenTransparentEdges();const m=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;m&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Oi.TRANSPARENT),this._renderGeometryLinearDepth(f);const y=this._renderHUDVisibility(f);f||this._renderInternalSlot(Se.LINE_CALLOUTS),this.performanceInfo.advance(Oi.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(e),this.performanceInfo.advance(Oi.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(ir.TRANSPARENT,f),this.performanceInfo.advance(Oi.TRANSPARENT_EDGES),this._renderTransparentTerrain(),p&&y&&(f?this._renderLineCallouts(fu.Occluded):l.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(fu.Occluded,l.framebuffer),this.performanceInfo.advance(Oi.HUD_OCCLUDED)),this.performanceInfo.advance(Oi.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),p&&(l.compositeTransparentTerrainOntoMain(this._bindParameters),f&&(this._renderEdges(ir.OPAQUE),this.performanceInfo.advance(Oi.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Oi.TRANSPARENT),this._renderEdges(ir.TRANSPARENT),this.performanceInfo.advance(Oi.TRANSPARENT_EDGES))),f&&this._renderLineCallouts(fu.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),l.renderToTargets(()=>{this._renderInternalSlot(Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(Se.LASERLINES)},l.currentColorTarget,l.mainDepth),this.performanceInfo.advance(Oi.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&l.renderTmpAndCompositeToMain(()=>this._renderSlot(Se.LASERLINES_CONTRAST_CONTROL),this._bindParameters,_a.PremultipliedAlpha),this.performanceInfo.advance(Oi.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(Oi.OCCLUDED);const _=i===zw.ON&&this._magnifierHelper.enabled,b=_&&C(t)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):t;this._rctx.bindFramebuffer(b);const x=this._offscreen.colorTexture;!this._renderAntiAliasing(x)&&v(x)&&this._compositingHelper.composite(this._bindParameters,x,_a.None),this.performanceInfo.advance(Oi.ANTIALIASING),this._renderHUD(fu.NotOccluded,b),this.performanceInfo.advance(Oi.HUD),this._renderHighlights(b,this._bindParameters),this.performanceInfo.advance(Oi.HIGHLIGHTS),_&&this._magnifierHelper.render(this._rctx,this._bindParameters),b!==t&&(this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,_a.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=c,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}_renderObjectAndLayerIdColor(t){if(v(t)&&de("enable-feature:objectAndLayerId-rendering")){const e=this._renderContext.output;this._rctx.bindFramebuffer(t),this._offscreen.renderToFBO(()=>this._renderGeometryAndTransparentTerrainPass(V.ObjectAndLayerIdColor),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(t),this._offscreen.renderToFBO(()=>{this._bindParameters.renderTransparentlyOccludedHUD=fu.NotOccluded,this._renderInternalSlot(Se.HUD_MATERIAL)},void 0,!0,!0),this._renderContext.output=e}}finish(t){this._hasAnimations||this._animationTimestep.clear();const e=this.performanceInfo.gpuSamplingEnabled,r=t===Ps.BACKGROUND;if(r||e){const i=r?this.performanceInfo.elapsedTime:0,s=e?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),n=Math.max(i,s);this._animationTimestep.frame(n,r)}}readDepthPixels(t,e,r){const i=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(t,t),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const s=Fi.COLOR_BUFFER_BIT|Fi.DEPTH_BUFFER_BIT|Fi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(s),this._renderGeometryAndTransparentTerrainPass(V.Depth)}i.readPixels(e[0],e[1],e[2],e[3],ze.RGBA,Lt.UNSIGNED_BYTE,r)}readHUDVisibility(t,e,r,i,s){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(t,e,r,i,ze.RGBA,Lt.UNSIGNED_BYTE,s)}readAccumulatedShadow(t){return this._shadowAccumulator.readAccumulatedShadow(t[0],t[1])}_setMultipassEnabled(t){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=t}_setTerrainCulling(t){this._bindParameters.multipassTerrain.cullAboveGround=t}_renderSlot(t){this._bindParameters.slot=t,this._renderPlugins.render()}_renderEdges(t,e=!1){const r=this._edgeView;v(r)&&r.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain(()=>r.render(this._bindParameters,t),this._bindParameters,_a.Alpha,e)}_renderShadowMap(t,e,r,i){const s=this._shadowMap;s.enabled&&this.isFeatureEnabled(Gs.ShadowMapUpdate)&&(s.start(e,r,i),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(V.ShadowHighlight,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,$E.Highlight)),s.clear(),this._renderShadowCascades(V.ShadowExcludeHighlight,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,$E.Default),this._renderGeometryAndTransparentTerrainPass(V.ShadowHighlight)})):this._renderShadowCascades(V.Shadow),s.finish(t),e.setGLViewport(this._rctx))}_renderShadowCascades(t,e=this._shadowMap,r=i=>{}){for(const i of e.cascades)i.camera.setGLViewport(this._rctx),this._prepare(i.camera,i.camera),this._renderGeometryAndTransparentTerrainPass(t),r(i)}get _needsLinearDepth(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreen.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(V.Depth),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture}_renderTerrainLinearDepth(t){if(t){const e=this._renderContext.output;this._renderContext.output=V.Depth,this._offscreen.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture}_renderGeometryLinearDepth(t){if(t){const e=this._renderContext.output;this._offscreen.renderToTargets(()=>this._renderGeometryPass(V.Depth),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture}get _needsNormal(){return this._ssaoHelper.active}_renderNormal(){this._needsNormal?this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(V.Normal)},this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(t){if(!this._needsDepthRange)return Pq;const e=Pvt(t,this._materialRenderers,this._stage.layers);return FE(e,this.renderPlugins.queryDepthRange(t)),e.near=Math.max(t.near,e.near),e.far=Math.min(t.far,e.far),e}_renderGeometryAndTransparentTerrainPass(t){this._renderContext.output=t,this._renderGeometryPass(t),this._renderTransparentTerrain()}_renderGeometryPass(t){this._renderContext.output=t,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderSSAO(t){this._ssaoHelper.render(this._bindParameters,t,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)}_renderOpaqueGeometry(){this._renderSlot(Se.INTEGRATED_MESH),this._renderSlot(Se.OPAQUE_TERRAIN),this._renderInternalSlot(Se.OPAQUE_MATERIAL),this._renderSlot(Se.OPAQUE_MATERIAL),this._renderSlot(Se.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(Se.TRANSPARENT_MATERIAL),this._renderSlot(Se.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(Se.TRANSPARENT_TERRAIN)}_renderHUDVisibility(t){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(Se.OCCLUSION_PIXELS)},t),e}_renderLineCallouts(t){this._bindParameters.renderTransparentlyOccludedHUD=t,t===fu.Occluded?this._offscreen.renderToTargets(()=>this._renderInternalSlot(Se.LINE_CALLOUTS),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(Se.LINE_CALLOUTS)}_renderHUD(t,e){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(t),!0),this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,_a.PremultipliedAlpha)):t===fu.Occluded?this._offscreen.renderToTargets(()=>this._renderHUDElements(fu.Occluded),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(t))}_renderHUDElements(t){this._bindParameters.renderTransparentlyOccludedHUD=t,this._renderInternalSlot(Se.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(Se.HUD_MATERIAL),this._renderInternalSlot(Se.LABEL_MATERIAL)}get _needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}_renderHighlights(t,e){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const r=this._highlight,i=this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(V.Highlight),this._rctx.clearSafe(Fi.DEPTH_BUFFER_BIT),this._renderHUDElements(fu.Both)},this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(e,t),r.render(this._bindParameters,i,t)}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(t,e,r){this._needsShadowCast&&v(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,t,e,r)}_renderOrderIndependentTransparency(t,e){const r=s=>{this._bindParameters.transparencyPassType=s,this._offscreen.renderOITPass(()=>t(),s,e)},i=this._renderContext.output;this._renderContext.output=V.Alpha,r(Tt.Alpha),this._renderContext.output=V.Color,r(Tt.Color),r(Tt.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,e),this._bindParameters.transparencyPassType=Tt.NONE,this._renderContext.output=i,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let t=0;_d.clear(),this._materialRenderers.forAll(n=>{n.material&&n.material.isVisible()&&n.material.renderOccluded===as.OccludeAndTransparentStencil&&(t|=n.material.renderOccluded,_d.push(n))});const e=this._offscreen,r=(n,o,a,l,c)=>{t&o&&(e.renderToTargets(a,e.tmpColor,e.mainDepth,[0,0,0,0],l,c),e.compositeOccludedOntoMain(this._bindParameters,n))};_d.length!==0&&(this._renderInternalSlot(Se.OCCLUDER_MATERIAL,_d),r(.5,as.OccludeAndTransparentStencil,()=>this._renderInternalSlot(Se.TRANSPARENT_OCCLUDER_MATERIAL,_d),!1,!1)),_d.clear(),this._materialRenderers.forAll(n=>{n.material&&n.material.isVisible()&&(n.material.renderOccluded===as.OccludeAndTransparent||n.material.renderOccluded===as.Transparent||n.material.renderOccluded===as.Opaque)&&(t|=n.material.renderOccluded,_d.push(n))});const i=this._renderPlugins.renderOccludedFlags;if(t|=i,!t)return;const s=n=>{this._renderContext.renderOccludedMask=n,i>as.Occlude&&this._renderSlot(Se.OCCLUDED_TERRAIN),this._renderInternalSlot(Se.OPAQUE_MATERIAL,_d),this._renderInternalSlot(Se.TRANSPARENT_MATERIAL,_d),this._renderInternalSlot(Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,_d),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=V.Color,r(.5,as.OccludeAndTransparent,()=>s(as.OccludeAndTransparent),!0,jl.OutlineVisualElementMask),r(.5,as.Transparent,()=>s(as.Transparent),!0,jl.OutlineVisualElementMask),r(1,as.Opaque,()=>s(as.Opaque),!0,jl.OutlineVisualElementMask),_d.clear()}_renderAntiAliasing(t){if(this._antialiasing){if(this._smaaPass.enable(()=>this._requestRender())&&v(t))return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_prepare(t,e){this._needsTransparentPass=this._materialRenderers.some(r=>r.requiresSlot(Se.TRANSPARENT_MATERIAL,V.Color)),this._bindParameters.camera=t,this._bindParameters.contentCamera=e}_ensureBindParameters(t,e){this._bindParameters.camera=t,this._bindParameters.contentCamera=e;const r=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=r.hudVisibilityTexture,this._bindParameters.mainColorTexture=r.mainColorTexture,this._bindParameters.highlightDepthTexture=r.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(t){if(this._bindParameters.ssr.enabled=this.hasWaterReflection,this._bindParameters.ssr.enabled){C(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=t),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Uu:(Lo($ue,this._bindParameters.camera.viewMatrix),Lo(Iue,this._bindParameters.camera.projectionMatrix),ys(ST,$ue,Iue),ys(ST,this._renderContext.lastFrameCamera.viewMatrix,ST),ys(ST,this._renderContext.lastFrameCamera.projectionMatrix,ST),this._reprojectionMatrix=ST),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const e=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=e>0?Math.min(e,t-this._waterReflectionEnableTime)/e:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._bindParameters.ssr.lastFrameColorTexture=null,this._waterReflectionEnableTime=null}_renderInternalSlot(t,e=this._materialRenderers){let r=!1;return this._bindParameters.slot=t,e.forAll(i=>{i.material.shouldRender(this._renderContext)&&i.render(this._renderContext.output,this._bindParameters)&&(r=!0)}),r}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Cwe(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var t,e,r,i,s;return{offscreen:((t=this._offscreen)==null?void 0:t.gpuMemoryUsage)??0,highlights:(((e=this._highlight)==null?void 0:e.gpuMemoryUsage)??0)+(((r=this._shadowHighlight)==null?void 0:r.gpuMemoryUsage)??0),shadows:((i=this._shadowMap)==null?void 0:i.gpuMemoryUsage)??0,ssao:((s=this._ssaoHelper)==null?void 0:s.gpuMemoryUsage)??0}}get test(){const t=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{t._renderStateFeatures=Rne()},getFramebufferTexture:e=>{switch(e){case d_.Color:return t._offscreen.colorTexture;case d_.LinearDepth:return t._offscreen.linearDepthTexture;case d_.Normals:return t._offscreen.normalTexture;case d_.ShadowMap:return t._shadowMap.depthTexture;case d_.HudVisibility:return t._offscreen.hudVisibilityTexture;case d_.Highlight:return t._offscreen.highlightTexture}}}}};var d_;u([d()],cu.prototype,"_shadowAccumulator",void 0),u([d()],cu.prototype,"_state",void 0),u([d()],cu.prototype,"_renderStateFeatures",void 0),u([d()],cu.prototype,"_antialiasingEnabled",void 0),u([d({readOnly:!0})],cu.prototype,"_antialiasing",null),u([d()],cu.prototype,"_ssaoEnabled",void 0),u([d()],cu.prototype,"_smaaPass",void 0),u([d({autoDestroy:!0})],cu.prototype,"_edgeView",void 0),u([d()],cu.prototype,"updating",null),u([d()],cu.prototype,"isCameraFinal",null),cu=u([P("esri.views.3d.webgl-engine.lib.Renderer")],cu),function(t){t[t.Color=0]="Color",t[t.LinearDepth=1]="LinearDepth",t[t.Normals=2]="Normals",t[t.ShadowMap=3]="ShadowMap",t[t.HudVisibility=4]="HudVisibility",t[t.Highlight=5]="Highlight"}(d_||(d_={}));const _d=new Kt,Iue=Ie(),$ue=Ie(),ST=Ie();let Lue=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Ee.ONE,dstRGB:Ee.ZERO,srcAlpha:Ee.ONE,dstAlpha:Ee.ZERO},this.blendEquation={mode:gm.ADD,modeAlpha:gm.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=lp.BACK,this.frontFace=SE.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=$i.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:lp.FRONT_AND_BACK,func:$i.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:lp.FRONT_AND_BACK,fail:Ds.KEEP,zFail:Ds.KEEP,zPass:Ds.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},$bt=class{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,new Error().stack)}remove(e){this._allocations.delete(e)}get information(){let e="";if(this._allocations.size>0){e+=`${this._allocations.size} live object allocations:
`;const r=new Map;this._allocations.forEach(i=>{r.set(i,(r.get(i)??0)+1)}),r.forEach((i,s)=>{const n=s.split(`
`);n.shift(),n.shift(),e+=`${i}: ${n.shift()}
`,n.forEach(o=>e+=`   ${o}
`)})}return e}};const Lbt={RECORD_ALLOCATIONS:!1};let Dbt=class{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new $bt(Lbt.RECORD_ALLOCATIONS);this._current.length<Un.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,r){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(r)}decrement(e,r){--this._current[e],this._allocations.remove(r)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,r)=>e+r,0)}get resourceInformation(){let e="";if(this.total>0){e+=`Live objects:
`;for(let r=0;r<Un.COUNT;++r){const i=this._current[r];i>0&&(e+=`${Un[r]}: ${i}
`)}}return e+=this._allocations.information,e}};const Nbt=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var Due,kq={},Fbt={get exports(){return kq},set exports(t){kq=t}};(Due=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(Fbt.exports=Due);const Ubt=kq;var Nue,zq={},Vbt={get exports(){return zq},set exports(t){zq=t}};Nue=Vbt,function(t){var e=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];e!==void 0&&(Nue.exports=e)}();const Fue=zq;var Bq={},kbt={get exports(){return Bq},set exports(t){Bq=t}};(function(t){(function(e){var r=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"]}();r!==void 0&&(t.exports=r)})()})(kbt);const zbt=Bq;var vd=999,Uue=9999,ok=0,ak=1,Vue=2,kue=3,zue=4,uL=5,Bbt=6,Gbt=7,jbt=8,Bue=9,Hbt=10,Gue=11,qbt=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function Wbt(){var t,e,r,i=0,s=0,n=vd,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,m="";return function(G){return a=[],G!==null?_(G.replace?G.replace(/\r\n/g,`
`):G):b()};function y(G){G.length&&a.push({type:qbt[n],data:G,position:h,line:l,column:c})}function _(G){var K;for(i=0,r=(m+=G).length;t=m[i],i<r;){switch(K=i,n){case ok:i=O();break;case ak:i=E();break;case Vue:i=S();break;case kue:i=R();break;case zue:i=U();break;case Gue:i=I();break;case uL:i=z();break;case Uue:i=B();break;case Bue:i=T();break;case vd:i=x()}K!==i&&(m[K]===`
`?(c=0,++l):++c)}return s+=i,m=m.slice(i),a}function b(G){return o.length&&y(o.join("")),n=Hbt,y("(eof)"),a}function x(){return o=o.length?[]:o,e==="/"&&t==="*"?(h=s+i-1,n=ok,e=t,i+1):e==="/"&&t==="/"?(h=s+i-1,n=ak,e=t,i+1):t==="#"?(n=Vue,h=s+i,i):/\s/.test(t)?(n=Bue,h=s+i,i):(p=/\d/.test(t),f=/[^\w_]/.test(t),h=s+i,n=p?zue:f?kue:Uue,i)}function T(){return/[^\s]/g.test(t)?(y(o.join("")),n=vd,i):(o.push(t),e=t,i+1)}function S(){return t!=="\r"&&t!==`
`||e==="\\"?(o.push(t),e=t,i+1):(y(o.join("")),n=vd,i)}function E(){return S()}function O(){return t==="/"&&e==="*"?(o.push(t),y(o.join("")),n=vd,i+1):(o.push(t),e=t,i+1)}function R(){if(e==="."&&/\d/.test(t))return n=uL,i;if(e==="/"&&t==="*")return n=ok,i;if(e==="/"&&t==="/")return n=ak,i;if(t==="."&&o.length){for(;L(o););return n=uL,i}if(t===";"||t===")"||t==="("){if(o.length)for(;L(o););return y(t),n=vd,i+1}var G=o.length===2&&t!=="=";if(/[\w_\d\s]/.test(t)||G){for(;L(o););return n=vd,i}return o.push(t),e=t,i+1}function L(G){for(var K,re,ee=0;;){if(K=Fue.indexOf(G.slice(0,G.length+ee).join("")),re=Fue[K],K===-1){if(ee--+G.length>0)continue;re=G.slice(0,1).join("")}return y(re),h+=re.length,(o=o.slice(re.length)).length}}function I(){return/[^a-fA-F0-9]/.test(t)?(y(o.join("")),n=vd,i):(o.push(t),e=t,i+1)}function U(){return t==="."||/[eE]/.test(t)?(o.push(t),n=uL,e=t,i+1):t==="x"&&o.length===1&&o[0]==="0"?(n=Gue,o.push(t),e=t,i+1):/[^\d]/.test(t)?(y(o.join("")),n=vd,i):(o.push(t),e=t,i+1)}function z(){return t==="f"&&(o.push(t),e=t,i+=1),/[eE]/.test(t)||t==="-"&&/[eE]/.test(e)?(o.push(t),e=t,i+1):/[^\d]/.test(t)?(y(o.join("")),n=vd,i):(o.push(t),e=t,i+1)}function B(){if(/[^\d\w_]/.test(t)){var G=o.join("");return n=Ubt.indexOf(G)>-1?jbt:zbt.indexOf(G)>-1?Gbt:Bbt,y(o.join("")),n=vd,i}return o.push(t),e=t,i+1}}function Xbt(t){var e=Wbt(),r=[];return r=(r=r.concat(e(t))).concat(e(null))}function Ybt(t){return Xbt(t)}function Zbt(t){return t.map(e=>e.type!=="eof"?e.data:"").join("")}const lk=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function Jbt(t,e="100",r="300 es"){const i=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of t)if(s.type==="preprocessor"){const n=i.exec(s.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===r)return o;if(o===e)return s.data="#version "+r,e;throw new Error("unknown glsl version: "+o)}}return t.splice(0,0,{type:"preprocessor",data:"#version "+r},{type:"whitespace",data:`
`}),null}function Kbt(t,e){for(let r=e-1;r>=0;r--){const i=t[r];if(i.type!=="whitespace"&&i.type!=="block-comment"){if(i.type!=="keyword")break;if(i.data==="attribute"||i.data==="in")return!0}}return!1}function tO(t,e,r,i){i=i||r;for(const s of t)if(s.type==="ident"&&s.data===r)return i in e?e[i]++:e[i]=0,tO(t,e,i+"_"+e[i],i);return r}function RRe(t,e,r="afterVersion"){function i(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const m=l[f];if(m.type==="preprocessor"&&(m.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++h:m.data.match(/\#endif\s*.*/)&&--h),r!=="afterVersion"&&r!=="afterPrecision"||m.type==="preprocessor"&&/^#version/.test(m.data)&&(p=Math.max(p,f)),r==="afterPrecision"&&m.type==="keyword"&&m.data==="precision"){const y=i(l,f);if(y===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,y)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<t.length&&/[^\r\n]$/.test(t[l].data);let a=s(t);o(a-1)&&t.splice(a++,0,n);for(const l of e)t.splice(a++,0,l);o(a-1)&&o(a)&&t.splice(a,0,n)}function Qbt(t,e,r,i="lowp"){RRe(t,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function ewt(t,e,r,i,s="lowp"){RRe(t,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:i.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function twt(t,e){let r,i,s=-1;for(let n=e;n<t.length;n++){const o=t[n];if(o.type==="operator"&&(o.data==="["&&(r=n),o.data==="]")){i=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return r&&i&&t.splice(r,i-r+1),s}function jue(t,e){const r=rwt();if(v(r))return r;const i=Ybt(t);if(Jbt(i,"100","300 es")==="300 es")return t;let s=null,n=null;const o={},a={};for(let l=0;l<i.length;++l){const c=i[l];switch(c.type){case"keyword":e===Tu.VERTEX_SHADER&&c.data==="attribute"?c.data="in":c.data==="varying"&&(c.data=e===Tu.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(c.data.trim())&&(c.data=c.data.replace(/(2D|Cube|EXT)/g,"")),e===Tu.FRAGMENT_SHADER&&c.data==="gl_FragColor"&&(s||(s=tO(i,o,"fragColor"),Qbt(i,s,"vec4")),c.data=s),e===Tu.FRAGMENT_SHADER&&c.data==="gl_FragData"){const h=twt(i,l+1),p=tO(i,o,"fragData");ewt(i,p,"vec4",h,"mediump"),c.data=p}else e===Tu.FRAGMENT_SHADER&&c.data==="gl_FragDepthEXT"&&(n||(n=tO(i,o,"gl_FragDepth")),c.data=n);break;case"ident":if(Nbt.includes(c.data)){if(e===Tu.VERTEX_SHADER&&Kbt(i,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");c.data in a||(a[c.data]=tO(i,o,c.data)),c.data=a[c.data]}}}for(let l=i.length-1;l>=0;--l){const c=i[l];if(c.type==="preprocessor"){const h=c.data.match(/\#extension\s+(.*)\:/);if(h&&h[1]&&lk.includes(h[1].trim())){const m=i[l+1];i.splice(l,m&&m.type==="whitespace"?2:1)}const p=c.data.match(/\#ifdef\s+(.*)/);p&&p[1]&&lk.includes(p[1].trim())&&(c.data="#if 1");const f=c.data.match(/\#ifndef\s+(.*)/);f&&f[1]&&lk.includes(f[1].trim())&&(c.data="#if 0")}}return iwt(t,Zbt(i))}function rwt(t){return null}function iwt(t,e){return e}const swt=4294967295;let nwt=class{constructor(e,r,i,s,n=new Map){this._context=e,this._locations=s,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),r.length===0&&console.error("Shaders source should not be empty!"),this._context.type===bt.WEBGL2&&(r=jue(r,Tu.VERTEX_SHADER),i=jue(i,Tu.FRAGMENT_SHADER)),this._vShader=Hue(this._context,Tu.VERTEX_SHADER,r),this._fShader=Hue(this._context,Tu.FRAGMENT_SHADER,i),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(Un.Shader,this),Dj()&&(this.vertexShader=r,this.fragmentShader=i);const o=this._context.gl,a=o.createProgram();if(o.attachShader(a,this._vShader),o.attachShader(a,this._fShader),this._locations.forEach((l,c)=>o.bindAttribLocation(a,l,c)),o.linkProgram(a),Dj()&&!o.getProgramParameter(a,o.LINK_STATUS)&&console.error(`Could not link shader
validated: ${o.getProgramParameter(a,o.VALIDATE_STATUS)}, gl error ${o.getError()}, vertex: ${o.getShaderParameter(this._vShader,o.COMPILE_STATUS)}, fragment: ${o.getShaderParameter(this._fShader,o.COMPILE_STATUS)}, info log: ${o.getProgramInfoLog(a)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===bt.WEBGL2){const l=o;for(const[c,h]of this._uniformBlockBindings){const p=l.getUniformBlockIndex(a,c);p<swt&&l.uniformBlockBinding(a,p,h)}}this._glName=a,this._context.instanceCounter.increment(Un.Program,this)}get glName(){return this._glName}get hasGLName(){return v(this._glName)}get compiled(){if(this._compiled)return!0;const e=this._context.gl.getExtension("KHR_parallel_shader_compile");return e==null||C(this.glName)?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,e.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const e=this._context.gl;this._vShader&&(e.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(Un.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(Un.Program,this))}ref(){++this._refCount}_getUniformLocation(e){return this._nameToUniformLocation[e]===void 0&&v(this.glName)&&(this._nameToUniformLocation[e]=this._context.gl.getUniformLocation(this.glName,e)),this._nameToUniformLocation[e]}hasUniform(e){return this._getUniformLocation(e)!==null}setUniform1i(e,r){const i=this._nameToUniform1[e];i!==void 0&&r===i||(this._context.gl.uniform1i(this._getUniformLocation(e),r),this._nameToUniform1[e]=r)}setUniform1iv(e,r){Qp(this._nameToUniform1v,e,r)&&this._context.gl.uniform1iv(this._getUniformLocation(e),r)}setUniform2iv(e,r){Qp(this._nameToUniform2,e,r)&&this._context.gl.uniform2iv(this._getUniformLocation(e),r)}setUniform3iv(e,r){Qp(this._nameToUniform3,e,r)&&this._context.gl.uniform3iv(this._getUniformLocation(e),r)}setUniform4iv(e,r){Qp(this._nameToUniform4,e,r)&&this._context.gl.uniform4iv(this._getUniformLocation(e),r)}setUniform1f(e,r){const i=this._nameToUniform1[e];i!==void 0&&r===i||(this._context.gl.uniform1f(this._getUniformLocation(e),r),this._nameToUniform1[e]=r)}setUniform1fv(e,r){Qp(this._nameToUniform1v,e,r)&&this._context.gl.uniform1fv(this._getUniformLocation(e),r)}setUniform2f(e,r,i){const s=this._nameToUniform2.get(e);s===void 0?(this._context.gl.uniform2f(this._getUniformLocation(e),r,i),this._nameToUniform2.set(e,[r,i])):r===s[0]&&i===s[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),r,i),s[0]=r,s[1]=i)}setUniform2fv(e,r){Qp(this._nameToUniform2,e,r)&&this._context.gl.uniform2fv(this._getUniformLocation(e),r)}setUniform3f(e,r,i,s){const n=this._nameToUniform3.get(e);n===void 0?(this._context.gl.uniform3f(this._getUniformLocation(e),r,i,s),this._nameToUniform3[e]=[r,i,s]):r===n[0]&&i===n[1]&&s===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),r,i,s),n[0]=r,n[1]=i,n[2]=s)}setUniform3fv(e,r){Qp(this._nameToUniform3,e,r)&&this._context.gl.uniform3fv(this._getUniformLocation(e),r)}setUniform4f(e,r,i,s,n){const o=this._nameToUniform4.get(e);o===void 0?(this._context.gl.uniform4f(this._getUniformLocation(e),r,i,s,n),this._nameToUniform4.set(e,[r,i,s,n])):o!==void 0&&r===o[0]&&i===o[1]&&s===o[2]&&n===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),r,i,s,n),o[0]=r,o[1]=i,o[2]=s,o[3]=n)}setUniform4fv(e,r){Qp(this._nameToUniform4,e,r)&&this._context.gl.uniform4fv(this._getUniformLocation(e),r)}setUniformMatrix3fv(e,r,i=!1){Qp(this._nameToUniformMatrix3,e,r)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(e),i,r)}setUniformMatrix4fv(e,r,i=!1){Qp(this._nameToUniformMatrix4,e,r)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(e),i,r)}stop(){}};function Hue(t,e,r){const i=t.gl,s=i.createShader(e);return i.shaderSource(s,r),i.compileShader(s),Dj()&&!i.getShaderParameter(s,i.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===Tu.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(i.getShaderInfoLog(s)),console.error(owt(r))),s}function owt(t){let e=2;return t.replace(/\n/g,()=>`
`+awt(e++)+":")}function awt(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function Qp(t,e,r){const i=t.get(e);return i?Kq(i,r):(t.set(e,Array.from(r)),!0)}let lwt=class{constructor(e){this._rctx=e,this._store=new uC}dispose(){this._store.forEach(e=>e.forEach(r=>r.dispose())),this._store.clear()}acquire(e,r,i,s){const n=this._store.get(e,r);if(v(n))return n.ref(),n;const o=new nwt(this._rctx,e,r,i,s);return o.ref(),this._store.set(e,r,o),o}get test(){let e=0;return this._store.forEach(r=>r.forEach(i=>e+=i.hasGLName?2:1)),{cachedWebGLObjects:e}}},gP=class{constructor(){this._result=!1}dispose(){this._program=et(this._program)}get result(){return v(this._program)&&(this._result=this._test(this._program),this.dispose()),this._result}},cwt=class extends gP{constructor(e){super(),this._rctx=e,this._dummyProgram=null,this._rctx.type===bt.WEBGL2&&de("mac")&&de("chrome")&&(this._program=this._prepareProgram(),this._dummyProgram=this._prepareDummyProgram())}dispose(){var e;super.dispose(),(e=this._dummyProgram)==null||e.dispose(),this._dummyProgram=null}_test(e){const r=this._rctx;r.resetState();const i=new Ns(r,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,wrapMode:Ot.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createIndex(this._rctx,$r.STATIC_DRAW,new Uint8Array([0]));r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.useProgram(this._dummyProgram),r.bindBuffer(s,Mt.ELEMENT_ARRAY_BUFFER),r.drawElements($t.POINTS,1,lt.UNSIGNED_BYTE,0),r.useProgram(e),r.bindVAO(null),r.drawArrays($t.TRIANGLES,0,258);const n=new Uint8Array(4);return i.readPixels(0,0,1,1,ze.RGBA,Lt.UNSIGNED_BYTE,n),i.dispose(),s.dispose(),n[0]===255}_prepareProgram(){const r=`
    precision highp float;

    varying float triangleId;

    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));

    void main(void) {
      triangleId = floor(float(gl_VertexID)/3.0);

      vec3 position = triangleVertices[gl_VertexID % 3];
      float offset = triangleId / ${w.float(85)};
      position.z = 0.5 - offset;

      gl_Position = vec4(position, 1.0);
    }
    `,i=`
    precision highp float;

    varying float triangleId;

    void main(void) {
      gl_FragColor = triangleId == ${w.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);
    }
    `;return this._rctx.programCache.acquire(r,i,new Map([]))}_prepareDummyProgram(){const e=`
    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,r=`
    void main(void) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`;return this._rctx.programCache.acquire(e,r,new Map([]))}},uwt=class extends gP{constructor(e){super(),this._rctx=e,this._program=que(this._rctx,!1),this._obfuscated=que(this._rctx,!0)}dispose(){super.dispose(),this._obfuscated=et(this._obfuscated)}_test(e){if(de("force-double-precision-obfuscation"))return!0;if(C(this._obfuscated))return!1;const r=this._runProgram(e),i=this._runProgram(this._obfuscated);return r!==0&&(i===0||r/i>5)}_runProgram(e){const r=this._rctx;r.resetState();const i=new Ns(r,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,wrapMode:Ot.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createVertex(r,$r.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new ed(r,new Map([["position",0]]),{geometry:[new No("position",2,lt.UNSIGNED_SHORT,0,4)]},{geometry:s}),o=$e(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),a=$e(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=new Float32Array(6);TH(o,l,3);const c=new Float32Array(6);TH(a,c,3),r.useProgram(e),e.setUniform3f("u_highA",l[0],l[2],l[4]),e.setUniform3f("u_lowA",l[1],l[3],l[5]),e.setUniform3f("u_highB",c[0],c[2],c[4]),e.setUniform3f("u_lowB",c[1],c[3],c[5]),r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays($t.TRIANGLE_STRIP,0,4);const h=new Uint8Array(4);i.readPixels(0,0,1,1,ze.RGBA,Lt.UNSIGNED_BYTE,h),n.dispose(!1),s.dispose(),i.dispose();const p=(o[2]-a[2])/25,f=$J(h);return Math.abs(p-f)}};function que(t,e){const r=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,i=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `;return t.programCache.acquire(r,i,new Map([["position",0]]))}var Wue,Xue,Gq={},hwt={get exports(){return Gq},set exports(t){Gq=t}};Wue=hwt,(Xue=function(){var t=function(_){window.console&&window.console.log&&window.console.log(_)},e=function(_){window.console&&window.console.error?window.console.error(_):t(_)},r={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,s=null;function n(_){if(i==null)for(var b in i={},s={},_)typeof _[b]=="number"&&(i[_[b]]=b,s[b]=_[b])}function o(){if(i==null)throw"WebGLDebugUtils.init(ctx) not called"}function a(_){return o(),i[_]!==void 0}function l(_){o();var b=i[_];return b!==void 0?"gl."+b:"/*UNKNOWN WebGL ENUM*/ 0x"+_.toString(16)}function c(_,b,x,T){var S;if((S=r[_])!==void 0&&(S=S[b])!==void 0&&S[x]){if(typeof S[x]=="object"&&S[x].enumBitwiseOr!==void 0){for(var E=S[x].enumBitwiseOr,O=0,R=[],L=0;L<E.length;++L){var I=s[E[L]];T&I&&(O|=I,R.push(l(I)))}return O===T?R.join(" | "):l(T)}return l(T)}return T===null?"null":T===void 0?"undefined":T.toString()}function h(_,b){for(var x="",T=b.length,S=0;S<T;++S)x+=(S==0?"":", ")+c(_,T,S,b[S]);return x}function p(_,b,x){_.__defineGetter__(x,function(){return b[x]}),_.__defineSetter__(x,function(T){b[x]=T})}function f(_,b,x,T){T=T||_,n(_),b=b||function(I,U,z){for(var B="",G=z.length,K=0;K<G;++K)B+=(K==0?"":", ")+c(U,G,K,z[K]);e("WebGL error "+l(I)+" in "+U+"("+B+")")};var S={};function E(I,U){return function(){x&&x(U,arguments);var z=I[U].apply(I,arguments),B=T.getError();return B!=0&&(S[B]=!0,b(B,U,arguments)),z}}var O={};for(var R in _)if(typeof _[R]=="function")if(R!="getExtension")O[R]=E(_,R);else{var L=E(_,R);O[R]=function(){return f(L.apply(_,arguments),b,x,T)}}else p(O,_,R);return O.getError=function(){for(var I in S)if(S.hasOwnProperty(I)&&S[I])return S[I]=!1,I;return _.NO_ERROR},O}function m(_){var b=_.getParameter(_.MAX_VERTEX_ATTRIBS),x=_.createBuffer();_.bindBuffer(_.ARRAY_BUFFER,x);for(var T=0;T<b;++T)_.disableVertexAttribArray(T),_.vertexAttribPointer(T,4,_.FLOAT,!1,0,0),_.vertexAttrib1f(T,0);_.deleteBuffer(x);var S=_.getParameter(_.MAX_TEXTURE_IMAGE_UNITS);for(T=0;T<S;++T)_.activeTexture(_.TEXTURE0+T),_.bindTexture(_.TEXTURE_CUBE_MAP,null),_.bindTexture(_.TEXTURE_2D,null);for(_.activeTexture(_.TEXTURE0),_.useProgram(null),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),_.bindFramebuffer(_.FRAMEBUFFER,null),_.bindRenderbuffer(_.RENDERBUFFER,null),_.disable(_.BLEND),_.disable(_.CULL_FACE),_.disable(_.DEPTH_TEST),_.disable(_.DITHER),_.disable(_.SCISSOR_TEST),_.blendColor(0,0,0,0),_.blendEquation(_.FUNC_ADD),_.blendFunc(_.ONE,_.ZERO),_.clearColor(0,0,0,0),_.clearDepth(1),_.clearStencil(-1),_.colorMask(!0,!0,!0,!0),_.cullFace(_.BACK),_.depthFunc(_.LESS),_.depthMask(!0),_.depthRange(0,1),_.frontFace(_.CCW),_.hint(_.GENERATE_MIPMAP_HINT,_.DONT_CARE),_.lineWidth(1),_.pixelStorei(_.PACK_ALIGNMENT,4),_.pixelStorei(_.UNPACK_ALIGNMENT,4),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_.UNPACK_COLORSPACE_CONVERSION_WEBGL&&_.pixelStorei(_.UNPACK_COLORSPACE_CONVERSION_WEBGL,_.BROWSER_DEFAULT_WEBGL),_.polygonOffset(0,0),_.sampleCoverage(1,!1),_.scissor(0,0,_.canvas.width,_.canvas.height),_.stencilFunc(_.ALWAYS,0,4294967295),_.stencilMask(4294967295),_.stencilOp(_.KEEP,_.KEEP,_.KEEP),_.viewport(0,0,_.canvas.width,_.canvas.height),_.clear(_.COLOR_BUFFER_BIT|_.DEPTH_BUFFER_BIT|_.STENCIL_BUFFER_BIT);_.getError(););}function y(_){var b,x,T=[],S=[],E={},O=1,R=!1,L=[],I=0,U=0,z=!1,B=0,G={};function K(W){return typeof W=="function"?W:function(ue){W.handleEvent(ue)}}_.getContext=(x=_.getContext,function(){var W=x.apply(_,arguments);if(W instanceof WebGLRenderingContext){if(W!=b){if(b)throw"got different context";E=J(b=W)}return E}return W});var re=function(W){T.push(K(W))},ee=function(W){S.push(K(W))};function q(W){var ue=W.addEventListener;W.addEventListener=function(pe,we,Ce){switch(pe){case"webglcontextlost":re(we);break;case"webglcontextrestored":ee(we);break;default:ue.apply(W,arguments)}}}function $(){for(var W=Object.keys(G),ue=0;ue<W.length;++ue)delete G[W]}function N(){++U,R||I==U&&_.loseContext()}function F(W,ue){var pe=W[ue];return function(){if(N(),!R)return pe.apply(W,arguments)}}function H(){for(var W=0;W<L.length;++W){var ue=L[W];ue instanceof WebGLBuffer?b.deleteBuffer(ue):ue instanceof WebGLFramebuffer?b.deleteFramebuffer(ue):ue instanceof WebGLProgram?b.deleteProgram(ue):ue instanceof WebGLRenderbuffer?b.deleteRenderbuffer(ue):ue instanceof WebGLShader?b.deleteShader(ue):ue instanceof WebGLTexture&&b.deleteTexture(ue)}}function X(W){return{statusMessage:W,preventDefault:function(){z=!0}}}return q(_),_.loseContext=function(){if(!R){for(R=!0,I=0,++O;b.getError(););$(),G[b.CONTEXT_LOST_WEBGL]=!0;var W=X("context lost"),ue=T.slice();setTimeout(function(){for(var pe=0;pe<ue.length;++pe)ue[pe](W);B>=0&&setTimeout(function(){_.restoreContext()},B)},0)}},_.restoreContext=function(){R&&S.length&&setTimeout(function(){if(!z)throw"can not restore. webglcontestlost listener did not call event.preventDefault";H(),m(b),R=!1,U=0,z=!1;for(var W=S.slice(),ue=X("context restored"),pe=0;pe<W.length;++pe)W[pe](ue)},0)},_.loseContextInNCalls=function(W){if(R)throw"You can not ask a lost contet to be lost";I=U+W},_.getNumCalls=function(){return U},_.setRestoreTimeout=function(W){B=W},_;function J(W){for(var ue in W)typeof W[ue]=="function"?E[ue]=F(W,ue):p(E,W,ue);E.getError=function(){if(N(),!R)for(;xe=b.getError();)G[xe]=!0;for(var xe in G)if(G[xe])return delete G[xe],xe;return E.NO_ERROR};for(var pe=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],we=0;we<pe.length;++we){var Ce=pe[we];E[Ce]=function(xe){return function(){if(N(),R)return null;var Ne=xe.apply(W,arguments);return Ne.__webglDebugContextLostId__=O,L.push(Ne),Ne}}(W[Ce])}var je=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(we=0;we<je.length;++we)Ce=je[we],E[Ce]=function(xe){return function(){return N(),R?null:xe.apply(W,arguments)}}(E[Ce]);var De=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(we=0;we<De.length;++we)Ce=De[we],E[Ce]=function(xe){return function(){return N(),!R&&xe.apply(W,arguments)}}(E[Ce]);return E.checkFramebufferStatus=function(xe){return function(){return N(),R?E.FRAMEBUFFER_UNSUPPORTED:xe.apply(W,arguments)}}(E.checkFramebufferStatus),E.getAttribLocation=function(xe){return function(){return N(),R?-1:xe.apply(W,arguments)}}(E.getAttribLocation),E.getVertexAttribOffset=function(xe){return function(){return N(),R?0:xe.apply(W,arguments)}}(E.getVertexAttribOffset),E.isContextLost=function(){return R},E}}return{init:n,mightBeEnum:a,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:f,makeLostContextSimulatingCanvas:y,resetToInitialState:m}}())!==void 0&&(Wue.exports=Xue);let dwt=class extends gP{constructor(e){var s,n,o,a,l;if(super(),this._rctx=e,!e.gl)return;if(e.type===bt.WEBGL1)return void(this._result=!(!((s=e.capabilities.textureFloat)!=null&&s.textureFloat)||!((n=e.capabilities.colorBufferFloat)!=null&&n.textureFloat)));if(!((o=e.capabilities.textureFloat)!=null&&o.textureFloat&&((a=e.capabilities.colorBufferFloat)!=null&&a.textureFloat)&&((l=e.capabilities.colorBufferFloat)!=null&&l.floatBlend)))return;const r=`
    precision highp float;
    attribute vec2 a_pos;

    void main() {
      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
     precision highp float;

     void main() {
      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
     }
    `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}_test(e){const r=this._rctx,i=new Ns(r,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,wrapMode:Ot.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:Lt.FLOAT,internalFormat:Et.RGBA32F,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createVertex(r,$r.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new ed(r,new Map([["a_pos",0]]),{geometry:[new No("a_pos",2,lt.UNSIGNED_SHORT,0,4)]},{geometry:s});r.useProgram(e);const o=r.getBoundFramebufferObject(),{x:a,y:l,width:c,height:h}=r.getViewport();r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays($t.TRIANGLE_STRIP,0,4);const p=zt({blending:o2e});r.setPipelineState(p),r.drawArrays($t.TRIANGLE_STRIP,0,4),Gq.init(r);const f=r.gl.getError();return r.setViewport(a,l,c,h),r.bindFramebuffer(o),n.dispose(!1),s.dispose(),i.dispose(),f!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}},pwt=class extends gP{constructor(e){super(),this._rctx=e;const r=`
      precision highp float;
      attribute vec2 a_pos;
      uniform highp sampler2D u_texture;
      varying vec4 v_color;

      float getBit(in float bitset, in int bitIndex) {
        float offset = pow(2.0, float(bitIndex));
        return mod(floor(bitset / offset), 2.0);
      }

      void main() {
        vec4 value = texture2D(u_texture, vec2(0.0));
        float bit = getBit(value.x * 255.0, 1);

        v_color = bit * vec4(1.0);
        gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
      }
      `,i=`
      precision highp float;
      varying vec4 v_color;

      void main() {
        gl_FragColor = v_color;
      }
      `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}_test(e){const r=this._rctx,i=new Ns(r,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,wrapMode:Ot.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=new Uint8Array(4),n=jr.createVertex(r,$r.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new ed(r,new Map([["a_position",0]]),{geometry:[new No("a_position",2,lt.SHORT,0,4)]},{geometry:n});r.useProgram(e);const a=new ct(r,{target:wt.TEXTURE_2D,wrapMode:Ot.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));e.setUniform1i("u_texture",0),r.bindTexture(a,0);const l=r.getBoundFramebufferObject();r.bindFramebuffer(i),r.useProgram(e);const{x:c,y:h,width:p,height:f}=r.getViewport();r.setViewport(0,0,1,1),r.bindVAO(o),r.drawArrays($t.TRIANGLE_STRIP,0,4),r.setViewport(c,h,p,f),i.readPixels(0,0,1,1,ze.RGBA,Lt.UNSIGNED_BYTE,s),o.dispose(!1),n.dispose(),i.dispose();const m=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return m&&se.getLogger("esri.views.webgl.testSamplerPrecision").warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),r.bindFramebuffer(l),m}};new No("a_pos",2,lt.BYTE,0,2);new No("a_pos",2,lt.BYTE,0,4),new No("a_tex",2,lt.BYTE,2,4);const fwt={geometry:[new No("a_pos",2,lt.UNSIGNED_SHORT,0,4)]};let mwt=class extends gP{constructor(e){super(),this._rctx=e,this._image=new Image,this._image.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",this._image.width=5,this._image.height=5,this._image.decode();const r=`
    precision highp float;

    attribute vec2 a_pos;
    varying vec2 v_uv;

    void main() {
      v_uv = a_pos;
      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
    precision highp float;

    varying vec2 v_uv;
    uniform sampler2D u_texture;

    void main() {
      gl_FragColor = texture2D(u_texture, v_uv);
    }
    `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}dispose(){super.dispose(),this._image.src=""}_test(e){const r=this._rctx;if(!r.gl)return e.dispose(),!0;const i=new Ns(r,{colorTarget:us.TEXTURE,depthStencilTarget:Ir.NONE},{target:wt.TEXTURE_2D,wrapMode:Ot.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,samplingMode:tt.NEAREST,width:1,height:1}),s=jr.createVertex(r,$r.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new ed(r,new Map([["a_pos",0]]),fwt,{geometry:s}),o=new ct(r,{dataType:Lt.UNSIGNED_BYTE,pixelFormat:ze.RGBA,preMultiplyAlpha:!1,wrapMode:Ot.CLAMP_TO_EDGE,samplingMode:tt.LINEAR},this._image);r.useProgram(e),r.bindTexture(o,0),e.setUniform1i("u_texture",0);const a=r.getBoundFramebufferObject(),{x:l,y:c,width:h,height:p}=r.getViewport();r.bindFramebuffer(i),r.setViewport(0,0,1,1),r.setClearColor(0,0,0,0),r.setBlendingEnabled(!1),r.clearSafe(Fi.COLOR_BUFFER_BIT),r.bindVAO(n),r.drawArrays($t.TRIANGLE_STRIP,0,4);const f=new Uint8Array(4);return i.readPixels(0,0,1,1,ze.RGBA,Lt.UNSIGNED_BYTE,f),n.dispose(!1),s.dispose(),i.dispose(),o.dispose(),r.setViewport(l,c,h,p),r.bindFramebuffer(a),f[0]!==255}},gwt=class{constructor(e){this.rctx=e,this.floatBufferBlend=new dwt(e),this.svgPremultipliesAlpha=new mwt(e),this.doublePrecisionRequiresObfuscation=new uwt(e),this.ignoresSamplerPrecision=new pwt(e),this.drawArraysRequiresIndicesTypeReset=new cwt(e)}dispose(){this.ignoresSamplerPrecision.dispose(),this.doublePrecisionRequiresObfuscation.dispose(),this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}};function ywt(t,e){if(e.disjointTimerQuery)return null;if(Pm(t))return{drawBuffers:t.drawBuffers.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const r=t.getExtension("WEBGL_draw_buffers");return r?{drawBuffers:r.drawBuffersWEBGL.bind(r),MAX_DRAW_BUFFERS:r.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:r.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function _wt(t){if(Pm(t))return t;const e=t.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}function vwt(t,e){if(e.compressedTextureETC)return null;const r=t.getExtension("WEBGL_compressed_texture_etc");return r?{COMPRESSED_R11_EAC:r.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:r.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:r.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:r.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:r.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:r.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function bwt(t,e){if(e.compressedTextureS3TC)return null;const r=t.getExtension("WEBGL_compressed_texture_s3tc");return r?{COMPRESSED_RGB_S3TC_DXT1:r.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:r.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:r.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:r.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function wwt(t,e){if(Pm(t))return{MIN:t.MIN,MAX:t.MAX};if(e.blendMinMax)return null;{const r=t.getExtension("EXT_blend_minmax");return r?{MIN:r.MIN_EXT,MAX:r.MAX_EXT}:null}}function xwt(t,e){if(e.textureFilterAnisotropic)return null;const r=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return r?{MAX_TEXTURE_MAX_ANISOTROPY:r.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:r.TEXTURE_MAX_ANISOTROPY_EXT}:null}function Twt(t,e){if(Pm(t))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!0,HALF_FLOAT:t.HALF_FLOAT,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F};if(t instanceof WebGLRenderingContext){const r=!e.textureHalfFloat&&t.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!t.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!!r,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!t.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:r?r.HALF_FLOAT_OES:void 0}}return null}function Swt(t,e){if(Pm(t)){const r=!e.colorBufferHalfFloat&&t.getExtension("EXT_color_buffer_half_float")||!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),i=!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F}:null}if(t instanceof WebGLRenderingContext){const r=!e.colorBufferHalfFloat&&t.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&t.getExtension("WEBGL_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,RGBA16F:r?r.RGBA16F_EXT:void 0,RGB16F:r?r.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}function CA(t,e,r,i,s){if(i&&Pm(t))return!0;if(e[r])return!1;for(const n of s)if(t.getExtension(n))return!0;return!1}function Ewt(t,e){if(!Pm(t)||e.textureNorm16)return null;const r=t.getExtension("EXT_texture_norm16");return r?{R16:r.R16_EXT,RG16:r.RG16_EXT,RGB16:r.RGB16_EXT,RGBA16:r.RGBA16_EXT,R16_SNORM:r.R16_SNORM_EXT,RG16_SNORM:r.RG16_SNORM_EXT,RGB16_SNORM:r.RGB16_SNORM_EXT,RGBA16_SNORM:r.RGBA16_SNORM_EXT}:null}function Cwt(t,e){const r=e.loseContext&&t.getExtension("WEBGL_lose_context");return r?{loseRenderingContext:()=>r.loseContext()}:null}function Awt(t,e){if(Pm(t))return{createVertexArray:t.createVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t)};if(e.vao)return null;const r=t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object");return r?{createVertexArray:r.createVertexArrayOES.bind(r),deleteVertexArray:r.deleteVertexArrayOES.bind(r),bindVertexArray:r.bindVertexArrayOES.bind(r)}:null}let Rwt=class{constructor(e,r){this._gl=e,this._instancing=null,this._vertexArrayObject=null,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._textureFloat=null,this._colorBufferFloat=null,this._minMaxBlending=null,this._loseContext=null,this._drawBuffers=null,this._textureNorm16=null,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._textureFloatLinear=null,this._disabledExtensions=r.disabledExtensions||{},this._debugWebGLExtensions=r.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=ywt(this._gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=_wt(this._gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=Awt(this._gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=vwt(this._gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=bwt(this._gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=xwt(this._gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=Obt(this._gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=Twt(this._gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=Swt(this._gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=wwt(this._gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=CA(this._gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=CA(this._gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=CA(this._gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=CA(this._gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=Cwt(this._gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=Ewt(this._gl,this._disabledExtensions)),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear===null&&(this._textureFloatLinear=CA(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"])),this._textureFloatLinear}enable(e){return this[e]}},Owt=class{constructor(e,r){this.gl=e,this.instanceCounter=new Dbt,this.programCache=new lwt(this),this._state=new Lue,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=Pm(e)?bt.WEBGL2:bt.WEBGL1,this._loadExtensions(),this.configure(r)}get gl2(){return this.type===bt.WEBGL1?null:this.gl}configure(e){this._capabilities=new Rwt(this.gl,e),this._parameters=this._loadParameters(e);const r=this.gl.getParameter(this.gl.VIEWPORT);this._state=new Lue,this._state.viewport={x:r[0],y:r[1],width:r[2],height:r[3]},this._stateTracker=new tKe({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const s=i.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const s=i.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=i.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{i?this.setStencilWriteMask(i.mask):this.setStencilWriteMask(0)}}),this.enforceState(),et(this._driverTest),this._driverTest=new gwt(this)}dispose(){et(this._driverTest),this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(Mt.ARRAY_BUFFER),this.unbindBuffer(Mt.ELEMENT_ARRAY_BUFFER),this.type===bt.WEBGL2&&(this.unbindBuffer(Mt.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(Mt.PIXEL_PACK_BUFFER),this.unbindBuffer(Mt.PIXEL_UNPACK_BUFFER),this.unbindBuffer(Mt.COPY_READ_BUFFER),this.unbindBuffer(Mt.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,yu()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var e;(e=this._state.program)==null||e.stop(),this._state.program=null}externalTextureUnitUpdate(e,r){for(let i=0;i<e.length;++i)this._state.textureUnitMap[e[i]]=null;r>=0&&(this._state.activeTexture=r)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,r,i,s){e===this._state.blendColor.r&&r===this._state.blendColor.g&&i===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(e,r,i,s),this._state.blendColor.r=e,this._state.blendColor.g=r,this._state.blendColor.b=i,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(e,r){e===this._state.blendFunction.srcRGB&&r===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=r,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,r,i,s){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===r&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(e,r,i,s),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=r,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,r){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===r||(this.gl.blendEquationSeparate(e,r),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=r,this._stateTracker.invalidateBlending())}setColorMask(e,r,i,s){this._state.colorMask.r===e&&this._state.colorMask.g===r&&this._state.colorMask.b===i&&this._state.colorMask.a===s||(this.gl.colorMask(e,r,i,s),this._state.colorMask.r=e,this._state.colorMask.g=r,this._state.colorMask.b=i,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(e,r,i,s){this._state.clearColor.r===e&&this._state.clearColor.g===r&&this._state.clearColor.b===i&&this._state.clearColor.a===s||(this.gl.clearColor(e,r,i,s),this._state.clearColor.r=e,this._state.clearColor.g=r,this._state.clearColor.b=i,this._state.clearColor.a=s)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,r){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===r||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=r,this.gl.polygonOffset(e,r),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,r,i,s){this._state.scissorRect.x===e&&this._state.scissorRect.y===r&&this._state.scissorRect.width===i&&this._state.scissorRect.height===s||(this.gl.scissor(e,r,i,s),this._state.scissorRect.x=e,this._state.scissorRect.y=r,this._state.scissorRect.width=i,this._state.scissorRect.height=s)}setDepthTestEnabled(e){this._state.depthTest!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,r){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===r||(this.gl.depthRange(e,r),this._state.depthRange.zNear=e,this._state.depthRange.zFar=r,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,r,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,r,i),this._state.stencilFunction.face=lp.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,r,i,s){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===r&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(e,r,i,s),this._state.stencilFunction.face=e,this._state.stencilFunction.func=r,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,r,i){this._state.stencilOperation.face===lp.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,r,i),this._state.stencilOperation.face=lp.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,r,i,s){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===r&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(e,r,i,s),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=r,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,r=!1){const i=this._state.activeTexture;return e>=0&&(r||e!==this._state.activeTexture)&&(this.gl.activeTexture(Y8+e),this._state.activeTexture=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,r=255){e&&(e&Fi.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),e&Fi.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),e&Fi.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(r),this.gl.clear(e))}drawArrays(e,r,i){if(yu()&&(this._numOfDrawCalls++,this._numOfTriangles+=Yue(e,i)),this.gl.drawArrays(e,r,i),yu()){const s=Bse(this);s&&console.error("drawArrays:",s)}}drawElements(e,r,i,s){if(yu()&&(this._numOfDrawCalls++,this._numOfTriangles+=Yue(e,r)),this.gl.drawElements(e,r,i,s),yu()){const n=Bse(this);if(n){const o=this.getBoundVAO(),a=o==null?void 0:o.indexBuffer,l=o==null?void 0:o.vertexBuffers,c={indexBuffer:a,vertexBuffers:l},h={mode:e,count:r,type:i,offset:s},p=ao(a,y=>y.size)??0,f=s+r,m=p<f?`. Buffer is too small. Attempted to draw index ${f} of ${p}`:"";console.error(`drawElements: ${n}${m}`,{args:h,vao:c})}}}logInfo(){yu()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){yu()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,r,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===e&&n.y===r&&n.width===i&&n.height===s||(n.x=e,n.y=r,n.width=i,n.height=s,this.gl.viewport(e,r,i,s))}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){var r;this._state.program!==e&&((r=this._state.program)==null||r.stop(),this._state.program=e,this.gl.useProgram((e==null?void 0:e.glName)??null))}bindTexture(e,r,i=!1){(r>=this.parameters.maxTextureImageUnits||r<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[r];return C(e)||e.glName==null?(v(s)&&(this.setActiveTexture(r,i),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[r]=null,s):i||s!==e?(this.setActiveTexture(r,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[r]=e,s):(e.isDirty&&(this.setActiveTexture(r,i),e.applyChanges()),s)}unbindTexture(e){if(!C(e))for(let r=0;r<this.parameters.maxTextureImageUnits;r++)this._state.textureUnitMap[r]===e&&(this.bindTexture(null,r),this._state.textureUnitMap[r]=null)}bindFramebuffer(e,r=!1){if(r||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(C(e))return this.gl.bindFramebuffer(Qn.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);e.initializeAndBind(Qn.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,r,i=!1){const s=r===Qn.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(i||n!==e)&&(C(e)?this.gl.bindFramebuffer(r,null):e.initializeAndBind(r),s?this._state.readFramebuffer=It(e,null):this._state.drawFramebuffer=It(e,null))}blitFramebuffer(e,r,i=0,s=0,n=e.width,o=e.height,a=0,l=0,c=r.width,h=r.height,p=Fi.COLOR_BUFFER_BIT,f=tt.NEAREST){this.bindFramebufferSeparate(e,Qn.READ_FRAMEBUFFER),this.bindFramebufferSeparate(r,Qn.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(i,s,n,o,a,l,c,h,p,f)}bindBuffer(e,r){if(e)switch(r??(r=e.bufferType),r){case Mt.ARRAY_BUFFER:this._state.vertexBuffer=rc(this.gl,e,r,this._state.vertexBuffer);break;case Mt.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=rc(this.gl,e,r,this._state.indexBuffer);break;case Mt.UNIFORM_BUFFER:this._state.uniformBuffer=rc(this.gl,e,r,this._state.uniformBuffer);break;case Mt.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=rc(this.gl,e,r,this._state.pixelPackBuffer);break;case Mt.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=rc(this.gl,e,r,this._state.pixelUnpackBuffer);break;case Mt.COPY_READ_BUFFER:this._state.copyReadBuffer=rc(this.gl,e,r,this._state.copyReadBuffer);break;case Mt.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=rc(this.gl,e,r,this._state.copyWriteBuffer)}}bindRenderbuffer(e){const r=this.gl;e||(r.bindRenderbuffer(r.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(r.bindRenderbuffer(r.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,r){if(r>=this.parameters.maxUniformBufferBindings||r<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=this._state.uniformBufferBindingPoints;let s=i[r];return C(s)&&(s={buffer:null,offset:0,size:0},i[r]=s),s}bindBufferBase(e,r,i){const s=this._getBufferBinding(e,r);C(s)||s.buffer===i&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(e,r,i?i.glName:null),s.buffer=i,s.offset=0,s.size=0)}bindBufferRange(e,r,i,s,n){const o=this._getBufferBinding(e,r);if(!C(o)&&!(o.buffer===i&&o.offset===s&&o.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(e,r,i.glName,s,n),o.buffer=i,o.offset=s,o.size=n}}bindUBO(e,r,i,s){C(r)?this.bindBufferBase(Mt.UNIFORM_BUFFER,e,null):(yu()&&(s??r.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),r.initialize(),i!==void 0&&s!==void 0?this.bindBufferRange(Mt.UNIFORM_BUFFER,e,r.buffer,i,s):this.bindBufferBase(Mt.UNIFORM_BUFFER,e,r.buffer))}unbindUBO(e){for(let r=0,i=this._state.uniformBufferBindingPoints.length;r<i;r++){const s=this._state.uniformBufferBindingPoints[r];v(s)&&s.buffer===e.buffer&&this.bindBufferBase(Mt.UNIFORM_BUFFER,r,null)}}unbindBuffer(e){switch(e){case Mt.ARRAY_BUFFER:this._state.vertexBuffer=rc(this.gl,null,e,this._state.vertexBuffer);break;case Mt.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=rc(this.gl,null,e,this._state.indexBuffer);break;case Mt.UNIFORM_BUFFER:this._state.uniformBuffer=rc(this.gl,null,e,this._state.uniformBuffer);break;case Mt.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=rc(this.gl,null,e,this._state.pixelPackBuffer);break;case Mt.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=rc(this.gl,null,e,this._state.pixelUnpackBuffer);break;case Mt.COPY_READ_BUFFER:this._state.copyReadBuffer=rc(this.gl,null,e,this._state.copyReadBuffer);break;case Mt.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=rc(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){C(e)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e)}async clientWaitAsync(e=10){const r=this.gl,i=r.fenceSync(Lj.SYNC_GPU_COMMANDS_COMPLETE,0);if(!i)throw new Error("Client wait failed, could not create sync object");let s;this.instanceCounter.increment(Un.Sync,i),r.flush();do await _w(e),s=r.clientWaitSync(i,0,0);while(s===WF.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(Un.Sync,i),r.deleteSync(i),s===WF.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=Qn.FRAMEBUFFER){return e===Qn.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(Mt.ARRAY_BUFFER),this.unbindBuffer(Mt.ELEMENT_ARRAY_BUFFER),this.type===bt.WEBGL2&&(this.unbindBuffer(Mt.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(Mt.PIXEL_PACK_BUFFER),this.unbindBuffer(Mt.PIXEL_UNPACK_BUFFER),this.unbindBuffer(Mt.COPY_READ_BUFFER),this.unbindBuffer(Mt.COPY_WRITE_BUFFER));for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(Ee.ONE,Ee.ZERO),this.setBlendEquation(gm.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(lp.BACK),this.setFrontFace(SE.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction($i.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction($i.ALWAYS,0,0),this.setStencilOp(Ds.KEEP,Ds.KEEP,Ds.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var n,o,a;const e=this.capabilities.vao;e&&e.bindVertexArray(null);const{gl:r,gl2:i}=this;for(let l=0;l<this.parameters.maxVertexAttributes;l++)r.disableVertexAttribArray(l);if(this._state.vertexBuffer?r.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):r.bindBuffer(Mt.ARRAY_BUFFER,null),this._state.indexBuffer?r.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):r.bindBuffer(Mt.ELEMENT_ARRAY_BUFFER,null),v(i)){this._state.uniformBuffer?i.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):i.bindBuffer(Mt.UNIFORM_BUFFER,null);for(let l=0;l<this._parameters.maxUniformBufferBindings;l++){const c=this._state.uniformBufferBindingPoints[l];if(v(c)){const{buffer:h,offset:p,size:f}=c;h!==null?p===0&&f===0?i.bindBufferBase(Mt.UNIFORM_BUFFER,l,h.glName):i.bindBufferRange(Mt.UNIFORM_BUFFER,l,h.glName,p,f):i.bindBufferBase(Mt.UNIFORM_BUFFER,l,null)}}this._state.pixelPackBuffer?i.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):i.bindBuffer(Mt.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?i.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):i.bindBuffer(Mt.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?i.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):i.bindBuffer(Mt.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?i.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):i.bindBuffer(Mt.COPY_WRITE_BUFFER,null),i.bindFramebuffer(Qn.READ_FRAMEBUFFER,null),i.readBuffer(i.BACK),this._state.readFramebuffer&&(i.bindFramebuffer(Qn.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),i.readBuffer(pu.COLOR_ATTACHMENT0)),i.bindFramebuffer(Qn.DRAW_FRAMEBUFFER,((n=this._state.drawFramebuffer)==null?void 0:n.glName)??null)}else this._state.readFramebuffer=this._state.drawFramebuffer,r.bindFramebuffer(Qn.FRAMEBUFFER,((o=this._state.drawFramebuffer)==null?void 0:o.glName)??null);if(e&&this._state.vertexArrayObject){const l=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(l)}r.useProgram(((a=this._state.program)==null?void 0:a.glName)??null),r.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),r.bindRenderbuffer(r.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),r.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),r.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),r.clearDepth(this._state.clearDepth),r.clearStencil(this._state.clearStencil),r.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),r.cullFace(this._state.cullFace),r.depthFunc(this._state.depthFunction),r.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._state.depthWrite),r.frontFace(this._state.frontFace),r.lineWidth(1),this._state.faceCulling===!0?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),r.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._state.stencilWriteMask);for(let l=0;l<this.parameters.maxTextureImageUnits;l++){r.activeTexture(Y8+l),r.bindTexture(wt.TEXTURE_2D,null),r.bindTexture(wt.TEXTURE_CUBE_MAP,null),this.type===bt.WEBGL2&&(r.bindTexture(wt.TEXTURE_3D,null),r.bindTexture(wt.TEXTURE_2D_ARRAY,null));const c=this._state.textureUnitMap[l];v(c)&&r.bindTexture(c.descriptor.target,c.glName)}r.activeTexture(Y8+this._state.activeTexture);const s=this._state.viewport;r.viewport(s.x,s.y,s.width,s.height),this.resetInfo()}_loadExtensions(){this.type===bt.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(e){const r=this.capabilities.textureFilterAnisotropic,i=e.maxAnisotropy??1/0,s=this.type===bt.WEBGL2,n=this.gl,o={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:r?Math.min(this.gl.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY),i):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:s?n.getParameter(n.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:s?n.getParameter(n.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:s?n.getParameter(n.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:s?n.getParameter(n.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:s?n.getParameter(n.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:s?n.getParameter(n.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:s?n.getParameter(n.MAX_SAMPLES):1};return ct.TEXTURE_UNIT_FOR_UPDATES=o.maxTextureImageUnits-1,o}};function rc(t,e,r,i){return e?i!==e&&t.bindBuffer(r,e.glName):t.bindBuffer(r,null),e}function Yue(t,e){switch(t){case $t.POINTS:return 2*e;case $t.TRIANGLES:return e/3;case $t.TRIANGLE_STRIP:case $t.TRIANGLE_FAN:return e-2;default:return 0}}let Mwt=class extends Owt{constructor(e,r,i){super(e,r),this.newCache=i,this._refCount=1}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}bindTechnique(e,r,i,s){return this.useProgram(e.program),e.bindPipelineState(this,i==null?void 0:i.slot,!!s),e.program.bindPass(r,i),e.program}get test(){return this.programCache.test}},R2=class extends Te{constructor(e,r,i){super({}),this._stage=e,this._techniqueRepository=r,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Fs,this._frameTask=e.view.resourceController.scheduler.registerTask(yt.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType($s.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return C(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(aK,new lK)),this._textureTechnique}acquire(e){const r=this._textures.get(e);return r?(r.ref(),It(r.loadingPromise,r)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(r=>{const i=r.texture.frameUpdate(this._rctx,this.textureTechnique,r.previousToken);i>=0&&i!==r.previousToken&&(r.previousToken=i,e=!0)}),e&&this.events.emit("changed",Ps.BACKGROUND)}_createNewRef(e){const r=this._stage.getObject(e);if(C(r))return gt(r!==void 0),null;const i=r.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),s=new Pwt(e,()=>{this._frameTask.schedule(()=>{s.isUnreferenced&&r.unload()})});return this._textures.set(e,s),s.ref(),v(r.glTexture)?(this._updateGLTexture(s,r.glTexture),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),s):(this._loadingCount++,s.loadingPromise=this._stage.schedule(()=>{const n=r.load(this._rctx,()=>this.textureTechnique),o=l=>(this._loadingCount--,s.loadingPromise=null,this._updateGLTexture(s,l),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),s),a=l=>(this._loadingCount--,s.loadingPromise=null,Ks(l)||se.getLogger(this.declaredClass).error(l),null);return Gu(n)?n.then(o,a):o(n)}),s.loadingPromise)}_updateGLTexture(e,r){e.glTexture=r,this.events.emit("changed",Ps.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],R2.prototype,"_loadingCount",void 0),u([d()],R2.prototype,"_frameTask",void 0),u([d()],R2.prototype,"updating",null),R2=u([P("esri.views.3d.webgl-engine.lib.TextureRepository")],R2);class Pwt{constructor(e,r){this.id=e,this._release=r,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(se.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}let rO=class extends Te{constructor(){super(...arguments),this._passParameters=new Iwt,this._loading=0}get passParameters(){return this._passParameters}destroy(){this._passParameters.waveNormal=et(this._passParameters.waveNormal),this._passParameters.wavePertubation=et(this._passParameters.wavePertubation)}get updating(){return this._loading>0}ensureResources(e){if(this._loading>0)return Xg.LOADING;if(v(this._passParameters.waveNormal)&&v(this._passParameters.wavePertubation))return Xg.LOADED;const r={target:wt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:Lt.UNSIGNED_BYTE,wrapMode:Ot.REPEAT,samplingMode:tt.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8};return++this._loading,dy(Kr("esri/images/materials/water/normals.jpg")).then(i=>this._passParameters.waveNormal=new ct(e,{...r,width:i.width,height:i.height},i)).catch(i=>se.getLogger(this.declaredClass).error("Failed to load water material normal texture.",i)).finally(()=>--this._loading),++this._loading,dy(Kr("esri/images/materials/water/perturbation.jpg")).then(i=>this._passParameters.wavePertubation=new ct(e,{...r,width:i.width,height:i.height},i)).catch(i=>se.getLogger(this.declaredClass).error("Failed to load water material pertubation texture.",i)).finally(()=>--this._loading),Xg.LOADING}};u([d()],rO.prototype,"_loading",void 0),u([d({type:Boolean,readOnly:!0})],rO.prototype,"updating",null),rO=u([P("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],rO);let Iwt=class extends pi{};const Zue=2048,$wt=1.5,Lwt=8;function Dwt(t,e){const{format:r,quality:i,rotation:s,disableDecorations:n}=t||{},o=GK(t,e.padding),a=Bwt(t,{width:e.width-o.left-o.right,height:e.height-o.top-o.bottom}),{width:l,height:c}=zwt(t,a),h=Hwt(r),p=Zwt[h];return{format:h,quality:ye(i??p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!t||!t.ignoreBackground),ignorePadding:!(!t||!t.ignorePadding)}}function Nwt(t,e){const r=Dwt(t,e),i=r.area,s=r.width/i.width,n=GK(r,e.padding),o=n.left+n.right,a=n.top+n.bottom,l=e.width-o,c=e.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=t&&t.layers?t.layers:[],m=r.ignoreBackground,y=r.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(i.x*s)+n.left,y:Math.floor(i.y*s)+n.top,width:r.width,height:r.height},format:r.format,quality:r.quality,rotation:r.rotation,pixelRatio:s,layers:f,disableDecorations:r.disableDecorations,ignoreBackground:m,ignorePadding:y,objectAndLayerIdColor:!1}}function ck(t,e,r){const{ctx:i,canvas:s}=ORe(t,r),n=i.getImageData(0,0,t.width,t.height),o=Uwt(s,e);return MRe(s),{dataUrl:o,data:n}}function uk(t,e){const{ctx:r,canvas:i}=ORe(t,e),s=r.getImageData(0,0,t.width,t.height);return MRe(i),s}function ORe(t,e){const r=Fwt();e.premultipliedAlpha&&Wwt(t),r.width=t.width,r.height=t.height;const i=r.getContext("2d",{willReadFrequently:!0});return i.putImageData(t,0,0),e.flipY&&qwt(i),{ctx:i,canvas:r}}function MRe(t){t.width=0,t.height=0}function Fwt(){return C(hk)&&(hk=document.createElement("canvas")),hk}let hk=null;function Uwt(t,e){const r=Xwt[e.format],i=e.quality/100;return t.toDataURL(r,i)}function Vwt(t,e,r,i=0,s=0,n=t.width-i,o=t.height-s,a=!1){const{data:l}=t,{width:c,height:h,data:p}=e,f=n/c,m=o/h,y=Math.ceil(f/2),_=Math.ceil(m/2),b=t.width;for(let x=0;x<h;x++)for(let T=0;T<c;T++){const S=4*(T+(a?h-x-1:x)*c);let E=0,O=0,R=0,L=0,I=0,U=0;const z=(x+.5)*m;for(let B=Math.floor(x*m);B<(x+1)*m;B++){const G=Math.abs(z-(B+.5))/_,K=(T+.5)*f,re=G*G;for(let ee=Math.floor(T*f);ee<(T+1)*f;ee++){const q=Math.abs(K-(ee+.5))/y,$=Math.sqrt(re+q*q);if($>=1)continue;let N=2*$*$*$-3*$*$+1;const F=4*(i+ee+(s+B)*b);U+=N*l[F+3],O+=N,!r&&l[F+3]<255&&(N=N*l[F+3]/255),R+=N*l[F],L+=N*l[F+1],I+=N*l[F+2],E+=N}}p[S]=R/E,p[S+1]=L/E,p[S+2]=I/E,p[S+3]=U/O}return e}function kwt(t,e,r){if(!e)return t;const{framebufferWidth:i,framebufferHeight:s,pixelRatio:n,region:o}=t,a=GK(t,r),l=a.left+a.right,c=a.top+a.bottom,h=i-l,p=s-c,f=Math.min(Lwt,Math.min((Zue-l)/h,(Zue-c)/p));return f<$wt?t:{...t,framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:i,height:s}}}function zwt(t,e){if(!t)return e;const r=t.width,i=t.height;if(r!=null&&i!=null)return{width:Math.floor(r),height:Math.floor(i)};if(r==null&&i==null)return e;const s=e.width/e.height;return i==null?{width:Math.floor(r),height:Math.floor(r/s)}:{width:Math.floor(i*s),height:Math.floor(i)}}function Bwt(t,e){const r={x:0,y:0,width:e.width,height:e.height};if(t&&t.area){t.area.x!=null&&(r.x=Math.floor(t.area.x)),t.area.y!=null&&(r.y=Math.floor(t.area.y));const i=t.area.width!=null?Math.floor(t.area.width):null,s=t.area.height!=null?Math.floor(t.area.height):null;if(r.width=e.width-r.x,r.height=e.height-r.y,i!=null&&s!=null)r.width=Math.min(r.width,i),r.height=Math.min(r.height,s);else if(i==null&&s!=null){const n=Math.min(r.width,i);r.height=n/r.width*r.height,r.width=n}else if(i!=null&&s==null){const n=Math.min(r.height,s);r.width=n/r.height*r.width,r.height=n}}return Gwt(jwt(r,t),e)}function Gwt(t,e){const r=Math.floor(Math.max(t.x,0)),i=Math.floor(Math.max(t.y,0)),s={x:r,y:i,width:Math.floor(Math.min(t.width,e.width-r)),height:Math.floor(Math.min(t.height,e.height-i))},n=s.width/s.height,o=t.width/t.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function jwt(t,e){if(!e||e.width==null||e.height==null)return t;const r=e.width/e.height,i=t.width/t.height;if(i===r)return t;if(i<r){const n=Math.floor(t.height*r);return t.x-=(n-t.width)/2,t.width=n,t}const s=Math.floor(t.width/r);return t.y-=(s-t.height)/2,t.height=s,t}function GK(t,e){return!e||t&&t.ignorePadding?Jwt:e}function Hwt(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return Ywt}}function qwt(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function Wwt(t){const e=t.data,r=e.length;for(let i=0;i<r;i+=4){const s=e[i+3];if(s!==255&&s>0){const n=255/s;e[i+0]=e[i+0]*n,e[i+1]=e[i+1]*n,e[i+2]=e[i+2]*n}}}const Xwt={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},Jue=98,Ywt="png",Zwt={png:100,jpg:Jue,jpeg:Jue},Jwt={top:0,right:0,bottom:0,left:0};let Kwt=class{constructor(e,r){this.viewCamera=e,this.frameHasDecorations=r}},Qwt=class{constructor(e,r,i,s){this._rctx=e,this._renderFunctions=r,this._forceCameraHook=i,this._disposeOffscreenBuffers=s,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Ps.BACKGROUND);const r=K_();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e,r){for(const i of this._screenshotQueue){if(this._rctx==null){i.resolver.reject();continue}const s={...i.settings,pixelRatio:i.settings.pixelRatio*e.viewCamera.pixelRatio},n=this._renderScreenshot(e,s,r);i.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,r,i){e.width=r.width,e.height=r.height;const s=e.getContext("2d"),n=i.pixelRatio;return s.save(),s.translate(0,r.height),s.scale(1,-1),i.region&&s.translate(-i.region.x,-i.region.y),s.scale(n,n),r=this._renderFunctions.renderOverlay(e,r),s.restore(),r}_readbackScreenshot(e,r){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},r):this._readbackScreenshotImmediate(e,r)}_readbackScreenshotResampled(e,r){const{framebufferWidth:i,framebufferHeight:s,region:n,resample:o}=e,a=this._ensureScreenshotEncodeCanvas();let l=dV(i,s,a);this._rctx.gl.readPixels(0,0,i,s,ze.RGBA,lt.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),r(),l=this._renderScreenshotOverlay(a,l,{...e,region:void 0});const c=dV(n.width,n.height,a);return Vwt(l,c,!0,o.region.x,s-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(e,r){const{framebufferHeight:i,region:s}=e,n=this._ensureScreenshotEncodeCanvas(),o=dV(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,i-(s.y+s.height),s.width,s.height,ze.RGBA,lt.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),r(),this._renderScreenshotOverlay(n,o,e)}_renderScreenshot(e,r,i){let s=null,n=null;const o=e.viewCamera,{framebufferWidth:a,framebufferHeight:l}=r;let c=!1;const h=r.disableDecorations&&e.frameHasDecorations,p=a!==o.fullWidth||l!==o.fullHeight,f=r.ignorePadding&&o.pixelRatio!==r.pixelRatio,m=p||h||f||r.objectAndLayerIdColor;if(r.objectAndLayerIdColor&&(n=new Ns(this._rctx,{width:a,height:l,colorTarget:us.TEXTURE,depthStencilTarget:Ir.DEPTH_STENCIL_RENDER_BUFFER})),m){const x=o.clone();if(r.ignorePadding){const E=FM(x.padding);for(let O=0;O<4;O++)E[O]=Math.round(E[O]/x.pixelRatio*r.pixelRatio);x.padding=E}x.fullWidth=a,x.fullHeight=l,x.pixelRatio=r.pixelRatio;const T=o.fovX-x.fovX,S=o.fovY-x.fovY;T<0&&T<S?x.fovX=o.fovX:S<0&&S<T&&(x.fovY=o.fovY),this._forceCameraHook(x),c=!0,s=new Ns(this._rctx,{width:x.fullWidth,height:x.fullHeight,colorTarget:us.TEXTURE,depthStencilTarget:Ir.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(s,n,x,r.disableDecorations?zw.OFF:zw.ON,i),this._disposeOffscreenBuffers()}const y=()=>{this._rctx.bindFramebuffer(null),et(s)},_=this._readbackScreenshot(r,y);y();let b=null;if(r.objectAndLayerIdColor){const x=()=>{this._rctx.bindFramebuffer(null),et(n)};this._rctx.bindFramebuffer(n),b=this._readbackScreenshot(r,x),this._rctx.bindFramebuffer(null),x()}if(m&&!this._rctx.contextAttributes.alpha)for(let x=3;x<_.data.length;x+=4)_.data[x]=255;if(b&&!this._rctx.contextAttributes.alpha)for(let x=3;x<b.data.length;x+=4)b.data[x]=255;return c&&this._forceCameraHook(o),[_,b]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}},Co=class extends Te{constructor(e){super({}),this.events=new Fs,this.waterTextureRepository=new rO,this._magnifierHelper=new A2,this.objectAndLayerIdRenderHelper=de("enable-feature:objectAndLayerId-rendering")?new Wvt:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),ne(()=>{var i;return(i=this.waterTextureRepository)==null?void 0:i.updating},()=>this.requestRender(),kt),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new uSe(this._rctx),this._shaderTechniqueRepository=new sSe({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new R2(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",i=>this.requestRender(i)),this._materialRepository=new nSe(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new Evt(this._rctx,this._shaderTechniqueRepository),this.renderer=new cu(e,this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,i=>this.requestRender(i));const r={renderScene:(i,s,n,o,a)=>this.renderer.render(i,s,{camera:n,contentCamera:n,mode:Tr.IDLE},o,a),requestRenderScene:i=>this.requestRender(i),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(i,s)=>e.options.screenshot.renderOverlay(i,s)};this._screenshotManager=new Qwt(this._rctx,r,i=>this.events.emit("force-camera-for-screenshot",i),()=>this.renderer.disposeOffscreenBuffers()),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Vi(this._frameTask),this._shaderTechniqueRepository=Ve(this._shaderTechniqueRepository)}get performanceInfo(){const e=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:e.getUsedTextureMemory!==void 0?e.getUsedTextureMemory():void 0,renderbufferMemory:e.getUsedRenderbufferMemory!==void 0?e.getUsedRenderbufferMemory():void 0,VBOMemory:e.getUsedVBOMemory!==void 0?e.getUsedVBOMemory():void 0}}requestRender(e=Ps.UPDATE){this._needsRender=!0,e===Ps.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then(r=>r[0])}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,r,i,s,n,o=n){const a=s.constrainWindowSize(r,i,n*s.pixelRatio,o*s.pixelRatio),l=this._ensureDepthBuffer(a);this.renderer.readDepthPixels(s,a,l);let c=Number.MAX_VALUE;for(let h=0;h<a[2]*a[3];h++){const p=Mvt(4*h,l,s.nearFar);c>p&&p!==s.nearFar[0]&&p!==s.nearFar[1]&&(c=p)}if(v(e)){const h=e.pickDepth(r*s.pixelRatio,i*s.pixelRatio,s);v(h)&&c>h&&h!==s.nearFar[0]&&h!==s.nearFar[1]&&(c=h)}return c===Number.MAX_VALUE?void 0:c}_ensureDepthBuffer(e){const r=4*e[2]*e[3];return(C(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<r)&&(this._tmpDepthBuffer=new Uint8Array(r)),this._tmpDepthBuffer}async reloadShaders(){$Ce(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(e){const r=e.view.state;let i=!1,s=Ps.BACKGROUND,n=!1;const o={preRender:({time:a})=>{i=this.updating,s=this._needsUpdate?Ps.UPDATE:Ps.BACKGROUND,e.commitSyncLayers();const l=a-this._lastAnimationUpdate;if(l>this.renderer.animationTimestep||v(r.forcedAnimationTime)||i||this._needsRender){const c=l/this.renderer.animationTimeDilation,h=new UTe(r.camera,c,r.forcedAnimationTime);this.renderer.updateAnimation(h)&&this.requestRender(Ps.BACKGROUND),this._lastAnimationUpdate=a}},render:({time:a})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&r.camera.fullWidth>0&&r.camera.fullHeight>0){const l=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(null,null,r,zw.ON,a),n=!0,l&&this.renderer.hasWaterReflection&&(this.requestRender(Ps.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:a})=>{const l=new Kwt(r.camera,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update(),this._screenshotManager.update(l,a)},finish:()=>{n&&(this.renderer.finish(r.mode===Tr.IDLE?s:Ps.UPDATE),n=!1)}};this._frameTask=kS(o)}_initializeContext(e){const r=e.options;this._canvas=r.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:r.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:r.stencil==null||r.stencil,powerPreference:"high-performance",preserveDrawingBuffer:r.preserveDrawingBuffer??!1},s=sKe("3d",this._canvas,i);if(C(s)){const n=de("esri-force-webgl");se.getLogger(this.declaredClass).error(n)}else this._rctx=this._newRenderingContext(s,e),this._loadShaderOnlyExtensions(),!r.alpha&&this._rctx.contextAttributes.alpha&&se.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&de("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,r){const i={disabledExtensions:r.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:r.options.debugWebGLExtensions||{},maxAnisotropy:8},s=(n,o)=>r.view.resourceController.memoryController.newCache(n,o);return new Mwt(e,i,s)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(e){return v(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return C(this._componentObjectCollection)&&(this._componentObjectCollection=new mvt(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};u([d({type:Boolean,readOnly:!0})],Co.prototype,"updating",null),u([d({autoDestroy:!0})],Co.prototype,"_rctx",void 0),u([d({autoDestroy:!0})],Co.prototype,"_container",void 0),u([d({autoDestroy:!0})],Co.prototype,"_canvas",void 0),u([d({autoDestroy:!0})],Co.prototype,"_stippleTextureRepository",void 0),u([d({autoDestroy:!0})],Co.prototype,"waterTextureRepository",void 0),u([d({autoDestroy:!0})],Co.prototype,"_magnifierHelper",void 0),u([d({readOnly:!0})],Co.prototype,"objectAndLayerIdRenderHelper",void 0),u([d({autoDestroy:!0})],Co.prototype,"_textureRepository",void 0),u([d({autoDestroy:!0})],Co.prototype,"_compositingHelper",void 0),u([d({autoDestroy:!0,readOnly:!0})],Co.prototype,"renderer",void 0),u([d({autoDestroy:!0})],Co.prototype,"_screenshotManager",void 0),u([d()],Co.prototype,"componentObjectCollection",null),u([d({autoDestroy:!0})],Co.prototype,"_componentObjectCollection",void 0),u([d()],Co.prototype,"_needsUpdate",void 0),u([d()],Co.prototype,"_needsWaterReflectionUpdate",void 0),Co=u([P("esri.views.3d.webgl-engine.parts.RenderView")],Co);let dc=class extends Te{constructor(e){super(e),this._handles=new Zr,this._model=new pN,this._layers=new Kt,this._asyncChangeSet=new KH,this._syncChangeSet=new KH,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Co(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(yt.STAGE,this),this._handles.add(this._frameTask)}destroy(){this._handles.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var e;return(e=this.renderView)==null?void 0:e.renderer}add(e){this._model.add(e),m4(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){C(e)||(this.renderView.requestRender(),this._model.remove(e),m4(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){v(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){v(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e,r){C(e)||(Array.isArray(e)||(e=[e]),await Promise.all(e.filter(i=>C(i.glTexture)).map(i=>this.schedule(()=>this._model.has(i)?i.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null),r)))}loadImmediate(e){return e.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(e,r){this._model.forEachOfType(e,r)}handleEvent(e,r){this.destroyed||(this._model.dirtySet[e](r),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){this._frameTask.processQueue(e),this._commit(e)}_commit(e){const r=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{if(e.done)return;const s=this._layerSyncSet.has(i.id)||i.updatePolicy===X_.SYNC,n=s?this._syncChangeSet:this._asyncChangeSet;r.commitLayer(i.id,n),this._layerSyncSet.delete(i.id),n.empty||(this.renderer.modify(n,s?Ja:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ja),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==X_.ASYNC||(r.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll(r=>{(this._layerSyncSet.has(r.id)||r.updatePolicy===X_.SYNC)&&(e.commitLayer(r.id,this._syncChangeSet),this._layerSyncSet.delete(r.id))});for(const r of this._layerSyncSet)e.commitLayer(r,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ja),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ja),this.renderView.requestRender())}schedule(e,r){return this._frameTask.schedule(e,r)}reschedule(e,r){return this._frameTask.reschedule(e,r)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Ja))}addRenderPlugin(e,r,i){const s=this.renderer.renderPlugins.add(e,r,i),n=()=>{Ule(r)&&this.view.sceneIntersectionHelper.addIntersectionHandler(r)};if(Gu(s))return s.then(n);n()}removeRenderPlugin(e){Ule(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:r=>e._model.test.content.filter(i=>i.type===r).length,model:e._model}}};dc.DebugSettings={endFrameContentValidation:!1},u([d({constructOnly:!0})],dc.prototype,"view",void 0),u([d({constructOnly:!0})],dc.prototype,"options",void 0),u([d({readOnly:!0})],dc.prototype,"viewingMode",null),u([d({constructOnly:!0})],dc.prototype,"container",void 0),u([d({constructOnly:!0})],dc.prototype,"_handles",void 0),u([d({readOnly:!0})],dc.prototype,"updating",null),u([d({constructOnly:!0})],dc.prototype,"_model",void 0),u([d({autoDestroy:!0})],dc.prototype,"renderView",void 0),u([d({readOnly:!0})],dc.prototype,"renderer",null),u([d({readOnly:!0})],dc.prototype,"running",null),dc=u([P("esri.views.3d.webgl-engine.Stage")],dc);let I6t=class extends O5{constructor(e,r,i,s){super(r,i),this.point=e,this.createGraphic=s}};function PRe(t){return Op(t)&&t.intersector===ts.PCL&&!!t.target}let L6t=class extends Rye{constructor(e,r,i,s,n){super(e),this.layerUid=e,this.sublayerUid=r,this.nodeIndex=i,this.componentIndex=s,this.triangleNr=n}},N6t=class extends O5{constructor(e,r,i){super(r,null),this.point=e,this.createVoxelGraphic=i}};function iU(t){return Op(t)&&t.intersector===ts.I3S&&!!t.target}function IRe(t){return Op(t)&&t.intersector===ts.VOXEL&&!!t.target}function Kue(t,e){var r,i;return I5(t)||$5(t)?uM((r=t.target)==null?void 0:r.object.metadata,e):Jat(t)?(i=e.map)==null?void 0:i.ground:PRe(t)||iU(t)||CSe(t)||IRe(t)?uM(t.target,e):null}function U6t(t,e){const r=jq(t,e);return v(r)&&r.type==="graphic"?r.graphic:null}function jq(t,e){var r;if(C(t))return null;if(I5(t)||$5(t))return Que((r=t.target)==null?void 0:r.object.metadata,e);if(PRe(t)){const i=t.target.createGraphic();return{type:"graphic",graphic:i,layer:i.layer}}if(IRe(t)){const i=t.target.createVoxelGraphic();return{type:"graphic",graphic:i,layer:i.layer}}return CSe(t)||mK(t)?Que(t.target,e):iU(t)?ext(t.target,e):null}function Que(t,e){if(C(t)||C(t.graphicUid))return null;const r=uM(t,e);if(C(r))return null;if(r===e.graphics)return C(e.graphicsView)||typeof t.graphicUid!="number"?null:e.graphicsView.getHit(t.graphicUid);const i=e.allLayerViews.find(s=>s.layer===r);return!i||i.suspended||C(t.graphicUid)?null:"getHit"in i?i.getHit(t.graphicUid):null}function ext(t,e){const r=uM(t,e);if(C(r))return null;const i=e.allLayerViews.find(s=>s.layer===r);return i&&!i.suspended&&"getGraphicFromIntersectorTarget"in i?rxt(i.getGraphicFromIntersectorTarget(t)):null}function txt(t,e){const r=uM(t,e);if(C(r))return null;const i=e.allLayerViews.find(s=>s.layer===r);return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(t):null}function rxt(t){return v(t)?{type:"graphic",graphic:t,layer:t.layer}:null}function uM(t,e){return!t||C(t.layerUid)?null:v(e.graphicsView)&&t.layerUid===e.graphicsView.processor.layer.id?e.graphics:e.map.findLayerByUid(t.layerUid)}function V6t(t,e){if(I5(t)||$5(t))return Hg(t.target.object.boundingVolumeWorldSpace.bounds);if(mK(t)){Afe(hL,t.transformation);const r=Math.max(hL[0],hL[1],hL[2]);return t.target.baseBoundingSphere.radius*r}return iU(t)?ao(txt(t.target,e),r=>.5*oge(r)):null}function k6t(t){return!I5(t)&&!$5(t)&&(mK(t)?t.target.numLodLevels>1:!!iU(t))}const hL=M();async function ixt(t,e){if(t.type==="2d")return t.hitTest(e);const r=await t.hitTest(e);if(r.results.length===0)return r;const i=r.results[0],s=(i.distance??0)*(1+sxt),n=r.results.findIndex(o=>(o.distance??0)>s);return n!==-1&&(r.results=r.results.slice(0,n)),r}const sxt=.05;let dk,pk;function nxt(t){const e=Twe(t);for(;e.length>1;){const r=ehe(e.shift());if(r.available)return r}return ehe(e.shift())}function ehe(t){switch(t){case bt.WEBGL1:return oxt();case bt.WEBGL2:return axt()}}function oxt(){return dk||(dk=uxt()),dk}function axt(){return pk||(pk=hxt()),pk}let $Re=class{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsElementIndexUint=!1,this.supportsStandardDerivatives=!1,this.supportsInstancedArrays=!1,this.supportsTextureFloat=!1,this.supportsTextureHalfFloat=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1}},lxt=class extends $Re{constructor(){super(...arguments),this.type=bt.WEBGL1}};class cxt extends $Re{constructor(){super(...arguments),this.type=bt.WEBGL2,this.supportsElementIndexUint=!0,this.supportsStandardDerivatives=!0,this.supportsInstancedArrays=!0,this.supportsTextureFloat=!0,this.supportsTextureHalfFloat=!0}}function LRe(t,e){var n;if(t===bt.WEBGL1&&typeof WebGLRenderingContext>"u"||t===bt.WEBGL2&&typeof WebGL2RenderingContext>"u")return null;const r=document.createElement("canvas");if(!r)return null;let i=XF(r,t,{failIfMajorPerformanceCaveat:!0});if(C(i)&&(i=XF(r,t),v(i)&&(e.majorPerformanceCaveat=!0)),C(i))return i;if(t===bt.WEBGL1){const o=(n=i.getParameter(i.VERSION))==null?void 0:n.match(/^WebGL\s+([\d.]*)/);if(o){const a=parseFloat(o[1]);e.available=a>=.94}}else e.available=!0;e.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),e.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);return s&&(e.supportsHighPrecisionFragment=s.precision>0),i}function uxt(){const t=new lxt,e=LRe(bt.WEBGL1,t);return C(e)||(t.supportsElementIndexUint=e.getExtension("OES_element_index_uint")!==null,t.supportsStandardDerivatives=e.getExtension("OES_standard_derivatives")!==null,t.supportsInstancedArrays=e.getExtension("ANGLE_instanced_arrays")!==null,t.supportsTextureFloat=e.getExtension("OES_texture_float")!==null,t.supportsTextureHalfFloat=e.getExtension("OES_texture_half_float")!==null,t.supportsColorBufferFloat=e.getExtension("WEBGL_color_buffer_float")!==null,t.supportsColorBufferFloatBlend=e.getExtension("EXT_float_blend")!==null,t.supportsColorBufferHalfFloat=e.getExtension("EXT_color_buffer_half_float")!==null),t}function hxt(){const t=new cxt,e=LRe(bt.WEBGL2,t);return C(e)||(t.supportsColorBufferFloat=e.getExtension("EXT_color_buffer_float")!==null,t.supportsColorBufferFloatBlend=e.getExtension("EXT_float_blend")!==null,t.supportsColorBufferHalfFloat=t.supportsColorBufferFloat||e.getExtension("EXT_color_buffer_half_float")!==null),t}function dxt(t){const e=nxt(t);if(!e.available)return new j("webgl:required","WebGL is required but not supported.");if(t==="3d"&&e.majorPerformanceCaveat)return new j("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!e.supportsHighPrecisionFragment)return new j("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!e.supportsVertexShaderSamplers)return new j("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(e.type===bt.WEBGL1){if(!e.supportsElementIndexUint)return new j("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!e.supportsStandardDerivatives)return new j("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!e.supportsInstancedArrays)return new j("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}function pxt(t){return t&&"nodeType"in t}function fxt(t){return t&&typeof t.render=="function"}const the={component:"esri-component"};let wb=class extends Te{constructor(){super(...arguments),this.widget=null}destroy(){this.widget&&this.widget.destroy(),this.node=null}get id(){return this.get("widget.id")||this.get("node.id")}set node(e){const r=this._get("node");e!==r&&(e&&e.classList.add(the.component),r&&r.classList.remove(the.component),this._set("node",e))}castNode(e){return e?typeof e=="string"||pxt(e)?(this._set("widget",null),F5(e)):(fxt(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],wb.prototype,"id",null),u([d()],wb.prototype,"node",null),u([Gt("node")],wb.prototype,"castNode",null),u([d({readOnly:!0})],wb.prototype,"widget",void 0),wb=u([P("esri.views.ui.Component")],wb);const _N=wb,mxt={left:0,top:0,bottom:0,right:0},DRe={bottom:30,top:15,right:15,left:15},fk="manual",tg="esri-ui",wl={ui:tg,corner:`${tg}-corner`,innerContainer:`${tg}-inner-container`,manualContainer:`${tg}-manual-container`,cornerContainer:`${tg}-corner-container`,topLeft:`${tg}-top-left`,topRight:`${tg}-top-right`,bottomLeft:`${tg}-bottom-left`,bottomRight:`${tg}-bottom-right`};function gxt(t){return t&&!t._started&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}function mk(t){const e=t,r=typeof e=="object"&&e!==null&&Object.getPrototypeOf(e);return(r===null||r===Object.prototype)&&("component"in e||"index"in e||"position"in e)?t:null}function gk(t,{top:e,bottom:r,left:i,right:s}){t.style.top=e,t.style.bottom=r,t.style.left=i,t.style.right=s}let Cf=class extends Fs.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentToKey=new Map,this._locale=Vh(),this.view=null,this._applyViewPadding=()=>{const r=this.container;r&&gk(r,this._toPxPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const r=this._innerContainer;r&&gk(r,this._toPxPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([ne(()=>{var e;return[(e=this.view)==null?void 0:e.padding,this.container]},this._applyViewPadding,kt),ne(()=>this.padding,this._applyUIPadding,kt),ne(()=>[this.container,this._locale],([e,r])=>{e&&e.setAttribute("lang",r)},kt),Epe(e=>{this._locale=e})])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._componentToKey.clear()}set container(e){const r=this._get("container");e!==r&&(e&&(e.classList.add(wl.ui),Tze(e),this._attachContainers(e)),r&&(r.classList.remove(wl.ui),gk(r,{top:"",bottom:"",left:"",right:""}),S0e(r)),this._set("container",e))}get height(){const e=this.get("view.height")||0;if(e===0)return e;const r=this._getViewPadding(),i=r.top+r.bottom;return Math.max(e-i,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:{...DRe,...e}}get width(){const e=this.get("view.width")||0;if(e===0)return e;const r=this._getViewPadding(),i=r.left+r.right;return Math.max(e-i,0)}add(e,r){let i,s;if(Array.isArray(e))return void e.forEach(o=>this.add(o,r));const n=mk(e);n&&({index:i,position:r,component:e,key:s}=n),r&&typeof r=="object"&&({index:i,key:s,position:r}=r),!e||r&&!this._isValidPosition(r)||this._add(e,r,i,s)}remove(e,r){if(!e)return;if(Array.isArray(e))return e.map(s=>this.remove(s,r));const i=this._find(e);if(i){const s=this._componentToKey;if(s.has(e)&&s.get(e)!==r)return;const n=this._components.indexOf(i);return i.node.parentNode&&i.node.parentNode.removeChild(i.node),this._componentToKey.delete(e),this._components.splice(n,1)[0]}}empty(e){return Array.isArray(e)?e.map(r=>this.empty(r)).reduce((r,i)=>r.concat(i)):(e=e||fk)===fk?Array.prototype.slice.call(this._manualContainer.children).filter(r=>!r.classList.contains(wl.corner)).map(r=>this.remove(r)):this._isValidPosition(e)?Array.prototype.slice.call(this._cornerNameToContainerLookup[e].children).map(this.remove,this):null}move(e,r){if(Array.isArray(e)&&e.forEach(o=>this.move(o,r)),!e)return;let i;const s=mk(e)||mk(r);if(s&&(i=s.index,r=s.position,e=s.component||e),r&&!this._isValidPosition(r))return;const n=this.remove(e);n&&this.add(n,{position:r,index:i})}find(e){if(!e)return null;const r=this._findById(e);return r&&(r.widget||r.node)}getPosition(e){for(const r in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[r].contains(e))return r;return null}_add(e,r,i,s){e instanceof _N||(e=new _N({node:e})),this._place({component:e,position:r,index:i}),this._components.push(e),s&&this._componentToKey.set(e,s)}_find(e){return e?e instanceof _N?this._findByComponent(e):typeof e=="string"?this._findById(e):this._findByNode(e.domNode||e):null}_getViewPadding(){return this.get("view.padding")||mxt}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(wl.innerContainer),e.classList.add(wl.cornerContainer);const r=document.createElement("div");r.classList.add(wl.innerContainer),r.classList.add(wl.manualContainer);const i=document.createElement("div");i.classList.add(wl.topLeft),i.classList.add(wl.corner),e.appendChild(i);const s=document.createElement("div");s.classList.add(wl.topRight),s.classList.add(wl.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(wl.bottomLeft),n.classList.add(wl.corner),e.appendChild(n);const o=document.createElement("div");o.classList.add(wl.bottomRight),o.classList.add(wl.corner),e.appendChild(o),this._innerContainer=e,this._manualContainer=r;const a=qf();this._cornerNameToContainerLookup={"top-left":i,"top-right":s,"bottom-left":n,"bottom-right":o,"top-leading":a?s:i,"top-trailing":a?i:s,"bottom-leading":a?o:n,"bottom-trailing":a?n:o},this._positionNameToContainerLookup={manual:r,...this._cornerNameToContainerLookup}}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const r=e.component,i=e.position||fk,s=e.index,n=this._positionNameToContainerLookup[i],o=s!=null&&s>-1;if(gxt(r.widget)&&r.widget.startup(),!o)return void n.appendChild(r.node);const a=Array.prototype.slice.call(n.children);if(s===0)return void(n.firstChild?wte(r.node,n.firstChild):n.appendChild(r.node));s>=a.length?n.appendChild(r.node):wte(r.node,a[s])}_toPxPosition(e){return{top:this._toPxUnit(e.top),left:this._toPxUnit(e.left),right:this._toPxUnit(e.right),bottom:this._toPxUnit(e.bottom)}}_toPxUnit(e){return e===0?"0":e+"px"}_findByComponent(e){let r,i=null;return this._components.some(s=>(r=s===e,r&&(i=s),r)),i}_findById(e){let r,i=null;return this._components.some(s=>(r=s.id===e,r&&(i=s),r)),i}_findByNode(e){let r,i=null;return this._components.some(s=>(r=s.node===e,r&&(i=s),r)),i}};u([d()],Cf.prototype,"_locale",void 0),u([d()],Cf.prototype,"container",null),u([d()],Cf.prototype,"height",null),u([d({value:DRe})],Cf.prototype,"padding",null),u([Gt("padding")],Cf.prototype,"castPadding",null),u([d()],Cf.prototype,"view",void 0),u([d()],Cf.prototype,"width",null),Cf=u([P("esri.views.ui.UI")],Cf);const yxt=Cf;function rhe(t,e){return t&&"copyright"in t&&(!e||typeof t.originOf=="function"&&t.originOf("copyright")==="user")}function _xt(t,e){return t.length!==e.length||t.some((r,i)=>r.text!==e[i].text)}function dL(t,e,r){!r||!e||t.find(i=>i.layerView===e&&i.text===r)||t.push({text:r,layerView:e})}function vxt(t){return t.type==="bing-maps"}const b0=[];let O2=class extends E3{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new ft,this.view=null,this._allLayerViewsChange=r=>{this.handles.remove("suspension");const i=this.get("view.allLayerViews");i&&this.handles.add(i.map(s=>ne(()=>{var n;return[s.suspended,(n=s.layer)==null?void 0:n.attributionVisible]},()=>this._updateAttributionItems())),"suspension"),r&&r.removed&&r.removed.forEach(s=>{this._pendingAttributions.delete(s),this._fetchedAttributionData.delete(s)}),this._updateAttributionItems()},this.handles.add([an(()=>{var r;return(r=this.view)==null?void 0:r.allLayerViews},"change",r=>this._allLayerViewsChange(r),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),ra(()=>{var r;return((r=this.view)==null?void 0:r.stationary)===!0},()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.view,r=e==null?void 0:e.allLayerViews;b0.length=0,e&&r?(r.forEach(i=>{var o;if(i.suspended||!((o=i.layer)!=null&&o.attributionVisible))return;const s=i.layer;if(rhe(s,"user"))return void dL(b0,i,s.copyright);if(s.hasAttributionData){if(this._fetchedAttributionData.has(i)){const a=this._fetchedAttributionData.get(i);return void(a?dL(b0,i,this._getDynamicAttribution(a,e,s)):rhe(s)&&dL(b0,i,s.copyright))}return void this._fetchAttributionData(i)}const n=s.get("portalItem.accessInformation");dL(b0,i,n||s.copyright)}),_xt(this.items,b0)&&(this.items.removeAll(),this.items.addMany(b0)),b0.length=0,this.notifyChange("state")):this._clear()}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const r=await Uc(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=r.ok?this._createContributionIndex(r.value,vxt(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,r){const i=e.contributors,s={};if(!i)return s;for(let n=0;n<i.length;n++){const o=i[n],a=o.coverageAreas;if(!a)return;for(const l of a){const c=l.bbox,h=l.zoomMin-(r&&l.zoomMin?1:0),p=l.zoomMax-(r&&l.zoomMax?1:0),f={xmin:c[1],ymin:c[0],xmax:c[3],ymax:c[2],spatialReference:We.WGS84},m={extent:jg(f),attribution:o.attribution||"",score:l.score!=null?l.score:100,id:n};for(let y=h;y<=p;y++)s[y]=s[y]||[],s[y].push(m)}}return s.maxKey=Math.max.apply(null,Object.keys(s)),s}_getDynamicAttribution(e,r,i){var h;const{extent:s,scale:n}=r;let o=((h=i.tileInfo)==null?void 0:h.scaleToZoom(n))??0;if(o=Math.min(e.maxKey??0,Math.round(o)),!s||o==null||o<=-1)return"";const a=e[o],l=ex(s.center.clone().normalize(),r.spatialReference),c={};return a?a.filter(p=>{const f=p.id,m=!c[f]&&l&&p.extent&&zW(p.extent,l);return m&&(c[f]=!0),m}).sort((p,f)=>f.score-p.score||p.objectId-f.objectId).map(p=>p.attribution).join(", "):""}};u([d({readOnly:!0,type:ft})],O2.prototype,"items",void 0),u([d({readOnly:!0})],O2.prototype,"state",null),u([d()],O2.prototype,"view",void 0),O2=u([P("esri.widgets.Attribution.AttributionViewModel")],O2);const NRe=O2,ET="esri-attribution",w0={base:`${ET} esri-widget`,poweredBy:`${ET}__powered-by`,sources:`${ET}__sources`,open:`${ET}--open`,sourcesOpen:`${ET}__sources--open`,link:`${ET}__link`,widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let Il=class extends Ma{constructor(e,r){super(e,r),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver(i=>i.forEach(({target:s})=>this._checkSourceTextOverflow(s))),this.iconClass=w0.widgetIcon,this.itemDelimiter=" | ",this.messages=null,this.viewModel=new NRe}initialize(){this.addHandles(an(()=>{var e;return(e=this.viewModel)==null?void 0:e.items},"change",()=>this.scheduleRender()))}destroy(){var e;(e=this._resizeObserver)==null||e.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,r)=>(e.includes(r.text)||e.push(r.text),e),[]).join(this.itemDelimiter)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[w0.open]:this._isOpen};return Q("div",{bind:this,class:this.classes(w0.base,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return Q("div",{class:w0.poweredBy},"Powered by"," ",Q("a",{class:w0.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const e=this._isOpen,r=this._isInteractive,i=r?"0":"",{attributionText:s}=this,n={[w0.sourcesOpen]:e,[w0.interactive]:r};return Q("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(w0.sources,n),innerHTML:s,tabindex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let r=!1;const{clientHeight:i,clientWidth:s,scrollWidth:n}=e,o=n>s,a=this._attributionTextOverflowed!==o;if(this._attributionTextOverflowed=o,a&&(r=!0),this._isOpen){const l=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,l&&(this._isOpen=!1,r=!0)}r&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],Il.prototype,"_isOpen",void 0),u([d()],Il.prototype,"_isInteractive",null),u([d()],Il.prototype,"_attributionTextOverflowed",void 0),u([d()],Il.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],Il.prototype,"attributionText",null),u([d()],Il.prototype,"iconClass",void 0),u([d()],Il.prototype,"itemDelimiter",void 0),u([d()],Il.prototype,"label",null),u([d(),rl("esri/widgets/Attribution/t9n/Attribution")],Il.prototype,"messages",void 0),u([d()],Il.prototype,"view",null),u([d({type:NRe})],Il.prototype,"viewModel",void 0),u([bh()],Il.prototype,"_toggleState",null),Il=u([P("esri.widgets.Attribution")],Il);const bxt=Il,wxt="esri.widgets.CompassViewModel";let xb=class extends kbe(Te){constructor(e){super(e),this._handles=new Zr,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(ne(()=>this.view,this._updateRotationWatcher,kt))}destroy(){Vi(this._handles),this.view=null}get canShowNorth(){const e=this.get("view.spatialReference");return!(!e||!e.isWebMercator&&!e.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){var r;if(!this.get("view.ready"))return;const e={};((r=this.view)==null?void 0:r.type)==="2d"?e.rotation=0:e.heading=0,this.callGoTo({target:e})}_updateForRotation(e){e!=null&&(this.orientation={z:e})}_updateForCamera(e){if(!e)return;const r=-e.heading;this.orientation={x:0,y:0,z:r}}_updateRotationWatcher(e){this._handles.removeAll(),e&&this._handles.add(e.type==="2d"?ne(()=>e==null?void 0:e.rotation,this._updateForRotation,kt):ne(()=>e==null?void 0:e.camera,this._updateForCamera,kt))}};u([d({readOnly:!0})],xb.prototype,"canShowNorth",null),u([d()],xb.prototype,"orientation",void 0),u([d({readOnly:!0})],xb.prototype,"state",null),u([d()],xb.prototype,"view",void 0),xb=u([P(wxt)],xb);const FRe=xb,x0={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let Af=class extends Ma{constructor(e,r){super(e,r),this.iconClass=x0.widgetIcon,this.messages=null,this.viewModel=new FRe}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:r}=this.viewModel,i=r==="disabled",s=(r==="rotation"?"rotation":"compass")=="compass",n=i?-1:0,o={[x0.disabled]:i,[x0.interactive]:!i},a={[x0.northIcon]:s,[x0.rotationIcon]:!s},{messages:l}=this;return Q("div",{bind:this,class:this.classes(x0.base,o),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:n,"aria-label":l.reset,title:l.reset},Q("span",{"aria-hidden":"true",class:this.classes(x0.icon,a),styles:this._toRotationTransform(e)}),Q("span",{class:x0.text},l.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(e){return{transform:`rotateZ(${e.z}deg)`}}};u([d()],Af.prototype,"goToOverride",null),u([d()],Af.prototype,"iconClass",void 0),u([d()],Af.prototype,"label",null),u([d(),rl("esri/widgets/Compass/t9n/Compass")],Af.prototype,"messages",void 0),u([d()],Af.prototype,"view",null),u([d({type:FRe})],Af.prototype,"viewModel",void 0),u([bh()],Af.prototype,"_reset",null),Af=u([P("esri.widgets.Compass")],Af);const xxt=Af,CT="esri-navigation-toggle",sh={base:`${CT} esri-widget`,button:`${CT}__button esri-widget--button`,activeButton:`${CT}__button--active`,panButton:`${CT}__button--pan`,rotateButton:`${CT}__button--rotate`,isLayoutHorizontal:`${CT}--horizontal`,rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let M2=class extends Te{constructor(t){super(t),this.navigationMode="pan",this.view=null}initialize(){this.own(ra(()=>{var t;return(t=this.view)==null?void 0:t.inputManager},()=>this._setNavigationMode()))}destroy(){this.view=null}get state(){var t;return this.get("view.ready")&&((t=this.view)==null?void 0:t.type)==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],M2.prototype,"state",null),u([d()],M2.prototype,"navigationMode",void 0),u([d()],M2.prototype,"view",void 0),M2=u([P("esri.widgets.NavigationToggleViewModel")],M2);const URe=M2;let Rf=class extends Ma{constructor(e,r){super(e,r),this.iconClass=sh.widgetIcon,this.messages=null,this.viewModel=new URe}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}toggle(){return this.viewModel.toggle()}render(){const e=this.get("viewModel.state")==="disabled",r=this.get("viewModel.navigationMode")==="pan",i={[sh.disabled]:e,[sh.isLayoutHorizontal]:this.layout==="horizontal"},s={[sh.activeButton]:r},n={[sh.activeButton]:!r},o=e?-1:0,a=this.messages.toggle;return Q("div",{bind:this,class:this.classes(sh.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:o,"aria-label":a,title:a},Q("div",{class:this.classes(sh.button,sh.panButton,s)},Q("span",{class:sh.panIcon})),Q("div",{class:this.classes(sh.button,sh.rotateButton,n)},Q("span",{class:sh.rotationIcon})))}_toggle(){this.toggle()}};u([d()],Rf.prototype,"iconClass",void 0),u([d()],Rf.prototype,"label",null),u([d({value:"vertical"})],Rf.prototype,"layout",null),u([d(),rl("esri/widgets/NavigationToggle/t9n/NavigationToggle")],Rf.prototype,"messages",void 0),u([d()],Rf.prototype,"view",null),u([d({type:URe})],Rf.prototype,"viewModel",void 0),u([bh()],Rf.prototype,"_toggle",null),Rf=u([P("esri.widgets.NavigationToggle")],Rf);const Txt=Rf,AA={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let e_=class extends Ma{constructor(){super(...arguments),this.enabled=!0,this.iconClass="",this.title=""}render(){const e=this.enabled?0:-1,r={[AA.disabled]:!this.enabled,[AA.interactive]:this.enabled},i={[this.iconClass]:!!this.iconClass};return Q("div",{bind:this,class:this.classes(AA.button,r),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:e,title:this.title},Q("span",{"aria-hidden":"true",role:"presentation",class:this.classes(AA.icon,i)}),Q("span",{class:AA.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],e_.prototype,"action",void 0),u([d()],e_.prototype,"enabled",void 0),u([d()],e_.prototype,"iconClass",void 0),u([d()],e_.prototype,"title",void 0),u([bh()],e_.prototype,"_triggerAction",null),e_=u([P("esri.widgets.IconButton")],e_);const ihe=e_;let P2=class extends Te{get canZoomIn(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMaxScale");return e===0||t>e}get canZoomOut(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMinScale");return e===0||t<e}};u([d({readOnly:!0})],P2.prototype,"canZoomIn",null),u([d({readOnly:!0})],P2.prototype,"canZoomOut",null),u([d()],P2.prototype,"view",void 0),P2=u([P("esri.widgets.Zoom.ZoomConditions2D")],P2);const Sxt=P2;let I2=class extends Te{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};u([d({readOnly:!0})],I2.prototype,"canZoomIn",null),u([d({readOnly:!0})],I2.prototype,"canZoomOut",null),u([d()],I2.prototype,"view",void 0),I2=u([P("esri.widgets.Zoom.ZoomConditions3D")],I2);const Ext=I2;let t_=class extends Te{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return v(this._zoomConditions)&&this._zoomConditions.canZoomIn}get canZoomOut(){var e;return v(this._zoomConditions)&&((e=this._zoomConditions)==null?void 0:e.canZoomOut)}get state(){var e;return(e=this.view)!=null&&e.ready?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new Sxt({view:e}):e.type==="3d"&&(this._zoomConditions=new Ext({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){if(!this.canZoomIn)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomIn():oS(e.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomOut():oS(e.goTo({zoomFactor:.5}))}};u([d()],t_.prototype,"_zoomConditions",void 0),u([d()],t_.prototype,"canZoomIn",null),u([d()],t_.prototype,"canZoomOut",null),u([d({readOnly:!0})],t_.prototype,"state",null),u([d()],t_.prototype,"view",null),t_=u([P("esri.widgets.Zoom.ZoomViewModel")],t_);const VRe=t_,RA={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let Eg=class extends Ma{constructor(t,e){super(t,e),this.iconClass=RA.widgetIcon,this.messages=null,this.viewModel=new VRe}initialize(){this._zoomInButton=new ihe({action:this.zoomIn.bind(this),iconClass:RA.zoomInIcon}),this._zoomOutButton=new ihe({action:this.zoomOut.bind(this),iconClass:RA.zoomOutIcon})}destroy(){this._zoomInButton=Ve(this._zoomInButton),this._zoomOutButton=Ve(this._zoomOutButton)}get label(){var t;return((t=this.messages)==null?void 0:t.widgetLabel)??""}set label(t){this._overrideIfSome("label",t)}set layout(t){t!=="horizontal"&&(t="vertical"),this._set("layout",t)}set view(t){this.viewModel.view=t}get view(){return this.viewModel.view}render(){const t=this.viewModel,e={[RA.horizontalLayout]:this.layout==="horizontal"},{canZoomIn:r,canZoomOut:i}=t;this._zoomInButton.enabled=r,this._zoomOutButton.enabled=i;const{zoomIn:s,zoomOut:n}=this.messages;return this._zoomInButton.title=s,this._zoomOutButton.title=n,Q("div",{class:this.classes(RA.base,e)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],Eg.prototype,"iconClass",void 0),u([d()],Eg.prototype,"label",null),u([d({value:"vertical"})],Eg.prototype,"layout",null),u([d(),rl("esri/widgets/Zoom/t9n/Zoom")],Eg.prototype,"messages",void 0),u([d()],Eg.prototype,"view",null),u([d({type:VRe})],Eg.prototype,"viewModel",void 0),Eg=u([P("esri.widgets.Zoom")],Eg);const kRe=Eg;function Cxt(t){return t&&t.view!==void 0}let vN=class extends yxt{constructor(t){super(t),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[]}initialize(){this.addHandles([ne(()=>this.components,this._componentsWatcher.bind(this),kt),ne(()=>this.view,this._updateViewAwareWidgets.bind(this),kt)])}_add(t,e,r,i){let s=t;if(typeof t=="string"&&this._defaultPositionLookup[t]){if(this._find(t))return;s=this._createComponent(t)}super._add(s,e,r,i)}_removeComponents(t){t.forEach(e=>{const r=this._find(e);r&&(this.remove(r),r.destroy())})}_updateViewAwareWidgets(t){this.components.forEach(e=>{const r=this._find(e),i=r&&r.widget;Cxt(i)&&(i.view=t)})}_componentsWatcher(t,e){this._removeComponents(e),this._addComponents(t),this._adjustPadding(t)}_adjustPadding(t){if(!t.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(t){this.constructed&&t.forEach(e=>this.add(this._createComponent(e),this._defaultPositionLookup[e]))}_createComponent(t){const e=this._createWidget(t);if(e)return new _N({id:t,node:e})}_createWidget(t){return t==="attribution"?this._createAttribution():t==="compass"?this._createCompass():t==="navigation-toggle"?this._createNavigationToggle():t==="zoom"?this._createZoom():void 0}_createAttribution(){return new bxt({view:this.view})}_createCompass(){return new xxt({view:this.view})}_createNavigationToggle(){return new Txt({view:this.view})}_createZoom(){return new kRe({view:this.view})}};u([d()],vN.prototype,"components",void 0),vN=u([P("esri.views.ui.DefaultUI")],vN);const Axt=vN;let bN=class extends Axt{constructor(t){super(t),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],bN.prototype,"components",void 0),bN=u([P("esri.views.ui.3d.DefaultUI3D")],bN);const zRe=bN;let ot=class extends E9e(gZe(IZe(YZe))){constructor(t){super(t),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._lostWebGLContextHandle=null,this._resolveWhenReady=[],this._propertiesPool=new cy({slicePlane:Pye},this),this._resourceController=pmt(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new GH({view:this}),this.labeler=new fb({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new gE,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Lb,this.environmentManager=new Dd,this.floors=new ft,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new JZe({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new $ft,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new zRe,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new pq,this.voxelWasm=null,this.voxelWasmPromise=null,h9e(),t&&t.environment||(this._defaults.environment=new f2,this.environment=this._defaults.environment);const e=(r=null)=>{v(r)&&r.type===mi.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async i=>{try{await i.when()}catch{}this._updatingChanged()}))};this.handles.add([an(()=>{var r;return(r=this.map)==null?void 0:r.allLayers},"after-changes",r=>e(r),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",r=>this._updateUpdatingMonitors(r)),ne(()=>this.map,r=>{r&&"load"in r&&r.load&&r.load().catch(()=>{})})]),this.inputManager=new Vit({view:this}),this.stateManager=new pn({view:this})}initialize(){this.groundView=new PZe({view:this}),this._updateUpdatingMonitors();const t=()=>this._updateDefaultToMapOptions();this.handles.add(an(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},kt),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},kt),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>CMe(e>0?1e3/Math.ceil(e):0),kt),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},t,qs),this.updatingHandles.add(()=>{var e,r;return(r=(e=this.map)==null?void 0:e.ground)==null?void 0:r.opacity},()=>this._updateDefaultHitTestOptions(),qs),this.handles.add(ne(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),ri))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=Ve(this.sharedSymbolResources),this._set("labeler",Ve(this.labeler)),this._set("deconflictor",Ve(this.deconflictor)),this._resourceController=Ve(this._resourceController),this._set("stateManager",Ve(this.stateManager)),this._set("inputManager",Ve(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this._set("environmentManager",Ve(this.environmentManager)),this.groundView=Ve(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var t;return(t=this.basemapTerrain)==null?void 0:t.spatialReference}get animation(){var t;return(t=this.state)==null?void 0:t.animation}get camera(){var t;return(t=this.stateManager)==null?void 0:t.camera}set camera(t){this.stateManager&&(this.stateManager.camera=t)}get contentCamera(){var t;return(t=this.stateManager)==null?void 0:t.contentCamera}set contentCamera(t){this.stateManager&&(this.stateManager.contentCamera=t)}installContentCameraReset(t={sticky:!1}){return this.stateManager.installContentCameraReset(t)}get center(){var t;return(t=this.stateManager)==null?void 0:t.center}set center(t){this.stateManager&&(this.stateManager.center=t)}get clippingArea(){var e;if(this.viewingMode==="global")return null;let t=this._userClippingArea||("clippingArea"in this.map?(e=this.map)==null?void 0:e.clippingArea:void 0);return!(this._userClippingArea||this.get("map.clippingEnabled"))||C(t)?(this._clippingArea=null,null):t instanceof Hr?this.spatialReference&&(t=pL(t,this.spatialReference),C(t))?(se.getLogger(this.declaredClass).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),C(t.intersection(this._groundAndLayersExtent))&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(se.getLogger(this.declaredClass).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(t){this.ready&&this.viewingMode==="global"&&v(t)?se.getLogger(this.declaredClass).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=t}get renderDataExtent(){if(this.state.viewingMode===Be.Global)return null;const t=this.renderSpatialReference,e=this.dataExtent;return C(e)||C(t)||e.spatialReference.equals(t)?e:pL(e,t)}get dataExtent(){let t=this._groundAndLayersExtent;const e=this.spatialReference||We.WGS84,r=pL(this.clippingArea,e);v(r)&&(t=v(t)?t.intersection(r):r);const i=this._get("dataExtent");return v(t)&&t.equals(i)?i:t}get _groundAndLayersExtent(){const t=this.spatialReference||We.WGS84;let e;const r=n=>{const o=pL(n,t);C(o)||(v(e)?e.union(o):e=o.clone())},i=this.basemapTerrain;if(i!=null&&i.spatialReference){const n=i.groundExtent;r(new Hr({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map){const n=o=>{!v(o.fullExtent)||o.type==="graphics"&&o.internal||r(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(C(e))return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const s=this._get("_groundAndLayersExtent");return e.equals(s)?s:e}set environment(t){t!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",t)}castEnvironment(t){return t?t instanceof f2?t:t instanceof tE?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(t):f2.fromWebsceneEnvironment(t):Ls(f2,t):new f2}get extent(){var t;return(t=this.stateManager)==null?void 0:t.extent}set extent(t){this.stateManager&&(this.stateManager.extent=t)}get screenCenter(){var t;return(t=this.stateManager)==null?void 0:t.screenCenter}get frustum(){var t;return(t=this.stateManager)==null?void 0:t.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||v(this.activeTool)&&this.activeTool.visible}get stationary(){return!this.animation&&!this.resizing&&(C(this.state)||this.state.stationary)}get navigating(){var t;return((t=this.state)==null?void 0:t.navigating)??!1}get padding(){var t;return(t=this.stateManager)==null?void 0:t.padding}set padding(t){this.stateManager&&(this.stateManager.padding=t)}set qualityProfile(t){sN.isValidProfile(t)&&(sN.apply(t,this.qualitySettings),this._set("qualityProfile",t))}get qualityProfile(){return this._get("qualityProfile")||sN.getDefaultProfile()}set slicePlane(t){if(v(this._stage)&&this._stage.renderer.setParameters({slicePlane:t}),C(t))return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");lx(t,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?b6e(this.scale,this.spatialReference):0}get scale(){var t;return(t=this.stateManager)==null?void 0:t.scale}set scale(t){this.stateManager&&(this.stateManager.scale=t)}get heightModelInfo(){const t=this.getDefaultHeightModelInfo();return t!=null?Tv.deriveUnitFromSR(t,this.spatialReference):null}get updating(){var s,n,o;if(this.destroyed)return!1;let t=0,e=this.layerViewManager.updating,r=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(a=>{if(a.isFulfilled()){if(a.updating){if(e=!0,a.suspended||sM(a))return;++r,t+=a.updatingProgress}}else++r});for(const a of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager])v(a)&&a.updating&&(r+=.1,t+=.5*.1);for(const a of[this.deconflictor,this.labeler,this.basemapTerrain])v(a)&&a.updating&&(++r,t+=a.updatingProgress);const i=this.stateManager.test.updatingIgnoreRenderState?Tr.IDLE:this.state.mode;if(e=!!(e||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||i!==Tr.IDLE||this._createGraphicsViewController||(s=this.inputManager)!=null&&s.hasPendingInputs||(o=(n=this.map)==null?void 0:n.allLayers)!=null&&o.some(a=>!a.isFulfilled())),e?(this._numUpdating=Math.max(r,this._numUpdating),t+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?t/=this._numUpdating:t=e?0:1,this._get("updatingProgress")!==t){const a=performance.now();if(t<1){const l=Math.min((a-this._lastUpdateTime)/2e3,1);t=this.updatingProgress*(1-l)+t*l}this._set("updatingProgress",t),this._lastUpdateTime=e&&t<1?a:0}return e}get viewingMode(){var r;const t=this._predeterminedViewingMode;if(v(t))return MU(t);const e=this.spatialReference;return e?v((r=this.defaultsFromMap)==null?void 0:r.viewingMode)&&e.equals(this.defaultsFromMap.spatialReference)?MU(this.defaultsFromMap.viewingMode):eE(e,Be.Global)?"global":"local":"global"}set viewingMode(t){this.ready?se.getLogger(this.declaredClass).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",t)}get viewpoint(){var t;return(t=this.stateManager)==null?void 0:t.viewpoint}set viewpoint(t){this.stateManager&&(this.stateManager.viewpoint=t)}get zoom(){return this.stateManager.zoom}set zoom(t){this.stateManager&&(this.stateManager.zoom=t)}get resourceController(){return this._resourceController}get performanceInfo(){return new Vmt(this)}on(t,e,r,i){return this.viewEvents.on(t,e,r,i)||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}toMap(t,e){if(!this.ready)return se.getLogger(this.declaredClass).error("#toMap()","Scene view cannot be used before it is ready"),null;const r=e?this.externalToInternalIntersectOptions(e):this._defaultToMapOptions,i=v(r.graphics)&&(v(r.graphics.include)||v(r.graphics.exclude)),s=Ese(t)?Sse(this,t):t,n=Ff(s);r.enableDraped=r.include&&!r.include.has(f_)||r.exclude&&r.exclude.has(f_);const o=this.sceneIntersectionHelper,a=Qh(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=i?Do.ALL:Do.MIN,o.intersectIntersectorScreen(n,a,r),i){for(const l of a.results.all){const c=jq(l,this);if(C(c))return this._intersectResultToMapPoint(l);if(c.type!=="graphic"||this._testGraphicUidFilter(r.graphics,c.graphic))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(t){if(!this.ready)return se.getLogger(this.declaredClass).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=It(t.z==null?Hf(this.elevationProvider,t):null,0);return ta(t,AT,this.renderSpatialReference,e),this.state.camera.projectToScreen(AT,yk),Zh(yk[0],yk[1])}pixelSizeAt(t){return this.ready?t?(ta(t,AT,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(AT)):0:(se.getLogger(this.declaredClass).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(t){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(t):1}hitTest(t,e){if(!this.ready)return se.getLogger(this.declaredClass).error("#hitTest()","Scene view cannot be used before it is ready"),null;const r=Ese(t)?Sse(this,t):t,i=cs(r.x,r.y),s=e?this.externalToInternalIntersectOptions(e):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=Qh(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=Do.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(i,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=Kue(a,this),c=v(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:r,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:Op(a)?a.distanceInRenderSpace:0,layer:c}};return Wr.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}async popupHitTest(t){const{results:e,ground:r}=await ixt(this,t);let i=null;return!(e.length===0||Math.abs(It(e[0].distance,0)-r.distance)<1e-5)||r.layer&&r.layer.type==="integrated-mesh"||(i=r.mapPoint),{results:e,screenPoint:t,mapPoint:i}}goTo(t,e){return this.updatingHandles.addPromise(this.stateManager.goTo(t,e))}async whenAnalysisView(t){if(C(t.parent))throw new j("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});switch(t.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(t.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(t)}}whenLayerView(t){return super.whenLayerView(t)}async takeScreenshot(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(e);return ck(r,e,this._pixelFormat())}async _takeScreenshot(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(e);return uk(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(e);return[uk(r[0],this._pixelFormat()),uk(r[1],this._pixelFormat())]}_completeSettings(t){const e=Nwt(t,this);return e.pixelRatio/=this.state.pixelRatio,kwt(e,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:t=>this._takeScreenshot(t),takeScreenshotWithObjectAndLayerId:t=>this._takeScreenshotWithObjectAndLayerId(t)}}async takeScreenshotWithObjectAndLayerId(t){if(!de("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(e),i=ck(r[0],e,this._pixelFormat()),s=this._completeSettings(t);return s.format="png",[i,ck(r[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(C(this._stage.renderView.objectAndLayerIdRenderHelper))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(t){return this.updatingHandles.addPromise(t)}importLayerView(t){return Pse.importLayerView(t)}hasLayerViewModule(t){return Pse.hasLayerViewModule(t)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var t,e,r,i;return this.map&&"initialViewProperties"in this.map&&((e=(t=this.map)==null?void 0:t.initialViewProperties)==null?void 0:e.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.spatialReference)||((i=this.defaultsFromMap)==null?void 0:i.ready)&&this._initialDefaultSpatialReference||null}async validate(){let t=dxt(this.type);const e=de("safari");if(e&&e<9&&(t=new j("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),v(t))throw se.getLogger(this.declaredClass).warn("#validate()",t.message),t}get _predeterminedViewingMode(){var e;const t=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return v(t)?Aee(t):null}getSpatialReferenceSupport({spatialReference:t,layer:e}){const r=this._predeterminedViewingMode;if(v(r))return this._validateSpatialReferenceForViewingMode(t,e,r)?{constraints:this._makeSpatialReferenceConstraints(t,e,r)}:null;const i=this._validateSpatialReferenceForViewingMode(t,e,Be.Local),s=this._validateSpatialReferenceForViewingMode(t,e,Be.Global);return i||s?i&&s?{constraints:this._makeSpatialReferenceConstraints(t,e,null)}:i?{constraints:this._makeSpatialReferenceConstraints(t,e,Be.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,e,Be.Global)}:null}_validateSpatialReferenceForViewingMode(t,e,r){return!!eE(t,r)&&(!!C(e)||!!ree(e)||(!cO(e)||!C(X6(e,t,r)))&&(!tee(e)||r!==Be.Global))}_makeSpatialReferenceConstraints(t,e,r){if(C(e))return[{spatialReference:t,viewingMode:r}];const i=t.isWebMercator,s=t.isWGS84;return ree(e)&&(i||s)?!s||r===Be.Local||EK(e.tileInfo,e.fullExtent,t,Be.Global)===null?[{spatialReference:t,viewingMode:r},{spatialReference:We.WebMercator,viewingMode:r}]:[{spatialReference:i?We.WGS84:We.WebMercator,viewingMode:r}]:cO(e)||tee(e)||!i&&!s?cO(e)&&i&&r!==Be.Global?[{spatialReference:t,viewingMode:r},{spatialReference:We.WGS84,viewingMode:Be.Local}]:[{spatialReference:t,viewingMode:r}]:[{spatialReference:t,viewingMode:r},{spatialReference:i?We.WGS84:We.WebMercator,viewingMode:r}]}_validateSpatialReference(t){const e=v(this.getSpatialReferenceSupport({spatialReference:t})),r=this._predeterminedViewingMode;return e||(v(r)?se.getLogger(this.declaredClass).warnOnce(`Spatial reference defined on view not supported in ${MU(r)} viewing mode.`):t.isGeographic&&se.getLogger(this.declaredClass).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(t=>{this.ready?t(this):this._resolveWhenReady.push(t)})}computeMapPointFromVec3d(t,e){let r=this.spatialReference||We.WGS84;return uo(t,this.renderSpatialReference,t,r)||(r=We.WGS84,uo(t,this.renderSpatialReference,t,r)),e?(e.x=t[0],e.y=t[1],e.z=t[2],e.spatialReference=r):e=new _t(t,r),e}trackGraphicState(t){if(!t.graphic)return se.getLogger(this.declaredClass).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(t.graphic);let r=null,i=!1;const s=n=>{var o;!i&&v(n)&&"processor"in n&&((o=n.processor)==null?void 0:o.type)==="graphics-3d"&&n.processor.graphicsCore&&(r=n.processor.graphicsCore.trackGraphicState(t))};return v(e)?s(e):this.whenViewForGraphic(t.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{i=!0,v(r)&&(r.remove(),r=null)}}}highlight(t){if(Array.isArray(t))return US(t.map(r=>this.highlight(r)));if(ft.isCollection(t))return US(t.toArray().map(r=>this.highlight(r)));const e=this.getViewForGraphic(t);return e&&"highlight"in e?e.highlight(t):yp()}maskOccludee(t){if(!t)return se.getLogger(this.declaredClass).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(t);let r=null,i=!1;const s=n=>{!i&&v(n)&&lZe(n)&&(r=n.maskOccludee(t))};return v(e)?s(e):this.whenViewForGraphic(t,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{i=!0,v(r)&&(r.remove(),r=null)}}}getViewForGraphic(t){return t.layer===this.graphics?this.graphicsView:t.layer?this.allLayerViews.find(e=>e.layer===t.layer):null}graphicChanged(t){v(this.graphicsView)&&this.graphicsView.graphicChanged(t)}async whenViewForGraphic(t,e){if(t.layer===this)return await f3(()=>this.graphicsView),this.graphicsView;if(!t.layer||!this.map)throw new j("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((r,i)=>{const s=this.map.allLayers.on("change",n=>{n.added.includes(t.layer)&&(s.remove(),this.whenLayerView(t.layer).then(r,i))})}):this.whenLayerView(t.layer)}externalToInternalIntersectOptions(t){const e=this._externalToInternalRenderItems(t.include,e3.INCLUDE),r=this._externalToInternalRenderItems(t.exclude,e3.EXCLUDE);return{include:e.layerUids,exclude:r.layerUids,graphics:{include:e.graphicUids,exclude:r.graphicUids}}}_intersectResultToMapPoint(t,e){return t.getIntersectionPoint(AT)?(e=this.computeMapPointFromVec3d(AT,e),t.intersector===ts.TERRAIN&&this.basemapTerrain&&(e.z=It(Hf(this.basemapTerrain,e),0)),e):null}_intersectResultsToHits(t,e){const r=new Array;let i=null;for(let s=0;s<t.length;s++){const n=t[s],o=Kue(n,this);if(v(o)&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=jq(n,this);if(C(a))continue;if(a.type==="graphic"){if(C(i)&&s!==t.length-1&&(i=new Set),v(i)){const h=this._getGraphicFilterUid(a.graphic);if(i.has(h))continue;i.add(h)}if(!this._testGraphicUidFilter(e,a.graphic))continue}const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;r.push({...a,mapPoint:l,distance:c})}return r}_getGraphicFilterUid(t){var s;const e=t.sourceLayer,r=t.layer,i=e&&"objectIdField"in e?e:r&&"objectIdField"in r?r:e;if(i){const n=i.objectIdField??$0e,o=(s=t.attributes)==null?void 0:s[n];if(o)return`o-${i.id}-${o}`}return`u-${t.uid}`}_testGraphicUidFilter(t,e){const r=this._getGraphicFilterUid(e);return C(t)||(C(t.include)||t.include.has(r))&&(C(t.exclude)||!t.exclude.has(r))}_externalToInternalRenderItems(t,e,r={layerUids:void 0,graphicUids:void 0}){if(!t)return r;if(t instanceof Sa)Rxt(r,this._getGraphicFilterUid(t)),e===e3.INCLUDE&&(v(this.graphicsView)&&t.layer===this?OA(r,this.graphicsView.processor.layer.id):t.layer&&OA(r,t.layer.uid));else if(Mk(t))for(const i of t)i===this.graphics&&v(this.graphicsView)?OA(r,this.graphicsView.processor.layer.id):i===this.map.ground?OA(r,f_):this._externalToInternalRenderItems(i,e,r);else"uid"in t&&OA(r,t.uid);return r}_initBasemapTerrain(){this._set("basemapTerrain",new q0t({view:this})),this._set("elevationProvider",new XR({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new $l({view:this})),this._set("featureTiles",new Ao({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{var r;const e=(r=this.basemapTerrain)==null?void 0:r.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const i=v(this.basemapTerrain.extent)&&v(this.basemapTerrain.spatialReference)?GE(o5(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;v(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(()=>Wr.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(ie(()=>import("./FeatureTileTree3DDebugger-47f173d5.js"),["./FeatureTileTree3DDebugger-47f173d5.js","./TileTreeDebugger-e1d9ec89.js"],import.meta.url)).then(({FeatureTileTree3DDebugger:r})=>{!this._featureTreeDebugger&&Wr.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new r({view:this}))}):e||!this._featureTreeDebugger||Wr.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},qs),this.updatingHandles.add(()=>this.clippingArea,t,qs),this.updatingHandles.add(()=>this.basemapTerrain.extent,t,qs)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new Yft(this.map,t));const e=this.state.isGlobal,r=I0e(e,t);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",Qft.create(this.state.viewingMode,r)),e||this.handles.add(ne(()=>{var i;return(i=this.basemapTerrain)==null?void 0:i.extent},i=>{const s=this.renderCoordsHelper.spatialReference;v(i)&&(i[0]!==0||i[1]!==0||i[2]!==0||i[3]!==0)&&c5(i,this.basemapTerrain.spatialReference,she,s)&&(this.renderCoordsHelper.extent=she)},ri),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(pE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(t=null){v(t)&&t.type===mi.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.handles.add(ne(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),ri),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(t,e){if(!this.overlay||!this.overlay.hasVisibleItems)return e;const r=t.getContext("2d");return r.putImageData(e,0,0),this.overlay.renderCanvas(t),r.getImageData(0,0,e.width,e.height)}_initStage(){const t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(s,n)=>this._renderScreenshotOverlay(s,n)}},e=new Lft(this.state.viewingMode,s=>this._stage.layers.forAll(s),this);this._set("sceneIntersectionHelper",e);const r=F5(this.surface);this._stage=new dc({view:this,options:t,container:r}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=wM(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new j("webgl-context-lost")),this.handles.add([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderer.setParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),kt),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,s=>this._stage.renderer.setParameters({highQualityTransparency:s}),kt),ne(()=>this.magnifier,s=>this._stage.renderView.magnifier=s,qs),this.on("pointer-move",()=>{var s;return(s=this._stage)==null?void 0:s.renderer.resetAnimation()})],"stage");const i=()=>{this._stage.renderer.setParameters({defaultHighlightOptions:pq.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],i),"stage"),i(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(pE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=Ve(this._stage),this._lostWebGLContextHandle=Vi(this._lostWebGLContextHandle),this.handles.remove("stage"),this._set("canvas",null)}_initSurface(t){this._exitSurface(),this.state.init(t,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new Bmt({view:this,viewingMode:t,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const t=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}async _createGraphicsViewAsync(t){const e=(await ie(()=>import("./GraphicsView3D-a91ccb42.js"),["./GraphicsView3D-a91ccb42.js","./GraphicsProcessor-3457cb00.js","./Graphics3DObjectStates-2997a87b.js","./optimizedFeatureQueryEngineAdapter-b9325535.js","./centroid-57d0b643.js","./PooledRBush-59133963.js","./quickselect-56c5966e.js"],import.meta.url)).default;ur(t),await f3(()=>{var r;return(r=this.basemapTerrain)==null?void 0:r.ready},t),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),v(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const t=Aee(this.viewingMode);if(t===Be.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.handles.add(an(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const r=this.get("map.initialViewProperties.environment");r&&(this.environment=r)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const e=this._resolveWhenReady;this._resolveWhenReady=[],e.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(f_);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(t.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(f_);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&t.opacity<1&&this._defaultHitTestOptions.exclude.add(t.uid)}}addVoxelLayerViewToWasm(t){return C(this.voxelWasm)?(C(this.voxelWasmPromise)&&(this.voxelWasmPromise=ie(()=>import("./VoxelWasmPerSceneView-1692e50d.js"),[],import.meta.url).then(e=>(this.voxelWasm=new e.default(this),this.voxelWasm))),this.voxelWasmPromise.then(e=>e.addVoxelLayer(t))):this.voxelWasm.addVoxelLayer(t)}removeVoxelLayerViewFromWasm(t){v(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(t)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function OA(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function Rxt(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}function pL(t,e){return v(t)&&rv(t.spatialReference,e)?GE(t,e):null}var e3;ot.type="3d",u([d()],ot.prototype,"_userClippingArea",void 0),u([d()],ot.prototype,"_resourceController",void 0),u([d()],ot.prototype,"_stage",void 0),u([d({readOnly:!0})],ot.prototype,"deconflictor",void 0),u([d({readOnly:!0})],ot.prototype,"labeler",void 0),u([d(I7(gE,"analyses"))],ot.prototype,"analyses",void 0),u([d({type:TE,readOnly:!0})],ot.prototype,"animation",null),u([d({readOnly:!0})],ot.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],ot.prototype,"elevationProvider",void 0),u([d()],ot.prototype,"camera",null),u([d({type:qh})],ot.prototype,"contentCamera",null),u([d({readOnly:!0})],ot.prototype,"canvas",void 0),u([d({type:_t})],ot.prototype,"center",null),u([d({type:Hr})],ot.prototype,"clippingArea",null),u([d({type:Lb})],ot.prototype,"constraints",void 0),u([d({type:Hr,readOnly:!0})],ot.prototype,"renderDataExtent",null),u([d({type:Hr,readOnly:!0})],ot.prototype,"dataExtent",null),u([d({type:Hr,readOnly:!0})],ot.prototype,"_groundAndLayersExtent",null),u([d({value:null,type:f2})],ot.prototype,"environment",null),u([Gt("environment")],ot.prototype,"castEnvironment",null),u([d({readOnly:!0})],ot.prototype,"environmentManager",void 0),u([d({type:Hr})],ot.prototype,"extent",null),u([d()],ot.prototype,"floors",void 0),u([d()],ot.prototype,"screenCenter",null),u([d()],ot.prototype,"frustum",null),u([d({type:Number,readOnly:!0})],ot.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],ot.prototype,"graphicsView",void 0),u([d({readOnly:!0})],ot.prototype,"analysisViewManager",void 0),u([d()],ot.prototype,"groundView",void 0),u([d({type:Boolean})],ot.prototype,"initialExtentRequired",null),u([d()],ot.prototype,"_defaultsFromMapSettings",null),u([d()],ot.prototype,"interacting",null),u([d()],ot.prototype,"stationary",null),u([d()],ot.prototype,"navigating",null),u([d()],ot.prototype,"map",void 0),u([d({readOnly:!0})],ot.prototype,"mapCoordsHelper",void 0),u([d()],ot.prototype,"padding",null),u([d({type:$l,readOnly:!0})],ot.prototype,"pointsOfInterest",void 0),u([d({type:Ao,readOnly:!0})],ot.prototype,"featureTiles",void 0),u([d()],ot.prototype,"_featureTreeDebugger",void 0),u([d({type:Boolean})],ot.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],ot.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],ot.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],ot.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],ot.prototype,"state",void 0),u([d({readOnly:!0})],ot.prototype,"inputManager",void 0),u([d({readOnly:!0})],ot.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],ot.prototype,"qualityProfile",null),u([d({type:qle,get(){let t=this._get("qualitySettings");return t||(t=new qle,sN.apply(this.qualityProfile,t)),t}})],ot.prototype,"qualitySettings",void 0),u([d()],ot.prototype,"slicePlane",null),u([d({readOnly:!0})],ot.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],ot.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],ot.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],ot.prototype,"resolution",null),u([d({type:Number})],ot.prototype,"scale",null),u([d()],ot.prototype,"heightModelInfo",null),u([d()],ot.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],ot.prototype,"alphaCompositingEnabled",void 0),u([d({constructOnly:!0})],ot.prototype,"preserveDrawingBufferEnabled",void 0),u([d({type:Boolean})],ot.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],ot.prototype,"type",void 0),u([d({type:zRe})],ot.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating","state.mode"]})],ot.prototype,"updating",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],ot.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],ot.prototype,"viewingMode",null),u([d({type:Vc})],ot.prototype,"viewpoint",null),u([d({type:Number})],ot.prototype,"zoom",null),u([d({type:pq})],ot.prototype,"highlightOptions",void 0),ot=u([P("esri.views.SceneView")],ot),function(t){t[t.INCLUDE=0]="INCLUDE",t[t.EXCLUDE=1]="EXCLUDE"}(e3||(e3={}));const AT=M(),yk=cs(),she=hr(),Oxt=ot;var Mxt=Object.defineProperty,Pxt=Object.getOwnPropertyDescriptor,Ixt=(t,e,r,i)=>{for(var s=i>1?void 0:i?Pxt(e,r):e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(s=(i?o(e,r,s):o(s))||s);return i&&s&&Mxt(e,r,s),s};let Hq=class extends Ma{constructor(t){super(t)}};Hq=Ixt([P("happy-moments.Widget")],Hq);const BRe=Hq;var Nf=(t=>(t[t.Day=0]="Day",t[t.Month=1]="Month",t))(Nf||{});/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */function GRe(t,e,r){const i=$xt(t);return new i(e,r)}function $xt(t){class e extends window.MutationObserver{constructor(i){super(i),this.observedEntry=[],this.callback=i}observe(i,s){return this.observedEntry.push({target:i,options:s}),super.observe(i,s)}unobserve(i){const s=this.observedEntry.filter(n=>n.target!==i);this.observedEntry=[],this.callback(super.takeRecords(),this),this.disconnect(),s.forEach(n=>this.observe(n.target,n.options))}}return function(){return t==="intersection"?window.IntersectionObserver:t==="mutation"?e:window.ResizeObserver}()}/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */const Lxt=new RegExp("\\.(0+)?$"),Dxt=new RegExp("0+$");class Qi{constructor(e){if(e instanceof Qi)return e;const[r,i]=Uxt(e).split(".").concat("");this.value=BigInt(r+i.padEnd(Qi.DECIMALS,"0").slice(0,Qi.DECIMALS))+BigInt(Qi.ROUNDED&&i[Qi.DECIMALS]>="5"),this.isNegative=e.charAt(0)==="-"}getIntegersAndDecimals(){const e=this.value.toString().replace("-","").padStart(Qi.DECIMALS+1,"0"),r=e.slice(0,-Qi.DECIMALS),i=e.slice(-Qi.DECIMALS).replace(Dxt,"");return{integers:r,decimals:i}}toString(){const{integers:e,decimals:r}=this.getIntegersAndDecimals();return`${this.isNegative?"-":""}${e}${r.length?"."+r:""}`}formatToParts(e){const{integers:r,decimals:i}=this.getIntegersAndDecimals(),s=e.numberFormatter.formatToParts(BigInt(r));return this.isNegative&&s.unshift({type:"minusSign",value:e.minusSign}),i.length&&(s.push({type:"decimal",value:e.decimal}),i.split("").forEach(n=>s.push({type:"fraction",value:n}))),s}format(e){const{integers:r,decimals:i}=this.getIntegersAndDecimals(),s=`${this.isNegative?e.minusSign:""}${e.numberFormatter.format(BigInt(r))}`,n=i.length?`${e.decimal}${i.split("").map(o=>e.numberFormatter.format(Number(o))).join("")}`:"";return`${s}${n}`}add(e){return Qi.fromBigInt(this.value+new Qi(e).value)}subtract(e){return Qi.fromBigInt(this.value-new Qi(e).value)}multiply(e){return Qi._divRound(this.value*new Qi(e).value,Qi.SHIFT)}divide(e){return Qi._divRound(this.value*Qi.SHIFT,new Qi(e).value)}}Qi.DECIMALS=100;Qi.ROUNDED=!0;Qi.SHIFT=BigInt("1"+"0".repeat(Qi.DECIMALS));Qi._divRound=(t,e)=>Qi.fromBigInt(t/e+(Qi.ROUNDED?t*BigInt(2)/e%BigInt(2):BigInt(0)));Qi.fromBigInt=t=>Object.assign(Object.create(Qi.prototype),{value:t,isNegative:t<BigInt(0)});function Nxt(t){return!(!t||isNaN(Number(t)))}const Fxt=/^([-0])0+(?=\d)/;function nhe(t,e){if(!t)return t;const r=t.toLowerCase().indexOf("e")+1;return r?t.replace(/[eE]*$/g,"").substring(0,r).concat(t.slice(r).replace(/[eE]/g,"")).split(/[eE]/).map((i,s)=>e(s===1?i.replace(/\./g,""):i)).join("e").replace(/^e/,"1e"):e(t)}function Uxt(t){const e=t.split(/[eE]/);if(e.length===1)return t;const r=+t;if(Number.isSafeInteger(r))return`${r}`;const i=t.charAt(0)==="-",s=+e[1],n=e[0].split("."),o=(i?n[0].substring(1):n[0])||"",a=n[1]||"",l=(p,f)=>{const m=Math.abs(f)-p.length,y=m>0?`${"0".repeat(m)}${p}`:p;return`${y.slice(0,f)}.${y.slice(f)}`},c=(p,f)=>{const m=f>p.length?`${p}${"0".repeat(f-p.length)}`:p;return`${m.slice(0,f)}.${m.slice(f)}`},h=s>0?`${o}${c(a,s)}`:`${l(o,s)}${a}`;return`${i?"-":""}${h.charAt(0)==="."?"0":""}${h.replace(Lxt,"").replace(Fxt,"")}`}const bv="en",Vxt=["ar","bg","bs","ca","cs","da","de","el",bv,"es","et","fi","fr","he","hr","hu","id","it","ja","ko","lt","lv","no","nl","pl","pt-BR","pt-PT","ro","ru","sk","sl","sr","sv","th","tr","uk","vi","zh-CN","zh-HK","zh-TW"],kxt=["ar","bg","bs","ca","cs","da","de","de-CH","el",bv,"en-AU","en-CA","en-GB","es","es-MX","et","fi","fr","fr-CH","he","hi","hr","hu","id","it","it-CH","ja","ko","lt","lv","mk","no","nl","pl","pt","pt-PT","ro","ru","sk","sl","sr","sv","th","tr","uk","vi","zh-CN","zh-HK","zh-TW"],zxt=["arab","arabext","bali","beng","deva","fullwide","gujr","guru","hanidec","khmr","knda","laoo","latn","limb","mlym","mong","mymr","orya","tamldec","telu","thai","tibt"],jRe=t=>zxt.includes(t),_k=new Intl.NumberFormat().resolvedOptions().numberingSystem,HRe=_k==="arab"||!jRe(_k)?"latn":_k,Bxt=t=>jRe(t)?t:HRe;function qRe(t,e="cldr"){const r=e==="cldr"?kxt:Vxt;return t?r.includes(t)?t:(t=t.toLowerCase(),t==="nb"?"no":e==="t9n"&&t==="pt"?"pt-BR":(t.includes("-")&&(t=t.replace(/(\w+)-(\w+)/,(i,s,n)=>`${s}-${n.toUpperCase()}`),r.includes(t)||(t=t.split("-")[0])),t==="zh"?"zh-CN":r.includes(t)?t:(console.warn(`Translations for the "${t}" locale are not available and will fall back to the default, English (en).`),bv))):bv}const hM=new Set;function Gxt(t){jxt(t),hM.size===0&&(wN==null||wN.observe(document.documentElement,{attributes:!0,attributeFilter:["lang"],subtree:!0})),hM.add(t)}function jxt(t){t.effectiveLocale=qxt(t)}function Hxt(t){hM.delete(t),hM.size===0&&wN.disconnect()}const wN=GRe("mutation",t=>{t.forEach(e=>{const r=e.target;hM.forEach(i=>{if(!WOe(r,i.el))return;const n=Jq(i.el,"[lang]");if(!n){i.effectiveLocale=bv;return}const o=n.lang;i.effectiveLocale=n.hasAttribute("lang")&&o===""?bv:o})})});function qxt(t){var e;return t.el.lang||((e=Jq(t.el,"[lang]"))==null?void 0:e.lang)||document.documentElement.lang||bv}class Wxt{constructor(){this.delocalize=e=>this._numberFormatOptions?nhe(e,r=>r.trim().replace(new RegExp(`[${this._minusSign}]`,"g"),"-").replace(new RegExp(`[${this._group}]`,"g"),"").replace(new RegExp(`[${this._decimal}]`,"g"),".").replace(new RegExp(`[${this._digits.join("")}]`,"g"),this._getDigitIndex)):e,this.localize=e=>this._numberFormatOptions?nhe(e,r=>Nxt(r.trim())?new Qi(r.trim()).format(this).replace(new RegExp(`[${this._actualGroup}]`,"g"),this._group):r):e}get group(){return this._group}get decimal(){return this._decimal}get minusSign(){return this._minusSign}get digits(){return this._digits}get numberFormatter(){return this._numberFormatter}get numberFormatOptions(){return this._numberFormatOptions}set numberFormatOptions(e){if(e.locale=qRe(e==null?void 0:e.locale),e.numberingSystem=Bxt(e==null?void 0:e.numberingSystem),!this._numberFormatOptions&&e.locale===bv&&e.numberingSystem===HRe&&Object.keys(e).length===2||JSON.stringify(this._numberFormatOptions)===JSON.stringify(e))return;this._numberFormatOptions=e,this._numberFormatter=new Intl.NumberFormat(this._numberFormatOptions.locale,this._numberFormatOptions),this._digits=[...new Intl.NumberFormat(this._numberFormatOptions.locale,{useGrouping:!1,numberingSystem:this._numberFormatOptions.numberingSystem}).format(9876543210)].reverse();const r=new Map(this._digits.map((s,n)=>[s,n])),i=new Intl.NumberFormat(this._numberFormatOptions.locale).formatToParts(-123456789e-1);this._actualGroup=i.find(s=>s.type==="group").value,this._group=this._actualGroup.trim().length===0?" ":this._actualGroup,this._decimal=i.find(s=>s.type==="decimal").value,this._minusSign=i.find(s=>s.type==="minusSign").value,this._getDigitIndex=s=>r.get(s)}}const vk=new Wxt;/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */const fL={};async function Xxt(t,e){const r=`${e}_${t}`;return fL[r]||(fL[r]=fetch(yhe(`./assets/${e}/t9n/messages_${t}.json`)).then(i=>(i.ok||ohe(),i.json())).catch(()=>ohe())),fL[r]}function ohe(){throw new Error("could not fetch component message bundle")}function jK(t){t.messages={...t.defaultMessages,...t.messageOverrides}}async function Yxt(t){t.defaultMessages=await WRe(t,t.effectiveLocale),jK(t)}async function WRe(t,e){const{el:r}=t,s=r.tagName.toLowerCase().replace("calcite-","");return Xxt(qRe(e,"t9n"),s)}async function Zxt(t,e){t.defaultMessages=await WRe(t,e),jK(t)}function Jxt(t){t.onMessagesChange=Qxt}function Kxt(t){t.onMessagesChange=void 0}function Qxt(){jK(this)}/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */const eTt={icon:"icon",flipRtl:"flip-rtl"},bk={},wk={},XRe={s:16,m:24,l:32};async function tTt({icon:t,scale:e}){const r=XRe[e],i=rTt(t),s=i.charAt(i.length-1)==="F",o=`${s?i.substring(0,i.length-1):i}${r}${s?"F":""}`;if(bk[o])return bk[o];wk[o]||(wk[o]=fetch(yhe(`./assets/icon/${o}.json`)).then(l=>l.json()).catch(()=>(console.error(`"${o}" is not a valid calcite-ui-icon name`),"")));const a=await wk[o];return bk[o]=a,a}function rTt(t){const e=!isNaN(Number(t.charAt(0))),r=t.split("-");if(r.length>0){const s=/[a-z]/i;t=r.map((n,o)=>n.replace(s,function(l,c){return o===0&&c===0?l:l.toUpperCase()})).join("")}return e?`i${t}`:t}const iTt="@keyframes in{0%{opacity:0}100%{opacity:1}}@keyframes in-down{0%{opacity:0;transform:translate3D(0, -5px, 0)}100%{opacity:1;transform:translate3D(0, 0, 0)}}@keyframes in-up{0%{opacity:0;transform:translate3D(0, 5px, 0)}100%{opacity:1;transform:translate3D(0, 0, 0)}}@keyframes in-scale{0%{opacity:0;transform:scale3D(0.95, 0.95, 1)}100%{opacity:1;transform:scale3D(1, 1, 1)}}:root{--calcite-animation-timing:calc(150ms * var(--calcite-internal-duration-factor));--calcite-internal-duration-factor:var(--calcite-duration-factor, 1);--calcite-internal-animation-timing-fast:calc(100ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-medium:calc(200ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-slow:calc(300ms * var(--calcite-internal-duration-factor))}.calcite-animate{opacity:0;animation-fill-mode:both;animation-duration:var(--calcite-animation-timing)}.calcite-animate__in{animation-name:in}.calcite-animate__in-down{animation-name:in-down}.calcite-animate__in-up{animation-name:in-up}.calcite-animate__in-scale{animation-name:in-scale}@media (prefers-reduced-motion: reduce){:root{--calcite-internal-duration-factor:0.01}}:root{--calcite-floating-ui-transition:var(--calcite-animation-timing);--calcite-floating-ui-z-index:600}:host([hidden]){display:none}:host{display:inline-flex;color:var(--calcite-ui-icon-color)}:host([scale=s]){block-size:1rem;inline-size:1rem;min-inline-size:1rem;min-block-size:1rem}:host([scale=m]){block-size:1.5rem;inline-size:1.5rem;min-inline-size:1.5rem;min-block-size:1.5rem}:host([scale=l]){block-size:2rem;inline-size:2rem;min-inline-size:2rem;min-block-size:2rem}.flip-rtl{transform:scaleX(-1)}.svg{display:block}",sTt=Rhe(class extends Phe{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.icon=null,this.flipRtl=!1,this.scale="m",this.textLabel=void 0,this.pathData=void 0,this.visible=!1}connectedCallback(){this.waitUntilVisible(()=>{this.visible=!0,this.loadIconPathData()})}disconnectedCallback(){var t;(t=this.intersectionObserver)==null||t.disconnect(),this.intersectionObserver=null}async componentWillLoad(){this.loadIconPathData()}render(){const{el:t,flipRtl:e,pathData:r,scale:i,textLabel:s}=this,n=GOe(t),o=XRe[i],a=!!s,l=[].concat(r||"");return gc(vhe,{"aria-hidden":XOe(!a),"aria-label":a?s:null,role:a?"img":null},gc("svg",{"aria-hidden":"true",class:{[eTt.flipRtl]:n==="rtl"&&e,svg:!0},fill:"currentColor",height:"100%",viewBox:`0 0 ${o} ${o}`,width:"100%",xmlns:"http://www.w3.org/2000/svg"},l.map(c=>typeof c=="string"?gc("path",{d:c}):gc("path",{d:c.d,opacity:"opacity"in c?c.opacity:1}))))}async loadIconPathData(){const{icon:t,scale:e,visible:r}=this;!t||!r||(this.pathData=await tTt({icon:t,scale:e}))}waitUntilVisible(t){if(this.intersectionObserver=GRe("intersection",e=>{e.forEach(r=>{r.isIntersecting&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null,t())})},{rootMargin:"50px"}),!this.intersectionObserver){t();return}this.intersectionObserver.observe(this.el)}static get assetsDirs(){return["assets"]}get el(){return this}static get watchers(){return{icon:["loadIconPathData"],scale:["loadIconPathData"]}}static get style(){return iTt}},[1,"calcite-icon",{icon:[513],flipRtl:[516,"flip-rtl"],scale:[513],textLabel:[1,"text-label"],pathData:[32],visible:[32]}]);function YRe(){if(typeof customElements>"u")return;["calcite-icon"].forEach(e=>{switch(e){case"calcite-icon":customElements.get(e)||customElements.define(e,sTt);break}})}YRe();/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.1.0
 */const ef={page:"page",selected:"is-selected",previous:"previous",next:"next",disabled:"is-disabled",ellipsis:"ellipsis",ellipsisStart:"ellipsis--start",ellipsisEnd:"ellipsis--end"},nTt="@keyframes in{0%{opacity:0}100%{opacity:1}}@keyframes in-down{0%{opacity:0;transform:translate3D(0, -5px, 0)}100%{opacity:1;transform:translate3D(0, 0, 0)}}@keyframes in-up{0%{opacity:0;transform:translate3D(0, 5px, 0)}100%{opacity:1;transform:translate3D(0, 0, 0)}}@keyframes in-scale{0%{opacity:0;transform:scale3D(0.95, 0.95, 1)}100%{opacity:1;transform:scale3D(1, 1, 1)}}:root{--calcite-animation-timing:calc(150ms * var(--calcite-internal-duration-factor));--calcite-internal-duration-factor:var(--calcite-duration-factor, 1);--calcite-internal-animation-timing-fast:calc(100ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-medium:calc(200ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-slow:calc(300ms * var(--calcite-internal-duration-factor))}.calcite-animate{opacity:0;animation-fill-mode:both;animation-duration:var(--calcite-animation-timing)}.calcite-animate__in{animation-name:in}.calcite-animate__in-down{animation-name:in-down}.calcite-animate__in-up{animation-name:in-up}.calcite-animate__in-scale{animation-name:in-scale}@media (prefers-reduced-motion: reduce){:root{--calcite-internal-duration-factor:0.01}}:root{--calcite-floating-ui-transition:var(--calcite-animation-timing);--calcite-floating-ui-z-index:600}:host([hidden]){display:none}:host([scale=s]){--calcite-pagination-spacing-internal:0.25rem 0.5rem}:host([scale=s]) .previous,:host([scale=s]) .next,:host([scale=s]) .page{block-size:1.5rem;font-size:var(--calcite-font-size--2);line-height:1rem}:host([scale=s]) .previous,:host([scale=s]) .next{padding-inline:0.25rem}:host([scale=m]){--calcite-pagination-spacing-internal:0.5rem 0.75rem}:host([scale=m]) .previous,:host([scale=m]) .next,:host([scale=m]) .page{block-size:2rem;font-size:var(--calcite-font-size--1);line-height:1rem}:host([scale=m]) .previous,:host([scale=m]) .next{padding-inline:0.5rem}:host([scale=l]){--calcite-pagination-spacing-internal:0.75rem 1rem}:host([scale=l]) .previous,:host([scale=l]) .next,:host([scale=l]) .page{block-size:2.75rem;font-size:var(--calcite-font-size-0);line-height:1.25rem}:host([scale=l]) .previous,:host([scale=l]) .next{padding-inline:1rem}:host{display:flex;writing-mode:horizontal-tb}:host button{outline-color:transparent}:host button:focus{outline:2px solid var(--calcite-ui-brand);outline-offset:-2px}.previous,.next,.page{box-sizing:border-box;display:flex;cursor:pointer;align-items:center;border-style:none;--tw-border-opacity:0;background-color:transparent;font-family:inherit;font-size:var(--calcite-font-size-0);line-height:1.25rem;color:var(--calcite-ui-text-3);border-block:2px solid transparent}.previous:hover,.next:hover,.page:hover{color:var(--calcite-ui-text-1);transition:all var(--calcite-animation-timing) ease-in-out 0s, outline 0s, outline-offset 0s}.page:hover{border-block-end-color:var(--calcite-ui-border-2)}.page.is-selected{font-weight:var(--calcite-font-weight-medium);color:var(--calcite-ui-text-1);border-block-end-color:var(--calcite-ui-brand)}.previous:hover,.next:hover{background-color:var(--calcite-ui-foreground-2);color:var(--calcite-ui-brand)}.previous:active,.next:active{background-color:var(--calcite-ui-foreground-3)}.previous.is-disabled,.next.is-disabled{pointer-events:none;background-color:transparent}.previous.is-disabled>calcite-icon,.next.is-disabled>calcite-icon{opacity:var(--calcite-ui-opacity-disabled)}.next{margin-inline-end:0px}.page,.ellipsis{padding:var(--calcite-pagination-spacing-internal)}.ellipsis{display:flex;align-items:flex-end;color:var(--calcite-ui-text-3)}",mL=5,oTt=Rhe(class extends Phe{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.calcitePaginationChange=lOe(this,"calcitePaginationChange",6),this.previousClicked=()=>{this.previousPage().then(),this.emitUpdate()},this.nextClicked=()=>{this.nextPage(),this.emitUpdate()},this.groupSeparator=!1,this.messageOverrides=void 0,this.pageSize=20,this.numberingSystem=void 0,this.startItem=1,this.totalItems=0,this.scale="m",this.defaultMessages=void 0,this.effectiveLocale="",this.messages=void 0}onMessagesChange(){}effectiveLocaleChange(){Zxt(this,this.effectiveLocale)}effectiveLocaleWatcher(){vk.numberFormatOptions={locale:this.effectiveLocale,numberingSystem:this.numberingSystem,useGrouping:this.groupSeparator}}connectedCallback(){Gxt(this),Jxt(this)}async componentWillLoad(){await Yxt(this)}disconnectedCallback(){Hxt(this),Kxt(this)}async nextPage(){this.startItem=Math.min(this.getLastStart(),this.startItem+this.pageSize)}async previousPage(){this.startItem=Math.max(1,this.startItem-this.pageSize)}getLastStart(){const{totalItems:t,pageSize:e}=this;return(t%e===0?t-e:Math.floor(t/e)*e)+1}showLeftEllipsis(){return Math.floor(this.startItem/this.pageSize)>3}showRightEllipsis(){return(this.totalItems-this.startItem)/this.pageSize>3}emitUpdate(){this.calcitePaginationChange.emit()}renderPages(){const t=this.getLastStart();let e,r;this.totalItems/this.pageSize<=mL?(r=1+this.pageSize,e=t-this.pageSize):this.startItem/this.pageSize<mL-1?(r=1+this.pageSize,e=1+4*this.pageSize):this.startItem+3*this.pageSize>=this.totalItems?(r=t-4*this.pageSize,e=t-this.pageSize):(r=this.startItem-this.pageSize,e=this.startItem+this.pageSize);const i=[];for(;r<=e;)i.push(r),r=r+this.pageSize;return i.map(s=>this.renderPage(s))}renderPage(t){const e=Math.floor(t/this.pageSize)+(this.pageSize===1?0:1);vk.numberFormatOptions={locale:this.effectiveLocale,numberingSystem:this.numberingSystem,useGrouping:this.groupSeparator};const r=vk.localize(e.toString());return gc("button",{class:{[ef.page]:!0,[ef.selected]:t===this.startItem},onClick:()=>{this.startItem=t,this.emitUpdate()}},r)}renderLeftEllipsis(){if(this.totalItems/this.pageSize>mL&&this.showLeftEllipsis())return gc("span",{class:`${ef.ellipsis} ${ef.ellipsisStart}`},"")}renderRightEllipsis(){if(this.totalItems/this.pageSize>mL&&this.showRightEllipsis())return gc("span",{class:`${ef.ellipsis} ${ef.ellipsisEnd}`},"")}render(){const{totalItems:t,pageSize:e,startItem:r}=this,i=e===1?r<=e:r<e,s=r+e>t;return gc(OOe,null,gc("button",{"aria-label":this.messages.previous,class:{[ef.previous]:!0,[ef.disabled]:i},disabled:i,onClick:this.previousClicked},gc("calcite-icon",{flipRtl:!0,icon:"chevronLeft",scale:this.scale==="l"?"m":"s"})),t>e?this.renderPage(1):null,this.renderLeftEllipsis(),this.renderPages(),this.renderRightEllipsis(),this.renderPage(this.getLastStart()),gc("button",{"aria-label":this.messages.next,class:{[ef.next]:!0,[ef.disabled]:s},disabled:s,onClick:this.nextClicked},gc("calcite-icon",{flipRtl:!0,icon:"chevronRight",scale:this.scale==="l"?"m":"s"})))}static get delegatesFocus(){return!0}static get assetsDirs(){return["assets"]}get el(){return this}static get watchers(){return{messageOverrides:["onMessagesChange"],effectiveLocale:["effectiveLocaleChange","effectiveLocaleWatcher"]}}static get style(){return nTt}},[17,"calcite-pagination",{groupSeparator:[516,"group-separator"],messageOverrides:[1040],pageSize:[514,"page-size"],numberingSystem:[1,"numbering-system"],startItem:[1538,"start-item"],totalItems:[514,"total-items"],scale:[513],messages:[1040],defaultMessages:[32],effectiveLocale:[32],nextPage:[64],previousPage:[64]}]);function aTt(){if(typeof customElements>"u")return;["calcite-pagination","calcite-icon"].forEach(e=>{switch(e){case"calcite-pagination":customElements.get(e)||customElements.define(e,oTt);break;case"calcite-icon":customElements.get(e)||YRe();break}})}aTt();var lTt=Object.defineProperty,cTt=Object.getOwnPropertyDescriptor,HK=(t,e,r,i)=>{for(var s=i>1?void 0:i?cTt(e,r):e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(s=(i?o(e,r,s):o(s))||s);return i&&s&&lTt(e,r,s),s};let dM=class extends BRe{render(){const{data:t}=this.happyMoments;return Q("div",{class:"list-container"},Q("ul",null,t.map((e,r)=>Q("li",{key:r,class:e.category,styles:{display:this.selectedCategory===e.category?"inherit":"hidden"}},e.text))))}};HK([d()],dM.prototype,"happyMoments",2);HK([d()],dM.prototype,"selectedCategory",2);dM=HK([P("happy-moments.List")],dM);const uTt=dM,hTt=t=>new Intl.NumberFormat("en-US").format(t),dTt="4c0daae2965d4c2e859dfa398f27d3da",gL={day:"https://services9.arcgis.com/FF3qnCUixr5w9JQi/arcgis/rest/services/HappyDB/FeatureServer/3",month:"https://services9.arcgis.com/FF3qnCUixr5w9JQi/arcgis/rest/services/HappyDB/FeatureServer/4"},pTt={affection:"affection",achievement:"achievement",enjoy_the_moment:"enjoying the moment",bonding:"bonding",leisure:"leisure",exercise:"exercise",nature:"nature"},qq=50;var fTt=Object.defineProperty,mTt=Object.getOwnPropertyDescriptor,ZRe=(t,e,r,i)=>{for(var s=i>1?void 0:i?mTt(e,r):e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(s=(i?o(e,r,s):o(s))||s);return i&&s&&fTt(e,r,s),s};let V4=class extends BRe{render(){const{timePeriod:t,statistics:e,happyMoments:r,selectedCategory:i,pagination:s}=this.store;return Q("div",{class:"ui-layout"},Q("header",null,Q("h2",null,"What made you happy in the last"," ",Q("button",{class:this.classes(t===Nf.Day?"focused":""),onclick:()=>this.store.toggleTimePeriod()},"24 hours"),Q("button",{class:this.classes(t===Nf.Month?"focused":""),onclick:()=>this.store.toggleTimePeriod()},"3 months"),"?"),e?this._renderDescription(e):"",e&&e.country?Q("button",{onclick:()=>{this.store.removeCountryFilter()},class:"remove-filter"},"Remove country filter"):""),this._renderHappyMoments(r,i),this._renderPagination(r,s))}_renderDescription(t){const e=t.country;return Q("div",{class:"description"},Q("p",null,this._getIntroPhrase(e),t.data.map((r,i)=>Q("span",{key:i},Q("span",{class:this.classes(r.category,"underline")},r.text)," (",hTt(r.counts),")",this._setPunctuation(i,t.data.length)))),e?"":Q("p",{class:"instruction"},"Click on a country to read the happy moments people shared."))}_getIntroPhrase(t){return t?Q("span",null,"In ",Q("b",null," ",t)," happy moments are related to"," "):Q("span",null,"Around the world, happy moments are related to ")}_setPunctuation(t,e){return e===1?". ":t===e-2?" and ":t===e-1?". ":", "}_renderHappyMoments(t,e){return t&&t.total?Q(uTt,{happyMoments:t}):""}_renderPagination(t,e){if(t&&t.total>qq)return Q("calcite-pagination",{class:"pagination","page-size":qq.toString(),"start-item":e.toString(),"total-items":t.total.toString(),scale:"s","numbering-system":"latn",onCalcitePaginationChange:r=>{this.store.setPagination(r.target.startItem-1)}})}};ZRe([d()],V4.prototype,"store",2);V4=ZRe([P("happy-moments.App")],V4);const gTt=V4;async function yTt(t,e,r){const i=X5(t);return C7e(i,Lc.from(e),{...r}).then(s=>s.data.count)}var _Tt=Object.defineProperty,vTt=Object.getOwnPropertyDescriptor,$p=(t,e,r,i)=>{for(var s=i>1?void 0:i?vTt(e,r):e,n=t.length-1,o;n>=0;n--)(o=t[n])&&(s=(i?o(e,r,s):o(s))||s);return i&&s&&_Tt(e,r,s),s};let Bu=class extends Te{constructor({view:t}){super(),this.selectionLayerView=null,this.mouseOverGraphic=null,this.statistics=null,this._cachedStatistics=[],this.happyMoments=null,this.pagination=0,this.setPagination=e=>{this.pagination=e},this.timePeriod=Nf.Day,this.country=null,this._view=t,this.addHandles([ne(()=>[this.timePeriod,this.country],()=>{this._loadStatistics(),this.pagination=0},{initial:!0}),ne(()=>[this.country,this.pagination,this.timePeriod],([e])=>{var r;e?this._loadHappyMoments():(this.happyMoments=null,this.pagination=0,(r=this.selectionHighlight)==null||r.remove())})]),t.when(()=>{const e=this._view.map.findLayerById("18718b1e65f-layer-91");e.outFields=["iso_a3","Name"],t.whenLayerView(e).then(s=>{this.selectionLayerView=s});const r=this._view.map.findLayerById("18718a5f1c6-layer-89"),i=this._view.map.findLayerById("18718ba9b7f-layer-97");this.addHandles([this._setupClickHitTest(e),this._setupHoverHitTest(e),ne(()=>[this.timePeriod],()=>{this.timePeriod===Nf.Day?(r.visible=!1,i.visible=!0,e.definitionExpression="happy_moments_count_24h > 0"):(r.visible=!0,i.visible=!1,e.definitionExpression="happy_moments_3m_count > 0")},{initial:!0})])})}toggleTimePeriod(){this.timePeriod=this.timePeriod===Nf.Day?Nf.Month:Nf.Day}removeCountryFilter(){this.country=null}async _loadStatistics(){const t=this._cachedStatistics.find(e=>this.country?e.country===this.country.isoId&&e.timePeriod===this.timePeriod:e.country===null&&e.timePeriod===this.timePeriod);if(t)this.statistics=t.data;else{let e=this.timePeriod===Nf.Day?gL.day:gL.month;try{const i=(await SO(e,new Lc({where:this.country?`country = '${this.country.isoId}'`:"1=1",outStatistics:[{onStatisticField:"hmid",statisticType:"count",outStatisticFieldName:"counts"}],groupByFieldsForStatistics:["category"]}))).features.map(o=>o.attributes);i.sort((o,a)=>a.counts-o.counts);const s=i.reduce((o,a)=>o+a.counts,0);i.forEach(o=>{o.percentage=Math.floor(o.counts/s*100),o.text=pTt[o.category]});const n={country:this.country?this.country.name:null,data:i};this._cachedStatistics.push({country:this.country?this.country.isoId:null,timePeriod:this.timePeriod,data:n}),this.statistics=n}catch(r){console.log(r)}}}_setupHoverHitTest(t){return this._view.on("pointer-move",e=>{this._view.hitTest(e,{include:t}).then(r=>{var i,s;if(r.results.length){this._view.container.style.cursor="pointer";const n=r.results[0];(n==null?void 0:n.type)==="graphic"&&(this.mouseOverGraphic?this.mouseOverGraphic.attributes.OBJECTID!==n.graphic.attributes.OBJECTID&&((i=this.mouseOverHighlight)==null||i.remove(),this.mouseOverHighlight=this.selectionLayerView.highlight(n.graphic),this.mouseOverGraphic=n.graphic):(this.mouseOverHighlight=this.selectionLayerView.highlight(n.graphic),this.mouseOverGraphic=n.graphic))}else this._view.container.style.cursor="revert",(s=this.mouseOverHighlight)==null||s.remove(),this.mouseOverGraphic=null})})}_setupClickHitTest(t){return this._view.on("click",e=>{this._view.hitTest(e,{include:t}).then(r=>{var i;if(r.results.length){const s=r.results[0];if((s==null?void 0:s.type)==="graphic"){const{iso_a3:n,Name:o}=s.graphic.attributes;this.country={isoId:n,name:o},(i=this.selectionHighlight)==null||i.remove(),this.selectionHighlight=this.selectionLayerView.highlight(s.graphic),this._view.goTo(s.graphic)}}})})}async _loadHappyMoments(){let t=this.timePeriod===Nf.Day?gL.day:gL.month;try{const r=(await SO(t,new Lc({where:`country = '${this.country.isoId}'`,start:this.pagination,num:qq,outFields:["cleaned_hm","category"]}))).features.map(s=>{const{cleaned_hm:n,category:o}=s.attributes;return{text:n,category:o}}),i=await yTt(t,new Lc({where:`country = '${this.country.isoId}'`}));this.happyMoments={total:i,data:r}}catch(e){console.log(e)}}};$p([d()],Bu.prototype,"selectionLayerView",2);$p([d()],Bu.prototype,"selectionHighlight",2);$p([d()],Bu.prototype,"mouseOverHighlight",2);$p([d()],Bu.prototype,"mouseOverGraphic",2);$p([d()],Bu.prototype,"timePeriod",2);$p([d()],Bu.prototype,"country",2);$p([d()],Bu.prototype,"statistics",2);$p([d()],Bu.prototype,"happyMoments",2);$p([d()],Bu.prototype,"pagination",2);$p([d()],Bu.prototype,"selectedCategory",2);Bu=$p([P("happy-moments.AppStore")],Bu);const bTt=Bu;_he(window.document.URL);Qr.assetsPath="./assets";const wTt=new U8e({portalItem:{id:dTt}}),qK=window.view=new Oxt({container:"view",map:wTt,alphaCompositingEnabled:!0,environment:{background:{type:"color",color:[0,0,0,0]},starsEnabled:!1,atmosphereEnabled:!1,lighting:{type:"virtual"}},highlightOptions:{color:new Ze("rgba(255, 173, 51, 255)")},ui:{components:[]},padding:{top:150},navigation:{mouseWheelZoomEnabled:!1,browserTouchPanEnabled:!1}}),xTt=new kRe({view:qK});qK.ui.add(xTt,"bottom-right");const TTt=new bTt({view:qK});new gTt({container:document.getElementById("ui"),store:TTt});export{Sc as $,Be as A,v_ as B,v as C,de as D,co as E,I0e as F,Gs as G,Vi as H,$i as I,C as J,Si as K,Do as L,wY as M,lp as N,Ds as O,Sa as P,M as Q,N6t as R,Bje as S,e4e as T,Pi as U,TXe as V,hX as W,ogt as X,ji as Y,j as Z,ie as _,Zr as a,yp as a$,ngt as a0,i3 as a1,ur as a2,Le as a3,Tv as a4,WFe as a5,h3 as a6,rv as a7,SM as a8,ux as a9,_t as aA,vW as aB,XH as aC,zE as aD,BEt as aE,Sje as aF,It as aG,tx as aH,um as aI,Hr as aJ,We as aK,Sm as aL,fe as aM,zS as aN,ke as aO,fee as aP,X5 as aQ,ove as aR,WBe as aS,qBe as aT,an as aU,Av as aV,wW as aW,al as aX,b6e as aY,dm as aZ,BO as a_,Fs as aa,bot as ab,wn as ac,FM as ad,Mme as ae,jSt as af,kFe as ag,Lc as ah,yt as ai,Wje as aj,jh as ak,qs as al,NTt as am,Dk as an,K_ as ao,US as ap,_gt as aq,qr as ar,EM as as,Fn as at,ra as au,X_ as av,RW as aw,ri as ax,sy as ay,rEt as az,Ve as b,ae as b$,o5 as b0,os as b1,JTt as b2,Gu as b3,ln as b4,A as b5,Ye as b6,LE as b7,Ln as b8,cK as b9,Lu as bA,ce as bB,lz as bC,jw as bD,d6 as bE,w as bF,jc as bG,Ry as bH,Ie as bI,Ke as bJ,Dr as bK,kr as bL,Nr as bM,Ar as bN,zt as bO,Yl as bP,Qt as bQ,vm as bR,$v as bS,k as bT,io as bU,No as bV,lt as bW,Kt as bX,Br as bY,ge as bZ,Me as b_,fx as ba,Ot as bb,H_ as bc,OCe as bd,_e as be,$4t as bf,Rn as bg,D4t as bh,wEt as bi,D4e as bj,vb as bk,P4t as bl,KF as bm,uy as bn,pi as bo,EEt as bp,KPt as bq,Lr as br,Zs as bs,CTe as bt,ys as bu,i5 as bv,qi as bw,N3 as bx,ar as by,Ur as bz,em as c,TLt as c$,xa as c0,ti as c1,age as c2,N4t as c3,F4t as c4,V4t as c5,zX as c6,ga as c7,j5e as c8,$t as c9,hr as cA,$o as cB,Z4 as cC,QRt as cD,Cn as cE,Mi as cF,uo as cG,mm as cH,pt as cI,ve as cJ,xXe as cK,W2t as cL,Io as cM,$St as cN,lo as cO,Cv as cP,Ze as cQ,P_ as cR,sx as cS,YE as cT,Ft as cU,E3 as cV,hje as cW,ZIt as cX,JIt as cY,knt as cZ,EIt as c_,g5 as ca,SEt as cb,et as cc,Pp as cd,jr as ce,$r as cf,I6t as cg,E8e as ch,sNt as ci,ww as cj,BFe as ck,My as cl,Bf as cm,eOt as cn,c5 as co,Vfe as cp,Uc as cq,Q_e as cr,fR as cs,vye as ct,tOt as cu,ATt as cv,le as cw,mF as cx,bP as cy,_C as cz,P as d,wee as d$,WGe as d0,VC as d1,vRt as d2,v5 as d3,bRt as d4,NM as d5,wRt as d6,b5 as d7,LM as d8,sbe as d9,lSe as dA,Yo as dB,ea as dC,y2t as dD,J_ as dE,Js as dF,np as dG,f3 as dH,me as dI,wu as dJ,pI as dK,bIt as dL,Tee as dM,fIt as dN,dot as dO,_5 as dP,nx as dQ,Qpt as dR,kJ as dS,qM as dT,Sn as dU,VE as dV,_Ce as dW,vs as dX,oy as dY,Ufe as dZ,z_ as d_,T4e as da,_Rt as db,wIt as dc,UDe as dd,Tp as de,lv as df,Kpt as dg,Got as dh,zot as di,Qq as dj,TEt as dk,Qh as dl,BX as dm,Xh as dn,UIt as dp,FIt as dq,cy as dr,mE as ds,Ac as dt,Oo as du,uNt as dv,tK as dw,MIt as dx,OIt as dy,Ja as dz,u as e,CAe as e$,vft as e0,Yr as e1,PTt as e2,Sk as e3,Lhe as e4,ip as e5,OM as e6,ND as e7,$Tt as e8,te as e9,aye as eA,zu as eB,Pt as eC,Pe as eD,h4 as eE,Am as eF,Tt as eG,Mp as eH,Ee as eI,Ei as eJ,Oy as eK,u6 as eL,Iv as eM,O6 as eN,vv as eO,I6 as eP,iK as eQ,M6 as eR,mC as eS,slt as eT,BZ as eU,pC as eV,lm as eW,zPe as eX,xp as eY,wot as eZ,J0t as e_,hE as ea,YGe as eb,ba as ec,p2t as ed,Gt as ee,xZe as ef,pNe as eg,DSt as eh,fFt as ei,EK as ej,YSt as ek,Gr as el,Cu as em,wp as en,dMt as eo,l5 as ep,Bc as eq,Ys as er,iw as es,Wr as et,es as eu,Ez as ev,ex as ew,Wft as ex,Nc as ey,Gl as ez,ETt as f,XE as f$,l3e as f0,c3e as f1,r3e as f2,ITt as f3,ao as f4,U5 as f5,$W as f6,_Y as f7,QX as f8,L4t as f9,jee as fA,Ou as fB,uge as fC,Oc as fD,Fl as fE,r3 as fF,kS as fG,dDe as fH,TUe as fI,L6t as fJ,N$ as fK,GTe as fL,Hc as fM,U_t as fN,$0e as fO,k5e as fP,ASt as fQ,Uce as fR,DS as fS,uE as fT,lDe as fU,Jh as fV,Hl as fW,PSt as fX,qt as fY,Xs as fZ,MSt as f_,k4t as fa,yY as fb,Iw as fc,so as fd,pp as fe,Wlt as ff,rs as fg,Lo as fh,Xe as fi,mX as fj,Ti as fk,tEt as fl,gz as fm,cm as fn,NXe as fo,bbe as fp,qXe as fq,HFe as fr,wje as fs,$X as ft,$M as fu,mt as fv,Vr as fw,FXe as fx,FTt as fy,Cr as fz,Te as g,a2t as g$,ir as g0,Pve as g1,Ive as g2,CIt as g3,uQe as g4,J4 as g5,iF as g6,GE as g7,fX as g8,CU as g9,Vn as gA,Aee as gB,bee as gC,tmt as gD,tRt as gE,rRt as gF,_W as gG,A2t as gH,fm as gI,Wge as gJ,Xge as gK,RSt as gL,pye as gM,Fnt as gN,_It as gO,Ffe as gP,xSt as gQ,DTt as gR,MFt as gS,vSt as gT,R7e as gU,vIt as gV,Ec as gW,Ipe as gX,dve as gY,lme as gZ,yfe as g_,a3 as ga,bw as gb,ye as gc,br as gd,XY as ge,nr as gf,rY as gg,Dg as gh,g3t as gi,vp as gj,ui as gk,J4t as gl,R2t as gm,Eu as gn,W4 as go,l2t as gp,w3 as gq,Ip as gr,RIt as gs,Tye as gt,rp as gu,Ynt as gv,f_t as gw,U4t as gx,I_ as gy,Z5e as gz,kt as h,oO as h$,CGe as h0,Q2t as h1,k_ as h2,sd as h3,Zlt as h4,Du as h5,uu as h6,us as h7,Ir as h8,wt as h9,rw as hA,bve as hB,_fe as hC,zW as hD,z2t as hE,va as hF,qY as hG,fBe as hH,oE as hI,W7e as hJ,aSt as hK,Lde as hL,G4 as hM,EX as hN,Rw as hO,p3 as hP,eDe as hQ,x_ as hR,Mu as hS,tNe as hT,FS as hU,rNe as hV,fme as hW,Nu as hX,q3e as hY,ISt as hZ,$2 as h_,Ns as ha,Ia as hb,ze as hc,Lt as hd,tt as he,ct as hf,Fi as hg,Ko as hh,gm as hi,is as hj,Pv as hk,HF as hl,Mv as hm,C6 as hn,ZPt as ho,Et as hp,Yge as hq,$Et as hr,HAt as hs,h5 as ht,wAt as hu,ta as hv,$s as hw,uAt as hx,zIe as hy,XIe as hz,Kr as i,_w as i$,xee as i0,FDe as i1,RAt as i2,Cre as i3,MAt as i4,cSt as i5,lX as i6,ipe as i7,qPe as i8,bAt as i9,VFe as iA,w2e as iB,mi as iC,wL as iD,fC as iE,lP as iF,OAt as iG,CSt as iH,V_ as iI,nI as iJ,aX as iK,oX as iL,ive as iM,sSt as iN,Wb as iO,Ra as iP,gS as iQ,Pze as iR,u3 as iS,bs as iT,ow as iU,X4 as iV,iy as iW,yX as iX,kfe as iY,NIe as iZ,oU as i_,yve as ia,vve as ib,mve as ic,mBe as id,Xoe as ie,Zot as ig,JSt as ih,uIt as ii,mfe as ij,PLe as ik,nSt as il,W5 as im,nm as io,GM as ip,S7e as iq,yIt as ir,Xje as is,ZSt as it,HSt as iu,WSt as iv,qSt as iw,XSt as ix,m3 as iy,Pu as iz,ft as j,hpe as j$,uyt as j0,nxt as j1,_z as j2,Bs as j3,yz as j4,bz as j5,tF as j6,DDe as j7,aG as j8,R0e as j9,yv as jA,Aw as jB,Pc as jC,OSt as jD,sEt as jE,nEt as jF,Vw as jG,ez as jH,xS as jI,ane as jJ,jt as jK,Hf as jL,d9e as jM,OCt as jN,NDe as jO,fr as jP,Bn as jQ,Fr as jR,as as jS,zn as jT,uS as jU,LLt as jV,Epe as jW,Z2t as jX,vn as jY,N2t as jZ,D2t as j_,Lk as ja,vq as jb,rFt as jc,hFt as jd,aEe as je,oce as jf,tFt as jg,sFt as jh,QNt as ji,FV as jj,uD as jk,eN as jl,Ap as jm,Y2t as jn,ed as jo,YJ as jp,Rh as jq,sce as jr,$mt as js,Lmt as jt,Po as ju,H3 as jv,f$e as jw,aEt as jx,BDe as jy,GDe as jz,se as k,YW as k$,cpe as k0,Ape as k1,TSt as k2,ESt as k3,SSt as k4,Vf as k5,L3 as k6,Zo as k7,Qr as k8,kn as k9,nwe as kA,$e as kB,Ul as kC,Q_ as kD,e5 as kE,QW as kF,ry as kG,nJe as kH,gn as kI,iwe as kJ,my as kK,nY as kL,UM as kM,wi as kN,gO as kO,A5 as kP,wye as kQ,kEt as kR,VEt as kS,hJe as kT,fJe as kU,F2t as kV,L2t as kW,$2t as kX,Fu as kY,zb as kZ,Gnt as k_,Py as ka,Q2 as kb,wa as kc,OLt as kd,sq as ke,U2t as kf,Jk as kg,B5 as kh,XCt as ki,YCt as kj,ZCt as kk,JCt as kl,Zh as km,cs as kn,Xd as ko,Cc as kp,LZ as kq,$Z as kr,Tme as ks,Qs as kt,He as ku,gs as kv,oEt as kw,s4e as kx,m2 as ky,tye as kz,V as l,qae as l$,Tse as l0,fMt as l1,xse as l2,uX as l3,Qa as l4,Wh as l5,t5 as l6,Oat as l7,ol as l8,S5 as l9,Pat as lA,Ww as lB,Kf as lC,At as lD,gW as lE,xIt as lF,Ff as lG,Bxe as lH,ax as lI,lY as lJ,zSt as lK,JEt as lL,wSt as lM,Tm as lN,wX as lO,Wfe as lP,Cp as lQ,OE as lR,Wt as lS,Qo as lT,P6 as lU,PTe as lV,BTe as lW,gt as lX,Ii as lY,xEt as lZ,sY as l_,Rp as la,no as lb,Uft as lc,CTt as ld,aw as le,X5e as lf,zEt as lg,FEt as lh,UEt as li,ZEt as lj,GSt as lk,j_ as ll,f4 as lm,R2e as ln,hMt as lo,gJe as lp,cR as lq,hS as lr,az as ls,Oa as lt,VS as lu,oS as lv,sW as lw,vOt as lx,j4 as ly,yut as lz,Se as m,Nhe as m$,yle as m0,$3 as m1,TM as m2,Ch as m3,gee as m4,LEt as m5,f_ as m6,ku as m7,V6 as m8,ql as m9,_f as mA,b3 as mB,cY as mC,KS as mD,BSt as mE,Srt as mF,uY as mG,Efe as mH,JS as mI,uye as mJ,_y as mK,F6e as mL,ay as mM,M5 as mN,lUe as mO,DEt as mP,cne as mQ,pMt as mR,lx as mS,sDe as mT,rl as mU,Ma as mV,Q as mW,Of as mX,CF as mY,N_e as mZ,xi as m_,Pa as ma,Ru as mb,cn as mc,NTe as md,XEt as me,ist as mf,Vu as mg,C6e as mh,XTe as mi,PE as mj,qS as mk,CH as ml,NJ as mm,J2t as mn,JOe as mo,NEt as mp,iU as mq,uF as mr,Jat as ms,U6t as mt,k6t as mu,V6t as mv,AM as mw,bSt as mx,b1 as my,wse as mz,ts as n,wve as n$,NS as n0,nS as n1,Xhe as n2,BTt as n3,wM as n4,_3e as n5,Uh as n6,B4 as n7,yM as n8,qTt as n9,Ca as nA,cP as nB,dX as nC,Uu as nD,H6 as nE,Ife as nF,id as nG,cE as nH,FLt as nI,_v as nJ,DLt as nK,ULt as nL,NLt as nM,Lut as nN,Uut as nO,Dut as nP,Nut as nQ,Fut as nR,_At as nS,gAt as nT,fAt as nU,CAt as nV,EAt as nW,C7e as nX,nW as nY,RX as nZ,X7e as n_,vgt as na,oOt as nb,z4 as nc,HPe as nd,hIt as ne,WAt as nf,sje as ng,_Fe as nh,AFe as ni,HTt as nj,jWe as nk,HWe as nl,qWe as nm,Vh as nn,lvt as no,cvt as np,tvt as nq,t6t as nr,$4 as ns,u5t as nt,hvt as nu,iP as nv,fF as nw,Sne as nx,RMt as ny,uDe as nz,mee as o,lOe as o$,TAt as o0,xAt as o1,QSt as o2,eEt as o3,KSt as o4,gLe as o5,mIt as o6,Are as o7,dIt as o8,$c as o9,SAt as oA,cve as oB,Xr as oC,Gi as oD,Oz as oE,wGe as oF,xGe as oG,J5e as oH,cp as oI,YEt as oJ,s6e as oK,YTt as oL,N3e as oM,pW as oN,K3e as oO,uFt as oP,xc as oQ,nce as oR,Rhe as oS,Phe as oT,gc as oU,kCt as oV,oke as oW,ske as oX,$Ct as oY,LCt as oZ,DCt as o_,w7e as oa,uje as ob,hFe as oc,N4e as od,s7e as oe,PAt as of,m7e as og,vre as oh,E7e as oi,AAt as oj,q8e as ok,JAt as ol,M7 as om,iO as on,l8 as oo,c8 as op,RTt as oq,OTt as or,xu as os,dAt as ot,MTt as ou,Tc as ov,ly as ow,WM as ox,el as oy,Yqe as oz,ne as p,vvt as p$,jCt as p0,STt as p1,zCt as p2,UCt as p3,vhe as p4,qCt as p5,OOe as p6,NCt as p7,VCt as p8,ake as p9,ICt as pA,HCt as pB,LO as pC,IJe as pD,yKe as pE,$we as pF,Iwe as pG,SKe as pH,WZ as pI,JKe as pJ,Ywe as pK,ZZ as pL,rQe as pM,GQe as pN,cet as pO,Zst as pP,d4 as pQ,$ot as pR,LJ as pS,dst as pT,Kw as pU,i0t as pV,q_t as pW,VK as pX,kAe as pY,yvt as pZ,GAe as p_,yhe as pa,HE as pb,nNe as pc,gje as pd,jE as pe,sRt as pf,BRt as pg,XYe as ph,z3e as pi,yje as pj,iRt as pk,kAt as pl,aE as pm,mO as pn,KB as po,nRt as pp,GCt as pq,BCt as pr,xv as ps,rfe as pt,mW as pu,Zhe as pv,L_ as pw,qCe as px,Oyt as py,FCt as pz,Ks as q,cbt as q$,qAe as q0,wvt as q1,YAe as q2,Tvt as q3,FP as q4,NU as q5,B4e as q6,Nwe as q7,AKe as q8,c2t as q9,o1t as qA,sRe as qB,l1t as qC,aRe as qD,rU as qE,x1t as qF,P1t as qG,B1t as qH,j1t as qI,q1t as qJ,Fje as qK,sl as qL,Wd as qM,P7e as qN,yTt as qO,yAt as qP,_ee as qQ,jW as qR,xRt as qS,KOe as qT,SRt as qU,TRt as qV,ERt as qW,X2t as qX,flt as qY,lRe as qZ,E1t as q_,N2 as qa,ife as qb,iX as qc,ILe as qd,rSt as qe,rX as qf,iSt as qg,oSt as qh,Yh as qi,Act as qj,PX as qk,bm as ql,_M as qm,sct as qn,cct as qo,Mlt as qp,Llt as qq,oK as qr,Kgt as qs,Jgt as qt,Z6 as qu,Qgt as qv,g4 as qw,Iat as qx,i1t as qy,tRe as qz,bt as r,$ve as r$,uRt as r0,Hje as r1,y$e as r2,mut as r3,But as r4,rpt as r5,Tpt as r6,ypt as r7,Gje as r8,IXe as r9,XFe as rA,tB as rB,K5 as rC,qFe as rD,xZ as rE,ybe as rF,Gc as rG,rd as rH,w5 as rI,ZLe as rJ,YLe as rK,ELe as rL,iee as rM,nl as rN,J5 as rO,hIe as rP,uIe as rQ,V2t as rR,SO as rS,ePe as rT,BXe as rU,tC as rV,iZ as rW,Rve as rX,OBe as rY,kGe as rZ,MBe as r_,PXe as ra,Jd as rb,Kme as rc,zje as rd,PW as re,iEt as rf,YFe as rg,JFe as rh,oNe as ri,CX as rj,lNe as rk,cNe as rl,Ree as rm,nv as rn,hi as ro,LDe as rp,bXe as rq,jje as rr,yXe as rs,Yje as rt,LXe as ru,Nee as rv,Ome as rw,LX as rx,s6 as ry,Qie as rz,MM as s,aWe as s$,Vve as s0,NF as s1,v2t as s2,Sve as s3,AO as s4,aNe as s5,lSt as s6,Ls as s7,UTt as s8,Pw as s9,Qhe as sA,uQ as sB,FF as sC,qje as sD,G_ as sE,jie as sF,XS as sG,vE as sH,QFe as sI,KFe as sJ,wv as sK,T5 as sL,WY as sM,hWe as sN,Nje as sO,vy as sP,MWe as sQ,fWe as sR,mWe as sS,Qqe as sT,eWe as sU,tWe as sV,rWe as sW,iWe as sX,sWe as sY,nWe as sZ,oWe as s_,bEt as sa,xE as sb,Lw as sc,rbe as sd,xW as se,ZT as sf,z7 as sg,IRt as sh,yWe as si,MN as sj,IO as sk,I7 as sl,Az as sm,Kh as sn,lE as so,m5e as sp,YX as sq,$5e as sr,ox as ss,K4 as st,uSt as su,GTt as sv,jIe as sw,am as sx,om as sy,Zme as sz,GXe as t,WO as t$,lWe as t0,cWe as t1,uWe as t2,gbe as t3,a3e as t4,dp as t5,kTt as t6,mQ as t7,sme as t8,$$e as t9,YWe as tA,ZWe as tB,ube as tC,Ox as tD,_E as tE,uW as tF,$ut as tG,Zu as tH,AMt as tI,CMt as tJ,QIt as tK,ave as tL,WTt as tM,Pke as tN,oI as tO,lG as tP,oUe as tQ,z5e as tR,V5e as tS,Gf as tT,EEe as tU,fw as tV,Z6e as tW,jTt as tX,FEe as tY,VEe as tZ,Fb as t_,XN as ta,Q4 as tb,ZFe as tc,LSt as td,zTt as te,IPe as tf,RQ as tg,D as th,I2t as ti,$ye as tj,$6e as tk,da as tl,C8e as tm,xF as tn,vbt as to,qAt as tp,Obe as tq,FYe as tr,Ibe as ts,IYe as tt,ab as tu,RZ as tv,AZ as tw,IAt as tx,OZ as ty,XWe as tz,nt as u,K2t as u0,ZJ as u1,cht as u2,IEe as u3,iht as u4,NEe as u5,LEe as u6,lht as u7,zc as u8,aq as u9,Aa as ua,DEe as ub,tP as uc,sht as ud,V3 as ue,qH as uf,g6 as ug,Yot as uh,$ht as ui,Iht as uj,Pht as uk,Ay as ul,cMt as um,rT as un,AIe as uo,$At as up,oZ as uq,GAt as ur,$Rt as us,TIt as ut,JLt as uu,bp as v,bi as w,tw as x,d as y,Qft as z};
